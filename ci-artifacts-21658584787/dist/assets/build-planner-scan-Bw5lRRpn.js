import{o as e,p as t,q as n,r as o,l as a,t as i,T as s,u as c,v as r,w as l,x as d,e as u}from"./main-DAA4nTv8.js";import{c as m,a as h}from"./aggregation-DIdlweK3.js";import{loadBuildFromData as p}from"./build-planner-DLAE7IlH.js";function f(e){const t=Math.round(e.reduce((e,t)=>e+t.x,0)/e.length),n=Math.round(e.reduce((e,t)=>e+t.width,0)/e.length),o={};e.forEach(e=>{o[e.rarity]=(o[e.rarity]||0)+1});const a=Object.entries(o).sort((e,t)=>t[1]-e[1])[0]?.[0]||"unknown",i=new Set(e.map(e=>e.y)).size;return{x:t,borderWidth:n,rarity:a,confidence:e.length/7,detections:e.length,verticalConsistency:i}}function g(e,t,n,o){if(e.length<2)return b(t,n,o);const a=[];for(let f=1;f<e.length;f++){const t=e[f],n=e[f-1];if(!t||!n)continue;const o=t.x-n.x;o>=20&&o<=100&&a.push(o)}if(a.length<2)return b(t,n,o);const i=function(e,t=2){const n=new Map;for(const i of e){const e=Math.round(i/t)*t;n.set(e,(n.get(e)||0)+1)}let o=0,a=e[0]??0;for(const[i,s]of n)s>o&&(o=s,a=i);return a}(a),s=Math.round(e.reduce((e,t)=>e+t.borderWidth,0)/e.length),c=Math.max(2,Math.min(10,Math.round(1.2*s))),r=i-c,l=r+c,d=Math.floor(n.height/l)>=1?r:n.height-10,u=Math.min(r,Math.max(r,d)),m=e.length*i,h=e[0]?.x??0,p=Math.round((t-m)/2)-h;return{iconWidth:Math.round(r),iconHeight:Math.round(u),xSpacing:c,ySpacing:c,cellStride:i,borderWidth:s,confidence:a.length/(e.length-1),detectedCells:e.length,firstCellX:h,centerOffset:p,debug:{gaps:a,gapMode:i}}}function b(e,t,n){const o=t.bottomY/n.baseResolution;return{iconWidth:Math.round(n.defaultCalibration.iconWidth*o),iconHeight:Math.round(n.defaultCalibration.iconHeight*o),xSpacing:Math.round(n.defaultCalibration.xSpacing*o),ySpacing:Math.round(n.defaultCalibration.ySpacing*o),cellStride:Math.round((n.defaultCalibration.iconWidth+n.defaultCalibration.xSpacing)*o),borderWidth:3,confidence:0,detectedCells:0,firstCellX:null,centerOffset:0,isDefault:!0}}function y(e){const t=e.data;let n=0,o=0,a=0,i=0,s=0,c=0,r=0,l=0;for(let g=0;g<t.length;g+=16){const e=t[g]??0,d=t[g+1]??0,u=t[g+2]??0;n+=e,o+=d,a+=u,i+=e*e,s+=d*d,c+=u*u;Math.max(e,d,u)-Math.min(e,d,u)>40&&r++,l++}const d=n/l,u=o/l,m=a/l,h=(d+u+m)/3,p=i/l-d*d+(s/l-u*u)+(c/l-m*m),f=r/l;return{isEmpty:p<400||h<30,isSuspicious:p<600&&f<.1,meanBrightness:h,totalVariance:p,colorfulRatio:f}}let v={baseResolution:720,maxDetectedRows:2,defaultCalibration:{xOffset:0,yOffset:0,iconWidth:40,iconHeight:40,xSpacing:4,ySpacing:4,iconsPerRow:20,numRows:3,totalItems:60}};const M=function(t,n,o){const a=Math.floor(.7*o),i=Math.floor(.15*n),s=Math.floor(.7*n),c=[];for(let h=a;h<o-2;h+=2){const n=t.getImageData(i,h,s,2).data;let o=0,a=0,r=0,l=0,d=0;for(let t=0;t<n.length;t+=16){const i=n[t]??0,s=n[t+1]??0,c=n[t+2]??0,u=(i+s+c)/3;o+=u;const m=u;a+=Math.pow(i-m,2)+Math.pow(s-m,2)+Math.pow(c-m,2);Math.max(i,s,c)-Math.min(i,s,c)>50&&r++,e(i,s,c)&&l++,d++}c.push({y:h,avgBrightness:o/d,avgVariance:a/d,colorfulRatio:r/d,rarityRatio:l/d})}let r=-1,l=o,d=0;for(let e=0;e<c.length-35;e++){const t=c.slice(e,e+35),n=t.reduce((e,t)=>e+t.avgBrightness,0)/t.length,a=t.reduce((e,t)=>e+t.avgVariance,0)/t.length,i=t.reduce((e,t)=>e+t.colorfulRatio,0)/t.length,s=t.reduce((e,t)=>e+t.rarityRatio,0)/t.length;let u=0;n>=25&&n<=160&&(u+=25),a>200&&(u+=Math.min(35,a/40)),i>.03&&(u+=80*i),s>.01&&(u+=150*s);const m=t[0],h=t[t.length-1];if(!m||!h)continue;const p=m.y/o;p>.88?u+=25:p>.82&&(u+=15),u>d&&(d=u,r=m.y,l=h.y+2)}-1===r&&(r=Math.floor(.88*o),l=o-5);const u=Math.floor(.12*o),m=Math.floor(.06*o);return l-r>u&&(r=l-u),l-r<m&&(r=l-m),{topY:r,bottomY:l,height:l-r,confidence:Math.min(1,d/100),debug:{stripData:c,bestScore:d}}},w=function(t,n,o){const{topY:a,bottomY:i}=o,s=i-a,c=Math.floor(.15*n),r=Math.floor(.85*n),l=[a+Math.floor(.05*s),a+Math.floor(.15*s),a+Math.floor(.3*s),a+Math.floor(.5*s),a+Math.floor(.7*s),a+Math.floor(.85*s),a+Math.floor(.95*s)],d=[],u={};for(const h of l){if(h>=t.canvas.height)continue;const n=t.getImageData(c,h,r-c,1).data;let o=!1,a=-1,i=null;for(let t=0;t<r-c;t++){const s=t+c,r=4*t,l=n[r]??0,m=n[r+1]??0,p=n[r+2]??0,f=e(l,m,p);if(f&&!o)o=!0,a=s,i=f;else if(!f&&o){const e=s-a;e>=2&&e<=8&&i&&(d.push({x:a,endX:s,y:h,width:e,rarity:i,type:"left"}),u[i]=(u[i]||0)+1),o=!1,i=null}}}let m=function(e,t){if(0===e.length)return[];const n=[...e].sort((e,t)=>e.x-t.x),o=n[0];if(!o)return[];const a=[];let i=[o];for(let s=1;s<n.length;s++){const e=n[s],o=i[i.length-1];e&&o&&(e.x-o.x<=t?i.push(e):(a.push(i),i=[e]))}i.length>0&&a.push(i);return a.map(f)}(d,6);return m=function(e,t=2){return e.filter(e=>e.verticalConsistency>=t)}(m,2),m=function(e){if(e.length<3)return e;const t=[];for(let r=1;r<e.length;r++){const n=e[r],o=e[r-1];if(!n||!o)continue;const a=n.x-o.x;a>0&&a<150&&t.push({gap:a,fromIdx:r-1,toIdx:r})}if(t.length<2)return e;const n=new Map,o=4;for(const{gap:r}of t){const e=Math.round(r/o)*o;n.set(e,(n.get(e)||0)+1)}let a=0,i=0;for(const[r,l]of n)l>i&&(i=l,a=r);if(i<3)return e;const s=new Set;for(const{gap:r,fromIdx:l,toIdx:d}of t)Math.abs(r-a)<=o&&(s.add(l),s.add(d));for(const{gap:r,fromIdx:l,toIdx:d}of t){const e=Math.round(r/a);if(e>=2&&e<=4){const t=a*e;Math.abs(r-t)<=o*e&&(s.add(l),s.add(d))}}const c=e.filter((e,t)=>s.has(t));if(c.length<3&&e.length>=3)return e;return c}(m),{edges:m,allEdges:d,colorCounts:u,dominantColors:Object.entries(u).sort((e,t)=>t[1]-e[1]).map(([e])=>e)}};function x(e,t,n,o,a){return function(e,t,n,o,a,i){const s=[],{iconWidth:c,iconHeight:r,xSpacing:l,ySpacing:d,cellStride:u}=e,m=r+d,h=t.bottomY-t.topY,p=Math.floor(h/m),f=i.maxDetectedRows,g=Math.min(p,f),b=t.bottomY-r-5;let y,v;if(a&&a.length>=2&&null!==e.firstCellX)y=e.firstCellX,v=a.length;else{v=Math.floor((n-100)/u);const e=v*u-l;y=Math.round((n-e)/2)}for(let w=0;w<g;w++){const e=b-w*m;if(e<.7*o)break;for(let t=0;t<v;t++){const o=y+t*u;o<0||o+c>n||s.push({x:o,y:e,width:c,height:r,row:w,col:t,slotIndex:s.length})}}const M=o/i.baseResolution;return{positions:s,calibration:{xOffset:Math.round((y-(n-v*u)/2)/M),yOffset:Math.round(100-(o-b-r)/M),iconWidth:Math.round(c/M),iconHeight:Math.round(r/M),xSpacing:Math.round(l/M),ySpacing:Math.round(d/M),iconsPerRow:v,numRows:g,totalItems:s.length},debug:{startX:y,firstRowY:b,cellStride:u,scale:M}}}(e,t,n,o,a,v)}const _=function(e,t){const n=[],o=[],a=[];for(const c of t){const t=y(e.getImageData(c.x,c.y,c.width,c.height));t.isEmpty?o.push({...c,validation:t}):t.isSuspicious?a.push({...c,validation:t}):n.push({...c,validation:t})}const i=t.length;let s=n.length/i;return o.length/i>.5&&(s*=.5),{validCells:n,emptyCells:o,suspiciousCells:a,totalCells:i,confidence:s,stats:{valid:n.length,empty:o.length,suspicious:a.length}}},C=function(e,t,n){const o=.2*(e.confidence||0)+.4*(t.confidence||0)+.4*(n.confidence||0);return Math.min(1,Math.max(0,o))};async function I(e,t,n,o={}){const a=Date.now(),{progressCallback:i}=o;try{i&&i(10,"Detecting hotbar region...");const o=M(e,t,n);i&&i(30,"Finding item borders...");const s=w(e,t,o);i&&i(50,"Calculating icon sizes...");const c=function(e,t,n){return g(e,t,n,v)}(s.edges,t,o);i&&i(70,"Building grid...");const r=x(c,o,t,n,s.edges);i&&i(90,"Validating cells...");const l=_(e,r.positions),d=22,u=c.iconWidth<d||c.iconHeight<d,m=o.confidence<.4&&s.edges.length<3&&c.isDefault,h=s.edges.length>=2&&c.confidence<.3&&l.validCells.length<3,p=[];u&&p.push("icons_too_small"),m&&p.push("likely_empty_screen"),h&&p.push("inconsistent_detection"),0===s.edges.length&&p.push("no_vertical_clusters"),(m||h||u)&&(l.validCells=[],l.confidence=0,l.failureReasons=p);const f=Date.now()-a;return i&&i(100,"Done!"),{success:!0,bandRegion:o,borders:s,metrics:c,grid:r,validation:l,calibration:r.calibration,elapsed:f,confidence:C(o,c,l),reasons:p.length>0?p:null}}catch(s){return{success:!1,error:s instanceof Error?s.message:String(s),reasons:["exception_thrown"],calibration:null}}}let S=!1,E=!1,$=!1,R=null,B=null;async function D(e){if(S)return;t(e),n(e);const s=[];s.push(o().then(()=>{E=!0,a.info({operation:"build_planner_scan.templates_loaded",data:{success:!0}})}).catch(e=>{a.warn({operation:"build_planner_scan.templates_load_failed",error:{name:e.name,message:e.message}})})),s.push(i().then(()=>{$=!0,a.info({operation:"build_planner_scan.presets_loaded",data:{success:!0}})}).catch(e=>{a.warn({operation:"build_planner_scan.presets_load_failed",error:{name:e.name,message:e.message}})})),await Promise.allSettled(s),function(){const e=document.querySelector(".build-actions");if(e&&!document.getElementById("import-screenshot-btn")){const t=document.createElement("button");t.id="import-screenshot-btn",t.className="btn-primary",t.innerHTML="ðŸ“· Import from Screenshot",t.title="Upload a screenshot to auto-detect items",e.insertBefore(t,e.firstChild);const n=document.createElement("input");n.type="file",n.id="build-planner-file-input",n.accept="image/*",n.style.display="none",e.appendChild(n)}if(!document.getElementById("build-planner-scan-modal")){const e=document.createElement("div");e.id="build-planner-scan-modal",e.className="modal build-scan-modal",e.innerHTML='\n            <div class="modal-content modal-wide">\n                <button class="close" id="close-scan-modal" aria-label="Close modal">&times;</button>\n                <h2>ðŸ“· Import Build from Screenshot</h2>\n                <div id="build-scan-content">\n                    \x3c!-- Content loaded dynamically --\x3e\n                </div>\n            </div>\n        ',document.body.appendChild(e),R=e}}(),function(){const e=document.getElementById("import-screenshot-btn");e?.addEventListener("click",L);const t=document.getElementById("build-planner-file-input");t?.addEventListener("change",W);const n=document.getElementById("close-scan-modal");n?.addEventListener("click",H),R?.addEventListener("click",e=>{e.target===R&&H()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&"flex"===R?.style.display&&H()})}(),S=!0,a.info({operation:"build_planner_scan.init",data:{templatesLoaded:E,presetsLoaded:$,itemsCount:e.items?.items.length||0}})}function L(){const e=document.getElementById("build-planner-file-input");e?.click()}async function W(e){const t=e.target,n=t.files?.[0];if(n)if(n.type.startsWith("image/"))if(n.size>10485760)s.error("Image size must be less than 10MB");else{try{const e=await function(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=e=>{const o=e.target?.result;"string"==typeof o?t(o):n(new Error("Failed to read image"))},o.onerror=()=>n(new Error("Failed to read file")),o.readAsDataURL(e)})}(n);!function(e){if(!R)return;const t=document.getElementById("build-scan-content");t&&(t.innerHTML=`\n            <div class="build-scan-processing">\n                <div class="build-scan-image-preview">\n                    <img src="${e}" alt="Processing screenshot" />\n                </div>\n                <div class="build-scan-progress">\n                    <div class="build-scan-progress-bar">\n                        <div class="build-scan-progress-fill" style="width: 0%"></div>\n                    </div>\n                    <p class="build-scan-progress-text">Initializing...</p>\n                </div>\n            </div>\n        `);R.style.display="flex"}(e);const t=await async function(e,t){const n=(e,n)=>{t?.({progress:e,status:n})};n(5,"Loading image...");const o=new Image;await new Promise((t,n)=>{o.onload=()=>t(),o.onerror=()=>n(new Error("Failed to load image")),o.src=e});const i=o.naturalWidth,s=o.naturalHeight;if(n(10,"Detecting grid layout..."),!c(i,s)&&$)try{n(15,"Auto-detecting grid...");const e=document.createElement("canvas");e.width=i,e.height=s;const t=e.getContext("2d");if(t){t.drawImage(o,0,0);const e=await I(t,i,s);e.success&&e.calibration&&a.info({operation:"build_planner_scan.auto_grid_success",data:{calibration:e.calibration}})}}catch(_){a.warn({operation:"build_planner_scan.auto_grid_failed",error:{name:_.name,message:_.message}})}n(20,"Running text recognition...");let u={items:[],tomes:[],character:null,weapon:null};try{u=await r(e,(e,t)=>{n(20+.3*e,t)})}catch(_){a.warn({operation:"build_planner_scan.ocr_failed",error:{name:_.name,message:_.message}})}n(50,"Running icon recognition...");let p=[];if(E||l())try{p=(await d(e,(e,t)=>{n(50+.4*e,t)})).map(e=>({...e,method:"template_match"}))}catch(_){a.warn({operation:"build_planner_scan.cv_failed",error:{name:_.name,message:_.message}})}n(90,"Combining detections...");const f=p.map(e=>({type:e.type,entity:e.entity,confidence:e.confidence,rawText:`cv_detected_${e.entity.name}`})),g=p.filter(e=>"item"===e.type).map(e=>({...e,type:e.type})),b=p.filter(e=>"tome"===e.type).map(e=>({...e,type:e.type})),y=m([...u.items,...f.filter(e=>"item"===e.type)],g),v=m([...u.tomes,...f.filter(e=>"tome"===e.type)],b),M=h(y),w=h(v),x={character:u.character?u.character.entity:p.find(e=>"character"===e.type)?.entity||null,weapon:u.weapon?u.weapon.entity:p.find(e=>"weapon"===e.type)?.entity||null,items:M.map(e=>({item:e.entity,count:e.count||1,confidence:e.confidence})),tomes:w.map(e=>({tome:e.entity,confidence:e.confidence}))};return n(100,"Detection complete!"),x}(e,e=>{!function(e){const t=document.querySelector(".build-scan-progress-fill"),n=document.querySelector(".build-scan-progress-text");t&&(t.style.width=`${e.progress}%`);n&&(n.textContent=e.status)}(e)});!function(e,t){if(!R)return;B=t;const n=t.items.reduce((e,t)=>e+t.count,0),o=t.items.length>0?t.items.reduce((e,t)=>e+t.confidence,0)/t.items.length:0,a=document.getElementById("build-scan-content");if(a){a.innerHTML=`\n            <div class="build-scan-preview">\n                <div class="build-scan-image-preview">\n                    <img src="${e}" alt="Uploaded screenshot" />\n                </div>\n\n                <div class="build-scan-results">\n                    <h3>Detected Items</h3>\n\n                    ${0===t.items.length&&0===t.tomes.length?'<p class="build-scan-empty">No items detected. Try a clearer screenshot of the pause menu.</p>':`\n                            <div class="build-scan-stats">\n                                <span>${n} items</span>\n                                <span>${t.tomes.length} tomes</span>\n                                <span>Avg confidence: ${Math.round(100*o)}%</span>\n                            </div>\n\n                            ${t.character?`\n                                <div class="build-scan-section">\n                                    <h4>Character</h4>\n                                    <div class="build-scan-entity">${u(t.character.name)}</div>\n                                </div>\n                            `:""}\n\n                            ${t.weapon?`\n                                <div class="build-scan-section">\n                                    <h4>Weapon</h4>\n                                    <div class="build-scan-entity">${u(t.weapon.name)}</div>\n                                </div>\n                            `:""}\n\n                            ${t.items.length>0?`\n                                <div class="build-scan-section">\n                                    <h4>Items</h4>\n                                    <div class="build-scan-items-list">\n                                        ${t.items.map(({item:e,count:t,confidence:n})=>`\n                                            <div class="build-scan-item ${k(n)}">\n                                                <span class="item-name">${u(e.name)}${t>1?` x${t}`:""}</span>\n                                                <span class="item-confidence">${Math.round(100*n)}%</span>\n                                            </div>\n                                        `).join("")}\n                                    </div>\n                                </div>\n                            `:""}\n\n                            ${t.tomes.length>0?`\n                                <div class="build-scan-section">\n                                    <h4>Tomes</h4>\n                                    <div class="build-scan-items-list">\n                                        ${t.tomes.map(({tome:e,confidence:t})=>`\n                                            <div class="build-scan-item ${k(t)}">\n                                                <span class="item-name">${u(e.name)}</span>\n                                                <span class="item-confidence">${Math.round(100*t)}%</span>\n                                            </div>\n                                        `).join("")}\n                                    </div>\n                                </div>\n                            `:""}\n                        `}\n                </div>\n\n                <div class="build-scan-actions">\n                    ${t.items.length>0||t.tomes.length>0?'\n                        <button id="apply-detected-build" class="btn-primary">\n                            âœ… Apply to Build Planner\n                        </button>\n                    ':""}\n                    <button id="cancel-detected-build" class="btn-secondary">\n                        Cancel\n                    </button>\n                </div>\n            </div>\n        `;const i=document.getElementById("apply-detected-build");i?.addEventListener("click",P);const s=document.getElementById("cancel-detected-build");s?.addEventListener("click",H)}}(e,t),a.info({operation:"build_planner_scan.file_processed",data:{fileName:n.name,fileSize:n.size,itemsDetected:t.items.length,tomesDetected:t.tomes.length}})}catch(o){a.error({operation:"build_planner_scan.process_error",error:{name:o.name,message:o.message}}),s.error(`Failed to process screenshot: ${o.message}`),H()}t.value=""}else s.error("Please select an image file")}function k(e){return e>=.8?"confidence-high":e>=.5?"confidence-medium":"confidence-low"}function H(){R&&(R.style.display="none"),B=null}function P(){if(!B)return void s.error("No detected build to apply");const e={character:B.character?.id,weapon:B.weapon?.id,items:[...new Set(B.items.map(e=>e.item.id))],tomes:B.tomes.map(e=>e.tome.id),name:"Imported Build",notes:`Imported from screenshot on ${(new Date).toLocaleString()}`};p(e),H();const t=e.items.length,n=e.tomes.length;s.success(`Applied ${t} items and ${n} tomes to Build Planner!`),a.info({operation:"build_planner_scan.build_applied",data:{characterId:e.character,weaponId:e.weapon,itemsCount:t,tomesCount:n}})}export{P as applyDetectedBuild,H as closePreviewModal,D as initBuildPlannerScan};
//# sourceMappingURL=build-planner-scan-Bw5lRRpn.js.map
