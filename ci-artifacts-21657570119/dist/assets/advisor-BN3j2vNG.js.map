{"version":3,"file":"advisor-BN3j2vNG.js","sources":["../../src/modules/recommendation.ts","../../src/modules/advisor.ts"],"sourcesContent":["// ========================================\n// MegaBonk Recommendation Engine\n// ========================================\n// Analyzes current build and provides intelligent item/weapon/tome recommendations\n// ========================================\n\nimport type { Item, Weapon, Tome, Character, Shrine, Tier } from '../types/index.ts';\n\n/**\n * Current build state\n */\nexport interface BuildState {\n    character: Character | null;\n    weapon: Weapon | null;\n    items: Item[];\n    tomes: Tome[];\n    stats?: {\n        hp?: number;\n        damage?: number;\n        speed?: number;\n        critChance?: number;\n    };\n}\n\n/**\n * Item choice for recommendation\n */\nexport interface ChoiceOption {\n    type: 'item' | 'weapon' | 'tome' | 'shrine';\n    entity: Item | Weapon | Tome | Shrine;\n}\n\n/**\n * Recommendation result with scoring and reasoning\n */\nexport interface Recommendation {\n    choice: ChoiceOption;\n    score: number;\n    confidence: number; // 0-1\n    reasoning: string[];\n    warnings: string[];\n    synergies: string[];\n    antiSynergies: string[];\n}\n\n/**\n * Tier score mapping\n */\nconst TIER_SCORES: Record<Tier, number> = {\n    SS: 100,\n    S: 80,\n    A: 60,\n    B: 40,\n    C: 20,\n};\n\n/**\n * Build archetype detection based on items\n */\ninterface BuildArchetype {\n    type: 'damage' | 'tank' | 'crit' | 'proc' | 'speed' | 'mixed';\n    strength: number; // 0-1\n}\n\n/**\n * Detect build archetype based on current items and tomes\n */\nfunction detectBuildArchetype(build: BuildState): BuildArchetype {\n    let damageCount = 0;\n    let tankCount = 0;\n    let critCount = 0;\n    let procCount = 0;\n    let speedCount = 0;\n\n    // Analyze items\n    for (const item of build.items) {\n        const itemName = item.name?.toLowerCase() || '';\n        const effect = item.base_effect?.toLowerCase() || '';\n        const desc = item.description?.toLowerCase() || '';\n\n        if (itemName.includes('damage') || effect.includes('damage') || desc.includes('damage')) {\n            damageCount++;\n        }\n        if (\n            itemName.includes('hp') ||\n            itemName.includes('health') ||\n            effect.includes('hp') ||\n            itemName.includes('beefy')\n        ) {\n            tankCount++;\n        }\n        if (\n            itemName.includes('crit') ||\n            effect.includes('crit') ||\n            itemName.includes('juice') ||\n            itemName.includes('fork')\n        ) {\n            critCount++;\n        }\n        if (\n            itemName.includes('proc') ||\n            itemName.includes('chance') ||\n            itemName.includes('bonk') ||\n            itemName.includes('meatball')\n        ) {\n            procCount++;\n        }\n        if (itemName.includes('speed') || itemName.includes('attack speed') || effect.includes('attack speed')) {\n            speedCount++;\n        }\n    }\n\n    // Analyze tomes\n    for (const tome of build.tomes) {\n        const statAffected = tome.stat_affected?.toLowerCase() || '';\n\n        if (statAffected.includes('damage')) damageCount += 2;\n        if (statAffected.includes('health') || statAffected.includes('hp')) tankCount += 2;\n        if (statAffected.includes('crit')) critCount += 2;\n        if (statAffected.includes('attack speed') || statAffected.includes('cooldown')) speedCount += 2;\n    }\n\n    const total = damageCount + tankCount + critCount + procCount + speedCount;\n\n    if (total === 0) {\n        return { type: 'mixed', strength: 0 };\n    }\n\n    // Determine dominant archetype\n    const scores = [\n        { type: 'damage' as const, count: damageCount },\n        { type: 'tank' as const, count: tankCount },\n        { type: 'crit' as const, count: critCount },\n        { type: 'proc' as const, count: procCount },\n        { type: 'speed' as const, count: speedCount },\n    ];\n\n    scores.sort((a, b) => b.count - a.count);\n\n    // Guard against empty scores array before accessing first element\n    if (scores.length === 0) {\n        return { type: 'mixed', strength: 0 };\n    }\n\n    // Safe: length check above guarantees scores[0] exists\n    const dominant = scores[0]!;\n\n    const strength = dominant.count / total;\n\n    // If no clear winner (difference < 20%), it's mixed\n    if (strength < 0.3) {\n        return { type: 'mixed', strength: 0.5 };\n    }\n\n    return { type: dominant.type, strength };\n}\n\n/**\n * Calculate synergy score between choice and current build\n */\nfunction calculateSynergyScore(\n    choice: ChoiceOption,\n    build: BuildState\n): { score: number; synergies: string[]; antiSynergies: string[] } {\n    let score = 0;\n    const synergies: string[] = [];\n    const antiSynergies: string[] = [];\n\n    const entity = choice.entity;\n    const entityName = entity.name;\n\n    // Check synergies with character (use optional chaining for defensive access)\n    if (build.character) {\n        const charSynergies = build.character?.synergies_items ?? [];\n        const charWeaponSynergies = build.character?.synergies_weapons ?? [];\n\n        // Bug fix: Require minimum 3-char match length to prevent false positives\n        // (e.g., \"or\" matching \"sword\", \"a\" matching everything)\n        // Also filter out empty strings which would match everything\n        if (\n            choice.type === 'item' &&\n            charSynergies.some(\n                s =>\n                    s.length >= 3 &&\n                    (s.toLowerCase().includes(entityName.toLowerCase()) ||\n                    entityName.toLowerCase().includes(s.toLowerCase()))\n            )\n        ) {\n            score += 20;\n            synergies.push(`Synergizes with ${build.character.name}`);\n        }\n\n        if (\n            choice.type === 'weapon' &&\n            charWeaponSynergies.some(\n                s =>\n                    s.length >= 3 &&\n                    (s.toLowerCase().includes(entityName.toLowerCase()) ||\n                    entityName.toLowerCase().includes(s.toLowerCase()))\n            )\n        ) {\n            score += 20;\n            synergies.push(`Great synergy with ${build.character.name}`);\n        }\n    }\n\n    // Check synergies with weapon\n    // Note: Items may use 'synergies' or 'synergies_weapons' field\n    if (build.weapon && choice.type === 'item') {\n        const item = entity as Item;\n        const itemSynergies = item?.synergies ?? [];\n        const itemSynergiesWeapons = item?.synergies_weapons ?? [];\n        const allWeaponSynergies = [...itemSynergies, ...itemSynergiesWeapons];\n        const weapon = build.weapon;\n\n        // Bug fix: Require minimum 3-char match length and filter empty strings\n        // to prevent false positives from short/empty synergy entries\n        if (\n            allWeaponSynergies.some(\n                s =>\n                    s.length >= 3 &&\n                    (s.toLowerCase() === weapon.name.toLowerCase() ||\n                    s.toLowerCase().includes(weapon.name.toLowerCase()) ||\n                    weapon.name.toLowerCase().includes(s.toLowerCase()))\n            )\n        ) {\n            score += 15;\n            synergies.push(`Synergizes with ${weapon.name}`);\n        }\n    }\n\n    // Check synergies with existing items\n    for (const buildItem of build.items) {\n        const itemEntity = entity as Item;\n        const itemSynergies = itemEntity?.synergies ?? [];\n\n        // Bug fix: Require minimum 3-char match length and filter empty strings\n        if (\n            itemSynergies.some(\n                s =>\n                    s.length >= 3 &&\n                    (s.toLowerCase().includes(buildItem.name.toLowerCase()) ||\n                    buildItem.name.toLowerCase().includes(s.toLowerCase()))\n            )\n        ) {\n            score += 10;\n            synergies.push(`Synergizes with ${buildItem.name}`);\n        }\n\n        // Check for anti-synergies\n        // Bug fix: Same minimum length check for anti-synergies\n        const antiSyns = itemEntity?.anti_synergies ?? itemEntity?.antiSynergies ?? [];\n        if (\n            antiSyns.some(\n                s =>\n                    s.length >= 3 &&\n                    (s.toLowerCase().includes(buildItem.name.toLowerCase()) ||\n                    buildItem.name.toLowerCase().includes(s.toLowerCase()))\n            )\n        ) {\n            score -= 30;\n            antiSynergies.push(`Anti-synergy with ${buildItem.name}`);\n        }\n    }\n\n    return { score, synergies, antiSynergies };\n}\n\n/**\n * Check for redundancy (already have similar items)\n */\nfunction calculateRedundancyPenalty(choice: ChoiceOption, build: BuildState): { penalty: number; reason?: string } {\n    if (choice.type !== 'item') {\n        return { penalty: 0 };\n    }\n\n    const item = choice.entity as Item;\n\n    // Check for \"one and done\" items\n    if (item.one_and_done) {\n        const hasAlready = build.items.some(i => i.id === item.id);\n        if (hasAlready) {\n            return { penalty: 100, reason: 'ONE-AND-DONE item already in build' };\n        }\n    }\n\n    // Check if we already have this exact item and it doesn't stack well\n    if (item.stacks_well === false) {\n        const hasAlready = build.items.some(i => i.id === item.id);\n        if (hasAlready) {\n            return { penalty: 50, reason: 'Item does not stack well' };\n        }\n    }\n\n    // Count similar items (diminishing returns)\n    const itemEffect = item.base_effect?.toLowerCase() || '';\n    let similarCount = 0;\n\n    for (const buildItem of build.items) {\n        const buildEffect = buildItem.base_effect?.toLowerCase() || '';\n\n        // Check for similar effects\n        if (itemEffect.includes('damage') && buildEffect.includes('damage')) {\n            similarCount++;\n        } else if (itemEffect.includes('crit') && buildEffect.includes('crit')) {\n            similarCount++;\n        } else if (itemEffect.includes('hp') && buildEffect.includes('hp')) {\n            similarCount++;\n        }\n    }\n\n    // Penalty increases with more similar items\n    const penalty = Math.min(similarCount * 10, 40);\n\n    if (penalty > 0) {\n        return { penalty, reason: `Already have ${similarCount} similar items` };\n    }\n\n    return { penalty: 0 };\n}\n\n/**\n * Calculate archetype fit bonus\n */\nfunction calculateArchetypeFit(choice: ChoiceOption, archetype: BuildArchetype): { bonus: number; reason?: string } {\n    if (archetype.type === 'mixed' || archetype.strength < 0.3) {\n        return { bonus: 0 };\n    }\n\n    const entity = choice.entity;\n    const name = entity.name?.toLowerCase() || '';\n    const effect = (entity as Item).base_effect?.toLowerCase() || '';\n\n    let fits = false;\n    let fitReason = '';\n\n    switch (archetype.type) {\n        case 'damage':\n            if (name.includes('damage') || effect.includes('damage') || name.includes('gym')) {\n                fits = true;\n                fitReason = 'Fits damage build archetype';\n            }\n            break;\n        case 'tank':\n            if (name.includes('hp') || name.includes('health') || effect.includes('hp') || name.includes('beefy')) {\n                fits = true;\n                fitReason = 'Fits tank build archetype';\n            }\n            break;\n        case 'crit':\n            if (name.includes('crit') || effect.includes('crit') || name.includes('juice') || name.includes('fork')) {\n                fits = true;\n                fitReason = 'Fits crit build archetype';\n            }\n            break;\n        case 'proc':\n            if (\n                name.includes('proc') ||\n                name.includes('chance') ||\n                effect.includes('chance') ||\n                name.includes('bonk')\n            ) {\n                fits = true;\n                fitReason = 'Fits proc-based build archetype';\n            }\n            break;\n        case 'speed':\n            if (name.includes('speed') || name.includes('attack speed') || effect.includes('attack speed')) {\n                fits = true;\n                fitReason = 'Fits speed build archetype';\n            }\n            break;\n    }\n\n    if (fits) {\n        const bonus = 15 * archetype.strength;\n        return { bonus, reason: fitReason };\n    }\n\n    return { bonus: 0 };\n}\n\n/**\n * Main recommendation engine\n */\nexport function recommendBestChoice(currentBuild: BuildState, choices: ChoiceOption[]): Recommendation[] {\n    const recommendations: Recommendation[] = [];\n\n    // Detect build archetype\n    const archetype = detectBuildArchetype(currentBuild);\n\n    for (const choice of choices) {\n        const entity = choice.entity;\n        let score = 0;\n        const reasoning: string[] = [];\n        const warnings: string[] = [];\n\n        // 1. Base tier score (40% weight)\n        const tierScore = TIER_SCORES[entity.tier];\n        score += tierScore;\n        reasoning.push(`${entity.tier}-tier item (${tierScore} base score)`);\n\n        // 2. Synergy analysis (30% weight)\n        const { score: synergyScore, synergies, antiSynergies } = calculateSynergyScore(choice, currentBuild);\n        score += synergyScore;\n\n        if (synergies.length > 0) {\n            reasoning.push(`${synergies.length} synergies detected`);\n        }\n        if (antiSynergies.length > 0) {\n            warnings.push(...antiSynergies);\n        }\n\n        // 3. Redundancy check (20% weight)\n        const { penalty: redundancyPenalty, reason: redundancyReason } = calculateRedundancyPenalty(\n            choice,\n            currentBuild\n        );\n        score -= redundancyPenalty;\n        if (redundancyReason) {\n            warnings.push(redundancyReason);\n        }\n\n        // 4. Archetype fit (10% weight)\n        const { bonus: archetypeBonus, reason: archetypeReason } = calculateArchetypeFit(choice, archetype);\n        score += archetypeBonus;\n        if (archetypeReason) {\n            reasoning.push(archetypeReason);\n        }\n\n        // 5. Build phase considerations\n        const itemCount = currentBuild.items.length;\n        if (itemCount < 3 && entity.tier === 'SS') {\n            score += 10;\n            reasoning.push('Early game - prioritize strong items');\n        }\n\n        // Calculate confidence (0-1)\n        const confidence = Math.min(synergies.length * 0.2 + (antiSynergies.length === 0 ? 0.3 : 0) + 0.5, 1.0);\n\n        recommendations.push({\n            choice,\n            score: Math.max(0, score),\n            confidence,\n            reasoning,\n            warnings,\n            synergies,\n            antiSynergies,\n        });\n    }\n\n    // Sort by score (highest first)\n    recommendations.sort((a, b) => b.score - a.score);\n\n    return recommendations;\n}\n\n/**\n * Format recommendation as human-readable text\n */\nexport function formatRecommendation(rec: Recommendation, rank: number): string {\n    const entity = rec.choice.entity;\n    const emoji = rank === 1 ? 'üéØ' : rank === 2 ? 'ü•à' : 'ü•â';\n\n    let text = `${emoji} ${rank === 1 ? 'RECOMMENDED: ' : `#${rank}: `}${entity.name} (${entity.tier}-tier)\\n`;\n    text += `Score: ${Math.round(rec.score)} | Confidence: ${Math.round(rec.confidence * 100)}%\\n\\n`;\n\n    if (rec.reasoning.length > 0) {\n        text += 'Why?\\n';\n        rec.reasoning.forEach(r => {\n            text += `‚úì ${r}\\n`;\n        });\n        text += '\\n';\n    }\n\n    if (rec.synergies.length > 0) {\n        text += 'Synergies:\\n';\n        rec.synergies.forEach(s => {\n            text += `  ‚Ä¢ ${s}\\n`;\n        });\n        text += '\\n';\n    }\n\n    if (rec.warnings.length > 0) {\n        text += 'Warnings:\\n';\n        rec.warnings.forEach(w => {\n            text += `  ‚ö†Ô∏è ${w}\\n`;\n        });\n        text += '\\n';\n    }\n\n    return text;\n}\n","// ========================================\n// MegaBonk Build Advisor Module\n// ========================================\n// Handles the UI and logic for the build recommendation feature\n// ========================================\n\nimport type { Item, Tome, Weapon, Shrine, AllGameData } from '../types/index.ts';\nimport { recommendBestChoice, type BuildState, type ChoiceOption, type Recommendation } from './recommendation.ts';\nimport { ToastManager } from './toast.ts';\nimport { logger } from './logger.ts';\n\n/** Union type for entities that can be selected in the advisor */\ntype AdvisorEntity = Item | Weapon | Tome | Shrine;\n\n// State\nlet allData: AllGameData = {};\nlet currentBuild: BuildState = {\n    character: null,\n    weapon: null,\n    items: [],\n    tomes: [],\n};\nlet selectedItems: Map<string, Item> = new Map();\nlet selectedTomes: Map<string, Tome> = new Map();\n\n/**\n * Initialize the advisor with game data\n */\nexport function initAdvisor(gameData: AllGameData): void {\n    allData = gameData;\n\n    // Populate character dropdown\n    const characterSelect = document.getElementById('advisor-character') as HTMLSelectElement;\n    if (characterSelect && gameData.characters?.characters) {\n        gameData.characters.characters.forEach(char => {\n            const option = document.createElement('option');\n            option.value = char.id;\n            option.textContent = char.name;\n            characterSelect.appendChild(option);\n        });\n    }\n\n    // Populate weapon dropdown\n    const weaponSelect = document.getElementById('advisor-weapon') as HTMLSelectElement;\n    if (weaponSelect && gameData.weapons?.weapons) {\n        gameData.weapons.weapons.forEach(weapon => {\n            const option = document.createElement('option');\n            option.value = weapon.id;\n            option.textContent = weapon.name;\n            weaponSelect.appendChild(option);\n        });\n    }\n\n    // Setup event listeners\n    setupEventListeners();\n\n    logger.info({\n        operation: 'advisor.init',\n        data: {\n            charactersCount: gameData.characters?.characters.length || 0,\n            weaponsCount: gameData.weapons?.weapons.length || 0,\n            itemsCount: gameData.items?.items.length || 0,\n        },\n    });\n}\n\n/**\n * Apply build state from scan module\n */\nexport function applyScannedBuild(state: BuildState): void {\n    // Set character\n    if (state.character) {\n        currentBuild.character = state.character;\n        const characterSelect = document.getElementById('advisor-character') as HTMLSelectElement;\n        if (characterSelect) {\n            characterSelect.value = state.character.id;\n        }\n    }\n\n    // Set weapon\n    if (state.weapon) {\n        currentBuild.weapon = state.weapon;\n        const weaponSelect = document.getElementById('advisor-weapon') as HTMLSelectElement;\n        if (weaponSelect) {\n            weaponSelect.value = state.weapon.id;\n        }\n    }\n\n    // Set items\n    if (state.items && state.items.length > 0) {\n        selectedItems.clear();\n        state.items.forEach(item => {\n            selectedItems.set(item.id, item);\n        });\n        currentBuild.items = state.items;\n    }\n\n    // Set tomes\n    if (state.tomes && state.tomes.length > 0) {\n        selectedTomes.clear();\n        state.tomes.forEach(tome => {\n            selectedTomes.set(tome.id, tome);\n        });\n        currentBuild.tomes = state.tomes;\n    }\n\n    // Update UI\n    updateCurrentBuildDisplay();\n\n    logger.info({\n        operation: 'advisor.scanned_build_applied',\n        data: {\n            character: state.character?.name,\n            weapon: state.weapon?.name,\n            itemsCount: state.items?.length || 0,\n            tomesCount: state.tomes?.length || 0,\n        },\n    });\n}\n\n/**\n * Setup all event listeners for the advisor\n */\nfunction setupEventListeners(): void {\n    // Character selection\n    const characterSelect = document.getElementById('advisor-character') as HTMLSelectElement;\n    characterSelect?.addEventListener('change', handleCharacterChange);\n\n    // Weapon selection\n    const weaponSelect = document.getElementById('advisor-weapon') as HTMLSelectElement;\n    weaponSelect?.addEventListener('change', handleWeaponChange);\n\n    // Add item button\n    const addItemBtn = document.getElementById('add-current-item');\n    addItemBtn?.addEventListener('click', () => showEntityModal('item'));\n\n    // Add tome button\n    const addTomeBtn = document.getElementById('add-current-tome');\n    addTomeBtn?.addEventListener('click', () => showEntityModal('tome'));\n\n    // Choice type selections (update entity dropdown when type changes)\n    for (let i = 1; i <= 3; i++) {\n        const typeSelect = document.getElementById(`choice-${i}-type`) as HTMLSelectElement;\n        typeSelect?.addEventListener('change', e => handleChoiceTypeChange(i, (e.target as HTMLSelectElement).value));\n    }\n\n    // Get recommendation button\n    const recommendBtn = document.getElementById('get-recommendation');\n    recommendBtn?.addEventListener('click', handleGetRecommendation);\n}\n\n/**\n * Handle character selection change\n */\nfunction handleCharacterChange(e: Event): void {\n    const select = e.target as HTMLSelectElement;\n    const characterId = select.value;\n\n    if (!characterId) {\n        currentBuild.character = null;\n        return;\n    }\n\n    const character = allData.characters?.characters.find(c => c.id === characterId);\n    if (character) {\n        currentBuild.character = character;\n        logger.info({\n            operation: 'advisor.character_selected',\n            data: { character: character.name },\n        });\n    }\n}\n\n/**\n * Handle weapon selection change\n */\nfunction handleWeaponChange(e: Event): void {\n    const select = e.target as HTMLSelectElement;\n    const weaponId = select.value;\n\n    if (!weaponId) {\n        currentBuild.weapon = null;\n        return;\n    }\n\n    const weapon = allData.weapons?.weapons.find(w => w.id === weaponId);\n    if (weapon) {\n        currentBuild.weapon = weapon;\n        logger.info({\n            operation: 'advisor.weapon_selected',\n            data: { weapon: weapon.name },\n        });\n    }\n}\n\n/**\n * Show modal for selecting items/tomes\n */\nfunction showEntityModal(type: 'item' | 'tome'): void {\n    const entities = type === 'item' ? allData.items?.items : allData.tomes?.tomes;\n    if (!entities) return;\n\n    // Create modal\n    const modal = document.createElement('div');\n    modal.className = 'modal advisor-entity-modal';\n    modal.style.display = 'block';\n\n    const modalContent = document.createElement('div');\n    modalContent.className = 'modal-content';\n\n    // Close button\n    const closeBtn = document.createElement('button');\n    closeBtn.className = 'close';\n    closeBtn.innerHTML = '&times;';\n    closeBtn.onclick = () => modal.remove();\n\n    // Title\n    const title = document.createElement('h3');\n    title.textContent = `Select ${type === 'item' ? 'Item' : 'Tome'}`;\n\n    // Entity list\n    const listContainer = document.createElement('div');\n    listContainer.className = 'advisor-entity-list';\n\n    entities.forEach(entity => {\n        const entityCard = document.createElement('button');\n        entityCard.className = 'advisor-entity-card';\n        entityCard.innerHTML = `\n            <div class=\"entity-name\">${entity.name}</div>\n            <div class=\"entity-tier\">${entity.tier}</div>\n        `;\n        entityCard.onclick = () => {\n            addEntityToCurrentBuild(type, entity);\n            modal.remove();\n        };\n        listContainer.appendChild(entityCard);\n    });\n\n    modalContent.appendChild(closeBtn);\n    modalContent.appendChild(title);\n    modalContent.appendChild(listContainer);\n    modal.appendChild(modalContent);\n    document.body.appendChild(modal);\n\n    // Close on outside click\n    modal.addEventListener('click', e => {\n        if (e.target === modal) {\n            modal.remove();\n        }\n    });\n}\n\n/**\n * Add entity to current build\n */\nfunction addEntityToCurrentBuild(type: 'item' | 'tome', entity: Item | Tome): void {\n    if (type === 'item') {\n        const item = entity as Item;\n        selectedItems.set(item.id, item);\n        currentBuild.items = Array.from(selectedItems.values());\n    } else {\n        const tome = entity as Tome;\n        selectedTomes.set(tome.id, tome);\n        currentBuild.tomes = Array.from(selectedTomes.values());\n    }\n\n    updateCurrentBuildDisplay();\n    ToastManager.success(`Added ${entity.name}`);\n}\n\n/**\n * Update the display of current build items/tomes\n */\nfunction updateCurrentBuildDisplay(): void {\n    // Update items display\n    const itemsContainer = document.getElementById('advisor-current-items');\n    if (itemsContainer) {\n        itemsContainer.innerHTML = '';\n\n        selectedItems.forEach(item => {\n            const chip = createEntityChip(item, () => {\n                selectedItems.delete(item.id);\n                currentBuild.items = Array.from(selectedItems.values());\n                updateCurrentBuildDisplay();\n            });\n            itemsContainer.appendChild(chip);\n        });\n\n        // Re-add the add button\n        const addBtn = document.createElement('button');\n        addBtn.className = 'advisor-add-btn';\n        addBtn.textContent = '+ Add Item';\n        addBtn.onclick = () => showEntityModal('item');\n        itemsContainer.appendChild(addBtn);\n    }\n\n    // Update tomes display\n    const tomesContainer = document.getElementById('advisor-current-tomes');\n    if (tomesContainer) {\n        tomesContainer.innerHTML = '';\n\n        selectedTomes.forEach(tome => {\n            const chip = createEntityChip(tome, () => {\n                selectedTomes.delete(tome.id);\n                currentBuild.tomes = Array.from(selectedTomes.values());\n                updateCurrentBuildDisplay();\n            });\n            tomesContainer.appendChild(chip);\n        });\n\n        // Re-add the add button\n        const addBtn = document.createElement('button');\n        addBtn.className = 'advisor-add-btn';\n        addBtn.textContent = '+ Add Tome';\n        addBtn.onclick = () => showEntityModal('tome');\n        tomesContainer.appendChild(addBtn);\n    }\n}\n\n/**\n * Create a chip element for an entity\n */\nfunction createEntityChip(entity: Item | Tome, onRemove: () => void): HTMLElement {\n    const chip = document.createElement('div');\n    chip.className = 'advisor-chip';\n    chip.innerHTML = `\n        <span class=\"chip-name\">${entity.name}</span>\n        <button class=\"chip-remove\" aria-label=\"Remove ${entity.name}\">&times;</button>\n    `;\n\n    const removeBtn = chip.querySelector('.chip-remove') as HTMLButtonElement;\n    removeBtn.onclick = onRemove;\n\n    return chip;\n}\n\n/**\n * Handle choice type change (updates entity dropdown)\n */\nfunction handleChoiceTypeChange(choiceNumber: number, type: string): void {\n    const entitySelect = document.getElementById(`choice-${choiceNumber}-entity`) as HTMLSelectElement;\n    if (!entitySelect) return;\n\n    // Clear existing options\n    entitySelect.innerHTML = '<option value=\"\">Select...</option>';\n\n    if (!type) return;\n\n    // Populate based on type\n    let entities: AdvisorEntity[] = [];\n    switch (type) {\n        case 'item':\n            entities = allData.items?.items || [];\n            break;\n        case 'weapon':\n            entities = allData.weapons?.weapons || [];\n            break;\n        case 'tome':\n            entities = allData.tomes?.tomes || [];\n            break;\n        case 'shrine':\n            entities = allData.shrines?.shrines || [];\n            break;\n    }\n\n    entities.forEach(entity => {\n        const option = document.createElement('option');\n        option.value = entity.id;\n        option.textContent = `${entity.name} (${entity.tier})`;\n        entitySelect.appendChild(option);\n    });\n}\n\n/**\n * Handle get recommendation button click\n */\nfunction handleGetRecommendation(): void {\n    try {\n        // Gather choices\n        const choices: ChoiceOption[] = [];\n\n        for (let i = 1; i <= 3; i++) {\n            const typeSelect = document.getElementById(`choice-${i}-type`) as HTMLSelectElement;\n            const entitySelect = document.getElementById(`choice-${i}-entity`) as HTMLSelectElement;\n\n            const type = typeSelect?.value;\n            const entityId = entitySelect?.value;\n\n            if (!type || !entityId) {\n                if (i <= 2) {\n                    ToastManager.error(`Please select at least 2 choices`);\n                    return;\n                }\n                continue;\n            }\n\n            // Find the entity\n            let entity: AdvisorEntity | undefined;\n            switch (type) {\n                case 'item':\n                    entity = allData.items?.items.find(e => e.id === entityId);\n                    break;\n                case 'weapon':\n                    entity = allData.weapons?.weapons.find(e => e.id === entityId);\n                    break;\n                case 'tome':\n                    entity = allData.tomes?.tomes.find(e => e.id === entityId);\n                    break;\n                case 'shrine':\n                    entity = allData.shrines?.shrines.find(e => e.id === entityId);\n                    break;\n            }\n\n            if (entity) {\n                choices.push({\n                    type: type as 'item' | 'weapon' | 'tome' | 'shrine',\n                    entity,\n                });\n            }\n        }\n\n        if (choices.length < 2) {\n            ToastManager.error('Please select at least 2 choices to compare');\n            return;\n        }\n\n        // Get recommendations\n        const recommendations = recommendBestChoice(currentBuild, choices);\n\n        // Display results\n        displayRecommendations(recommendations);\n\n        logger.info({\n            operation: 'advisor.recommendation_generated',\n            data: {\n                choicesCount: choices.length,\n                topChoice: recommendations[0]?.choice.entity.name,\n            },\n        });\n    } catch (error) {\n        logger.error({\n            operation: 'advisor.recommendation_error',\n            error: {\n                name: (error as Error).name,\n                message: (error as Error).message,\n                module: 'advisor',\n            },\n        });\n        ToastManager.error('Failed to generate recommendation. Please try again.');\n    }\n}\n\n/**\n * Display recommendations\n */\nfunction displayRecommendations(recommendations: Recommendation[]): void {\n    const resultsDiv = document.getElementById('advisor-results');\n    const resultsContent = document.getElementById('advisor-results-content');\n\n    if (!resultsDiv || !resultsContent) return;\n\n    resultsContent.innerHTML = '';\n\n    if (recommendations.length === 0) {\n        resultsContent.innerHTML = '<p>No recommendations available.</p>';\n        resultsDiv.style.display = 'block';\n        return;\n    }\n\n    // Display each recommendation\n    recommendations.forEach((rec, index) => {\n        const card = document.createElement('div');\n        card.className = `advisor-result-card ${index === 0 ? 'top-recommendation' : ''}`;\n\n        const entity = rec.choice.entity;\n        const rank = index + 1;\n        const emoji = rank === 1 ? 'üéØ' : rank === 2 ? 'ü•à' : 'ü•â';\n\n        let html = `\n            <div class=\"result-header\">\n                <div class=\"result-rank\">${emoji} ${rank === 1 ? 'RECOMMENDED' : `#${rank}`}</div>\n                <div class=\"result-title\">${entity.name}</div>\n                <div class=\"result-tier tier-${entity.tier.toLowerCase()}\">${entity.tier}</div>\n            </div>\n            <div class=\"result-score\">\n                <strong>Score:</strong> ${Math.round(rec.score)} |\n                <strong>Confidence:</strong> ${Math.round(rec.confidence * 100)}%\n            </div>\n        `;\n\n        if (rec.reasoning.length > 0) {\n            html += '<div class=\"result-section\"><strong>Why?</strong><ul>';\n            rec.reasoning.forEach((r: string) => {\n                html += `<li>‚úì ${r}</li>`;\n            });\n            html += '</ul></div>';\n        }\n\n        if (rec.synergies.length > 0) {\n            html += '<div class=\"result-section\"><strong>Synergies:</strong><ul>';\n            rec.synergies.forEach((s: string) => {\n                html += `<li class=\"synergy\">‚Ä¢ ${s}</li>`;\n            });\n            html += '</ul></div>';\n        }\n\n        if (rec.warnings.length > 0) {\n            html += '<div class=\"result-section warnings\"><strong>Warnings:</strong><ul>';\n            rec.warnings.forEach((w: string) => {\n                html += `<li class=\"warning\">‚ö†Ô∏è ${w}</li>`;\n            });\n            html += '</ul></div>';\n        }\n\n        card.innerHTML = html;\n        resultsContent.appendChild(card);\n    });\n\n    resultsDiv.style.display = 'block';\n\n    // Scroll to results\n    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });\n}\n\n/**\n * Reset advisor state\n */\nexport function resetAdvisor(): void {\n    currentBuild = {\n        character: null,\n        weapon: null,\n        items: [],\n        tomes: [],\n    };\n    selectedItems.clear();\n    selectedTomes.clear();\n\n    // Reset UI\n    const characterSelect = document.getElementById('advisor-character') as HTMLSelectElement;\n    const weaponSelect = document.getElementById('advisor-weapon') as HTMLSelectElement;\n    if (characterSelect) characterSelect.value = '';\n    if (weaponSelect) weaponSelect.value = '';\n\n    updateCurrentBuildDisplay();\n\n    // Clear choices\n    for (let i = 1; i <= 3; i++) {\n        const typeSelect = document.getElementById(`choice-${i}-type`) as HTMLSelectElement;\n        const entitySelect = document.getElementById(`choice-${i}-entity`) as HTMLSelectElement;\n        if (typeSelect) typeSelect.value = '';\n        if (entitySelect) entitySelect.value = '';\n    }\n\n    // Hide results\n    const resultsDiv = document.getElementById('advisor-results');\n    if (resultsDiv) resultsDiv.style.display = 'none';\n}\n\n// ========================================\n// Global Assignments\n// ========================================\n// Expose functions globally for cross-module access\nwindow.initAdvisor = initAdvisor;\n// Type assertion needed: applyScannedBuild accepts BuildState but window type uses unknown for flexibility\nwindow.applyScannedBuild = applyScannedBuild as typeof window.applyScannedBuild;\n"],"names":["TIER_SCORES","SS","S","A","B","C","calculateSynergyScore","choice","build","score","synergies","antiSynergies","entity","entityName","name","character","charSynergies","synergies_items","charWeaponSynergies","synergies_weapons","type","some","s","length","toLowerCase","includes","push","weapon","item","allWeaponSynergies","buildItem","items","itemEntity","anti_synergies","calculateRedundancyPenalty","penalty","one_and_done","i","id","reason","stacks_well","itemEffect","base_effect","similarCount","buildEffect","Math","min","calculateArchetypeFit","archetype","strength","bonus","effect","fits","fitReason","allData","currentBuild","tomes","selectedItems","Map","selectedTomes","initAdvisor","gameData","characterSelect","document","getElementById","characters","forEach","char","option","createElement","value","textContent","appendChild","weaponSelect","weapons","addEventListener","handleCharacterChange","handleWeaponChange","addItemBtn","showEntityModal","addTomeBtn","typeSelect","e","handleChoiceTypeChange","target","recommendBtn","handleGetRecommendation","setupEventListeners","logger","info","operation","data","charactersCount","weaponsCount","itemsCount","applyScannedBuild","state","clear","set","tome","updateCurrentBuildDisplay","tomesCount","characterId","find","c","weaponId","w","entities","modal","className","style","display","modalContent","closeBtn","innerHTML","onclick","remove","title","listContainer","entityCard","tier","Array","from","values","ToastManager","success","addEntityToCurrentBuild","body","itemsContainer","chip","createEntityChip","delete","addBtn","tomesContainer","onRemove","querySelector","choiceNumber","entitySelect","shrines","choices","entityId","error","recommendations","damageCount","tankCount","critCount","procCount","speedCount","itemName","desc","description","statAffected","stat_affected","total","scores","count","sort","a","b","dominant","detectBuildArchetype","reasoning","warnings","tierScore","synergyScore","redundancyPenalty","redundancyReason","archetypeBonus","archetypeReason","confidence","max","recommendBestChoice","resultsDiv","resultsContent","rec","index","card","rank","html","round","r","scrollIntoView","behavior","block","displayRecommendations","choicesCount","topChoice","message","module","resetAdvisor","window"],"mappings":"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"}