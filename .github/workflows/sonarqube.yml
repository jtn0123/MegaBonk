name: SonarQube

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: sonar-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  sonarqube:
    name: SonarQube Scan
    if: github.event_name == 'push' || github.event.pull_request.head.repo.fork == false
    runs-on: [self-hosted, sonar]
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Wait for Test Suite workflow to finish and find its run ID
      - name: Wait for Test workflow
        id: wait-test
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.payload.pull_request?.head?.ref || context.ref?.replace('refs/heads/', '');
            const headSha = context.payload.pull_request?.head?.sha || context.sha;
            const triggerTime = new Date(Date.now() - 600000).toISOString();
            console.log(`Looking for Test Suite workflow on branch=${branch} sha=${headSha}`);

            for (let i = 0; i < 30; i++) {
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner, repo,
                branch: branch,
                head_sha: headSha,
                status: 'completed',
                per_page: 10,
                created: `>=${triggerTime.split('T')[0]}`
              });

              const testRun = runs.data.workflow_runs
                .filter(r => r.name === 'Test Suite' && r.status === 'completed' && r.head_sha === headSha)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

              if (testRun) {
                core.setOutput('run_id', testRun.id);
                console.log(`Found Test Suite run: ${testRun.id} (created ${testRun.created_at})`);
                return;
              }

              console.log(`Waiting for Test Suite workflow... (attempt ${i + 1}/30)`);
              await new Promise(r => setTimeout(r, 30000));
            }
            core.setFailed('Test Suite workflow did not complete in time');

      - name: Download unit coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-coverage
          path: coverage/unit/
          run-id: ${{ steps.wait-test.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify coverage files exist
        run: |
          echo "=== Coverage files ==="
          ls -la coverage/unit/lcov.info 2>/dev/null && echo "Unit lcov: $(wc -l < coverage/unit/lcov.info) lines" || echo "WARNING: No unit lcov.info!"
          ls -la coverage/merged/lcov.info 2>/dev/null && echo "Merged lcov: $(wc -l < coverage/merged/lcov.info) lines" || echo "INFO: No merged lcov.info (E2E may have been skipped)"
          echo "=== Sample SF paths from unit lcov ==="
          grep "^SF:" coverage/unit/lcov.info 2>/dev/null | head -5
          echo "=== Non-zero coverage lines (sample) ==="
          grep "^DA:" coverage/unit/lcov.info 2>/dev/null | grep -v ",0$" | head -5

      - uses: sonarsource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.verbose=true

      - uses: sonarsource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
