<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Validation Tool - MegaBonk</title>
    <link rel="stylesheet" href="cv-validator/styles/base.css">
    <link rel="stylesheet" href="cv-validator/styles/layout.css">
    <link rel="stylesheet" href="cv-validator/styles/components.css">
    <link rel="stylesheet" href="cv-validator/styles/modal.css">
</head>
<body>
    <h1>CV Validation Tool</h1>
    <p class="header-info">Compare CV detection results against ground truth labels</p>

    <div class="controls">
        <select id="image-select">
            <option value="">-- Select a test image --</option>
        </select>
        <div class="confidence-slider">
            <label>Confidence:</label>
            <input type="range" id="confidence-threshold" min="0.3" max="0.9" step="0.01" value="0.45">
            <span class="value" id="confidence-value">0.45</span>
        </div>
        <div class="confidence-slider">
            <label>Grid Y Offset:</label>
            <input type="range" id="grid-y-offset" min="-100" max="100" step="5" value="0">
            <span class="value" id="grid-y-value">0px</span>
        </div>
        <div class="confidence-slider">
            <label>Show Slots:</label>
            <input type="text" id="slot-filter" placeholder="all, or 0,1,5" style="width: 80px; padding: 5px 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-panel); color: var(--text-primary);">
        </div>
        <button id="run-detection" class="primary" disabled>Run Detection</button>
        <button id="run-all">Run All Tests</button>
        <button id="export-validated" disabled>Export Validated</button>
        <button id="toggle-grid-calibration">Grid Calibration &#x25BC;</button>
    </div>

    <div class="page-layout">
        <div class="main-area">
            <div class="main-content">
                <div class="panel screenshot-panel">
                    <h2>Screenshot</h2>
                    <div class="image-container" id="screenshot-container">
                        <img id="screenshot-img" src="" alt="Screenshot">
                        <canvas id="overlay-canvas"></canvas>
                    </div>
                    <p class="status-message" id="image-info">Select an image to begin</p>
                    <p class="expand-hint">Click slot to correct, click outside slots to view full size</p>
                </div>

                <!-- Grid Calibration Panel - right below image -->
                <div class="grid-calibration-panel" id="grid-calibration-panel" style="display: none;">
                    <div class="calibration-row">
                        <div class="calibration-control">
                            <label>X Offset:</label>
                            <input type="range" id="grid-x-offset" min="-200" max="200" step="1" value="0">
                            <span class="value" id="grid-x-value">0px</span>
                        </div>
                        <div class="calibration-control">
                            <label>Icon Width:</label>
                            <input type="range" id="icon-width" min="20" max="80" step="1" value="40">
                            <span class="value" id="icon-width-value">40px</span>
                        </div>
                        <div class="calibration-control">
                            <label>Icon Height:</label>
                            <input type="range" id="icon-height" min="20" max="80" step="1" value="40">
                            <span class="value" id="icon-height-value">40px</span>
                        </div>
                    </div>
                    <div class="calibration-row">
                        <div class="calibration-control">
                            <label>X Spacing:</label>
                            <input type="range" id="x-spacing" min="0" max="20" step="1" value="4">
                            <span class="value" id="x-spacing-value">4px</span>
                        </div>
                        <div class="calibration-control">
                            <label>Y Spacing:</label>
                            <input type="range" id="y-spacing" min="0" max="40" step="1" value="4">
                            <span class="value" id="y-spacing-value">4px</span>
                        </div>
                        <div class="calibration-control">
                            <label>Icons/Row:</label>
                            <input type="range" id="icons-per-row" min="10" max="30" step="1" value="20">
                            <span class="value" id="icons-per-row-value">20</span>
                        </div>
                        <div class="calibration-control">
                            <label>Rows:</label>
                            <input type="range" id="num-rows" min="1" max="5" step="1" value="3">
                            <span class="value" id="num-rows-value">3</span>
                        </div>
                    </div>
                    <div class="calibration-info">
                        <span id="resolution-info">Resolution: --</span>
                        <span id="scale-info">Scale: --</span>
                        <button id="reset-calibration">Reset to Defaults</button>
                    </div>
                    <div class="preset-controls">
                        <span id="preset-status">No preset loaded</span>
                        <button id="save-preset">Save Preset</button>
                        <button id="load-preset">Load Preset</button>
                        <button id="delete-preset">Delete</button>
                    </div>
                </div>

                <!-- Metrics - below calibration -->
                <div class="metrics-grid">
                    <div class="metric-card" id="metric-f1">
                        <div class="value">--</div>
                        <div class="label">F1 Score</div>
                    </div>
                    <div class="metric-card" id="metric-precision">
                        <div class="value">--</div>
                        <div class="label">Precision</div>
                    </div>
                    <div class="metric-card" id="metric-recall">
                        <div class="value">--</div>
                        <div class="label">Recall</div>
                    </div>
                    <div class="metric-card" id="metric-detected">
                        <div class="value">--</div>
                        <div class="label">Detected Items</div>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item"><span class="dot match"></span> Match</div>
                    <div class="legend-item"><span class="dot false-positive"></span> False Positive</div>
                    <div class="legend-item"><span class="dot missing"></span> Missing</div>
                </div>

                <div class="secondary-panels">
                <div class="panel">
                    <h2>CV Detection <span class="count" id="detection-count">0</span> <span class="corrections-counter" id="corrections-counter">0 corrections</span></h2>
                    <div class="progress-bar" id="progress-container" style="display: none;">
                        <div class="fill" id="progress-fill"></div>
                    </div>
                    <p class="status-message" id="detection-status">Waiting...</p>
                    <div class="item-list" id="detected-items"></div>

                    <!-- Correction Panel -->
                    <div class="correction-panel" id="correction-panel">
                        <h3>
                            Correct Detection
                            <span class="slot-badge" id="correction-slot-badge">Slot 0</span>
                        </h3>
                        <div class="current-detection" id="current-detection-display">
                            <img id="correction-current-img" src="" alt="">
                            <div class="info">
                                <div class="name" id="correction-current-name">Item Name</div>
                                <div class="confidence" id="correction-current-conf">Confidence: 0%</div>
                            </div>
                        </div>

                        <div class="correction-section">
                            <h4>Quick Picks (Top Alternatives)</h4>
                            <div class="quick-picks" id="quick-picks"></div>
                        </div>

                        <div class="correction-section">
                            <h4>Search All Items</h4>
                            <div class="correction-search">
                                <input type="text" id="correction-search-input" placeholder="Search items...">
                            </div>
                            <div class="filter-buttons" id="correction-filters">
                                <button class="filter-btn active" data-rarity="all">All</button>
                                <button class="filter-btn" data-rarity="common">Common</button>
                                <button class="filter-btn" data-rarity="uncommon">Uncommon</button>
                                <button class="filter-btn" data-rarity="rare">Rare</button>
                                <button class="filter-btn" data-rarity="epic">Epic</button>
                                <button class="filter-btn" data-rarity="legendary">Legendary</button>
                            </div>
                            <div class="correction-results" id="correction-results"></div>
                            <div class="results-count" id="results-count" style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;"></div>
                        </div>

                        <div class="correction-actions">
                            <button class="apply-btn" id="apply-correction-btn" disabled>Apply Correction</button>
                            <button class="correct-btn" id="mark-correct-btn">Mark Correct âœ“</button>
                            <button class="empty-btn" id="mark-empty-btn">Mark as Empty</button>
                            <button class="cancel-btn" id="cancel-correction-btn">Cancel</button>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>Ground Truth <span class="count" id="truth-count">0</span></h2>
                    <div class="item-list" id="truth-items"></div>
                </div>
                </div><!-- end secondary-panels -->
            </div>

            <div id="log-panel">
                <h3>Detection Log</h3>
                <div id="log-content"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="panel">
                <h2>Item Reference <span class="count" id="ref-count">0</span></h2>
                <div class="search-box">
                    <input type="text" id="item-search" placeholder="Search items...">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-rarity="all">All</button>
                    <button class="filter-btn" data-rarity="common">Common</button>
                    <button class="filter-btn" data-rarity="uncommon">Uncommon</button>
                    <button class="filter-btn" data-rarity="rare">Rare</button>
                    <button class="filter-btn" data-rarity="epic">Epic</button>
                    <button class="filter-btn" data-rarity="legendary">Legendary</button>
                </div>
                <div class="item-reference-list" id="item-reference-list"></div>
            </div>
        </div>
    </div>

    <div class="copy-toast" id="copy-toast">Copied!</div>

    <!-- Image Modal for Full Size View -->
    <div class="image-modal" id="image-modal">
        <div class="image-modal-header">
            <h3 id="modal-title">Screenshot</h3>
            <div class="zoom-controls">
                <button onclick="zoomImage(-0.25)">-</button>
                <span id="zoom-level">100%</span>
                <button onclick="zoomImage(0.25)">+</button>
                <button onclick="resetZoom()">Reset</button>
                <button onclick="fitToScreen()">Fit</button>
                <button class="image-modal-close" onclick="closeImageModal()">Close (Esc)</button>
            </div>
        </div>
        <div class="image-modal-content" id="modal-content">
            <div class="modal-loading" id="modal-loading">Loading image...</div>
            <img id="modal-img" src="" alt="Full size screenshot">
            <canvas id="modal-overlay"></canvas>
        </div>
    </div>

    <script type="module" src="cv-validator/js/main.js"></script>
</body>
</html>
