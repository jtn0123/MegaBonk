<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Validation Tool - MegaBonk</title>
    <link rel="stylesheet" href="cv-validator/styles/base.css">
    <link rel="stylesheet" href="cv-validator/styles/layout.css">
    <link rel="stylesheet" href="cv-validator/styles/components.css">
    <link rel="stylesheet" href="cv-validator/styles/modal.css">
</head>
<body>
    <h1>CV Validation Tool</h1>
    <p class="header-info">Compare CV detection results against ground truth labels</p>
    <nav class="page-nav">
        <a href="cv-validator.html" class="active">üîç Validator</a>
        <a href="cv-analytics.html">üìä Analytics</a>
        <a href="cv-performance.html">‚ö° Performance</a>
        <a href="training-validator.html">üéØ Training Data</a>
        <a href="quick-test.html">üß™ Quick Test</a>
        <a href="image-manager.html">üóÇÔ∏è Image Manager</a>
    </nav>

    <div class="controls">
        <select id="image-select">
            <option value="">-- Select a test image --</option>
        </select>
        <div class="confidence-slider">
            <label>Confidence:</label>
            <input type="range" id="confidence-threshold" min="0.3" max="0.9" step="0.01" value="0.45">
            <span class="value" id="confidence-value">0.45</span>
        </div>
        <div class="confidence-slider">
            <label>Grid Y Offset:</label>
            <input type="range" id="grid-y-offset" min="-100" max="100" step="1" value="0">
            <span class="value" id="grid-y-value">0px</span>
        </div>
        <div class="detection-options">
            <label>Detection:</label>
            <div class="toggle-group">
                <button id="toggle-enhanced" class="toggle-btn active" title="Multi-method similarity (NCC+SSIM+histogram+edges)">
                    Enhanced
                </button>
                <div class="training-toggle-wrapper">
                    <button id="toggle-training" class="toggle-btn active" title="Use training data templates">
                        Training Data
                    </button>
                    <button id="training-sources-btn" class="sources-btn" title="Select training data sources">‚ñº</button>
                    <div class="training-sources-dropdown" id="training-sources-dropdown">
                        <div class="sources-header">
                            <span>Training Sources</span>
                            <button id="sources-select-all" class="sources-action">All</button>
                            <button id="sources-select-none" class="sources-action">None</button>
                        </div>
                        <div class="sources-list" id="sources-list">
                            <p class="sources-loading">Loading sources...</p>
                        </div>
                        <div class="sources-footer">
                            <a href="training-validator.html" target="_blank" class="validate-link">Validate Training Data &rarr;</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="confidence-slider">
            <label>Show Slots:</label>
            <div class="slot-filter-wrapper">
                <input type="text" id="slot-filter" placeholder="all, or 0,1,5">
                <button id="slot-filter-helper-btn" class="helper-btn" title="Quick filter presets">...</button>
                <div class="slot-filter-helper" id="slot-filter-helper">
                    <div class="helper-presets">
                        <button data-filter="all">All</button>
                        <button data-filter="0-19">Row 1</button>
                        <button data-filter="20-39">Row 2</button>
                        <button data-filter="40-59">Row 3</button>
                        <button data-filter="0-9">First 10</button>
                        <button data-filter="0-19">First 20</button>
                    </div>
                    <div class="helper-hint">Format: all, 0-19, 0,1,5</div>
                </div>
            </div>
        </div>
        <button id="run-detection" class="primary" disabled>Run Detection</button>
        <button id="run-all">Run All Tests</button>
        <button id="toggle-batch" class="batch-btn" disabled title="Keyboard: ‚Üê/‚Üí navigate, Enter accept, E empty, S skip">Bulk Label</button>
        <button id="save-training" class="save-training" disabled>Save to Training</button>
        <button id="export-validated" disabled>Export JSON</button>
        <button id="toggle-grid-calibration">Grid Calibration &#x25BC;</button>
        <button id="toggle-ablation" class="toggle-ablation-btn">Ablation Testing &#x25BC;</button>
        <button id="toggle-debug" class="toggle-debug-btn">Debug Panel &#x25BC;</button>
    </div>

    <!-- File System Status Indicator -->
    <div class="fs-status-bar" id="fs-status-bar">
        <div class="fs-status-indicator" id="fs-status">
            <span class="fs-icon" id="fs-icon">&#128193;</span>
            <span class="fs-path" id="fs-path">No directory selected</span>
            <span class="fs-permission" id="fs-permission"></span>
        </div>
        <div class="fs-actions">
            <button id="fs-select-dir" class="fs-btn">Select Directory</button>
            <button id="fs-clear-dir" class="fs-btn" style="display: none;">Clear</button>
        </div>
        <div class="fs-method" id="fs-method">Save method: Download fallback</div>
    </div>

    <div class="page-layout">
        <div class="main-area">
            <div class="main-content">
                <div class="panel screenshot-panel">
                    <h2>Screenshot</h2>
                    <div class="image-container" id="screenshot-container">
                        <img id="screenshot-img" src="" alt="Screenshot">
                        <canvas id="overlay-canvas"></canvas>
                    </div>
                    <p class="status-message" id="image-info">Select an image to begin</p>
                    <p class="expand-hint">Click slot to correct, click outside slots to view full size</p>
                </div>

                <!-- Grid Calibration Panel - right below image -->
                <div class="grid-calibration-panel" id="grid-calibration-panel" style="display: none;">
                    <div class="calibration-grid">
                        <div class="cal-group">
                            <span class="cal-group-label">Position</span>
                            <div class="cal-input">
                                <label>X</label>
                                <input type="number" id="grid-x-offset" min="-200" max="200" step="1" value="0">
                                <span class="unit">px</span>
                            </div>
                            <div class="cal-input">
                                <label>Y</label>
                                <input type="number" id="cal-y-offset" min="-100" max="100" step="1" value="0">
                                <span class="unit">px</span>
                            </div>
                        </div>
                        <div class="cal-group">
                            <span class="cal-group-label">Icon Size</span>
                            <div class="cal-input">
                                <label>W</label>
                                <input type="number" id="icon-width" min="20" max="80" step="1" value="40">
                                <span class="unit">px</span>
                            </div>
                            <div class="cal-input">
                                <label>H</label>
                                <input type="number" id="icon-height" min="20" max="80" step="1" value="40">
                                <span class="unit">px</span>
                            </div>
                        </div>
                        <div class="cal-group">
                            <span class="cal-group-label">Spacing</span>
                            <div class="cal-input">
                                <label>X</label>
                                <input type="number" id="x-spacing" min="0" max="20" step="1" value="4">
                                <span class="unit">px</span>
                            </div>
                            <div class="cal-input">
                                <label>Y</label>
                                <input type="number" id="y-spacing" min="0" max="40" step="1" value="4">
                                <span class="unit">px</span>
                            </div>
                        </div>
                        <div class="cal-group">
                            <span class="cal-group-label">Grid</span>
                            <div class="cal-input">
                                <label>Cols</label>
                                <input type="number" id="icons-per-row" min="10" max="30" step="1" value="20">
                            </div>
                            <div class="cal-input">
                                <label>Rows</label>
                                <input type="number" id="num-rows" min="1" max="5" step="1" value="3">
                            </div>
                            <div class="cal-input">
                                <label>Items</label>
                                <input type="number" id="total-items" min="1" max="100" step="1" value="60">
                            </div>
                        </div>
                    </div>
                    <div class="calibration-info">
                        <span id="resolution-info">Resolution: --</span>
                        <span id="scale-info">Scale: --</span>
                        <button id="reset-calibration">Reset to Defaults</button>
                    </div>
                    <!-- Advanced Detection Settings -->
                    <div class="advanced-settings-toggle">
                        <button id="toggle-advanced" class="toggle-advanced-btn">Advanced Settings &#x25BC;</button>
                    </div>
                    <div class="advanced-settings" id="advanced-settings" style="display: none;">
                        <div class="calibration-row">
                            <div class="calibration-control">
                                <label>Empty Variance:</label>
                                <input type="range" id="empty-variance" min="50" max="500" step="10" value="300">
                                <span class="value" id="empty-variance-value">300</span>
                            </div>
                            <div class="calibration-control">
                                <label>Template Margin:</label>
                                <input type="range" id="template-margin" min="0" max="30" step="1" value="15">
                                <span class="value" id="template-margin-value">15%</span>
                            </div>
                            <div class="calibration-control">
                                <label>Top Matches:</label>
                                <input type="range" id="top-matches" min="3" max="10" step="1" value="5">
                                <span class="value" id="top-matches-value">5</span>
                            </div>
                        </div>
                        <div class="advanced-actions">
                            <button id="reset-advanced">Reset to Defaults</button>
                        </div>
                    </div>
                    <div class="preset-controls">
                        <div class="preset-status-container">
                            <span id="preset-status">No preset loaded</span>
                            <span class="preset-badge" id="preset-badge"></span>
                            <span class="preset-modified-warning" id="preset-modified" style="display: none;">
                                &#x26A0; Modified: <span id="modified-fields"></span>
                            </span>
                        </div>
                        <div class="preset-buttons">
                            <button id="save-preset">Save Preset</button>
                            <button id="load-preset">Load Preset</button>
                            <button id="mark-verified" class="verified-btn" title="Mark current calibration as verified master preset">Mark Verified ‚úì</button>
                            <button id="delete-preset">Delete</button>
                            <button id="export-all-presets" title="Export all presets to JSON file">Export All</button>
                            <button id="reload-presets" title="Reload presets from grid-presets.json file">Reload</button>
                        </div>
                    </div>

                    <!-- Auto-Detect Section -->
                    <div class="auto-detect-section">
                        <div class="auto-detect-header">
                            <button id="auto-detect-btn" class="auto-detect-btn" disabled>
                                <span class="auto-detect-icon">üîç</span> Auto-Detect Grid
                            </button>
                            <button id="detect-with-auto-grid" class="detect-with-auto-btn" disabled title="Auto-detect grid, apply, then run item detection">
                                <span class="auto-detect-icon">‚ö°</span> Detect (Auto-Grid)
                            </button>
                            <span class="auto-detect-status" id="auto-detect-status"></span>
                        </div>
                        <div class="auto-detect-progress" id="auto-detect-progress" style="display: none;">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" id="auto-detect-progress-fill"></div>
                            </div>
                            <span class="progress-text" id="auto-detect-progress-text">Detecting...</span>
                        </div>
                        <div class="auto-detect-results" id="auto-detect-results" style="display: none;">
                            <div class="detection-confidence">
                                <span class="confidence-label">Detection Confidence:</span>
                                <span class="confidence-value" id="auto-detect-confidence">0%</span>
                                <span class="confidence-bar">
                                    <span class="confidence-fill" id="auto-detect-confidence-fill"></span>
                                </span>
                            </div>
                            <div class="detection-stats" id="auto-detect-stats">
                                <span class="stat"><strong>Cells:</strong> <span id="auto-cells">0</span></span>
                                <span class="stat"><strong>Valid:</strong> <span id="auto-valid">0</span></span>
                                <span class="stat"><strong>Empty:</strong> <span id="auto-empty">0</span></span>
                            </div>
                            <div class="comparison-toggle">
                                <button id="toggle-comparison" class="toggle-comparison-btn">
                                    Compare with Preset ‚ñº
                                </button>
                            </div>
                            <div class="comparison-view" id="comparison-view" style="display: none;">
                                <table class="comparison-table">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Auto</th>
                                            <th>Preset</th>
                                            <th>Diff</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparison-table-body">
                                    </tbody>
                                </table>
                                <div class="comparison-summary" id="comparison-summary"></div>
                            </div>
                            <div class="auto-detect-actions">
                                <button id="apply-auto-detect" class="apply-auto-btn">Apply Auto-Detected</button>
                                <button id="toggle-overlay" class="overlay-btn">Show Overlay</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ablation Testing Panel -->
                <div class="ablation-panel" id="ablation-panel">
                    <div class="ablation-header">
                        <h3><span class="icon">üß™</span> Ablation Testing</h3>
                        <div class="ablation-header-actions">
                            <button id="reset-ablation-config" class="preset-btn">Reset to Default</button>
                        </div>
                    </div>
                    <div class="ablation-body">
                        <!-- Presets -->
                        <div class="ablation-presets">
                            <label>Quick Presets:</label>
                            <button class="preset-btn" data-preset="baseline-all-on">Baseline (All On)</button>
                            <button class="preset-btn" data-preset="minimal">Minimal</button>
                            <button class="preset-btn" data-preset="no-preprocessing">No Preprocessing</button>
                            <button class="preset-btn" data-preset="no-dynamic-grid">Static Grid</button>
                            <button class="preset-btn" data-preset="ssim-only">SSIM Only</button>
                            <button class="preset-btn" data-preset="ncc-only">NCC Only</button>
                            <button class="preset-btn" data-preset="all-metrics">All Metrics</button>
                        </div>

                        <!-- Live Metrics -->
                        <div class="ablation-live-metrics">
                            <div class="live-metric f1">
                                <div class="value" id="ablation-f1">--</div>
                                <div class="label">F1 Score</div>
                            </div>
                            <div class="live-metric precision">
                                <div class="value" id="ablation-precision">--</div>
                                <div class="label">Precision</div>
                            </div>
                            <div class="live-metric recall">
                                <div class="value" id="ablation-recall">--</div>
                                <div class="label">Recall</div>
                            </div>
                            <div class="live-metric">
                                <div class="value" id="ablation-time">--</div>
                                <div class="label">Time (ms)</div>
                            </div>
                        </div>

                        <!-- Component Toggles by Category -->
                        <div class="ablation-categories">
                            <!-- Template Matching -->
                            <div class="ablation-category">
                                <h4>Template Matching</h4>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useMultiScale" checked>
                                    <span class="toggle-label">Multi-Scale</span>
                                    <span class="toggle-hint">48/64px</span>
                                </label>
                            </div>

                            <!-- Preprocessing -->
                            <div class="ablation-category">
                                <h4>Preprocessing</h4>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useContrastEnhancement" checked>
                                    <span class="toggle-label">Contrast Enhancement</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useColorNormalization" checked>
                                    <span class="toggle-label">Color Normalization</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useSharpening">
                                    <span class="toggle-label">Sharpening</span>
                                    <span class="toggle-hint">slower</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useHistogramEqualization">
                                    <span class="toggle-label">Histogram Eq.</span>
                                    <span class="toggle-hint">slower</span>
                                </label>
                            </div>

                            <!-- Grid Detection -->
                            <div class="ablation-category">
                                <h4>Grid Detection</h4>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useDynamicGrid" checked>
                                    <span class="toggle-label">Dynamic Grid</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useResolutionAwareParams" checked>
                                    <span class="toggle-label">Resolution-Aware</span>
                                </label>
                            </div>

                            <!-- Filtering -->
                            <div class="ablation-category">
                                <h4>Filtering</h4>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useRarityFiltering" checked>
                                    <span class="toggle-label">Rarity Filtering</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useEmptyCellFilter" checked>
                                    <span class="toggle-label">Empty Cell Filter</span>
                                </label>
                            </div>

                            <!-- Similarity Metrics -->
                            <div class="ablation-category">
                                <h4>Similarity Metrics</h4>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-metrics.ssim" checked>
                                    <span class="toggle-label">SSIM</span>
                                    <span class="toggle-hint">40%</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-metrics.ncc" checked>
                                    <span class="toggle-label">NCC</span>
                                    <span class="toggle-hint">35%</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-metrics.histogram" checked>
                                    <span class="toggle-label">Histogram</span>
                                    <span class="toggle-hint">25%</span>
                                </label>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-metrics.edge">
                                    <span class="toggle-label">Edge</span>
                                    <span class="toggle-hint">slower</span>
                                </label>
                            </div>

                            <!-- Scoring -->
                            <div class="ablation-category">
                                <h4>Scoring</h4>
                                <label class="ablation-toggle">
                                    <input type="checkbox" id="toggle-useAgreementBonus" checked>
                                    <span class="toggle-label">Agreement Bonus</span>
                                    <span class="toggle-hint">+3%</span>
                                </label>
                            </div>
                        </div>

                        <!-- Component Impact (populated after batch tests) -->
                        <div class="ablation-impact" id="ablation-impact" style="display: none;">
                            <h4>Component Impact (from batch tests)</h4>
                            <div class="impact-list" id="impact-list"></div>
                        </div>

                        <!-- Actions -->
                        <div class="ablation-actions">
                            <button id="apply-ablation-config" class="primary">Apply & Re-detect</button>
                            <button id="run-ablation-batch" class="run-ablation-btn" disabled>Run Batch Ablation</button>
                            <button id="clear-ablation-results">Clear Results</button>
                        </div>

                        <!-- Ablation Results Table -->
                        <div class="ablation-results" id="ablation-results" style="display: none;">
                            <h4>Batch Ablation Results</h4>
                            <table class="ablation-results-table">
                                <thead>
                                    <tr>
                                        <th>Config</th>
                                        <th>F1</th>
                                        <th>Precision</th>
                                        <th>Recall</th>
                                        <th>Time</th>
                                        <th>Œî Baseline</th>
                                    </tr>
                                </thead>
                                <tbody id="ablation-results-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Debug Visualization Panel -->
                <div class="debug-panel" id="debug-panel" style="display: none;">
                    <div class="debug-header">
                        <h3><span class="icon">üìä</span> Debug Visualization</h3>
                        <button id="export-debug-data" class="export-btn">Export JSON</button>
                    </div>
                    <div class="debug-body">
                        <!-- Confidence Distribution -->
                        <div class="debug-section">
                            <h4>Confidence Distribution</h4>
                            <div class="confidence-histogram" id="confidence-histogram">
                                <div class="histogram-bars">
                                    <div class="histogram-bar" data-range="0.3-0.4"><span class="bar-fill" style="height: 0%"></span><span class="bar-label">0.3</span></div>
                                    <div class="histogram-bar" data-range="0.4-0.5"><span class="bar-fill" style="height: 0%"></span><span class="bar-label">0.4</span></div>
                                    <div class="histogram-bar" data-range="0.5-0.6"><span class="bar-fill" style="height: 0%"></span><span class="bar-label">0.5</span></div>
                                    <div class="histogram-bar" data-range="0.6-0.7"><span class="bar-fill" style="height: 0%"></span><span class="bar-label">0.6</span></div>
                                    <div class="histogram-bar" data-range="0.7-0.8"><span class="bar-fill" style="height: 0%"></span><span class="bar-label">0.7</span></div>
                                    <div class="histogram-bar" data-range="0.8-0.9"><span class="bar-fill" style="height: 0%"></span><span class="bar-label">0.8</span></div>
                                    <div class="histogram-bar" data-range="0.9-1.0"><span class="bar-fill" style="height: 0%"></span><span class="bar-label">0.9</span></div>
                                </div>
                                <div class="histogram-stats">
                                    <span>Mean: <b id="conf-mean">--</b></span>
                                    <span>Median: <b id="conf-median">--</b></span>
                                    <span>Uncertain: <b id="conf-uncertain">--</b></span>
                                </div>
                            </div>
                        </div>

                        <!-- Detection Config -->
                        <div class="debug-section">
                            <h4>Detection Config</h4>
                            <div class="debug-config">
                                <div class="config-item">
                                    <span class="label">Resolution Tier:</span>
                                    <span class="value" id="debug-tier">--</span>
                                </div>
                                <div class="config-item">
                                    <span class="label">Dynamic Threshold:</span>
                                    <span class="value" id="debug-threshold">--</span>
                                </div>
                                <div class="config-item">
                                    <span class="label">Strategies:</span>
                                    <span class="value" id="debug-strategies">--</span>
                                </div>
                                <div class="config-item">
                                    <span class="label">Scoring Weights:</span>
                                    <span class="value" id="debug-weights">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- Per-Rarity Breakdown -->
                        <div class="debug-section">
                            <h4>Per-Rarity Accuracy</h4>
                            <div class="rarity-breakdown" id="rarity-breakdown">
                                <div class="rarity-row common"><span class="rarity-name">Common</span><span class="rarity-stats" id="rarity-common">--</span></div>
                                <div class="rarity-row uncommon"><span class="rarity-name">Uncommon</span><span class="rarity-stats" id="rarity-uncommon">--</span></div>
                                <div class="rarity-row rare"><span class="rarity-name">Rare</span><span class="rarity-stats" id="rarity-rare">--</span></div>
                                <div class="rarity-row epic"><span class="rarity-name">Epic</span><span class="rarity-stats" id="rarity-epic">--</span></div>
                                <div class="rarity-row legendary"><span class="rarity-name">Legendary</span><span class="rarity-stats" id="rarity-legendary">--</span></div>
                            </div>
                        </div>

                        <!-- Uncertain Detections (Active Learning) -->
                        <div class="debug-section">
                            <h4>Uncertain Detections <span class="uncertain-badge" id="uncertain-count">0</span></h4>
                            <p class="section-hint">Click to verify or correct</p>
                            <div class="uncertain-list" id="uncertain-list">
                                <p class="no-uncertain">No uncertain detections</p>
                            </div>
                        </div>

                        <!-- Active Learning Stats -->
                        <div class="debug-section">
                            <h4>Active Learning <span class="learning-badge" id="learning-badge">Session</span></h4>
                            <div class="learning-stats" id="learning-stats">
                                <div class="stat-row">
                                    <span class="stat-label">Corrections this session:</span>
                                    <span class="stat-value" id="session-corrections">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Verifications this session:</span>
                                    <span class="stat-value" id="session-verifications">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Labels/min:</span>
                                    <span class="stat-value" id="labels-per-minute">0</span>
                                </div>
                            </div>

                            <h5>Common Confusions</h5>
                            <div class="confusion-list" id="confusion-list">
                                <p class="no-data">No confusion data yet</p>
                            </div>

                            <h5>Error-Prone Items</h5>
                            <div class="error-prone-list" id="error-prone-list">
                                <p class="no-data">No error-prone items detected</p>
                            </div>
                        </div>

                        <!-- Metrics History -->
                        <div class="debug-section">
                            <h4>Session Metrics</h4>
                            <div class="metrics-history">
                                <div class="metric-row"><span>Total Runs:</span><span id="metrics-runs">0</span></div>
                                <div class="metric-row"><span>Avg Detection Time:</span><span id="metrics-time">--</span></div>
                                <div class="metric-row"><span>Cache Hit Rate:</span><span id="metrics-cache">--</span></div>
                                <div class="metric-row"><span>Two-Phase Success:</span><span id="metrics-twophase">--</span></div>
                            </div>
                        </div>

                        <!-- Recommendations -->
                        <div class="debug-section recommendations-section">
                            <h4>Recommendations</h4>
                            <div class="recommendations-list" id="recommendations-list">
                                <p class="no-data">Run detection to see recommendations</p>
                            </div>

                            <div class="session-templates-info">
                                <div class="template-counter">
                                    <span class="icon">&#128202;</span>
                                    <span>Session Templates: <strong id="session-template-count">0</strong></span>
                                </div>
                                <p class="template-hint">Templates added during this session (cleared on page reload). Run import script after exporting to save permanently.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics - below calibration -->
                <div class="metrics-grid">
                    <div class="metric-card" id="metric-f1">
                        <div class="value">--</div>
                        <div class="label">F1 Score</div>
                    </div>
                    <div class="metric-card" id="metric-precision">
                        <div class="value">--</div>
                        <div class="label">Precision</div>
                    </div>
                    <div class="metric-card" id="metric-recall">
                        <div class="value">--</div>
                        <div class="label">Recall</div>
                    </div>
                    <div class="metric-card" id="metric-detected">
                        <div class="value">--</div>
                        <div class="label">Detected Items</div>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item"><span class="dot match"></span> Match</div>
                    <div class="legend-item"><span class="dot false-positive"></span> False Positive</div>
                    <div class="legend-item"><span class="dot missing"></span> Missing</div>
                </div>

                <!-- CV Detection Panel - Full Width -->
                <div class="panel cv-detection-panel">
                    <div class="cv-detection-header">
                        <h2>CV Detection <span class="count" id="detection-count">0</span>
                            <span class="corrections-wrapper">
                                <span class="corrections-counter" id="corrections-counter">0 corrections</span>
                                <div class="corrections-dropdown" id="corrections-dropdown">
                                    <div class="corrections-breakdown">
                                        <div class="breakdown-row"><span class="breakdown-icon verified">&#x2713;</span> <span id="breakdown-verified">0</span> verified</div>
                                        <div class="breakdown-row"><span class="breakdown-icon corrected">&#x2194;</span> <span id="breakdown-corrected">0</span> corrected</div>
                                        <div class="breakdown-row"><span class="breakdown-icon empty">&#x2205;</span> <span id="breakdown-empty">0</span> marked empty</div>
                                        <div class="breakdown-row"><span class="breakdown-icon unknown">?</span> <span id="breakdown-unknown">0</span> unknown</div>
                                    </div>
                                    <div class="validation-progress">
                                        <div class="progress-label">Validation progress</div>
                                        <div class="progress-track">
                                            <div class="progress-fill-validation" id="validation-progress-fill"></div>
                                        </div>
                                        <div class="progress-percent" id="validation-percent">0%</div>
                                    </div>
                                </div>
                            </span>
                        </h2>
                        <p class="status-message inline-status" id="detection-status">Waiting...</p>
                    </div>
                    <!-- Batch Progress Indicator -->
                    <div class="batch-progress" id="batch-progress" style="display: none;">
                        <div class="batch-progress-info">
                            <span id="batch-current-image">Processing...</span>
                            <span id="batch-progress-count">0/0</span>
                        </div>
                        <div class="batch-progress-bar">
                            <div class="batch-progress-fill" id="batch-progress-fill"></div>
                        </div>
                        <div class="batch-progress-stats">
                            <span>Running Avg F1: <span id="batch-running-f1">--</span></span>
                            <button id="batch-cancel" class="cancel-batch-btn">Cancel</button>
                        </div>
                    </div>
                    <div class="progress-bar" id="progress-container" style="display: none;">
                        <div class="fill" id="progress-fill"></div>
                    </div>
                    <div class="item-list" id="detected-items"></div>

                    <!-- Correction Panel -->
                    <div class="correction-panel" id="correction-panel">
                        <h3>
                            Correct Detection
                            <span class="slot-badge" id="correction-slot-badge">Slot 0</span>
                        </h3>
                        <div class="correction-layout">
                            <div class="correction-left">
                                <div class="current-detection" id="current-detection-display">
                                    <img id="correction-current-img" src="" alt="">
                                    <div class="info">
                                        <div class="name" id="correction-current-name">Item Name</div>
                                        <div class="confidence" id="correction-current-conf">Confidence: 0%</div>
                                    </div>
                                </div>
                                <div class="correction-section">
                                    <h4>Quick Picks</h4>
                                    <div class="quick-picks" id="quick-picks"></div>
                                </div>
                            </div>
                            <div class="correction-right">
                                <div class="correction-section">
                                    <h4>Search All Items</h4>
                                    <div class="correction-search">
                                        <input type="text" id="correction-search-input" placeholder="Search items...">
                                    </div>
                                    <div class="filter-buttons" id="correction-filters">
                                        <button class="filter-btn active" data-rarity="all">All</button>
                                        <button class="filter-btn" data-rarity="common">Common</button>
                                        <button class="filter-btn" data-rarity="uncommon">Uncommon</button>
                                        <button class="filter-btn" data-rarity="rare">Rare</button>
                                        <button class="filter-btn" data-rarity="epic">Epic</button>
                                        <button class="filter-btn" data-rarity="legendary">Legendary</button>
                                    </div>
                                    <div class="correction-results" id="correction-results"></div>
                                    <div class="results-count" id="results-count" style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;"></div>
                                </div>
                                <div class="correction-section">
                                    <h4>Unknown Item</h4>
                                    <div class="unknown-item-input">
                                        <input type="text" id="manual-item-input" placeholder="Type item name...">
                                        <button id="add-manual-item">Add</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="correction-actions">
                            <button class="apply-btn" id="apply-correction-btn" disabled>Apply Correction</button>
                            <button class="correct-btn" id="mark-correct-btn">Mark Correct ‚úì</button>
                            <button class="empty-btn" id="mark-empty-btn">Mark Empty</button>
                            <button class="cancel-btn" id="cancel-correction-btn">Cancel</button>
                        </div>
                    </div>

                    <!-- Batch Labeling Panel -->
                    <div class="batch-panel" id="batch-panel">
                        <div class="batch-header">
                            <h3>Bulk Labeling Mode</h3>
                            <div class="batch-progress-display">
                                <span id="batch-label-progress">0/0 (0%)</span>
                                <div class="batch-progress-track">
                                    <div class="batch-progress-fill-bar" id="batch-progress-bar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="batch-content">
                            <div class="batch-current">
                                <div class="batch-crop-container">
                                    <img id="batch-current-crop" src="" alt="Current slot">
                                </div>
                                <div class="batch-info">
                                    <div class="batch-slot-info" id="batch-slot-info">Slot 1 of --</div>
                                    <div class="batch-current-name" id="batch-current-name">--</div>
                                    <div class="batch-current-conf" id="batch-current-conf">--</div>
                                    <div class="batch-label-status unlabeled" id="batch-label-status">Not labeled</div>
                                </div>
                            </div>
                            <div class="batch-alternatives">
                                <h4>Quick Select (1-6)</h4>
                                <div class="batch-alt-list" id="batch-alternatives"></div>
                            </div>
                        </div>
                        <div class="batch-actions">
                            <button id="batch-prev" class="batch-nav-btn" title="‚Üê/A">‚óÄ Prev</button>
                            <button id="batch-accept" class="batch-accept-btn" title="Enter/Space">Accept ‚úì</button>
                            <button id="batch-empty" class="batch-empty-btn" title="E">Empty</button>
                            <button id="batch-skip" class="batch-skip-btn" title="S">Skip</button>
                            <button id="batch-next" class="batch-nav-btn" title="‚Üí/D">Next ‚ñ∂</button>
                        </div>
                        <div class="batch-footer">
                            <div class="batch-shortcuts">
                                <span>Keys: ‚Üê‚Üí navigate ‚Ä¢ Enter accept ‚Ä¢ E empty ‚Ä¢ S skip ‚Ä¢ 1-6 select alt ‚Ä¢ Esc exit</span>
                            </div>
                            <button id="batch-finish" class="batch-finish-btn">Finish Labeling</button>
                        </div>
                    </div>
                </div>

                <!-- Ground Truth - Full Width at Bottom -->
                <div class="panel ground-truth-panel">
                    <h2>Ground Truth <span class="count" id="truth-count">0</span></h2>
                    <div class="item-list" id="truth-items"></div>
                </div>
            </div>

            <div id="log-panel">
                <h3>Detection Log</h3>
                <div id="log-content"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="panel">
                <h2>Item Reference <span class="count" id="ref-count">0</span></h2>
                <div class="search-box">
                    <input type="text" id="item-search" placeholder="Search items...">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-rarity="all">All</button>
                    <button class="filter-btn" data-rarity="common">Common</button>
                    <button class="filter-btn" data-rarity="uncommon">Uncommon</button>
                    <button class="filter-btn" data-rarity="rare">Rare</button>
                    <button class="filter-btn" data-rarity="epic">Epic</button>
                    <button class="filter-btn" data-rarity="legendary">Legendary</button>
                </div>
                <div class="item-reference-list" id="item-reference-list"></div>
            </div>
        </div>
    </div>

    <div class="copy-toast" id="copy-toast">Copied!</div>

    <!-- Enhanced Training Toast -->
    <div class="training-toast" id="training-toast">
        <div class="toast-header">
            <span class="toast-icon" id="toast-icon">&#x2713;</span>
            <span class="toast-title" id="toast-title">Saved successfully</span>
            <button class="toast-close" id="toast-close">&times;</button>
        </div>
        <div class="toast-body">
            <div class="toast-filename" id="toast-filename"></div>
            <div class="toast-next-step">
                <span>Next step:</span>
                <code id="toast-command">npm run import:training</code>
                <button class="copy-cmd-btn" id="copy-cmd-btn" title="Copy to clipboard">&#128203;</button>
            </div>
        </div>
    </div>

    <!-- Export Preview Modal -->
    <div class="preview-modal" id="export-preview-modal">
        <div class="preview-modal-content">
            <div class="preview-header">
                <h3>Export Preview</h3>
                <button class="preview-close" id="preview-close">&times;</button>
            </div>
            <div class="preview-body">
                <div class="preview-file">
                    <label>File:</label>
                    <span id="preview-filename"></span>
                </div>
                <div class="preview-destination">
                    <label>Destination:</label>
                    <span id="preview-destination"></span>
                </div>
                <div class="preview-summary">
                    <h4>Summary</h4>
                    <ul>
                        <li><span id="preview-slots">0</span> slots detected</li>
                        <li><span id="preview-corrections">0</span> corrections made (<span id="preview-corrections-detail"></span>)</li>
                        <li><span id="preview-crops">0</span> training crops will be saved</li>
                        <li><span id="preview-unknown">0</span> unknown items flagged</li>
                        <li>Estimated size: <span id="preview-size">~0 KB</span></li>
                    </ul>
                </div>
            </div>
            <div class="preview-actions">
                <button class="cancel-btn" id="preview-cancel">Cancel</button>
                <button class="confirm-btn" id="preview-confirm">Save to Training</button>
            </div>
        </div>
    </div>

    <!-- Batch Test Results Modal -->
    <div class="batch-modal" id="batch-results-modal">
        <div class="batch-modal-content">
            <div class="batch-header">
                <h3>Batch Test Results</h3>
                <button class="batch-close" id="batch-close">&times;</button>
            </div>
            <div class="batch-body">
                <table class="batch-table" id="batch-table">
                    <thead>
                        <tr>
                            <th data-sort="image">Image</th>
                            <th data-sort="f1">F1</th>
                            <th data-sort="precision">Prec</th>
                            <th data-sort="recall">Recall</th>
                            <th data-sort="detected">Det/Exp</th>
                        </tr>
                    </thead>
                    <tbody id="batch-table-body">
                    </tbody>
                </table>
                <div class="batch-summary" id="batch-summary">
                    <span>Average: F1=<span id="batch-avg-f1">--</span> Precision=<span id="batch-avg-precision">--</span> Recall=<span id="batch-avg-recall">--</span></span>
                </div>
            </div>
            <div class="batch-actions">
                <button class="export-btn" id="batch-export-csv">Export CSV</button>
                <button class="export-btn" id="batch-export-json">Export JSON</button>
            </div>
        </div>
    </div>

    <!-- Image Modal for Full Size View -->
    <div class="image-modal" id="image-modal">
        <div class="image-modal-header">
            <h3 id="modal-title">Screenshot</h3>
            <div class="zoom-controls">
                <button onclick="zoomImage(-0.25)">-</button>
                <span id="zoom-level">100%</span>
                <button onclick="zoomImage(0.25)">+</button>
                <button onclick="resetZoom()">Reset</button>
                <button onclick="fitToScreen()">Fit</button>
                <button class="image-modal-close" onclick="closeImageModal()">Close (Esc)</button>
            </div>
        </div>
        <div class="image-modal-content" id="modal-content">
            <div class="modal-loading" id="modal-loading">Loading image...</div>
            <img id="modal-img" src="" alt="Full size screenshot">
            <canvas id="modal-overlay"></canvas>
        </div>
    </div>

    <script type="module" src="cv-validator/js/main.js"></script>
</body>
</html>
