<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Data Validator - MegaBonk</title>
    <style>
        :root {
            --bg: #0f1419;
            --bg-card: #1a1f2e;
            --bg-panel: #232936;
            --border: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #8b9ab5;
            --accent: #e94560;
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #f87171;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
        }

        h1 {
            margin-bottom: 8px;
            color: var(--accent);
        }

        .header-info {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls select, .controls input, .controls button {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-panel);
            color: var(--text-primary);
            font-size: 14px;
        }

        .controls button {
            cursor: pointer;
        }

        .controls button:hover {
            border-color: var(--accent);
        }

        .controls button.primary {
            background: var(--accent);
            border-color: var(--accent);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            gap: 6px;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: bold;
            color: var(--accent);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
        }

        .card:hover {
            border-color: var(--accent);
        }

        .card.valid {
            border-color: var(--success);
            background: rgba(74, 222, 128, 0.05);
        }

        .card.invalid {
            border-color: var(--error);
            background: rgba(248, 113, 113, 0.1);
        }

        .card.unreadable {
            border-color: var(--warning);
            background: rgba(251, 191, 36, 0.1);
            opacity: 0.7;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: bold;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .sample-id {
            font-size: 10px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .comparison {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        .image-box {
            text-align: center;
        }

        .image-box img {
            width: 64px;
            height: 64px;
            border-radius: 6px;
            border: 2px solid var(--border);
            background: #000;
            object-fit: contain;
        }

        .image-box.crop img {
            border-color: var(--accent);
        }

        .image-box.ref img {
            border-color: var(--text-secondary);
        }

        .image-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .vs {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .meta div {
            margin-bottom: 2px;
        }

        .actions {
            display: flex;
            gap: 6px;
        }

        .actions button {
            flex: 1;
            padding: 6px 10px;
            font-size: 11px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-panel);
            color: var(--text-primary);
            cursor: pointer;
        }

        .actions button:hover {
            border-color: var(--accent);
        }

        .actions button.mark-valid {
            background: rgba(74, 222, 128, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .actions button.mark-invalid {
            background: rgba(248, 113, 113, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .actions button.mark-unreadable {
            background: rgba(251, 191, 36, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .actions button.delete {
            background: var(--error);
            border-color: var(--error);
            color: #000;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .source-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: var(--bg-panel);
            border-radius: 3px;
            color: var(--text-secondary);
            display: inline-block;
            margin-top: 4px;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .zoom-modal.show {
            display: flex;
        }

        .zoom-modal img {
            max-width: 90%;
            max-height: 70%;
            image-rendering: pixelated;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .zoom-modal .close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .zoom-comparison {
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .zoom-comparison .image-box img {
            width: 128px;
            height: 128px;
        }
    </style>
</head>
<body>
    <h1>Training Data Validator</h1>
    <p class="header-info">Validate training crops against reference icons to catch regressions</p>

    <div class="controls">
        <select id="filter-item">
            <option value="">All Items</option>
        </select>
        <select id="filter-source">
            <option value="">All Sources</option>
        </select>
        <select id="filter-status">
            <option value="">All Status</option>
            <option value="unreviewed">Unreviewed</option>
            <option value="valid">Valid</option>
            <option value="invalid">Invalid</option>
            <option value="unreadable">Unreadable</option>
        </select>
        <input type="text" id="search" placeholder="Search items...">
        <button id="mark-all-valid">Mark All Valid</button>
        <button id="export-report">Export Report</button>
    </div>

    <div class="stats">
        <div class="stat">
            <span class="stat-label">Total:</span>
            <span class="stat-value" id="stat-total">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Valid:</span>
            <span class="stat-value" id="stat-valid" style="color: var(--success)">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Invalid:</span>
            <span class="stat-value" id="stat-invalid" style="color: var(--error)">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Unreviewed:</span>
            <span class="stat-value" id="stat-unreviewed" style="color: var(--text-secondary)">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Unreadable:</span>
            <span class="stat-value" id="stat-unreadable" style="color: var(--warning)">0</span>
        </div>
    </div>

    <div class="grid" id="grid">
        <div class="loading">Loading training data...</div>
    </div>

    <div class="zoom-modal" id="zoom-modal">
        <span class="close" onclick="closeZoom()">&times;</span>
        <div class="zoom-comparison">
            <div class="image-box crop">
                <img id="zoom-crop" src="" alt="Crop">
                <div class="image-label">Training Crop</div>
            </div>
            <span class="vs">vs</span>
            <div class="image-box ref">
                <img id="zoom-ref" src="" alt="Reference">
                <div class="image-label">Reference Icon</div>
            </div>
        </div>
        <div id="zoom-info" style="color: var(--text-secondary); font-size: 14px;"></div>
    </div>

    <script type="module">
        const TRAINING_DATA_PATH = '../../data/training-data/';
        const ITEMS_DATA_PATH = '../../data/items.json';
        const IMAGES_BASE = '../../src/';

        let trainingIndex = null;
        let itemsData = null;
        let itemLookup = new Map();
        let validationStatus = {}; // Stored in localStorage

        // Load validation status from localStorage
        function loadValidationStatus() {
            try {
                const stored = localStorage.getItem('training-validation-status');
                if (stored) {
                    validationStatus = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Failed to load validation status:', e);
            }
        }

        function saveValidationStatus() {
            try {
                localStorage.setItem('training-validation-status', JSON.stringify(validationStatus));
            } catch (e) {
                console.error('Failed to save validation status:', e);
            }
        }

        async function loadData() {
            try {
                // Load items data
                const itemsResp = await fetch(ITEMS_DATA_PATH);
                itemsData = await itemsResp.json();

                for (const item of itemsData.items) {
                    itemLookup.set(item.id, item);
                }

                // Load training index
                const indexResp = await fetch(TRAINING_DATA_PATH + 'index.json');
                trainingIndex = await indexResp.json();

                loadValidationStatus();
                populateFilters();
                renderGrid();
            } catch (e) {
                document.getElementById('grid').innerHTML =
                    `<div class="empty">Failed to load data: ${e.message}</div>`;
            }
        }

        function populateFilters() {
            const itemFilter = document.getElementById('filter-item');
            const sourceFilter = document.getElementById('filter-source');

            // Get unique items and sources
            const items = Object.keys(trainingIndex.items).sort();
            const sources = new Set();

            for (const itemData of Object.values(trainingIndex.items)) {
                for (const sample of itemData.samples) {
                    sources.add(sample.source_image);
                }
            }

            // Populate item filter
            for (const itemId of items) {
                const item = itemLookup.get(itemId);
                const name = item?.name || itemId;
                const opt = document.createElement('option');
                opt.value = itemId;
                opt.textContent = name;
                itemFilter.appendChild(opt);
            }

            // Populate source filter
            for (const source of Array.from(sources).sort()) {
                const opt = document.createElement('option');
                opt.value = source;
                opt.textContent = source.replace(/^pc-\d+p\//, '').replace(/\.(jpg|png)$/i, '');
                sourceFilter.appendChild(opt);
            }
        }

        function getAllSamples() {
            const samples = [];
            for (const [itemId, itemData] of Object.entries(trainingIndex.items)) {
                const refItem = itemLookup.get(itemId);
                for (const sample of itemData.samples) {
                    samples.push({
                        itemId,
                        itemName: itemData.name,
                        refImage: refItem?.image || null,
                        ...sample
                    });
                }
            }
            return samples;
        }

        function getFilteredSamples() {
            const itemFilter = document.getElementById('filter-item').value;
            const sourceFilter = document.getElementById('filter-source').value;
            const statusFilter = document.getElementById('filter-status').value;
            const search = document.getElementById('search').value.toLowerCase();

            return getAllSamples().filter(sample => {
                if (itemFilter && sample.itemId !== itemFilter) return false;
                if (sourceFilter && sample.source_image !== sourceFilter) return false;

                const status = validationStatus[sample.id] || 'unreviewed';
                if (statusFilter && status !== statusFilter) return false;

                if (search && !sample.itemName.toLowerCase().includes(search)) return false;

                return true;
            });
        }

        function updateStats() {
            const all = getAllSamples();
            let valid = 0, invalid = 0, unreviewed = 0, unreadable = 0;

            for (const sample of all) {
                const status = validationStatus[sample.id];
                if (status === 'valid') valid++;
                else if (status === 'invalid') invalid++;
                else if (status === 'unreadable') unreadable++;
                else unreviewed++;
            }

            document.getElementById('stat-total').textContent = all.length;
            document.getElementById('stat-valid').textContent = valid;
            document.getElementById('stat-invalid').textContent = invalid;
            document.getElementById('stat-unreviewed').textContent = unreviewed;
            document.getElementById('stat-unreadable').textContent = unreadable;
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            const samples = getFilteredSamples();

            updateStats();

            if (samples.length === 0) {
                grid.innerHTML = '<div class="empty">No samples match the current filters</div>';
                return;
            }

            grid.innerHTML = samples.map(sample => {
                const status = validationStatus[sample.id] || 'unreviewed';
                const statusClass = status === 'valid' ? 'valid' : status === 'invalid' ? 'invalid' : status === 'unreadable' ? 'unreadable' : '';
                const cropPath = TRAINING_DATA_PATH + sample.file;
                const refPath = sample.refImage ? IMAGES_BASE + sample.refImage : '';
                const sourceName = sample.source_image.replace(/^pc-\d+p\//, '').replace(/\.(jpg|png)$/i, '');

                return `
                    <div class="card ${statusClass}" data-id="${sample.id}">
                        <div class="card-header">
                            <span class="item-name">${sample.itemName}</span>
                            <span class="sample-id">${sample.id}</span>
                        </div>
                        <div class="comparison" onclick="openZoom('${cropPath}', '${refPath}', '${sample.itemName}', '${sample.id}')">
                            <div class="image-box crop">
                                <img src="${cropPath}" alt="Crop" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22><rect fill=%22%23333%22 width=%2264%22 height=%2264%22/><text x=%2232%22 y=%2232%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22>?</text></svg>'">
                                <div class="image-label">Crop</div>
                            </div>
                            <span class="vs">vs</span>
                            <div class="image-box ref">
                                ${refPath ?
                                    `<img src="${refPath}" alt="Ref" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22><rect fill=%22%23333%22 width=%2264%22 height=%2264%22/><text x=%2232%22 y=%2232%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22>?</text></svg>'">` :
                                    `<img src="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2264%22 height=%2264%22><rect fill=%22%23333%22 width=%2264%22 height=%2264%22/><text x=%2232%22 y=%2232%22 fill=%22%23666%22 text-anchor=%22middle%22 dy=%22.3em%22>N/A</text></svg>" alt="No ref">`
                                }
                                <div class="image-label">Reference</div>
                            </div>
                        </div>
                        <div class="meta">
                            <div>Conf: ${(sample.original_confidence * 100).toFixed(1)}%</div>
                            <div>Size: ${sample.dimensions.w}x${sample.dimensions.h}</div>
                            <div class="source-badge" title="${sample.source_image}">${sourceName}</div>
                        </div>
                        <div class="actions">
                            <button class="mark-valid" onclick="markStatus('${sample.id}', 'valid')">Valid</button>
                            <button class="mark-invalid" onclick="markStatus('${sample.id}', 'invalid')">Invalid</button>
                            <button class="mark-unreadable" onclick="markStatus('${sample.id}', 'unreadable')">Unreadable</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.markStatus = function(id, status) {
            validationStatus[id] = status;
            saveValidationStatus();
            renderGrid();
        };

        window.openZoom = function(cropPath, refPath, name, id) {
            document.getElementById('zoom-crop').src = cropPath;
            document.getElementById('zoom-ref').src = refPath || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect fill="#333" width="128" height="128"/><text x="64" y="64" fill="#666" text-anchor="middle" dy=".3em">N/A</text></svg>';
            document.getElementById('zoom-info').textContent = `${name} (${id})`;
            document.getElementById('zoom-modal').classList.add('show');
        };

        window.closeZoom = function() {
            document.getElementById('zoom-modal').classList.remove('show');
        };

        // Event listeners
        document.getElementById('filter-item').addEventListener('change', renderGrid);
        document.getElementById('filter-source').addEventListener('change', renderGrid);
        document.getElementById('filter-status').addEventListener('change', renderGrid);
        document.getElementById('search').addEventListener('input', renderGrid);

        document.getElementById('mark-all-valid').addEventListener('click', () => {
            const samples = getFilteredSamples();
            for (const sample of samples) {
                validationStatus[sample.id] = 'valid';
            }
            saveValidationStatus();
            renderGrid();
        });

        document.getElementById('export-report').addEventListener('click', () => {
            const all = getAllSamples();
            const report = {
                generated_at: new Date().toISOString(),
                total: all.length,
                valid: 0,
                invalid: 0,
                unreadable: 0,
                unreviewed: 0,
                invalid_samples: [],
                unreadable_samples: [],
                unreviewed_samples: []
            };

            for (const sample of all) {
                const status = validationStatus[sample.id];
                if (status === 'valid') report.valid++;
                else if (status === 'invalid') {
                    report.invalid++;
                    report.invalid_samples.push({ id: sample.id, item: sample.itemName, source: sample.source_image });
                } else if (status === 'unreadable') {
                    report.unreadable++;
                    report.unreadable_samples.push({ id: sample.id, item: sample.itemName, source: sample.source_image });
                } else {
                    report.unreviewed++;
                    report.unreviewed_samples.push({ id: sample.id, item: sample.itemName });
                }
            }

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `training-validation-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('zoom-modal').addEventListener('click', (e) => {
            if (e.target.id === 'zoom-modal') closeZoom();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeZoom();
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
