{"version":3,"mappings":"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","names":["isModalClosing","__resetCompareState","toggleCompareItem","itemId","compareItems","getState","index","indexOf","newItems","splice","setState","length","MAX_COMPARE_ITEMS","ToastManager","warning","updateCompareButton","compareBtn","safeGetElementById","countSpan","safeQuerySelector","textContent","toString","style","display","safeQuerySelectorAll","forEach","cb","checkbox","id","dataset","value","checked","includes","async","openCompareModal","items","map","allData","find","item","filter","compareBody","modal","chartableItems","scaling_per_stack","one_and_done","graph_type","html","unit","scaling_type","escapeHtml","name","rarity","tier","base_effect","stacks_well","formula","val","idx","join","synergies","slice","s","anti_synergies","notes","innerHTML","setAttribute","requestAnimationFrame","classList","add","activateFocusTrap","currentModal","canvas","document","getElementById","contains","createCompareChart","__vitePreload","import","__VITE_PRELOAD__","parentElement","error","logger","warn","operation","message","closeCompareModal","deactivateFocusTrap","remove","chartInstances","then","instances","destroy","catch","info","data","reason","setTimeout","updateCompareDisplay","clearCompare","getCompareItems"],"ignoreList":[],"sources":["../../src/modules/compare.ts"],"sourcesContent":["// ========================================\n// MegaBonk Compare Mode Module\n// ========================================\n\nimport type { Item } from '../types/index.ts';\nimport { ToastManager } from './toast.ts';\nimport { allData } from './data-service.ts';\nimport { safeGetElementById, safeQuerySelector, safeQuerySelectorAll, escapeHtml } from './utils.ts';\nimport { MAX_COMPARE_ITEMS } from './constants.ts';\nimport { getState, setState } from './store.ts';\nimport { logger } from './logger.ts';\nimport { activateFocusTrap, deactivateFocusTrap } from './modal-core.ts';\n\n// ========================================\n// State\n// ========================================\n\n// Compare mode state - uses centralized store\n// No local copy - always read from store for proper test isolation\n\n// Flag to prevent double-close race condition\nlet isModalClosing = false;\n\n/**\n * Reset internal state for testing\n * @internal - Only exported for test isolation\n */\nexport function __resetCompareState(): void {\n    isModalClosing = false;\n}\n\n// ========================================\n// Exported Functions\n// ========================================\n\n/**\n * Toggle item in comparison list\n * @param itemId - Item ID to toggle\n */\nexport function toggleCompareItem(itemId: string): void {\n    const compareItems = getState('compareItems') || [];\n    const index = compareItems.indexOf(itemId);\n    if (index > -1) {\n        const newItems = [...compareItems];\n        newItems.splice(index, 1);\n        setState('compareItems', newItems);\n    } else {\n        if (compareItems.length >= MAX_COMPARE_ITEMS) {\n            ToastManager.warning(\n                `You can only compare up to ${MAX_COMPARE_ITEMS} items at once. Remove an item first.`\n            );\n            return;\n        }\n        setState('compareItems', [...compareItems, itemId]);\n    }\n    updateCompareButton();\n}\n\n/**\n * Update compare button visibility and state\n */\nexport function updateCompareButton(): void {\n    const compareBtn = safeGetElementById('compare-btn');\n    if (!compareBtn) return;\n\n    const compareItems = getState('compareItems') || [];\n    const countSpan = safeQuerySelector('.compare-count', compareBtn);\n    if (countSpan) {\n        countSpan.textContent = compareItems.length.toString();\n    }\n\n    compareBtn.style.display = compareItems.length >= 2 ? 'block' : 'none';\n\n    // Update checkboxes\n    safeQuerySelectorAll('.compare-checkbox').forEach((cb: Element) => {\n        const checkbox = cb as HTMLInputElement;\n        const id = checkbox.dataset.id || checkbox.value;\n        checkbox.checked = compareItems.includes(id);\n    });\n}\n\n/**\n * Open the comparison modal\n */\nexport async function openCompareModal(): Promise<void> {\n    const compareItems = getState('compareItems') || [];\n    if (compareItems.length < 2) {\n        ToastManager.warning('Select at least 2 items to compare!');\n        return;\n    }\n\n    const items = compareItems\n        .map((id: string) => allData.items?.items?.find((item: Item) => item.id === id))\n        .filter((item): item is Item => item !== undefined);\n\n    const compareBody = safeGetElementById('compareBody');\n    const modal = safeGetElementById('compareModal');\n    if (!compareBody || !modal) return;\n\n    // Filter items that have scaling data for the chart\n    const chartableItems = items.filter(\n        (item: Item) => item.scaling_per_stack && !item.one_and_done && item.graph_type !== 'flat'\n    );\n\n    // Build HTML with optional chart section\n    let html = '';\n    if (chartableItems.length >= 2) {\n        html += `\n            <div class=\"compare-chart-section\">\n                <h3>Scaling Comparison</h3>\n                <div class=\"compare-chart-container\">\n                    <canvas id=\"compare-scaling-chart\" class=\"scaling-chart\"></canvas>\n                </div>\n            </div>\n        `;\n    }\n\n    html += '<div class=\"compare-grid\">';\n\n    items.forEach((item: Item) => {\n        const isPercentage =\n            item.scaling_type && (item.scaling_type.includes('chance') || item.scaling_type.includes('damage'));\n        const unit = isPercentage ? '%' : '';\n\n        html += `\n            <div class=\"compare-column\">\n                <div class=\"compare-header\">\n                    <h3>${escapeHtml(item.name)}</h3>\n                    <div class=\"item-badges\">\n                        <span class=\"badge rarity-${item.rarity}\">${item.rarity}</span>\n                        <span class=\"badge tier-${item.tier}\">${item.tier} Tier</span>\n                    </div>\n                </div>\n\n                <div class=\"compare-section\">\n                    <h4>Base Effect</h4>\n                    <p>${escapeHtml(item.base_effect || 'N/A')}</p>\n                </div>\n\n                <div class=\"compare-section\">\n                    <h4>Stacking</h4>\n                    ${\n                        item.stacks_well === undefined\n                            ? '<p class=\"neutral\">Stacking behavior unknown</p>'\n                            : `<p class=\"${item.stacks_well ? 'positive' : 'negative'}\">\n                            ${item.stacks_well ? '✓ Stacks Well' : '✗ One-and-Done'}\n                        </p>`\n                    }\n                </div>\n\n                <div class=\"compare-section\">\n                    <h4>Formula</h4>\n                    <code class=\"formula-code\">${escapeHtml(item.formula || 'N/A')}</code>\n                </div>\n\n                <div class=\"compare-section\">\n                    <h4>Scaling (1-10 stacks)</h4>\n                    <div class=\"scaling-values\">\n                        ${\n                            item.scaling_per_stack\n                                ? item.scaling_per_stack\n                                      .map(\n                                          (val: number, idx: number) =>\n                                              `<span class=\"scale-value\">${idx + 1}: <strong>${val}${unit}</strong></span>`\n                                      )\n                                      .join('')\n                                : 'N/A'\n                        }\n                    </div>\n                </div>\n\n                ${\n                    item.synergies?.length\n                        ? `\n                    <div class=\"compare-section\">\n                        <h4>Synergies</h4>\n                        <div class=\"synergy-tags\">\n                            ${item.synergies\n                                .slice(0, 5)\n                                .map((s: string) => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`)\n                                .join('')}\n                        </div>\n                    </div>\n                `\n                        : ''\n                }\n\n                ${\n                    item.anti_synergies?.length\n                        ? `\n                    <div class=\"compare-section\">\n                        <h4>Anti-Synergies</h4>\n                        <div class=\"antisynergy-tags\">\n                            ${item.anti_synergies.map((s: string) => `<span class=\"antisynergy-tag\">${escapeHtml(s)}</span>`).join('')}\n                        </div>\n                    </div>\n                `\n                        : ''\n                }\n\n                <div class=\"compare-section\">\n                    <h4>Notes</h4>\n                    <p class=\"notes\">${escapeHtml(item.notes || 'N/A')}</p>\n                </div>\n\n                <button class=\"remove-compare-btn\" data-remove-id=\"${item.id}\" aria-label=\"Remove ${escapeHtml(item.name)} from comparison\">\n                    Remove from Comparison\n                </button>\n            </div>\n        `;\n    });\n\n    html += '</div>';\n    compareBody.innerHTML = html;\n    modal.style.display = 'block';\n    modal.setAttribute('aria-hidden', 'false'); // Announce modal to screen readers\n\n    // Trigger animation after display is set, then initialize chart\n    // Using nested RAF ensures chart init happens after modal is visible\n    requestAnimationFrame(() => {\n        modal.classList.add('active');\n\n        // Activate focus trap for accessibility\n        activateFocusTrap(modal);\n\n        // Initialize compare chart after modal is confirmed active\n        if (chartableItems.length >= 2) {\n            // Use another RAF to ensure DOM is painted with active state\n            requestAnimationFrame(async () => {\n                // Check if modal is still active and canvas exists before creating chart\n                const currentModal = safeGetElementById('compareModal');\n                const canvas = document.getElementById('compare-scaling-chart');\n                if (!currentModal || !currentModal.classList.contains('active') || !canvas) {\n                    return;\n                }\n\n                try {\n                    // Dynamically import chart function only when needed\n                    const { createCompareChart } = await import('./charts.ts');\n                    // Re-verify modal state after async import\n                    if (currentModal.classList.contains('active') && canvas.parentElement) {\n                        createCompareChart('compare-scaling-chart', chartableItems);\n                    }\n                } catch (error) {\n                    // Chart module failed to load - modal still works, just without chart\n                    logger.warn({\n                        operation: 'compare.load_chart',\n                        error: {\n                            name: (error as Error).name,\n                            message: (error as Error).message,\n                        },\n                    });\n                }\n            });\n        }\n    });\n}\n\n/**\n * Close compare modal with animation\n */\nexport async function closeCompareModal(): Promise<void> {\n    // Prevent double-close race condition\n    if (isModalClosing) {\n        return;\n    }\n\n    const modal = safeGetElementById('compareModal');\n    if (!modal || modal.style.display === 'none') {\n        return;\n    }\n\n    isModalClosing = true;\n\n    // Deactivate focus trap before closing\n    deactivateFocusTrap();\n\n    // Update UI immediately (don't block on chart cleanup)\n    modal.classList.remove('active');\n    modal.setAttribute('aria-hidden', 'true'); // Hide from screen readers\n\n    // Destroy compare chart asynchronously to prevent memory leak\n    // Using fire-and-forget pattern to avoid blocking modal close\n    import('./charts.ts')\n        .then(({ chartInstances }) => {\n            const instances = chartInstances as Record<string, { destroy: () => void }>;\n            if (instances && instances['compare-scaling-chart']) {\n                instances['compare-scaling-chart'].destroy();\n                delete instances['compare-scaling-chart'];\n            }\n        })\n        .catch((error) => {\n            // Chart module not loaded yet, nothing to clean up\n            // Log at debug level for troubleshooting if needed\n            logger.info({\n                operation: 'compare.chart_cleanup_skipped',\n                data: { reason: 'module_not_loaded', error: (error as Error).message },\n            });\n        });\n    setTimeout(() => {\n        modal.style.display = 'none';\n        isModalClosing = false; // Reset flag after close animation completes\n    }, 300);\n}\n\n/**\n * Update compare display after item removal\n */\nexport function updateCompareDisplay(): void {\n    const compareItems = getState('compareItems') || [];\n    if (compareItems.length < 2) {\n        closeCompareModal();\n    } else {\n        openCompareModal();\n    }\n}\n\n/**\n * Clear all compare selections\n */\nexport function clearCompare(): void {\n    setState('compareItems', []);\n    updateCompareButton();\n    closeCompareModal();\n}\n\n// ========================================\n// Exported API\n// ========================================\n\n/**\n * Get compare items (returns a copy to prevent state corruption)\n * @returns Compare items array\n */\nexport function getCompareItems(): string[] {\n    return [...(getState('compareItems') || [])];\n}\n"],"file":"compare-DCgMDklD.js"}