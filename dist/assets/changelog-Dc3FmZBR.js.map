{"version":3,"file":"changelog-Dc3FmZBR.js","sources":["../../src/modules/changelog.ts"],"sourcesContent":["// ========================================\n// MegaBonk Changelog Module\n// ========================================\n\nimport { allData } from './data-service.ts';\nimport { safeGetElementById, escapeHtml, isValidExternalUrl, generateEmptyState } from './utils.ts';\nimport type { ChangelogPatch, Entity } from '../types/index.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Entity type for changelog links (singular form)\n */\ntype ChangelogEntityType = 'item' | 'weapon' | 'tome' | 'character' | 'shrine';\n\n/**\n * Change entry with optional change_type\n */\ninterface ChangeEntry {\n    text: string;\n    change_type?: 'buff' | 'nerf' | 'fix' | string;\n}\n\n/**\n * Categories object from patch\n */\ninterface ChangeCategories {\n    balance?: ChangeEntry[];\n    new_content?: ChangeEntry[];\n    bug_fixes?: ChangeEntry[];\n    removed?: ChangeEntry[];\n    other?: ChangeEntry[];\n    [key: string]: ChangeEntry[] | undefined;\n}\n\n/**\n * Extended patch with categories\n */\ninterface ExtendedPatch extends ChangelogPatch {\n    categories?: ChangeCategories;\n    raw_notes?: string;\n    steam_url?: string;\n    summary?: string;\n}\n\n// ========================================\n// Entity Link Parsing\n// ========================================\n\n/**\n * Find an entity in the loaded data by type and ID\n * @param type - Entity type (item, weapon, tome, character, shrine)\n * @param id - Entity ID\n * @returns Found entity or null\n */\nexport function findEntityInData(type: ChangelogEntityType, id: string): Entity | null {\n    switch (type) {\n        case 'item':\n            return (allData.items?.items?.find(e => e.id === id) as Entity | undefined) || null;\n        case 'weapon':\n            return (allData.weapons?.weapons?.find(e => e.id === id) as Entity | undefined) || null;\n        case 'tome':\n            return (allData.tomes?.tomes?.find(e => e.id === id) as Entity | undefined) || null;\n        case 'character':\n            return (allData.characters?.characters?.find(e => e.id === id) as Entity | undefined) || null;\n        case 'shrine':\n            return (allData.shrines?.shrines?.find(e => e.id === id) as Entity | undefined) || null;\n        default:\n            return null;\n    }\n}\n\n/**\n * Parse changelog text and convert entity links to clickable HTML\n * Markup format: [[type:id|Display Text]]\n * @param text - Text with [[type:id|label]] markup\n * @returns HTML with clickable entity links\n */\nexport function parseChangelogLinks(text: string): string {\n    if (!text) return '';\n\n    // Pattern: [[type:id|Display Text]]\n    // Note: ID allows word characters and hyphens, and can be empty for graceful handling\n    const linkPattern = /\\[\\[(\\w+):([\\w-]*)\\|([^\\]]+)\\]\\]/g;\n\n    return text.replace(linkPattern, (_match: string, type: string, id: string, label: string): string => {\n        // Validate entity type\n        const validTypes: ChangelogEntityType[] = ['item', 'weapon', 'tome', 'character', 'shrine'];\n        if (!validTypes.includes(type as ChangelogEntityType)) {\n            return label; // Return plain text if invalid type\n        }\n\n        // Verify entity exists in loaded data\n        const entity = findEntityInData(type as ChangelogEntityType, id);\n        if (!entity) {\n            return escapeHtml(label); // Return escaped plain text if entity not found\n        }\n\n        // Bug fix: Escape all user-provided content to prevent XSS\n        const safeType = escapeHtml(type);\n        const safeId = escapeHtml(id);\n        const safeLabel = escapeHtml(label);\n        return `<a href=\"#\" class=\"entity-link\"\n                   data-entity-type=\"${safeType}\"\n                   data-entity-id=\"${safeId}\"\n                   title=\"View ${safeLabel}\">${safeLabel}</a>`;\n    });\n}\n\n// ========================================\n// Rendering Helpers\n// ========================================\n\n/**\n * Format category name for display\n * @param category - Category key\n * @returns Formatted display name\n */\nexport function formatCategoryName(category: string): string {\n    const names: Record<string, string> = {\n        balance: 'Balance Changes',\n        new_content: 'New Content',\n        bug_fixes: 'Bug Fixes',\n        removed: 'Removed',\n        other: 'Other Changes',\n    };\n    return names[category] || category;\n}\n\n/**\n * Format date string for display\n * @param dateStr - ISO date string (YYYY-MM-DD)\n * @returns Formatted date\n */\nexport function formatChangelogDate(dateStr: string): string {\n    if (!dateStr) return '';\n    // Parse as UTC to avoid timezone inconsistencies across browsers\n    // YYYY-MM-DD format is parsed as UTC midnight when using explicit UTC parsing\n    const date = new Date(dateStr + 'T00:00:00Z');\n    // Validate date is valid before formatting\n    if (isNaN(date.getTime())) {\n        return 'Invalid Date';\n    }\n    return date.toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n        timeZone: 'UTC', // Ensure consistent display regardless of local timezone\n    });\n}\n\n/**\n * Render sections for each category of changes\n * @param categories - Categories object from patch\n * @param rawNotes - Fallback raw notes if categories are empty\n * @returns HTML string for all sections\n */\nexport function renderChangesSections(categories: ChangeCategories | undefined, rawNotes: string | undefined): string {\n    if (!categories) {\n        // Fallback to raw notes if no categories\n        if (rawNotes) {\n            // Escape HTML first for XSS prevention, then parse entity links\n            // Entity link syntax [[type:id|label]] survives escaping since it uses no HTML chars\n            return `<div class=\"changelog-raw-notes\">${parseChangelogLinks(escapeHtml(rawNotes))}</div>`;\n        }\n        return '';\n    }\n\n    const order = ['new_content', 'balance', 'bug_fixes', 'removed', 'other'];\n\n    const sectionsHtml = order\n        .map(cat => {\n            const changes = categories[cat];\n            if (!changes || changes.length === 0) return '';\n\n            const items = changes\n                .map(\n                    change => `\n            <div class=\"changelog-item ${change.change_type || ''}\">\n                ${parseChangelogLinks(change.text)}\n            </div>\n        `\n                )\n                .join('');\n\n            return `\n            <div class=\"changelog-section\">\n                <div class=\"changelog-section-title\">${formatCategoryName(cat)}</div>\n                ${items}\n            </div>\n        `;\n        })\n        .join('');\n\n    // If no categorized content, show raw notes as fallback\n    if (!sectionsHtml.trim() && rawNotes) {\n        // Escape HTML first for XSS prevention, then parse entity links\n        return `<div class=\"changelog-raw-notes\">${parseChangelogLinks(escapeHtml(rawNotes))}</div>`;\n    }\n\n    return sectionsHtml;\n}\n\n// ========================================\n// Main Renderer\n// ========================================\n\n/**\n * Render changelog entries\n * @param patches - Array of patch objects\n */\nexport function renderChangelog(patches: ExtendedPatch[]): void {\n    const container = safeGetElementById('changelogContainer');\n    if (!container) return;\n\n    container.innerHTML = '';\n\n    if (!patches || patches.length === 0) {\n        container.innerHTML = generateEmptyState('ðŸ“‹', 'Changelog Entries');\n        return;\n    }\n\n    // Add changelog header\n    const latestDate = patches[0]?.date ? formatChangelogDate(patches[0].date) : 'Unknown';\n    const header = document.createElement('header');\n    header.className = 'changelog-page-header';\n    header.innerHTML = `\n        <h2 class=\"changelog-page-title\">ðŸ“‹ MegaBonk Changelog</h2>\n        <p class=\"changelog-page-subtitle\">Official game updates and patch notes</p>\n        <div class=\"changelog-page-stats\">\n            <span>${patches.length} patches</span>\n            <span>â€¢</span>\n            <span>Latest: ${latestDate}</span>\n        </div>\n    `;\n    container.appendChild(header);\n\n    patches.forEach(patch => {\n        const entry = document.createElement('article');\n        entry.className = 'changelog-entry';\n        entry.dataset.patchId = patch.id;\n\n        // Count changes per category\n        const categoryCounts = Object.entries(patch.categories || {})\n            .filter(([_, changes]) => changes && changes.length > 0)\n            .map(([cat, changes]) => ({ cat, count: changes!.length }));\n\n        const categoryPills = categoryCounts\n            .map(\n                ({ cat, count }) =>\n                    `<span class=\"category-pill ${cat}\">${formatCategoryName(cat).split(' ')[0]} (${count})</span>`\n            )\n            .join('');\n\n        entry.innerHTML = `\n            <div class=\"changelog-header\">\n                <span class=\"changelog-version\">v${escapeHtml(patch.version)}</span>\n                <h3 class=\"changelog-title\">${escapeHtml(patch.title)}</h3>\n                <span class=\"changelog-date\">${formatChangelogDate(patch.date)}</span>\n                ${\n                    patch.steam_url && isValidExternalUrl(patch.steam_url)\n                        ? `\n                    <a href=\"${escapeHtml(patch.steam_url)}\" target=\"_blank\" rel=\"noopener\" class=\"changelog-steam-link\">\n                        ðŸ”— Steam\n                    </a>\n                `\n                        : ''\n                }\n            </div>\n            <p class=\"changelog-summary\">${escapeHtml(patch.summary || '')}</p>\n            <div class=\"changelog-categories\">${categoryPills}</div>\n            <div class=\"changelog-changes\" id=\"changes-${patch.id}\">\n                ${renderChangesSections(patch.categories, patch.raw_notes)}\n            </div>\n            <button class=\"changelog-expand-btn\" data-target=\"changes-${patch.id}\"\n                    aria-expanded=\"false\" aria-controls=\"changes-${patch.id}\">\n                Show Details\n            </button>\n        `;\n\n        container.appendChild(entry);\n    });\n\n    // Event delegation for expand buttons\n    container.removeEventListener('click', handleExpandClick); // Remove any existing listener\n    container.addEventListener('click', handleExpandClick);\n}\n\n/**\n * Handle expand button clicks via event delegation\n * @param e - Click event\n */\nexport function handleExpandClick(e: Event): void {\n    const button = (e.target as HTMLElement).closest('.changelog-expand-btn') as HTMLButtonElement | null;\n    if (button) {\n        toggleChangelogExpand(button);\n    }\n}\n\n// ========================================\n// Interactions\n// ========================================\n\n/**\n * Toggle changelog expand/collapse\n * @param button - The expand button clicked\n */\nexport function toggleChangelogExpand(button: HTMLButtonElement): void {\n    const targetId = button.dataset.target;\n    if (!targetId) return;\n\n    const target = safeGetElementById(targetId);\n    if (!target) return;\n\n    const isExpanded = target.classList.contains('expanded');\n\n    if (isExpanded) {\n        target.classList.remove('expanded');\n        button.textContent = 'Show Details';\n        // Bug fix: Update aria-expanded for screen readers\n        button.setAttribute('aria-expanded', 'false');\n    } else {\n        target.classList.add('expanded');\n        button.textContent = 'Hide Details';\n        button.setAttribute('aria-expanded', 'true');\n    }\n}\n\n/**\n * Update changelog item count badge\n * @param patches - Filtered patches array\n */\nexport function updateChangelogStats(patches: ExtendedPatch[]): void {\n    const itemCount = safeGetElementById('item-count');\n    if (!itemCount) return;\n\n    const totalPatches = allData.changelog?.patches?.length || 0;\n    // Bug fix #3: Handle null/undefined patches array\n    const showingPatches = patches?.length || 0;\n\n    // Show \"X patches\" or \"X/Y patches\" if filtered\n    if (showingPatches === totalPatches) {\n        itemCount.textContent = `${showingPatches} patches`;\n    } else {\n        itemCount.textContent = `${showingPatches}/${totalPatches} patches`;\n    }\n}\n\n// ========================================\n// Exported functions:\n// - findEntityInData(type, id)\n// - parseChangelogLinks(text)\n// - formatCategoryName(category)\n// - formatChangelogDate(dateStr)\n// - renderChangesSections(categories, rawNotes)\n// - renderChangelog(patches)\n// - handleExpandClick(e)\n// - toggleChangelogExpand(button)\n// - updateChangelogStats(patches)\n// ========================================\n"],"names":["findEntityInData","type","id","allData","items","find","e","weapons","tomes","characters","shrines","parseChangelogLinks","text","replace","_match","label","includes","escapeHtml","safeType","safeId","safeLabel","formatCategoryName","category","balance","new_content","bug_fixes","removed","other","formatChangelogDate","dateStr","date","Date","isNaN","getTime","toLocaleDateString","year","month","day","timeZone","renderChangesSections","categories","rawNotes","sectionsHtml","map","cat","changes","length","change","change_type","join","trim","renderChangelog","patches","container","safeGetElementById","innerHTML","generateEmptyState","latestDate","header","document","createElement","className","appendChild","forEach","patch","entry","dataset","patchId","categoryPills","Object","entries","filter","_","count","split","version","title","steam_url","isValidExternalUrl","summary","raw_notes","removeEventListener","handleExpandClick","addEventListener","button","target","closest","toggleChangelogExpand","targetId","classList","contains","remove","textContent","setAttribute","add","updateChangelogStats","itemCount","totalPatches","changelog","showingPatches"],"mappings":"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"}