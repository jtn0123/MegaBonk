import{z as e,l as t,e as n,T as a,A as c,u as i,w as s,C as o,E as r,F as l,G as d,p as m,o as u,q as p,H as f,J as h,K as g}from"./main-xEzYQXDo.js";import{c as y,a as w}from"./aggregation-DIdlweK3.js";async function v(n,a){try{const{width:c,height:i}=await e(n),s=[{x:0,y:Math.floor(.8*i),width:c,height:Math.floor(.2*i),label:"hotbar_region"},{x:0,y:0,width:Math.floor(.25*c),height:Math.floor(.4*i),label:"equipment_region"}],o=document.createElement("canvas");return o.width=c,o.height=i,await async function(e,n,a,c){const i=e.getContext("2d");if(!i)return void t.warn({operation:"cv.debug.render_overlay_no_context",data:{canvasWidth:e.width,canvasHeight:e.height}});const s=await new Promise((e,a)=>{const c=new Image;c.onload=()=>e(c),c.onerror=e=>{const c=e instanceof ErrorEvent?e.message:"Unknown image load error";t.warn({operation:"cv.debug.image_load_failed",data:{imageUrlLength:n.length,error:c}}),a(new Error(`Failed to load image for debug overlay: ${c}`))},c.src=n});e.width=s.width,e.height=s.height,i.drawImage(s,0,0),i.lineWidth=2,i.setLineDash([10,5]),i.strokeStyle="rgba(0, 255, 255, 0.6)",i.font="14px monospace",a.forEach(e=>{if(i.strokeRect(e.x,e.y,e.width,e.height),e.label){i.fillStyle="rgba(0, 255, 255, 0.8)";const t=e.label.replace("_"," ").toUpperCase();i.fillRect(e.x,e.y-20,i.measureText(t).width+10,20),i.fillStyle="black",i.fillText(t,e.x+5,e.y-5)}}),i.setLineDash([]),c.forEach(e=>{if(!e.position)return;const t=e.position,n=e.confidence;let a;a=n>=.85?"rgba(0, 255, 0, 0.8)":n>=.7?"rgba(255, 165, 0, 0.8)":"rgba(255, 0, 0, 0.8)",i.lineWidth=3,i.strokeStyle=a,i.strokeRect(t.x,t.y,t.width,t.height);const c=`${e.entity.name}`,s=`${(100*n).toFixed(0)}%`,o=Math.max(i.measureText(c).width,i.measureText(s).width)+10;i.fillStyle=a,i.fillRect(t.x,t.y+t.height,o,36),i.fillStyle="black",i.font="bold 12px monospace",i.fillText(c,t.x+5,t.y+t.height+14),i.fillText(s,t.x+5,t.y+t.height+30)});const o=10,r=10;i.fillStyle="rgba(0, 0, 0, 0.8)",i.fillRect(o,r,220,140),i.fillStyle="white",i.font="bold 14px monospace",i.fillText("Smart Detection Overlay",20,30),i.font="12px monospace",i.fillStyle="rgba(0, 255, 0, 1)",i.fillText("‚ñ† High (‚â•85%)",20,55),i.fillStyle="rgba(255, 165, 0, 1)",i.fillText("‚ñ† Medium (70-85%)",20,75),i.fillStyle="rgba(255, 0, 0, 1)",i.fillText("‚ñ† Low (<70%)",20,95),i.fillStyle="rgba(0, 255, 255, 1)",i.fillText("‚îÑ Scan regions",20,115),i.fillStyle="rgba(200, 200, 200, 1)",i.fillText(`Detections: ${c.length}`,20,135)}(o,n,s,a),o.toDataURL("image/png")}catch(c){return t.error({operation:"cv.debug.create_overlay_failed",error:{name:c.name,message:c.message,stack:c.stack?.split("\n").slice(0,3).join(" -> ")},data:{imageUrlLength:n.length,detectionsCount:a.length}}),n}}function b(e,t=5){return e instanceof Error?{name:e.name,message:e.message,stack:e.stack?.split("\n").slice(0,t).join(" -> ")}:{name:"UnknownError",message:String(e)}}function E(e,n,a){t.error({operation:e,error:b(n),data:a})}function _(e,n,a){t.warn({operation:e,error:b(n),data:a})}function $(e,t,a,c,i,s){const o=document.getElementById("scan-selection-area");o&&(o.style.display="block",I("character",e.characters?.characters||[],e=>{t(e),s()}),I("weapon",e.weapons?.weapons||[],e=>{a(e),s()}),function(e,t,a){const c=document.getElementById("scan-item-grid");if(!c||!e.items?.items)return;c.innerHTML="";const i=document.createElement("input");i.type="search",i.className="scan-search-input",i.placeholder="üîç Search items...",i.addEventListener("input",e=>{!function(e){const t=document.getElementById("scan-grid-items-container");if(!t)return;const n=t.querySelectorAll(".scan-item-card");n.forEach(t=>{(t.dataset.name||"").includes(e)?t.style.display="flex":t.style.display="none"})}(e.target.value.toLowerCase())}),c.appendChild(i);const s=document.createElement("div");s.className="scan-grid-items",s.id="scan-grid-items-container",e.items.items.forEach(e=>{const c=function(e,t,a){const c=document.createElement("div");c.className="scan-item-card",c.dataset.id=e.id,c.dataset.name=e.name.toLowerCase();const i=document.createElement("div");i.className="scan-item-info",i.innerHTML=`\n        <div class="scan-item-name">${n(e.name)}</div>\n        <div class="scan-item-tier tier-${n(e.tier.toLowerCase())}">${n(e.tier)}</div>\n    `;const s=document.createElement("div");s.className="scan-item-controls";const o=document.createElement("button");o.className="scan-count-btn",o.textContent="‚àí",o.setAttribute("aria-label",`Decrease ${e.name} count`);const r=document.createElement("span");r.className="scan-count-display",r.textContent="0";const l=document.createElement("button");l.className="scan-count-btn",l.textContent="+",l.setAttribute("aria-label",`Increase ${e.name} count`);const d=n=>{const i=t(e,n);r.textContent=i.toString(),0===i?c.classList.remove("selected"):c.classList.add("selected"),a()};return o.addEventListener("click",()=>d(-1)),l.addEventListener("click",()=>d(1)),s.appendChild(o),s.appendChild(r),s.appendChild(l),c.appendChild(i),c.appendChild(s),c}(e,t,a);s.appendChild(c)}),c.appendChild(s)}(e,c,s),function(e,t,a){const c=document.getElementById("scan-tome-grid");if(!c||!e.tomes?.tomes)return;c.innerHTML="",e.tomes.tomes.forEach(e=>{const i=document.createElement("button");i.className="scan-tome-card",i.dataset.id=e.id,i.innerHTML=`\n            <div class="scan-tome-name">${n(e.name)}</div>\n            <div class="scan-tome-tier tier-${n(e.tier.toLowerCase())}">${n(e.tier)}</div>\n        `,i.addEventListener("click",()=>{i.classList.contains("selected")?(i.classList.remove("selected"),t(e,!1)):(i.classList.add("selected"),t(e,!0)),a()}),c.appendChild(i)})}(e,i,s),s())}function I(e,t,a){const c=document.getElementById(`scan-${e}-grid`);c&&(c.innerHTML="",t.forEach(e=>{const t=document.createElement("button");t.className="scan-entity-card",t.dataset.id=e.id,t.innerHTML=`\n            <div class="scan-entity-name">${n(e.name)}</div>\n            <div class="scan-entity-tier tier-${n(e.tier.toLowerCase())}">${n(e.tier)}</div>\n        `,t.addEventListener("click",()=>{c.querySelectorAll(".scan-entity-card").forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),a(e)}),c.appendChild(t)}))}function x(e,t){let n="";switch(e){case"character":n="scan-character-grid";break;case"weapon":n="scan-weapon-grid";break;case"tome":n="scan-tome-grid"}const a=document.getElementById(n);if(!a)return;a.querySelectorAll(".scan-entity-card, .scan-tome-card").forEach(e=>{e.classList.remove("selected")});const c=a.querySelector(`[data-id="${t}"]`);c&&c.classList.add("selected")}async function C(e,n,m,u,p){if(!n.tryAcquire())return void a.info("Detection already in progress...");if(!m&&!u)return a.info("Item templates are still loading. Please wait a moment and try again."),void n.release();u&&(a.warning("Item templates failed to load. Detection accuracy may be reduced."),_("scan_build.hybrid_detect_degraded",u));const f=c("Initializing..."),h=document.getElementById("scan-image-preview");h&&h.appendChild(f.element);try{a.info("Starting hybrid detection (OCR + Computer Vision)..."),f.update(10,"Running OCR...");const n=await i(e,(e,t)=>{f.update(10+.4*e,t)});f.update(50,"Running computer vision...");const c=await s(e,(e,t)=>{f.update(50+.4*e,t)});f.update(90,"Combining detections...");const m=function(e,t){const n=t.map(e=>({type:e.type,entity:e.entity,confidence:e.confidence,rawText:`cv_detected_${e.entity.name}`})),a=y([...e.items,...n.filter(e=>"item"===e.type)],t.filter(e=>"item"===e.type)),c=y([...e.tomes,...n.filter(e=>"tome"===e.type)],t.filter(e=>"tome"===e.type)),i=w(a),s=w(c);let o=e.character;if(!o){const e=t.find(e=>"character"===e.type);e&&(o={type:"character",entity:e.entity,confidence:e.confidence,rawText:"hybrid_cv"})}let r=e.weapon;if(!r){const e=t.find(e=>"weapon"===e.type);e&&(r={type:"weapon",entity:e.entity,confidence:e.confidence,rawText:"hybrid_cv"})}return{items:i.map(e=>({type:e.type,entity:e.entity,confidence:e.confidence,rawText:`hybrid_${e.method}`,count:e.count})),tomes:s.map(e=>({type:e.type,entity:e.entity,confidence:e.confidence,rawText:`hybrid_${e.method}`,count:e.count})),character:o,weapon:r,rawText:"hybrid_detection"}}(n,c);p(m),o(),r(),await async function(e,t,n){if(l()){const c=await v(e,t);d(c);const i=document.getElementById("scan-image-preview");i&&(i.innerHTML=`\n                <img src="${c}" alt="Debug Overlay" style="max-width: 100%; border-radius: 8px;" />\n                <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">\n                    Debug Mode: Green=High confidence, Orange=Medium, Red=Low\n                </p>\n            `),a.success(`Hybrid Detection: ${n.items.length} items, ${n.tomes.length} tomes (Debug overlay shown)`)}else d(null),a.success(`Hybrid Detection: ${n.items.length} items, ${n.tomes.length} tomes (Enhanced accuracy!)`)}(e,c,m),t.info({operation:"scan_build.hybrid_detect_complete",data:{itemsDetected:m.items.length,tomesDetected:m.tomes.length,characterDetected:m.character?1:0,weaponDetected:m.weapon?1:0,ocrItems:n.items.length,cvItems:c.length}})}catch(g){E("scan_build.hybrid_detect_error",g),a.error(`Hybrid detection failed: ${g.message}`)}finally{f.remove(),n.release()}}function T(e){return e>=.8?"confidence-high":e>=.5?"confidence-medium":"confidence-low"}function L(e,t,a,c,i){a.selectedItems.clear(),a.selectedTomes.clear(),a.selectedCharacter=null,a.selectedWeapon=null,c(),e.character&&(a.selectedCharacter=e.character.entity,x("character",e.character.entity.id)),e.weapon&&(a.selectedWeapon=e.weapon.entity,x("weapon",e.weapon.entity.id));const s=new Map;e.items.forEach(e=>{if(!e.entity)return;const t=e.entity,n=s.get(t.id)||0;s.set(t.id,n+1)}),s.forEach((e,n)=>{const c=t.items?.items?.find(e=>e.id===n);c&&(a.selectedItems.set(c.id,{item:c,count:e}),function(e,t){const n=document.getElementById("scan-grid-items-container");if(!n)return;const a=n.querySelector(`[data-id="${e}"]`);if(!a)return;const c=a.querySelector(".scan-count-display");c&&(c.textContent=t.toString()),a.classList.add("selected")}(c.id,e))});const o=new Set;e.tomes.forEach(e=>{if(!e.entity)return;const t=e.entity;o.has(t.id)||(o.add(t.id),a.selectedTomes.set(t.id,t),x("tome",t.id))}),i(),function(e){const t=document.getElementById("scan-detection-info");if(!t)return;const a=[...e.character?[e.character]:[],...e.weapon?[e.weapon]:[],...e.items,...e.tomes],c=a.filter(e=>e.confidence>=.8).length,i=a.filter(e=>e.confidence>=.5&&e.confidence<.8).length,s=a.filter(e=>e.confidence<.5).length,o=a.length>0?a.reduce((e,t)=>e+t.confidence,0)/a.length:0;let r='<div class="scan-detection-results"><h4>üîç Detection Confidence:</h4>';if(a.length>0&&(r+=`<div class="scan-detection-stats">\n            <div class="scan-detection-stat stat-high">\n                <span class="stat-count">${c}</span> high\n            </div>\n            <div class="scan-detection-stat stat-medium">\n                <span class="stat-count">${i}</span> medium\n            </div>\n            <div class="scan-detection-stat stat-low">\n                <span class="stat-count">${s}</span> low\n            </div>\n            <div class="scan-detection-stat">\n                Avg: <span class="stat-count">${Math.round(100*o)}%</span>\n            </div>\n        </div>`),(s>=3||s>0&&s>=.5*a.length)&&(r+='<div class="scan-low-confidence-warning">\n            <strong>‚ö†Ô∏è Many low-confidence detections</strong>\n            Some items may be incorrectly identified. Review the selections below and adjust as needed.\n        </div>'),e.character){const t=T(e.character.confidence);r+=`<div class="scan-detection-item">\n            <span>Character: ${n(e.character.entity.name)}</span>\n            <span class="confidence ${t}">${Math.round(100*e.character.confidence)}%</span>\n        </div>`}if(e.weapon){const t=T(e.weapon.confidence);r+=`<div class="scan-detection-item">\n            <span>Weapon: ${n(e.weapon.entity.name)}</span>\n            <span class="confidence ${t}">${Math.round(100*e.weapon.confidence)}%</span>\n        </div>`}e.items.length>0&&(r+='<div class="scan-detection-section"><strong>Items:</strong>',e.items.forEach(e=>{const t=T(e.confidence);r+=`<div class="scan-detection-item">\n                <span>${n(e.entity.name)}</span>\n                <span class="confidence ${t}">${Math.round(100*e.confidence)}%</span>\n            </div>`}),r+="</div>"),e.tomes.length>0&&(r+='<div class="scan-detection-section"><strong>Tomes:</strong>',e.tomes.forEach(e=>{const t=T(e.confidence);r+=`<div class="scan-detection-item">\n                <span>${n(e.entity.name)}</span>\n                <span class="confidence ${t}">${Math.round(100*e.confidence)}%</span>\n            </div>`}),r+="</div>"),r+='<p class="scan-detection-hint">üí° Review and adjust selections below if needed</p></div>',t.innerHTML=r,t.style.display="block"}(e)}let S={},k=null,B=new Map,M=new Map,D=null,W=null,H=!1,R=null;const A=f(),N=function(e,t){let n=null,a=0;return{call:async(...c)=>{n&&(clearTimeout(n),n=null),a++;const i=a;return new Promise(s=>{n=setTimeout(async()=>{if(i===a)try{const t=await e(...c);s(i===a?t:null)}catch(t){if(i===a)throw t;s(null)}else s(null)},t)})},cancel:()=>{n&&(clearTimeout(n),n=null),a++}}}(async function(e){return new Promise((n,c)=>{try{const i=new FileReader;i.onload=e=>{const t=e.target?.result;"string"==typeof t?(k=t,function(e,t,n){const a=document.getElementById("scan-image-preview");if(!a||!e)return;a.innerHTML="";const c=document.createElement("div");c.className="scan-image-wrapper";const i=document.createElement("img");i.src=e,i.alt="Uploaded build screenshot",i.className="scan-preview-image";const s=document.createElement("button");s.className="scan-clear-btn",s.id="scan-clear-image",s.setAttribute("aria-label","Clear image"),s.textContent="‚úï",c.appendChild(i),c.appendChild(s),a.appendChild(c),a.style.display="block";const o=document.getElementById("scan-auto-detect-area");o&&(o.style.display="block"),t.add(s,"click",n)}(k,A,G),Y(),a.success("Image uploaded! Now select the items you see"),n()):(a.error("Failed to read image as data URL"),c(new Error("Failed to read image as data URL")))},i.onerror=()=>{a.error("Failed to read image file"),c(new Error("Failed to read image file"))},i.readAsDataURL(e),t.info({operation:"scan_build.image_uploaded",data:{fileName:e.name,fileSize:e.size,fileType:e.type}})}catch(i){E("scan_build.upload_error",i),a.error("Failed to upload image"),c(i)}})},100),z=function(){let e=!1;return{isLocked:()=>e,tryAcquire:()=>!e&&(e=!0,!0),release:()=>{e=!1},withLock:async t=>{if(e)return null;e=!0;try{return await t()}finally{e=!1}}}}();let q=null;function F(){return{selectedItems:B,selectedTomes:M,selectedCharacter:D,selectedWeapon:W}}function U(e,n){S=e,n&&(q=n),m(e),u(e),H=!1,R=null;const c=document.getElementById("scan-hybrid-detect-btn");c&&(c.disabled=!0,c.title="Loading item templates..."),p().then(()=>{H=!0,c&&(c.disabled=!1,c.title=""),t.info({operation:"scan_build.templates_loaded",data:{success:!0}})}).catch(n=>{R=n,c&&(c.disabled=!1,c.title="Templates failed to load - reduced accuracy"),t.error({operation:"scan_build.load_templates",error:{name:n.name,message:n.message,stack:n.stack?.split("\n").slice(0,5).join(" -> ")},data:{itemsCount:e.items?.items?.length||0,phase:"template_preload"}}),a.error("Failed to load item templates for recognition")}),function(){j();const e=document.getElementById("scan-upload-btn");e&&A.addWithSignal(e,"click",P);const t=document.getElementById("scan-file-input");t&&A.addWithSignal(t,"change",O);const n=document.getElementById("scan-clear-image");n&&A.addWithSignal(n,"click",G);const a=document.getElementById("scan-apply-to-advisor");a&&A.addWithSignal(a,"click",ne);const c=document.getElementById("scan-auto-detect-btn");c&&A.addWithSignal(c,"click",ee);const i=document.getElementById("scan-hybrid-detect-btn");i&&A.addWithSignal(i,"click",te)}(),t.info({operation:"scan_build.init",data:{itemsCount:e.items?.items.length||0}})}function j(){A.removeAll()}function P(){const e=document.getElementById("scan-file-input");e?.click()}async function O(e){const t=e.target,n=t.files?.[0];n&&(n.type.startsWith("image/")?n.size>h?a.error(`Image size must be less than ${h/1048576}MB`):N.call(n):a.error("Please select an image file"))}function G(){k=null,B.clear(),M.clear(),D=null,W=null,function(){const e=document.getElementById("scan-image-preview");e&&(e.innerHTML="",e.style.display="none");const t=document.getElementById("scan-selection-area");t&&(t.style.display="none");const n=document.getElementById("scan-auto-detect-area");n&&(n.style.display="none");const a=document.getElementById("scan-detection-info");a&&(a.style.display="none");const c=document.getElementById("scan-file-input");c&&(c.value="")}(),a.info("Image cleared")}function V(e,t){const n=B.get(e.id),a=n?.count||0,c=Math.max(0,Math.min(g,a+t));return 0===c?B.delete(e.id):B.set(e.id,{item:e,count:c}),c}function J(e){D=e}function K(e){W=e}function Q(e,t){t?M.set(e.id,e):M.delete(e.id)}function X(){!function(e){const t=document.getElementById("scan-selection-summary");if(!t)return;let a="<h4>Selected Build State:</h4>";e.selectedCharacter&&(a+=`<div class="scan-summary-item">üë§ <strong>${n(e.selectedCharacter.name)}</strong></div>`),e.selectedWeapon&&(a+=`<div class="scan-summary-item">‚öîÔ∏è <strong>${n(e.selectedWeapon.name)}</strong></div>`),e.selectedItems.size>0&&(a+='<div class="scan-summary-section"><strong>üì¶ Items:</strong><ul>',e.selectedItems.forEach(({item:e,count:t})=>{a+=`<li>${n(e.name)} x${t}</li>`}),a+="</ul></div>"),e.selectedTomes.size>0&&(a+='<div class="scan-summary-section"><strong>üìö Tomes:</strong><ul>',e.selectedTomes.forEach(e=>{a+=`<li>${n(e.name)}</li>`}),a+="</ul></div>"),t.innerHTML=a;const c=document.getElementById("scan-apply-to-advisor");c&&(c.style.display=e.selectedCharacter||e.selectedWeapon||e.selectedItems.size>0||e.selectedTomes.size>0?"block":"none")}(F())}function Y(){$(S,J,K,V,Q,X)}function Z(e){L(e,S,F(),Y,X)}async function ee(){k?await async function(e,n,o){if(!n.tryAcquire())return void a.info("Detection already in progress...");const r=c("Initializing..."),l=document.getElementById("scan-image-preview");l&&l.appendChild(r.element);try{a.info("Starting auto-detection...");const n=await i(e,(e,t)=>{r.update(e,t)});if(0===n.items.length&&0===n.tomes.length){t.info({operation:"scan_build.ocr_empty_trying_cv",data:{message:"OCR found no items, trying icon detection"}}),r.update(50,"Trying icon detection..."),a.info("No text found, trying icon detection...");try{const n=await s(e,(e,t)=>{r.update(50+.5*e,t)});if(n.length>0)return o({items:n.filter(e=>"item"===e.type).map(e=>({type:"item",entity:e.entity,confidence:e.confidence,rawText:`cv_detected_${e.entity.name}`})),tomes:[],character:null,weapon:null}),a.success(`Detected ${n.length} items via icon matching`),void t.info({operation:"scan_build.cv_fallback_success",data:{itemsDetected:n.length}})}catch(d){_("scan_build.cv_fallback_failed",d)}}o(n),0===n.items.length&&0===n.tomes.length?a.info("No items detected. Try Hybrid mode or a clearer screenshot."):a.success(`Detected: ${n.items.length} items, ${n.tomes.length} tomes`+(n.character?", 1 character":"")+(n.weapon?", 1 weapon":"")),t.info({operation:"scan_build.auto_detect_complete",data:{itemsDetected:n.items.length,tomesDetected:n.tomes.length,characterDetected:n.character?1:0,weaponDetected:n.weapon?1:0}})}catch(m){E("scan_build.auto_detect_error",m),a.error(`Auto-detection failed: ${m.message}`)}finally{r.remove(),n.release()}}(k,z,Z):a.error("Please upload an image first")}async function te(){k?await C(k,z,H,R,Z):a.error("Please upload an image first")}function ne(){!function(e,n){const c=[];e.selectedItems.forEach(({item:e,count:t})=>{for(let n=0;n<t;n++)c.push(e)});const i={character:e.selectedCharacter,weapon:e.selectedWeapon,items:c,tomes:Array.from(e.selectedTomes.values())};n&&n(i);const s=window;"function"==typeof s.applyScannedBuild&&s.applyScannedBuild(i),a.success("Build state applied to advisor!"),t.info({operation:"scan_build.applied_to_advisor",data:{character:e.selectedCharacter?.name,weapon:e.selectedWeapon?.name,itemsCount:c.length,tomesCount:i.tomes.length}}),setTimeout(()=>{const e=document.getElementById("advisor-current-build-section");e?.scrollIntoView({behavior:"smooth",block:"start"})},100)}(F(),q)}function ae(){return{character:(e=F()).selectedCharacter,weapon:e.selectedWeapon,items:Array.from(e.selectedItems.entries()).map(([e,t])=>({id:e,name:t.item.name,count:t.count})),tomes:Array.from(e.selectedTomes.values()).map(e=>({id:e.id,name:e.name}))};var e}function ce(){j(),N.cancel(),z.isLocked()&&z.release(),S={},k=null,B=new Map,M=new Map,D=null,W=null,q=null,H=!1,R=null}window.initScanBuild=U;export{ce as __resetForTesting,j as cleanupEventListeners,ae as getScanState,ae as getState,U as initScanBuild};
//# sourceMappingURL=scan-build-fOLbnOZ0.js.map
