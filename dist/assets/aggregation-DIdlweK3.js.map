{"version":3,"file":"aggregation-DIdlweK3.js","sources":["../../src/modules/cv/aggregation.ts"],"sourcesContent":["// ========================================\n// CV Result Aggregation\n// ========================================\n\nimport type { CVDetectionResult } from './types.ts';\n\n/** Base detection result for combining OCR and CV results */\ninterface BaseDetectionResult {\n    type: string;\n    entity: { id: string; name: string };\n    confidence: number;\n    position?: { x: number; y: number; width: number; height: number };\n    method?: string;\n}\n\n/**\n * Aggregate duplicate detections into single entries with counts\n * Converts [Wrench, Wrench, Wrench] â†’ [Wrench x3]\n */\nexport function aggregateDuplicates(detections: CVDetectionResult[]): Array<CVDetectionResult & { count: number }> {\n    const grouped = new Map<string, Array<CVDetectionResult & { count?: number }>>();\n\n    // Group by entity ID\n    detections.forEach(detection => {\n        const key = detection.entity.id;\n        if (!grouped.has(key)) {\n            grouped.set(key, []);\n        }\n        grouped.get(key)!.push(detection);\n    });\n\n    // Aggregate each group\n    const aggregated: Array<CVDetectionResult & { count: number }> = [];\n\n    grouped.forEach((group, _entityId) => {\n        // Sum up counts (default to 1 per detection)\n        const totalCount = group.reduce((sum, d) => sum + (d.count || 1), 0);\n\n        // Use highest confidence from group\n        const maxConfidence = Math.max(...group.map(d => d.confidence));\n\n        // Keep first detection's position\n        const firstDetection = group[0];\n        if (!firstDetection) return;\n\n        aggregated.push({\n            type: firstDetection.type,\n            entity: firstDetection.entity,\n            confidence: maxConfidence,\n            position: firstDetection.position,\n            method: firstDetection.method,\n            count: totalCount,\n        });\n    });\n\n    // Sort by entity name for consistent ordering\n    return aggregated.sort((a, b) => a.entity.name.localeCompare(b.entity.name));\n}\n\n/**\n * Combine OCR and CV results for hybrid detection\n */\nexport function combineDetections(\n    ocrResults: BaseDetectionResult[],\n    cvResults: CVDetectionResult[]\n): CVDetectionResult[] {\n    const combined: CVDetectionResult[] = [];\n    const seen = new Set<string>();\n\n    // Merge results, boosting confidence when both methods agree\n    [...ocrResults, ...cvResults].forEach(result => {\n        const entity = result.entity;\n        const key = `${entity.id}_${result.type}`;\n\n        if (seen.has(key)) {\n            // Already added - boost confidence if found by both methods\n            const existing = combined.find(r => r.entity.id === entity.id && r.type === result.type);\n            if (existing) {\n                existing.confidence = Math.min(0.98, existing.confidence * 1.2);\n                existing.method = 'hybrid';\n            }\n        } else {\n            seen.add(key);\n            combined.push({\n                type: result.type as CVDetectionResult['type'],\n                entity: result.entity as CVDetectionResult['entity'],\n                confidence: result.confidence,\n                position: result.position,\n                method: (result.method || 'template_match') as CVDetectionResult['method'],\n            });\n        }\n    });\n\n    // Sort by confidence\n    return combined.sort((a, b) => b.confidence - a.confidence);\n}\n"],"names":["aggregateDuplicates","detections","grouped","Map","forEach","detection","key","entity","id","has","set","get","push","aggregated","group","_entityId","totalCount","reduce","sum","d","count","maxConfidence","Math","max","map","confidence","firstDetection","type","position","method","sort","a","b","name","localeCompare","combineDetections","ocrResults","cvResults","combined","seen","Set","result","existing","find","r","min","add"],"mappings":"AAmBO,SAASA,EAAoBC,GAChC,MAAMC,MAAcC,IAGpBF,EAAWG,QAAQC,IACf,MAAMC,EAAMD,EAAUE,OAAOC,GACxBN,EAAQO,IAAIH,IACbJ,EAAQQ,IAAIJ,EAAK,IAErBJ,EAAQS,IAAIL,GAAMM,KAAKP,KAI3B,MAAMQ,EAA2D,GAwBjE,OAtBAX,EAAQE,QAAQ,CAACU,EAAOC,KAEpB,MAAMC,EAAaF,EAAMG,OAAO,CAACC,EAAKC,IAAMD,GAAOC,EAAEC,OAAS,GAAI,GAG5DC,EAAgBC,KAAKC,OAAOT,EAAMU,IAAIL,GAAKA,EAAEM,aAG7CC,EAAiBZ,EAAM,GACxBY,GAELb,EAAWD,KAAK,CACZe,KAAMD,EAAeC,KACrBpB,OAAQmB,EAAenB,OACvBkB,WAAYJ,EACZO,SAAUF,EAAeE,SACzBC,OAAQH,EAAeG,OACvBT,MAAOJ,MAKRH,EAAWiB,KAAK,CAACC,EAAGC,IAAMD,EAAExB,OAAO0B,KAAKC,cAAcF,EAAEzB,OAAO0B,MAC1E,CAKO,SAASE,EACZC,EACAC,GAEA,MAAMC,EAAgC,GAChCC,MAAWC,IA2BjB,MAxBA,IAAIJ,KAAeC,GAAWjC,QAAQqC,IAClC,MAAMlC,EAASkC,EAAOlC,OAChBD,EAAM,GAAGC,EAAOC,MAAMiC,EAAOd,OAEnC,GAAIY,EAAK9B,IAAIH,GAAM,CAEf,MAAMoC,EAAWJ,EAASK,KAAKC,GAAKA,EAAErC,OAAOC,KAAOD,EAAOC,IAAMoC,EAAEjB,OAASc,EAAOd,MAC/Ee,IACAA,EAASjB,WAAaH,KAAKuB,IAAI,IAA4B,IAAtBH,EAASjB,YAC9CiB,EAASb,OAAS,SAE1B,MACIU,EAAKO,IAAIxC,GACTgC,EAAS1B,KAAK,CACVe,KAAMc,EAAOd,KACbpB,OAAQkC,EAAOlC,OACfkB,WAAYgB,EAAOhB,WACnBG,SAAUa,EAAOb,SACjBC,OAASY,EAAOZ,QAAU,qBAM/BS,EAASR,KAAK,CAACC,EAAGC,IAAMA,EAAEP,WAAaM,EAAEN,WACpD"}