{"version":3,"file":"build-planner-BOgbpcnK.js","sources":["../../src/modules/build-stats.ts","../../src/modules/build-ui.ts","../../src/modules/build-validation.ts","../../src/modules/build-planner.ts"],"sourcesContent":["// ========================================\n// MegaBonk Build Stats Module\n// Stat calculations, damage formulas, build scoring\n// ========================================\n\nimport type { Tome, Item } from '../types/index.ts';\nimport {\n    DEFAULT_BUILD_STATS,\n    ITEM_EFFECTS,\n    type BuildStats,\n    type ItemEffect,\n} from './constants.ts';\nimport type { Build } from './store.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Extended build stats with calculated properties\n */\nexport interface CalculatedBuildStats extends BuildStats {\n    evasion: number;\n    overcrit: boolean;\n}\n\n// ========================================\n// Build Stats Memoization Cache\n// ========================================\nlet lastBuildCacheKey = '';\nlet cachedBuildStats: CalculatedBuildStats | null = null;\n\n/**\n * Invalidate the memoization cache\n * Should be called when underlying data changes (e.g., allData reload)\n */\nexport function invalidateBuildStatsCache(): void {\n    lastBuildCacheKey = '';\n    cachedBuildStats = null;\n}\n\n/**\n * Generate a cache key from build state\n * @param build - Build to generate key for\n * @returns Cache key string\n */\nexport function getBuildCacheKey(build: Build): string {\n    return [\n        build.character?.id || '',\n        build.weapon?.id || '',\n        build.tomes\n            .map((t: Tome) => t.id)\n            .sort()\n            .join(','),\n        build.items\n            .map((i: Item) => i.id)\n            .sort()\n            .join(','),\n    ].join('|');\n}\n\n/**\n * Apply character passive bonuses based on passive_ability text\n * Pattern matching is data-driven - no hardcoded character IDs\n * @param stats - Stats object to modify\n * @param passive - Character passive ability text\n */\nfunction applyCharacterPassives(stats: CalculatedBuildStats, passive: string): void {\n    const passiveLower = passive.toLowerCase();\n\n    // Crit Chance passive (e.g., \"Gain 1% Crit Chance per level\")\n    if (/crit(ical)?\\s*chance/i.test(passiveLower)) {\n        stats.crit_chance += 50;\n    }\n    // HP passive (e.g., \"+2 Max HP per level\", \"Gain X HP per level\")\n    if (/max\\s*hp|hp\\s*per\\s*level/i.test(passiveLower)) {\n        stats.hp += 50;\n    }\n    // Armor passive (e.g., \"Gain 1% Armor per level\")\n    if (/armor/i.test(passiveLower)) {\n        stats.armor += 50;\n    }\n    // Damage passive (e.g., \"Gain 1.5% Damage per level\")\n    // Match \"gain X% damage\" but not \"critical damage\"\n    if (/gain.*\\d+(\\.\\d+)?%?\\s*damage/i.test(passiveLower) && !/crit(ical)?\\s*damage/i.test(passiveLower)) {\n        stats.damage += 20;\n    }\n    // Attack Speed passive (e.g., \"Gain 1% Attack Speed per level\")\n    if (/attack\\s*speed/i.test(passiveLower)) {\n        stats.attack_speed += 50;\n    }\n    // Movement Speed passive\n    if (/move(ment)?\\s*speed/i.test(passiveLower)) {\n        stats.movement_speed += 20;\n    }\n    // Crit Damage passive\n    if (/crit(ical)?\\s*damage/i.test(passiveLower)) {\n        stats.crit_damage += 25;\n    }\n}\n\n/**\n * Apply tome bonuses to stats\n * @param stats - Stats object to modify\n * @param tome - Tome to apply\n */\nfunction applyTomeBonus(stats: CalculatedBuildStats, tome: Tome): void {\n    const tomeLevel = 5;\n    // Safely extract numeric value from value_per_level\n    // Handles formats like:\n    // - \"+0.08x (8% damage)\" - decimal multiplier, needs *100 to get percentage\n    // - \"+7% crit chance\" - integer percentage, use as-is\n    // - \"+25 Max HP\" - absolute value, use as-is\n    const valueStr = tome.value_per_level || '';\n    const match = String(valueStr).match(/[+-]?\\d+(?:\\.\\d+)?/);\n    const rawValue = match ? parseFloat(match[0]) : 0;\n    // Bug fix: Use Number.isFinite to catch both NaN and Infinity values\n    // Clamp to reasonable bounds to prevent overflow from malformed data\n    const safeRawValue = Number.isFinite(rawValue) ? Math.max(-1000, Math.min(1000, rawValue)) : 0;\n\n    // Bug fix: Handle different value formats correctly\n    // Decimal values < 1 (like 0.08) represent percentages that need *100\n    // Integer values >= 1 (like 7, 25) are already the correct value\n    const value = safeRawValue < 1 && safeRawValue > 0 ? safeRawValue * 100 : safeRawValue;\n\n    // Apply tome bonus: value per level * tome level\n    if (tome.stat_affected === 'Damage') stats.damage += value * tomeLevel;\n    else if (tome.stat_affected === 'Critical Chance' || tome.id === 'precision')\n        stats.crit_chance += value * tomeLevel;\n    else if (tome.stat_affected === 'Crit Damage') stats.crit_damage += value * tomeLevel;\n    else if (tome.stat_affected === 'Max HP' || tome.id === 'vitality' || tome.id === 'hp')\n        stats.hp += value * tomeLevel;\n    else if (tome.stat_affected === 'Attack Speed' || tome.id === 'cooldown')\n        stats.attack_speed += value * tomeLevel;\n    else if (tome.stat_affected === 'Movement Speed' || tome.id === 'agility')\n        stats.movement_speed += value * tomeLevel;\n    else if (tome.stat_affected === 'Armor' || tome.id === 'armor') stats.armor += value * tomeLevel;\n}\n\n/**\n * Apply item effects to stats using ITEM_EFFECTS constant\n * @param stats - Stats object to modify\n * @param item - Item to apply\n */\nfunction applyItemEffect(stats: CalculatedBuildStats, item: Item): void {\n    const effect: ItemEffect | undefined = ITEM_EFFECTS[item.id];\n    if (effect) {\n        const statKey = effect.stat;\n        if (effect.type === 'add') {\n            stats[statKey] += effect.value;\n        } else if (effect.type === 'multiply') {\n            stats[statKey] *= effect.value;\n        } else if (effect.type === 'hp_percent') {\n            // Special: damage based on HP percentage\n            stats[statKey] += (stats.hp / 100) * effect.value;\n        }\n    }\n}\n\n/**\n * Calculate build statistics with memoization\n * Results are cached until the build changes to avoid recalculation\n * @param build - Build to calculate stats for\n * @param useCache - Whether to use memoization cache (default true)\n * @returns Calculated stats\n */\nexport function calculateBuildStats(build: Build, useCache: boolean = true): CalculatedBuildStats {\n    // Check memoization cache\n    if (useCache) {\n        const cacheKey = getBuildCacheKey(build);\n        if (cacheKey === lastBuildCacheKey && cachedBuildStats) {\n            return cachedBuildStats;\n        }\n        lastBuildCacheKey = cacheKey;\n    }\n\n    const stats: CalculatedBuildStats = { ...DEFAULT_BUILD_STATS, evasion: 0, overcrit: false };\n\n    // Apply character passive bonuses\n    if (build.character) {\n        const passive = build.character.passive_ability || '';\n        applyCharacterPassives(stats, passive);\n    }\n\n    // Use parseFloat instead of parseInt for decimal damage values\n    if (build.weapon) {\n        const baseDamage = build.weapon.base_damage ?? build.weapon.baseDamage;\n        // Handle undefined/null: parseFloat(String(undefined)) returns NaN, and NaN || 0 still gives NaN\n        // Bug fix: Use Number.isFinite instead of Number.isNaN to also catch Infinity values\n        const parsedDamage = baseDamage != null ? parseFloat(String(baseDamage)) : 0;\n        stats.damage += Number.isFinite(parsedDamage) ? parsedDamage : 0;\n    }\n\n    // Apply tome bonuses\n    build.tomes.forEach((tome: Tome) => applyTomeBonus(stats, tome));\n\n    // Apply item effects\n    build.items.forEach((item: Item) => applyItemEffect(stats, item));\n\n    // Calculate evasion\n    // Prevent division by zero in evasion formula if evasion_internal is <= -100\n    // Formula: evasion = internal / (1 + internal/100)\n    // Clamp evasion_internal to prevent negative or zero denominator\n    const clampedEvasionInternal = Math.max(stats.evasion_internal, -99);\n    stats.evasion = Math.round((clampedEvasionInternal / (1 + clampedEvasionInternal / 100)) * 100) / 100;\n    stats.overcrit = stats.crit_chance > 100;\n\n    // Cache the result for memoization\n    if (useCache) {\n        cachedBuildStats = stats;\n    }\n\n    return stats;\n}\n\n/**\n * Calculate DPS (damage per second) for a build\n * @param stats - Calculated build stats\n * @returns Estimated DPS value\n */\nexport function calculateDPS(stats: CalculatedBuildStats): number {\n    const baseDamage = stats.damage;\n    const critMultiplier = 1 + (stats.crit_chance / 100) * (stats.crit_damage / 100 - 1);\n    const attackSpeedMultiplier = 1 + stats.attack_speed / 100;\n    \n    return baseDamage * critMultiplier * attackSpeedMultiplier * stats.projectiles;\n}\n\n/**\n * Calculate effective HP considering armor and evasion\n * @param stats - Calculated build stats\n * @returns Effective HP value\n */\nexport function calculateEffectiveHP(stats: CalculatedBuildStats): number {\n    const armorReduction = stats.armor / (stats.armor + 100); // Diminishing returns formula\n    const evasionMultiplier = 1 / (1 - stats.evasion / 100);\n    \n    return stats.hp * (1 / (1 - armorReduction)) * evasionMultiplier;\n}\n\n/**\n * Score a build for comparison (higher is better)\n * @param stats - Calculated build stats\n * @returns Numeric score for the build\n */\nexport function scoreBuild(stats: CalculatedBuildStats): number {\n    const dps = calculateDPS(stats);\n    const ehp = calculateEffectiveHP(stats);\n    const mobilityBonus = stats.movement_speed * 2;\n    \n    // Weighted score combining offense and defense\n    return dps * 0.6 + ehp * 0.3 + mobilityBonus * 0.1;\n}\n","// ========================================\n// MegaBonk Build UI Module\n// UI rendering, DOM updates, modals\n// ========================================\n\nimport type { Character, Weapon, Tome, Item } from '../types/index.ts';\nimport { ToastManager } from './toast.ts';\nimport { allData } from './data-service.ts';\nimport { safeGetElementById, escapeHtml, safeQuerySelectorAll, safeSetValue } from './utils.ts';\nimport { BUILD_ITEMS_LIMIT } from './constants.ts';\nimport type { Build } from './store.ts';\nimport { calculateBuildStats, type CalculatedBuildStats } from './build-stats.ts';\nimport { detectSynergies } from './build-validation.ts';\n\n// ========================================\n// UI Rendering\n// ========================================\n\n/**\n * Render character select dropdown\n * Uses DocumentFragment to batch DOM operations\n */\nexport function renderCharacterSelect(): void {\n    const charSelect = safeGetElementById('build-character') as HTMLSelectElement | null;\n    if (!charSelect) return;\n    \n    charSelect.innerHTML = '<option value=\"\">Select Character...</option>';\n    \n    if (allData.characters?.characters) {\n        const fragment = document.createDocumentFragment();\n        allData.characters.characters.forEach((char: Character) => {\n            const option = document.createElement('option');\n            option.value = char.id;\n            option.textContent = `${char.name} (${char.tier} Tier)`;\n            fragment.appendChild(option);\n        });\n        charSelect.appendChild(fragment);\n    }\n}\n\n/**\n * Render weapon select dropdown\n * Uses DocumentFragment to batch DOM operations\n */\nexport function renderWeaponSelect(): void {\n    const weaponSelect = safeGetElementById('build-weapon') as HTMLSelectElement | null;\n    if (!weaponSelect) return;\n    \n    weaponSelect.innerHTML = '<option value=\"\">Select Weapon...</option>';\n    \n    if (allData.weapons?.weapons) {\n        const fragment = document.createDocumentFragment();\n        allData.weapons.weapons.forEach((weapon: Weapon) => {\n            const option = document.createElement('option');\n            option.value = weapon.id;\n            option.textContent = `${weapon.name} (${weapon.tier} Tier)`;\n            fragment.appendChild(option);\n        });\n        weaponSelect.appendChild(fragment);\n    }\n}\n\n/**\n * Render tomes selection checkboxes\n * Uses DocumentFragment to batch DOM operations\n */\nexport function renderTomesSelection(): void {\n    const tomesSelection = safeGetElementById('tomes-selection');\n    if (!tomesSelection) return;\n    \n    tomesSelection.innerHTML = '';\n    \n    if (allData.tomes?.tomes) {\n        const fragment = document.createDocumentFragment();\n        allData.tomes.tomes.forEach((tome: Tome) => {\n            const label = document.createElement('label');\n            // Security: Use escapeHtml to prevent XSS from compromised JSON data\n            label.innerHTML = `<input type=\"checkbox\" value=\"${escapeHtml(tome.id)}\" class=\"tome-checkbox\"> ${escapeHtml(tome.name)}`;\n            fragment.appendChild(label);\n        });\n        tomesSelection.appendChild(fragment);\n    }\n}\n\n/**\n * Render items selection checkboxes\n * Uses DocumentFragment to batch DOM operations\n */\nexport function renderItemsSelection(): void {\n    const itemsSelection = safeGetElementById('items-selection');\n    if (!itemsSelection) return;\n    \n    itemsSelection.innerHTML = '';\n    \n    if (allData.items?.items) {\n        const fragment = document.createDocumentFragment();\n        allData.items.items.slice(0, BUILD_ITEMS_LIMIT).forEach((item: Item) => {\n            const label = document.createElement('label');\n            // Security: Use escapeHtml to prevent XSS from compromised JSON data\n            label.innerHTML = `<input type=\"checkbox\" value=\"${escapeHtml(item.id)}\" class=\"item-checkbox\"> ${escapeHtml(item.name)} (${escapeHtml(item.tier)})`;\n            fragment.appendChild(label);\n        });\n        itemsSelection.appendChild(fragment);\n    }\n}\n\n/**\n * Render the build planner UI\n * Uses DocumentFragment to batch DOM operations and prevent layout thrashing\n */\nexport function renderBuildPlanner(): void {\n    renderCharacterSelect();\n    renderWeaponSelect();\n    renderTomesSelection();\n    renderItemsSelection();\n}\n\n/**\n * Render stats display\n * @param stats - Calculated stats to display\n */\nexport function renderStatsDisplay(stats: CalculatedBuildStats): void {\n    const statsDisplay = safeGetElementById('build-stats');\n    if (!statsDisplay) return;\n    \n    statsDisplay.innerHTML = `\n        <div class=\"stat-card\"><div class=\"stat-icon\">‚öîÔ∏è</div><div class=\"stat-info\"><div class=\"stat-label\">Total Damage</div><div class=\"stat-value\">${stats.damage.toFixed(0)}%</div></div></div>\n        <div class=\"stat-card\"><div class=\"stat-icon\">‚ù§Ô∏è</div><div class=\"stat-info\"><div class=\"stat-label\">Max HP</div><div class=\"stat-value\">${stats.hp.toFixed(0)}</div></div></div>\n        <div class=\"stat-card ${stats.overcrit ? 'stat-overcrit' : ''}\"><div class=\"stat-icon\">üí•</div><div class=\"stat-info\"><div class=\"stat-label\">Crit Chance${stats.overcrit ? ' (OVERCRIT!)' : ''}</div><div class=\"stat-value\">${stats.crit_chance.toFixed(1)}%</div></div></div>\n        <div class=\"stat-card\"><div class=\"stat-icon\">üéØ</div><div class=\"stat-info\"><div class=\"stat-label\">Crit Damage</div><div class=\"stat-value\">${stats.crit_damage.toFixed(0)}%</div></div></div>\n        <div class=\"stat-card\"><div class=\"stat-icon\">‚ö°</div><div class=\"stat-info\"><div class=\"stat-label\">Attack Speed</div><div class=\"stat-value\">${stats.attack_speed.toFixed(0)}%</div></div></div>\n        <div class=\"stat-card\"><div class=\"stat-icon\">üëü</div><div class=\"stat-info\"><div class=\"stat-label\">Movement Speed</div><div class=\"stat-value\">${stats.movement_speed.toFixed(0)}%</div></div></div>\n        <div class=\"stat-card\"><div class=\"stat-icon\">üõ°Ô∏è</div><div class=\"stat-info\"><div class=\"stat-label\">Armor</div><div class=\"stat-value\">${stats.armor.toFixed(0)}</div></div></div>\n        <div class=\"stat-card\"><div class=\"stat-icon\">üí®</div><div class=\"stat-info\"><div class=\"stat-label\">Evasion</div><div class=\"stat-value\">${stats.evasion.toFixed(1)}%</div></div></div>\n        <div class=\"stat-card\"><div class=\"stat-icon\">üéØ</div><div class=\"stat-info\"><div class=\"stat-label\">Projectiles</div><div class=\"stat-value\">${stats.projectiles}</div></div></div>\n    `;\n}\n\n/**\n * Render synergies display\n * @param synergies - Array of synergy messages\n */\nexport function renderSynergiesDisplay(synergies: string[]): void {\n    const synergiesDisplay = safeGetElementById('build-synergies');\n    if (!synergiesDisplay) return;\n    \n    synergiesDisplay.innerHTML =\n        synergies.length > 0\n            ? `<h4>üîó Synergies Found:</h4><ul>${synergies.map((s: string) => `<li>${s}</li>`).join('')}</ul>`\n            : '<p>Select character, weapon, and items to see synergies...</p>';\n}\n\n/**\n * Render placeholder when build is incomplete\n */\nexport function renderStatsPlaceholder(): void {\n    const statsDisplay = safeGetElementById('build-stats');\n    if (!statsDisplay) return;\n    \n    statsDisplay.innerHTML =\n        '<p class=\"stats-placeholder\">Select character and weapon to see calculated stats...</p>';\n}\n\n/**\n * Update the build analysis display (stats and synergies)\n * @param build - Current build state\n * @param onBuildUpdate - Callback when build state changes\n */\nexport function updateBuildDisplay(build: Build, onBuildUpdate?: () => void): void {\n    // Calculate and display stats\n    if (build.character && build.weapon) {\n        const stats = calculateBuildStats(build);\n        renderStatsDisplay(stats);\n    } else {\n        renderStatsPlaceholder();\n    }\n    \n    // Detect and display synergies\n    const synergyResult = detectSynergies(build);\n    renderSynergiesDisplay(synergyResult.messages);\n    \n    // Notify of build update\n    if (onBuildUpdate) {\n        onBuildUpdate();\n    }\n}\n\n// ========================================\n// Checkbox/Selection State Management\n// ========================================\n\n/**\n * Set character selection in UI\n * @param charId - Character ID to select\n */\nexport function setCharacterSelection(charId: string): void {\n    safeSetValue('build-character', charId);\n}\n\n/**\n * Set weapon selection in UI\n * @param weaponId - Weapon ID to select\n */\nexport function setWeaponSelection(weaponId: string): void {\n    safeSetValue('build-weapon', weaponId);\n}\n\n/**\n * Set tome checkbox states\n * @param tomeIds - Array of tome IDs to check\n */\nexport function setTomeCheckboxes(tomeIds: string[]): void {\n    const tomeCheckboxes = document.querySelectorAll('.tome-checkbox') as NodeListOf<HTMLInputElement>;\n    const checkboxMap = new Map<string, HTMLInputElement>();\n    tomeCheckboxes.forEach(cb => checkboxMap.set(cb.value, cb));\n    \n    tomeIds.forEach((tomeId: string) => {\n        const checkbox = checkboxMap.get(tomeId);\n        if (checkbox) checkbox.checked = true;\n    });\n}\n\n/**\n * Set item checkbox states\n * @param itemIds - Array of item IDs to check\n */\nexport function setItemCheckboxes(itemIds: string[]): void {\n    const itemCheckboxes = document.querySelectorAll('.item-checkbox') as NodeListOf<HTMLInputElement>;\n    const checkboxMap = new Map<string, HTMLInputElement>();\n    itemCheckboxes.forEach(cb => checkboxMap.set(cb.value, cb));\n    \n    itemIds.forEach((itemId: string) => {\n        const checkbox = checkboxMap.get(itemId);\n        if (checkbox) checkbox.checked = true;\n    });\n}\n\n/**\n * Clear all selections in UI\n */\nexport function clearAllSelections(): void {\n    safeSetValue('build-character', '');\n    safeSetValue('build-weapon', '');\n    safeQuerySelectorAll('.tome-checkbox').forEach((cb: Element) => ((cb as HTMLInputElement).checked = false));\n    safeQuerySelectorAll('.item-checkbox').forEach((cb: Element) => ((cb as HTMLInputElement).checked = false));\n}\n\n/**\n * Get selected tome IDs from checkboxes\n * @returns Array of selected tome IDs\n */\nexport function getSelectedTomeIds(): string[] {\n    return Array.from(safeQuerySelectorAll('.tome-checkbox:checked')).map(\n        (cb: Element) => (cb as HTMLInputElement).value\n    );\n}\n\n/**\n * Get selected item IDs from checkboxes\n * @returns Array of selected item IDs\n */\nexport function getSelectedItemIds(): string[] {\n    return Array.from(safeQuerySelectorAll('.item-checkbox:checked')).map(\n        (cb: Element) => (cb as HTMLInputElement).value\n    );\n}\n\n// ========================================\n// Clipboard Operations\n// ========================================\n\n/**\n * Copy text to clipboard with toast feedback\n * @param text - Text to copy\n * @param successMessage - Message to show on success\n */\nexport async function copyToClipboard(text: string, successMessage: string): Promise<boolean> {\n    try {\n        await navigator.clipboard.writeText(text);\n        ToastManager.success(successMessage);\n        return true;\n    } catch (err) {\n        const error = err as Error;\n        ToastManager.error(`Failed to copy to clipboard: ${error.message}`);\n        return false;\n    }\n}\n\n// ========================================\n// Event Setup\n// ========================================\n\n/**\n * Setup build planner event listeners\n * @param onCharacterChange - Callback when character changes\n * @param onWeaponChange - Callback when weapon changes\n * @param onExport - Callback for export button\n * @param onShare - Callback for share button\n * @param onClear - Callback for clear button\n */\nexport function setupBuildPlannerEvents(\n    onCharacterChange: (charId: string) => void,\n    onWeaponChange: (weaponId: string) => void,\n    onExport: () => void,\n    onShare: () => void,\n    onClear: () => void\n): void {\n    const charSelect = safeGetElementById('build-character');\n    if (charSelect) {\n        charSelect.addEventListener('change', (e: Event) => {\n            const target = e.target as HTMLSelectElement;\n            onCharacterChange(target.value);\n        });\n    }\n\n    const weaponSelect = safeGetElementById('build-weapon');\n    if (weaponSelect) {\n        weaponSelect.addEventListener('change', (e: Event) => {\n            const target = e.target as HTMLSelectElement;\n            onWeaponChange(target.value);\n        });\n    }\n\n    const exportBtn = safeGetElementById('export-build');\n    if (exportBtn) {\n        exportBtn.addEventListener('click', onExport);\n    }\n\n    const shareBtn = safeGetElementById('share-build-url');\n    if (shareBtn) {\n        shareBtn.addEventListener('click', onShare);\n    }\n\n    const clearBtn = safeGetElementById('clear-build');\n    if (clearBtn) {\n        clearBtn.addEventListener('click', onClear);\n    }\n}\n\n/**\n * Setup tome and item checkbox change listeners\n * @param onSelectionChange - Callback when selection changes\n */\nexport function setupSelectionListeners(onSelectionChange: () => void): void {\n    // Delegate to parent containers for efficiency\n    const tomesSelection = safeGetElementById('tomes-selection');\n    if (tomesSelection) {\n        tomesSelection.addEventListener('change', onSelectionChange);\n    }\n    \n    const itemsSelection = safeGetElementById('items-selection');\n    if (itemsSelection) {\n        itemsSelection.addEventListener('change', onSelectionChange);\n    }\n}\n","// ========================================\n// MegaBonk Build Validation Module\n// Build validation, synergy checking\n// ========================================\n\nimport type { Character, Weapon, Item } from '../types/index.ts';\nimport type { Build } from './store.ts';\nimport { escapeHtml } from './utils.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Build data for serialization (with IDs only)\n */\nexport interface BuildData {\n    character?: string;\n    weapon?: string;\n    tomes?: string[];\n    items?: string[];\n    name?: string;\n    notes?: string;\n    timestamp?: number;\n}\n\n/**\n * URL-encoded build data (abbreviated keys)\n */\nexport interface URLBuildData {\n    c?: string;\n    w?: string;\n    t?: string[];\n    i?: string[];\n}\n\n/**\n * Synergy result\n */\nexport interface SynergyResult {\n    found: boolean;\n    messages: string[];\n}\n\n// ========================================\n// Build Entry Validation\n// ========================================\n\n/**\n * Validate a build history entry has required structure\n * @param entry - Entry to validate\n * @returns True if entry is valid\n */\nexport function isValidBuildEntry(entry: unknown): entry is BuildData {\n    if (typeof entry !== 'object' || entry === null) return false;\n    const obj = entry as Record<string, unknown>;\n    // At minimum, must have some identifying property (character, weapon, or timestamp)\n    // and arrays must be arrays (if present)\n    if (obj.tomes !== undefined && !Array.isArray(obj.tomes)) return false;\n    if (obj.items !== undefined && !Array.isArray(obj.items)) return false;\n    return true;\n}\n\n/**\n * Validate base64 string format\n * @param encoded - String to validate\n * @returns True if valid base64\n */\nexport function isValidBase64(encoded: string): boolean {\n    // Base64 should only contain alphanumeric, +, /, and = characters\n    return /^[A-Za-z0-9+/=]+$/.test(encoded);\n}\n\n/**\n * Validate URL-encoded build data structure\n * @param decoded - Decoded object to validate\n * @returns True if valid build data structure\n */\nexport function isValidURLBuildData(decoded: unknown): decoded is URLBuildData {\n    if (typeof decoded !== 'object' || decoded === null) return false;\n    \n    const obj = decoded as Record<string, unknown>;\n    \n    // Optional string fields\n    if (obj.c !== undefined && typeof obj.c !== 'string') return false;\n    if (obj.w !== undefined && typeof obj.w !== 'string') return false;\n    \n    // Optional string array fields\n    if (obj.t !== undefined && (!Array.isArray(obj.t) || !obj.t.every(item => typeof item === 'string'))) return false;\n    if (obj.i !== undefined && (!Array.isArray(obj.i) || !obj.i.every(item => typeof item === 'string'))) return false;\n    \n    return true;\n}\n\n// ========================================\n// Synergy Detection\n// ========================================\n\n/**\n * Check character-weapon synergy\n * @param character - Character to check\n * @param weapon - Weapon to check\n * @returns True if synergy exists\n */\nexport function hasCharacterWeaponSynergy(character: Character, weapon: Weapon): boolean {\n    return character.synergies_weapons?.includes(weapon.name) ?? false;\n}\n\n/**\n * Check item-weapon synergy\n * @param item - Item to check\n * @param weapon - Weapon to check\n * @returns True if synergy exists\n */\nexport function hasItemWeaponSynergy(item: Item, weapon: Weapon): boolean {\n    const itemSynergies = item.synergies || [];\n    const weaponName = weapon.name.toLowerCase();\n    \n    // Bug fix: Filter out empty strings to prevent false positives\n    // (\"sword\".includes(\"\") is always true, causing false matches)\n    return itemSynergies.some(\n        (syn: string) =>\n            syn.length > 0 &&\n            weaponName.length > 0 &&\n            (syn.toLowerCase().includes(weaponName) ||\n                weaponName.includes(syn.toLowerCase()))\n    );\n}\n\n/**\n * Detect all synergies in a build\n * @param build - Build to analyze\n * @returns Synergy result with messages\n */\nexport function detectSynergies(build: Build): SynergyResult {\n    const messages: string[] = [];\n    \n    // Check character-weapon synergy\n    if (build.character && build.weapon) {\n        if (hasCharacterWeaponSynergy(build.character, build.weapon)) {\n            messages.push(\n                `‚úì ${escapeHtml(build.character.name)} synergizes with ${escapeHtml(build.weapon.name)}!`\n            );\n        }\n    }\n    \n    // Check item synergies with weapon\n    if (build.weapon) {\n        build.items.forEach((item: Item) => {\n            if (hasItemWeaponSynergy(item, build.weapon!)) {\n                messages.push(`‚úì ${escapeHtml(item.name)} works great with ${escapeHtml(build.weapon!.name)}`);\n            }\n        });\n    }\n    \n    return {\n        found: messages.length > 0,\n        messages,\n    };\n}\n\n/**\n * Check for potential anti-synergies or conflicts\n * @param build - Build to analyze\n * @returns Array of warning messages\n */\nexport function detectAntiSynergies(build: Build): string[] {\n    const warnings: string[] = [];\n    \n    // Example: warn about conflicting item effects\n    const itemIds = build.items.map(i => i.id);\n    \n    // Check for duplicate effect types that don't stack well\n    const hasMultipleCritItems = itemIds.filter(id => \n        ['clover', 'eagle_claw', 'lucky_coin'].includes(id)\n    ).length > 2;\n    \n    if (hasMultipleCritItems) {\n        warnings.push('‚ö†Ô∏è Multiple crit items may have diminishing returns');\n    }\n    \n    return warnings;\n}\n\n// ========================================\n// Build Completeness Validation\n// ========================================\n\n/**\n * Check if build has minimum required components\n * @param build - Build to validate\n * @returns True if build is valid\n */\nexport function isValidBuild(build: Build): boolean {\n    return build.character !== null || build.weapon !== null;\n}\n\n/**\n * Get build completeness percentage\n * @param build - Build to analyze\n * @returns Percentage (0-100) of build completeness\n */\nexport function getBuildCompleteness(build: Build): number {\n    let score = 0;\n    const maxScore = 4;\n    \n    if (build.character) score += 1;\n    if (build.weapon) score += 1;\n    if (build.tomes.length > 0) score += 1;\n    if (build.items.length > 0) score += 1;\n    \n    return Math.round((score / maxScore) * 100);\n}\n\n/**\n * Validate build data from external source (import/URL)\n * @param data - Raw data to validate\n * @returns Validated BuildData or null if invalid\n */\nexport function validateBuildData(data: unknown): BuildData | null {\n    if (!isValidBuildEntry(data)) return null;\n    \n    const buildData = data as BuildData;\n    \n    // Sanitize string fields\n    if (buildData.character && typeof buildData.character !== 'string') return null;\n    if (buildData.weapon && typeof buildData.weapon !== 'string') return null;\n    if (buildData.name && typeof buildData.name !== 'string') return null;\n    if (buildData.notes && typeof buildData.notes !== 'string') return null;\n    \n    // Validate timestamp if present\n    if (buildData.timestamp !== undefined) {\n        if (typeof buildData.timestamp !== 'number' || !Number.isFinite(buildData.timestamp)) {\n            return null;\n        }\n    }\n    \n    return buildData;\n}\n","// ========================================\n// MegaBonk Build Planner Module\n// Main entry point - orchestrates stats, validation, and UI\n// ========================================\n\nimport type { Character, Weapon, Tome, Item } from '../types/index.ts';\nimport { ToastManager } from './toast.ts';\nimport { allData } from './data-service.ts';\nimport { MAX_BUILD_HISTORY } from './constants.ts';\nimport { logger } from './logger.ts';\nimport { getState, setState, type Build } from './store.ts';\n\n// Import from sub-modules\nimport {\n    calculateBuildStats as calculateBuildStatsFromModule,\n    invalidateBuildStatsCache,\n    type CalculatedBuildStats,\n} from './build-stats.ts';\nimport {\n    isValidBuildEntry,\n    isValidBase64,\n    isValidURLBuildData,\n    type BuildData,\n    type URLBuildData,\n} from './build-validation.ts';\nimport {\n    renderBuildPlanner as renderUI,\n    updateBuildDisplay,\n    setupBuildPlannerEvents as setupUIEvents,\n    setupSelectionListeners,\n    setCharacterSelection,\n    setWeaponSelection,\n    setTomeCheckboxes,\n    setItemCheckboxes,\n    clearAllSelections,\n    getSelectedTomeIds,\n    getSelectedItemIds,\n    copyToClipboard,\n} from './build-ui.ts';\n\n// Re-export types for backwards compatibility\nexport type { Build } from './store.ts';\nexport type { BuildData, URLBuildData } from './build-validation.ts';\nexport type { CalculatedBuildStats } from './build-stats.ts';\nexport { invalidateBuildStatsCache } from './build-stats.ts';\n\n/**\n * Calculate build statistics with memoization\n * Wrapper that provides backwards compatibility by using current build if none provided\n * @param build - Optional build to calculate stats for (uses currentBuild if not provided)\n * @returns Calculated stats\n */\nexport function calculateBuildStats(build?: Build): CalculatedBuildStats {\n    const buildToUse = build || getState('currentBuild');\n    return calculateBuildStatsFromModule(buildToUse);\n}\n\n// ========================================\n// Build Templates\n// ========================================\n\ninterface BuildTemplate {\n    name: string;\n    description: string;\n    build: BuildData;\n}\n\ntype BuildTemplatesMap = Record<string, BuildTemplate>;\n\nexport const BUILD_TEMPLATES: Readonly<BuildTemplatesMap> = Object.freeze({\n    crit_build: {\n        name: 'üéØ Crit Build',\n        description: 'Maximize critical hit chance and damage',\n        build: {\n            character: 'cl4nk',\n            weapon: 'revolver',\n            tomes: ['precision', 'damage'],\n            items: ['clover', 'eagle_claw'],\n        },\n    },\n    tank_build: {\n        name: 'üõ°Ô∏è Tank Build',\n        description: 'High HP and survivability',\n        build: {\n            character: 'sir_oofie',\n            weapon: 'sword',\n            tomes: ['hp', 'armor'],\n            items: ['chonkplate', 'golden_shield'],\n        },\n    },\n    speed_build: {\n        name: '‚ö° Speed Build',\n        description: 'Fast attack and movement speed',\n        build: {\n            character: 'bandit',\n            weapon: 'katana',\n            tomes: ['cooldown', 'agility'],\n            items: ['turbo_skates', 'turbo_socks'],\n        },\n    },\n    glass_cannon: {\n        name: 'üí• Glass Cannon',\n        description: 'Maximum damage, low defense',\n        build: {\n            character: 'ogre',\n            weapon: 'sniper_rifle',\n            tomes: ['damage', 'cooldown'],\n            items: ['power_gloves', 'gym_sauce'],\n        },\n    },\n});\n\n// ========================================\n// State Management\n// ========================================\n\nconst BUILD_HISTORY_KEY = 'megabonk_build_history';\nlet eventsInitialized = false;\n\n/**\n * Get the current build from the store (never stale)\n */\nfunction getCurrentBuildFromStore(): Build {\n    return getState('currentBuild');\n}\n\n// Proxy for backwards compatibility - always reads from store\nconst currentBuild: Build = new Proxy({} as Build, {\n    get(_target, prop: keyof Build) {\n        const build = getCurrentBuildFromStore();\n        return build[prop];\n    },\n    set(_target, prop: keyof Build, value: unknown) {\n        const build = { ...getCurrentBuildFromStore() };\n        (build as Record<keyof Build, unknown>)[prop] = value;\n        setState('currentBuild', build);\n        return true;\n    },\n});\n\nfunction updateCurrentBuild(build: Build): void {\n    setState('currentBuild', build);\n}\n\n// ========================================\n// Build History Management\n// ========================================\n\nexport function getBuildHistory(): BuildData[] {\n    try {\n        const history = localStorage.getItem(BUILD_HISTORY_KEY);\n        if (!history) return [];\n\n        const parsed = JSON.parse(history);\n        if (!Array.isArray(parsed)) {\n            logger.warn({\n                operation: 'build.history',\n                error: { name: 'ValidationError', message: 'Build history is not an array' },\n            });\n            return [];\n        }\n\n        return parsed.filter((entry, index) => {\n            if (isValidBuildEntry(entry)) return true;\n            logger.warn({\n                operation: 'build.history',\n                error: { name: 'ValidationError', message: `Skipping corrupted entry at index ${index}` },\n            });\n            return false;\n        }) as BuildData[];\n    } catch (error) {\n        logger.warn({\n            operation: 'build.history',\n            error: { name: (error as Error).name, message: (error as Error).message },\n        });\n        return [];\n    }\n}\n\nexport function saveBuildToHistory(): void {\n    if (!currentBuild.character && !currentBuild.weapon) {\n        ToastManager.warning('Build must have at least a character or weapon');\n        return;\n    }\n\n    try {\n        let history = getBuildHistory();\n        const buildData: BuildData = {\n            name: currentBuild.name || `Build ${new Date().toLocaleString()}`,\n            notes: currentBuild.notes || '',\n            timestamp: Date.now(),\n            character: currentBuild.character?.id,\n            weapon: currentBuild.weapon?.id,\n            tomes: (currentBuild.tomes || []).map((t: Tome) => t.id),\n            items: (currentBuild.items || []).map((i: Item) => i.id),\n        };\n\n        history.unshift(buildData);\n        history = history.slice(0, MAX_BUILD_HISTORY);\n        localStorage.setItem(BUILD_HISTORY_KEY, JSON.stringify(history));\n\n        logger.info({\n            operation: 'build.save',\n            data: {\n                action: 'save_to_history',\n                characterId: currentBuild.character?.id,\n                weaponId: currentBuild.weapon?.id,\n                tomesCount: currentBuild.tomes?.length ?? 0,\n                itemsCount: currentBuild.items?.length ?? 0,\n                historySize: history.length,\n            },\n        });\n\n        ToastManager.success(`Build \"${buildData.name}\" saved to history!`);\n    } catch {\n        ToastManager.error('Failed to save build to history');\n    }\n}\n\nexport function loadBuildFromHistory(index: number): void {\n    try {\n        if (!Number.isFinite(index) || !Number.isInteger(index)) {\n            ToastManager.error('Invalid build index');\n            return;\n        }\n\n        const history = getBuildHistory();\n        if (index < 0 || index >= history.length) {\n            ToastManager.error('Build not found in history');\n            return;\n        }\n\n        const buildData = history[index];\n        if (!buildData) {\n            ToastManager.error('Build not found in history');\n            return;\n        }\n        \n        loadBuildFromData(buildData);\n\n        logger.info({\n            operation: 'build.load',\n            data: {\n                action: 'load_from_history',\n                source: 'history',\n                historyIndex: index,\n                characterId: buildData.character,\n                weaponId: buildData.weapon,\n            },\n        });\n\n        ToastManager.success(`Loaded \"${buildData.name || 'Build'}\" from history`);\n    } catch {\n        ToastManager.error('Failed to load build from history');\n    }\n}\n\nexport function deleteBuildFromHistory(index: number): void {\n    try {\n        if (!Number.isFinite(index) || !Number.isInteger(index)) {\n            ToastManager.error('Invalid build index');\n            return;\n        }\n\n        let history = getBuildHistory();\n        if (index < 0 || index >= history.length) {\n            ToastManager.error('Build not found in history');\n            return;\n        }\n\n        const buildName = history[index]?.name || 'Build';\n        history.splice(index, 1);\n        localStorage.setItem(BUILD_HISTORY_KEY, JSON.stringify(history));\n        ToastManager.success(`Deleted \"${buildName}\" from history`);\n\n        const windowWithModal = window as Window & { showBuildHistoryModal?: () => void };\n        if (typeof windowWithModal.showBuildHistoryModal === 'function') {\n            windowWithModal.showBuildHistoryModal();\n        }\n    } catch {\n        ToastManager.error('Failed to delete build from history');\n    }\n}\n\nexport function clearBuildHistory(): void {\n    try {\n        localStorage.removeItem(BUILD_HISTORY_KEY);\n        ToastManager.success('Build history cleared');\n    } catch {\n        ToastManager.error('Failed to clear build history');\n    }\n}\n\n// ========================================\n// Build Templates\n// ========================================\n\nexport function loadBuildTemplate(templateId: string): void {\n    const template = BUILD_TEMPLATES[templateId];\n    if (!template) {\n        ToastManager.error('Template not found');\n        return;\n    }\n\n    try {\n        currentBuild.name = template.name;\n        currentBuild.notes = template.description;\n        loadBuildFromData(template.build);\n        ToastManager.success(`Loaded template: ${template.name}`);\n    } catch {\n        ToastManager.error('Failed to load template');\n    }\n}\n\n// ========================================\n// Build Import/Export/Load\n// ========================================\n\nexport function loadBuildFromData(buildData: BuildData): void {\n    clearBuild();\n\n    if (buildData.character && allData.characters?.characters) {\n        const charMap = new Map(allData.characters.characters.map((c: Character) => [c.id, c]));\n        const char = charMap.get(buildData.character);\n        if (char) {\n            currentBuild.character = char;\n            setCharacterSelection(char.id);\n        }\n    }\n\n    if (buildData.weapon && allData.weapons?.weapons) {\n        const weaponMap = new Map(allData.weapons.weapons.map((w: Weapon) => [w.id, w]));\n        const weapon = weaponMap.get(buildData.weapon);\n        if (weapon) {\n            currentBuild.weapon = weapon;\n            setWeaponSelection(weapon.id);\n        }\n    }\n\n    if (buildData.tomes && Array.isArray(buildData.tomes) && allData.tomes?.tomes) {\n        setTomeCheckboxes(buildData.tomes);\n    }\n\n    if (buildData.items && Array.isArray(buildData.items) && allData.items?.items) {\n        setItemCheckboxes(buildData.items);\n    }\n\n    if (buildData.name) currentBuild.name = buildData.name;\n    if (buildData.notes) currentBuild.notes = buildData.notes;\n\n    updateBuildAnalysis();\n}\n\nexport function importBuild(jsonString: string): void {\n    try {\n        const buildData = JSON.parse(jsonString) as BuildData;\n        loadBuildFromData(buildData);\n        ToastManager.success('Build imported successfully!');\n    } catch {\n        ToastManager.error('Invalid build data. Please check the format.');\n    }\n}\n\nexport function applyRandomBuild(randomBuild: {\n    character: { id: string } | null;\n    weapon: { id: string } | null;\n    tomes: { id: string }[];\n    items: { id: string }[];\n}): void {\n    const buildData: BuildData = {\n        character: randomBuild.character?.id || '',\n        weapon: randomBuild.weapon?.id || '',\n        tomes: randomBuild.tomes.map(t => t.id),\n        items: randomBuild.items.map(i => i.id),\n        name: 'Random Build',\n        notes: 'Generated by Random Build Generator',\n    };\n\n    loadBuildFromData(buildData);\n    ToastManager.success('Random build applied!');\n}\n\n// ========================================\n// UI Rendering & Events\n// ========================================\n\nexport function renderBuildPlanner(): void {\n    if (!eventsInitialized) {\n        setupBuildPlannerEvents();\n        eventsInitialized = true;\n    }\n    renderUI();\n}\n\nexport function setupBuildPlannerEvents(): void {\n    setupUIEvents(\n        // onCharacterChange\n        (charId: string) => {\n            const charsArray = allData.characters?.characters;\n            currentBuild.character = charsArray ? charsArray.find((c: Character) => c.id === charId) || null : null;\n            updateBuildAnalysis();\n        },\n        // onWeaponChange\n        (weaponId: string) => {\n            const weaponsArray = allData.weapons?.weapons;\n            currentBuild.weapon = weaponsArray ? weaponsArray.find((w: Weapon) => w.id === weaponId) || null : null;\n            updateBuildAnalysis();\n        },\n        // onExport\n        exportBuild,\n        // onShare\n        shareBuildURL,\n        // onClear\n        clearBuild\n    );\n    \n    setupSelectionListeners(updateBuildAnalysis);\n}\n\nexport function updateBuildAnalysis(): void {\n    // Sync checkbox selections to build state\n    const selectedTomes = getSelectedTomeIds();\n    if (allData.tomes?.tomes) {\n        const tomeMap = new Map(allData.tomes.tomes.map((t: Tome) => [t.id, t]));\n        currentBuild.tomes = selectedTomes\n            .map((id: string) => tomeMap.get(id))\n            .filter((t): t is Tome => t !== undefined);\n    } else {\n        currentBuild.tomes = [];\n    }\n\n    const selectedItems = getSelectedItemIds();\n    if (allData.items?.items) {\n        const itemMap = new Map(allData.items.items.map((i: Item) => [i.id, i]));\n        currentBuild.items = selectedItems\n            .map((id: string) => itemMap.get(id))\n            .filter((i): i is Item => i !== undefined);\n    } else {\n        currentBuild.items = [];\n    }\n\n    setState('currentBuild', { ...currentBuild });\n\n    // Update UI display\n    updateBuildDisplay(getCurrentBuildFromStore(), updateBuildURL);\n}\n\n// ========================================\n// Export & Share\n// ========================================\n\nexport function exportBuild(): void {\n    const buildCode = JSON.stringify({\n        character: currentBuild.character?.id,\n        weapon: currentBuild.weapon?.id,\n        tomes: currentBuild.tomes.map((t: Tome) => t.id),\n        items: currentBuild.items.map((i: Item) => i.id),\n    });\n\n    copyToClipboard(buildCode, 'Build code copied to clipboard!');\n}\n\nexport function shareBuildURL(): void {\n    const buildData: URLBuildData = {\n        c: currentBuild.character?.id,\n        w: currentBuild.weapon?.id,\n        t: currentBuild.tomes.map((t: Tome) => t.id),\n        i: currentBuild.items.map((i: Item) => i.id),\n    };\n\n    if (!buildData.c) delete buildData.c;\n    if (!buildData.w) delete buildData.w;\n    if (!buildData.t || buildData.t.length === 0) delete buildData.t;\n    if (!buildData.i || buildData.i.length === 0) delete buildData.i;\n\n    let encoded: string;\n    try {\n        encoded = btoa(JSON.stringify(buildData));\n    } catch (error) {\n        logger.error({\n            operation: 'build.share',\n            error: { name: (error as Error).name, message: (error as Error).message, module: 'build-planner' },\n        });\n        ToastManager.error('Build is too large to share. Try removing some items.');\n        return;\n    }\n\n    const url = `${window.location.origin}${window.location.pathname}#build=${encoded}`;\n\n    logger.info({\n        operation: 'build.share',\n        data: {\n            action: 'share_url',\n            characterId: currentBuild.character?.id,\n            weaponId: currentBuild.weapon?.id,\n            tomesCount: currentBuild.tomes?.length ?? 0,\n            itemsCount: currentBuild.items?.length ?? 0,\n        },\n    });\n\n    copyToClipboard(url, 'Build link copied to clipboard! Share it with friends.');\n}\n\n// ========================================\n// URL Handling\n// ========================================\n\nexport function loadBuildFromURL(): boolean {\n    const hash = window.location.hash;\n    if (!hash || !hash.includes('build=')) return false;\n\n    try {\n        const encoded = hash.split('build=')[1];\n        if (!encoded) {\n            ToastManager.error('Invalid build link');\n            return false;\n        }\n\n        if (!isValidBase64(encoded)) {\n            logger.warn({\n                operation: 'build.load',\n                error: { name: 'ValidationError', message: 'Invalid base64 characters in build URL' },\n            });\n            ToastManager.error('Invalid build link format');\n            return false;\n        }\n\n        if (encoded.length > 10000) {\n            logger.warn({\n                operation: 'build.load',\n                error: { name: 'ValidationError', message: 'Build URL exceeds maximum length' },\n            });\n            ToastManager.error('Build link is too long');\n            return false;\n        }\n\n        let decodedString: string;\n        try {\n            decodedString = atob(encoded);\n        } catch {\n            ToastManager.error('Invalid build link encoding');\n            return false;\n        }\n\n        const decoded = JSON.parse(decodedString);\n        \n        if (!isValidURLBuildData(decoded)) {\n            ToastManager.error('Invalid build data format');\n            return false;\n        }\n\n        // Load character\n        if (decoded.c && allData.characters) {\n            const charMap = new Map(allData.characters.characters.map((c: Character) => [c.id, c]));\n            const char = charMap.get(decoded.c);\n            if (char) {\n                currentBuild.character = char;\n                setCharacterSelection(char.id);\n            }\n        }\n\n        // Load weapon\n        if (decoded.w && allData.weapons) {\n            const weaponMap = new Map(allData.weapons.weapons.map((w: Weapon) => [w.id, w]));\n            const weapon = weaponMap.get(decoded.w);\n            if (weapon) {\n                currentBuild.weapon = weapon;\n                setWeaponSelection(weapon.id);\n            }\n        }\n\n        // Load tomes\n        if (decoded.t && Array.isArray(decoded.t) && allData.tomes?.tomes) {\n            const tomeMap = new Map(allData.tomes.tomes.map((t: Tome) => [t.id, t]));\n            currentBuild.tomes = decoded.t\n                .map((id: string) => tomeMap.get(id))\n                .filter((t): t is Tome => t !== undefined);\n            setTomeCheckboxes(decoded.t);\n        }\n\n        // Load items\n        if (decoded.i && Array.isArray(decoded.i) && allData.items?.items) {\n            const itemMap = new Map(allData.items.items.map((i: Item) => [i.id, i]));\n            currentBuild.items = decoded.i\n                .map((id: string) => itemMap.get(id))\n                .filter((i): i is Item => i !== undefined);\n            setItemCheckboxes(decoded.i);\n        }\n\n        updateBuildAnalysis();\n\n        logger.info({\n            operation: 'build.load',\n            data: {\n                action: 'load_from_url',\n                source: 'url',\n                characterId: currentBuild.character?.id,\n                weaponId: currentBuild.weapon?.id,\n                tomesCount: currentBuild.tomes?.length ?? 0,\n                itemsCount: currentBuild.items?.length ?? 0,\n            },\n        });\n\n        ToastManager.success('Build loaded from URL!');\n        return true;\n    } catch {\n        ToastManager.error('Invalid build link');\n        return false;\n    }\n}\n\nexport function updateBuildURL(): void {\n    if (\n        !currentBuild.character &&\n        !currentBuild.weapon &&\n        (currentBuild.tomes?.length ?? 0) === 0 &&\n        (currentBuild.items?.length ?? 0) === 0\n    ) {\n        if (window.location.hash) {\n            history.replaceState(null, '', window.location.pathname);\n        }\n        return;\n    }\n\n    const buildData: URLBuildData = {\n        c: currentBuild.character?.id,\n        w: currentBuild.weapon?.id,\n        t: currentBuild.tomes.map((t: Tome) => t.id),\n        i: currentBuild.items.map((i: Item) => i.id),\n    };\n\n    if (!buildData.c) delete buildData.c;\n    if (!buildData.w) delete buildData.w;\n    if (!buildData.t || buildData.t.length === 0) delete buildData.t;\n    if (!buildData.i || buildData.i.length === 0) delete buildData.i;\n\n    try {\n        const encoded = btoa(JSON.stringify(buildData));\n        history.replaceState(null, '', `#build=${encoded}`);\n    } catch (error) {\n        logger.debug({\n            operation: 'build.url_update',\n            error: { name: (error as Error).name, message: (error as Error).message },\n        });\n    }\n}\n\n// ========================================\n// Build Operations\n// ========================================\n\nexport function clearBuild(): void {\n    logger.info({\n        operation: 'build.clear',\n        data: {\n            action: 'clear',\n            hadCharacter: currentBuild.character !== null,\n            hadWeapon: currentBuild.weapon !== null,\n            tomesCleared: currentBuild.tomes?.length ?? 0,\n            itemsCleared: currentBuild.items?.length ?? 0,\n        },\n    });\n\n    invalidateBuildStatsCache();\n    updateCurrentBuild({ character: null, weapon: null, tomes: [], items: [] });\n    clearAllSelections();\n    updateBuildAnalysis();\n}\n\nexport function getCurrentBuild(): Build {\n    const build = getState('currentBuild');\n    return {\n        ...build,\n        tomes: [...build.tomes],\n        items: [...build.items],\n    };\n}\n"],"names":["lastBuildCacheKey","cachedBuildStats","invalidateBuildStatsCache","calculateBuildStats","build","useCache","cacheKey","character","id","weapon","tomes","map","t","sort","join","items","i","getBuildCacheKey","stats","DEFAULT_BUILD_STATS","evasion","overcrit","passive","passive_ability","passiveLower","toLowerCase","test","crit_chance","hp","armor","damage","attack_speed","movement_speed","crit_damage","applyCharacterPassives","baseDamage","base_damage","parsedDamage","parseFloat","String","Number","isFinite","forEach","tome","valueStr","value_per_level","match","rawValue","safeRawValue","Math","max","min","value","stat_affected","applyTomeBonus","item","effect","ITEM_EFFECTS","statKey","stat","type","applyItemEffect","clampedEvasionInternal","evasion_internal","round","renderBuildPlanner","charSelect","safeGetElementById","innerHTML","allData","characters","fragment","document","createDocumentFragment","char","option","createElement","textContent","name","tier","appendChild","renderCharacterSelect","weaponSelect","weapons","renderWeaponSelect","tomesSelection","label","escapeHtml","renderTomesSelection","itemsSelection","slice","BUILD_ITEMS_LIMIT","renderItemsSelection","updateBuildDisplay","onBuildUpdate","statsDisplay","toFixed","projectiles","renderStatsDisplay","renderStatsPlaceholder","synergyResult","messages","synergies_weapons","includes","push","itemSynergies","synergies","weaponName","some","syn","length","hasItemWeaponSynergy","found","detectSynergies","synergiesDisplay","s","renderSynergiesDisplay","setCharacterSelection","charId","safeSetValue","setWeaponSelection","weaponId","setTomeCheckboxes","tomeIds","tomeCheckboxes","querySelectorAll","checkboxMap","Map","cb","set","tomeId","checkbox","get","checked","setItemCheckboxes","itemIds","itemCheckboxes","itemId","async","copyToClipboard","text","successMessage","navigator","clipboard","writeText","ToastManager","success","err","error","message","calculateBuildStatsFromModule","getState","BUILD_TEMPLATES","Object","freeze","crit_build","description","tank_build","speed_build","glass_cannon","BUILD_HISTORY_KEY","eventsInitialized","getCurrentBuildFromStore","currentBuild","Proxy","_target","prop","setState","getBuildHistory","history","localStorage","getItem","parsed","JSON","parse","Array","isArray","filter","entry","index","obj","isValidBuildEntry","logger","warn","operation","saveBuildToHistory","buildData","Date","toLocaleString","notes","timestamp","now","unshift","MAX_BUILD_HISTORY","setItem","stringify","info","data","action","characterId","tomesCount","itemsCount","historySize","warning","loadBuildFromHistory","isInteger","loadBuildFromData","source","historyIndex","deleteBuildFromHistory","buildName","splice","windowWithModal","window","showBuildHistoryModal","clearBuildHistory","removeItem","loadBuildTemplate","templateId","template","clearBuild","c","w","updateBuildAnalysis","importBuild","jsonString","applyRandomBuild","randomBuild","setupBuildPlannerEvents","renderUI","onCharacterChange","onWeaponChange","onExport","onShare","onClear","addEventListener","e","target","exportBtn","shareBtn","clearBtn","setupUIEvents","charsArray","find","weaponsArray","exportBuild","shareBuildURL","onSelectionChange","setupSelectionListeners","selectedTomes","from","safeQuerySelectorAll","tomeMap","selectedItems","itemMap","updateBuildURL","encoded","btoa","module","url","location","origin","pathname","loadBuildFromURL","hash","split","isValidBase64","decodedString","atob","decoded","every","isValidURLBuildData","replaceState","debug","hadCharacter","hadWeapon","tomesCleared","itemsCleared","getCurrentBuild"],"mappings":"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"}