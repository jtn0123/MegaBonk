{"version":3,"mappings":"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AAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,KAGrB,CACI6iG,MAAO,EACP7iG,QAAS,CACL,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,KAGrB,CACI6iG,MAAO,EACP7iG,QAAS,CACL,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,KAGrB,CACI6iG,MAAO,EACP7iG,QAAS,CACL,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,KAGrB,CACI6iG,MAAO,EACP7iG,QAAS,CACL,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,KAGrB,CACI6iG,MAAO,EACP7iG,QAAS,CACL,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,EAAG,EAAG,EAAG,EAAG,GACb,CAAC,E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","names":["ToastManager","container","init","this","document","createElement","id","setAttribute","body","appendChild","show","message","type","duration","toast","className","textContent","requestAnimationFrame","classList","add","setTimeout","remove","addEventListener","parentNode","once","info","success","warning","error","reset","$constructor","name","initializer","params","inst","def","_zod","Object","defineProperty","value","constr","_","traits","Set","enumerable","has","proto","prototype","keys","i","length","k","bind","Parent","Definition","_a","deferred","fn","Symbol","hasInstance","$ZodAsyncError","Error","constructor","super","$ZodEncodeError","globalConfig","config","newConfig","getEnumValues","entries","numericValues","values","filter","v","indexOf","map","jsonStringifyReplacer","toString","cached","getter","nullish","input","cleanRegex","source","start","startsWith","end","endsWith","slice","EVALUATING","defineLazy","object","key","get","set","configurable","assignProp","target","prop","writable","mergeDefs","defs","mergedDescriptors","descriptors","getOwnPropertyDescriptors","assign","defineProperties","esc","str","JSON","stringify","captureStackTrace","_args","isObject","data","Array","isArray","allowsEval","navigator","userAgent","includes","Function","isPlainObject","o","ctor","prot","hasOwnProperty","call","shallowClone","propertyKeyTypes","escapeRegex","replace","clone","cl","parent","normalizeParams","_params","NUMBER_FORMAT_RANGES","safeint","Number","MIN_SAFE_INTEGER","MAX_SAFE_INTEGER","int32","uint32","float32","float64","MAX_VALUE","aborted","x","startIndex","issues","continue","prefixIssues","path","iss","unshift","unwrapMessage","finalizeIssue","ctx","full","customError","localeError","reportInput","getLengthableOrigin","issue","args","code","util.jsonStringifyReplacer","$ZodError","$ZodRealError","_parse","_Err","schema","_ctx","async","result","run","Promise","core.$ZodAsyncError","e","Err","util.finalizeIssue","core.config","util.captureStackTrace","callee","_parseAsync","_safeParse","errors.$ZodError","safeParse","errors.$ZodRealError","_safeParseAsync","safeParseAsync","_encode","direction","_decode","_encodeAsync","_decodeAsync","_safeEncode","_safeDecode","_safeEncodeAsync","_safeDecodeAsync","cuid","cuid2","ulid","xid","ksuid","nanoid","guid","uuid","version","RegExp","email","ipv4","ipv6","cidrv4","cidrv6","base64","base64url","e164","dateSource","date","timeSource","hhmm","precision","integer","number","boolean","lowercase","uppercase","$ZodCheck","core.$constructor","onattach","numericOriginMap","bigint","$ZodCheckLessThan","origin","push","bag","curr","inclusive","maximum","exclusiveMaximum","POSITIVE_INFINITY","check","payload","getTime","abort","$ZodCheckGreaterThan","minimum","exclusiveMinimum","NEGATIVE_INFINITY","$ZodCheckMultipleOf","multipleOf","BigInt","val","step","valDecCount","split","stepString","stepDecCount","test","match","parseInt","decCount","toFixed","util.floatSafeRemainder","divisor","$ZodCheckNumberFormat","format","isInt","util.NUMBER_FORMAT_RANGES","pattern","regexes.integer","isInteger","expected","isSafeInteger","note","$ZodCheckMaxLength","when","util.nullish","util.getLengthableOrigin","$ZodCheckMinLength","$ZodCheckLengthEquals","tooBig","exact","$ZodCheckStringFormat","_b","patterns","lastIndex","$ZodCheckRegex","$ZodCheckLowerCase","regexes.lowercase","$ZodCheckUpperCase","regexes.uppercase","$ZodCheckIncludes","escapedRegex","util.escapeRegex","position","$ZodCheckStartsWith","prefix","$ZodCheckEndsWith","suffix","$ZodCheckOverwrite","tx","Doc","content","indent","indented","write","arg","execution","lines","minIndent","Math","min","trimStart","dedented","repeat","line","compile","F","join","major","minor","patch","$ZodType","checks","ch","parse","runChecks","asyncResult","isAborted","util.aborted","currLen","resolve","then","handleCanaryResult","canary","checkResult","skipChecks","util.defineLazy","validate","r","vendor","$ZodString","pop","coerce","String","$ZodStringFormat","checks.$ZodCheckStringFormat","$ZodGUID","regexes.guid","$ZodUUID","v1","v2","v3","v4","v5","v6","v7","v8","regexes.uuid","$ZodEmail","regexes.email","$ZodURL","trimmed","trim","url","URL","hostname","protocol","normalize","href","$ZodEmoji","$ZodNanoID","regexes.nanoid","$ZodCUID","regexes.cuid","$ZodCUID2","regexes.cuid2","$ZodULID","regexes.ulid","$ZodXID","regexes.xid","$ZodKSUID","regexes.ksuid","$ZodISODateTime","time","opts","local","offset","timeRegex","regexes.datetime","$ZodISODate","regexes.date","$ZodISOTime","$ZodISODuration","regexes.duration","$ZodIPv4","regexes.ipv4","$ZodIPv6","regexes.ipv6","$ZodCIDRv4","regexes.cidrv4","$ZodCIDRv6","regexes.cidrv6","parts","address","prefixNum","isValidBase64","atob","$ZodBase64","regexes.base64","contentEncoding","$ZodBase64URL","regexes.base64url","c","padEnd","ceil","isValidBase64URL","$ZodE164","regexes.e164","$ZodJWT","token","algorithm","tokensParts","header","parsedHeader","typ","alg","isValidJWT","$ZodNumber","regexes.number","isNaN","isFinite","received","$ZodNumberFormat","checks.$ZodCheckNumberFormat","$ZodBoolean","regexes.boolean","Boolean","$ZodUnknown","$ZodNever","handleArrayResult","final","index","util.prefixIssues","$ZodArray","proms","item","element","all","handlePropertyResult","isOptionalOut","normalizeDef","shape","okeys","optin","optout","keySet","numKeys","optionalKeys","handleCatchall","unrecognized","_catchall","catchall","t","$ZodObject","desc","getOwnPropertyDescriptor","sh","newSh","_normalized","util.cached","propValues","field","util.isObject","el","$ZodObjectJIT","superParse","fastpass","jit","core.globalConfig","jitless","fastEnabled","util.allowsEval","doc","normalized","parseStr","util.esc","ids","create","counter","generateFastpass","handleUnionResults","results","nonaborted","errors","$ZodUnion","options","some","every","flatMap","option","from","p","util.cleanRegex","single","first","$ZodIntersection","left","right","handleIntersectionResults","mergeValues","a","b","valid","Date","util.isPlainObject","bKeys","sharedKeys","newObj","sharedValue","mergeErrorPath","newArray","unrecKeys","Map","unrecIssue","l","bothKeys","f","merged","$ZodRecord","keyType","recordKeys","valueType","Reflect","ownKeys","keyResult","retryResult","mode","$ZodEnum","util.getEnumValues","valuesSet","util.propertyKeyTypes","$ZodTransform","core.$ZodEncodeError","_out","transform","output","handleOptionalResult","$ZodOptional","innerType","$ZodExactOptional","$ZodNullable","$ZodDefault","defaultValue","handleDefaultResult","$ZodPrefault","$ZodNonOptional","handleNonOptionalResult","$ZodCatch","catchValue","$ZodPipe","in","out","handlePipeResult","next","$ZodReadonly","handleReadonlyResult","freeze","$ZodCustom","checks.$ZodCheck","handleRefineResult","_iss","util.issue","$ZodRegistry","_map","WeakMap","_idmap","_meta","meta","clear","delete","pm","globalThis","__zod_globalRegistry","globalRegistry","_string","Class","util.normalizeParams","_email","_guid","_uuid","_uuidv4","_uuidv6","_uuidv7","_url","_emoji","_nanoid","_cuid","_cuid2","_ulid","_xid","_ksuid","_ipv4","_ipv6","_cidrv4","_cidrv6","_base64","_base64url","_e164","_jwt","_isoDateTime","_isoDate","_isoTime","_isoDuration","_number","_int","_boolean","_unknown","_never","_lt","checks.$ZodCheckLessThan","_lte","_gt","checks.$ZodCheckGreaterThan","_gte","_multipleOf","checks.$ZodCheckMultipleOf","_maxLength","checks.$ZodCheckMaxLength","_minLength","checks.$ZodCheckMinLength","_length","checks.$ZodCheckLengthEquals","_regex","checks.$ZodCheckRegex","_lowercase","checks.$ZodCheckLowerCase","_uppercase","checks.$ZodCheckUpperCase","_includes","checks.$ZodCheckIncludes","_startsWith","checks.$ZodCheckStartsWith","_endsWith","checks.$ZodCheckEndsWith","_overwrite","checks.$ZodCheckOverwrite","_normalize","form","_trim","_toLowerCase","toLowerCase","_toUpperCase","toUpperCase","_slugify","util.slugify","_array","_refine","_superRefine","_check","addIssue","_issue","fatal","initializeContext","processors","metadataRegistry","metadata","unrepresentable","override","io","seen","cycles","reused","external","process","schemaPath","count","cycle","overrideSchema","toJSONSchema","processJSONSchema","_json","processor","ref","isParent","isTransforming","examples","default","_prefault","extractDefs","root","idToSchema","entry","existing","extractToDef","$ref","defId","defsSegment","externalId","registry","uriGenerator","uri","defUriPrefix","makeURI","ext","finalize","flattenRef","zodSchema","_cached","refSeen","refSchema","allOf","parentSeen","jsonSchema","reverse","$schema","$id","$defs","definitions","finalized","createStandardJSONSchemaMethod","_err","_schema","items","rest","libraryOptions","formatMap","datetime","json_string","regex","optionalProcessor","ZodISODateTime","core.$ZodISODateTime","schemas.ZodStringFormat","ZodISODate","core.$ZodISODate","ZodISOTime","core.$ZodISOTime","ZodISODuration","core.$ZodISODuration","mapper","fieldErrors","_errors","processError","core.formatError","flatten","formErrors","sub","core.flattenError","addIssues","isEmpty","ZodError","ZodRealError","parseAsync","encode","decode","encodeAsync","decodeAsync","safeEncode","safeDecode","safeEncodeAsync","safeDecodeAsync","ZodType","core.$ZodType","createToJSONSchemaMethod","util.mergeDefs","with","core.clone","brand","register","reg","parse.parse","parse.safeParse","parse.parseAsync","parse.safeParseAsync","spa","parse.encode","parse.decode","parse.encodeAsync","parse.decodeAsync","parse.safeEncode","parse.safeDecode","parse.safeEncodeAsync","parse.safeDecodeAsync","refine","core._refine","ZodCustom","superRefine","refinement","overwrite","checks.overwrite","optional","exactOptional","ZodExactOptional","nullable","nonoptional","ZodNonOptional","array","or","union","ZodUnion","and","ZodIntersection","pipe","ZodTransform","_default","ZodDefault","util.shallowClone","prefault","ZodPrefault","catch","_catch","ZodCatch","readonly","ZodReadonly","describe","description","core.globalRegistry","isOptional","isNullable","apply","_ZodString","core.$ZodString","json","minLength","maxLength","size","regexes","processors.stringProcessor","checks.regex","checks.includes","checks.startsWith","checks.endsWith","checks.minLength","max","checks.maxLength","checks.length","nonempty","checks.lowercase","checks.uppercase","checks.normalize","slugify","ZodString","core._email","ZodEmail","core._url","ZodURL","jwt","core._jwt","ZodJWT","emoji","core._emoji","ZodEmoji","core._guid","ZodGUID","core._uuid","ZodUUID","uuidv4","core._uuidv4","uuidv6","core._uuidv6","uuidv7","core._uuidv7","core._nanoid","ZodNanoID","core._cuid","ZodCUID","core._cuid2","ZodCUID2","core._ulid","ZodULID","core._base64","ZodBase64","core._base64url","ZodBase64URL","core._xid","ZodXID","core._ksuid","ZodKSUID","core._ipv4","ZodIPv4","core._ipv6","ZodIPv6","core._cidrv4","ZodCIDRv4","core._cidrv6","ZodCIDRv6","core._e164","ZodE164","core._isoDateTime","iso.datetime","core._isoDate","iso.date","core._isoTime","iso.time","core._isoDuration","iso.duration","string","core._string","ZodStringFormat","core.$ZodStringFormat","core.$ZodEmail","core.$ZodGUID","core.$ZodUUID","core.$ZodURL","core.$ZodEmoji","core.$ZodNanoID","core.$ZodCUID","core.$ZodCUID2","core.$ZodULID","core.$ZodXID","core.$ZodKSUID","core.$ZodIPv4","core.$ZodIPv6","core.$ZodCIDRv4","core.$ZodCIDRv6","core.$ZodBase64","core.$ZodBase64URL","core.$ZodE164","core.$ZodJWT","ZodNumber","core.$ZodNumber","processors.numberProcessor","gt","checks.gt","gte","checks.gte","lt","checks.lt","lte","checks.lte","int","safe","positive","nonnegative","negative","nonpositive","checks.multipleOf","finite","minValue","maxValue","core._number","ZodNumberFormat","core.$ZodNumberFormat","core._int","ZodBoolean","core.$ZodBoolean","processors.booleanProcessor","core._boolean","ZodUnknown","core.$ZodUnknown","unknown","ZodNever","core.$ZodNever","not","processors.neverProcessor","ZodArray","core.$ZodArray","minItems","maxItems","processors.arrayProcessor","len","unwrap","core._array","ZodObject","core.$ZodObjectJIT","properties","allKeys","requiredKeys","required","additionalProperties","processors.objectProcessor","keyof","_enum","passthrough","loose","strict","core._never","strip","extend","incoming","existingShape","_shape","util.extend","safeExtend","util.safeExtend","merge","other","util.merge","pick","mask","currDef","newShape","util.pick","omit","util.omit","partial","oldShape","util.partial","ZodOptional","util.required","core.$ZodUnion","isExclusive","oneOf","anyOf","processors.unionProcessor","core.$ZodIntersection","isSimpleIntersection","processors.intersectionProcessor","ZodRecord","core.$ZodRecord","keyBag","valueSchema","patternProperties","propertyNames","keyValues","validKeyValues","processors.recordProcessor","record","ZodEnum","core.$ZodEnum","enum","processors.enumProcessor","extract","newEntries","exclude","fromEntries","core.$ZodTransform","processors.transformProcessor","core.$ZodOptional","processors.optionalProcessor","core.$ZodExactOptional","ZodNullable","core.$ZodNullable","inner","processors.nullableProcessor","core.$ZodDefault","processors.defaultProcessor","removeDefault","core.$ZodPrefault","processors.prefaultProcessor","core.$ZodNonOptional","processors.nonoptionalProcessor","core.$ZodCatch","processors.catchProcessor","removeCatch","ZodPipe","core.$ZodPipe","processors.pipeProcessor","in_","core.$ZodReadonly","readOnly","processors.readonlyProcessor","core.$ZodCustom","processors.customProcessor","Logger","globalContext","correlationStack","remoteBuffer","remoteFlushTimeout","sessionId","generateSessionId","minLevel","isProduction","enableConsole","enableRemote","includeStackTrace","maxContextSize","sampling","errorSampleRate","slowRequestThresholdMs","slowRequestSampleRate","defaultSampleRate","getInstance","instance","configure","getConfig","debug","event","log","warn","setContext","clearContext","getContext","getSessionId","startTimer","_name","performance","now","round","startOperation","correlationId","random","endOperation","splice","getCurrentCorrelationId","withOperation","operation","stopTimer","durationMs","err","stack","level","fullEvent","timestamp","context","buildContext","outputToConsole","remoteEndpoint","sendToRemote","eventContext","online","onLine","window","viewportSize","width","innerWidth","height","innerHeight","levelMethods","console","levelName","color","method","shouldSample","flushRemoteBuffer","batch","fetch","headers","keepalive","logger","z.object","formula","z.string","z.number","cap","ItemSchema","rarity","z.enum","tier","unlocked_by_default","z.boolean","unlock_requirement","unlock_cost_silver","base_effect","scaling_type","stacking_behavior","stacks_well","stack_cap","scaling_per_stack","z.array","detailed_description","synergies","anti_synergies","notes","graph_type","one_and_done","image","WeaponSchema","base_damage","base_projectile_count","attack_pattern","upgradeable_stats","best_for","synergies_items","synergies_tomes","synergies_characters","playstyle","pros","cons","TomeSchema","stat_affected","value_per_level","max_level","priority","recommended_for","synergies_weapons","CharacterSchema","starting_weapon","passive_ability","passive_description","strengths","weaknesses","build_tips","ShrineSchema","icon","activation","reward","reusable","spawn_count","map_icon","strategy","StatsSchema","last_updated","mechanics","z.record","z.unknown","breakpoints","ItemsDataSchema","total_items","WeaponsDataSchema","total_weapons","weapons","TomesDataSchema","total_tomes","tomes","CharactersDataSchema","total_characters","characters","ShrinesDataSchema","total_shrines","shrines","validateData","dataType","errorMessages","module","z.ZodError","zodError","TIER_ORDER","SS","S","A","B","C","RARITY_ORDER","legendary","epic","rare","uncommon","common","ITEM_IDS","GYM_SAUCE","FORBIDDEN_JUICE","OATS","BATTERY","TURBO_SOCKS","BEER","BACKPACK","SLIPPERY_RING","PHANTOM_SHROUD","BEEFY_RING","LEECHING_CRYSTAL","BRASS_KNUCKLES","BOSS_BUSTER","ITEM_EFFECTS","stat","DEFAULT_BUILD_STATS","damage","hp","crit_chance","crit_damage","attack_speed","movement_speed","armor","evasion_internal","projectiles","MAX_COMPARE_ITEMS","BUILD_ITEMS_LIMIT","VALID_TIERS","VALID_RARITIES","MAX_ITEM_COUNT","MAX_FILE_SIZE_BYTES","MAX_BUILD_HISTORY","FEATURES","COMPARE_ITEMS","BUILD_SCANNER","BUILD_ADVISOR","PULL_TO_REFRESH","FAVORITES","VIEW_DETAILS_BUTTON","MODAL_BACKDROP_CLOSE","TAB_SCROLL_INDICATORS","SEARCH_FOCUS_HISTORY","MOBILE_MORE_MENU","OFFLINE_NOTIFICATIONS","validateWithZod","validateItems","validateWeapons","validateTomes","validateCharacters","validateShrines","validateStats","validateTier","entity","validateAllData","allData","warnings","forEach","dataArray","validateDataStructure","validateRarity","dataForType","crossRefResult","itemIds","weaponIds","w","tomeIds","characterIds","synergy","sIndex","synergyWith","character","passiveItemRef","passive_item_ref","weapon","upgradesFrom","upgrades_from","upgradesTo","upgrades_to","validateCrossReferences","tags","tome","isItem","isInputElement","tagName","isSelectElement","safeGetElementById","fallback","getElementById","safeQuerySelector","selector","querySelector","safeQuerySelectorAll","querySelectorAll","safeSetValue","generateResponsiveImage","imagePath","altText","escapeHtml","imageFallbackHandlerAttached","imageLoadHandlerAttached","generateEntityImage","generateModalImage","generateEmptyState","entityType","hasName","obj","hasTier","hasRarity","text","div","innerHTML","generateTierLabel","isValidExternalUrl","parsed","debounce","delay","timeoutId","debouncedFn","clearTimeout","cancel","state","currentTab","filteredData","stats","changelog","currentBuild","compareItems","favorites","subscribers","getState","setState","syncStateKeyToWindow","keySubscribers","callback","subscribe","internalCallback","FAVORITES_KEY","localStorageAvailable","isLocalStorageAvailable","testKey","localStorage","setItem","getItem","removeItem","saveFavorites","toggleFavorite","tabName","itemId","newFavorites","SEARCH_HISTORY_KEY","getSearchHistory","history","showSearchHistoryDropdown","searchInput","onSelect","existingDropdown","dropdown","term","searchBox","parentElement","style","abortController","AbortController","closeDropdown","clearBtn","stopPropagation","clearSearchHistory","signal","historyItems","currentIndex","updateActiveItem","isActive","toggle","focus","getAttribute","preventDefault","selectCurrentItem","contains","FILTER_STATE_KEY","TABS_WITHOUT_FILTERS","getAllFilterStates","states","sessionStorage","saveFilterState","searchInputEl","favoritesOnlyEl","tierFilterEl","sortByEl","search","favoritesOnly","checked","tierFilter","sortBy","rarityFilterEl","stackingFilterEl","rarityFilter","stackingFilter","allStates","fuzzyMatchScore","searchTerm","fieldName","score","matchType","fieldBonus","searchIndex","consecutiveMatches","ALLOWED_FILTER_KEYS","DROPDOWN_ID","focusedIndex","currentResults","isDropdownVisible","isSearchDropdownVisible","hideSearchDropdown","hidden","handleDropdownKeyboard","updateFocusedItem","navigateToResult","selectFocusedItem","switchTab","entityId","itemCard","scrollIntoView","behavior","block","isFocused","updateFilters","filtersContainer","filterData","filterStartTime","originalCount","filtered","searchQuery","criteria","query","filters","trimmedQuery","filterMatch","parseAdvancedSearch","baseEffect","bestMatch","reduce","best","current","_matchContext","sort","itemValue","threshold","parseFloat","substring","numValue","matchesAdvancedFilters","favs","isFavorite","typeFilterEl","typeFilter","shrine","isShrine","patches","categoryFilterEl","categoryFilter","categories","categoryItems","patchesForSort","dateCache","Infinity","dateKey","d","logFilterEvent","standardSortByEl","standardSortBy","aName","bName","localeCompare","aTier","bTier","aRarity","bRarity","sortData","startTime","filteredCount","totalItems","matchedItems","handleSearch","addToSearchHistory","renderGlobalSearchResults","searchFields","dataSources","resultsForType","bestScore","globalSearch","renderTabContent","clearFilters","initChartsAsync","chartInitFn","__vitePreload","import","__VITE_PRELOAD__","NON_DATA_TABS","updateStats","itemCount","display","totalCount","getDataForTab","showingCount","categoryName","label","EMPTY_STATE_CONFIG","getMessage","buttonText","buttonAction","compare","generic","getPopularItems","limit","tierOrder","mapEntityToSuggested","getShortDescription","detectEmptyStateType","favoritesCheckbox","hasActiveFilters","getFavorites","generateEmptyStateWithSuggestions","suggestions","byTier","tiers","tierItems","floor","getCompareableItems","goodItems","getAlternativeItems","getPartialMatchItems","suggestionsHtml","imageHtml","generateSuggestionCard","clearFiltersAndSearch","select","dataset","action","clearSearch","closest","card","openDetailModal","modal","renderWeapons","fragment","createDocumentFragment","tabIndex","tag","generateMetaTags","TYPE_LABELS","createSearchResultCard","tabType","getItemDescription","initAdvisor","applyScannedBuild","initScanBuild","initCV","initOCR","initEnhancedCV","detectItemsWithEnhancedCV","initEnhancedScanBuild","handleEnhancedHybridDetect","compareStrategiesOnImage","registerFunction","callFunction","renderBuildPlanner","initBuildPlannerScan","populateCalculatorItems","calculateBreakpoint","calcBtn","listenerAttached","updateChangelogStats","renderChangelog","renderAbout","updateAboutStats","getCompareItems","stackText","stackClass","graphHtml","html","descHtml","needsExpand","fullText","truncateText","compareCheckboxHtml","renderItems","valueStr","renderTomes","char","renderCharacters","renderShrines","activeTabPanel","grouped","baseTypeOrder","typeOrder","currentTabType","typeResults","isCurrentTab","sectionHeader","sectionContainer","generateItemSkeletonCard","includeGraph","generateCharacterSkeletonCard","generateShrineSkeletonCard","generateWeaponSkeletonCard","showTabSkeletonLoading","containerId","hadContent","generateCard","getSkeletonGenerator","skeletons","fill","hideSkeletonLoading","skeletonContainer","removeAttribute","showTabSkeleton","showSkeletonLoading","includeGraphs","hideTabSkeleton","moduleCache","loadCompareModule","loadChartsModule","TAB_MODULES","calculator","advisor","store","windowWithScanBuild","loadModuleWithCache","loader","loaded","loading","loadingPromise","preloadCommonModules","requestIdleCallback","cb","TAB_STORAGE_KEY","VALID_TABS","lastTabSwitchTime","tabSwitchInProgress","updateTabUI","btn","tabContent","s","isValidFilterState","restoreFilterState","loadAndRenderTab","loaders","loadPromises","moduleCount","loadTabModules","reason","requestedTab","shouldProceedWithTabSwitch","previousTab","destroyAllCharts","cleanupPreviousTab","tabData","fromTab","toTab","updateTabState","STORAGE_KEY","TABS_WITH_RECENT","recentlyViewed","saveRecentlyViewed","onModalOpened","addToRecentlyViewed","initRecentlyViewed","stored","weekAgo","loadRecentlyViewed","isWeapon","isTome","isCharacter","DEFAULT_CONFIG","maxResults","minScore","STAT_KEYWORDS","calculateItemSimilarity","item1","item2","reasons","tierMatch","rarityMatch","effect1","effect2","keyword","shared","sharedKeywords","scaling_formula_type","calculateWeaponSimilarity","weapon1","weapon2","playstyleMatch","sharedBestFor","pattern1","pattern2","calculateTomeSimilarity","tome1","tome2","statMatch","priorityDiff","abs","statCategories","offensive","defensive","utility","category","stat1Lower","stat2Lower","inCategory1","inCategory2","calculateCharacterSimilarity","char1","char2","sharedSynergies","passive1","passive2","renderSimilarItemsSection","similarItems","sourceEntity","candidates","itemsArray","find","weaponsArray","tomesArray","charsArray","candidate","similarity","findSimilarItems","itemName","FORMULA_VARIABLES","renderFraction","numerator","denominator","highlightVariables","placeholders","sortedVariables","variable","escaped","placeholder","renderFormula","num","den","parseFractions","processed","withFractions","finalHtml","renderFormulaDisplay","renderItemModal","showGraph","hasScalingTracks","scaling_tracks","idx","hiddenMechanicsHtml","hidden_mechanics","m","hyperbolicWarning","max_stacks","incrementModalSessionId","initAttempts","initChart","getCurrentModalSessionId","chartModule","getChartModule","getEffectiveStackCap","createScalingChart","trackKeys","firstTrackKey","firstTrack","effectiveCap","chartOptions","scalingFormulaType","hyperbolicConstant","hyperbolic_constant","maxStacks","handleTabClick","tab","trackKey","track","existingHandler","tabHandlers","removeEventListener","setupScalingTabHandlers","secondary_scaling","renderWeaponModal","upgradeableStatsHtml","synergiesHtml","prosConsHtml","renderCharacterModal","base_hp","renderTomeModal","calculateTomeProgression","progression","renderShrineModal","cachedChartModule","modalCloseTimeout","_currentModalSessionId","focusTrapActive","focusableElements","firstFocusableElement","lastFocusableElement","modalObserver","handleModalKeydown","closeModal","shiftKey","activeElement","deactivateFocusTrap","activateFocusTrap","modalTitle","disconnect","MutationObserver","mutations","mutation","removed","removedNodes","Element","modalEl","observe","childList","attributes","attributeFilter","shrinesArray","modalBody","handleActivation","keyEvent","eventAbortController","scrollListenerCleanup","resizeListenerCleanup","lastModalCloseTime","_abortSignalSupported","getAbortSignalSupported","controller","testHandler","testDiv","isAbortSignalSupported","getListenerOptions","getEventAbortSignal","cleanupTabScrollListeners","handleKeydownDelegation","ctrlKey","altKey","metaKey","handleCardClick","handleEmptyStateClick","emptyStates","targetVal","parsedTarget","quickCalc","handleBreakpointCardActivation","handleNumberKeyTabSwitch","tabButtons","nextTab","handleTabArrowNavigation","closeCompareModal","compareModal","handleClickDelegation","handleViewDetailsClick","matchMedia","matches","handleItemCardClick","expandable","isTruncated","truncated","textSpan","indicator","removeId","toggleCompareItem","updateCompareDisplay","handleRemoveCompareClick","toggleChangelogExpand","htmlTarget","handleBreakpointCardClick","nowFavorited","title","handleFavoriteClick","handleSearchResultClick","checkbox","lastToggle","handleCompareCheckboxClick","handleChangeDelegation","updateBuildAnalysis","setupEventDelegation","setupEventListeners","tabContainer","updateTabScrollIndicators","canScrollLeft","scrollLeft","canScrollRight","scrollWidth","clientWidth","scrollRAFPending","throttledScrollHandler","debouncedResizeHandler","passive","setupTabScrollIndicators","setupSearchListeners","closeBtn","closeCompare","handleModalBackdropInteraction","itemModal","modalContent","setupModalListeners","compareBtn","openCompareModal","setupCompareButtonListener","toggleBtn","isExpanded","setupFilterToggle","controls","isMobile","lastScrollY","scrollY","ticking","currentScrollY","scrollDelta","setupStickySearchHideOnScroll","indexStr","dropdownEl","setupDropdownClickHandlers","LAST_SYNC_KEY","OFFLINE_INDICATOR_ID","recordDataSync","getLastSyncTime","updateOfflineIndicator","isOffline","lastSync","diff","seconds","minutes","hours","days","formatRelativeTime","retryBtn","loadAllData","setupOfflineListeners","prepend","createOfflineIndicator","previousState","hideLoading","overlay","getCurrentData","changelogData","fetchWithTimeout","timeout","response","categorized","errorMessage","retriable","categorizeFetchError","enhancedError","fetchWithRetry","maxRetries","initialDelay","lastError","attempt","ok","status","statusText","pow","delayMs","errorType","showLoading","loadStartTime","responses","dataTypes","newData","invalidateBuildStatsCache","validationResult","errorCount","warningCount","loadDuration","filesLoaded","itemCounts","validationResults","versionEl","updatedEl","windowWithSwitchTab","saved","getSavedTab","windowWithLoadBuild","loadBuildFromURL","windowWithAdvisor","mainContent","errorDiv","showErrorMessage","getDataForTabFromData","Proxy","_target","domCache","cache","initialized","invalidate","invalidateAll","refresh","isId","breadcrumbs","getRecentBreadcrumbs","sinceMs","cutoff","recordError","breadcrumb","addBreadcrumb","captureStateSnapshot","filteredDataCount","hasCharacter","hasWeapon","tomesCount","itemsCount","compareItemsCount","windowSize","location","errorBoundaries","registerErrorBoundary","moduleName","fallbackFn","safeModuleInit","initFn","gracefulDegradation","wrappedInit","silent","onError","boundary","retries","stateSnapshot","recentBreadcrumbs","phase","breadcrumbCount","handlerError","hErr","fallbackError","fErr","recoveryAttempted","recoverySucceeded","boundaryError","bErr","withErrorBoundary","degraded","keydownHandler","SHORTCUTS","shortcuts","setupKeyboardShortcuts","categoriesHtml","shortcut","showShortcutsModal","tabs","tabBtn","click","dispatchEvent","Event","bubbles","blur","gridBtn","listBtn","themeBtn","THEMES","DARK","LIGHT","LIGHT_THEME","DARK_THEME","themeManager","currentTheme","getStoredTheme","getSystemTheme","applyTheme","theme","documentElement","themeVars","property","setProperty","toggleTheme","newTheme","setTheme","getTheme","createThemeToggleButton","button","updateButtonContent","n","persisted","timeStamp","delta","rating","getEntriesByType","responseStart","activationStart","prerendering","wasDiscarded","navigationType","h","hadRecentInput","at","PerformanceObserver","supportedEntryTypes","getEntries","buffered","u","visibilityState","firstHiddenTime","onHidden","g","y","E","reportAllChanges","P","T","M","interactionId","interactionCount","L","entryType","capture","PerformanceEventTiming","durationThreshold","takeRecords","N","q","H","O","readyState","metrics","CLS","FCP","LCP","TTFB","INP","logMetric","metric","formattedValue","formatValue","handleMetric","gtag","metric_id","metric_value","metric_delta","metric_rating","sendToAnalytics","initWebVitals","onCLS","onFCP","isTrusted","onLCP","onTTFB","onINP","logSummary","collectedMetrics","goodCount","total","MORE_MENU_TABS","MORE_TAB_NAMES","isMenuOpen","previouslyFocusedElement","updateMenuItems","menu","isCurrent","handleFocusTrap","offsetParent","getFocusableElements","firstElement","lastElement","handleKeyboardNavigation","hideMoreMenu","findIndex","nextIndex","prevIndex","showMoreMenu","createMoreMenu","backdrop","itemsContainer","setupMenuEventListeners","firstItem","updateMobileNavState","navItems","isMoreTab","currentMoreTab","iconSpan","labelSpan","handleNavClick","navItem","TAB_FILTERS","isSheetOpen","renderFilterGroups","opt","updateFilterBadge","HTMLInputElement","HTMLSelectElement","countActiveFilters","badge","hideFilterSheet","sheet","showFilterSheet","createFilterSheet","sheetInput","clearSheetFilters","applyBtn","filterId","mainInput","applyFiltersFromSheet","setupSheetEventListeners","syncFiltersToSheet","firstInput","createMobileFilterButton","initMobileFilters","after","injectMobileFilterButton","getLocalStorage","debugEnabled","debugOptions","showRegionBounds","showSlotGrid","showConfidenceLabels","showDetectionBoxes","showVarianceHeatmap","showDominantColors","regionColors","fontSize","lineWidth","debugLogs","debugStats","totalDetections","successfulMatches","falsePositives","averageConfidence","averageProcessingTime","regionDetectionAccuracy","templateCacheHits","templateCacheMisses","setDebugEnabled","enabled","isDebugEnabled","setDebugOptions","getDebugOptions","shift","getLogs","clearLogs","exportLogs","getStats","resetStats","createProgressIndicator","initialStatus","progressDiv","children","child","update","progress","textEl","fillEl","createEventListenerManager","cleanups","ensureAbortController","handler","addWithSignal","removeAll","cleanup","getSignal","downloadJson","filename","pretty","mimeType","blob","Blob","createObjectURL","download","removeChild","revokeObjectURL","downloadFile","cvDebug","enable","disable","setOptions","getOptions","currentLogFilter","lastOverlayUrl","updateIntervalId","eventManager","initDebugPanel","clearInterval","cleanupDebugPanel","panel","expandBtn","debugModeCheckbox","panelContent","updateLogViewer","toggleExpanded","optionMap","elementId","optionKey","initOverlayOptions","filterSelect","initLogFilter","exportBtn","logsJson","downloadJsonFile","resetBtn","downloadBtn","dataUrl","link","downloadDebugImage","initActionButtons","setInterval","hasPanel","hasExpandBtn","hasCheckbox","hasContent","totalEl","confidenceEl","timeEl","cacheEl","viewer","logs","recentLogs","toLocaleTimeString","hour12","hour","minute","second","formatLogEntry","setLastOverlayUrl","disabled","PULL_THRESHOLD","startY","currentY","isPulling","isRefreshing","isAtTop","updateIndicator","distance","clampedDistance","resetIndicator","handleTouchStart","touch","touches","clientY","handleTouchMove","handleTouchEnd","triggerRefresh","initPullRefresh","maxTouchPoints","createIndicator","cleanupPullRefresh","withTimeout","promise","timeoutMs","operationName","reject","sleep","ms","tesseractModule","activeWorker","workerInitPromise","getOrCreateWorker","Tesseract","getTesseract","worker","createWorker","terminate","terminateOCRWorker","getTag","isString","isNumber","isBoolean","isObjectLike","isDefined","isBlank","hasOwn","KeyStore","_keys","_keyMap","totalWeight","createKey","weight","keyId","toJSON","src","getFn","createKeyPath","createKeyId","MISSING_KEY_PROPERTY","INVALID_KEY_WEIGHT_VALUE","Config","isCaseSensitive","ignoreDiacritics","includeScore","shouldSort","sortFn","includeMatches","findAllMatches","minMatchCharLength","useExtendedSearch","list","arr","deepGet","baseToString","ignoreLocation","ignoreFieldNorm","fieldNormWeight","SPACE","FuseIndex","norm","mantissa","numTokens","isCreated","setIndexRecords","setSources","docs","records","setKeys","_keysMap","docIndex","_addString","_addObject","removeAt","getValueForItemAtKeyId","$","keyIndex","subRecords","nestedArrIndex","subRecord","createIndex","myIndex","computeScore$1","currentLocation","expectedLocation","accuracy","proximity","MAX_BITS","patternAlphabet","patternLen","textLen","currentThreshold","bestLocation","computeMatches","matchMask","lastBitArr","finalScore","binMax","binMin","binMid","finish","bitArr","j","charMatch","charAt","isMatch","indices","matchmask","convertMaskToIndices","createPatternAlphabet","stripDiacritics","BitapSearch","chunks","addChunk","alphabet","remainder","substr","searchIn","allIndices","totalScore","hasMatches","BaseMatch","isMultiMatch","getMatch","multiRegex","isSingleMatch","singleRegex","exp","FuzzyMatch","_bitapSearch","IncludeMatch","searchers","searchersLen","SPACE_RE","MultiMatchSet","ExtendedSearch","queryItem","found","searcher","parseQuery","condition","numMatches","qLen","pLen","registeredSearchers","createSearcher","searcherClass","LogicalOperator","KeyType","isExpression","convertToExplicit","LogicalOperator_AND","auto","isQueryPath","isPath","isLeaf","LOGICAL_SEARCH_INVALID_QUERY_FOR_KEY","node","operator","transformMatches","refIndex","transformScore","Fuse","_keyStore","setCollection","_docs","_myIndex","predicate","getIndex","_searchStringList","_searchObjectList","_searchLogical","EPSILON","computeScore","transformers","transformer","expression","evaluate","_findMatches","res","resultMap","expResults","parseIndex","itemFuse","tomeFuse","characterFuse","weaponFuse","gameData","fuseOptions","itemsIndexed","tomesIndexed","charactersIndexed","weaponsIndexed","detectEntitiesFromText","fuseInstance","segments","subSegments","seg","segTrimmed","splitIntoSegments","detections","seenEntities","bestUnmatchedScore","bestUnmatchedName","segment","confidence","rawText","matchedEntity","segmentsChecked","sampleSegments","autoDetectFromImage","imageDataUrl","progressCallback","lastProgress","progressInterval","recognizePromise","recognize","extractedText","textLength","textPreview","willRetry","backoffMs","extractTextFromImage","detectItemsFromText","detectTomesFromText","detectCharacterFromText","detectWeaponFromText","itemsDetected","tomesDetected","characterDetected","weaponDetected","isOCRWorkerActive","itemTemplates","templatesByColor","templatesLoaded","priorityTemplatesLoaded","standardTemplatesLoading","detectionCache","resizedTemplateCache","maxSize","firstKey","multiScaleTemplates","COMMON_ICON_SIZES","CACHE_TTL","cacheCleanupTimer","getAllData","getItemTemplates","getTemplatesByColor","isTemplatesLoaded","setStandardTemplatesLoading","getDetectionCache","setMultiScaleTemplate","imageData","currentCount","getMultiScaleTemplateCount","evictedItemId","sizes","setTemplatesLoaded","setPriorityTemplatesLoaded","gridPresets","gridPresetsLoaded","loadGridPresets","presetCount","presets","getPresetForResolution","trainingTemplates","trainingDataLoaded","trainingDataLoadingInProgress","trainingIndex","availableSources","enabledSources","sessionTemplates","trainingDataBasePath","isTrainingDataLoaded","getTrainingTemplatesForItem","templates","sessionTpls","combined","sourceImage","getTemplateWeight","validationType","loadTrainingImage","img","Image","resolved","onload","canvas","willReadFrequently","drawImage","getImageData","onerror","ErrorEvent","loadTrainingData","templateCount","indexPath","totalSamples","total_samples","loadedCount","failedCount","itemData","sample","samples","file","source_image","validation_type","resolution","source_resolution","enableAllSources","loadedTemplates","failedTemplates","itemsWithTemplates","sourcesFound","startCacheCleanup","timer","setCacheCleanupTimer","evicted","toEvict","remaining","itemsAvailable","isFullyLoaded","RARITY_BORDER_COLORS","rgb","getColorCandidates","adjacent","red","orange","yellow","green","lime","cyan","blue","purple","magenta","gray","black","white","getAdjacentColors","EMPTY_DETECTION_CONFIG","calculateColorVariance","pixels","sumR","sumG","sumB","meanR","meanG","meanB","varianceSum","diffR","diffG","diffB","calculateEdgeDensity","edgePixels","totalPixels","center","bottom","getDominantColor","detailed","primary","secondary","saturation","brightness","avgR","avgG","avgB","maxChannel","minChannel","lightness","saturationValue","getDetailedColorCategory","matchesRarityColor","hsl","rgbToHsl","hueMatch","satMatch","lumMatch","detectRarityAtPixel","isInventoryBackground","darkLowSatPixels","margin","isEmptyCell","sumSquareR","sumSquareG","sumSquareB","totalVariance","totalSaturation","calculateAverageSaturation","histWidth","bins","binIndex","calculateHistogramWidth","ratio","marginX","marginY","centerSumR","centerSumG","centerSumB","centerSumSqR","centerSumSqG","centerSumSqB","centerCount","edgeSumR","edgeSumG","edgeSumB","edgeSumSqR","edgeSumSqG","edgeSumSqB","edgeCount","centerMeanR","centerMeanG","centerMeanB","edgeMeanR","edgeMeanG","edgeMeanB","calculateCenterEdgeRatio","edgeDensity","detectBorderRarity","borderPixels","borderWidth","topIndex","bottomIndex","leftIndex","rightIndex","Uint8ClampedArray","extractBorderPixels","rarityVotes","bestVotes","votes","countRarityBorderPixels","rarityCount","colorfulCount","rarityCounts","generateMultiScaleVariants","targetSize","resizedCanvas","resizedCtx","imageSmoothingEnabled","imageSmoothingQuality","loadTemplatesBatch","failedIds","pngImg","totalAttempted","failed","groupTemplatesByColor","template","colorCategory","loadItemTemplates","standard","priorityRarities","prioritizeItems","priorityResult","priorityLoaded","priorityFailed","priorityTotal","standardResult","standardLoaded","standardFailed","multiScaleVariants","colorGroups","activeConfig","weights","ssim","ncc","histogram","edge","agreement","minMetricsForBonus","bonusPerMetric","maxBonus","baseThreshold","rarityThresholds","minConfidence","maxConfidence","getThresholdForRarity","base","adjustment","passesThreshold","STRATEGY_PROFILES","low","iconSize","typical","spacing","maxHotbarRows","iconsPerRow","templateScales","nmsThreshold","cellMarginPercent","borderMarginPercent","countTextHeight","countTextPosition","scanStep","batchSize","medium","high","ultra","getResolutionTier","_width","getProfileForResolution","getCountTextRegion","cellX","cellY","cellWidth","cellHeight","profile","textHeight","textWidth","getWorkerPath","workerName","cvDetectionInProgress","setCVDetectionInProgress","getDynamicMinConfidence","tierAdjustment","calculateIoU","box1","box2","x1","y1","x2","y2","intersectionArea","unionArea","nonMaxSuppression","iouThreshold","sorted","kept","detection","shouldKeep","keptDetection","resizeImageData","targetWidth","targetHeight","putImageData","outputCanvas","outputCtx","extractIconRegion","cell","iconWidth","iconHeight","canvasWidth","canvasHeight","safeX","safeY","safeWidth","safeHeight","createImageData","extractCountRegion","countSize","detectHotbarRegion","scanStartY","scanEndY","sampleStartX","sampleWidth","strips","variance","rarityRatio","colorfulRatio","bestBandStart","bestBandEnd","windowSlice","avgRarityRatio","avgColorful","avgVariance","firstStrip","lastStrip","yPosition","maxBandHeight","minBandHeight","topY","bottomY","detectIconEdges","bandRegion","bandHeight","scanStartX","scanEndX","scanYOffsets","edgeCounts","yOffset","scanY","inBorder","borderStart","localX","bucket","consistentEdges","edges","gaps","previous","gap","fromIdx","toIdx","gapCounts","tolerance","modeGap","modeCount","consistentIndices","filterByConsistentSpacing","calculateAccuracyMetrics","detected","groundTruth","detectedNames","truthNames","truePositives","falseNegatives","recall","detectResolution","detectUILayout","aspectRatio","groupBy","keyFn","groups","getAdaptiveIconSizes","steam_deck","detectGridPositions","_gridSize","adaptiveGridSize","positions","hotbarY","findMode","stdDev","buckets","maxCount","modeValues","vals","mean","sum","sqrt","calculateAdaptiveTolerance","spacings","expectedIconSize","baseStdDev","baseTolerance","adaptiveTolerance","minTolerance","maxTolerance","verifyGridPattern","isValid","filteredDetections","gridParams","rows","yTolerance","currentRow","clusterByY","allXSpacings","row","sortedRow","ySpacings","rowCenters","xMode","yMode","xSpacing","ySpacing","xTolerance","firstInRow","isConsistentSpacing","isMultipleSpacing","fitRatio","maxOutliers","adaptiveXTolerance","preprocessImage","factor","midpoint","enhanceContrast","minR","maxR","minG","maxG","minB","maxB","rangeR","rangeG","rangeB","normalizeColors","calculateWindowedSSIM","img1","img2","C1","C2","gray1","Float32Array","gray2","totalSSIM","windowCount","wy","wx","mean1","mean2","windowPixels","dy","dx","var1","var2","covar","d1","d2","data1","data2","g1","g2","calculateSSIM","calculateCombinedSimilarity","imageData1","imageData2","processed1","processed2","pixels1","pixels2","sum1","sum2","sumProduct","sumSquare1","sumSquare2","product","calculateNCC","binSize","hist1","hist2","count1","count2","intersection","calculateHistogramSimilarity","w1","h1","w2","h2","getGray","getEdge","gx","gy","sumSq1","sumSq2","e1","e2","correlation","calculateEdgeSimilarity","scores","aboveThreshold","calculateWeightedScore","testUtils","calculateF1Score","generateTestReport","report","toISOString","avgAccuracy","avgPrecision","avgRecall","avgProcessingTime","processingTime","byResolution","resResults","resAvgAccuracy","byLayout","uiLayout","layout","layoutResults","layoutAvgAccuracy","byMode","detectionMode","modeResults","modeAvgAccuracy","imageName","runAutomatedTest","detectionFn","itemMetrics","detectedItems","confidenceScores","expectedItems","compareDetectionResults","result1","result2","items1","items2","set1","set2","onlyIn1","onlyIn2","inBoth","performanceData","rankingCache","skipList","successRateWeight","confidenceWeight","timeDecay","lastCacheUpdate","getTemplateRanking","templateId","perf","ranking","calculateRanking","updateCacheIfNeeded","shouldSkipTemplate","successRate","usageCount","successCount","daysSinceUpdate","lastUpdated","decayFactor","rankScore","avgConfidence","shouldSkip","optimalThreshold","minVotes","minConsensus","usePerformanceWeighting","performanceWeight","confusionPenalty","calculateFinalConfidence","aggregate","itemVotes","mid","weightSum","rankWeight","weightedConfidence","combineVotes","effectiveConfig","aggregates","vote","templateWeight","weightedScore","voteCount","agg","aggregateVotes","winner","maxScore","totalVotes","consensus","votingBreakdown","calculateSimilarity","calculateEnhancedSimilarity","matchTemplate","screenshotCtx","skipRankingCheck","shouldUseTemplate","iconRegion","resizedTemplate","hasMultiScaleTemplates","closestSize","minDiff","findClosestTemplateSize","getMultiScaleTemplate","resized","getResizedTemplate","setResizedTemplate","matchTemplateMulti","primaryScore","trainingTpl","resizedTraining","rawScore","votingResult","findBestTemplateMatch","useMultiTemplate","loadImageToCanvas","cacheResults","imageHash","CVMetricsCollector","runs","currentRun","colorFilterStats","attempts","exactMatches","mixedFallbacks","candidateCounts","setEnabled","isEnabled","startRun","imageWidth","imageHeight","totalTimeMs","gridDetectionTimeMs","templateMatchingTimeMs","validationTimeMs","twoPhaseAttempted","twoPhaseSucceeded","twoPhaseFailureReason","gridConfidence","gridCellsGenerated","gridVerificationInput","gridVerificationOutput","gridVerificationRejected","colorFilterAttempts","colorExactMatches","colorMixedFallbacks","avgCandidatesAfterColorFilter","highConfidenceDetections","mediumConfidenceDetections","lowConfidenceDetections","confidenceHistogram","rarityValidationMatches","rarityValidationMismatches","rarityValidationRejections","detectionsByRarity","recordTwoPhaseAttempt","succeeded","failureReason","gridCells","recordGridDetectionTime","timeMs","recordTemplateMatchingTime","recordValidationTime","recordGridVerification","inputCount","outputCount","recordColorFilter","usedExactMatch","usedMixed","candidateCount","recordDetection","recordRarityValidation","matched","rejected","endRun","getRuns","getAggregatedMetrics","runCount","twoPhaseAttempts","twoPhaseSuccesses","twoPhaseSuccessRate","gridConfidences","avgGridConfidence","retentionRates","avgGridRetentionRate","colorRuns","avgColorExactMatchRate","avgColorMixedFallbackRate","avgCandidatesAfterFilter","avgDetectionsPerRun","avgHighConfidenceRate","avgTotalTimeMs","avgGridDetectionTimeMs","avgTemplateMatchingTimeMs","byDifficulty","exportJSON","aggregated","getMetricsCollector","detectIconsWithTwoPhase","gridStartTime","hotbarRegion","grid","spacingCounts","modeSpacing","startX","columns","lastEdgeX","edgeX","expectedEdges","actualConsistentEdges","inferGridFromEdges","hotbarConfidence","edgesFound","gridDetected","gridUsed","maxCells","cells","col","generateGridROIs","cellSize","cellData","cellColor","colorsToCheck","candidateItems","seenIds","colorItems","itemsToCheck","usedAdjacent","templateMatchingTime","cellsScanned","detectIconsWithSlidingWindow","dynamicThreshold","stepSize","regionOfInterest","multiScale","iconSizes","sizesToUse","primarySize","scanX","scanWidth","scanHeight","totalSteps","currentStep","scanRegion","windowData","scaleSize","scaleROI","scale","rawDetections","scannedPositions","nmsDetections","beforeNMS","afterNMS","STRATEGIES","preprocessing","contrastEnhance","contrastFactor","colorNormalize","edgeEnhance","useRanking","skipPoorPerformers","maxTemplatesPerItem","metricWeights","fast","strategies","minAgreement","combineMethod","earlyExitThreshold","parallel","getStrategy","selectStrategiesForImage","sceneType","CONFIG","findUncertainDetections","uncertain","alternatives","findAlternatives","cropDataUrl","detectedItemId","calculateSimilarityScore","detectedName","detectedItemName","detectedWords","itemWords","DIGIT_PATTERNS","digit","matchPattern","binary","patternHeight","patternWidth","srcHeight","srcWidth","srcY","srcX","resizeBinary","extractBinaryRegion","recognizeDigit","hasXPrefix","diagonalCount","midY","midX","detectCount","screenHeight","region","clampedRegion","regionData","srcIdx","dstIdx","extractRegion","isWhite","isYellow","isLight","findBrightTextPixels","components","visited","minX","maxX","minY","maxY","queue","visitedRow","coord","neighbors","nx","ny","compWidth","compHeight","findComponents","digits","totalConfidence","hasX","comp","compBinary","hasCountOverlay","brightCount","detectItemsWithCV","useWorkers","runStartTime","hash1","hash2","sampleCount","charCodeAt","hashImageDataUrl","cachedResults","getCachedResults","resultCount","selectedStrategies","resolutionTier","gridPositions","workers","workerResults","Worker","templateData","batches","batchPromises","batchIndex","batchId","postMessage","flat","detectItemsWithWorkers","detectionsCount","twoPhaseResult","hotbarDetections","gridColumns","gridRows","detectedHotbar","hotbarROI","usingROI","equipmentDetections","equipmentROI","detectEquipmentRegion","allDetections","gridVerification","verifiedDetections","boostedDetections","boost","detectedItemNames","itemSynergies","wrench","battery","medkit","newConfidence","validationStartTime","validated","strictMode","pos","detectedRarity","expectedRarity","validateWithBorderRarity","cellW","cellH","countResult","stackCount","countConfidence","logData","debugHint","suggestion","feedbackDetections","uncertainDetections","shouldPromptForLearning","uncertainCount","topUncertain","detectScreenType","hotbarHeight","totalBrightness","avgBrightness","isGameplay","screenType","setupUpdateNotification","serviceWorker","ready","registration","updateNotificationShown","newWorker","installing","handleStateChange","notification","reloadBtn","handleReload","waiting","handleControllerChange","reload","dismissBtn","showUpdateNotification","detectItemCounts","counts","srcCanvas","countROI","countCanvas","countMatch","toDataURL","detectIconScale","hotbar","matchingSpacings","detectedSize","fitsGrid","gridStart","runEnsembleDetection","_items","_progressCallback","strategyDetections","strategyId","byItem","det","winnerItemId","winnerConfidence","winnerDetections","dets","maxConf","avgConf","weightedSum","weightedConf","bestDet","bestStrategy","strategyResults","combineStrategyDetections","getCVMetrics","collector","getDetectionConfig","scoringConfig","extractDominantColors","numColors","colorMap","freq","frequency","detectUIRegions","ctxOrWidth","widthOrHeight","actualHeight","hasContext","pauseMenu","inventory","detectPauseMenuRegions","gameplay","detectGameplayRegions","clearDetectionCache","cleared","initStartTime","lineno","colno","column","critical","HTMLImageElement","complete","naturalHeight","blurUp","addedNodes","HTMLElement","subtree","setupBlurUpHandler","loadFavorites","cssText","opacity","mobileNav","moreBtn","newTab","initMobileNav","initDuration","modulesLoaded"],"ignoreList":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,62,72],"sources":["../../src/modules/toast.ts","../../node_modules/zod/v4/core/core.js","../../node_modules/zod/v4/core/util.js","../../node_modules/zod/v4/core/errors.js","../../node_modules/zod/v4/core/parse.js","../../node_modules/zod/v4/core/regexes.js","../../node_modules/zod/v4/core/checks.js","../../node_modules/zod/v4/core/doc.js","../../node_modules/zod/v4/core/versions.js","../../node_modules/zod/v4/core/schemas.js","../../node_modules/zod/v4/core/registries.js","../../node_modules/zod/v4/core/api.js","../../node_modules/zod/v4/core/to-json-schema.js","../../node_modules/zod/v4/core/json-schema-processors.js","../../node_modules/zod/v4/classic/iso.js","../../node_modules/zod/v4/classic/errors.js","../../node_modules/zod/v4/classic/parse.js","../../node_modules/zod/v4/classic/schemas.js","../../src/modules/logger-core.ts","../../src/modules/schema-validator.ts","../../src/modules/constants.ts","../../src/modules/data-validation.ts","../../src/types/index.ts","../../src/modules/utils.ts","../../src/modules/store.ts","../../src/modules/favorites.ts","../../src/modules/search-history.ts","../../src/modules/filter-state.ts","../../src/modules/fuzzy-match.ts","../../src/modules/search-dropdown.ts","../../src/modules/filters.ts","../../src/modules/global-search.ts","../../src/modules/renderers/common.ts","../../src/modules/empty-states.ts","../../src/modules/renderers/weapons.ts","../../src/modules/renderers/global-search.ts","../../src/modules/registry.ts","../../src/modules/renderers/tab-content.ts","../../src/modules/renderers/items.ts","../../src/modules/renderers/tomes.ts","../../src/modules/renderers/characters.ts","../../src/modules/renderers/shrines.ts","../../src/modules/skeleton-loader.ts","../../src/modules/tab-loader.ts","../../src/modules/events-tabs.ts","../../src/modules/recently-viewed.ts","../../src/modules/similar-items.ts","../../src/modules/formula-renderer.ts","../../src/modules/modal-items.ts","../../src/modules/modal-weapons.ts","../../src/modules/modal-characters.ts","../../src/modules/modal-entities.ts","../../src/modules/modal-core.ts","../../src/modules/events-core.ts","../../src/modules/events-search.ts","../../src/modules/offline-ui.ts","../../src/modules/data-service.ts","../../src/modules/dom-cache.ts","../../src/modules/breadcrumbs.ts","../../src/modules/error-boundary.ts","../../src/modules/keyboard-shortcuts.ts","../../src/modules/theme-manager.ts","../../node_modules/web-vitals/dist/web-vitals.js","../../src/modules/web-vitals.ts","../../src/modules/mobile-nav.ts","../../src/modules/mobile-filters.ts","../../src/modules/image-recognition-debug.ts","../../src/modules/dom-utils.ts","../../src/modules/debug-ui.ts","../../src/modules/pull-refresh.ts","../../src/modules/ocr/utils.ts","../../src/modules/ocr/worker.ts","../../node_modules/fuse.js/dist/fuse.mjs","../../src/modules/ocr/detection.ts","../../src/modules/ocr/extraction.ts","../../src/modules/ocr/index.ts","../../src/modules/cv/state.ts","../../src/modules/cv/training.ts","../../src/modules/cv/core.ts","../../src/modules/cv/color-utils.ts","../../src/modules/cv/color-extraction.ts","../../src/modules/cv/color-matching.ts","../../src/modules/cv/templates.ts","../../src/modules/cv/scoring-config.ts","../../src/modules/cv/resolution-profiles.ts","../../src/modules/cv/detection-config.ts","../../src/modules/cv/detection-utils.ts","../../src/modules/cv/grid/hotbar-detection.ts","../../src/modules/cv/grid/edge-detection.ts","../../src/modules/test-utils.ts","../../src/modules/cv/grid/scale-detection.ts","../../src/modules/cv/grid/grid-verification.ts","../../src/modules/cv/similarity.ts","../../src/modules/cv/template-ranking.ts","../../src/modules/cv/voting.ts","../../src/modules/cv/detection-matching.ts","../../src/modules/cv/detection-processing.ts","../../src/modules/cv/metrics.ts","../../src/modules/cv/detection-pipeline/two-phase.ts","../../src/modules/cv/grid/grid-inference.ts","../../src/modules/cv/detection-pipeline/sliding-window.ts","../../src/modules/cv/ensemble-detector.ts","../../src/modules/cv/active-learning.ts","../../src/modules/cv/count-detection.ts","../../src/modules/cv/detection-pipeline/orchestrator.ts","../../src/modules/cv/detection-pipeline/worker-detection.ts","../../src/modules/cv/regions.ts","../../src/script.ts","../../src/modules/computer-vision.ts","../../src/modules/cv/detection-pipeline/ocr-count.ts","../../src/modules/cv/detection-pipeline/ensemble-detection.ts","../../src/modules/cv/detection-pipeline/metrics-exports.ts"],"sourcesContent":["// ========================================\n// MegaBonk Toast Notification Module\n// ========================================\n\n/**\n * Toast type\n */\ntype ToastType = 'info' | 'success' | 'warning' | 'error';\n\n/**\n * Toast notification manager for user feedback\n * Replaces browser alert() with modern, styled notifications\n */\nexport const ToastManager = {\n    container: null as HTMLElement | null,\n\n    /**\n     * Initialize the toast container\n     */\n    init(): void {\n        if (this.container) return;\n\n        this.container = document.createElement('div');\n        this.container.id = 'toast-container';\n        this.container.setAttribute('role', 'status');\n        this.container.setAttribute('aria-live', 'polite');\n        this.container.setAttribute('aria-atomic', 'true');\n        document.body.appendChild(this.container);\n    },\n\n    /**\n     * Show a toast notification\n     * @param message - Message to display\n     * @param type - Toast type: 'info', 'success', 'warning', 'error'\n     * @param duration - Duration in ms (default 3000)\n     * @returns The toast element (for testing purposes)\n     */\n    show(message: string, type: ToastType = 'info', duration: number = 3000): HTMLElement {\n        this.init();\n\n        const toast = document.createElement('div');\n        toast.className = `toast toast-${type}`;\n        toast.textContent = message;\n        toast.setAttribute('role', 'alert');\n\n        this.container!.appendChild(toast);\n\n        // Trigger entrance animation\n        requestAnimationFrame(() => {\n            toast.classList.add('toast-visible');\n        });\n\n        // Auto-dismiss\n        setTimeout(() => {\n            toast.classList.remove('toast-visible');\n\n            // Use { once: true } to prevent memory leak\n            toast.addEventListener(\n                'transitionend',\n                () => {\n                    if (toast.parentNode) {\n                        toast.remove();\n                    }\n                },\n                { once: true }\n            );\n\n            // Fallback timeout to ensure removal even if transition doesn't fire\n            setTimeout(() => {\n                if (toast.parentNode) {\n                    toast.remove();\n                }\n            }, 500); // Max transition duration\n        }, duration);\n\n        return toast;\n    },\n\n    /**\n     * Show info toast\n     * @param message - Message to display\n     * @returns The toast element\n     */\n    info(message: string): HTMLElement {\n        return this.show(message, 'info');\n    },\n\n    /**\n     * Show success toast\n     * @param message - Message to display\n     * @returns The toast element\n     */\n    success(message: string): HTMLElement {\n        return this.show(message, 'success');\n    },\n\n    /**\n     * Show warning toast\n     * @param message - Message to display\n     * @returns The toast element\n     */\n    warning(message: string): HTMLElement {\n        return this.show(message, 'warning');\n    },\n\n    /**\n     * Show error toast\n     * @param message - Message to display\n     * @returns The toast element\n     */\n    error(message: string): HTMLElement {\n        return this.show(message, 'error');\n    },\n\n    /**\n     * Reset the toast manager (for testing)\n     * Removes the container and resets state\n     */\n    reset(): void {\n        if (this.container) {\n            this.container.remove();\n            this.container = null;\n        }\n    },\n};\n","/** A special constant with type `never` */\nexport const NEVER = Object.freeze({\n    status: \"aborted\",\n});\nexport /*@__NO_SIDE_EFFECTS__*/ function $constructor(name, initializer, params) {\n    function init(inst, def) {\n        if (!inst._zod) {\n            Object.defineProperty(inst, \"_zod\", {\n                value: {\n                    def,\n                    constr: _,\n                    traits: new Set(),\n                },\n                enumerable: false,\n            });\n        }\n        if (inst._zod.traits.has(name)) {\n            return;\n        }\n        inst._zod.traits.add(name);\n        initializer(inst, def);\n        // support prototype modifications\n        const proto = _.prototype;\n        const keys = Object.keys(proto);\n        for (let i = 0; i < keys.length; i++) {\n            const k = keys[i];\n            if (!(k in inst)) {\n                inst[k] = proto[k].bind(inst);\n            }\n        }\n    }\n    // doesn't work if Parent has a constructor with arguments\n    const Parent = params?.Parent ?? Object;\n    class Definition extends Parent {\n    }\n    Object.defineProperty(Definition, \"name\", { value: name });\n    function _(def) {\n        var _a;\n        const inst = params?.Parent ? new Definition() : this;\n        init(inst, def);\n        (_a = inst._zod).deferred ?? (_a.deferred = []);\n        for (const fn of inst._zod.deferred) {\n            fn();\n        }\n        return inst;\n    }\n    Object.defineProperty(_, \"init\", { value: init });\n    Object.defineProperty(_, Symbol.hasInstance, {\n        value: (inst) => {\n            if (params?.Parent && inst instanceof params.Parent)\n                return true;\n            return inst?._zod?.traits?.has(name);\n        },\n    });\n    Object.defineProperty(_, \"name\", { value: name });\n    return _;\n}\n//////////////////////////////   UTILITIES   ///////////////////////////////////////\nexport const $brand = Symbol(\"zod_brand\");\nexport class $ZodAsyncError extends Error {\n    constructor() {\n        super(`Encountered Promise during synchronous parse. Use .parseAsync() instead.`);\n    }\n}\nexport class $ZodEncodeError extends Error {\n    constructor(name) {\n        super(`Encountered unidirectional transform during encode: ${name}`);\n        this.name = \"ZodEncodeError\";\n    }\n}\nexport const globalConfig = {};\nexport function config(newConfig) {\n    if (newConfig)\n        Object.assign(globalConfig, newConfig);\n    return globalConfig;\n}\n","// functions\nexport function assertEqual(val) {\n    return val;\n}\nexport function assertNotEqual(val) {\n    return val;\n}\nexport function assertIs(_arg) { }\nexport function assertNever(_x) {\n    throw new Error(\"Unexpected value in exhaustive check\");\n}\nexport function assert(_) { }\nexport function getEnumValues(entries) {\n    const numericValues = Object.values(entries).filter((v) => typeof v === \"number\");\n    const values = Object.entries(entries)\n        .filter(([k, _]) => numericValues.indexOf(+k) === -1)\n        .map(([_, v]) => v);\n    return values;\n}\nexport function joinValues(array, separator = \"|\") {\n    return array.map((val) => stringifyPrimitive(val)).join(separator);\n}\nexport function jsonStringifyReplacer(_, value) {\n    if (typeof value === \"bigint\")\n        return value.toString();\n    return value;\n}\nexport function cached(getter) {\n    const set = false;\n    return {\n        get value() {\n            if (!set) {\n                const value = getter();\n                Object.defineProperty(this, \"value\", { value });\n                return value;\n            }\n            throw new Error(\"cached value already set\");\n        },\n    };\n}\nexport function nullish(input) {\n    return input === null || input === undefined;\n}\nexport function cleanRegex(source) {\n    const start = source.startsWith(\"^\") ? 1 : 0;\n    const end = source.endsWith(\"$\") ? source.length - 1 : source.length;\n    return source.slice(start, end);\n}\nexport function floatSafeRemainder(val, step) {\n    const valDecCount = (val.toString().split(\".\")[1] || \"\").length;\n    const stepString = step.toString();\n    let stepDecCount = (stepString.split(\".\")[1] || \"\").length;\n    if (stepDecCount === 0 && /\\d?e-\\d?/.test(stepString)) {\n        const match = stepString.match(/\\d?e-(\\d?)/);\n        if (match?.[1]) {\n            stepDecCount = Number.parseInt(match[1]);\n        }\n    }\n    const decCount = valDecCount > stepDecCount ? valDecCount : stepDecCount;\n    const valInt = Number.parseInt(val.toFixed(decCount).replace(\".\", \"\"));\n    const stepInt = Number.parseInt(step.toFixed(decCount).replace(\".\", \"\"));\n    return (valInt % stepInt) / 10 ** decCount;\n}\nconst EVALUATING = Symbol(\"evaluating\");\nexport function defineLazy(object, key, getter) {\n    let value = undefined;\n    Object.defineProperty(object, key, {\n        get() {\n            if (value === EVALUATING) {\n                // Circular reference detected, return undefined to break the cycle\n                return undefined;\n            }\n            if (value === undefined) {\n                value = EVALUATING;\n                value = getter();\n            }\n            return value;\n        },\n        set(v) {\n            Object.defineProperty(object, key, {\n                value: v,\n                // configurable: true,\n            });\n            // object[key] = v;\n        },\n        configurable: true,\n    });\n}\nexport function objectClone(obj) {\n    return Object.create(Object.getPrototypeOf(obj), Object.getOwnPropertyDescriptors(obj));\n}\nexport function assignProp(target, prop, value) {\n    Object.defineProperty(target, prop, {\n        value,\n        writable: true,\n        enumerable: true,\n        configurable: true,\n    });\n}\nexport function mergeDefs(...defs) {\n    const mergedDescriptors = {};\n    for (const def of defs) {\n        const descriptors = Object.getOwnPropertyDescriptors(def);\n        Object.assign(mergedDescriptors, descriptors);\n    }\n    return Object.defineProperties({}, mergedDescriptors);\n}\nexport function cloneDef(schema) {\n    return mergeDefs(schema._zod.def);\n}\nexport function getElementAtPath(obj, path) {\n    if (!path)\n        return obj;\n    return path.reduce((acc, key) => acc?.[key], obj);\n}\nexport function promiseAllObject(promisesObj) {\n    const keys = Object.keys(promisesObj);\n    const promises = keys.map((key) => promisesObj[key]);\n    return Promise.all(promises).then((results) => {\n        const resolvedObj = {};\n        for (let i = 0; i < keys.length; i++) {\n            resolvedObj[keys[i]] = results[i];\n        }\n        return resolvedObj;\n    });\n}\nexport function randomString(length = 10) {\n    const chars = \"abcdefghijklmnopqrstuvwxyz\";\n    let str = \"\";\n    for (let i = 0; i < length; i++) {\n        str += chars[Math.floor(Math.random() * chars.length)];\n    }\n    return str;\n}\nexport function esc(str) {\n    return JSON.stringify(str);\n}\nexport function slugify(input) {\n    return input\n        .toLowerCase()\n        .trim()\n        .replace(/[^\\w\\s-]/g, \"\")\n        .replace(/[\\s_-]+/g, \"-\")\n        .replace(/^-+|-+$/g, \"\");\n}\nexport const captureStackTrace = (\"captureStackTrace\" in Error ? Error.captureStackTrace : (..._args) => { });\nexport function isObject(data) {\n    return typeof data === \"object\" && data !== null && !Array.isArray(data);\n}\nexport const allowsEval = cached(() => {\n    // @ts-ignore\n    if (typeof navigator !== \"undefined\" && navigator?.userAgent?.includes(\"Cloudflare\")) {\n        return false;\n    }\n    try {\n        const F = Function;\n        new F(\"\");\n        return true;\n    }\n    catch (_) {\n        return false;\n    }\n});\nexport function isPlainObject(o) {\n    if (isObject(o) === false)\n        return false;\n    // modified constructor\n    const ctor = o.constructor;\n    if (ctor === undefined)\n        return true;\n    if (typeof ctor !== \"function\")\n        return true;\n    // modified prototype\n    const prot = ctor.prototype;\n    if (isObject(prot) === false)\n        return false;\n    // ctor doesn't have static `isPrototypeOf`\n    if (Object.prototype.hasOwnProperty.call(prot, \"isPrototypeOf\") === false) {\n        return false;\n    }\n    return true;\n}\nexport function shallowClone(o) {\n    if (isPlainObject(o))\n        return { ...o };\n    if (Array.isArray(o))\n        return [...o];\n    return o;\n}\nexport function numKeys(data) {\n    let keyCount = 0;\n    for (const key in data) {\n        if (Object.prototype.hasOwnProperty.call(data, key)) {\n            keyCount++;\n        }\n    }\n    return keyCount;\n}\nexport const getParsedType = (data) => {\n    const t = typeof data;\n    switch (t) {\n        case \"undefined\":\n            return \"undefined\";\n        case \"string\":\n            return \"string\";\n        case \"number\":\n            return Number.isNaN(data) ? \"nan\" : \"number\";\n        case \"boolean\":\n            return \"boolean\";\n        case \"function\":\n            return \"function\";\n        case \"bigint\":\n            return \"bigint\";\n        case \"symbol\":\n            return \"symbol\";\n        case \"object\":\n            if (Array.isArray(data)) {\n                return \"array\";\n            }\n            if (data === null) {\n                return \"null\";\n            }\n            if (data.then && typeof data.then === \"function\" && data.catch && typeof data.catch === \"function\") {\n                return \"promise\";\n            }\n            if (typeof Map !== \"undefined\" && data instanceof Map) {\n                return \"map\";\n            }\n            if (typeof Set !== \"undefined\" && data instanceof Set) {\n                return \"set\";\n            }\n            if (typeof Date !== \"undefined\" && data instanceof Date) {\n                return \"date\";\n            }\n            // @ts-ignore\n            if (typeof File !== \"undefined\" && data instanceof File) {\n                return \"file\";\n            }\n            return \"object\";\n        default:\n            throw new Error(`Unknown data type: ${t}`);\n    }\n};\nexport const propertyKeyTypes = new Set([\"string\", \"number\", \"symbol\"]);\nexport const primitiveTypes = new Set([\"string\", \"number\", \"bigint\", \"boolean\", \"symbol\", \"undefined\"]);\nexport function escapeRegex(str) {\n    return str.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n}\n// zod-specific utils\nexport function clone(inst, def, params) {\n    const cl = new inst._zod.constr(def ?? inst._zod.def);\n    if (!def || params?.parent)\n        cl._zod.parent = inst;\n    return cl;\n}\nexport function normalizeParams(_params) {\n    const params = _params;\n    if (!params)\n        return {};\n    if (typeof params === \"string\")\n        return { error: () => params };\n    if (params?.message !== undefined) {\n        if (params?.error !== undefined)\n            throw new Error(\"Cannot specify both `message` and `error` params\");\n        params.error = params.message;\n    }\n    delete params.message;\n    if (typeof params.error === \"string\")\n        return { ...params, error: () => params.error };\n    return params;\n}\nexport function createTransparentProxy(getter) {\n    let target;\n    return new Proxy({}, {\n        get(_, prop, receiver) {\n            target ?? (target = getter());\n            return Reflect.get(target, prop, receiver);\n        },\n        set(_, prop, value, receiver) {\n            target ?? (target = getter());\n            return Reflect.set(target, prop, value, receiver);\n        },\n        has(_, prop) {\n            target ?? (target = getter());\n            return Reflect.has(target, prop);\n        },\n        deleteProperty(_, prop) {\n            target ?? (target = getter());\n            return Reflect.deleteProperty(target, prop);\n        },\n        ownKeys(_) {\n            target ?? (target = getter());\n            return Reflect.ownKeys(target);\n        },\n        getOwnPropertyDescriptor(_, prop) {\n            target ?? (target = getter());\n            return Reflect.getOwnPropertyDescriptor(target, prop);\n        },\n        defineProperty(_, prop, descriptor) {\n            target ?? (target = getter());\n            return Reflect.defineProperty(target, prop, descriptor);\n        },\n    });\n}\nexport function stringifyPrimitive(value) {\n    if (typeof value === \"bigint\")\n        return value.toString() + \"n\";\n    if (typeof value === \"string\")\n        return `\"${value}\"`;\n    return `${value}`;\n}\nexport function optionalKeys(shape) {\n    return Object.keys(shape).filter((k) => {\n        return shape[k]._zod.optin === \"optional\" && shape[k]._zod.optout === \"optional\";\n    });\n}\nexport const NUMBER_FORMAT_RANGES = {\n    safeint: [Number.MIN_SAFE_INTEGER, Number.MAX_SAFE_INTEGER],\n    int32: [-2147483648, 2147483647],\n    uint32: [0, 4294967295],\n    float32: [-3.4028234663852886e38, 3.4028234663852886e38],\n    float64: [-Number.MAX_VALUE, Number.MAX_VALUE],\n};\nexport const BIGINT_FORMAT_RANGES = {\n    int64: [/* @__PURE__*/ BigInt(\"-9223372036854775808\"), /* @__PURE__*/ BigInt(\"9223372036854775807\")],\n    uint64: [/* @__PURE__*/ BigInt(0), /* @__PURE__*/ BigInt(\"18446744073709551615\")],\n};\nexport function pick(schema, mask) {\n    const currDef = schema._zod.def;\n    const checks = currDef.checks;\n    const hasChecks = checks && checks.length > 0;\n    if (hasChecks) {\n        throw new Error(\".pick() cannot be used on object schemas containing refinements\");\n    }\n    const def = mergeDefs(schema._zod.def, {\n        get shape() {\n            const newShape = {};\n            for (const key in mask) {\n                if (!(key in currDef.shape)) {\n                    throw new Error(`Unrecognized key: \"${key}\"`);\n                }\n                if (!mask[key])\n                    continue;\n                newShape[key] = currDef.shape[key];\n            }\n            assignProp(this, \"shape\", newShape); // self-caching\n            return newShape;\n        },\n        checks: [],\n    });\n    return clone(schema, def);\n}\nexport function omit(schema, mask) {\n    const currDef = schema._zod.def;\n    const checks = currDef.checks;\n    const hasChecks = checks && checks.length > 0;\n    if (hasChecks) {\n        throw new Error(\".omit() cannot be used on object schemas containing refinements\");\n    }\n    const def = mergeDefs(schema._zod.def, {\n        get shape() {\n            const newShape = { ...schema._zod.def.shape };\n            for (const key in mask) {\n                if (!(key in currDef.shape)) {\n                    throw new Error(`Unrecognized key: \"${key}\"`);\n                }\n                if (!mask[key])\n                    continue;\n                delete newShape[key];\n            }\n            assignProp(this, \"shape\", newShape); // self-caching\n            return newShape;\n        },\n        checks: [],\n    });\n    return clone(schema, def);\n}\nexport function extend(schema, shape) {\n    if (!isPlainObject(shape)) {\n        throw new Error(\"Invalid input to extend: expected a plain object\");\n    }\n    const checks = schema._zod.def.checks;\n    const hasChecks = checks && checks.length > 0;\n    if (hasChecks) {\n        // Only throw if new shape overlaps with existing shape\n        // Use getOwnPropertyDescriptor to check key existence without accessing values\n        const existingShape = schema._zod.def.shape;\n        for (const key in shape) {\n            if (Object.getOwnPropertyDescriptor(existingShape, key) !== undefined) {\n                throw new Error(\"Cannot overwrite keys on object schemas containing refinements. Use `.safeExtend()` instead.\");\n            }\n        }\n    }\n    const def = mergeDefs(schema._zod.def, {\n        get shape() {\n            const _shape = { ...schema._zod.def.shape, ...shape };\n            assignProp(this, \"shape\", _shape); // self-caching\n            return _shape;\n        },\n    });\n    return clone(schema, def);\n}\nexport function safeExtend(schema, shape) {\n    if (!isPlainObject(shape)) {\n        throw new Error(\"Invalid input to safeExtend: expected a plain object\");\n    }\n    const def = mergeDefs(schema._zod.def, {\n        get shape() {\n            const _shape = { ...schema._zod.def.shape, ...shape };\n            assignProp(this, \"shape\", _shape); // self-caching\n            return _shape;\n        },\n    });\n    return clone(schema, def);\n}\nexport function merge(a, b) {\n    const def = mergeDefs(a._zod.def, {\n        get shape() {\n            const _shape = { ...a._zod.def.shape, ...b._zod.def.shape };\n            assignProp(this, \"shape\", _shape); // self-caching\n            return _shape;\n        },\n        get catchall() {\n            return b._zod.def.catchall;\n        },\n        checks: [], // delete existing checks\n    });\n    return clone(a, def);\n}\nexport function partial(Class, schema, mask) {\n    const currDef = schema._zod.def;\n    const checks = currDef.checks;\n    const hasChecks = checks && checks.length > 0;\n    if (hasChecks) {\n        throw new Error(\".partial() cannot be used on object schemas containing refinements\");\n    }\n    const def = mergeDefs(schema._zod.def, {\n        get shape() {\n            const oldShape = schema._zod.def.shape;\n            const shape = { ...oldShape };\n            if (mask) {\n                for (const key in mask) {\n                    if (!(key in oldShape)) {\n                        throw new Error(`Unrecognized key: \"${key}\"`);\n                    }\n                    if (!mask[key])\n                        continue;\n                    // if (oldShape[key]!._zod.optin === \"optional\") continue;\n                    shape[key] = Class\n                        ? new Class({\n                            type: \"optional\",\n                            innerType: oldShape[key],\n                        })\n                        : oldShape[key];\n                }\n            }\n            else {\n                for (const key in oldShape) {\n                    // if (oldShape[key]!._zod.optin === \"optional\") continue;\n                    shape[key] = Class\n                        ? new Class({\n                            type: \"optional\",\n                            innerType: oldShape[key],\n                        })\n                        : oldShape[key];\n                }\n            }\n            assignProp(this, \"shape\", shape); // self-caching\n            return shape;\n        },\n        checks: [],\n    });\n    return clone(schema, def);\n}\nexport function required(Class, schema, mask) {\n    const def = mergeDefs(schema._zod.def, {\n        get shape() {\n            const oldShape = schema._zod.def.shape;\n            const shape = { ...oldShape };\n            if (mask) {\n                for (const key in mask) {\n                    if (!(key in shape)) {\n                        throw new Error(`Unrecognized key: \"${key}\"`);\n                    }\n                    if (!mask[key])\n                        continue;\n                    // overwrite with non-optional\n                    shape[key] = new Class({\n                        type: \"nonoptional\",\n                        innerType: oldShape[key],\n                    });\n                }\n            }\n            else {\n                for (const key in oldShape) {\n                    // overwrite with non-optional\n                    shape[key] = new Class({\n                        type: \"nonoptional\",\n                        innerType: oldShape[key],\n                    });\n                }\n            }\n            assignProp(this, \"shape\", shape); // self-caching\n            return shape;\n        },\n    });\n    return clone(schema, def);\n}\n// invalid_type | too_big | too_small | invalid_format | not_multiple_of | unrecognized_keys | invalid_union | invalid_key | invalid_element | invalid_value | custom\nexport function aborted(x, startIndex = 0) {\n    if (x.aborted === true)\n        return true;\n    for (let i = startIndex; i < x.issues.length; i++) {\n        if (x.issues[i]?.continue !== true) {\n            return true;\n        }\n    }\n    return false;\n}\nexport function prefixIssues(path, issues) {\n    return issues.map((iss) => {\n        var _a;\n        (_a = iss).path ?? (_a.path = []);\n        iss.path.unshift(path);\n        return iss;\n    });\n}\nexport function unwrapMessage(message) {\n    return typeof message === \"string\" ? message : message?.message;\n}\nexport function finalizeIssue(iss, ctx, config) {\n    const full = { ...iss, path: iss.path ?? [] };\n    // for backwards compatibility\n    if (!iss.message) {\n        const message = unwrapMessage(iss.inst?._zod.def?.error?.(iss)) ??\n            unwrapMessage(ctx?.error?.(iss)) ??\n            unwrapMessage(config.customError?.(iss)) ??\n            unwrapMessage(config.localeError?.(iss)) ??\n            \"Invalid input\";\n        full.message = message;\n    }\n    // delete (full as any).def;\n    delete full.inst;\n    delete full.continue;\n    if (!ctx?.reportInput) {\n        delete full.input;\n    }\n    return full;\n}\nexport function getSizableOrigin(input) {\n    if (input instanceof Set)\n        return \"set\";\n    if (input instanceof Map)\n        return \"map\";\n    // @ts-ignore\n    if (input instanceof File)\n        return \"file\";\n    return \"unknown\";\n}\nexport function getLengthableOrigin(input) {\n    if (Array.isArray(input))\n        return \"array\";\n    if (typeof input === \"string\")\n        return \"string\";\n    return \"unknown\";\n}\nexport function parsedType(data) {\n    const t = typeof data;\n    switch (t) {\n        case \"number\": {\n            return Number.isNaN(data) ? \"nan\" : \"number\";\n        }\n        case \"object\": {\n            if (data === null) {\n                return \"null\";\n            }\n            if (Array.isArray(data)) {\n                return \"array\";\n            }\n            const obj = data;\n            if (obj && Object.getPrototypeOf(obj) !== Object.prototype && \"constructor\" in obj && obj.constructor) {\n                return obj.constructor.name;\n            }\n        }\n    }\n    return t;\n}\nexport function issue(...args) {\n    const [iss, input, inst] = args;\n    if (typeof iss === \"string\") {\n        return {\n            message: iss,\n            code: \"custom\",\n            input,\n            inst,\n        };\n    }\n    return { ...iss };\n}\nexport function cleanEnum(obj) {\n    return Object.entries(obj)\n        .filter(([k, _]) => {\n        // return true if NaN, meaning it's not a number, thus a string key\n        return Number.isNaN(Number.parseInt(k, 10));\n    })\n        .map((el) => el[1]);\n}\n// Codec utility functions\nexport function base64ToUint8Array(base64) {\n    const binaryString = atob(base64);\n    const bytes = new Uint8Array(binaryString.length);\n    for (let i = 0; i < binaryString.length; i++) {\n        bytes[i] = binaryString.charCodeAt(i);\n    }\n    return bytes;\n}\nexport function uint8ArrayToBase64(bytes) {\n    let binaryString = \"\";\n    for (let i = 0; i < bytes.length; i++) {\n        binaryString += String.fromCharCode(bytes[i]);\n    }\n    return btoa(binaryString);\n}\nexport function base64urlToUint8Array(base64url) {\n    const base64 = base64url.replace(/-/g, \"+\").replace(/_/g, \"/\");\n    const padding = \"=\".repeat((4 - (base64.length % 4)) % 4);\n    return base64ToUint8Array(base64 + padding);\n}\nexport function uint8ArrayToBase64url(bytes) {\n    return uint8ArrayToBase64(bytes).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=/g, \"\");\n}\nexport function hexToUint8Array(hex) {\n    const cleanHex = hex.replace(/^0x/, \"\");\n    if (cleanHex.length % 2 !== 0) {\n        throw new Error(\"Invalid hex string length\");\n    }\n    const bytes = new Uint8Array(cleanHex.length / 2);\n    for (let i = 0; i < cleanHex.length; i += 2) {\n        bytes[i / 2] = Number.parseInt(cleanHex.slice(i, i + 2), 16);\n    }\n    return bytes;\n}\nexport function uint8ArrayToHex(bytes) {\n    return Array.from(bytes)\n        .map((b) => b.toString(16).padStart(2, \"0\"))\n        .join(\"\");\n}\n// instanceof\nexport class Class {\n    constructor(..._args) { }\n}\n","import { $constructor } from \"./core.js\";\nimport * as util from \"./util.js\";\nconst initializer = (inst, def) => {\n    inst.name = \"$ZodError\";\n    Object.defineProperty(inst, \"_zod\", {\n        value: inst._zod,\n        enumerable: false,\n    });\n    Object.defineProperty(inst, \"issues\", {\n        value: def,\n        enumerable: false,\n    });\n    inst.message = JSON.stringify(def, util.jsonStringifyReplacer, 2);\n    Object.defineProperty(inst, \"toString\", {\n        value: () => inst.message,\n        enumerable: false,\n    });\n};\nexport const $ZodError = $constructor(\"$ZodError\", initializer);\nexport const $ZodRealError = $constructor(\"$ZodError\", initializer, { Parent: Error });\nexport function flattenError(error, mapper = (issue) => issue.message) {\n    const fieldErrors = {};\n    const formErrors = [];\n    for (const sub of error.issues) {\n        if (sub.path.length > 0) {\n            fieldErrors[sub.path[0]] = fieldErrors[sub.path[0]] || [];\n            fieldErrors[sub.path[0]].push(mapper(sub));\n        }\n        else {\n            formErrors.push(mapper(sub));\n        }\n    }\n    return { formErrors, fieldErrors };\n}\nexport function formatError(error, mapper = (issue) => issue.message) {\n    const fieldErrors = { _errors: [] };\n    const processError = (error) => {\n        for (const issue of error.issues) {\n            if (issue.code === \"invalid_union\" && issue.errors.length) {\n                issue.errors.map((issues) => processError({ issues }));\n            }\n            else if (issue.code === \"invalid_key\") {\n                processError({ issues: issue.issues });\n            }\n            else if (issue.code === \"invalid_element\") {\n                processError({ issues: issue.issues });\n            }\n            else if (issue.path.length === 0) {\n                fieldErrors._errors.push(mapper(issue));\n            }\n            else {\n                let curr = fieldErrors;\n                let i = 0;\n                while (i < issue.path.length) {\n                    const el = issue.path[i];\n                    const terminal = i === issue.path.length - 1;\n                    if (!terminal) {\n                        curr[el] = curr[el] || { _errors: [] };\n                    }\n                    else {\n                        curr[el] = curr[el] || { _errors: [] };\n                        curr[el]._errors.push(mapper(issue));\n                    }\n                    curr = curr[el];\n                    i++;\n                }\n            }\n        }\n    };\n    processError(error);\n    return fieldErrors;\n}\nexport function treeifyError(error, mapper = (issue) => issue.message) {\n    const result = { errors: [] };\n    const processError = (error, path = []) => {\n        var _a, _b;\n        for (const issue of error.issues) {\n            if (issue.code === \"invalid_union\" && issue.errors.length) {\n                // regular union error\n                issue.errors.map((issues) => processError({ issues }, issue.path));\n            }\n            else if (issue.code === \"invalid_key\") {\n                processError({ issues: issue.issues }, issue.path);\n            }\n            else if (issue.code === \"invalid_element\") {\n                processError({ issues: issue.issues }, issue.path);\n            }\n            else {\n                const fullpath = [...path, ...issue.path];\n                if (fullpath.length === 0) {\n                    result.errors.push(mapper(issue));\n                    continue;\n                }\n                let curr = result;\n                let i = 0;\n                while (i < fullpath.length) {\n                    const el = fullpath[i];\n                    const terminal = i === fullpath.length - 1;\n                    if (typeof el === \"string\") {\n                        curr.properties ?? (curr.properties = {});\n                        (_a = curr.properties)[el] ?? (_a[el] = { errors: [] });\n                        curr = curr.properties[el];\n                    }\n                    else {\n                        curr.items ?? (curr.items = []);\n                        (_b = curr.items)[el] ?? (_b[el] = { errors: [] });\n                        curr = curr.items[el];\n                    }\n                    if (terminal) {\n                        curr.errors.push(mapper(issue));\n                    }\n                    i++;\n                }\n            }\n        }\n    };\n    processError(error);\n    return result;\n}\n/** Format a ZodError as a human-readable string in the following form.\n *\n * From\n *\n * ```ts\n * ZodError {\n *   issues: [\n *     {\n *       expected: 'string',\n *       code: 'invalid_type',\n *       path: [ 'username' ],\n *       message: 'Invalid input: expected string'\n *     },\n *     {\n *       expected: 'number',\n *       code: 'invalid_type',\n *       path: [ 'favoriteNumbers', 1 ],\n *       message: 'Invalid input: expected number'\n *     }\n *   ];\n * }\n * ```\n *\n * to\n *\n * ```\n * username\n *    Expected number, received string at \"username\n * favoriteNumbers[0]\n *    Invalid input: expected number\n * ```\n */\nexport function toDotPath(_path) {\n    const segs = [];\n    const path = _path.map((seg) => (typeof seg === \"object\" ? seg.key : seg));\n    for (const seg of path) {\n        if (typeof seg === \"number\")\n            segs.push(`[${seg}]`);\n        else if (typeof seg === \"symbol\")\n            segs.push(`[${JSON.stringify(String(seg))}]`);\n        else if (/[^\\w$]/.test(seg))\n            segs.push(`[${JSON.stringify(seg)}]`);\n        else {\n            if (segs.length)\n                segs.push(\".\");\n            segs.push(seg);\n        }\n    }\n    return segs.join(\"\");\n}\nexport function prettifyError(error) {\n    const lines = [];\n    // sort by path length\n    const issues = [...error.issues].sort((a, b) => (a.path ?? []).length - (b.path ?? []).length);\n    // Process each issue\n    for (const issue of issues) {\n        lines.push(` ${issue.message}`);\n        if (issue.path?.length)\n            lines.push(`   at ${toDotPath(issue.path)}`);\n    }\n    // Convert Map to formatted string\n    return lines.join(\"\\n\");\n}\n","import * as core from \"./core.js\";\nimport * as errors from \"./errors.js\";\nimport * as util from \"./util.js\";\nexport const _parse = (_Err) => (schema, value, _ctx, _params) => {\n    const ctx = _ctx ? Object.assign(_ctx, { async: false }) : { async: false };\n    const result = schema._zod.run({ value, issues: [] }, ctx);\n    if (result instanceof Promise) {\n        throw new core.$ZodAsyncError();\n    }\n    if (result.issues.length) {\n        const e = new (_params?.Err ?? _Err)(result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config())));\n        util.captureStackTrace(e, _params?.callee);\n        throw e;\n    }\n    return result.value;\n};\nexport const parse = /* @__PURE__*/ _parse(errors.$ZodRealError);\nexport const _parseAsync = (_Err) => async (schema, value, _ctx, params) => {\n    const ctx = _ctx ? Object.assign(_ctx, { async: true }) : { async: true };\n    let result = schema._zod.run({ value, issues: [] }, ctx);\n    if (result instanceof Promise)\n        result = await result;\n    if (result.issues.length) {\n        const e = new (params?.Err ?? _Err)(result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config())));\n        util.captureStackTrace(e, params?.callee);\n        throw e;\n    }\n    return result.value;\n};\nexport const parseAsync = /* @__PURE__*/ _parseAsync(errors.$ZodRealError);\nexport const _safeParse = (_Err) => (schema, value, _ctx) => {\n    const ctx = _ctx ? { ..._ctx, async: false } : { async: false };\n    const result = schema._zod.run({ value, issues: [] }, ctx);\n    if (result instanceof Promise) {\n        throw new core.$ZodAsyncError();\n    }\n    return result.issues.length\n        ? {\n            success: false,\n            error: new (_Err ?? errors.$ZodError)(result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config()))),\n        }\n        : { success: true, data: result.value };\n};\nexport const safeParse = /* @__PURE__*/ _safeParse(errors.$ZodRealError);\nexport const _safeParseAsync = (_Err) => async (schema, value, _ctx) => {\n    const ctx = _ctx ? Object.assign(_ctx, { async: true }) : { async: true };\n    let result = schema._zod.run({ value, issues: [] }, ctx);\n    if (result instanceof Promise)\n        result = await result;\n    return result.issues.length\n        ? {\n            success: false,\n            error: new _Err(result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config()))),\n        }\n        : { success: true, data: result.value };\n};\nexport const safeParseAsync = /* @__PURE__*/ _safeParseAsync(errors.$ZodRealError);\nexport const _encode = (_Err) => (schema, value, _ctx) => {\n    const ctx = _ctx ? Object.assign(_ctx, { direction: \"backward\" }) : { direction: \"backward\" };\n    return _parse(_Err)(schema, value, ctx);\n};\nexport const encode = /* @__PURE__*/ _encode(errors.$ZodRealError);\nexport const _decode = (_Err) => (schema, value, _ctx) => {\n    return _parse(_Err)(schema, value, _ctx);\n};\nexport const decode = /* @__PURE__*/ _decode(errors.$ZodRealError);\nexport const _encodeAsync = (_Err) => async (schema, value, _ctx) => {\n    const ctx = _ctx ? Object.assign(_ctx, { direction: \"backward\" }) : { direction: \"backward\" };\n    return _parseAsync(_Err)(schema, value, ctx);\n};\nexport const encodeAsync = /* @__PURE__*/ _encodeAsync(errors.$ZodRealError);\nexport const _decodeAsync = (_Err) => async (schema, value, _ctx) => {\n    return _parseAsync(_Err)(schema, value, _ctx);\n};\nexport const decodeAsync = /* @__PURE__*/ _decodeAsync(errors.$ZodRealError);\nexport const _safeEncode = (_Err) => (schema, value, _ctx) => {\n    const ctx = _ctx ? Object.assign(_ctx, { direction: \"backward\" }) : { direction: \"backward\" };\n    return _safeParse(_Err)(schema, value, ctx);\n};\nexport const safeEncode = /* @__PURE__*/ _safeEncode(errors.$ZodRealError);\nexport const _safeDecode = (_Err) => (schema, value, _ctx) => {\n    return _safeParse(_Err)(schema, value, _ctx);\n};\nexport const safeDecode = /* @__PURE__*/ _safeDecode(errors.$ZodRealError);\nexport const _safeEncodeAsync = (_Err) => async (schema, value, _ctx) => {\n    const ctx = _ctx ? Object.assign(_ctx, { direction: \"backward\" }) : { direction: \"backward\" };\n    return _safeParseAsync(_Err)(schema, value, ctx);\n};\nexport const safeEncodeAsync = /* @__PURE__*/ _safeEncodeAsync(errors.$ZodRealError);\nexport const _safeDecodeAsync = (_Err) => async (schema, value, _ctx) => {\n    return _safeParseAsync(_Err)(schema, value, _ctx);\n};\nexport const safeDecodeAsync = /* @__PURE__*/ _safeDecodeAsync(errors.$ZodRealError);\n","import * as util from \"./util.js\";\nexport const cuid = /^[cC][^\\s-]{8,}$/;\nexport const cuid2 = /^[0-9a-z]+$/;\nexport const ulid = /^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/;\nexport const xid = /^[0-9a-vA-V]{20}$/;\nexport const ksuid = /^[A-Za-z0-9]{27}$/;\nexport const nanoid = /^[a-zA-Z0-9_-]{21}$/;\n/** ISO 8601-1 duration regex. Does not support the 8601-2 extensions like negative durations or fractional/negative components. */\nexport const duration = /^P(?:(\\d+W)|(?!.*W)(?=\\d|T\\d)(\\d+Y)?(\\d+M)?(\\d+D)?(T(?=\\d)(\\d+H)?(\\d+M)?(\\d+([.,]\\d+)?S)?)?)$/;\n/** Implements ISO 8601-2 extensions like explicit +- prefixes, mixing weeks with other units, and fractional/negative components. */\nexport const extendedDuration = /^[-+]?P(?!$)(?:(?:[-+]?\\d+Y)|(?:[-+]?\\d+[.,]\\d+Y$))?(?:(?:[-+]?\\d+M)|(?:[-+]?\\d+[.,]\\d+M$))?(?:(?:[-+]?\\d+W)|(?:[-+]?\\d+[.,]\\d+W$))?(?:(?:[-+]?\\d+D)|(?:[-+]?\\d+[.,]\\d+D$))?(?:T(?=[\\d+-])(?:(?:[-+]?\\d+H)|(?:[-+]?\\d+[.,]\\d+H$))?(?:(?:[-+]?\\d+M)|(?:[-+]?\\d+[.,]\\d+M$))?(?:[-+]?\\d+(?:[.,]\\d+)?S)?)??$/;\n/** A regex for any UUID-like identifier: 8-4-4-4-12 hex pattern */\nexport const guid = /^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/;\n/** Returns a regex for validating an RFC 9562/4122 UUID.\n *\n * @param version Optionally specify a version 1-8. If no version is specified, all versions are supported. */\nexport const uuid = (version) => {\n    if (!version)\n        return /^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/;\n    return new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${version}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`);\n};\nexport const uuid4 = /*@__PURE__*/ uuid(4);\nexport const uuid6 = /*@__PURE__*/ uuid(6);\nexport const uuid7 = /*@__PURE__*/ uuid(7);\n/** Practical email validation */\nexport const email = /^(?!\\.)(?!.*\\.\\.)([A-Za-z0-9_'+\\-\\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\\-]*\\.)+[A-Za-z]{2,}$/;\n/** Equivalent to the HTML5 input[type=email] validation implemented by browsers. Source: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/email */\nexport const html5Email = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n/** The classic emailregex.com regex for RFC 5322-compliant emails */\nexport const rfc5322Email = /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\n/** A loose regex that allows Unicode characters, enforces length limits, and that's about it. */\nexport const unicodeEmail = /^[^\\s@\"]{1,64}@[^\\s@]{1,255}$/u;\nexport const idnEmail = unicodeEmail;\nexport const browserEmail = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n// from https://thekevinscott.com/emojis-in-javascript/#writing-a-regular-expression\nconst _emoji = `^(\\\\p{Extended_Pictographic}|\\\\p{Emoji_Component})+$`;\nexport function emoji() {\n    return new RegExp(_emoji, \"u\");\n}\nexport const ipv4 = /^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/;\nexport const ipv6 = /^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/;\nexport const mac = (delimiter) => {\n    const escapedDelim = util.escapeRegex(delimiter ?? \":\");\n    return new RegExp(`^(?:[0-9A-F]{2}${escapedDelim}){5}[0-9A-F]{2}$|^(?:[0-9a-f]{2}${escapedDelim}){5}[0-9a-f]{2}$`);\n};\nexport const cidrv4 = /^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\/([0-9]|[1-2][0-9]|3[0-2])$/;\nexport const cidrv6 = /^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/;\n// https://stackoverflow.com/questions/7860392/determine-if-string-is-in-base64-using-javascript\nexport const base64 = /^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/;\nexport const base64url = /^[A-Za-z0-9_-]*$/;\n// based on https://stackoverflow.com/questions/106179/regular-expression-to-match-dns-hostname-or-ip-address\n// export const hostname: RegExp = /^([a-zA-Z0-9-]+\\.)*[a-zA-Z0-9-]+$/;\nexport const hostname = /^(?=.{1,253}\\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\\.?$/;\nexport const domain = /^([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\\.)+[a-zA-Z]{2,}$/;\n// https://blog.stevenlevithan.com/archives/validate-phone-number#r4-3 (regex sans spaces)\n// E.164: leading digit must be 1-9; total digits (excluding '+') between 7-15\nexport const e164 = /^\\+[1-9]\\d{6,14}$/;\n// const dateSource = `((\\\\d\\\\d[2468][048]|\\\\d\\\\d[13579][26]|\\\\d\\\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\\\d|30)|(02)-(0[1-9]|1\\\\d|2[0-8])))`;\nconst dateSource = `(?:(?:\\\\d\\\\d[2468][048]|\\\\d\\\\d[13579][26]|\\\\d\\\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\\\d|30)|(?:02)-(?:0[1-9]|1\\\\d|2[0-8])))`;\nexport const date = /*@__PURE__*/ new RegExp(`^${dateSource}$`);\nfunction timeSource(args) {\n    const hhmm = `(?:[01]\\\\d|2[0-3]):[0-5]\\\\d`;\n    const regex = typeof args.precision === \"number\"\n        ? args.precision === -1\n            ? `${hhmm}`\n            : args.precision === 0\n                ? `${hhmm}:[0-5]\\\\d`\n                : `${hhmm}:[0-5]\\\\d\\\\.\\\\d{${args.precision}}`\n        : `${hhmm}(?::[0-5]\\\\d(?:\\\\.\\\\d+)?)?`;\n    return regex;\n}\nexport function time(args) {\n    return new RegExp(`^${timeSource(args)}$`);\n}\n// Adapted from https://stackoverflow.com/a/3143231\nexport function datetime(args) {\n    const time = timeSource({ precision: args.precision });\n    const opts = [\"Z\"];\n    if (args.local)\n        opts.push(\"\");\n    // if (args.offset) opts.push(`([+-]\\\\d{2}:\\\\d{2})`);\n    if (args.offset)\n        opts.push(`([+-](?:[01]\\\\d|2[0-3]):[0-5]\\\\d)`);\n    const timeRegex = `${time}(?:${opts.join(\"|\")})`;\n    return new RegExp(`^${dateSource}T(?:${timeRegex})$`);\n}\nexport const string = (params) => {\n    const regex = params ? `[\\\\s\\\\S]{${params?.minimum ?? 0},${params?.maximum ?? \"\"}}` : `[\\\\s\\\\S]*`;\n    return new RegExp(`^${regex}$`);\n};\nexport const bigint = /^-?\\d+n?$/;\nexport const integer = /^-?\\d+$/;\nexport const number = /^-?\\d+(?:\\.\\d+)?$/;\nexport const boolean = /^(?:true|false)$/i;\nconst _null = /^null$/i;\nexport { _null as null };\nconst _undefined = /^undefined$/i;\nexport { _undefined as undefined };\n// regex for string with no uppercase letters\nexport const lowercase = /^[^A-Z]*$/;\n// regex for string with no lowercase letters\nexport const uppercase = /^[^a-z]*$/;\n// regex for hexadecimal strings (any length)\nexport const hex = /^[0-9a-fA-F]*$/;\n// Hash regexes for different algorithms and encodings\n// Helper function to create base64 regex with exact length and padding\nfunction fixedBase64(bodyLength, padding) {\n    return new RegExp(`^[A-Za-z0-9+/]{${bodyLength}}${padding}$`);\n}\n// Helper function to create base64url regex with exact length (no padding)\nfunction fixedBase64url(length) {\n    return new RegExp(`^[A-Za-z0-9_-]{${length}}$`);\n}\n// MD5 (16 bytes): base64 = 24 chars total (22 + \"==\")\nexport const md5_hex = /^[0-9a-fA-F]{32}$/;\nexport const md5_base64 = /*@__PURE__*/ fixedBase64(22, \"==\");\nexport const md5_base64url = /*@__PURE__*/ fixedBase64url(22);\n// SHA1 (20 bytes): base64 = 28 chars total (27 + \"=\")\nexport const sha1_hex = /^[0-9a-fA-F]{40}$/;\nexport const sha1_base64 = /*@__PURE__*/ fixedBase64(27, \"=\");\nexport const sha1_base64url = /*@__PURE__*/ fixedBase64url(27);\n// SHA256 (32 bytes): base64 = 44 chars total (43 + \"=\")\nexport const sha256_hex = /^[0-9a-fA-F]{64}$/;\nexport const sha256_base64 = /*@__PURE__*/ fixedBase64(43, \"=\");\nexport const sha256_base64url = /*@__PURE__*/ fixedBase64url(43);\n// SHA384 (48 bytes): base64 = 64 chars total (no padding)\nexport const sha384_hex = /^[0-9a-fA-F]{96}$/;\nexport const sha384_base64 = /*@__PURE__*/ fixedBase64(64, \"\");\nexport const sha384_base64url = /*@__PURE__*/ fixedBase64url(64);\n// SHA512 (64 bytes): base64 = 88 chars total (86 + \"==\")\nexport const sha512_hex = /^[0-9a-fA-F]{128}$/;\nexport const sha512_base64 = /*@__PURE__*/ fixedBase64(86, \"==\");\nexport const sha512_base64url = /*@__PURE__*/ fixedBase64url(86);\n","// import { $ZodType } from \"./schemas.js\";\nimport * as core from \"./core.js\";\nimport * as regexes from \"./regexes.js\";\nimport * as util from \"./util.js\";\nexport const $ZodCheck = /*@__PURE__*/ core.$constructor(\"$ZodCheck\", (inst, def) => {\n    var _a;\n    inst._zod ?? (inst._zod = {});\n    inst._zod.def = def;\n    (_a = inst._zod).onattach ?? (_a.onattach = []);\n});\nconst numericOriginMap = {\n    number: \"number\",\n    bigint: \"bigint\",\n    object: \"date\",\n};\nexport const $ZodCheckLessThan = /*@__PURE__*/ core.$constructor(\"$ZodCheckLessThan\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    const origin = numericOriginMap[typeof def.value];\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        const curr = (def.inclusive ? bag.maximum : bag.exclusiveMaximum) ?? Number.POSITIVE_INFINITY;\n        if (def.value < curr) {\n            if (def.inclusive)\n                bag.maximum = def.value;\n            else\n                bag.exclusiveMaximum = def.value;\n        }\n    });\n    inst._zod.check = (payload) => {\n        if (def.inclusive ? payload.value <= def.value : payload.value < def.value) {\n            return;\n        }\n        payload.issues.push({\n            origin,\n            code: \"too_big\",\n            maximum: typeof def.value === \"object\" ? def.value.getTime() : def.value,\n            input: payload.value,\n            inclusive: def.inclusive,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckGreaterThan = /*@__PURE__*/ core.$constructor(\"$ZodCheckGreaterThan\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    const origin = numericOriginMap[typeof def.value];\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        const curr = (def.inclusive ? bag.minimum : bag.exclusiveMinimum) ?? Number.NEGATIVE_INFINITY;\n        if (def.value > curr) {\n            if (def.inclusive)\n                bag.minimum = def.value;\n            else\n                bag.exclusiveMinimum = def.value;\n        }\n    });\n    inst._zod.check = (payload) => {\n        if (def.inclusive ? payload.value >= def.value : payload.value > def.value) {\n            return;\n        }\n        payload.issues.push({\n            origin,\n            code: \"too_small\",\n            minimum: typeof def.value === \"object\" ? def.value.getTime() : def.value,\n            input: payload.value,\n            inclusive: def.inclusive,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckMultipleOf = \n/*@__PURE__*/ core.$constructor(\"$ZodCheckMultipleOf\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    inst._zod.onattach.push((inst) => {\n        var _a;\n        (_a = inst._zod.bag).multipleOf ?? (_a.multipleOf = def.value);\n    });\n    inst._zod.check = (payload) => {\n        if (typeof payload.value !== typeof def.value)\n            throw new Error(\"Cannot mix number and bigint in multiple_of check.\");\n        const isMultiple = typeof payload.value === \"bigint\"\n            ? payload.value % def.value === BigInt(0)\n            : util.floatSafeRemainder(payload.value, def.value) === 0;\n        if (isMultiple)\n            return;\n        payload.issues.push({\n            origin: typeof payload.value,\n            code: \"not_multiple_of\",\n            divisor: def.value,\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckNumberFormat = /*@__PURE__*/ core.$constructor(\"$ZodCheckNumberFormat\", (inst, def) => {\n    $ZodCheck.init(inst, def); // no format checks\n    def.format = def.format || \"float64\";\n    const isInt = def.format?.includes(\"int\");\n    const origin = isInt ? \"int\" : \"number\";\n    const [minimum, maximum] = util.NUMBER_FORMAT_RANGES[def.format];\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.format = def.format;\n        bag.minimum = minimum;\n        bag.maximum = maximum;\n        if (isInt)\n            bag.pattern = regexes.integer;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        if (isInt) {\n            if (!Number.isInteger(input)) {\n                // invalid_format issue\n                // payload.issues.push({\n                //   expected: def.format,\n                //   format: def.format,\n                //   code: \"invalid_format\",\n                //   input,\n                //   inst,\n                // });\n                // invalid_type issue\n                payload.issues.push({\n                    expected: origin,\n                    format: def.format,\n                    code: \"invalid_type\",\n                    continue: false,\n                    input,\n                    inst,\n                });\n                return;\n                // not_multiple_of issue\n                // payload.issues.push({\n                //   code: \"not_multiple_of\",\n                //   origin: \"number\",\n                //   input,\n                //   inst,\n                //   divisor: 1,\n                // });\n            }\n            if (!Number.isSafeInteger(input)) {\n                if (input > 0) {\n                    // too_big\n                    payload.issues.push({\n                        input,\n                        code: \"too_big\",\n                        maximum: Number.MAX_SAFE_INTEGER,\n                        note: \"Integers must be within the safe integer range.\",\n                        inst,\n                        origin,\n                        inclusive: true,\n                        continue: !def.abort,\n                    });\n                }\n                else {\n                    // too_small\n                    payload.issues.push({\n                        input,\n                        code: \"too_small\",\n                        minimum: Number.MIN_SAFE_INTEGER,\n                        note: \"Integers must be within the safe integer range.\",\n                        inst,\n                        origin,\n                        inclusive: true,\n                        continue: !def.abort,\n                    });\n                }\n                return;\n            }\n        }\n        if (input < minimum) {\n            payload.issues.push({\n                origin: \"number\",\n                input,\n                code: \"too_small\",\n                minimum,\n                inclusive: true,\n                inst,\n                continue: !def.abort,\n            });\n        }\n        if (input > maximum) {\n            payload.issues.push({\n                origin: \"number\",\n                input,\n                code: \"too_big\",\n                maximum,\n                inclusive: true,\n                inst,\n                continue: !def.abort,\n            });\n        }\n    };\n});\nexport const $ZodCheckBigIntFormat = /*@__PURE__*/ core.$constructor(\"$ZodCheckBigIntFormat\", (inst, def) => {\n    $ZodCheck.init(inst, def); // no format checks\n    const [minimum, maximum] = util.BIGINT_FORMAT_RANGES[def.format];\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.format = def.format;\n        bag.minimum = minimum;\n        bag.maximum = maximum;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        if (input < minimum) {\n            payload.issues.push({\n                origin: \"bigint\",\n                input,\n                code: \"too_small\",\n                minimum: minimum,\n                inclusive: true,\n                inst,\n                continue: !def.abort,\n            });\n        }\n        if (input > maximum) {\n            payload.issues.push({\n                origin: \"bigint\",\n                input,\n                code: \"too_big\",\n                maximum,\n                inclusive: true,\n                inst,\n                continue: !def.abort,\n            });\n        }\n    };\n});\nexport const $ZodCheckMaxSize = /*@__PURE__*/ core.$constructor(\"$ZodCheckMaxSize\", (inst, def) => {\n    var _a;\n    $ZodCheck.init(inst, def);\n    (_a = inst._zod.def).when ?? (_a.when = (payload) => {\n        const val = payload.value;\n        return !util.nullish(val) && val.size !== undefined;\n    });\n    inst._zod.onattach.push((inst) => {\n        const curr = (inst._zod.bag.maximum ?? Number.POSITIVE_INFINITY);\n        if (def.maximum < curr)\n            inst._zod.bag.maximum = def.maximum;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        const size = input.size;\n        if (size <= def.maximum)\n            return;\n        payload.issues.push({\n            origin: util.getSizableOrigin(input),\n            code: \"too_big\",\n            maximum: def.maximum,\n            inclusive: true,\n            input,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckMinSize = /*@__PURE__*/ core.$constructor(\"$ZodCheckMinSize\", (inst, def) => {\n    var _a;\n    $ZodCheck.init(inst, def);\n    (_a = inst._zod.def).when ?? (_a.when = (payload) => {\n        const val = payload.value;\n        return !util.nullish(val) && val.size !== undefined;\n    });\n    inst._zod.onattach.push((inst) => {\n        const curr = (inst._zod.bag.minimum ?? Number.NEGATIVE_INFINITY);\n        if (def.minimum > curr)\n            inst._zod.bag.minimum = def.minimum;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        const size = input.size;\n        if (size >= def.minimum)\n            return;\n        payload.issues.push({\n            origin: util.getSizableOrigin(input),\n            code: \"too_small\",\n            minimum: def.minimum,\n            inclusive: true,\n            input,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckSizeEquals = /*@__PURE__*/ core.$constructor(\"$ZodCheckSizeEquals\", (inst, def) => {\n    var _a;\n    $ZodCheck.init(inst, def);\n    (_a = inst._zod.def).when ?? (_a.when = (payload) => {\n        const val = payload.value;\n        return !util.nullish(val) && val.size !== undefined;\n    });\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.minimum = def.size;\n        bag.maximum = def.size;\n        bag.size = def.size;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        const size = input.size;\n        if (size === def.size)\n            return;\n        const tooBig = size > def.size;\n        payload.issues.push({\n            origin: util.getSizableOrigin(input),\n            ...(tooBig ? { code: \"too_big\", maximum: def.size } : { code: \"too_small\", minimum: def.size }),\n            inclusive: true,\n            exact: true,\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckMaxLength = /*@__PURE__*/ core.$constructor(\"$ZodCheckMaxLength\", (inst, def) => {\n    var _a;\n    $ZodCheck.init(inst, def);\n    (_a = inst._zod.def).when ?? (_a.when = (payload) => {\n        const val = payload.value;\n        return !util.nullish(val) && val.length !== undefined;\n    });\n    inst._zod.onattach.push((inst) => {\n        const curr = (inst._zod.bag.maximum ?? Number.POSITIVE_INFINITY);\n        if (def.maximum < curr)\n            inst._zod.bag.maximum = def.maximum;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        const length = input.length;\n        if (length <= def.maximum)\n            return;\n        const origin = util.getLengthableOrigin(input);\n        payload.issues.push({\n            origin,\n            code: \"too_big\",\n            maximum: def.maximum,\n            inclusive: true,\n            input,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckMinLength = /*@__PURE__*/ core.$constructor(\"$ZodCheckMinLength\", (inst, def) => {\n    var _a;\n    $ZodCheck.init(inst, def);\n    (_a = inst._zod.def).when ?? (_a.when = (payload) => {\n        const val = payload.value;\n        return !util.nullish(val) && val.length !== undefined;\n    });\n    inst._zod.onattach.push((inst) => {\n        const curr = (inst._zod.bag.minimum ?? Number.NEGATIVE_INFINITY);\n        if (def.minimum > curr)\n            inst._zod.bag.minimum = def.minimum;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        const length = input.length;\n        if (length >= def.minimum)\n            return;\n        const origin = util.getLengthableOrigin(input);\n        payload.issues.push({\n            origin,\n            code: \"too_small\",\n            minimum: def.minimum,\n            inclusive: true,\n            input,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckLengthEquals = /*@__PURE__*/ core.$constructor(\"$ZodCheckLengthEquals\", (inst, def) => {\n    var _a;\n    $ZodCheck.init(inst, def);\n    (_a = inst._zod.def).when ?? (_a.when = (payload) => {\n        const val = payload.value;\n        return !util.nullish(val) && val.length !== undefined;\n    });\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.minimum = def.length;\n        bag.maximum = def.length;\n        bag.length = def.length;\n    });\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        const length = input.length;\n        if (length === def.length)\n            return;\n        const origin = util.getLengthableOrigin(input);\n        const tooBig = length > def.length;\n        payload.issues.push({\n            origin,\n            ...(tooBig ? { code: \"too_big\", maximum: def.length } : { code: \"too_small\", minimum: def.length }),\n            inclusive: true,\n            exact: true,\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckStringFormat = /*@__PURE__*/ core.$constructor(\"$ZodCheckStringFormat\", (inst, def) => {\n    var _a, _b;\n    $ZodCheck.init(inst, def);\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.format = def.format;\n        if (def.pattern) {\n            bag.patterns ?? (bag.patterns = new Set());\n            bag.patterns.add(def.pattern);\n        }\n    });\n    if (def.pattern)\n        (_a = inst._zod).check ?? (_a.check = (payload) => {\n            def.pattern.lastIndex = 0;\n            if (def.pattern.test(payload.value))\n                return;\n            payload.issues.push({\n                origin: \"string\",\n                code: \"invalid_format\",\n                format: def.format,\n                input: payload.value,\n                ...(def.pattern ? { pattern: def.pattern.toString() } : {}),\n                inst,\n                continue: !def.abort,\n            });\n        });\n    else\n        (_b = inst._zod).check ?? (_b.check = () => { });\n});\nexport const $ZodCheckRegex = /*@__PURE__*/ core.$constructor(\"$ZodCheckRegex\", (inst, def) => {\n    $ZodCheckStringFormat.init(inst, def);\n    inst._zod.check = (payload) => {\n        def.pattern.lastIndex = 0;\n        if (def.pattern.test(payload.value))\n            return;\n        payload.issues.push({\n            origin: \"string\",\n            code: \"invalid_format\",\n            format: \"regex\",\n            input: payload.value,\n            pattern: def.pattern.toString(),\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckLowerCase = /*@__PURE__*/ core.$constructor(\"$ZodCheckLowerCase\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.lowercase);\n    $ZodCheckStringFormat.init(inst, def);\n});\nexport const $ZodCheckUpperCase = /*@__PURE__*/ core.$constructor(\"$ZodCheckUpperCase\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.uppercase);\n    $ZodCheckStringFormat.init(inst, def);\n});\nexport const $ZodCheckIncludes = /*@__PURE__*/ core.$constructor(\"$ZodCheckIncludes\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    const escapedRegex = util.escapeRegex(def.includes);\n    const pattern = new RegExp(typeof def.position === \"number\" ? `^.{${def.position}}${escapedRegex}` : escapedRegex);\n    def.pattern = pattern;\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.patterns ?? (bag.patterns = new Set());\n        bag.patterns.add(pattern);\n    });\n    inst._zod.check = (payload) => {\n        if (payload.value.includes(def.includes, def.position))\n            return;\n        payload.issues.push({\n            origin: \"string\",\n            code: \"invalid_format\",\n            format: \"includes\",\n            includes: def.includes,\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckStartsWith = /*@__PURE__*/ core.$constructor(\"$ZodCheckStartsWith\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    const pattern = new RegExp(`^${util.escapeRegex(def.prefix)}.*`);\n    def.pattern ?? (def.pattern = pattern);\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.patterns ?? (bag.patterns = new Set());\n        bag.patterns.add(pattern);\n    });\n    inst._zod.check = (payload) => {\n        if (payload.value.startsWith(def.prefix))\n            return;\n        payload.issues.push({\n            origin: \"string\",\n            code: \"invalid_format\",\n            format: \"starts_with\",\n            prefix: def.prefix,\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckEndsWith = /*@__PURE__*/ core.$constructor(\"$ZodCheckEndsWith\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    const pattern = new RegExp(`.*${util.escapeRegex(def.suffix)}$`);\n    def.pattern ?? (def.pattern = pattern);\n    inst._zod.onattach.push((inst) => {\n        const bag = inst._zod.bag;\n        bag.patterns ?? (bag.patterns = new Set());\n        bag.patterns.add(pattern);\n    });\n    inst._zod.check = (payload) => {\n        if (payload.value.endsWith(def.suffix))\n            return;\n        payload.issues.push({\n            origin: \"string\",\n            code: \"invalid_format\",\n            format: \"ends_with\",\n            suffix: def.suffix,\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\n///////////////////////////////////\n/////    $ZodCheckProperty    /////\n///////////////////////////////////\nfunction handleCheckPropertyResult(result, payload, property) {\n    if (result.issues.length) {\n        payload.issues.push(...util.prefixIssues(property, result.issues));\n    }\n}\nexport const $ZodCheckProperty = /*@__PURE__*/ core.$constructor(\"$ZodCheckProperty\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    inst._zod.check = (payload) => {\n        const result = def.schema._zod.run({\n            value: payload.value[def.property],\n            issues: [],\n        }, {});\n        if (result instanceof Promise) {\n            return result.then((result) => handleCheckPropertyResult(result, payload, def.property));\n        }\n        handleCheckPropertyResult(result, payload, def.property);\n        return;\n    };\n});\nexport const $ZodCheckMimeType = /*@__PURE__*/ core.$constructor(\"$ZodCheckMimeType\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    const mimeSet = new Set(def.mime);\n    inst._zod.onattach.push((inst) => {\n        inst._zod.bag.mime = def.mime;\n    });\n    inst._zod.check = (payload) => {\n        if (mimeSet.has(payload.value.type))\n            return;\n        payload.issues.push({\n            code: \"invalid_value\",\n            values: def.mime,\n            input: payload.value.type,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCheckOverwrite = /*@__PURE__*/ core.$constructor(\"$ZodCheckOverwrite\", (inst, def) => {\n    $ZodCheck.init(inst, def);\n    inst._zod.check = (payload) => {\n        payload.value = def.tx(payload.value);\n    };\n});\n","export class Doc {\n    constructor(args = []) {\n        this.content = [];\n        this.indent = 0;\n        if (this)\n            this.args = args;\n    }\n    indented(fn) {\n        this.indent += 1;\n        fn(this);\n        this.indent -= 1;\n    }\n    write(arg) {\n        if (typeof arg === \"function\") {\n            arg(this, { execution: \"sync\" });\n            arg(this, { execution: \"async\" });\n            return;\n        }\n        const content = arg;\n        const lines = content.split(\"\\n\").filter((x) => x);\n        const minIndent = Math.min(...lines.map((x) => x.length - x.trimStart().length));\n        const dedented = lines.map((x) => x.slice(minIndent)).map((x) => \" \".repeat(this.indent * 2) + x);\n        for (const line of dedented) {\n            this.content.push(line);\n        }\n    }\n    compile() {\n        const F = Function;\n        const args = this?.args;\n        const content = this?.content ?? [``];\n        const lines = [...content.map((x) => `  ${x}`)];\n        // console.log(lines.join(\"\\n\"));\n        return new F(...args, lines.join(\"\\n\"));\n    }\n}\n","export const version = {\n    major: 4,\n    minor: 3,\n    patch: 6,\n};\n","import * as checks from \"./checks.js\";\nimport * as core from \"./core.js\";\nimport { Doc } from \"./doc.js\";\nimport { parse, parseAsync, safeParse, safeParseAsync } from \"./parse.js\";\nimport * as regexes from \"./regexes.js\";\nimport * as util from \"./util.js\";\nimport { version } from \"./versions.js\";\nexport const $ZodType = /*@__PURE__*/ core.$constructor(\"$ZodType\", (inst, def) => {\n    var _a;\n    inst ?? (inst = {});\n    inst._zod.def = def; // set _def property\n    inst._zod.bag = inst._zod.bag || {}; // initialize _bag object\n    inst._zod.version = version;\n    const checks = [...(inst._zod.def.checks ?? [])];\n    // if inst is itself a checks.$ZodCheck, run it as a check\n    if (inst._zod.traits.has(\"$ZodCheck\")) {\n        checks.unshift(inst);\n    }\n    for (const ch of checks) {\n        for (const fn of ch._zod.onattach) {\n            fn(inst);\n        }\n    }\n    if (checks.length === 0) {\n        // deferred initializer\n        // inst._zod.parse is not yet defined\n        (_a = inst._zod).deferred ?? (_a.deferred = []);\n        inst._zod.deferred?.push(() => {\n            inst._zod.run = inst._zod.parse;\n        });\n    }\n    else {\n        const runChecks = (payload, checks, ctx) => {\n            let isAborted = util.aborted(payload);\n            let asyncResult;\n            for (const ch of checks) {\n                if (ch._zod.def.when) {\n                    const shouldRun = ch._zod.def.when(payload);\n                    if (!shouldRun)\n                        continue;\n                }\n                else if (isAborted) {\n                    continue;\n                }\n                const currLen = payload.issues.length;\n                const _ = ch._zod.check(payload);\n                if (_ instanceof Promise && ctx?.async === false) {\n                    throw new core.$ZodAsyncError();\n                }\n                if (asyncResult || _ instanceof Promise) {\n                    asyncResult = (asyncResult ?? Promise.resolve()).then(async () => {\n                        await _;\n                        const nextLen = payload.issues.length;\n                        if (nextLen === currLen)\n                            return;\n                        if (!isAborted)\n                            isAborted = util.aborted(payload, currLen);\n                    });\n                }\n                else {\n                    const nextLen = payload.issues.length;\n                    if (nextLen === currLen)\n                        continue;\n                    if (!isAborted)\n                        isAborted = util.aborted(payload, currLen);\n                }\n            }\n            if (asyncResult) {\n                return asyncResult.then(() => {\n                    return payload;\n                });\n            }\n            return payload;\n        };\n        const handleCanaryResult = (canary, payload, ctx) => {\n            // abort if the canary is aborted\n            if (util.aborted(canary)) {\n                canary.aborted = true;\n                return canary;\n            }\n            // run checks first, then\n            const checkResult = runChecks(payload, checks, ctx);\n            if (checkResult instanceof Promise) {\n                if (ctx.async === false)\n                    throw new core.$ZodAsyncError();\n                return checkResult.then((checkResult) => inst._zod.parse(checkResult, ctx));\n            }\n            return inst._zod.parse(checkResult, ctx);\n        };\n        inst._zod.run = (payload, ctx) => {\n            if (ctx.skipChecks) {\n                return inst._zod.parse(payload, ctx);\n            }\n            if (ctx.direction === \"backward\") {\n                // run canary\n                // initial pass (no checks)\n                const canary = inst._zod.parse({ value: payload.value, issues: [] }, { ...ctx, skipChecks: true });\n                if (canary instanceof Promise) {\n                    return canary.then((canary) => {\n                        return handleCanaryResult(canary, payload, ctx);\n                    });\n                }\n                return handleCanaryResult(canary, payload, ctx);\n            }\n            // forward\n            const result = inst._zod.parse(payload, ctx);\n            if (result instanceof Promise) {\n                if (ctx.async === false)\n                    throw new core.$ZodAsyncError();\n                return result.then((result) => runChecks(result, checks, ctx));\n            }\n            return runChecks(result, checks, ctx);\n        };\n    }\n    // Lazy initialize ~standard to avoid creating objects for every schema\n    util.defineLazy(inst, \"~standard\", () => ({\n        validate: (value) => {\n            try {\n                const r = safeParse(inst, value);\n                return r.success ? { value: r.data } : { issues: r.error?.issues };\n            }\n            catch (_) {\n                return safeParseAsync(inst, value).then((r) => (r.success ? { value: r.data } : { issues: r.error?.issues }));\n            }\n        },\n        vendor: \"zod\",\n        version: 1,\n    }));\n});\nexport { clone } from \"./util.js\";\nexport const $ZodString = /*@__PURE__*/ core.$constructor(\"$ZodString\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.pattern = [...(inst?._zod.bag?.patterns ?? [])].pop() ?? regexes.string(inst._zod.bag);\n    inst._zod.parse = (payload, _) => {\n        if (def.coerce)\n            try {\n                payload.value = String(payload.value);\n            }\n            catch (_) { }\n        if (typeof payload.value === \"string\")\n            return payload;\n        payload.issues.push({\n            expected: \"string\",\n            code: \"invalid_type\",\n            input: payload.value,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodStringFormat = /*@__PURE__*/ core.$constructor(\"$ZodStringFormat\", (inst, def) => {\n    // check initialization must come first\n    checks.$ZodCheckStringFormat.init(inst, def);\n    $ZodString.init(inst, def);\n});\nexport const $ZodGUID = /*@__PURE__*/ core.$constructor(\"$ZodGUID\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.guid);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodUUID = /*@__PURE__*/ core.$constructor(\"$ZodUUID\", (inst, def) => {\n    if (def.version) {\n        const versionMap = {\n            v1: 1,\n            v2: 2,\n            v3: 3,\n            v4: 4,\n            v5: 5,\n            v6: 6,\n            v7: 7,\n            v8: 8,\n        };\n        const v = versionMap[def.version];\n        if (v === undefined)\n            throw new Error(`Invalid UUID version: \"${def.version}\"`);\n        def.pattern ?? (def.pattern = regexes.uuid(v));\n    }\n    else\n        def.pattern ?? (def.pattern = regexes.uuid());\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodEmail = /*@__PURE__*/ core.$constructor(\"$ZodEmail\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.email);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodURL = /*@__PURE__*/ core.$constructor(\"$ZodURL\", (inst, def) => {\n    $ZodStringFormat.init(inst, def);\n    inst._zod.check = (payload) => {\n        try {\n            // Trim whitespace from input\n            const trimmed = payload.value.trim();\n            // @ts-ignore\n            const url = new URL(trimmed);\n            if (def.hostname) {\n                def.hostname.lastIndex = 0;\n                if (!def.hostname.test(url.hostname)) {\n                    payload.issues.push({\n                        code: \"invalid_format\",\n                        format: \"url\",\n                        note: \"Invalid hostname\",\n                        pattern: def.hostname.source,\n                        input: payload.value,\n                        inst,\n                        continue: !def.abort,\n                    });\n                }\n            }\n            if (def.protocol) {\n                def.protocol.lastIndex = 0;\n                if (!def.protocol.test(url.protocol.endsWith(\":\") ? url.protocol.slice(0, -1) : url.protocol)) {\n                    payload.issues.push({\n                        code: \"invalid_format\",\n                        format: \"url\",\n                        note: \"Invalid protocol\",\n                        pattern: def.protocol.source,\n                        input: payload.value,\n                        inst,\n                        continue: !def.abort,\n                    });\n                }\n            }\n            // Set the output value based on normalize flag\n            if (def.normalize) {\n                // Use normalized URL\n                payload.value = url.href;\n            }\n            else {\n                // Preserve the original input (trimmed)\n                payload.value = trimmed;\n            }\n            return;\n        }\n        catch (_) {\n            payload.issues.push({\n                code: \"invalid_format\",\n                format: \"url\",\n                input: payload.value,\n                inst,\n                continue: !def.abort,\n            });\n        }\n    };\n});\nexport const $ZodEmoji = /*@__PURE__*/ core.$constructor(\"$ZodEmoji\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.emoji());\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodNanoID = /*@__PURE__*/ core.$constructor(\"$ZodNanoID\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.nanoid);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodCUID = /*@__PURE__*/ core.$constructor(\"$ZodCUID\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.cuid);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodCUID2 = /*@__PURE__*/ core.$constructor(\"$ZodCUID2\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.cuid2);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodULID = /*@__PURE__*/ core.$constructor(\"$ZodULID\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.ulid);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodXID = /*@__PURE__*/ core.$constructor(\"$ZodXID\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.xid);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodKSUID = /*@__PURE__*/ core.$constructor(\"$ZodKSUID\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.ksuid);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodISODateTime = /*@__PURE__*/ core.$constructor(\"$ZodISODateTime\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.datetime(def));\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodISODate = /*@__PURE__*/ core.$constructor(\"$ZodISODate\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.date);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodISOTime = /*@__PURE__*/ core.$constructor(\"$ZodISOTime\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.time(def));\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodISODuration = /*@__PURE__*/ core.$constructor(\"$ZodISODuration\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.duration);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodIPv4 = /*@__PURE__*/ core.$constructor(\"$ZodIPv4\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.ipv4);\n    $ZodStringFormat.init(inst, def);\n    inst._zod.bag.format = `ipv4`;\n});\nexport const $ZodIPv6 = /*@__PURE__*/ core.$constructor(\"$ZodIPv6\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.ipv6);\n    $ZodStringFormat.init(inst, def);\n    inst._zod.bag.format = `ipv6`;\n    inst._zod.check = (payload) => {\n        try {\n            // @ts-ignore\n            new URL(`http://[${payload.value}]`);\n            // return;\n        }\n        catch {\n            payload.issues.push({\n                code: \"invalid_format\",\n                format: \"ipv6\",\n                input: payload.value,\n                inst,\n                continue: !def.abort,\n            });\n        }\n    };\n});\nexport const $ZodMAC = /*@__PURE__*/ core.$constructor(\"$ZodMAC\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.mac(def.delimiter));\n    $ZodStringFormat.init(inst, def);\n    inst._zod.bag.format = `mac`;\n});\nexport const $ZodCIDRv4 = /*@__PURE__*/ core.$constructor(\"$ZodCIDRv4\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.cidrv4);\n    $ZodStringFormat.init(inst, def);\n});\nexport const $ZodCIDRv6 = /*@__PURE__*/ core.$constructor(\"$ZodCIDRv6\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.cidrv6); // not used for validation\n    $ZodStringFormat.init(inst, def);\n    inst._zod.check = (payload) => {\n        const parts = payload.value.split(\"/\");\n        try {\n            if (parts.length !== 2)\n                throw new Error();\n            const [address, prefix] = parts;\n            if (!prefix)\n                throw new Error();\n            const prefixNum = Number(prefix);\n            if (`${prefixNum}` !== prefix)\n                throw new Error();\n            if (prefixNum < 0 || prefixNum > 128)\n                throw new Error();\n            // @ts-ignore\n            new URL(`http://[${address}]`);\n        }\n        catch {\n            payload.issues.push({\n                code: \"invalid_format\",\n                format: \"cidrv6\",\n                input: payload.value,\n                inst,\n                continue: !def.abort,\n            });\n        }\n    };\n});\n//////////////////////////////   ZodBase64   //////////////////////////////\nexport function isValidBase64(data) {\n    if (data === \"\")\n        return true;\n    if (data.length % 4 !== 0)\n        return false;\n    try {\n        // @ts-ignore\n        atob(data);\n        return true;\n    }\n    catch {\n        return false;\n    }\n}\nexport const $ZodBase64 = /*@__PURE__*/ core.$constructor(\"$ZodBase64\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.base64);\n    $ZodStringFormat.init(inst, def);\n    inst._zod.bag.contentEncoding = \"base64\";\n    inst._zod.check = (payload) => {\n        if (isValidBase64(payload.value))\n            return;\n        payload.issues.push({\n            code: \"invalid_format\",\n            format: \"base64\",\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\n//////////////////////////////   ZodBase64   //////////////////////////////\nexport function isValidBase64URL(data) {\n    if (!regexes.base64url.test(data))\n        return false;\n    const base64 = data.replace(/[-_]/g, (c) => (c === \"-\" ? \"+\" : \"/\"));\n    const padded = base64.padEnd(Math.ceil(base64.length / 4) * 4, \"=\");\n    return isValidBase64(padded);\n}\nexport const $ZodBase64URL = /*@__PURE__*/ core.$constructor(\"$ZodBase64URL\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.base64url);\n    $ZodStringFormat.init(inst, def);\n    inst._zod.bag.contentEncoding = \"base64url\";\n    inst._zod.check = (payload) => {\n        if (isValidBase64URL(payload.value))\n            return;\n        payload.issues.push({\n            code: \"invalid_format\",\n            format: \"base64url\",\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodE164 = /*@__PURE__*/ core.$constructor(\"$ZodE164\", (inst, def) => {\n    def.pattern ?? (def.pattern = regexes.e164);\n    $ZodStringFormat.init(inst, def);\n});\n//////////////////////////////   ZodJWT   //////////////////////////////\nexport function isValidJWT(token, algorithm = null) {\n    try {\n        const tokensParts = token.split(\".\");\n        if (tokensParts.length !== 3)\n            return false;\n        const [header] = tokensParts;\n        if (!header)\n            return false;\n        // @ts-ignore\n        const parsedHeader = JSON.parse(atob(header));\n        if (\"typ\" in parsedHeader && parsedHeader?.typ !== \"JWT\")\n            return false;\n        if (!parsedHeader.alg)\n            return false;\n        if (algorithm && (!(\"alg\" in parsedHeader) || parsedHeader.alg !== algorithm))\n            return false;\n        return true;\n    }\n    catch {\n        return false;\n    }\n}\nexport const $ZodJWT = /*@__PURE__*/ core.$constructor(\"$ZodJWT\", (inst, def) => {\n    $ZodStringFormat.init(inst, def);\n    inst._zod.check = (payload) => {\n        if (isValidJWT(payload.value, def.alg))\n            return;\n        payload.issues.push({\n            code: \"invalid_format\",\n            format: \"jwt\",\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodCustomStringFormat = /*@__PURE__*/ core.$constructor(\"$ZodCustomStringFormat\", (inst, def) => {\n    $ZodStringFormat.init(inst, def);\n    inst._zod.check = (payload) => {\n        if (def.fn(payload.value))\n            return;\n        payload.issues.push({\n            code: \"invalid_format\",\n            format: def.format,\n            input: payload.value,\n            inst,\n            continue: !def.abort,\n        });\n    };\n});\nexport const $ZodNumber = /*@__PURE__*/ core.$constructor(\"$ZodNumber\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.pattern = inst._zod.bag.pattern ?? regexes.number;\n    inst._zod.parse = (payload, _ctx) => {\n        if (def.coerce)\n            try {\n                payload.value = Number(payload.value);\n            }\n            catch (_) { }\n        const input = payload.value;\n        if (typeof input === \"number\" && !Number.isNaN(input) && Number.isFinite(input)) {\n            return payload;\n        }\n        const received = typeof input === \"number\"\n            ? Number.isNaN(input)\n                ? \"NaN\"\n                : !Number.isFinite(input)\n                    ? \"Infinity\"\n                    : undefined\n            : undefined;\n        payload.issues.push({\n            expected: \"number\",\n            code: \"invalid_type\",\n            input,\n            inst,\n            ...(received ? { received } : {}),\n        });\n        return payload;\n    };\n});\nexport const $ZodNumberFormat = /*@__PURE__*/ core.$constructor(\"$ZodNumberFormat\", (inst, def) => {\n    checks.$ZodCheckNumberFormat.init(inst, def);\n    $ZodNumber.init(inst, def); // no format checks\n});\nexport const $ZodBoolean = /*@__PURE__*/ core.$constructor(\"$ZodBoolean\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.pattern = regexes.boolean;\n    inst._zod.parse = (payload, _ctx) => {\n        if (def.coerce)\n            try {\n                payload.value = Boolean(payload.value);\n            }\n            catch (_) { }\n        const input = payload.value;\n        if (typeof input === \"boolean\")\n            return payload;\n        payload.issues.push({\n            expected: \"boolean\",\n            code: \"invalid_type\",\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodBigInt = /*@__PURE__*/ core.$constructor(\"$ZodBigInt\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.pattern = regexes.bigint;\n    inst._zod.parse = (payload, _ctx) => {\n        if (def.coerce)\n            try {\n                payload.value = BigInt(payload.value);\n            }\n            catch (_) { }\n        if (typeof payload.value === \"bigint\")\n            return payload;\n        payload.issues.push({\n            expected: \"bigint\",\n            code: \"invalid_type\",\n            input: payload.value,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodBigIntFormat = /*@__PURE__*/ core.$constructor(\"$ZodBigIntFormat\", (inst, def) => {\n    checks.$ZodCheckBigIntFormat.init(inst, def);\n    $ZodBigInt.init(inst, def); // no format checks\n});\nexport const $ZodSymbol = /*@__PURE__*/ core.$constructor(\"$ZodSymbol\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, _ctx) => {\n        const input = payload.value;\n        if (typeof input === \"symbol\")\n            return payload;\n        payload.issues.push({\n            expected: \"symbol\",\n            code: \"invalid_type\",\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodUndefined = /*@__PURE__*/ core.$constructor(\"$ZodUndefined\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.pattern = regexes.undefined;\n    inst._zod.values = new Set([undefined]);\n    inst._zod.optin = \"optional\";\n    inst._zod.optout = \"optional\";\n    inst._zod.parse = (payload, _ctx) => {\n        const input = payload.value;\n        if (typeof input === \"undefined\")\n            return payload;\n        payload.issues.push({\n            expected: \"undefined\",\n            code: \"invalid_type\",\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodNull = /*@__PURE__*/ core.$constructor(\"$ZodNull\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.pattern = regexes.null;\n    inst._zod.values = new Set([null]);\n    inst._zod.parse = (payload, _ctx) => {\n        const input = payload.value;\n        if (input === null)\n            return payload;\n        payload.issues.push({\n            expected: \"null\",\n            code: \"invalid_type\",\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodAny = /*@__PURE__*/ core.$constructor(\"$ZodAny\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload) => payload;\n});\nexport const $ZodUnknown = /*@__PURE__*/ core.$constructor(\"$ZodUnknown\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload) => payload;\n});\nexport const $ZodNever = /*@__PURE__*/ core.$constructor(\"$ZodNever\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, _ctx) => {\n        payload.issues.push({\n            expected: \"never\",\n            code: \"invalid_type\",\n            input: payload.value,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodVoid = /*@__PURE__*/ core.$constructor(\"$ZodVoid\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, _ctx) => {\n        const input = payload.value;\n        if (typeof input === \"undefined\")\n            return payload;\n        payload.issues.push({\n            expected: \"void\",\n            code: \"invalid_type\",\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodDate = /*@__PURE__*/ core.$constructor(\"$ZodDate\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, _ctx) => {\n        if (def.coerce) {\n            try {\n                payload.value = new Date(payload.value);\n            }\n            catch (_err) { }\n        }\n        const input = payload.value;\n        const isDate = input instanceof Date;\n        const isValidDate = isDate && !Number.isNaN(input.getTime());\n        if (isValidDate)\n            return payload;\n        payload.issues.push({\n            expected: \"date\",\n            code: \"invalid_type\",\n            input,\n            ...(isDate ? { received: \"Invalid Date\" } : {}),\n            inst,\n        });\n        return payload;\n    };\n});\nfunction handleArrayResult(result, final, index) {\n    if (result.issues.length) {\n        final.issues.push(...util.prefixIssues(index, result.issues));\n    }\n    final.value[index] = result.value;\n}\nexport const $ZodArray = /*@__PURE__*/ core.$constructor(\"$ZodArray\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        const input = payload.value;\n        if (!Array.isArray(input)) {\n            payload.issues.push({\n                expected: \"array\",\n                code: \"invalid_type\",\n                input,\n                inst,\n            });\n            return payload;\n        }\n        payload.value = Array(input.length);\n        const proms = [];\n        for (let i = 0; i < input.length; i++) {\n            const item = input[i];\n            const result = def.element._zod.run({\n                value: item,\n                issues: [],\n            }, ctx);\n            if (result instanceof Promise) {\n                proms.push(result.then((result) => handleArrayResult(result, payload, i)));\n            }\n            else {\n                handleArrayResult(result, payload, i);\n            }\n        }\n        if (proms.length) {\n            return Promise.all(proms).then(() => payload);\n        }\n        return payload; //handleArrayResultsAsync(parseResults, final);\n    };\n});\nfunction handlePropertyResult(result, final, key, input, isOptionalOut) {\n    if (result.issues.length) {\n        // For optional-out schemas, ignore errors on absent keys\n        if (isOptionalOut && !(key in input)) {\n            return;\n        }\n        final.issues.push(...util.prefixIssues(key, result.issues));\n    }\n    if (result.value === undefined) {\n        if (key in input) {\n            final.value[key] = undefined;\n        }\n    }\n    else {\n        final.value[key] = result.value;\n    }\n}\nfunction normalizeDef(def) {\n    const keys = Object.keys(def.shape);\n    for (const k of keys) {\n        if (!def.shape?.[k]?._zod?.traits?.has(\"$ZodType\")) {\n            throw new Error(`Invalid element at key \"${k}\": expected a Zod schema`);\n        }\n    }\n    const okeys = util.optionalKeys(def.shape);\n    return {\n        ...def,\n        keys,\n        keySet: new Set(keys),\n        numKeys: keys.length,\n        optionalKeys: new Set(okeys),\n    };\n}\nfunction handleCatchall(proms, input, payload, ctx, def, inst) {\n    const unrecognized = [];\n    // iterate over input keys\n    const keySet = def.keySet;\n    const _catchall = def.catchall._zod;\n    const t = _catchall.def.type;\n    const isOptionalOut = _catchall.optout === \"optional\";\n    for (const key in input) {\n        if (keySet.has(key))\n            continue;\n        if (t === \"never\") {\n            unrecognized.push(key);\n            continue;\n        }\n        const r = _catchall.run({ value: input[key], issues: [] }, ctx);\n        if (r instanceof Promise) {\n            proms.push(r.then((r) => handlePropertyResult(r, payload, key, input, isOptionalOut)));\n        }\n        else {\n            handlePropertyResult(r, payload, key, input, isOptionalOut);\n        }\n    }\n    if (unrecognized.length) {\n        payload.issues.push({\n            code: \"unrecognized_keys\",\n            keys: unrecognized,\n            input,\n            inst,\n        });\n    }\n    if (!proms.length)\n        return payload;\n    return Promise.all(proms).then(() => {\n        return payload;\n    });\n}\nexport const $ZodObject = /*@__PURE__*/ core.$constructor(\"$ZodObject\", (inst, def) => {\n    // requires cast because technically $ZodObject doesn't extend\n    $ZodType.init(inst, def);\n    // const sh = def.shape;\n    const desc = Object.getOwnPropertyDescriptor(def, \"shape\");\n    if (!desc?.get) {\n        const sh = def.shape;\n        Object.defineProperty(def, \"shape\", {\n            get: () => {\n                const newSh = { ...sh };\n                Object.defineProperty(def, \"shape\", {\n                    value: newSh,\n                });\n                return newSh;\n            },\n        });\n    }\n    const _normalized = util.cached(() => normalizeDef(def));\n    util.defineLazy(inst._zod, \"propValues\", () => {\n        const shape = def.shape;\n        const propValues = {};\n        for (const key in shape) {\n            const field = shape[key]._zod;\n            if (field.values) {\n                propValues[key] ?? (propValues[key] = new Set());\n                for (const v of field.values)\n                    propValues[key].add(v);\n            }\n        }\n        return propValues;\n    });\n    const isObject = util.isObject;\n    const catchall = def.catchall;\n    let value;\n    inst._zod.parse = (payload, ctx) => {\n        value ?? (value = _normalized.value);\n        const input = payload.value;\n        if (!isObject(input)) {\n            payload.issues.push({\n                expected: \"object\",\n                code: \"invalid_type\",\n                input,\n                inst,\n            });\n            return payload;\n        }\n        payload.value = {};\n        const proms = [];\n        const shape = value.shape;\n        for (const key of value.keys) {\n            const el = shape[key];\n            const isOptionalOut = el._zod.optout === \"optional\";\n            const r = el._zod.run({ value: input[key], issues: [] }, ctx);\n            if (r instanceof Promise) {\n                proms.push(r.then((r) => handlePropertyResult(r, payload, key, input, isOptionalOut)));\n            }\n            else {\n                handlePropertyResult(r, payload, key, input, isOptionalOut);\n            }\n        }\n        if (!catchall) {\n            return proms.length ? Promise.all(proms).then(() => payload) : payload;\n        }\n        return handleCatchall(proms, input, payload, ctx, _normalized.value, inst);\n    };\n});\nexport const $ZodObjectJIT = /*@__PURE__*/ core.$constructor(\"$ZodObjectJIT\", (inst, def) => {\n    // requires cast because technically $ZodObject doesn't extend\n    $ZodObject.init(inst, def);\n    const superParse = inst._zod.parse;\n    const _normalized = util.cached(() => normalizeDef(def));\n    const generateFastpass = (shape) => {\n        const doc = new Doc([\"shape\", \"payload\", \"ctx\"]);\n        const normalized = _normalized.value;\n        const parseStr = (key) => {\n            const k = util.esc(key);\n            return `shape[${k}]._zod.run({ value: input[${k}], issues: [] }, ctx)`;\n        };\n        doc.write(`const input = payload.value;`);\n        const ids = Object.create(null);\n        let counter = 0;\n        for (const key of normalized.keys) {\n            ids[key] = `key_${counter++}`;\n        }\n        // A: preserve key order {\n        doc.write(`const newResult = {};`);\n        for (const key of normalized.keys) {\n            const id = ids[key];\n            const k = util.esc(key);\n            const schema = shape[key];\n            const isOptionalOut = schema?._zod?.optout === \"optional\";\n            doc.write(`const ${id} = ${parseStr(key)};`);\n            if (isOptionalOut) {\n                // For optional-out schemas, ignore errors on absent keys\n                doc.write(`\n        if (${id}.issues.length) {\n          if (${k} in input) {\n            payload.issues = payload.issues.concat(${id}.issues.map(iss => ({\n              ...iss,\n              path: iss.path ? [${k}, ...iss.path] : [${k}]\n            })));\n          }\n        }\n        \n        if (${id}.value === undefined) {\n          if (${k} in input) {\n            newResult[${k}] = undefined;\n          }\n        } else {\n          newResult[${k}] = ${id}.value;\n        }\n        \n      `);\n            }\n            else {\n                doc.write(`\n        if (${id}.issues.length) {\n          payload.issues = payload.issues.concat(${id}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${k}, ...iss.path] : [${k}]\n          })));\n        }\n        \n        if (${id}.value === undefined) {\n          if (${k} in input) {\n            newResult[${k}] = undefined;\n          }\n        } else {\n          newResult[${k}] = ${id}.value;\n        }\n        \n      `);\n            }\n        }\n        doc.write(`payload.value = newResult;`);\n        doc.write(`return payload;`);\n        const fn = doc.compile();\n        return (payload, ctx) => fn(shape, payload, ctx);\n    };\n    let fastpass;\n    const isObject = util.isObject;\n    const jit = !core.globalConfig.jitless;\n    const allowsEval = util.allowsEval;\n    const fastEnabled = jit && allowsEval.value; // && !def.catchall;\n    const catchall = def.catchall;\n    let value;\n    inst._zod.parse = (payload, ctx) => {\n        value ?? (value = _normalized.value);\n        const input = payload.value;\n        if (!isObject(input)) {\n            payload.issues.push({\n                expected: \"object\",\n                code: \"invalid_type\",\n                input,\n                inst,\n            });\n            return payload;\n        }\n        if (jit && fastEnabled && ctx?.async === false && ctx.jitless !== true) {\n            // always synchronous\n            if (!fastpass)\n                fastpass = generateFastpass(def.shape);\n            payload = fastpass(payload, ctx);\n            if (!catchall)\n                return payload;\n            return handleCatchall([], input, payload, ctx, value, inst);\n        }\n        return superParse(payload, ctx);\n    };\n});\nfunction handleUnionResults(results, final, inst, ctx) {\n    for (const result of results) {\n        if (result.issues.length === 0) {\n            final.value = result.value;\n            return final;\n        }\n    }\n    const nonaborted = results.filter((r) => !util.aborted(r));\n    if (nonaborted.length === 1) {\n        final.value = nonaborted[0].value;\n        return nonaborted[0];\n    }\n    final.issues.push({\n        code: \"invalid_union\",\n        input: final.value,\n        inst,\n        errors: results.map((result) => result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config()))),\n    });\n    return final;\n}\nexport const $ZodUnion = /*@__PURE__*/ core.$constructor(\"$ZodUnion\", (inst, def) => {\n    $ZodType.init(inst, def);\n    util.defineLazy(inst._zod, \"optin\", () => def.options.some((o) => o._zod.optin === \"optional\") ? \"optional\" : undefined);\n    util.defineLazy(inst._zod, \"optout\", () => def.options.some((o) => o._zod.optout === \"optional\") ? \"optional\" : undefined);\n    util.defineLazy(inst._zod, \"values\", () => {\n        if (def.options.every((o) => o._zod.values)) {\n            return new Set(def.options.flatMap((option) => Array.from(option._zod.values)));\n        }\n        return undefined;\n    });\n    util.defineLazy(inst._zod, \"pattern\", () => {\n        if (def.options.every((o) => o._zod.pattern)) {\n            const patterns = def.options.map((o) => o._zod.pattern);\n            return new RegExp(`^(${patterns.map((p) => util.cleanRegex(p.source)).join(\"|\")})$`);\n        }\n        return undefined;\n    });\n    const single = def.options.length === 1;\n    const first = def.options[0]._zod.run;\n    inst._zod.parse = (payload, ctx) => {\n        if (single) {\n            return first(payload, ctx);\n        }\n        let async = false;\n        const results = [];\n        for (const option of def.options) {\n            const result = option._zod.run({\n                value: payload.value,\n                issues: [],\n            }, ctx);\n            if (result instanceof Promise) {\n                results.push(result);\n                async = true;\n            }\n            else {\n                if (result.issues.length === 0)\n                    return result;\n                results.push(result);\n            }\n        }\n        if (!async)\n            return handleUnionResults(results, payload, inst, ctx);\n        return Promise.all(results).then((results) => {\n            return handleUnionResults(results, payload, inst, ctx);\n        });\n    };\n});\nfunction handleExclusiveUnionResults(results, final, inst, ctx) {\n    const successes = results.filter((r) => r.issues.length === 0);\n    if (successes.length === 1) {\n        final.value = successes[0].value;\n        return final;\n    }\n    if (successes.length === 0) {\n        // No matches - same as regular union\n        final.issues.push({\n            code: \"invalid_union\",\n            input: final.value,\n            inst,\n            errors: results.map((result) => result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config()))),\n        });\n    }\n    else {\n        // Multiple matches - exclusive union failure\n        final.issues.push({\n            code: \"invalid_union\",\n            input: final.value,\n            inst,\n            errors: [],\n            inclusive: false,\n        });\n    }\n    return final;\n}\nexport const $ZodXor = /*@__PURE__*/ core.$constructor(\"$ZodXor\", (inst, def) => {\n    $ZodUnion.init(inst, def);\n    def.inclusive = false;\n    const single = def.options.length === 1;\n    const first = def.options[0]._zod.run;\n    inst._zod.parse = (payload, ctx) => {\n        if (single) {\n            return first(payload, ctx);\n        }\n        let async = false;\n        const results = [];\n        for (const option of def.options) {\n            const result = option._zod.run({\n                value: payload.value,\n                issues: [],\n            }, ctx);\n            if (result instanceof Promise) {\n                results.push(result);\n                async = true;\n            }\n            else {\n                results.push(result);\n            }\n        }\n        if (!async)\n            return handleExclusiveUnionResults(results, payload, inst, ctx);\n        return Promise.all(results).then((results) => {\n            return handleExclusiveUnionResults(results, payload, inst, ctx);\n        });\n    };\n});\nexport const $ZodDiscriminatedUnion = \n/*@__PURE__*/\ncore.$constructor(\"$ZodDiscriminatedUnion\", (inst, def) => {\n    def.inclusive = false;\n    $ZodUnion.init(inst, def);\n    const _super = inst._zod.parse;\n    util.defineLazy(inst._zod, \"propValues\", () => {\n        const propValues = {};\n        for (const option of def.options) {\n            const pv = option._zod.propValues;\n            if (!pv || Object.keys(pv).length === 0)\n                throw new Error(`Invalid discriminated union option at index \"${def.options.indexOf(option)}\"`);\n            for (const [k, v] of Object.entries(pv)) {\n                if (!propValues[k])\n                    propValues[k] = new Set();\n                for (const val of v) {\n                    propValues[k].add(val);\n                }\n            }\n        }\n        return propValues;\n    });\n    const disc = util.cached(() => {\n        const opts = def.options;\n        const map = new Map();\n        for (const o of opts) {\n            const values = o._zod.propValues?.[def.discriminator];\n            if (!values || values.size === 0)\n                throw new Error(`Invalid discriminated union option at index \"${def.options.indexOf(o)}\"`);\n            for (const v of values) {\n                if (map.has(v)) {\n                    throw new Error(`Duplicate discriminator value \"${String(v)}\"`);\n                }\n                map.set(v, o);\n            }\n        }\n        return map;\n    });\n    inst._zod.parse = (payload, ctx) => {\n        const input = payload.value;\n        if (!util.isObject(input)) {\n            payload.issues.push({\n                code: \"invalid_type\",\n                expected: \"object\",\n                input,\n                inst,\n            });\n            return payload;\n        }\n        const opt = disc.value.get(input?.[def.discriminator]);\n        if (opt) {\n            return opt._zod.run(payload, ctx);\n        }\n        if (def.unionFallback) {\n            return _super(payload, ctx);\n        }\n        // no matching discriminator\n        payload.issues.push({\n            code: \"invalid_union\",\n            errors: [],\n            note: \"No matching discriminator\",\n            discriminator: def.discriminator,\n            input,\n            path: [def.discriminator],\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodIntersection = /*@__PURE__*/ core.$constructor(\"$ZodIntersection\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        const input = payload.value;\n        const left = def.left._zod.run({ value: input, issues: [] }, ctx);\n        const right = def.right._zod.run({ value: input, issues: [] }, ctx);\n        const async = left instanceof Promise || right instanceof Promise;\n        if (async) {\n            return Promise.all([left, right]).then(([left, right]) => {\n                return handleIntersectionResults(payload, left, right);\n            });\n        }\n        return handleIntersectionResults(payload, left, right);\n    };\n});\nfunction mergeValues(a, b) {\n    // const aType = parse.t(a);\n    // const bType = parse.t(b);\n    if (a === b) {\n        return { valid: true, data: a };\n    }\n    if (a instanceof Date && b instanceof Date && +a === +b) {\n        return { valid: true, data: a };\n    }\n    if (util.isPlainObject(a) && util.isPlainObject(b)) {\n        const bKeys = Object.keys(b);\n        const sharedKeys = Object.keys(a).filter((key) => bKeys.indexOf(key) !== -1);\n        const newObj = { ...a, ...b };\n        for (const key of sharedKeys) {\n            const sharedValue = mergeValues(a[key], b[key]);\n            if (!sharedValue.valid) {\n                return {\n                    valid: false,\n                    mergeErrorPath: [key, ...sharedValue.mergeErrorPath],\n                };\n            }\n            newObj[key] = sharedValue.data;\n        }\n        return { valid: true, data: newObj };\n    }\n    if (Array.isArray(a) && Array.isArray(b)) {\n        if (a.length !== b.length) {\n            return { valid: false, mergeErrorPath: [] };\n        }\n        const newArray = [];\n        for (let index = 0; index < a.length; index++) {\n            const itemA = a[index];\n            const itemB = b[index];\n            const sharedValue = mergeValues(itemA, itemB);\n            if (!sharedValue.valid) {\n                return {\n                    valid: false,\n                    mergeErrorPath: [index, ...sharedValue.mergeErrorPath],\n                };\n            }\n            newArray.push(sharedValue.data);\n        }\n        return { valid: true, data: newArray };\n    }\n    return { valid: false, mergeErrorPath: [] };\n}\nfunction handleIntersectionResults(result, left, right) {\n    // Track which side(s) report each key as unrecognized\n    const unrecKeys = new Map();\n    let unrecIssue;\n    for (const iss of left.issues) {\n        if (iss.code === \"unrecognized_keys\") {\n            unrecIssue ?? (unrecIssue = iss);\n            for (const k of iss.keys) {\n                if (!unrecKeys.has(k))\n                    unrecKeys.set(k, {});\n                unrecKeys.get(k).l = true;\n            }\n        }\n        else {\n            result.issues.push(iss);\n        }\n    }\n    for (const iss of right.issues) {\n        if (iss.code === \"unrecognized_keys\") {\n            for (const k of iss.keys) {\n                if (!unrecKeys.has(k))\n                    unrecKeys.set(k, {});\n                unrecKeys.get(k).r = true;\n            }\n        }\n        else {\n            result.issues.push(iss);\n        }\n    }\n    // Report only keys unrecognized by BOTH sides\n    const bothKeys = [...unrecKeys].filter(([, f]) => f.l && f.r).map(([k]) => k);\n    if (bothKeys.length && unrecIssue) {\n        result.issues.push({ ...unrecIssue, keys: bothKeys });\n    }\n    if (util.aborted(result))\n        return result;\n    const merged = mergeValues(left.value, right.value);\n    if (!merged.valid) {\n        throw new Error(`Unmergable intersection. Error path: ` + `${JSON.stringify(merged.mergeErrorPath)}`);\n    }\n    result.value = merged.data;\n    return result;\n}\nexport const $ZodTuple = /*@__PURE__*/ core.$constructor(\"$ZodTuple\", (inst, def) => {\n    $ZodType.init(inst, def);\n    const items = def.items;\n    inst._zod.parse = (payload, ctx) => {\n        const input = payload.value;\n        if (!Array.isArray(input)) {\n            payload.issues.push({\n                input,\n                inst,\n                expected: \"tuple\",\n                code: \"invalid_type\",\n            });\n            return payload;\n        }\n        payload.value = [];\n        const proms = [];\n        const reversedIndex = [...items].reverse().findIndex((item) => item._zod.optin !== \"optional\");\n        const optStart = reversedIndex === -1 ? 0 : items.length - reversedIndex;\n        if (!def.rest) {\n            const tooBig = input.length > items.length;\n            const tooSmall = input.length < optStart - 1;\n            if (tooBig || tooSmall) {\n                payload.issues.push({\n                    ...(tooBig\n                        ? { code: \"too_big\", maximum: items.length, inclusive: true }\n                        : { code: \"too_small\", minimum: items.length }),\n                    input,\n                    inst,\n                    origin: \"array\",\n                });\n                return payload;\n            }\n        }\n        let i = -1;\n        for (const item of items) {\n            i++;\n            if (i >= input.length)\n                if (i >= optStart)\n                    continue;\n            const result = item._zod.run({\n                value: input[i],\n                issues: [],\n            }, ctx);\n            if (result instanceof Promise) {\n                proms.push(result.then((result) => handleTupleResult(result, payload, i)));\n            }\n            else {\n                handleTupleResult(result, payload, i);\n            }\n        }\n        if (def.rest) {\n            const rest = input.slice(items.length);\n            for (const el of rest) {\n                i++;\n                const result = def.rest._zod.run({\n                    value: el,\n                    issues: [],\n                }, ctx);\n                if (result instanceof Promise) {\n                    proms.push(result.then((result) => handleTupleResult(result, payload, i)));\n                }\n                else {\n                    handleTupleResult(result, payload, i);\n                }\n            }\n        }\n        if (proms.length)\n            return Promise.all(proms).then(() => payload);\n        return payload;\n    };\n});\nfunction handleTupleResult(result, final, index) {\n    if (result.issues.length) {\n        final.issues.push(...util.prefixIssues(index, result.issues));\n    }\n    final.value[index] = result.value;\n}\nexport const $ZodRecord = /*@__PURE__*/ core.$constructor(\"$ZodRecord\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        const input = payload.value;\n        if (!util.isPlainObject(input)) {\n            payload.issues.push({\n                expected: \"record\",\n                code: \"invalid_type\",\n                input,\n                inst,\n            });\n            return payload;\n        }\n        const proms = [];\n        const values = def.keyType._zod.values;\n        if (values) {\n            payload.value = {};\n            const recordKeys = new Set();\n            for (const key of values) {\n                if (typeof key === \"string\" || typeof key === \"number\" || typeof key === \"symbol\") {\n                    recordKeys.add(typeof key === \"number\" ? key.toString() : key);\n                    const result = def.valueType._zod.run({ value: input[key], issues: [] }, ctx);\n                    if (result instanceof Promise) {\n                        proms.push(result.then((result) => {\n                            if (result.issues.length) {\n                                payload.issues.push(...util.prefixIssues(key, result.issues));\n                            }\n                            payload.value[key] = result.value;\n                        }));\n                    }\n                    else {\n                        if (result.issues.length) {\n                            payload.issues.push(...util.prefixIssues(key, result.issues));\n                        }\n                        payload.value[key] = result.value;\n                    }\n                }\n            }\n            let unrecognized;\n            for (const key in input) {\n                if (!recordKeys.has(key)) {\n                    unrecognized = unrecognized ?? [];\n                    unrecognized.push(key);\n                }\n            }\n            if (unrecognized && unrecognized.length > 0) {\n                payload.issues.push({\n                    code: \"unrecognized_keys\",\n                    input,\n                    inst,\n                    keys: unrecognized,\n                });\n            }\n        }\n        else {\n            payload.value = {};\n            for (const key of Reflect.ownKeys(input)) {\n                if (key === \"__proto__\")\n                    continue;\n                let keyResult = def.keyType._zod.run({ value: key, issues: [] }, ctx);\n                if (keyResult instanceof Promise) {\n                    throw new Error(\"Async schemas not supported in object keys currently\");\n                }\n                // Numeric string fallback: if key is a numeric string and failed, retry with Number(key)\n                // This handles z.number(), z.literal([1, 2, 3]), and unions containing numeric literals\n                const checkNumericKey = typeof key === \"string\" && regexes.number.test(key) && keyResult.issues.length;\n                if (checkNumericKey) {\n                    const retryResult = def.keyType._zod.run({ value: Number(key), issues: [] }, ctx);\n                    if (retryResult instanceof Promise) {\n                        throw new Error(\"Async schemas not supported in object keys currently\");\n                    }\n                    if (retryResult.issues.length === 0) {\n                        keyResult = retryResult;\n                    }\n                }\n                if (keyResult.issues.length) {\n                    if (def.mode === \"loose\") {\n                        // Pass through unchanged\n                        payload.value[key] = input[key];\n                    }\n                    else {\n                        // Default \"strict\" behavior: error on invalid key\n                        payload.issues.push({\n                            code: \"invalid_key\",\n                            origin: \"record\",\n                            issues: keyResult.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config())),\n                            input: key,\n                            path: [key],\n                            inst,\n                        });\n                    }\n                    continue;\n                }\n                const result = def.valueType._zod.run({ value: input[key], issues: [] }, ctx);\n                if (result instanceof Promise) {\n                    proms.push(result.then((result) => {\n                        if (result.issues.length) {\n                            payload.issues.push(...util.prefixIssues(key, result.issues));\n                        }\n                        payload.value[keyResult.value] = result.value;\n                    }));\n                }\n                else {\n                    if (result.issues.length) {\n                        payload.issues.push(...util.prefixIssues(key, result.issues));\n                    }\n                    payload.value[keyResult.value] = result.value;\n                }\n            }\n        }\n        if (proms.length) {\n            return Promise.all(proms).then(() => payload);\n        }\n        return payload;\n    };\n});\nexport const $ZodMap = /*@__PURE__*/ core.$constructor(\"$ZodMap\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        const input = payload.value;\n        if (!(input instanceof Map)) {\n            payload.issues.push({\n                expected: \"map\",\n                code: \"invalid_type\",\n                input,\n                inst,\n            });\n            return payload;\n        }\n        const proms = [];\n        payload.value = new Map();\n        for (const [key, value] of input) {\n            const keyResult = def.keyType._zod.run({ value: key, issues: [] }, ctx);\n            const valueResult = def.valueType._zod.run({ value: value, issues: [] }, ctx);\n            if (keyResult instanceof Promise || valueResult instanceof Promise) {\n                proms.push(Promise.all([keyResult, valueResult]).then(([keyResult, valueResult]) => {\n                    handleMapResult(keyResult, valueResult, payload, key, input, inst, ctx);\n                }));\n            }\n            else {\n                handleMapResult(keyResult, valueResult, payload, key, input, inst, ctx);\n            }\n        }\n        if (proms.length)\n            return Promise.all(proms).then(() => payload);\n        return payload;\n    };\n});\nfunction handleMapResult(keyResult, valueResult, final, key, input, inst, ctx) {\n    if (keyResult.issues.length) {\n        if (util.propertyKeyTypes.has(typeof key)) {\n            final.issues.push(...util.prefixIssues(key, keyResult.issues));\n        }\n        else {\n            final.issues.push({\n                code: \"invalid_key\",\n                origin: \"map\",\n                input,\n                inst,\n                issues: keyResult.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config())),\n            });\n        }\n    }\n    if (valueResult.issues.length) {\n        if (util.propertyKeyTypes.has(typeof key)) {\n            final.issues.push(...util.prefixIssues(key, valueResult.issues));\n        }\n        else {\n            final.issues.push({\n                origin: \"map\",\n                code: \"invalid_element\",\n                input,\n                inst,\n                key: key,\n                issues: valueResult.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config())),\n            });\n        }\n    }\n    final.value.set(keyResult.value, valueResult.value);\n}\nexport const $ZodSet = /*@__PURE__*/ core.$constructor(\"$ZodSet\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        const input = payload.value;\n        if (!(input instanceof Set)) {\n            payload.issues.push({\n                input,\n                inst,\n                expected: \"set\",\n                code: \"invalid_type\",\n            });\n            return payload;\n        }\n        const proms = [];\n        payload.value = new Set();\n        for (const item of input) {\n            const result = def.valueType._zod.run({ value: item, issues: [] }, ctx);\n            if (result instanceof Promise) {\n                proms.push(result.then((result) => handleSetResult(result, payload)));\n            }\n            else\n                handleSetResult(result, payload);\n        }\n        if (proms.length)\n            return Promise.all(proms).then(() => payload);\n        return payload;\n    };\n});\nfunction handleSetResult(result, final) {\n    if (result.issues.length) {\n        final.issues.push(...result.issues);\n    }\n    final.value.add(result.value);\n}\nexport const $ZodEnum = /*@__PURE__*/ core.$constructor(\"$ZodEnum\", (inst, def) => {\n    $ZodType.init(inst, def);\n    const values = util.getEnumValues(def.entries);\n    const valuesSet = new Set(values);\n    inst._zod.values = valuesSet;\n    inst._zod.pattern = new RegExp(`^(${values\n        .filter((k) => util.propertyKeyTypes.has(typeof k))\n        .map((o) => (typeof o === \"string\" ? util.escapeRegex(o) : o.toString()))\n        .join(\"|\")})$`);\n    inst._zod.parse = (payload, _ctx) => {\n        const input = payload.value;\n        if (valuesSet.has(input)) {\n            return payload;\n        }\n        payload.issues.push({\n            code: \"invalid_value\",\n            values,\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodLiteral = /*@__PURE__*/ core.$constructor(\"$ZodLiteral\", (inst, def) => {\n    $ZodType.init(inst, def);\n    if (def.values.length === 0) {\n        throw new Error(\"Cannot create literal schema with no valid values\");\n    }\n    const values = new Set(def.values);\n    inst._zod.values = values;\n    inst._zod.pattern = new RegExp(`^(${def.values\n        .map((o) => (typeof o === \"string\" ? util.escapeRegex(o) : o ? util.escapeRegex(o.toString()) : String(o)))\n        .join(\"|\")})$`);\n    inst._zod.parse = (payload, _ctx) => {\n        const input = payload.value;\n        if (values.has(input)) {\n            return payload;\n        }\n        payload.issues.push({\n            code: \"invalid_value\",\n            values: def.values,\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodFile = /*@__PURE__*/ core.$constructor(\"$ZodFile\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, _ctx) => {\n        const input = payload.value;\n        // @ts-ignore\n        if (input instanceof File)\n            return payload;\n        payload.issues.push({\n            expected: \"file\",\n            code: \"invalid_type\",\n            input,\n            inst,\n        });\n        return payload;\n    };\n});\nexport const $ZodTransform = /*@__PURE__*/ core.$constructor(\"$ZodTransform\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        if (ctx.direction === \"backward\") {\n            throw new core.$ZodEncodeError(inst.constructor.name);\n        }\n        const _out = def.transform(payload.value, payload);\n        if (ctx.async) {\n            const output = _out instanceof Promise ? _out : Promise.resolve(_out);\n            return output.then((output) => {\n                payload.value = output;\n                return payload;\n            });\n        }\n        if (_out instanceof Promise) {\n            throw new core.$ZodAsyncError();\n        }\n        payload.value = _out;\n        return payload;\n    };\n});\nfunction handleOptionalResult(result, input) {\n    if (result.issues.length && input === undefined) {\n        return { issues: [], value: undefined };\n    }\n    return result;\n}\nexport const $ZodOptional = /*@__PURE__*/ core.$constructor(\"$ZodOptional\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.optin = \"optional\";\n    inst._zod.optout = \"optional\";\n    util.defineLazy(inst._zod, \"values\", () => {\n        return def.innerType._zod.values ? new Set([...def.innerType._zod.values, undefined]) : undefined;\n    });\n    util.defineLazy(inst._zod, \"pattern\", () => {\n        const pattern = def.innerType._zod.pattern;\n        return pattern ? new RegExp(`^(${util.cleanRegex(pattern.source)})?$`) : undefined;\n    });\n    inst._zod.parse = (payload, ctx) => {\n        if (def.innerType._zod.optin === \"optional\") {\n            const result = def.innerType._zod.run(payload, ctx);\n            if (result instanceof Promise)\n                return result.then((r) => handleOptionalResult(r, payload.value));\n            return handleOptionalResult(result, payload.value);\n        }\n        if (payload.value === undefined) {\n            return payload;\n        }\n        return def.innerType._zod.run(payload, ctx);\n    };\n});\nexport const $ZodExactOptional = /*@__PURE__*/ core.$constructor(\"$ZodExactOptional\", (inst, def) => {\n    // Call parent init - inherits optin/optout = \"optional\"\n    $ZodOptional.init(inst, def);\n    // Override values/pattern to NOT add undefined\n    util.defineLazy(inst._zod, \"values\", () => def.innerType._zod.values);\n    util.defineLazy(inst._zod, \"pattern\", () => def.innerType._zod.pattern);\n    // Override parse to just delegate (no undefined handling)\n    inst._zod.parse = (payload, ctx) => {\n        return def.innerType._zod.run(payload, ctx);\n    };\n});\nexport const $ZodNullable = /*@__PURE__*/ core.$constructor(\"$ZodNullable\", (inst, def) => {\n    $ZodType.init(inst, def);\n    util.defineLazy(inst._zod, \"optin\", () => def.innerType._zod.optin);\n    util.defineLazy(inst._zod, \"optout\", () => def.innerType._zod.optout);\n    util.defineLazy(inst._zod, \"pattern\", () => {\n        const pattern = def.innerType._zod.pattern;\n        return pattern ? new RegExp(`^(${util.cleanRegex(pattern.source)}|null)$`) : undefined;\n    });\n    util.defineLazy(inst._zod, \"values\", () => {\n        return def.innerType._zod.values ? new Set([...def.innerType._zod.values, null]) : undefined;\n    });\n    inst._zod.parse = (payload, ctx) => {\n        // Forward direction (decode): allow null to pass through\n        if (payload.value === null)\n            return payload;\n        return def.innerType._zod.run(payload, ctx);\n    };\n});\nexport const $ZodDefault = /*@__PURE__*/ core.$constructor(\"$ZodDefault\", (inst, def) => {\n    $ZodType.init(inst, def);\n    // inst._zod.qin = \"true\";\n    inst._zod.optin = \"optional\";\n    util.defineLazy(inst._zod, \"values\", () => def.innerType._zod.values);\n    inst._zod.parse = (payload, ctx) => {\n        if (ctx.direction === \"backward\") {\n            return def.innerType._zod.run(payload, ctx);\n        }\n        // Forward direction (decode): apply defaults for undefined input\n        if (payload.value === undefined) {\n            payload.value = def.defaultValue;\n            /**\n             * $ZodDefault returns the default value immediately in forward direction.\n             * It doesn't pass the default value into the validator (\"prefault\"). There's no reason to pass the default value through validation. The validity of the default is enforced by TypeScript statically. Otherwise, it's the responsibility of the user to ensure the default is valid. In the case of pipes with divergent in/out types, you can specify the default on the `in` schema of your ZodPipe to set a \"prefault\" for the pipe.   */\n            return payload;\n        }\n        // Forward direction: continue with default handling\n        const result = def.innerType._zod.run(payload, ctx);\n        if (result instanceof Promise) {\n            return result.then((result) => handleDefaultResult(result, def));\n        }\n        return handleDefaultResult(result, def);\n    };\n});\nfunction handleDefaultResult(payload, def) {\n    if (payload.value === undefined) {\n        payload.value = def.defaultValue;\n    }\n    return payload;\n}\nexport const $ZodPrefault = /*@__PURE__*/ core.$constructor(\"$ZodPrefault\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.optin = \"optional\";\n    util.defineLazy(inst._zod, \"values\", () => def.innerType._zod.values);\n    inst._zod.parse = (payload, ctx) => {\n        if (ctx.direction === \"backward\") {\n            return def.innerType._zod.run(payload, ctx);\n        }\n        // Forward direction (decode): apply prefault for undefined input\n        if (payload.value === undefined) {\n            payload.value = def.defaultValue;\n        }\n        return def.innerType._zod.run(payload, ctx);\n    };\n});\nexport const $ZodNonOptional = /*@__PURE__*/ core.$constructor(\"$ZodNonOptional\", (inst, def) => {\n    $ZodType.init(inst, def);\n    util.defineLazy(inst._zod, \"values\", () => {\n        const v = def.innerType._zod.values;\n        return v ? new Set([...v].filter((x) => x !== undefined)) : undefined;\n    });\n    inst._zod.parse = (payload, ctx) => {\n        const result = def.innerType._zod.run(payload, ctx);\n        if (result instanceof Promise) {\n            return result.then((result) => handleNonOptionalResult(result, inst));\n        }\n        return handleNonOptionalResult(result, inst);\n    };\n});\nfunction handleNonOptionalResult(payload, inst) {\n    if (!payload.issues.length && payload.value === undefined) {\n        payload.issues.push({\n            code: \"invalid_type\",\n            expected: \"nonoptional\",\n            input: payload.value,\n            inst,\n        });\n    }\n    return payload;\n}\nexport const $ZodSuccess = /*@__PURE__*/ core.$constructor(\"$ZodSuccess\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        if (ctx.direction === \"backward\") {\n            throw new core.$ZodEncodeError(\"ZodSuccess\");\n        }\n        const result = def.innerType._zod.run(payload, ctx);\n        if (result instanceof Promise) {\n            return result.then((result) => {\n                payload.value = result.issues.length === 0;\n                return payload;\n            });\n        }\n        payload.value = result.issues.length === 0;\n        return payload;\n    };\n});\nexport const $ZodCatch = /*@__PURE__*/ core.$constructor(\"$ZodCatch\", (inst, def) => {\n    $ZodType.init(inst, def);\n    util.defineLazy(inst._zod, \"optin\", () => def.innerType._zod.optin);\n    util.defineLazy(inst._zod, \"optout\", () => def.innerType._zod.optout);\n    util.defineLazy(inst._zod, \"values\", () => def.innerType._zod.values);\n    inst._zod.parse = (payload, ctx) => {\n        if (ctx.direction === \"backward\") {\n            return def.innerType._zod.run(payload, ctx);\n        }\n        // Forward direction (decode): apply catch logic\n        const result = def.innerType._zod.run(payload, ctx);\n        if (result instanceof Promise) {\n            return result.then((result) => {\n                payload.value = result.value;\n                if (result.issues.length) {\n                    payload.value = def.catchValue({\n                        ...payload,\n                        error: {\n                            issues: result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config())),\n                        },\n                        input: payload.value,\n                    });\n                    payload.issues = [];\n                }\n                return payload;\n            });\n        }\n        payload.value = result.value;\n        if (result.issues.length) {\n            payload.value = def.catchValue({\n                ...payload,\n                error: {\n                    issues: result.issues.map((iss) => util.finalizeIssue(iss, ctx, core.config())),\n                },\n                input: payload.value,\n            });\n            payload.issues = [];\n        }\n        return payload;\n    };\n});\nexport const $ZodNaN = /*@__PURE__*/ core.$constructor(\"$ZodNaN\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, _ctx) => {\n        if (typeof payload.value !== \"number\" || !Number.isNaN(payload.value)) {\n            payload.issues.push({\n                input: payload.value,\n                inst,\n                expected: \"nan\",\n                code: \"invalid_type\",\n            });\n            return payload;\n        }\n        return payload;\n    };\n});\nexport const $ZodPipe = /*@__PURE__*/ core.$constructor(\"$ZodPipe\", (inst, def) => {\n    $ZodType.init(inst, def);\n    util.defineLazy(inst._zod, \"values\", () => def.in._zod.values);\n    util.defineLazy(inst._zod, \"optin\", () => def.in._zod.optin);\n    util.defineLazy(inst._zod, \"optout\", () => def.out._zod.optout);\n    util.defineLazy(inst._zod, \"propValues\", () => def.in._zod.propValues);\n    inst._zod.parse = (payload, ctx) => {\n        if (ctx.direction === \"backward\") {\n            const right = def.out._zod.run(payload, ctx);\n            if (right instanceof Promise) {\n                return right.then((right) => handlePipeResult(right, def.in, ctx));\n            }\n            return handlePipeResult(right, def.in, ctx);\n        }\n        const left = def.in._zod.run(payload, ctx);\n        if (left instanceof Promise) {\n            return left.then((left) => handlePipeResult(left, def.out, ctx));\n        }\n        return handlePipeResult(left, def.out, ctx);\n    };\n});\nfunction handlePipeResult(left, next, ctx) {\n    if (left.issues.length) {\n        // prevent further checks\n        left.aborted = true;\n        return left;\n    }\n    return next._zod.run({ value: left.value, issues: left.issues }, ctx);\n}\nexport const $ZodCodec = /*@__PURE__*/ core.$constructor(\"$ZodCodec\", (inst, def) => {\n    $ZodType.init(inst, def);\n    util.defineLazy(inst._zod, \"values\", () => def.in._zod.values);\n    util.defineLazy(inst._zod, \"optin\", () => def.in._zod.optin);\n    util.defineLazy(inst._zod, \"optout\", () => def.out._zod.optout);\n    util.defineLazy(inst._zod, \"propValues\", () => def.in._zod.propValues);\n    inst._zod.parse = (payload, ctx) => {\n        const direction = ctx.direction || \"forward\";\n        if (direction === \"forward\") {\n            const left = def.in._zod.run(payload, ctx);\n            if (left instanceof Promise) {\n                return left.then((left) => handleCodecAResult(left, def, ctx));\n            }\n            return handleCodecAResult(left, def, ctx);\n        }\n        else {\n            const right = def.out._zod.run(payload, ctx);\n            if (right instanceof Promise) {\n                return right.then((right) => handleCodecAResult(right, def, ctx));\n            }\n            return handleCodecAResult(right, def, ctx);\n        }\n    };\n});\nfunction handleCodecAResult(result, def, ctx) {\n    if (result.issues.length) {\n        // prevent further checks\n        result.aborted = true;\n        return result;\n    }\n    const direction = ctx.direction || \"forward\";\n    if (direction === \"forward\") {\n        const transformed = def.transform(result.value, result);\n        if (transformed instanceof Promise) {\n            return transformed.then((value) => handleCodecTxResult(result, value, def.out, ctx));\n        }\n        return handleCodecTxResult(result, transformed, def.out, ctx);\n    }\n    else {\n        const transformed = def.reverseTransform(result.value, result);\n        if (transformed instanceof Promise) {\n            return transformed.then((value) => handleCodecTxResult(result, value, def.in, ctx));\n        }\n        return handleCodecTxResult(result, transformed, def.in, ctx);\n    }\n}\nfunction handleCodecTxResult(left, value, nextSchema, ctx) {\n    // Check if transform added any issues\n    if (left.issues.length) {\n        left.aborted = true;\n        return left;\n    }\n    return nextSchema._zod.run({ value, issues: left.issues }, ctx);\n}\nexport const $ZodReadonly = /*@__PURE__*/ core.$constructor(\"$ZodReadonly\", (inst, def) => {\n    $ZodType.init(inst, def);\n    util.defineLazy(inst._zod, \"propValues\", () => def.innerType._zod.propValues);\n    util.defineLazy(inst._zod, \"values\", () => def.innerType._zod.values);\n    util.defineLazy(inst._zod, \"optin\", () => def.innerType?._zod?.optin);\n    util.defineLazy(inst._zod, \"optout\", () => def.innerType?._zod?.optout);\n    inst._zod.parse = (payload, ctx) => {\n        if (ctx.direction === \"backward\") {\n            return def.innerType._zod.run(payload, ctx);\n        }\n        const result = def.innerType._zod.run(payload, ctx);\n        if (result instanceof Promise) {\n            return result.then(handleReadonlyResult);\n        }\n        return handleReadonlyResult(result);\n    };\n});\nfunction handleReadonlyResult(payload) {\n    payload.value = Object.freeze(payload.value);\n    return payload;\n}\nexport const $ZodTemplateLiteral = /*@__PURE__*/ core.$constructor(\"$ZodTemplateLiteral\", (inst, def) => {\n    $ZodType.init(inst, def);\n    const regexParts = [];\n    for (const part of def.parts) {\n        if (typeof part === \"object\" && part !== null) {\n            // is Zod schema\n            if (!part._zod.pattern) {\n                // if (!source)\n                throw new Error(`Invalid template literal part, no pattern found: ${[...part._zod.traits].shift()}`);\n            }\n            const source = part._zod.pattern instanceof RegExp ? part._zod.pattern.source : part._zod.pattern;\n            if (!source)\n                throw new Error(`Invalid template literal part: ${part._zod.traits}`);\n            const start = source.startsWith(\"^\") ? 1 : 0;\n            const end = source.endsWith(\"$\") ? source.length - 1 : source.length;\n            regexParts.push(source.slice(start, end));\n        }\n        else if (part === null || util.primitiveTypes.has(typeof part)) {\n            regexParts.push(util.escapeRegex(`${part}`));\n        }\n        else {\n            throw new Error(`Invalid template literal part: ${part}`);\n        }\n    }\n    inst._zod.pattern = new RegExp(`^${regexParts.join(\"\")}$`);\n    inst._zod.parse = (payload, _ctx) => {\n        if (typeof payload.value !== \"string\") {\n            payload.issues.push({\n                input: payload.value,\n                inst,\n                expected: \"string\",\n                code: \"invalid_type\",\n            });\n            return payload;\n        }\n        inst._zod.pattern.lastIndex = 0;\n        if (!inst._zod.pattern.test(payload.value)) {\n            payload.issues.push({\n                input: payload.value,\n                inst,\n                code: \"invalid_format\",\n                format: def.format ?? \"template_literal\",\n                pattern: inst._zod.pattern.source,\n            });\n            return payload;\n        }\n        return payload;\n    };\n});\nexport const $ZodFunction = /*@__PURE__*/ core.$constructor(\"$ZodFunction\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._def = def;\n    inst._zod.def = def;\n    inst.implement = (func) => {\n        if (typeof func !== \"function\") {\n            throw new Error(\"implement() must be called with a function\");\n        }\n        return function (...args) {\n            const parsedArgs = inst._def.input ? parse(inst._def.input, args) : args;\n            const result = Reflect.apply(func, this, parsedArgs);\n            if (inst._def.output) {\n                return parse(inst._def.output, result);\n            }\n            return result;\n        };\n    };\n    inst.implementAsync = (func) => {\n        if (typeof func !== \"function\") {\n            throw new Error(\"implementAsync() must be called with a function\");\n        }\n        return async function (...args) {\n            const parsedArgs = inst._def.input ? await parseAsync(inst._def.input, args) : args;\n            const result = await Reflect.apply(func, this, parsedArgs);\n            if (inst._def.output) {\n                return await parseAsync(inst._def.output, result);\n            }\n            return result;\n        };\n    };\n    inst._zod.parse = (payload, _ctx) => {\n        if (typeof payload.value !== \"function\") {\n            payload.issues.push({\n                code: \"invalid_type\",\n                expected: \"function\",\n                input: payload.value,\n                inst,\n            });\n            return payload;\n        }\n        // Check if output is a promise type to determine if we should use async implementation\n        const hasPromiseOutput = inst._def.output && inst._def.output._zod.def.type === \"promise\";\n        if (hasPromiseOutput) {\n            payload.value = inst.implementAsync(payload.value);\n        }\n        else {\n            payload.value = inst.implement(payload.value);\n        }\n        return payload;\n    };\n    inst.input = (...args) => {\n        const F = inst.constructor;\n        if (Array.isArray(args[0])) {\n            return new F({\n                type: \"function\",\n                input: new $ZodTuple({\n                    type: \"tuple\",\n                    items: args[0],\n                    rest: args[1],\n                }),\n                output: inst._def.output,\n            });\n        }\n        return new F({\n            type: \"function\",\n            input: args[0],\n            output: inst._def.output,\n        });\n    };\n    inst.output = (output) => {\n        const F = inst.constructor;\n        return new F({\n            type: \"function\",\n            input: inst._def.input,\n            output,\n        });\n    };\n    return inst;\n});\nexport const $ZodPromise = /*@__PURE__*/ core.$constructor(\"$ZodPromise\", (inst, def) => {\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, ctx) => {\n        return Promise.resolve(payload.value).then((inner) => def.innerType._zod.run({ value: inner, issues: [] }, ctx));\n    };\n});\nexport const $ZodLazy = /*@__PURE__*/ core.$constructor(\"$ZodLazy\", (inst, def) => {\n    $ZodType.init(inst, def);\n    // let _innerType!: any;\n    // util.defineLazy(def, \"getter\", () => {\n    //   if (!_innerType) {\n    //     _innerType = def.getter();\n    //   }\n    //   return () => _innerType;\n    // });\n    util.defineLazy(inst._zod, \"innerType\", () => def.getter());\n    util.defineLazy(inst._zod, \"pattern\", () => inst._zod.innerType?._zod?.pattern);\n    util.defineLazy(inst._zod, \"propValues\", () => inst._zod.innerType?._zod?.propValues);\n    util.defineLazy(inst._zod, \"optin\", () => inst._zod.innerType?._zod?.optin ?? undefined);\n    util.defineLazy(inst._zod, \"optout\", () => inst._zod.innerType?._zod?.optout ?? undefined);\n    inst._zod.parse = (payload, ctx) => {\n        const inner = inst._zod.innerType;\n        return inner._zod.run(payload, ctx);\n    };\n});\nexport const $ZodCustom = /*@__PURE__*/ core.$constructor(\"$ZodCustom\", (inst, def) => {\n    checks.$ZodCheck.init(inst, def);\n    $ZodType.init(inst, def);\n    inst._zod.parse = (payload, _) => {\n        return payload;\n    };\n    inst._zod.check = (payload) => {\n        const input = payload.value;\n        const r = def.fn(input);\n        if (r instanceof Promise) {\n            return r.then((r) => handleRefineResult(r, payload, input, inst));\n        }\n        handleRefineResult(r, payload, input, inst);\n        return;\n    };\n});\nfunction handleRefineResult(result, payload, input, inst) {\n    if (!result) {\n        const _iss = {\n            code: \"custom\",\n            input,\n            inst, // incorporates params.error into issue reporting\n            path: [...(inst._zod.def.path ?? [])], // incorporates params.error into issue reporting\n            continue: !inst._zod.def.abort,\n            // params: inst._zod.def.params,\n        };\n        if (inst._zod.def.params)\n            _iss.params = inst._zod.def.params;\n        payload.issues.push(util.issue(_iss));\n    }\n}\n","var _a;\nexport const $output = Symbol(\"ZodOutput\");\nexport const $input = Symbol(\"ZodInput\");\nexport class $ZodRegistry {\n    constructor() {\n        this._map = new WeakMap();\n        this._idmap = new Map();\n    }\n    add(schema, ..._meta) {\n        const meta = _meta[0];\n        this._map.set(schema, meta);\n        if (meta && typeof meta === \"object\" && \"id\" in meta) {\n            this._idmap.set(meta.id, schema);\n        }\n        return this;\n    }\n    clear() {\n        this._map = new WeakMap();\n        this._idmap = new Map();\n        return this;\n    }\n    remove(schema) {\n        const meta = this._map.get(schema);\n        if (meta && typeof meta === \"object\" && \"id\" in meta) {\n            this._idmap.delete(meta.id);\n        }\n        this._map.delete(schema);\n        return this;\n    }\n    get(schema) {\n        // return this._map.get(schema) as any;\n        // inherit metadata\n        const p = schema._zod.parent;\n        if (p) {\n            const pm = { ...(this.get(p) ?? {}) };\n            delete pm.id; // do not inherit id\n            const f = { ...pm, ...this._map.get(schema) };\n            return Object.keys(f).length ? f : undefined;\n        }\n        return this._map.get(schema);\n    }\n    has(schema) {\n        return this._map.has(schema);\n    }\n}\n// registries\nexport function registry() {\n    return new $ZodRegistry();\n}\n(_a = globalThis).__zod_globalRegistry ?? (_a.__zod_globalRegistry = registry());\nexport const globalRegistry = globalThis.__zod_globalRegistry;\n","import * as checks from \"./checks.js\";\nimport * as registries from \"./registries.js\";\nimport * as schemas from \"./schemas.js\";\nimport * as util from \"./util.js\";\n// @__NO_SIDE_EFFECTS__\nexport function _string(Class, params) {\n    return new Class({\n        type: \"string\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _coercedString(Class, params) {\n    return new Class({\n        type: \"string\",\n        coerce: true,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _email(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"email\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _guid(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"guid\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _uuid(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"uuid\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _uuidv4(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"uuid\",\n        check: \"string_format\",\n        abort: false,\n        version: \"v4\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _uuidv6(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"uuid\",\n        check: \"string_format\",\n        abort: false,\n        version: \"v6\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _uuidv7(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"uuid\",\n        check: \"string_format\",\n        abort: false,\n        version: \"v7\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _url(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"url\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _emoji(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"emoji\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _nanoid(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"nanoid\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _cuid(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"cuid\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _cuid2(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"cuid2\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _ulid(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"ulid\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _xid(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"xid\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _ksuid(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"ksuid\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _ipv4(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"ipv4\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _ipv6(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"ipv6\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _mac(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"mac\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _cidrv4(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"cidrv4\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _cidrv6(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"cidrv6\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _base64(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"base64\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _base64url(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"base64url\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _e164(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"e164\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _jwt(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"jwt\",\n        check: \"string_format\",\n        abort: false,\n        ...util.normalizeParams(params),\n    });\n}\nexport const TimePrecision = {\n    Any: null,\n    Minute: -1,\n    Second: 0,\n    Millisecond: 3,\n    Microsecond: 6,\n};\n// @__NO_SIDE_EFFECTS__\nexport function _isoDateTime(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"datetime\",\n        check: \"string_format\",\n        offset: false,\n        local: false,\n        precision: null,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _isoDate(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"date\",\n        check: \"string_format\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _isoTime(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"time\",\n        check: \"string_format\",\n        precision: null,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _isoDuration(Class, params) {\n    return new Class({\n        type: \"string\",\n        format: \"duration\",\n        check: \"string_format\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _number(Class, params) {\n    return new Class({\n        type: \"number\",\n        checks: [],\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _coercedNumber(Class, params) {\n    return new Class({\n        type: \"number\",\n        coerce: true,\n        checks: [],\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _int(Class, params) {\n    return new Class({\n        type: \"number\",\n        check: \"number_format\",\n        abort: false,\n        format: \"safeint\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _float32(Class, params) {\n    return new Class({\n        type: \"number\",\n        check: \"number_format\",\n        abort: false,\n        format: \"float32\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _float64(Class, params) {\n    return new Class({\n        type: \"number\",\n        check: \"number_format\",\n        abort: false,\n        format: \"float64\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _int32(Class, params) {\n    return new Class({\n        type: \"number\",\n        check: \"number_format\",\n        abort: false,\n        format: \"int32\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _uint32(Class, params) {\n    return new Class({\n        type: \"number\",\n        check: \"number_format\",\n        abort: false,\n        format: \"uint32\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _boolean(Class, params) {\n    return new Class({\n        type: \"boolean\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _coercedBoolean(Class, params) {\n    return new Class({\n        type: \"boolean\",\n        coerce: true,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _bigint(Class, params) {\n    return new Class({\n        type: \"bigint\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _coercedBigint(Class, params) {\n    return new Class({\n        type: \"bigint\",\n        coerce: true,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _int64(Class, params) {\n    return new Class({\n        type: \"bigint\",\n        check: \"bigint_format\",\n        abort: false,\n        format: \"int64\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _uint64(Class, params) {\n    return new Class({\n        type: \"bigint\",\n        check: \"bigint_format\",\n        abort: false,\n        format: \"uint64\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _symbol(Class, params) {\n    return new Class({\n        type: \"symbol\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _undefined(Class, params) {\n    return new Class({\n        type: \"undefined\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _null(Class, params) {\n    return new Class({\n        type: \"null\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _any(Class) {\n    return new Class({\n        type: \"any\",\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _unknown(Class) {\n    return new Class({\n        type: \"unknown\",\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _never(Class, params) {\n    return new Class({\n        type: \"never\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _void(Class, params) {\n    return new Class({\n        type: \"void\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _date(Class, params) {\n    return new Class({\n        type: \"date\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _coercedDate(Class, params) {\n    return new Class({\n        type: \"date\",\n        coerce: true,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _nan(Class, params) {\n    return new Class({\n        type: \"nan\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _lt(value, params) {\n    return new checks.$ZodCheckLessThan({\n        check: \"less_than\",\n        ...util.normalizeParams(params),\n        value,\n        inclusive: false,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _lte(value, params) {\n    return new checks.$ZodCheckLessThan({\n        check: \"less_than\",\n        ...util.normalizeParams(params),\n        value,\n        inclusive: true,\n    });\n}\nexport { \n/** @deprecated Use `z.lte()` instead. */\n_lte as _max, };\n// @__NO_SIDE_EFFECTS__\nexport function _gt(value, params) {\n    return new checks.$ZodCheckGreaterThan({\n        check: \"greater_than\",\n        ...util.normalizeParams(params),\n        value,\n        inclusive: false,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _gte(value, params) {\n    return new checks.$ZodCheckGreaterThan({\n        check: \"greater_than\",\n        ...util.normalizeParams(params),\n        value,\n        inclusive: true,\n    });\n}\nexport { \n/** @deprecated Use `z.gte()` instead. */\n_gte as _min, };\n// @__NO_SIDE_EFFECTS__\nexport function _positive(params) {\n    return _gt(0, params);\n}\n// negative\n// @__NO_SIDE_EFFECTS__\nexport function _negative(params) {\n    return _lt(0, params);\n}\n// nonpositive\n// @__NO_SIDE_EFFECTS__\nexport function _nonpositive(params) {\n    return _lte(0, params);\n}\n// nonnegative\n// @__NO_SIDE_EFFECTS__\nexport function _nonnegative(params) {\n    return _gte(0, params);\n}\n// @__NO_SIDE_EFFECTS__\nexport function _multipleOf(value, params) {\n    return new checks.$ZodCheckMultipleOf({\n        check: \"multiple_of\",\n        ...util.normalizeParams(params),\n        value,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _maxSize(maximum, params) {\n    return new checks.$ZodCheckMaxSize({\n        check: \"max_size\",\n        ...util.normalizeParams(params),\n        maximum,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _minSize(minimum, params) {\n    return new checks.$ZodCheckMinSize({\n        check: \"min_size\",\n        ...util.normalizeParams(params),\n        minimum,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _size(size, params) {\n    return new checks.$ZodCheckSizeEquals({\n        check: \"size_equals\",\n        ...util.normalizeParams(params),\n        size,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _maxLength(maximum, params) {\n    const ch = new checks.$ZodCheckMaxLength({\n        check: \"max_length\",\n        ...util.normalizeParams(params),\n        maximum,\n    });\n    return ch;\n}\n// @__NO_SIDE_EFFECTS__\nexport function _minLength(minimum, params) {\n    return new checks.$ZodCheckMinLength({\n        check: \"min_length\",\n        ...util.normalizeParams(params),\n        minimum,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _length(length, params) {\n    return new checks.$ZodCheckLengthEquals({\n        check: \"length_equals\",\n        ...util.normalizeParams(params),\n        length,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _regex(pattern, params) {\n    return new checks.$ZodCheckRegex({\n        check: \"string_format\",\n        format: \"regex\",\n        ...util.normalizeParams(params),\n        pattern,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _lowercase(params) {\n    return new checks.$ZodCheckLowerCase({\n        check: \"string_format\",\n        format: \"lowercase\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _uppercase(params) {\n    return new checks.$ZodCheckUpperCase({\n        check: \"string_format\",\n        format: \"uppercase\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _includes(includes, params) {\n    return new checks.$ZodCheckIncludes({\n        check: \"string_format\",\n        format: \"includes\",\n        ...util.normalizeParams(params),\n        includes,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _startsWith(prefix, params) {\n    return new checks.$ZodCheckStartsWith({\n        check: \"string_format\",\n        format: \"starts_with\",\n        ...util.normalizeParams(params),\n        prefix,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _endsWith(suffix, params) {\n    return new checks.$ZodCheckEndsWith({\n        check: \"string_format\",\n        format: \"ends_with\",\n        ...util.normalizeParams(params),\n        suffix,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _property(property, schema, params) {\n    return new checks.$ZodCheckProperty({\n        check: \"property\",\n        property,\n        schema,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _mime(types, params) {\n    return new checks.$ZodCheckMimeType({\n        check: \"mime_type\",\n        mime: types,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _overwrite(tx) {\n    return new checks.$ZodCheckOverwrite({\n        check: \"overwrite\",\n        tx,\n    });\n}\n// normalize\n// @__NO_SIDE_EFFECTS__\nexport function _normalize(form) {\n    return _overwrite((input) => input.normalize(form));\n}\n// trim\n// @__NO_SIDE_EFFECTS__\nexport function _trim() {\n    return _overwrite((input) => input.trim());\n}\n// toLowerCase\n// @__NO_SIDE_EFFECTS__\nexport function _toLowerCase() {\n    return _overwrite((input) => input.toLowerCase());\n}\n// toUpperCase\n// @__NO_SIDE_EFFECTS__\nexport function _toUpperCase() {\n    return _overwrite((input) => input.toUpperCase());\n}\n// slugify\n// @__NO_SIDE_EFFECTS__\nexport function _slugify() {\n    return _overwrite((input) => util.slugify(input));\n}\n// @__NO_SIDE_EFFECTS__\nexport function _array(Class, element, params) {\n    return new Class({\n        type: \"array\",\n        element,\n        // get element() {\n        //   return element;\n        // },\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _union(Class, options, params) {\n    return new Class({\n        type: \"union\",\n        options,\n        ...util.normalizeParams(params),\n    });\n}\nexport function _xor(Class, options, params) {\n    return new Class({\n        type: \"union\",\n        options,\n        inclusive: false,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _discriminatedUnion(Class, discriminator, options, params) {\n    return new Class({\n        type: \"union\",\n        options,\n        discriminator,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _intersection(Class, left, right) {\n    return new Class({\n        type: \"intersection\",\n        left,\n        right,\n    });\n}\n// export function _tuple(\n//   Class: util.SchemaClass<schemas.$ZodTuple>,\n//   items: [],\n//   params?: string | $ZodTupleParams\n// ): schemas.$ZodTuple<[], null>;\n// @__NO_SIDE_EFFECTS__\nexport function _tuple(Class, items, _paramsOrRest, _params) {\n    const hasRest = _paramsOrRest instanceof schemas.$ZodType;\n    const params = hasRest ? _params : _paramsOrRest;\n    const rest = hasRest ? _paramsOrRest : null;\n    return new Class({\n        type: \"tuple\",\n        items,\n        rest,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _record(Class, keyType, valueType, params) {\n    return new Class({\n        type: \"record\",\n        keyType,\n        valueType,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _map(Class, keyType, valueType, params) {\n    return new Class({\n        type: \"map\",\n        keyType,\n        valueType,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _set(Class, valueType, params) {\n    return new Class({\n        type: \"set\",\n        valueType,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _enum(Class, values, params) {\n    const entries = Array.isArray(values) ? Object.fromEntries(values.map((v) => [v, v])) : values;\n    // if (Array.isArray(values)) {\n    //   for (const value of values) {\n    //     entries[value] = value;\n    //   }\n    // } else {\n    //   Object.assign(entries, values);\n    // }\n    // const entries: util.EnumLike = {};\n    // for (const val of values) {\n    //   entries[val] = val;\n    // }\n    return new Class({\n        type: \"enum\",\n        entries,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\n/** @deprecated This API has been merged into `z.enum()`. Use `z.enum()` instead.\n *\n * ```ts\n * enum Colors { red, green, blue }\n * z.enum(Colors);\n * ```\n */\nexport function _nativeEnum(Class, entries, params) {\n    return new Class({\n        type: \"enum\",\n        entries,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _literal(Class, value, params) {\n    return new Class({\n        type: \"literal\",\n        values: Array.isArray(value) ? value : [value],\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _file(Class, params) {\n    return new Class({\n        type: \"file\",\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _transform(Class, fn) {\n    return new Class({\n        type: \"transform\",\n        transform: fn,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _optional(Class, innerType) {\n    return new Class({\n        type: \"optional\",\n        innerType,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _nullable(Class, innerType) {\n    return new Class({\n        type: \"nullable\",\n        innerType,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _default(Class, innerType, defaultValue) {\n    return new Class({\n        type: \"default\",\n        innerType,\n        get defaultValue() {\n            return typeof defaultValue === \"function\" ? defaultValue() : util.shallowClone(defaultValue);\n        },\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _nonoptional(Class, innerType, params) {\n    return new Class({\n        type: \"nonoptional\",\n        innerType,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _success(Class, innerType) {\n    return new Class({\n        type: \"success\",\n        innerType,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _catch(Class, innerType, catchValue) {\n    return new Class({\n        type: \"catch\",\n        innerType,\n        catchValue: (typeof catchValue === \"function\" ? catchValue : () => catchValue),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _pipe(Class, in_, out) {\n    return new Class({\n        type: \"pipe\",\n        in: in_,\n        out,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _readonly(Class, innerType) {\n    return new Class({\n        type: \"readonly\",\n        innerType,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _templateLiteral(Class, parts, params) {\n    return new Class({\n        type: \"template_literal\",\n        parts,\n        ...util.normalizeParams(params),\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _lazy(Class, getter) {\n    return new Class({\n        type: \"lazy\",\n        getter,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _promise(Class, innerType) {\n    return new Class({\n        type: \"promise\",\n        innerType,\n    });\n}\n// @__NO_SIDE_EFFECTS__\nexport function _custom(Class, fn, _params) {\n    const norm = util.normalizeParams(_params);\n    norm.abort ?? (norm.abort = true); // default to abort:false\n    const schema = new Class({\n        type: \"custom\",\n        check: \"custom\",\n        fn: fn,\n        ...norm,\n    });\n    return schema;\n}\n// same as _custom but defaults to abort:false\n// @__NO_SIDE_EFFECTS__\nexport function _refine(Class, fn, _params) {\n    const schema = new Class({\n        type: \"custom\",\n        check: \"custom\",\n        fn: fn,\n        ...util.normalizeParams(_params),\n    });\n    return schema;\n}\n// @__NO_SIDE_EFFECTS__\nexport function _superRefine(fn) {\n    const ch = _check((payload) => {\n        payload.addIssue = (issue) => {\n            if (typeof issue === \"string\") {\n                payload.issues.push(util.issue(issue, payload.value, ch._zod.def));\n            }\n            else {\n                // for Zod 3 backwards compatibility\n                const _issue = issue;\n                if (_issue.fatal)\n                    _issue.continue = false;\n                _issue.code ?? (_issue.code = \"custom\");\n                _issue.input ?? (_issue.input = payload.value);\n                _issue.inst ?? (_issue.inst = ch);\n                _issue.continue ?? (_issue.continue = !ch._zod.def.abort); // abort is always undefined, so this is always true...\n                payload.issues.push(util.issue(_issue));\n            }\n        };\n        return fn(payload.value, payload);\n    });\n    return ch;\n}\n// @__NO_SIDE_EFFECTS__\nexport function _check(fn, params) {\n    const ch = new checks.$ZodCheck({\n        check: \"custom\",\n        ...util.normalizeParams(params),\n    });\n    ch._zod.check = fn;\n    return ch;\n}\n// @__NO_SIDE_EFFECTS__\nexport function describe(description) {\n    const ch = new checks.$ZodCheck({ check: \"describe\" });\n    ch._zod.onattach = [\n        (inst) => {\n            const existing = registries.globalRegistry.get(inst) ?? {};\n            registries.globalRegistry.add(inst, { ...existing, description });\n        },\n    ];\n    ch._zod.check = () => { }; // no-op check\n    return ch;\n}\n// @__NO_SIDE_EFFECTS__\nexport function meta(metadata) {\n    const ch = new checks.$ZodCheck({ check: \"meta\" });\n    ch._zod.onattach = [\n        (inst) => {\n            const existing = registries.globalRegistry.get(inst) ?? {};\n            registries.globalRegistry.add(inst, { ...existing, ...metadata });\n        },\n    ];\n    ch._zod.check = () => { }; // no-op check\n    return ch;\n}\n// @__NO_SIDE_EFFECTS__\nexport function _stringbool(Classes, _params) {\n    const params = util.normalizeParams(_params);\n    let truthyArray = params.truthy ?? [\"true\", \"1\", \"yes\", \"on\", \"y\", \"enabled\"];\n    let falsyArray = params.falsy ?? [\"false\", \"0\", \"no\", \"off\", \"n\", \"disabled\"];\n    if (params.case !== \"sensitive\") {\n        truthyArray = truthyArray.map((v) => (typeof v === \"string\" ? v.toLowerCase() : v));\n        falsyArray = falsyArray.map((v) => (typeof v === \"string\" ? v.toLowerCase() : v));\n    }\n    const truthySet = new Set(truthyArray);\n    const falsySet = new Set(falsyArray);\n    const _Codec = Classes.Codec ?? schemas.$ZodCodec;\n    const _Boolean = Classes.Boolean ?? schemas.$ZodBoolean;\n    const _String = Classes.String ?? schemas.$ZodString;\n    const stringSchema = new _String({ type: \"string\", error: params.error });\n    const booleanSchema = new _Boolean({ type: \"boolean\", error: params.error });\n    const codec = new _Codec({\n        type: \"pipe\",\n        in: stringSchema,\n        out: booleanSchema,\n        transform: ((input, payload) => {\n            let data = input;\n            if (params.case !== \"sensitive\")\n                data = data.toLowerCase();\n            if (truthySet.has(data)) {\n                return true;\n            }\n            else if (falsySet.has(data)) {\n                return false;\n            }\n            else {\n                payload.issues.push({\n                    code: \"invalid_value\",\n                    expected: \"stringbool\",\n                    values: [...truthySet, ...falsySet],\n                    input: payload.value,\n                    inst: codec,\n                    continue: false,\n                });\n                return {};\n            }\n        }),\n        reverseTransform: ((input, _payload) => {\n            if (input === true) {\n                return truthyArray[0] || \"true\";\n            }\n            else {\n                return falsyArray[0] || \"false\";\n            }\n        }),\n        error: params.error,\n    });\n    return codec;\n}\n// @__NO_SIDE_EFFECTS__\nexport function _stringFormat(Class, format, fnOrRegex, _params = {}) {\n    const params = util.normalizeParams(_params);\n    const def = {\n        ...util.normalizeParams(_params),\n        check: \"string_format\",\n        type: \"string\",\n        format,\n        fn: typeof fnOrRegex === \"function\" ? fnOrRegex : (val) => fnOrRegex.test(val),\n        ...params,\n    };\n    if (fnOrRegex instanceof RegExp) {\n        def.pattern = fnOrRegex;\n    }\n    const inst = new Class(def);\n    return inst;\n}\n","import { globalRegistry } from \"./registries.js\";\n// function initializeContext<T extends schemas.$ZodType>(inputs: JSONSchemaGeneratorParams<T>): ToJSONSchemaContext<T> {\n//   return {\n//     processor: inputs.processor,\n//     metadataRegistry: inputs.metadata ?? globalRegistry,\n//     target: inputs.target ?? \"draft-2020-12\",\n//     unrepresentable: inputs.unrepresentable ?? \"throw\",\n//   };\n// }\nexport function initializeContext(params) {\n    // Normalize target: convert old non-hyphenated versions to hyphenated versions\n    let target = params?.target ?? \"draft-2020-12\";\n    if (target === \"draft-4\")\n        target = \"draft-04\";\n    if (target === \"draft-7\")\n        target = \"draft-07\";\n    return {\n        processors: params.processors ?? {},\n        metadataRegistry: params?.metadata ?? globalRegistry,\n        target,\n        unrepresentable: params?.unrepresentable ?? \"throw\",\n        override: params?.override ?? (() => { }),\n        io: params?.io ?? \"output\",\n        counter: 0,\n        seen: new Map(),\n        cycles: params?.cycles ?? \"ref\",\n        reused: params?.reused ?? \"inline\",\n        external: params?.external ?? undefined,\n    };\n}\nexport function process(schema, ctx, _params = { path: [], schemaPath: [] }) {\n    var _a;\n    const def = schema._zod.def;\n    // check for schema in seens\n    const seen = ctx.seen.get(schema);\n    if (seen) {\n        seen.count++;\n        // check if cycle\n        const isCycle = _params.schemaPath.includes(schema);\n        if (isCycle) {\n            seen.cycle = _params.path;\n        }\n        return seen.schema;\n    }\n    // initialize\n    const result = { schema: {}, count: 1, cycle: undefined, path: _params.path };\n    ctx.seen.set(schema, result);\n    // custom method overrides default behavior\n    const overrideSchema = schema._zod.toJSONSchema?.();\n    if (overrideSchema) {\n        result.schema = overrideSchema;\n    }\n    else {\n        const params = {\n            ..._params,\n            schemaPath: [..._params.schemaPath, schema],\n            path: _params.path,\n        };\n        if (schema._zod.processJSONSchema) {\n            schema._zod.processJSONSchema(ctx, result.schema, params);\n        }\n        else {\n            const _json = result.schema;\n            const processor = ctx.processors[def.type];\n            if (!processor) {\n                throw new Error(`[toJSONSchema]: Non-representable type encountered: ${def.type}`);\n            }\n            processor(schema, ctx, _json, params);\n        }\n        const parent = schema._zod.parent;\n        if (parent) {\n            // Also set ref if processor didn't (for inheritance)\n            if (!result.ref)\n                result.ref = parent;\n            process(parent, ctx, params);\n            ctx.seen.get(parent).isParent = true;\n        }\n    }\n    // metadata\n    const meta = ctx.metadataRegistry.get(schema);\n    if (meta)\n        Object.assign(result.schema, meta);\n    if (ctx.io === \"input\" && isTransforming(schema)) {\n        // examples/defaults only apply to output type of pipe\n        delete result.schema.examples;\n        delete result.schema.default;\n    }\n    // set prefault as default\n    if (ctx.io === \"input\" && result.schema._prefault)\n        (_a = result.schema).default ?? (_a.default = result.schema._prefault);\n    delete result.schema._prefault;\n    // pulling fresh from ctx.seen in case it was overwritten\n    const _result = ctx.seen.get(schema);\n    return _result.schema;\n}\nexport function extractDefs(ctx, schema\n// params: EmitParams\n) {\n    // iterate over seen map;\n    const root = ctx.seen.get(schema);\n    if (!root)\n        throw new Error(\"Unprocessed schema. This is a bug in Zod.\");\n    // Track ids to detect duplicates across different schemas\n    const idToSchema = new Map();\n    for (const entry of ctx.seen.entries()) {\n        const id = ctx.metadataRegistry.get(entry[0])?.id;\n        if (id) {\n            const existing = idToSchema.get(id);\n            if (existing && existing !== entry[0]) {\n                throw new Error(`Duplicate schema id \"${id}\" detected during JSON Schema conversion. Two different schemas cannot share the same id when converted together.`);\n            }\n            idToSchema.set(id, entry[0]);\n        }\n    }\n    // returns a ref to the schema\n    // defId will be empty if the ref points to an external schema (or #)\n    const makeURI = (entry) => {\n        // comparing the seen objects because sometimes\n        // multiple schemas map to the same seen object.\n        // e.g. lazy\n        // external is configured\n        const defsSegment = ctx.target === \"draft-2020-12\" ? \"$defs\" : \"definitions\";\n        if (ctx.external) {\n            const externalId = ctx.external.registry.get(entry[0])?.id; // ?? \"__shared\";// `__schema${ctx.counter++}`;\n            // check if schema is in the external registry\n            const uriGenerator = ctx.external.uri ?? ((id) => id);\n            if (externalId) {\n                return { ref: uriGenerator(externalId) };\n            }\n            // otherwise, add to __shared\n            const id = entry[1].defId ?? entry[1].schema.id ?? `schema${ctx.counter++}`;\n            entry[1].defId = id; // set defId so it will be reused if needed\n            return { defId: id, ref: `${uriGenerator(\"__shared\")}#/${defsSegment}/${id}` };\n        }\n        if (entry[1] === root) {\n            return { ref: \"#\" };\n        }\n        // self-contained schema\n        const uriPrefix = `#`;\n        const defUriPrefix = `${uriPrefix}/${defsSegment}/`;\n        const defId = entry[1].schema.id ?? `__schema${ctx.counter++}`;\n        return { defId, ref: defUriPrefix + defId };\n    };\n    // stored cached version in `def` property\n    // remove all properties, set $ref\n    const extractToDef = (entry) => {\n        // if the schema is already a reference, do not extract it\n        if (entry[1].schema.$ref) {\n            return;\n        }\n        const seen = entry[1];\n        const { ref, defId } = makeURI(entry);\n        seen.def = { ...seen.schema };\n        // defId won't be set if the schema is a reference to an external schema\n        // or if the schema is the root schema\n        if (defId)\n            seen.defId = defId;\n        // wipe away all properties except $ref\n        const schema = seen.schema;\n        for (const key in schema) {\n            delete schema[key];\n        }\n        schema.$ref = ref;\n    };\n    // throw on cycles\n    // break cycles\n    if (ctx.cycles === \"throw\") {\n        for (const entry of ctx.seen.entries()) {\n            const seen = entry[1];\n            if (seen.cycle) {\n                throw new Error(\"Cycle detected: \" +\n                    `#/${seen.cycle?.join(\"/\")}/<root>` +\n                    '\\n\\nSet the `cycles` parameter to `\"ref\"` to resolve cyclical schemas with defs.');\n            }\n        }\n    }\n    // extract schemas into $defs\n    for (const entry of ctx.seen.entries()) {\n        const seen = entry[1];\n        // convert root schema to # $ref\n        if (schema === entry[0]) {\n            extractToDef(entry); // this has special handling for the root schema\n            continue;\n        }\n        // extract schemas that are in the external registry\n        if (ctx.external) {\n            const ext = ctx.external.registry.get(entry[0])?.id;\n            if (schema !== entry[0] && ext) {\n                extractToDef(entry);\n                continue;\n            }\n        }\n        // extract schemas with `id` meta\n        const id = ctx.metadataRegistry.get(entry[0])?.id;\n        if (id) {\n            extractToDef(entry);\n            continue;\n        }\n        // break cycles\n        if (seen.cycle) {\n            // any\n            extractToDef(entry);\n            continue;\n        }\n        // extract reused schemas\n        if (seen.count > 1) {\n            if (ctx.reused === \"ref\") {\n                extractToDef(entry);\n                // biome-ignore lint:\n                continue;\n            }\n        }\n    }\n}\nexport function finalize(ctx, schema) {\n    const root = ctx.seen.get(schema);\n    if (!root)\n        throw new Error(\"Unprocessed schema. This is a bug in Zod.\");\n    // flatten refs - inherit properties from parent schemas\n    const flattenRef = (zodSchema) => {\n        const seen = ctx.seen.get(zodSchema);\n        // already processed\n        if (seen.ref === null)\n            return;\n        const schema = seen.def ?? seen.schema;\n        const _cached = { ...schema };\n        const ref = seen.ref;\n        seen.ref = null; // prevent infinite recursion\n        if (ref) {\n            flattenRef(ref);\n            const refSeen = ctx.seen.get(ref);\n            const refSchema = refSeen.schema;\n            // merge referenced schema into current\n            if (refSchema.$ref && (ctx.target === \"draft-07\" || ctx.target === \"draft-04\" || ctx.target === \"openapi-3.0\")) {\n                // older drafts can't combine $ref with other properties\n                schema.allOf = schema.allOf ?? [];\n                schema.allOf.push(refSchema);\n            }\n            else {\n                Object.assign(schema, refSchema);\n            }\n            // restore child's own properties (child wins)\n            Object.assign(schema, _cached);\n            const isParentRef = zodSchema._zod.parent === ref;\n            // For parent chain, child is a refinement - remove parent-only properties\n            if (isParentRef) {\n                for (const key in schema) {\n                    if (key === \"$ref\" || key === \"allOf\")\n                        continue;\n                    if (!(key in _cached)) {\n                        delete schema[key];\n                    }\n                }\n            }\n            // When ref was extracted to $defs, remove properties that match the definition\n            if (refSchema.$ref && refSeen.def) {\n                for (const key in schema) {\n                    if (key === \"$ref\" || key === \"allOf\")\n                        continue;\n                    if (key in refSeen.def && JSON.stringify(schema[key]) === JSON.stringify(refSeen.def[key])) {\n                        delete schema[key];\n                    }\n                }\n            }\n        }\n        // If parent was extracted (has $ref), propagate $ref to this schema\n        // This handles cases like: readonly().meta({id}).describe()\n        // where processor sets ref to innerType but parent should be referenced\n        const parent = zodSchema._zod.parent;\n        if (parent && parent !== ref) {\n            // Ensure parent is processed first so its def has inherited properties\n            flattenRef(parent);\n            const parentSeen = ctx.seen.get(parent);\n            if (parentSeen?.schema.$ref) {\n                schema.$ref = parentSeen.schema.$ref;\n                // De-duplicate with parent's definition\n                if (parentSeen.def) {\n                    for (const key in schema) {\n                        if (key === \"$ref\" || key === \"allOf\")\n                            continue;\n                        if (key in parentSeen.def && JSON.stringify(schema[key]) === JSON.stringify(parentSeen.def[key])) {\n                            delete schema[key];\n                        }\n                    }\n                }\n            }\n        }\n        // execute overrides\n        ctx.override({\n            zodSchema: zodSchema,\n            jsonSchema: schema,\n            path: seen.path ?? [],\n        });\n    };\n    for (const entry of [...ctx.seen.entries()].reverse()) {\n        flattenRef(entry[0]);\n    }\n    const result = {};\n    if (ctx.target === \"draft-2020-12\") {\n        result.$schema = \"https://json-schema.org/draft/2020-12/schema\";\n    }\n    else if (ctx.target === \"draft-07\") {\n        result.$schema = \"http://json-schema.org/draft-07/schema#\";\n    }\n    else if (ctx.target === \"draft-04\") {\n        result.$schema = \"http://json-schema.org/draft-04/schema#\";\n    }\n    else if (ctx.target === \"openapi-3.0\") {\n        // OpenAPI 3.0 schema objects should not include a $schema property\n    }\n    else {\n        // Arbitrary string values are allowed but won't have a $schema property set\n    }\n    if (ctx.external?.uri) {\n        const id = ctx.external.registry.get(schema)?.id;\n        if (!id)\n            throw new Error(\"Schema is missing an `id` property\");\n        result.$id = ctx.external.uri(id);\n    }\n    Object.assign(result, root.def ?? root.schema);\n    // build defs object\n    const defs = ctx.external?.defs ?? {};\n    for (const entry of ctx.seen.entries()) {\n        const seen = entry[1];\n        if (seen.def && seen.defId) {\n            defs[seen.defId] = seen.def;\n        }\n    }\n    // set definitions in result\n    if (ctx.external) {\n    }\n    else {\n        if (Object.keys(defs).length > 0) {\n            if (ctx.target === \"draft-2020-12\") {\n                result.$defs = defs;\n            }\n            else {\n                result.definitions = defs;\n            }\n        }\n    }\n    try {\n        // this \"finalizes\" this schema and ensures all cycles are removed\n        // each call to finalize() is functionally independent\n        // though the seen map is shared\n        const finalized = JSON.parse(JSON.stringify(result));\n        Object.defineProperty(finalized, \"~standard\", {\n            value: {\n                ...schema[\"~standard\"],\n                jsonSchema: {\n                    input: createStandardJSONSchemaMethod(schema, \"input\", ctx.processors),\n                    output: createStandardJSONSchemaMethod(schema, \"output\", ctx.processors),\n                },\n            },\n            enumerable: false,\n            writable: false,\n        });\n        return finalized;\n    }\n    catch (_err) {\n        throw new Error(\"Error converting schema to JSON.\");\n    }\n}\nfunction isTransforming(_schema, _ctx) {\n    const ctx = _ctx ?? { seen: new Set() };\n    if (ctx.seen.has(_schema))\n        return false;\n    ctx.seen.add(_schema);\n    const def = _schema._zod.def;\n    if (def.type === \"transform\")\n        return true;\n    if (def.type === \"array\")\n        return isTransforming(def.element, ctx);\n    if (def.type === \"set\")\n        return isTransforming(def.valueType, ctx);\n    if (def.type === \"lazy\")\n        return isTransforming(def.getter(), ctx);\n    if (def.type === \"promise\" ||\n        def.type === \"optional\" ||\n        def.type === \"nonoptional\" ||\n        def.type === \"nullable\" ||\n        def.type === \"readonly\" ||\n        def.type === \"default\" ||\n        def.type === \"prefault\") {\n        return isTransforming(def.innerType, ctx);\n    }\n    if (def.type === \"intersection\") {\n        return isTransforming(def.left, ctx) || isTransforming(def.right, ctx);\n    }\n    if (def.type === \"record\" || def.type === \"map\") {\n        return isTransforming(def.keyType, ctx) || isTransforming(def.valueType, ctx);\n    }\n    if (def.type === \"pipe\") {\n        return isTransforming(def.in, ctx) || isTransforming(def.out, ctx);\n    }\n    if (def.type === \"object\") {\n        for (const key in def.shape) {\n            if (isTransforming(def.shape[key], ctx))\n                return true;\n        }\n        return false;\n    }\n    if (def.type === \"union\") {\n        for (const option of def.options) {\n            if (isTransforming(option, ctx))\n                return true;\n        }\n        return false;\n    }\n    if (def.type === \"tuple\") {\n        for (const item of def.items) {\n            if (isTransforming(item, ctx))\n                return true;\n        }\n        if (def.rest && isTransforming(def.rest, ctx))\n            return true;\n        return false;\n    }\n    return false;\n}\n/**\n * Creates a toJSONSchema method for a schema instance.\n * This encapsulates the logic of initializing context, processing, extracting defs, and finalizing.\n */\nexport const createToJSONSchemaMethod = (schema, processors = {}) => (params) => {\n    const ctx = initializeContext({ ...params, processors });\n    process(schema, ctx);\n    extractDefs(ctx, schema);\n    return finalize(ctx, schema);\n};\nexport const createStandardJSONSchemaMethod = (schema, io, processors = {}) => (params) => {\n    const { libraryOptions, target } = params ?? {};\n    const ctx = initializeContext({ ...(libraryOptions ?? {}), target, io, processors });\n    process(schema, ctx);\n    extractDefs(ctx, schema);\n    return finalize(ctx, schema);\n};\n","import { extractDefs, finalize, initializeContext, process, } from \"./to-json-schema.js\";\nimport { getEnumValues } from \"./util.js\";\nconst formatMap = {\n    guid: \"uuid\",\n    url: \"uri\",\n    datetime: \"date-time\",\n    json_string: \"json-string\",\n    regex: \"\", // do not set\n};\n// ==================== SIMPLE TYPE PROCESSORS ====================\nexport const stringProcessor = (schema, ctx, _json, _params) => {\n    const json = _json;\n    json.type = \"string\";\n    const { minimum, maximum, format, patterns, contentEncoding } = schema._zod\n        .bag;\n    if (typeof minimum === \"number\")\n        json.minLength = minimum;\n    if (typeof maximum === \"number\")\n        json.maxLength = maximum;\n    // custom pattern overrides format\n    if (format) {\n        json.format = formatMap[format] ?? format;\n        if (json.format === \"\")\n            delete json.format; // empty format is not valid\n        // JSON Schema format: \"time\" requires a full time with offset or Z\n        // z.iso.time() does not include timezone information, so format: \"time\" should never be used\n        if (format === \"time\") {\n            delete json.format;\n        }\n    }\n    if (contentEncoding)\n        json.contentEncoding = contentEncoding;\n    if (patterns && patterns.size > 0) {\n        const regexes = [...patterns];\n        if (regexes.length === 1)\n            json.pattern = regexes[0].source;\n        else if (regexes.length > 1) {\n            json.allOf = [\n                ...regexes.map((regex) => ({\n                    ...(ctx.target === \"draft-07\" || ctx.target === \"draft-04\" || ctx.target === \"openapi-3.0\"\n                        ? { type: \"string\" }\n                        : {}),\n                    pattern: regex.source,\n                })),\n            ];\n        }\n    }\n};\nexport const numberProcessor = (schema, ctx, _json, _params) => {\n    const json = _json;\n    const { minimum, maximum, format, multipleOf, exclusiveMaximum, exclusiveMinimum } = schema._zod.bag;\n    if (typeof format === \"string\" && format.includes(\"int\"))\n        json.type = \"integer\";\n    else\n        json.type = \"number\";\n    if (typeof exclusiveMinimum === \"number\") {\n        if (ctx.target === \"draft-04\" || ctx.target === \"openapi-3.0\") {\n            json.minimum = exclusiveMinimum;\n            json.exclusiveMinimum = true;\n        }\n        else {\n            json.exclusiveMinimum = exclusiveMinimum;\n        }\n    }\n    if (typeof minimum === \"number\") {\n        json.minimum = minimum;\n        if (typeof exclusiveMinimum === \"number\" && ctx.target !== \"draft-04\") {\n            if (exclusiveMinimum >= minimum)\n                delete json.minimum;\n            else\n                delete json.exclusiveMinimum;\n        }\n    }\n    if (typeof exclusiveMaximum === \"number\") {\n        if (ctx.target === \"draft-04\" || ctx.target === \"openapi-3.0\") {\n            json.maximum = exclusiveMaximum;\n            json.exclusiveMaximum = true;\n        }\n        else {\n            json.exclusiveMaximum = exclusiveMaximum;\n        }\n    }\n    if (typeof maximum === \"number\") {\n        json.maximum = maximum;\n        if (typeof exclusiveMaximum === \"number\" && ctx.target !== \"draft-04\") {\n            if (exclusiveMaximum <= maximum)\n                delete json.maximum;\n            else\n                delete json.exclusiveMaximum;\n        }\n    }\n    if (typeof multipleOf === \"number\")\n        json.multipleOf = multipleOf;\n};\nexport const booleanProcessor = (_schema, _ctx, json, _params) => {\n    json.type = \"boolean\";\n};\nexport const bigintProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"BigInt cannot be represented in JSON Schema\");\n    }\n};\nexport const symbolProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Symbols cannot be represented in JSON Schema\");\n    }\n};\nexport const nullProcessor = (_schema, ctx, json, _params) => {\n    if (ctx.target === \"openapi-3.0\") {\n        json.type = \"string\";\n        json.nullable = true;\n        json.enum = [null];\n    }\n    else {\n        json.type = \"null\";\n    }\n};\nexport const undefinedProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Undefined cannot be represented in JSON Schema\");\n    }\n};\nexport const voidProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Void cannot be represented in JSON Schema\");\n    }\n};\nexport const neverProcessor = (_schema, _ctx, json, _params) => {\n    json.not = {};\n};\nexport const anyProcessor = (_schema, _ctx, _json, _params) => {\n    // empty schema accepts anything\n};\nexport const unknownProcessor = (_schema, _ctx, _json, _params) => {\n    // empty schema accepts anything\n};\nexport const dateProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Date cannot be represented in JSON Schema\");\n    }\n};\nexport const enumProcessor = (schema, _ctx, json, _params) => {\n    const def = schema._zod.def;\n    const values = getEnumValues(def.entries);\n    // Number enums can have both string and number values\n    if (values.every((v) => typeof v === \"number\"))\n        json.type = \"number\";\n    if (values.every((v) => typeof v === \"string\"))\n        json.type = \"string\";\n    json.enum = values;\n};\nexport const literalProcessor = (schema, ctx, json, _params) => {\n    const def = schema._zod.def;\n    const vals = [];\n    for (const val of def.values) {\n        if (val === undefined) {\n            if (ctx.unrepresentable === \"throw\") {\n                throw new Error(\"Literal `undefined` cannot be represented in JSON Schema\");\n            }\n            else {\n                // do not add to vals\n            }\n        }\n        else if (typeof val === \"bigint\") {\n            if (ctx.unrepresentable === \"throw\") {\n                throw new Error(\"BigInt literals cannot be represented in JSON Schema\");\n            }\n            else {\n                vals.push(Number(val));\n            }\n        }\n        else {\n            vals.push(val);\n        }\n    }\n    if (vals.length === 0) {\n        // do nothing (an undefined literal was stripped)\n    }\n    else if (vals.length === 1) {\n        const val = vals[0];\n        json.type = val === null ? \"null\" : typeof val;\n        if (ctx.target === \"draft-04\" || ctx.target === \"openapi-3.0\") {\n            json.enum = [val];\n        }\n        else {\n            json.const = val;\n        }\n    }\n    else {\n        if (vals.every((v) => typeof v === \"number\"))\n            json.type = \"number\";\n        if (vals.every((v) => typeof v === \"string\"))\n            json.type = \"string\";\n        if (vals.every((v) => typeof v === \"boolean\"))\n            json.type = \"boolean\";\n        if (vals.every((v) => v === null))\n            json.type = \"null\";\n        json.enum = vals;\n    }\n};\nexport const nanProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"NaN cannot be represented in JSON Schema\");\n    }\n};\nexport const templateLiteralProcessor = (schema, _ctx, json, _params) => {\n    const _json = json;\n    const pattern = schema._zod.pattern;\n    if (!pattern)\n        throw new Error(\"Pattern not found in template literal\");\n    _json.type = \"string\";\n    _json.pattern = pattern.source;\n};\nexport const fileProcessor = (schema, _ctx, json, _params) => {\n    const _json = json;\n    const file = {\n        type: \"string\",\n        format: \"binary\",\n        contentEncoding: \"binary\",\n    };\n    const { minimum, maximum, mime } = schema._zod.bag;\n    if (minimum !== undefined)\n        file.minLength = minimum;\n    if (maximum !== undefined)\n        file.maxLength = maximum;\n    if (mime) {\n        if (mime.length === 1) {\n            file.contentMediaType = mime[0];\n            Object.assign(_json, file);\n        }\n        else {\n            Object.assign(_json, file); // shared props at root\n            _json.anyOf = mime.map((m) => ({ contentMediaType: m })); // only contentMediaType differs\n        }\n    }\n    else {\n        Object.assign(_json, file);\n    }\n};\nexport const successProcessor = (_schema, _ctx, json, _params) => {\n    json.type = \"boolean\";\n};\nexport const customProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Custom types cannot be represented in JSON Schema\");\n    }\n};\nexport const functionProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Function types cannot be represented in JSON Schema\");\n    }\n};\nexport const transformProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Transforms cannot be represented in JSON Schema\");\n    }\n};\nexport const mapProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Map cannot be represented in JSON Schema\");\n    }\n};\nexport const setProcessor = (_schema, ctx, _json, _params) => {\n    if (ctx.unrepresentable === \"throw\") {\n        throw new Error(\"Set cannot be represented in JSON Schema\");\n    }\n};\n// ==================== COMPOSITE TYPE PROCESSORS ====================\nexport const arrayProcessor = (schema, ctx, _json, params) => {\n    const json = _json;\n    const def = schema._zod.def;\n    const { minimum, maximum } = schema._zod.bag;\n    if (typeof minimum === \"number\")\n        json.minItems = minimum;\n    if (typeof maximum === \"number\")\n        json.maxItems = maximum;\n    json.type = \"array\";\n    json.items = process(def.element, ctx, { ...params, path: [...params.path, \"items\"] });\n};\nexport const objectProcessor = (schema, ctx, _json, params) => {\n    const json = _json;\n    const def = schema._zod.def;\n    json.type = \"object\";\n    json.properties = {};\n    const shape = def.shape;\n    for (const key in shape) {\n        json.properties[key] = process(shape[key], ctx, {\n            ...params,\n            path: [...params.path, \"properties\", key],\n        });\n    }\n    // required keys\n    const allKeys = new Set(Object.keys(shape));\n    const requiredKeys = new Set([...allKeys].filter((key) => {\n        const v = def.shape[key]._zod;\n        if (ctx.io === \"input\") {\n            return v.optin === undefined;\n        }\n        else {\n            return v.optout === undefined;\n        }\n    }));\n    if (requiredKeys.size > 0) {\n        json.required = Array.from(requiredKeys);\n    }\n    // catchall\n    if (def.catchall?._zod.def.type === \"never\") {\n        // strict\n        json.additionalProperties = false;\n    }\n    else if (!def.catchall) {\n        // regular\n        if (ctx.io === \"output\")\n            json.additionalProperties = false;\n    }\n    else if (def.catchall) {\n        json.additionalProperties = process(def.catchall, ctx, {\n            ...params,\n            path: [...params.path, \"additionalProperties\"],\n        });\n    }\n};\nexport const unionProcessor = (schema, ctx, json, params) => {\n    const def = schema._zod.def;\n    // Exclusive unions (inclusive === false) use oneOf (exactly one match) instead of anyOf (one or more matches)\n    // This includes both z.xor() and discriminated unions\n    const isExclusive = def.inclusive === false;\n    const options = def.options.map((x, i) => process(x, ctx, {\n        ...params,\n        path: [...params.path, isExclusive ? \"oneOf\" : \"anyOf\", i],\n    }));\n    if (isExclusive) {\n        json.oneOf = options;\n    }\n    else {\n        json.anyOf = options;\n    }\n};\nexport const intersectionProcessor = (schema, ctx, json, params) => {\n    const def = schema._zod.def;\n    const a = process(def.left, ctx, {\n        ...params,\n        path: [...params.path, \"allOf\", 0],\n    });\n    const b = process(def.right, ctx, {\n        ...params,\n        path: [...params.path, \"allOf\", 1],\n    });\n    const isSimpleIntersection = (val) => \"allOf\" in val && Object.keys(val).length === 1;\n    const allOf = [\n        ...(isSimpleIntersection(a) ? a.allOf : [a]),\n        ...(isSimpleIntersection(b) ? b.allOf : [b]),\n    ];\n    json.allOf = allOf;\n};\nexport const tupleProcessor = (schema, ctx, _json, params) => {\n    const json = _json;\n    const def = schema._zod.def;\n    json.type = \"array\";\n    const prefixPath = ctx.target === \"draft-2020-12\" ? \"prefixItems\" : \"items\";\n    const restPath = ctx.target === \"draft-2020-12\" ? \"items\" : ctx.target === \"openapi-3.0\" ? \"items\" : \"additionalItems\";\n    const prefixItems = def.items.map((x, i) => process(x, ctx, {\n        ...params,\n        path: [...params.path, prefixPath, i],\n    }));\n    const rest = def.rest\n        ? process(def.rest, ctx, {\n            ...params,\n            path: [...params.path, restPath, ...(ctx.target === \"openapi-3.0\" ? [def.items.length] : [])],\n        })\n        : null;\n    if (ctx.target === \"draft-2020-12\") {\n        json.prefixItems = prefixItems;\n        if (rest) {\n            json.items = rest;\n        }\n    }\n    else if (ctx.target === \"openapi-3.0\") {\n        json.items = {\n            anyOf: prefixItems,\n        };\n        if (rest) {\n            json.items.anyOf.push(rest);\n        }\n        json.minItems = prefixItems.length;\n        if (!rest) {\n            json.maxItems = prefixItems.length;\n        }\n    }\n    else {\n        json.items = prefixItems;\n        if (rest) {\n            json.additionalItems = rest;\n        }\n    }\n    // length\n    const { minimum, maximum } = schema._zod.bag;\n    if (typeof minimum === \"number\")\n        json.minItems = minimum;\n    if (typeof maximum === \"number\")\n        json.maxItems = maximum;\n};\nexport const recordProcessor = (schema, ctx, _json, params) => {\n    const json = _json;\n    const def = schema._zod.def;\n    json.type = \"object\";\n    // For looseRecord with regex patterns, use patternProperties\n    // This correctly represents \"only validate keys matching the pattern\" semantics\n    // and composes well with allOf (intersections)\n    const keyType = def.keyType;\n    const keyBag = keyType._zod.bag;\n    const patterns = keyBag?.patterns;\n    if (def.mode === \"loose\" && patterns && patterns.size > 0) {\n        // Use patternProperties for looseRecord with regex patterns\n        const valueSchema = process(def.valueType, ctx, {\n            ...params,\n            path: [...params.path, \"patternProperties\", \"*\"],\n        });\n        json.patternProperties = {};\n        for (const pattern of patterns) {\n            json.patternProperties[pattern.source] = valueSchema;\n        }\n    }\n    else {\n        // Default behavior: use propertyNames + additionalProperties\n        if (ctx.target === \"draft-07\" || ctx.target === \"draft-2020-12\") {\n            json.propertyNames = process(def.keyType, ctx, {\n                ...params,\n                path: [...params.path, \"propertyNames\"],\n            });\n        }\n        json.additionalProperties = process(def.valueType, ctx, {\n            ...params,\n            path: [...params.path, \"additionalProperties\"],\n        });\n    }\n    // Add required for keys with discrete values (enum, literal, etc.)\n    const keyValues = keyType._zod.values;\n    if (keyValues) {\n        const validKeyValues = [...keyValues].filter((v) => typeof v === \"string\" || typeof v === \"number\");\n        if (validKeyValues.length > 0) {\n            json.required = validKeyValues;\n        }\n    }\n};\nexport const nullableProcessor = (schema, ctx, json, params) => {\n    const def = schema._zod.def;\n    const inner = process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    if (ctx.target === \"openapi-3.0\") {\n        seen.ref = def.innerType;\n        json.nullable = true;\n    }\n    else {\n        json.anyOf = [inner, { type: \"null\" }];\n    }\n};\nexport const nonoptionalProcessor = (schema, ctx, _json, params) => {\n    const def = schema._zod.def;\n    process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = def.innerType;\n};\nexport const defaultProcessor = (schema, ctx, json, params) => {\n    const def = schema._zod.def;\n    process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = def.innerType;\n    json.default = JSON.parse(JSON.stringify(def.defaultValue));\n};\nexport const prefaultProcessor = (schema, ctx, json, params) => {\n    const def = schema._zod.def;\n    process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = def.innerType;\n    if (ctx.io === \"input\")\n        json._prefault = JSON.parse(JSON.stringify(def.defaultValue));\n};\nexport const catchProcessor = (schema, ctx, json, params) => {\n    const def = schema._zod.def;\n    process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = def.innerType;\n    let catchValue;\n    try {\n        catchValue = def.catchValue(undefined);\n    }\n    catch {\n        throw new Error(\"Dynamic catch values are not supported in JSON Schema\");\n    }\n    json.default = catchValue;\n};\nexport const pipeProcessor = (schema, ctx, _json, params) => {\n    const def = schema._zod.def;\n    const innerType = ctx.io === \"input\" ? (def.in._zod.def.type === \"transform\" ? def.out : def.in) : def.out;\n    process(innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = innerType;\n};\nexport const readonlyProcessor = (schema, ctx, json, params) => {\n    const def = schema._zod.def;\n    process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = def.innerType;\n    json.readOnly = true;\n};\nexport const promiseProcessor = (schema, ctx, _json, params) => {\n    const def = schema._zod.def;\n    process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = def.innerType;\n};\nexport const optionalProcessor = (schema, ctx, _json, params) => {\n    const def = schema._zod.def;\n    process(def.innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = def.innerType;\n};\nexport const lazyProcessor = (schema, ctx, _json, params) => {\n    const innerType = schema._zod.innerType;\n    process(innerType, ctx, params);\n    const seen = ctx.seen.get(schema);\n    seen.ref = innerType;\n};\n// ==================== ALL PROCESSORS ====================\nexport const allProcessors = {\n    string: stringProcessor,\n    number: numberProcessor,\n    boolean: booleanProcessor,\n    bigint: bigintProcessor,\n    symbol: symbolProcessor,\n    null: nullProcessor,\n    undefined: undefinedProcessor,\n    void: voidProcessor,\n    never: neverProcessor,\n    any: anyProcessor,\n    unknown: unknownProcessor,\n    date: dateProcessor,\n    enum: enumProcessor,\n    literal: literalProcessor,\n    nan: nanProcessor,\n    template_literal: templateLiteralProcessor,\n    file: fileProcessor,\n    success: successProcessor,\n    custom: customProcessor,\n    function: functionProcessor,\n    transform: transformProcessor,\n    map: mapProcessor,\n    set: setProcessor,\n    array: arrayProcessor,\n    object: objectProcessor,\n    union: unionProcessor,\n    intersection: intersectionProcessor,\n    tuple: tupleProcessor,\n    record: recordProcessor,\n    nullable: nullableProcessor,\n    nonoptional: nonoptionalProcessor,\n    default: defaultProcessor,\n    prefault: prefaultProcessor,\n    catch: catchProcessor,\n    pipe: pipeProcessor,\n    readonly: readonlyProcessor,\n    promise: promiseProcessor,\n    optional: optionalProcessor,\n    lazy: lazyProcessor,\n};\nexport function toJSONSchema(input, params) {\n    if (\"_idmap\" in input) {\n        // Registry case\n        const registry = input;\n        const ctx = initializeContext({ ...params, processors: allProcessors });\n        const defs = {};\n        // First pass: process all schemas to build the seen map\n        for (const entry of registry._idmap.entries()) {\n            const [_, schema] = entry;\n            process(schema, ctx);\n        }\n        const schemas = {};\n        const external = {\n            registry,\n            uri: params?.uri,\n            defs,\n        };\n        // Update the context with external configuration\n        ctx.external = external;\n        // Second pass: emit each schema\n        for (const entry of registry._idmap.entries()) {\n            const [key, schema] = entry;\n            extractDefs(ctx, schema);\n            schemas[key] = finalize(ctx, schema);\n        }\n        if (Object.keys(defs).length > 0) {\n            const defsSegment = ctx.target === \"draft-2020-12\" ? \"$defs\" : \"definitions\";\n            schemas.__shared = {\n                [defsSegment]: defs,\n            };\n        }\n        return { schemas };\n    }\n    // Single schema case\n    const ctx = initializeContext({ ...params, processors: allProcessors });\n    process(input, ctx);\n    extractDefs(ctx, input);\n    return finalize(ctx, input);\n}\n","import * as core from \"../core/index.js\";\nimport * as schemas from \"./schemas.js\";\nexport const ZodISODateTime = /*@__PURE__*/ core.$constructor(\"ZodISODateTime\", (inst, def) => {\n    core.$ZodISODateTime.init(inst, def);\n    schemas.ZodStringFormat.init(inst, def);\n});\nexport function datetime(params) {\n    return core._isoDateTime(ZodISODateTime, params);\n}\nexport const ZodISODate = /*@__PURE__*/ core.$constructor(\"ZodISODate\", (inst, def) => {\n    core.$ZodISODate.init(inst, def);\n    schemas.ZodStringFormat.init(inst, def);\n});\nexport function date(params) {\n    return core._isoDate(ZodISODate, params);\n}\nexport const ZodISOTime = /*@__PURE__*/ core.$constructor(\"ZodISOTime\", (inst, def) => {\n    core.$ZodISOTime.init(inst, def);\n    schemas.ZodStringFormat.init(inst, def);\n});\nexport function time(params) {\n    return core._isoTime(ZodISOTime, params);\n}\nexport const ZodISODuration = /*@__PURE__*/ core.$constructor(\"ZodISODuration\", (inst, def) => {\n    core.$ZodISODuration.init(inst, def);\n    schemas.ZodStringFormat.init(inst, def);\n});\nexport function duration(params) {\n    return core._isoDuration(ZodISODuration, params);\n}\n","import * as core from \"../core/index.js\";\nimport { $ZodError } from \"../core/index.js\";\nimport * as util from \"../core/util.js\";\nconst initializer = (inst, issues) => {\n    $ZodError.init(inst, issues);\n    inst.name = \"ZodError\";\n    Object.defineProperties(inst, {\n        format: {\n            value: (mapper) => core.formatError(inst, mapper),\n            // enumerable: false,\n        },\n        flatten: {\n            value: (mapper) => core.flattenError(inst, mapper),\n            // enumerable: false,\n        },\n        addIssue: {\n            value: (issue) => {\n                inst.issues.push(issue);\n                inst.message = JSON.stringify(inst.issues, util.jsonStringifyReplacer, 2);\n            },\n            // enumerable: false,\n        },\n        addIssues: {\n            value: (issues) => {\n                inst.issues.push(...issues);\n                inst.message = JSON.stringify(inst.issues, util.jsonStringifyReplacer, 2);\n            },\n            // enumerable: false,\n        },\n        isEmpty: {\n            get() {\n                return inst.issues.length === 0;\n            },\n            // enumerable: false,\n        },\n    });\n    // Object.defineProperty(inst, \"isEmpty\", {\n    //   get() {\n    //     return inst.issues.length === 0;\n    //   },\n    // });\n};\nexport const ZodError = core.$constructor(\"ZodError\", initializer);\nexport const ZodRealError = core.$constructor(\"ZodError\", initializer, {\n    Parent: Error,\n});\n// /** @deprecated Use `z.core.$ZodErrorMapCtx` instead. */\n// export type ErrorMapCtx = core.$ZodErrorMapCtx;\n","import * as core from \"../core/index.js\";\nimport { ZodRealError } from \"./errors.js\";\nexport const parse = /* @__PURE__ */ core._parse(ZodRealError);\nexport const parseAsync = /* @__PURE__ */ core._parseAsync(ZodRealError);\nexport const safeParse = /* @__PURE__ */ core._safeParse(ZodRealError);\nexport const safeParseAsync = /* @__PURE__ */ core._safeParseAsync(ZodRealError);\n// Codec functions\nexport const encode = /* @__PURE__ */ core._encode(ZodRealError);\nexport const decode = /* @__PURE__ */ core._decode(ZodRealError);\nexport const encodeAsync = /* @__PURE__ */ core._encodeAsync(ZodRealError);\nexport const decodeAsync = /* @__PURE__ */ core._decodeAsync(ZodRealError);\nexport const safeEncode = /* @__PURE__ */ core._safeEncode(ZodRealError);\nexport const safeDecode = /* @__PURE__ */ core._safeDecode(ZodRealError);\nexport const safeEncodeAsync = /* @__PURE__ */ core._safeEncodeAsync(ZodRealError);\nexport const safeDecodeAsync = /* @__PURE__ */ core._safeDecodeAsync(ZodRealError);\n","import * as core from \"../core/index.js\";\nimport { util } from \"../core/index.js\";\nimport * as processors from \"../core/json-schema-processors.js\";\nimport { createStandardJSONSchemaMethod, createToJSONSchemaMethod } from \"../core/to-json-schema.js\";\nimport * as checks from \"./checks.js\";\nimport * as iso from \"./iso.js\";\nimport * as parse from \"./parse.js\";\nexport const ZodType = /*@__PURE__*/ core.$constructor(\"ZodType\", (inst, def) => {\n    core.$ZodType.init(inst, def);\n    Object.assign(inst[\"~standard\"], {\n        jsonSchema: {\n            input: createStandardJSONSchemaMethod(inst, \"input\"),\n            output: createStandardJSONSchemaMethod(inst, \"output\"),\n        },\n    });\n    inst.toJSONSchema = createToJSONSchemaMethod(inst, {});\n    inst.def = def;\n    inst.type = def.type;\n    Object.defineProperty(inst, \"_def\", { value: def });\n    // base methods\n    inst.check = (...checks) => {\n        return inst.clone(util.mergeDefs(def, {\n            checks: [\n                ...(def.checks ?? []),\n                ...checks.map((ch) => typeof ch === \"function\" ? { _zod: { check: ch, def: { check: \"custom\" }, onattach: [] } } : ch),\n            ],\n        }), {\n            parent: true,\n        });\n    };\n    inst.with = inst.check;\n    inst.clone = (def, params) => core.clone(inst, def, params);\n    inst.brand = () => inst;\n    inst.register = ((reg, meta) => {\n        reg.add(inst, meta);\n        return inst;\n    });\n    // parsing\n    inst.parse = (data, params) => parse.parse(inst, data, params, { callee: inst.parse });\n    inst.safeParse = (data, params) => parse.safeParse(inst, data, params);\n    inst.parseAsync = async (data, params) => parse.parseAsync(inst, data, params, { callee: inst.parseAsync });\n    inst.safeParseAsync = async (data, params) => parse.safeParseAsync(inst, data, params);\n    inst.spa = inst.safeParseAsync;\n    // encoding/decoding\n    inst.encode = (data, params) => parse.encode(inst, data, params);\n    inst.decode = (data, params) => parse.decode(inst, data, params);\n    inst.encodeAsync = async (data, params) => parse.encodeAsync(inst, data, params);\n    inst.decodeAsync = async (data, params) => parse.decodeAsync(inst, data, params);\n    inst.safeEncode = (data, params) => parse.safeEncode(inst, data, params);\n    inst.safeDecode = (data, params) => parse.safeDecode(inst, data, params);\n    inst.safeEncodeAsync = async (data, params) => parse.safeEncodeAsync(inst, data, params);\n    inst.safeDecodeAsync = async (data, params) => parse.safeDecodeAsync(inst, data, params);\n    // refinements\n    inst.refine = (check, params) => inst.check(refine(check, params));\n    inst.superRefine = (refinement) => inst.check(superRefine(refinement));\n    inst.overwrite = (fn) => inst.check(checks.overwrite(fn));\n    // wrappers\n    inst.optional = () => optional(inst);\n    inst.exactOptional = () => exactOptional(inst);\n    inst.nullable = () => nullable(inst);\n    inst.nullish = () => optional(nullable(inst));\n    inst.nonoptional = (params) => nonoptional(inst, params);\n    inst.array = () => array(inst);\n    inst.or = (arg) => union([inst, arg]);\n    inst.and = (arg) => intersection(inst, arg);\n    inst.transform = (tx) => pipe(inst, transform(tx));\n    inst.default = (def) => _default(inst, def);\n    inst.prefault = (def) => prefault(inst, def);\n    // inst.coalesce = (def, params) => coalesce(inst, def, params);\n    inst.catch = (params) => _catch(inst, params);\n    inst.pipe = (target) => pipe(inst, target);\n    inst.readonly = () => readonly(inst);\n    // meta\n    inst.describe = (description) => {\n        const cl = inst.clone();\n        core.globalRegistry.add(cl, { description });\n        return cl;\n    };\n    Object.defineProperty(inst, \"description\", {\n        get() {\n            return core.globalRegistry.get(inst)?.description;\n        },\n        configurable: true,\n    });\n    inst.meta = (...args) => {\n        if (args.length === 0) {\n            return core.globalRegistry.get(inst);\n        }\n        const cl = inst.clone();\n        core.globalRegistry.add(cl, args[0]);\n        return cl;\n    };\n    // helpers\n    inst.isOptional = () => inst.safeParse(undefined).success;\n    inst.isNullable = () => inst.safeParse(null).success;\n    inst.apply = (fn) => fn(inst);\n    return inst;\n});\n/** @internal */\nexport const _ZodString = /*@__PURE__*/ core.$constructor(\"_ZodString\", (inst, def) => {\n    core.$ZodString.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.stringProcessor(inst, ctx, json, params);\n    const bag = inst._zod.bag;\n    inst.format = bag.format ?? null;\n    inst.minLength = bag.minimum ?? null;\n    inst.maxLength = bag.maximum ?? null;\n    // validations\n    inst.regex = (...args) => inst.check(checks.regex(...args));\n    inst.includes = (...args) => inst.check(checks.includes(...args));\n    inst.startsWith = (...args) => inst.check(checks.startsWith(...args));\n    inst.endsWith = (...args) => inst.check(checks.endsWith(...args));\n    inst.min = (...args) => inst.check(checks.minLength(...args));\n    inst.max = (...args) => inst.check(checks.maxLength(...args));\n    inst.length = (...args) => inst.check(checks.length(...args));\n    inst.nonempty = (...args) => inst.check(checks.minLength(1, ...args));\n    inst.lowercase = (params) => inst.check(checks.lowercase(params));\n    inst.uppercase = (params) => inst.check(checks.uppercase(params));\n    // transforms\n    inst.trim = () => inst.check(checks.trim());\n    inst.normalize = (...args) => inst.check(checks.normalize(...args));\n    inst.toLowerCase = () => inst.check(checks.toLowerCase());\n    inst.toUpperCase = () => inst.check(checks.toUpperCase());\n    inst.slugify = () => inst.check(checks.slugify());\n});\nexport const ZodString = /*@__PURE__*/ core.$constructor(\"ZodString\", (inst, def) => {\n    core.$ZodString.init(inst, def);\n    _ZodString.init(inst, def);\n    inst.email = (params) => inst.check(core._email(ZodEmail, params));\n    inst.url = (params) => inst.check(core._url(ZodURL, params));\n    inst.jwt = (params) => inst.check(core._jwt(ZodJWT, params));\n    inst.emoji = (params) => inst.check(core._emoji(ZodEmoji, params));\n    inst.guid = (params) => inst.check(core._guid(ZodGUID, params));\n    inst.uuid = (params) => inst.check(core._uuid(ZodUUID, params));\n    inst.uuidv4 = (params) => inst.check(core._uuidv4(ZodUUID, params));\n    inst.uuidv6 = (params) => inst.check(core._uuidv6(ZodUUID, params));\n    inst.uuidv7 = (params) => inst.check(core._uuidv7(ZodUUID, params));\n    inst.nanoid = (params) => inst.check(core._nanoid(ZodNanoID, params));\n    inst.guid = (params) => inst.check(core._guid(ZodGUID, params));\n    inst.cuid = (params) => inst.check(core._cuid(ZodCUID, params));\n    inst.cuid2 = (params) => inst.check(core._cuid2(ZodCUID2, params));\n    inst.ulid = (params) => inst.check(core._ulid(ZodULID, params));\n    inst.base64 = (params) => inst.check(core._base64(ZodBase64, params));\n    inst.base64url = (params) => inst.check(core._base64url(ZodBase64URL, params));\n    inst.xid = (params) => inst.check(core._xid(ZodXID, params));\n    inst.ksuid = (params) => inst.check(core._ksuid(ZodKSUID, params));\n    inst.ipv4 = (params) => inst.check(core._ipv4(ZodIPv4, params));\n    inst.ipv6 = (params) => inst.check(core._ipv6(ZodIPv6, params));\n    inst.cidrv4 = (params) => inst.check(core._cidrv4(ZodCIDRv4, params));\n    inst.cidrv6 = (params) => inst.check(core._cidrv6(ZodCIDRv6, params));\n    inst.e164 = (params) => inst.check(core._e164(ZodE164, params));\n    // iso\n    inst.datetime = (params) => inst.check(iso.datetime(params));\n    inst.date = (params) => inst.check(iso.date(params));\n    inst.time = (params) => inst.check(iso.time(params));\n    inst.duration = (params) => inst.check(iso.duration(params));\n});\nexport function string(params) {\n    return core._string(ZodString, params);\n}\nexport const ZodStringFormat = /*@__PURE__*/ core.$constructor(\"ZodStringFormat\", (inst, def) => {\n    core.$ZodStringFormat.init(inst, def);\n    _ZodString.init(inst, def);\n});\nexport const ZodEmail = /*@__PURE__*/ core.$constructor(\"ZodEmail\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodEmail.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function email(params) {\n    return core._email(ZodEmail, params);\n}\nexport const ZodGUID = /*@__PURE__*/ core.$constructor(\"ZodGUID\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodGUID.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function guid(params) {\n    return core._guid(ZodGUID, params);\n}\nexport const ZodUUID = /*@__PURE__*/ core.$constructor(\"ZodUUID\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodUUID.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function uuid(params) {\n    return core._uuid(ZodUUID, params);\n}\nexport function uuidv4(params) {\n    return core._uuidv4(ZodUUID, params);\n}\n// ZodUUIDv6\nexport function uuidv6(params) {\n    return core._uuidv6(ZodUUID, params);\n}\n// ZodUUIDv7\nexport function uuidv7(params) {\n    return core._uuidv7(ZodUUID, params);\n}\nexport const ZodURL = /*@__PURE__*/ core.$constructor(\"ZodURL\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodURL.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function url(params) {\n    return core._url(ZodURL, params);\n}\nexport function httpUrl(params) {\n    return core._url(ZodURL, {\n        protocol: /^https?$/,\n        hostname: core.regexes.domain,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodEmoji = /*@__PURE__*/ core.$constructor(\"ZodEmoji\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodEmoji.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function emoji(params) {\n    return core._emoji(ZodEmoji, params);\n}\nexport const ZodNanoID = /*@__PURE__*/ core.$constructor(\"ZodNanoID\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodNanoID.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function nanoid(params) {\n    return core._nanoid(ZodNanoID, params);\n}\nexport const ZodCUID = /*@__PURE__*/ core.$constructor(\"ZodCUID\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodCUID.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function cuid(params) {\n    return core._cuid(ZodCUID, params);\n}\nexport const ZodCUID2 = /*@__PURE__*/ core.$constructor(\"ZodCUID2\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodCUID2.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function cuid2(params) {\n    return core._cuid2(ZodCUID2, params);\n}\nexport const ZodULID = /*@__PURE__*/ core.$constructor(\"ZodULID\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodULID.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function ulid(params) {\n    return core._ulid(ZodULID, params);\n}\nexport const ZodXID = /*@__PURE__*/ core.$constructor(\"ZodXID\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodXID.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function xid(params) {\n    return core._xid(ZodXID, params);\n}\nexport const ZodKSUID = /*@__PURE__*/ core.$constructor(\"ZodKSUID\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodKSUID.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function ksuid(params) {\n    return core._ksuid(ZodKSUID, params);\n}\nexport const ZodIPv4 = /*@__PURE__*/ core.$constructor(\"ZodIPv4\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodIPv4.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function ipv4(params) {\n    return core._ipv4(ZodIPv4, params);\n}\nexport const ZodMAC = /*@__PURE__*/ core.$constructor(\"ZodMAC\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodMAC.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function mac(params) {\n    return core._mac(ZodMAC, params);\n}\nexport const ZodIPv6 = /*@__PURE__*/ core.$constructor(\"ZodIPv6\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodIPv6.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function ipv6(params) {\n    return core._ipv6(ZodIPv6, params);\n}\nexport const ZodCIDRv4 = /*@__PURE__*/ core.$constructor(\"ZodCIDRv4\", (inst, def) => {\n    core.$ZodCIDRv4.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function cidrv4(params) {\n    return core._cidrv4(ZodCIDRv4, params);\n}\nexport const ZodCIDRv6 = /*@__PURE__*/ core.$constructor(\"ZodCIDRv6\", (inst, def) => {\n    core.$ZodCIDRv6.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function cidrv6(params) {\n    return core._cidrv6(ZodCIDRv6, params);\n}\nexport const ZodBase64 = /*@__PURE__*/ core.$constructor(\"ZodBase64\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodBase64.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function base64(params) {\n    return core._base64(ZodBase64, params);\n}\nexport const ZodBase64URL = /*@__PURE__*/ core.$constructor(\"ZodBase64URL\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodBase64URL.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function base64url(params) {\n    return core._base64url(ZodBase64URL, params);\n}\nexport const ZodE164 = /*@__PURE__*/ core.$constructor(\"ZodE164\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodE164.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function e164(params) {\n    return core._e164(ZodE164, params);\n}\nexport const ZodJWT = /*@__PURE__*/ core.$constructor(\"ZodJWT\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodJWT.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function jwt(params) {\n    return core._jwt(ZodJWT, params);\n}\nexport const ZodCustomStringFormat = /*@__PURE__*/ core.$constructor(\"ZodCustomStringFormat\", (inst, def) => {\n    // ZodStringFormat.init(inst, def);\n    core.$ZodCustomStringFormat.init(inst, def);\n    ZodStringFormat.init(inst, def);\n});\nexport function stringFormat(format, fnOrRegex, _params = {}) {\n    return core._stringFormat(ZodCustomStringFormat, format, fnOrRegex, _params);\n}\nexport function hostname(_params) {\n    return core._stringFormat(ZodCustomStringFormat, \"hostname\", core.regexes.hostname, _params);\n}\nexport function hex(_params) {\n    return core._stringFormat(ZodCustomStringFormat, \"hex\", core.regexes.hex, _params);\n}\nexport function hash(alg, params) {\n    const enc = params?.enc ?? \"hex\";\n    const format = `${alg}_${enc}`;\n    const regex = core.regexes[format];\n    if (!regex)\n        throw new Error(`Unrecognized hash format: ${format}`);\n    return core._stringFormat(ZodCustomStringFormat, format, regex, params);\n}\nexport const ZodNumber = /*@__PURE__*/ core.$constructor(\"ZodNumber\", (inst, def) => {\n    core.$ZodNumber.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.numberProcessor(inst, ctx, json, params);\n    inst.gt = (value, params) => inst.check(checks.gt(value, params));\n    inst.gte = (value, params) => inst.check(checks.gte(value, params));\n    inst.min = (value, params) => inst.check(checks.gte(value, params));\n    inst.lt = (value, params) => inst.check(checks.lt(value, params));\n    inst.lte = (value, params) => inst.check(checks.lte(value, params));\n    inst.max = (value, params) => inst.check(checks.lte(value, params));\n    inst.int = (params) => inst.check(int(params));\n    inst.safe = (params) => inst.check(int(params));\n    inst.positive = (params) => inst.check(checks.gt(0, params));\n    inst.nonnegative = (params) => inst.check(checks.gte(0, params));\n    inst.negative = (params) => inst.check(checks.lt(0, params));\n    inst.nonpositive = (params) => inst.check(checks.lte(0, params));\n    inst.multipleOf = (value, params) => inst.check(checks.multipleOf(value, params));\n    inst.step = (value, params) => inst.check(checks.multipleOf(value, params));\n    // inst.finite = (params) => inst.check(core.finite(params));\n    inst.finite = () => inst;\n    const bag = inst._zod.bag;\n    inst.minValue =\n        Math.max(bag.minimum ?? Number.NEGATIVE_INFINITY, bag.exclusiveMinimum ?? Number.NEGATIVE_INFINITY) ?? null;\n    inst.maxValue =\n        Math.min(bag.maximum ?? Number.POSITIVE_INFINITY, bag.exclusiveMaximum ?? Number.POSITIVE_INFINITY) ?? null;\n    inst.isInt = (bag.format ?? \"\").includes(\"int\") || Number.isSafeInteger(bag.multipleOf ?? 0.5);\n    inst.isFinite = true;\n    inst.format = bag.format ?? null;\n});\nexport function number(params) {\n    return core._number(ZodNumber, params);\n}\nexport const ZodNumberFormat = /*@__PURE__*/ core.$constructor(\"ZodNumberFormat\", (inst, def) => {\n    core.$ZodNumberFormat.init(inst, def);\n    ZodNumber.init(inst, def);\n});\nexport function int(params) {\n    return core._int(ZodNumberFormat, params);\n}\nexport function float32(params) {\n    return core._float32(ZodNumberFormat, params);\n}\nexport function float64(params) {\n    return core._float64(ZodNumberFormat, params);\n}\nexport function int32(params) {\n    return core._int32(ZodNumberFormat, params);\n}\nexport function uint32(params) {\n    return core._uint32(ZodNumberFormat, params);\n}\nexport const ZodBoolean = /*@__PURE__*/ core.$constructor(\"ZodBoolean\", (inst, def) => {\n    core.$ZodBoolean.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.booleanProcessor(inst, ctx, json, params);\n});\nexport function boolean(params) {\n    return core._boolean(ZodBoolean, params);\n}\nexport const ZodBigInt = /*@__PURE__*/ core.$constructor(\"ZodBigInt\", (inst, def) => {\n    core.$ZodBigInt.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.bigintProcessor(inst, ctx, json, params);\n    inst.gte = (value, params) => inst.check(checks.gte(value, params));\n    inst.min = (value, params) => inst.check(checks.gte(value, params));\n    inst.gt = (value, params) => inst.check(checks.gt(value, params));\n    inst.gte = (value, params) => inst.check(checks.gte(value, params));\n    inst.min = (value, params) => inst.check(checks.gte(value, params));\n    inst.lt = (value, params) => inst.check(checks.lt(value, params));\n    inst.lte = (value, params) => inst.check(checks.lte(value, params));\n    inst.max = (value, params) => inst.check(checks.lte(value, params));\n    inst.positive = (params) => inst.check(checks.gt(BigInt(0), params));\n    inst.negative = (params) => inst.check(checks.lt(BigInt(0), params));\n    inst.nonpositive = (params) => inst.check(checks.lte(BigInt(0), params));\n    inst.nonnegative = (params) => inst.check(checks.gte(BigInt(0), params));\n    inst.multipleOf = (value, params) => inst.check(checks.multipleOf(value, params));\n    const bag = inst._zod.bag;\n    inst.minValue = bag.minimum ?? null;\n    inst.maxValue = bag.maximum ?? null;\n    inst.format = bag.format ?? null;\n});\nexport function bigint(params) {\n    return core._bigint(ZodBigInt, params);\n}\nexport const ZodBigIntFormat = /*@__PURE__*/ core.$constructor(\"ZodBigIntFormat\", (inst, def) => {\n    core.$ZodBigIntFormat.init(inst, def);\n    ZodBigInt.init(inst, def);\n});\n// int64\nexport function int64(params) {\n    return core._int64(ZodBigIntFormat, params);\n}\n// uint64\nexport function uint64(params) {\n    return core._uint64(ZodBigIntFormat, params);\n}\nexport const ZodSymbol = /*@__PURE__*/ core.$constructor(\"ZodSymbol\", (inst, def) => {\n    core.$ZodSymbol.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.symbolProcessor(inst, ctx, json, params);\n});\nexport function symbol(params) {\n    return core._symbol(ZodSymbol, params);\n}\nexport const ZodUndefined = /*@__PURE__*/ core.$constructor(\"ZodUndefined\", (inst, def) => {\n    core.$ZodUndefined.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.undefinedProcessor(inst, ctx, json, params);\n});\nfunction _undefined(params) {\n    return core._undefined(ZodUndefined, params);\n}\nexport { _undefined as undefined };\nexport const ZodNull = /*@__PURE__*/ core.$constructor(\"ZodNull\", (inst, def) => {\n    core.$ZodNull.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.nullProcessor(inst, ctx, json, params);\n});\nfunction _null(params) {\n    return core._null(ZodNull, params);\n}\nexport { _null as null };\nexport const ZodAny = /*@__PURE__*/ core.$constructor(\"ZodAny\", (inst, def) => {\n    core.$ZodAny.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.anyProcessor(inst, ctx, json, params);\n});\nexport function any() {\n    return core._any(ZodAny);\n}\nexport const ZodUnknown = /*@__PURE__*/ core.$constructor(\"ZodUnknown\", (inst, def) => {\n    core.$ZodUnknown.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.unknownProcessor(inst, ctx, json, params);\n});\nexport function unknown() {\n    return core._unknown(ZodUnknown);\n}\nexport const ZodNever = /*@__PURE__*/ core.$constructor(\"ZodNever\", (inst, def) => {\n    core.$ZodNever.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.neverProcessor(inst, ctx, json, params);\n});\nexport function never(params) {\n    return core._never(ZodNever, params);\n}\nexport const ZodVoid = /*@__PURE__*/ core.$constructor(\"ZodVoid\", (inst, def) => {\n    core.$ZodVoid.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.voidProcessor(inst, ctx, json, params);\n});\nfunction _void(params) {\n    return core._void(ZodVoid, params);\n}\nexport { _void as void };\nexport const ZodDate = /*@__PURE__*/ core.$constructor(\"ZodDate\", (inst, def) => {\n    core.$ZodDate.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.dateProcessor(inst, ctx, json, params);\n    inst.min = (value, params) => inst.check(checks.gte(value, params));\n    inst.max = (value, params) => inst.check(checks.lte(value, params));\n    const c = inst._zod.bag;\n    inst.minDate = c.minimum ? new Date(c.minimum) : null;\n    inst.maxDate = c.maximum ? new Date(c.maximum) : null;\n});\nexport function date(params) {\n    return core._date(ZodDate, params);\n}\nexport const ZodArray = /*@__PURE__*/ core.$constructor(\"ZodArray\", (inst, def) => {\n    core.$ZodArray.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.arrayProcessor(inst, ctx, json, params);\n    inst.element = def.element;\n    inst.min = (minLength, params) => inst.check(checks.minLength(minLength, params));\n    inst.nonempty = (params) => inst.check(checks.minLength(1, params));\n    inst.max = (maxLength, params) => inst.check(checks.maxLength(maxLength, params));\n    inst.length = (len, params) => inst.check(checks.length(len, params));\n    inst.unwrap = () => inst.element;\n});\nexport function array(element, params) {\n    return core._array(ZodArray, element, params);\n}\n// .keyof\nexport function keyof(schema) {\n    const shape = schema._zod.def.shape;\n    return _enum(Object.keys(shape));\n}\nexport const ZodObject = /*@__PURE__*/ core.$constructor(\"ZodObject\", (inst, def) => {\n    core.$ZodObjectJIT.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.objectProcessor(inst, ctx, json, params);\n    util.defineLazy(inst, \"shape\", () => {\n        return def.shape;\n    });\n    inst.keyof = () => _enum(Object.keys(inst._zod.def.shape));\n    inst.catchall = (catchall) => inst.clone({ ...inst._zod.def, catchall: catchall });\n    inst.passthrough = () => inst.clone({ ...inst._zod.def, catchall: unknown() });\n    inst.loose = () => inst.clone({ ...inst._zod.def, catchall: unknown() });\n    inst.strict = () => inst.clone({ ...inst._zod.def, catchall: never() });\n    inst.strip = () => inst.clone({ ...inst._zod.def, catchall: undefined });\n    inst.extend = (incoming) => {\n        return util.extend(inst, incoming);\n    };\n    inst.safeExtend = (incoming) => {\n        return util.safeExtend(inst, incoming);\n    };\n    inst.merge = (other) => util.merge(inst, other);\n    inst.pick = (mask) => util.pick(inst, mask);\n    inst.omit = (mask) => util.omit(inst, mask);\n    inst.partial = (...args) => util.partial(ZodOptional, inst, args[0]);\n    inst.required = (...args) => util.required(ZodNonOptional, inst, args[0]);\n});\nexport function object(shape, params) {\n    const def = {\n        type: \"object\",\n        shape: shape ?? {},\n        ...util.normalizeParams(params),\n    };\n    return new ZodObject(def);\n}\n// strictObject\nexport function strictObject(shape, params) {\n    return new ZodObject({\n        type: \"object\",\n        shape,\n        catchall: never(),\n        ...util.normalizeParams(params),\n    });\n}\n// looseObject\nexport function looseObject(shape, params) {\n    return new ZodObject({\n        type: \"object\",\n        shape,\n        catchall: unknown(),\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodUnion = /*@__PURE__*/ core.$constructor(\"ZodUnion\", (inst, def) => {\n    core.$ZodUnion.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.unionProcessor(inst, ctx, json, params);\n    inst.options = def.options;\n});\nexport function union(options, params) {\n    return new ZodUnion({\n        type: \"union\",\n        options: options,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodXor = /*@__PURE__*/ core.$constructor(\"ZodXor\", (inst, def) => {\n    ZodUnion.init(inst, def);\n    core.$ZodXor.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.unionProcessor(inst, ctx, json, params);\n    inst.options = def.options;\n});\n/** Creates an exclusive union (XOR) where exactly one option must match.\n * Unlike regular unions that succeed when any option matches, xor fails if\n * zero or more than one option matches the input. */\nexport function xor(options, params) {\n    return new ZodXor({\n        type: \"union\",\n        options: options,\n        inclusive: false,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodDiscriminatedUnion = /*@__PURE__*/ core.$constructor(\"ZodDiscriminatedUnion\", (inst, def) => {\n    ZodUnion.init(inst, def);\n    core.$ZodDiscriminatedUnion.init(inst, def);\n});\nexport function discriminatedUnion(discriminator, options, params) {\n    // const [options, params] = args;\n    return new ZodDiscriminatedUnion({\n        type: \"union\",\n        options,\n        discriminator,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodIntersection = /*@__PURE__*/ core.$constructor(\"ZodIntersection\", (inst, def) => {\n    core.$ZodIntersection.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.intersectionProcessor(inst, ctx, json, params);\n});\nexport function intersection(left, right) {\n    return new ZodIntersection({\n        type: \"intersection\",\n        left: left,\n        right: right,\n    });\n}\nexport const ZodTuple = /*@__PURE__*/ core.$constructor(\"ZodTuple\", (inst, def) => {\n    core.$ZodTuple.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.tupleProcessor(inst, ctx, json, params);\n    inst.rest = (rest) => inst.clone({\n        ...inst._zod.def,\n        rest: rest,\n    });\n});\nexport function tuple(items, _paramsOrRest, _params) {\n    const hasRest = _paramsOrRest instanceof core.$ZodType;\n    const params = hasRest ? _params : _paramsOrRest;\n    const rest = hasRest ? _paramsOrRest : null;\n    return new ZodTuple({\n        type: \"tuple\",\n        items: items,\n        rest,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodRecord = /*@__PURE__*/ core.$constructor(\"ZodRecord\", (inst, def) => {\n    core.$ZodRecord.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.recordProcessor(inst, ctx, json, params);\n    inst.keyType = def.keyType;\n    inst.valueType = def.valueType;\n});\nexport function record(keyType, valueType, params) {\n    return new ZodRecord({\n        type: \"record\",\n        keyType,\n        valueType: valueType,\n        ...util.normalizeParams(params),\n    });\n}\n// type alksjf = core.output<core.$ZodRecordKey>;\nexport function partialRecord(keyType, valueType, params) {\n    const k = core.clone(keyType);\n    k._zod.values = undefined;\n    return new ZodRecord({\n        type: \"record\",\n        keyType: k,\n        valueType: valueType,\n        ...util.normalizeParams(params),\n    });\n}\nexport function looseRecord(keyType, valueType, params) {\n    return new ZodRecord({\n        type: \"record\",\n        keyType,\n        valueType: valueType,\n        mode: \"loose\",\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodMap = /*@__PURE__*/ core.$constructor(\"ZodMap\", (inst, def) => {\n    core.$ZodMap.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.mapProcessor(inst, ctx, json, params);\n    inst.keyType = def.keyType;\n    inst.valueType = def.valueType;\n    inst.min = (...args) => inst.check(core._minSize(...args));\n    inst.nonempty = (params) => inst.check(core._minSize(1, params));\n    inst.max = (...args) => inst.check(core._maxSize(...args));\n    inst.size = (...args) => inst.check(core._size(...args));\n});\nexport function map(keyType, valueType, params) {\n    return new ZodMap({\n        type: \"map\",\n        keyType: keyType,\n        valueType: valueType,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodSet = /*@__PURE__*/ core.$constructor(\"ZodSet\", (inst, def) => {\n    core.$ZodSet.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.setProcessor(inst, ctx, json, params);\n    inst.min = (...args) => inst.check(core._minSize(...args));\n    inst.nonempty = (params) => inst.check(core._minSize(1, params));\n    inst.max = (...args) => inst.check(core._maxSize(...args));\n    inst.size = (...args) => inst.check(core._size(...args));\n});\nexport function set(valueType, params) {\n    return new ZodSet({\n        type: \"set\",\n        valueType: valueType,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodEnum = /*@__PURE__*/ core.$constructor(\"ZodEnum\", (inst, def) => {\n    core.$ZodEnum.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.enumProcessor(inst, ctx, json, params);\n    inst.enum = def.entries;\n    inst.options = Object.values(def.entries);\n    const keys = new Set(Object.keys(def.entries));\n    inst.extract = (values, params) => {\n        const newEntries = {};\n        for (const value of values) {\n            if (keys.has(value)) {\n                newEntries[value] = def.entries[value];\n            }\n            else\n                throw new Error(`Key ${value} not found in enum`);\n        }\n        return new ZodEnum({\n            ...def,\n            checks: [],\n            ...util.normalizeParams(params),\n            entries: newEntries,\n        });\n    };\n    inst.exclude = (values, params) => {\n        const newEntries = { ...def.entries };\n        for (const value of values) {\n            if (keys.has(value)) {\n                delete newEntries[value];\n            }\n            else\n                throw new Error(`Key ${value} not found in enum`);\n        }\n        return new ZodEnum({\n            ...def,\n            checks: [],\n            ...util.normalizeParams(params),\n            entries: newEntries,\n        });\n    };\n});\nfunction _enum(values, params) {\n    const entries = Array.isArray(values) ? Object.fromEntries(values.map((v) => [v, v])) : values;\n    return new ZodEnum({\n        type: \"enum\",\n        entries,\n        ...util.normalizeParams(params),\n    });\n}\nexport { _enum as enum };\n/** @deprecated This API has been merged into `z.enum()`. Use `z.enum()` instead.\n *\n * ```ts\n * enum Colors { red, green, blue }\n * z.enum(Colors);\n * ```\n */\nexport function nativeEnum(entries, params) {\n    return new ZodEnum({\n        type: \"enum\",\n        entries,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodLiteral = /*@__PURE__*/ core.$constructor(\"ZodLiteral\", (inst, def) => {\n    core.$ZodLiteral.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.literalProcessor(inst, ctx, json, params);\n    inst.values = new Set(def.values);\n    Object.defineProperty(inst, \"value\", {\n        get() {\n            if (def.values.length > 1) {\n                throw new Error(\"This schema contains multiple valid literal values. Use `.values` instead.\");\n            }\n            return def.values[0];\n        },\n    });\n});\nexport function literal(value, params) {\n    return new ZodLiteral({\n        type: \"literal\",\n        values: Array.isArray(value) ? value : [value],\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodFile = /*@__PURE__*/ core.$constructor(\"ZodFile\", (inst, def) => {\n    core.$ZodFile.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.fileProcessor(inst, ctx, json, params);\n    inst.min = (size, params) => inst.check(core._minSize(size, params));\n    inst.max = (size, params) => inst.check(core._maxSize(size, params));\n    inst.mime = (types, params) => inst.check(core._mime(Array.isArray(types) ? types : [types], params));\n});\nexport function file(params) {\n    return core._file(ZodFile, params);\n}\nexport const ZodTransform = /*@__PURE__*/ core.$constructor(\"ZodTransform\", (inst, def) => {\n    core.$ZodTransform.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.transformProcessor(inst, ctx, json, params);\n    inst._zod.parse = (payload, _ctx) => {\n        if (_ctx.direction === \"backward\") {\n            throw new core.$ZodEncodeError(inst.constructor.name);\n        }\n        payload.addIssue = (issue) => {\n            if (typeof issue === \"string\") {\n                payload.issues.push(util.issue(issue, payload.value, def));\n            }\n            else {\n                // for Zod 3 backwards compatibility\n                const _issue = issue;\n                if (_issue.fatal)\n                    _issue.continue = false;\n                _issue.code ?? (_issue.code = \"custom\");\n                _issue.input ?? (_issue.input = payload.value);\n                _issue.inst ?? (_issue.inst = inst);\n                // _issue.continue ??= true;\n                payload.issues.push(util.issue(_issue));\n            }\n        };\n        const output = def.transform(payload.value, payload);\n        if (output instanceof Promise) {\n            return output.then((output) => {\n                payload.value = output;\n                return payload;\n            });\n        }\n        payload.value = output;\n        return payload;\n    };\n});\nexport function transform(fn) {\n    return new ZodTransform({\n        type: \"transform\",\n        transform: fn,\n    });\n}\nexport const ZodOptional = /*@__PURE__*/ core.$constructor(\"ZodOptional\", (inst, def) => {\n    core.$ZodOptional.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.optionalProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function optional(innerType) {\n    return new ZodOptional({\n        type: \"optional\",\n        innerType: innerType,\n    });\n}\nexport const ZodExactOptional = /*@__PURE__*/ core.$constructor(\"ZodExactOptional\", (inst, def) => {\n    core.$ZodExactOptional.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.optionalProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function exactOptional(innerType) {\n    return new ZodExactOptional({\n        type: \"optional\",\n        innerType: innerType,\n    });\n}\nexport const ZodNullable = /*@__PURE__*/ core.$constructor(\"ZodNullable\", (inst, def) => {\n    core.$ZodNullable.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.nullableProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function nullable(innerType) {\n    return new ZodNullable({\n        type: \"nullable\",\n        innerType: innerType,\n    });\n}\n// nullish\nexport function nullish(innerType) {\n    return optional(nullable(innerType));\n}\nexport const ZodDefault = /*@__PURE__*/ core.$constructor(\"ZodDefault\", (inst, def) => {\n    core.$ZodDefault.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.defaultProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n    inst.removeDefault = inst.unwrap;\n});\nexport function _default(innerType, defaultValue) {\n    return new ZodDefault({\n        type: \"default\",\n        innerType: innerType,\n        get defaultValue() {\n            return typeof defaultValue === \"function\" ? defaultValue() : util.shallowClone(defaultValue);\n        },\n    });\n}\nexport const ZodPrefault = /*@__PURE__*/ core.$constructor(\"ZodPrefault\", (inst, def) => {\n    core.$ZodPrefault.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.prefaultProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function prefault(innerType, defaultValue) {\n    return new ZodPrefault({\n        type: \"prefault\",\n        innerType: innerType,\n        get defaultValue() {\n            return typeof defaultValue === \"function\" ? defaultValue() : util.shallowClone(defaultValue);\n        },\n    });\n}\nexport const ZodNonOptional = /*@__PURE__*/ core.$constructor(\"ZodNonOptional\", (inst, def) => {\n    core.$ZodNonOptional.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.nonoptionalProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function nonoptional(innerType, params) {\n    return new ZodNonOptional({\n        type: \"nonoptional\",\n        innerType: innerType,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodSuccess = /*@__PURE__*/ core.$constructor(\"ZodSuccess\", (inst, def) => {\n    core.$ZodSuccess.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.successProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function success(innerType) {\n    return new ZodSuccess({\n        type: \"success\",\n        innerType: innerType,\n    });\n}\nexport const ZodCatch = /*@__PURE__*/ core.$constructor(\"ZodCatch\", (inst, def) => {\n    core.$ZodCatch.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.catchProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n    inst.removeCatch = inst.unwrap;\n});\nfunction _catch(innerType, catchValue) {\n    return new ZodCatch({\n        type: \"catch\",\n        innerType: innerType,\n        catchValue: (typeof catchValue === \"function\" ? catchValue : () => catchValue),\n    });\n}\nexport { _catch as catch };\nexport const ZodNaN = /*@__PURE__*/ core.$constructor(\"ZodNaN\", (inst, def) => {\n    core.$ZodNaN.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.nanProcessor(inst, ctx, json, params);\n});\nexport function nan(params) {\n    return core._nan(ZodNaN, params);\n}\nexport const ZodPipe = /*@__PURE__*/ core.$constructor(\"ZodPipe\", (inst, def) => {\n    core.$ZodPipe.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.pipeProcessor(inst, ctx, json, params);\n    inst.in = def.in;\n    inst.out = def.out;\n});\nexport function pipe(in_, out) {\n    return new ZodPipe({\n        type: \"pipe\",\n        in: in_,\n        out: out,\n        // ...util.normalizeParams(params),\n    });\n}\nexport const ZodCodec = /*@__PURE__*/ core.$constructor(\"ZodCodec\", (inst, def) => {\n    ZodPipe.init(inst, def);\n    core.$ZodCodec.init(inst, def);\n});\nexport function codec(in_, out, params) {\n    return new ZodCodec({\n        type: \"pipe\",\n        in: in_,\n        out: out,\n        transform: params.decode,\n        reverseTransform: params.encode,\n    });\n}\nexport const ZodReadonly = /*@__PURE__*/ core.$constructor(\"ZodReadonly\", (inst, def) => {\n    core.$ZodReadonly.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.readonlyProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function readonly(innerType) {\n    return new ZodReadonly({\n        type: \"readonly\",\n        innerType: innerType,\n    });\n}\nexport const ZodTemplateLiteral = /*@__PURE__*/ core.$constructor(\"ZodTemplateLiteral\", (inst, def) => {\n    core.$ZodTemplateLiteral.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.templateLiteralProcessor(inst, ctx, json, params);\n});\nexport function templateLiteral(parts, params) {\n    return new ZodTemplateLiteral({\n        type: \"template_literal\",\n        parts,\n        ...util.normalizeParams(params),\n    });\n}\nexport const ZodLazy = /*@__PURE__*/ core.$constructor(\"ZodLazy\", (inst, def) => {\n    core.$ZodLazy.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.lazyProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.getter();\n});\nexport function lazy(getter) {\n    return new ZodLazy({\n        type: \"lazy\",\n        getter: getter,\n    });\n}\nexport const ZodPromise = /*@__PURE__*/ core.$constructor(\"ZodPromise\", (inst, def) => {\n    core.$ZodPromise.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.promiseProcessor(inst, ctx, json, params);\n    inst.unwrap = () => inst._zod.def.innerType;\n});\nexport function promise(innerType) {\n    return new ZodPromise({\n        type: \"promise\",\n        innerType: innerType,\n    });\n}\nexport const ZodFunction = /*@__PURE__*/ core.$constructor(\"ZodFunction\", (inst, def) => {\n    core.$ZodFunction.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.functionProcessor(inst, ctx, json, params);\n});\nexport function _function(params) {\n    return new ZodFunction({\n        type: \"function\",\n        input: Array.isArray(params?.input) ? tuple(params?.input) : (params?.input ?? array(unknown())),\n        output: params?.output ?? unknown(),\n    });\n}\nexport { _function as function };\nexport const ZodCustom = /*@__PURE__*/ core.$constructor(\"ZodCustom\", (inst, def) => {\n    core.$ZodCustom.init(inst, def);\n    ZodType.init(inst, def);\n    inst._zod.processJSONSchema = (ctx, json, params) => processors.customProcessor(inst, ctx, json, params);\n});\n// custom checks\nexport function check(fn) {\n    const ch = new core.$ZodCheck({\n        check: \"custom\",\n        // ...util.normalizeParams(params),\n    });\n    ch._zod.check = fn;\n    return ch;\n}\nexport function custom(fn, _params) {\n    return core._custom(ZodCustom, fn ?? (() => true), _params);\n}\nexport function refine(fn, _params = {}) {\n    return core._refine(ZodCustom, fn, _params);\n}\n// superRefine\nexport function superRefine(fn) {\n    return core._superRefine(fn);\n}\n// Re-export describe and meta from core\nexport const describe = core.describe;\nexport const meta = core.meta;\nfunction _instanceof(cls, params = {}) {\n    const inst = new ZodCustom({\n        type: \"custom\",\n        check: \"custom\",\n        fn: (data) => data instanceof cls,\n        abort: true,\n        ...util.normalizeParams(params),\n    });\n    inst._zod.bag.Class = cls;\n    // Override check to emit invalid_type instead of custom\n    inst._zod.check = (payload) => {\n        if (!(payload.value instanceof cls)) {\n            payload.issues.push({\n                code: \"invalid_type\",\n                expected: cls.name,\n                input: payload.value,\n                inst,\n                path: [...(inst._zod.def.path ?? [])],\n            });\n        }\n    };\n    return inst;\n}\nexport { _instanceof as instanceof };\n// stringbool\nexport const stringbool = (...args) => core._stringbool({\n    Codec: ZodCodec,\n    Boolean: ZodBoolean,\n    String: ZodString,\n}, ...args);\nexport function json(params) {\n    const jsonSchema = lazy(() => {\n        return union([string(params), number(), boolean(), _null(), array(jsonSchema), record(string(), jsonSchema)]);\n    });\n    return jsonSchema;\n}\n// preprocess\n// /** @deprecated Use `z.pipe()` and `z.transform()` instead. */\nexport function preprocess(fn, schema) {\n    return pipe(transform(fn), schema);\n}\n","// ========================================\n// Logger Core Module\n// ========================================\n// Core logging functions: info, warn, error, debug\n// Type definitions and Logger class\n// ========================================\n\n// Vite import.meta.env type (subset of fields we use)\ninterface ViteImportMeta {\n    env?: {\n        PROD?: boolean;\n        DEV?: boolean;\n        MODE?: string;\n    };\n}\n\n// ========================================\n// Log Levels\n// ========================================\n\nexport enum LogLevel {\n    DEBUG = 0,\n    INFO = 1,\n    WARN = 2,\n    ERROR = 3,\n}\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Logger configuration\n */\nexport interface LoggerConfig {\n    minLevel: LogLevel;\n    enableConsole: boolean;\n    enableRemote: boolean;\n    remoteEndpoint?: string;\n    includeStackTrace: boolean;\n    maxContextSize: number;\n    sampling: SamplingConfig;\n}\n\n/**\n * Tail sampling configuration (loggingsucks.com pattern)\n * Keep 100% of errors/slow requests, sample the rest\n */\nexport interface SamplingConfig {\n    /** Always send errors (default: 1.0 = 100%) */\n    errorSampleRate: number;\n    /** Threshold in ms for \"slow\" requests */\n    slowRequestThresholdMs: number;\n    /** Always send slow requests (default: 1.0 = 100%) */\n    slowRequestSampleRate: number;\n    /** Sample rate for normal successful requests (default: 0.05 = 5%) */\n    defaultSampleRate: number;\n}\n\n/**\n * Base wide event structure\n */\nexport interface WideEvent {\n    operation: string;\n    timestamp: number;\n    sessionId?: string;\n    correlationId?: string;\n    durationMs?: number;\n    success?: boolean;\n    context?: EventContext;\n    error?: EventError;\n    data?: Record<string, unknown>;\n}\n\n/**\n * Event context - enriches events with app state\n */\nexport interface EventContext {\n    currentTab?: string;\n    sessionId?: string;\n    userAgent?: string;\n    viewportSize?: { width: number; height: number };\n    online?: boolean;\n    [key: string]: unknown;\n}\n\n/**\n * Error information for error events\n */\nexport interface EventError {\n    name: string;\n    message: string;\n    stack?: string;\n    module?: string;\n    cause?: unknown;\n    /** Whether this error can be retried (loggingsucks.com pattern) */\n    retriable?: boolean;\n}\n\n// ========================================\n// Specific Wide Event Types\n// ========================================\n\n/**\n * Data loading event\n */\nexport interface DataLoadEvent extends WideEvent {\n    operation: 'data.load';\n    data: {\n        filesLoaded: string[];\n        fileTimings: Record<string, number>;\n        totalSizeBytes?: number;\n        validationResults: {\n            valid: boolean;\n            errorCount: number;\n            warningCount: number;\n        };\n        fromCache?: boolean;\n    };\n}\n\n/**\n * Filter/search event\n */\nexport interface FilterEvent extends WideEvent {\n    operation: 'filter.apply';\n    data: {\n        tabName: string;\n        searchQuery: string;\n        filters: {\n            tier?: string;\n            rarity?: string;\n            stacking?: string;\n            favoritesOnly?: boolean;\n        };\n        totalItems: number;\n        matchedItems: number;\n        matchType?: 'exact' | 'fuzzy' | 'advanced';\n    };\n}\n\n/**\n * Build planner event\n */\nexport interface BuildPlannerEvent extends WideEvent {\n    operation: 'build.update' | 'build.save' | 'build.load' | 'build.share' | 'build.clear';\n    data: {\n        action: string;\n        characterId?: string;\n        weaponId?: string;\n        tomeIds?: string[];\n        itemIds?: string[];\n        tomesCount: number;\n        itemsCount: number;\n        source?: 'url' | 'history' | 'template' | 'manual';\n    };\n}\n\n/**\n * Calculator event\n */\nexport interface CalculatorEvent extends WideEvent {\n    operation: 'calculator.compute';\n    data: {\n        itemId: string;\n        itemName: string;\n        targetValue: number;\n        result: {\n            stacksNeeded: number;\n            perStack: number;\n            actualValue: number;\n            isCapped: boolean;\n            isOneAndDone: boolean;\n        };\n    };\n}\n\n/**\n * Chart event\n */\nexport interface ChartEvent extends WideEvent {\n    operation: 'chart.init' | 'chart.destroy' | 'chart.error';\n    data: {\n        chartId: string;\n        chartType: 'scaling' | 'compare' | 'tome';\n        dataPoints?: number;\n        itemName?: string;\n        reason?: string;\n    };\n}\n\n/**\n * Modal event\n */\nexport interface ModalEvent extends WideEvent {\n    operation: 'modal.open' | 'modal.close';\n    data: {\n        modalType: 'item' | 'weapon' | 'tome' | 'character' | 'shrine' | 'compare' | 'history';\n        entityId?: string;\n        entityName?: string;\n        hasChart?: boolean;\n    };\n}\n\n/**\n * Tab switch event\n */\nexport interface TabSwitchEvent extends WideEvent {\n    operation: 'tab.switch';\n    data: {\n        fromTab: string;\n        toTab: string;\n        itemCount: number;\n    };\n}\n\n/**\n * Error boundary event\n */\nexport interface ErrorBoundaryEvent extends WideEvent {\n    operation: 'error.boundary' | 'error.unhandled' | 'error.promise';\n    error: EventError;\n    data?: {\n        retries?: number;\n        maxRetries?: number;\n        recoveryAttempted?: boolean;\n        recoverySucceeded?: boolean;\n        userAction?: string;\n    };\n}\n\n/**\n * Module lifecycle event\n */\nexport interface ModuleEvent extends WideEvent {\n    operation: 'module.init' | 'module.init.failed' | 'module.degraded';\n    data: {\n        moduleName: string;\n        required?: boolean;\n        gracefulDegradation?: boolean;\n    };\n}\n\n/**\n * Application lifecycle event\n */\nexport interface AppLifecycleEvent extends WideEvent {\n    operation: 'app.init' | 'app.ready' | 'app.offline' | 'app.online' | 'app.update';\n    data: {\n        phase?: string;\n        modulesLoaded?: string[];\n        modulesFailed?: string[];\n        initDurationMs?: number;\n    };\n}\n\n/**\n * Validation event\n */\nexport interface ValidationEvent extends WideEvent {\n    operation: 'data.validate';\n    data: {\n        valid: boolean;\n        errorCount: number;\n        warningCount: number;\n        errors?: string[];\n        warnings?: string[];\n    };\n}\n\n// ========================================\n// Logger Class\n// ========================================\n\n/**\n * Centralized logger implementing wide events pattern\n */\nexport class Logger {\n    private static instance: Logger;\n    private config: LoggerConfig;\n    private sessionId: string;\n    private globalContext: Record<string, unknown> = {};\n    private correlationStack: string[] = [];\n\n    private constructor() {\n        this.sessionId = this.generateSessionId();\n        this.config = {\n            minLevel: this.isProduction() ? LogLevel.INFO : LogLevel.DEBUG,\n            enableConsole: true,\n            enableRemote: false,\n            includeStackTrace: !this.isProduction(),\n            maxContextSize: 10000,\n            sampling: {\n                errorSampleRate: 1.0, // Keep 100% of errors\n                slowRequestThresholdMs: 1000, // 1 second threshold\n                slowRequestSampleRate: 1.0, // Keep 100% of slow requests\n                defaultSampleRate: 0.05, // Sample 5% of normal requests\n            },\n        };\n    }\n\n    /**\n     * Get singleton instance\n     */\n    public static getInstance(): Logger {\n        if (!Logger.instance) {\n            Logger.instance = new Logger();\n        }\n        return Logger.instance;\n    }\n\n    /**\n     * Configure logger settings\n     */\n    public configure(config: Partial<LoggerConfig>): void {\n        this.config = { ...this.config, ...config };\n    }\n\n    /**\n     * Get current configuration\n     */\n    public getConfig(): LoggerConfig {\n        return { ...this.config };\n    }\n\n    /**\n     * Log debug event\n     */\n    public debug(event: Omit<WideEvent, 'timestamp' | 'sessionId'>): void {\n        this.log(LogLevel.DEBUG, event);\n    }\n\n    /**\n     * Log info event\n     */\n    public info(event: Omit<WideEvent, 'timestamp' | 'sessionId'>): void {\n        this.log(LogLevel.INFO, event);\n    }\n\n    /**\n     * Log warning event\n     */\n    public warn(event: Omit<WideEvent, 'timestamp' | 'sessionId'>): void {\n        this.log(LogLevel.WARN, event);\n    }\n\n    /**\n     * Log error event\n     */\n    public error(event: Omit<WideEvent, 'timestamp' | 'sessionId'>): void {\n        this.log(LogLevel.ERROR, event);\n    }\n\n    /**\n     * Set global context value (enriches all events)\n     */\n    public setContext(key: string, value: unknown): void {\n        this.globalContext[key] = value;\n    }\n\n    /**\n     * Clear global context value\n     */\n    public clearContext(key: string): void {\n        delete this.globalContext[key];\n    }\n\n    /**\n     * Get current global context\n     */\n    public getContext(): Record<string, unknown> {\n        return { ...this.globalContext };\n    }\n\n    /**\n     * Get session ID\n     */\n    public getSessionId(): string {\n        return this.sessionId;\n    }\n\n    /**\n     * Start a timer for measuring operation duration\n     * Returns a stop function that returns elapsed milliseconds\n     */\n    public startTimer(_name: string): () => number {\n        const start = performance.now();\n        return () => Math.round(performance.now() - start);\n    }\n\n    /**\n     * Start a correlation context for tracing related operations\n     */\n    public startOperation(name: string): string {\n        const correlationId = `${name}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\n        this.correlationStack.push(correlationId);\n        return correlationId;\n    }\n\n    /**\n     * End a correlation context\n     */\n    public endOperation(correlationId: string): void {\n        const index = this.correlationStack.indexOf(correlationId);\n        if (index > -1) {\n            this.correlationStack.splice(index, 1);\n        }\n    }\n\n    /**\n     * Get current correlation ID (most recent)\n     */\n    public getCurrentCorrelationId(): string | undefined {\n        return this.correlationStack[this.correlationStack.length - 1];\n    }\n\n    /**\n     * Wrap an async operation with logging\n     */\n    public async withOperation<T>(\n        operation: string,\n        fn: () => Promise<T>,\n        metadata?: Record<string, unknown>\n    ): Promise<T> {\n        const correlationId = this.startOperation(operation);\n        const stopTimer = this.startTimer(operation);\n\n        try {\n            const result = await fn();\n            this.info({\n                operation,\n                correlationId,\n                durationMs: stopTimer(),\n                success: true,\n                data: metadata,\n            });\n            return result;\n        } catch (error) {\n            const err = error as Error;\n            this.error({\n                operation,\n                correlationId,\n                durationMs: stopTimer(),\n                success: false,\n                error: {\n                    name: err.name,\n                    message: err.message,\n                    stack: this.config.includeStackTrace ? err.stack : undefined,\n                },\n                data: metadata,\n            });\n            throw error;\n        } finally {\n            this.endOperation(correlationId);\n        }\n    }\n\n    // ========================================\n    // Private Methods\n    // ========================================\n\n    /**\n     * Core logging method\n     */\n    private log(level: LogLevel, event: Omit<WideEvent, 'timestamp' | 'sessionId'>): void {\n        // Check log level\n        if (level < this.config.minLevel) {\n            return;\n        }\n\n        // Build full event\n        const fullEvent: WideEvent = {\n            ...event,\n            timestamp: Date.now(),\n            sessionId: this.sessionId,\n            correlationId: event.correlationId || this.getCurrentCorrelationId(),\n            context: this.buildContext(event.context),\n        };\n\n        // Output to console\n        if (this.config.enableConsole) {\n            this.outputToConsole(level, fullEvent);\n        }\n\n        // Send to remote endpoint (if configured)\n        if (this.config.enableRemote && this.config.remoteEndpoint) {\n            this.sendToRemote(fullEvent);\n        }\n    }\n\n    /**\n     * Build context with global context merged\n     */\n    private buildContext(eventContext?: EventContext): EventContext {\n        const context: EventContext = {\n            ...this.globalContext,\n            ...eventContext,\n            sessionId: this.sessionId,\n            online: typeof navigator !== 'undefined' ? navigator.onLine : true,\n        };\n\n        // Add viewport size if in browser\n        if (typeof window !== 'undefined') {\n            context.viewportSize = {\n                width: window.innerWidth,\n                height: window.innerHeight,\n            };\n        }\n\n        return context;\n    }\n\n    /**\n     * Output to console with appropriate formatting\n     */\n    private outputToConsole(level: LogLevel, event: WideEvent): void {\n        const levelNames = ['DEBUG', 'INFO', 'WARN', 'ERROR'];\n        const levelColors = ['#6b7280', '#3b82f6', '#f59e0b', '#ef4444'];\n        const levelMethods = [console.debug, console.info, console.warn, console.error];\n\n        const levelName = levelNames[level] ?? 'INFO';\n        const color = levelColors[level] ?? '#3b82f6';\n        const method = levelMethods[level] ?? console.info;\n\n        if (this.isProduction()) {\n            // Production: minimal JSON output\n            method(JSON.stringify(event));\n        } else {\n            // Development: formatted output\n            const duration = event.durationMs ? ` (${event.durationMs}ms)` : '';\n            const success = event.success !== undefined ? (event.success ? ' OK' : ' FAIL') : '';\n\n            method(\n                `%c[${levelName}]%c ${event.operation}${duration}${success}`,\n                `color: ${color}; font-weight: bold;`,\n                'color: inherit;',\n                event\n            );\n        }\n    }\n\n    /**\n     * Determine if event should be sampled for remote logging\n     * Implements tail sampling from loggingsucks.com:\n     * - Keep 100% of errors\n     * - Keep 100% of slow requests\n     * - Random sample the rest\n     */\n    private shouldSample(event: WideEvent): boolean {\n        const { sampling } = this.config;\n\n        // Always keep errors\n        if (event.error || event.success === false) {\n            return Math.random() < sampling.errorSampleRate;\n        }\n\n        // Always keep slow requests\n        if (event.durationMs && event.durationMs > sampling.slowRequestThresholdMs) {\n            return Math.random() < sampling.slowRequestSampleRate;\n        }\n\n        // Random sample normal requests\n        return Math.random() < sampling.defaultSampleRate;\n    }\n\n    /**\n     * Send event to remote endpoint (batched with tail sampling)\n     */\n    private remoteBuffer: WideEvent[] = [];\n    private remoteFlushTimeout: ReturnType<typeof setTimeout> | null = null;\n\n    private sendToRemote(event: WideEvent): void {\n        // Apply tail sampling\n        if (!this.shouldSample(event)) {\n            return;\n        }\n\n        this.remoteBuffer.push(event);\n\n        // Flush if buffer is full\n        if (this.remoteBuffer.length >= 50) {\n            this.flushRemoteBuffer();\n            return;\n        }\n\n        // Schedule flush if not already scheduled\n        if (!this.remoteFlushTimeout) {\n            this.remoteFlushTimeout = setTimeout(() => this.flushRemoteBuffer(), 5000);\n        }\n    }\n\n    private flushRemoteBuffer(): void {\n        if (this.remoteBuffer.length === 0) return;\n\n        const batch = this.remoteBuffer.splice(0, this.remoteBuffer.length);\n        this.remoteFlushTimeout = null;\n\n        if (this.config.remoteEndpoint) {\n            fetch(this.config.remoteEndpoint, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify(batch),\n                keepalive: true,\n            }).catch(() => {\n                // Re-add to buffer on failure (with limit)\n                if (this.remoteBuffer.length < 100) {\n                    this.remoteBuffer.unshift(...batch);\n                }\n            });\n        }\n    }\n\n    /**\n     * Generate unique session ID\n     */\n    private generateSessionId(): string {\n        return `${Date.now()}-${Math.random().toString(36).slice(2, 11)}`;\n    }\n\n    /**\n     * Check if running in production\n     */\n    private isProduction(): boolean {\n        // Vite sets import.meta.env.PROD\n        try {\n            return (import.meta as ViteImportMeta).env?.PROD === true;\n        } catch {\n            return false;\n        }\n    }\n}\n\n// ========================================\n// Exports\n// ========================================\n\n/**\n * Singleton logger instance\n */\nexport const logger = Logger.getInstance();\n","// ========================================\n// Schema Validator Module\n// ========================================\n// Uses Zod for runtime type validation of JSON data\n// TypeScript types are automatically inferred from Zod schemas\n// ========================================\n\nimport { z, ZodError, ZodIssue } from 'zod';\nimport { logger } from './logger.ts';\nimport type { ValidationResult } from '../types/index.ts';\n\n/**\n * Common schemas\n */\nconst ScalingSchema = z\n    .object({\n        formula: z.string(),\n        min: z.number().optional(),\n        max: z.number().optional(),\n        cap: z.number().optional(),\n    })\n    .optional();\n\n/**\n * Item schema - matches actual items.json structure\n */\nconst ItemSchema = z.object({\n    id: z.string(),\n    name: z.string(),\n    rarity: z.enum(['common', 'uncommon', 'rare', 'epic', 'legendary']),\n    tier: z.enum(['SS', 'S', 'A', 'B', 'C']),\n    unlocked_by_default: z.boolean().optional(),\n    unlock_requirement: z.string().nullable().optional(),\n    unlock_cost_silver: z.number().optional(),\n    base_effect: z.string().optional(),\n    scaling_type: z.string().optional(),\n    stacking_behavior: z.string().optional(),\n    stacks_well: z.boolean().optional(),\n    stack_cap: z.number().nullable().optional(),\n    formula: z.string().optional(),\n    scaling_per_stack: z.array(z.number()).optional(),\n    detailed_description: z.string().optional(),\n    synergies: z.array(z.string()).optional(),\n    anti_synergies: z.array(z.string()).optional(),\n    notes: z.string().optional(),\n    graph_type: z.string().optional(),\n    one_and_done: z.boolean().optional(),\n    image: z.string().optional(),\n});\n\n/**\n * Weapon schema - matches actual weapons.json structure\n */\nconst WeaponSchema = z.object({\n    id: z.string(),\n    name: z.string(),\n    tier: z.enum(['SS', 'S', 'A', 'B', 'C']),\n    base_damage: z.number().optional(),\n    base_projectile_count: z.number().optional(),\n    attack_pattern: z.string().optional(),\n    upgradeable_stats: z.array(z.string()).optional(),\n    unlock_requirement: z.string().nullable().optional(),\n    unlock_cost_silver: z.number().optional(),\n    unlocked_by_default: z.boolean().optional(),\n    description: z.string().optional(),\n    best_for: z.array(z.string()).optional(),\n    synergies_items: z.array(z.string()).optional(),\n    synergies_tomes: z.array(z.string()).optional(),\n    synergies_characters: z.array(z.string()).optional(),\n    playstyle: z.string().optional(),\n    pros: z.array(z.string()).optional(),\n    cons: z.array(z.string()).optional(),\n    image: z.string().optional(),\n});\n\n/**\n * Tome schema - matches actual tomes.json structure\n */\nconst TomeSchema = z.object({\n    id: z.string(),\n    name: z.string(),\n    tier: z.enum(['SS', 'S', 'A', 'B', 'C']),\n    stat_affected: z.string().optional(),\n    value_per_level: z.string().optional(),\n    unlocked_by_default: z.boolean().optional(),\n    unlock_requirement: z.string().nullable().optional(),\n    unlock_cost_silver: z.number().optional(),\n    max_level: z.number().optional(),\n    description: z.string().optional(),\n    priority: z.number().optional(),\n    recommended_for: z.array(z.string()).optional(),\n    synergies_items: z.array(z.string()).optional(),\n    synergies_weapons: z.array(z.string()).optional(),\n    synergies_characters: z.array(z.string()).optional(),\n    notes: z.string().optional(),\n    image: z.string().optional(),\n});\n\n/**\n * Character schema - matches actual characters.json structure\n */\nconst CharacterSchema = z.object({\n    id: z.string(),\n    name: z.string(),\n    tier: z.enum(['SS', 'S', 'A', 'B', 'C']),\n    starting_weapon: z.string().optional(),\n    passive_ability: z.string().optional(),\n    passive_description: z.string().optional(),\n    unlock_requirement: z.string().nullable().optional(),\n    unlock_cost_silver: z.number().optional(),\n    unlocked_by_default: z.boolean().optional(),\n    playstyle: z.string().optional(),\n    best_for: z.array(z.string()).optional(),\n    strengths: z.array(z.string()).optional(),\n    weaknesses: z.array(z.string()).optional(),\n    synergies_items: z.array(z.string()).optional(),\n    synergies_tomes: z.array(z.string()).optional(),\n    synergies_weapons: z.array(z.string()).optional(),\n    build_tips: z.string().optional(),\n    image: z.string().optional(),\n});\n\n/**\n * Shrine schema - matches actual shrines.json structure\n */\nconst ShrineSchema = z.object({\n    id: z.string(),\n    name: z.string(),\n    type: z.string().optional(),\n    icon: z.string().optional(),\n    description: z.string().optional(),\n    activation: z.string().optional(),\n    reward: z.string().optional(),\n    reusable: z.boolean().optional(),\n    spawn_count: z.string().optional(),\n    map_icon: z.string().optional(),\n    best_for: z.array(z.string()).optional(),\n    synergies_items: z.array(z.string()).optional(),\n    strategy: z.string().optional(),\n    notes: z.string().optional(),\n    image: z.string().optional(),\n});\n\n/**\n * Stats schema\n * Using z.unknown() for mechanics/breakpoints as they contain arbitrary nested data\n */\nconst StatsSchema = z.object({\n    version: z.string().optional(),\n    last_updated: z.string().optional(),\n    mechanics: z.record(z.string(), z.unknown()).optional(),\n    breakpoints: z.record(z.string(), z.unknown()).optional(),\n});\n\n/**\n * Data collection schemas - using passthrough() to allow extra fields like total_items\n */\nconst ItemsDataSchema = z\n    .object({\n        version: z.string(),\n        last_updated: z.string(),\n        total_items: z.number().optional(),\n        items: z.array(ItemSchema),\n    })\n    .passthrough();\n\nconst WeaponsDataSchema = z\n    .object({\n        version: z.string(),\n        last_updated: z.string(),\n        total_weapons: z.number().optional(),\n        weapons: z.array(WeaponSchema),\n    })\n    .passthrough();\n\nconst TomesDataSchema = z\n    .object({\n        version: z.string(),\n        last_updated: z.string(),\n        total_tomes: z.number().optional(),\n        tomes: z.array(TomeSchema),\n    })\n    .passthrough();\n\nconst CharactersDataSchema = z\n    .object({\n        version: z.string(),\n        last_updated: z.string(),\n        total_characters: z.number().optional(),\n        characters: z.array(CharacterSchema),\n    })\n    .passthrough();\n\nconst ShrinesDataSchema = z\n    .object({\n        version: z.string(),\n        last_updated: z.string(),\n        total_shrines: z.number().optional(),\n        shrines: z.array(ShrineSchema),\n    })\n    .passthrough();\n\n// ========================================\n// TypeScript Types Inferred from Zod Schemas\n// ========================================\n// These types are automatically generated from the Zod schemas above\n// This means we only define the structure once!\n\nexport type Scaling = z.infer<typeof ScalingSchema>;\nexport type ZodItem = z.infer<typeof ItemSchema>;\nexport type ZodWeapon = z.infer<typeof WeaponSchema>;\nexport type ZodTome = z.infer<typeof TomeSchema>;\nexport type ZodCharacter = z.infer<typeof CharacterSchema>;\nexport type ZodShrine = z.infer<typeof ShrineSchema>;\nexport type ZodStats = z.infer<typeof StatsSchema>;\nexport type ZodItemsData = z.infer<typeof ItemsDataSchema>;\nexport type ZodWeaponsData = z.infer<typeof WeaponsDataSchema>;\nexport type ZodTomesData = z.infer<typeof TomesDataSchema>;\nexport type ZodCharactersData = z.infer<typeof CharactersDataSchema>;\nexport type ZodShrinesData = z.infer<typeof ShrinesDataSchema>;\n\n// ========================================\n// Validation Functions\n// ========================================\n\n/**\n * Validate data against a schema\n */\nexport function validateData<T>(data: unknown, schema: z.ZodSchema<T>, dataType: string): ValidationResult<T> {\n    try {\n        const validatedData = schema.parse(data);\n        return {\n            success: true,\n            data: validatedData,\n        };\n    } catch (error) {\n        const err = error as Error;\n        logger.error({\n            operation: 'schema.validate',\n            error: {\n                name: err.name,\n                message: err.message,\n                module: 'schema-validator',\n            },\n            data: { dataType },\n        });\n\n        // Format Zod errors for better readability\n        let errorMessages: string;\n        if (error instanceof z.ZodError) {\n            const zodError = error as ZodError;\n            errorMessages = zodError.issues.map((err: ZodIssue) => `${err.path.join('.')}: ${err.message}`).join(', ');\n        } else if (error instanceof Error) {\n            errorMessages = error.message;\n        } else {\n            errorMessages = 'Unknown error';\n        }\n\n        return {\n            success: false,\n            error: `Invalid ${dataType} data: ${errorMessages}`,\n            zodError: error instanceof z.ZodError ? error : undefined,\n        };\n    }\n}\n\n/**\n * Validate items data\n */\nexport function validateItems(data: unknown): ValidationResult<ZodItemsData> {\n    return validateData(data, ItemsDataSchema, 'items');\n}\n\n/**\n * Validate weapons data\n */\nexport function validateWeapons(data: unknown): ValidationResult<ZodWeaponsData> {\n    return validateData(data, WeaponsDataSchema, 'weapons');\n}\n\n/**\n * Validate tomes data\n */\nexport function validateTomes(data: unknown): ValidationResult<ZodTomesData> {\n    return validateData(data, TomesDataSchema, 'tomes');\n}\n\n/**\n * Validate characters data\n */\nexport function validateCharacters(data: unknown): ValidationResult<ZodCharactersData> {\n    return validateData(data, CharactersDataSchema, 'characters');\n}\n\n/**\n * Validate shrines data\n */\nexport function validateShrines(data: unknown): ValidationResult<ZodShrinesData> {\n    return validateData(data, ShrinesDataSchema, 'shrines');\n}\n\n/**\n * Validate stats data\n */\nexport function validateStats(data: unknown): ValidationResult<ZodStats> {\n    return validateData(data, StatsSchema, 'stats');\n}\n\n/**\n * Validation results for all data types\n */\nexport interface AllDataValidationResults {\n    items: ValidationResult<ZodItemsData> | null;\n    weapons: ValidationResult<ZodWeaponsData> | null;\n    tomes: ValidationResult<ZodTomesData> | null;\n    characters: ValidationResult<ZodCharactersData> | null;\n    shrines: ValidationResult<ZodShrinesData> | null;\n    stats: ValidationResult<ZodStats> | null;\n    allValid: boolean;\n}\n\n/**\n * Validate all game data\n */\nexport function validateAllData(allData: {\n    items?: unknown;\n    weapons?: unknown;\n    tomes?: unknown;\n    characters?: unknown;\n    shrines?: unknown;\n    stats?: unknown;\n}): AllDataValidationResults {\n    const results: AllDataValidationResults = {\n        items: null,\n        weapons: null,\n        tomes: null,\n        characters: null,\n        shrines: null,\n        stats: null,\n        allValid: true,\n    };\n\n    if (allData.items) {\n        results.items = validateItems(allData.items);\n        if (!results.items.success) results.allValid = false;\n    }\n\n    if (allData.weapons) {\n        results.weapons = validateWeapons(allData.weapons);\n        if (!results.weapons.success) results.allValid = false;\n    }\n\n    if (allData.tomes) {\n        results.tomes = validateTomes(allData.tomes);\n        if (!results.tomes.success) results.allValid = false;\n    }\n\n    if (allData.characters) {\n        results.characters = validateCharacters(allData.characters);\n        if (!results.characters.success) results.allValid = false;\n    }\n\n    if (allData.shrines) {\n        results.shrines = validateShrines(allData.shrines);\n        if (!results.shrines.success) results.allValid = false;\n    }\n\n    if (allData.stats) {\n        results.stats = validateStats(allData.stats);\n        if (!results.stats.success) results.allValid = false;\n    }\n\n    return results;\n}\n\n/**\n * Export schemas for direct use if needed\n */\nexport const schemas = {\n    Item: ItemSchema,\n    Weapon: WeaponSchema,\n    Tome: TomeSchema,\n    Character: CharacterSchema,\n    Shrine: ShrineSchema,\n    Stats: StatsSchema,\n    ItemsData: ItemsDataSchema,\n    WeaponsData: WeaponsDataSchema,\n    TomesData: TomesDataSchema,\n    CharactersData: CharactersDataSchema,\n    ShrinesData: ShrinesDataSchema,\n} as const;\n","// ========================================\n// MegaBonk Constants Module\n// ========================================\n\nimport type { Tier, Rarity } from '../types/index.ts';\n\n/**\n * Build stats definition\n */\nexport interface BuildStats {\n    damage: number;\n    hp: number;\n    crit_chance: number;\n    crit_damage: number;\n    attack_speed: number;\n    movement_speed: number;\n    armor: number;\n    evasion_internal: number;\n    projectiles: number;\n}\n\n/**\n * Valid stat keys for item effects\n */\nexport type StatKey = keyof BuildStats;\n\n/**\n * Item stat effect definition\n */\nexport interface ItemEffect {\n    stat: StatKey;\n    value: number;\n    type: 'add' | 'multiply' | 'hp_percent';\n}\n\n// Tier ordering for sorting (lower = better)\nexport const TIER_ORDER: Readonly<Record<Tier, number>> = Object.freeze({\n    SS: 0,\n    S: 1,\n    A: 2,\n    B: 3,\n    C: 4,\n});\n\n// Rarity ordering for sorting (lower = rarer)\nexport const RARITY_ORDER: Readonly<Record<Rarity, number>> = Object.freeze({\n    legendary: 0,\n    epic: 1,\n    rare: 2,\n    uncommon: 3,\n    common: 4,\n});\n\n// Item IDs used in build calculations\nexport const ITEM_IDS = Object.freeze({\n    GYM_SAUCE: 'gym_sauce',\n    FORBIDDEN_JUICE: 'forbidden_juice',\n    OATS: 'oats',\n    BATTERY: 'battery',\n    TURBO_SOCKS: 'turbo_socks',\n    BEER: 'beer',\n    BACKPACK: 'backpack',\n    SLIPPERY_RING: 'slippery_ring',\n    PHANTOM_SHROUD: 'phantom_shroud',\n    BEEFY_RING: 'beefy_ring',\n    LEECHING_CRYSTAL: 'leeching_crystal',\n    BRASS_KNUCKLES: 'brass_knuckles',\n    BOSS_BUSTER: 'boss_buster',\n} as const);\n\n// Item stat effects for build calculator\n// Maps item ID to stat modifications\nexport const ITEM_EFFECTS: Readonly<Record<string, ItemEffect>> = Object.freeze({\n    [ITEM_IDS.GYM_SAUCE]: { stat: 'damage', value: 10, type: 'add' },\n    [ITEM_IDS.FORBIDDEN_JUICE]: { stat: 'crit_chance', value: 10, type: 'add' },\n    [ITEM_IDS.OATS]: { stat: 'hp', value: 25, type: 'add' },\n    [ITEM_IDS.BATTERY]: { stat: 'attack_speed', value: 8, type: 'add' },\n    [ITEM_IDS.TURBO_SOCKS]: { stat: 'movement_speed', value: 15, type: 'add' },\n    [ITEM_IDS.BEER]: { stat: 'damage', value: 20, type: 'add' },\n    [ITEM_IDS.BACKPACK]: { stat: 'projectiles', value: 1, type: 'add' },\n    [ITEM_IDS.SLIPPERY_RING]: { stat: 'evasion_internal', value: 15, type: 'add' },\n    [ITEM_IDS.PHANTOM_SHROUD]: { stat: 'evasion_internal', value: 15, type: 'add' },\n    [ITEM_IDS.BEEFY_RING]: { stat: 'damage', value: 20, type: 'hp_percent' },\n    [ITEM_IDS.LEECHING_CRYSTAL]: { stat: 'hp', value: 1.5, type: 'multiply' },\n    [ITEM_IDS.BRASS_KNUCKLES]: { stat: 'damage', value: 20, type: 'add' },\n    [ITEM_IDS.BOSS_BUSTER]: { stat: 'damage', value: 15, type: 'add' },\n});\n\n// Default stat values for build calculator\nexport const DEFAULT_BUILD_STATS: Readonly<BuildStats> = Object.freeze({\n    damage: 100,\n    hp: 100,\n    crit_chance: 5,\n    crit_damage: 150,\n    attack_speed: 100,\n    movement_speed: 100,\n    armor: 0,\n    evasion_internal: 0,\n    projectiles: 1,\n});\n\n// Bug fix #14: Define magic numbers as constants\nexport const MAX_COMPARE_ITEMS = 3;\nexport const BUILD_ITEMS_LIMIT = 40;\nexport const VALID_TIERS: readonly Tier[] = Object.freeze(['SS', 'S', 'A', 'B', 'C']);\nexport const VALID_RARITIES: readonly Rarity[] = Object.freeze(['common', 'uncommon', 'rare', 'epic', 'legendary']);\n\n// QA Round 3: Centralized limits\nexport const MAX_ITEM_COUNT = 99; // Maximum count per item in scan build\nexport const MAX_FILE_SIZE_BYTES = 10 * 1024 * 1024; // 10MB file upload limit\nexport const MAX_BUILD_HISTORY = 20; // Maximum saved builds in history\nexport const MAX_SEARCH_HISTORY = 10; // Maximum saved search terms\nexport const MAX_RECENT_ITEMS = 10; // Maximum recently viewed items\nexport const MAX_GLOBAL_SEARCH_RESULTS = 100; // Maximum global search results\nexport const MAX_SEARCH_RESULTS_PER_TYPE = 30; // Maximum results per entity type in global search\n\n// ========================================\n// Feature Flags\n// ========================================\n// Toggle features on/off for gradual rollout or A/B testing\n\nexport const FEATURES = Object.freeze({\n    /** Enable item comparison feature (plus button on cards) */\n    COMPARE_ITEMS: false,\n    /** Enable build scanning from screenshots */\n    BUILD_SCANNER: true,\n    /** Enable AI-powered build advisor */\n    BUILD_ADVISOR: true,\n    /** Enable pull-to-refresh on mobile */\n    PULL_TO_REFRESH: true,\n    /** Enable favorites feature (heart button on cards) */\n    FAVORITES: false,\n    /** Enable view-details button on cards */\n    VIEW_DETAILS_BUTTON: false,\n    /** Enable modal backdrop click to close */\n    MODAL_BACKDROP_CLOSE: false,\n    /** Enable tab scroll indicators */\n    TAB_SCROLL_INDICATORS: false,\n    /** Enable search focus behavior (history dropdown) */\n    SEARCH_FOCUS_HISTORY: false,\n    /** Enable mobile \"More\" menu with dynamic styles */\n    MOBILE_MORE_MENU: false,\n    /** Enable online/offline toast notifications */\n    OFFLINE_NOTIFICATIONS: false,\n});\n","// ========================================\n// MegaBonk Data Validation Module\n// Uses Zod for schema validation and cross-reference checking\n// ========================================\n\nimport {\n    validateItems,\n    validateWeapons,\n    validateTomes,\n    validateCharacters,\n    validateShrines,\n    validateStats,\n} from './schema-validator.ts';\nimport { VALID_RARITIES, VALID_TIERS } from './constants.ts';\nimport { logger } from './logger.ts';\nimport type { ValidationResult, AllGameData, EntityType, Rarity, Tier } from '../types/index.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Legacy validation result (basic structure checks)\n */\nexport interface LegacyValidationResult {\n    valid: boolean;\n    errors: string[];\n}\n\n/**\n * Comprehensive validation result\n */\nexport interface ComprehensiveValidationResult {\n    valid: boolean;\n    errors: string[];\n    warnings: string[];\n}\n\n/**\n * Zod validation wrapper result\n */\nexport interface ZodValidationResult {\n    valid: boolean;\n    errors: string[];\n    data?: unknown;\n}\n\n// ========================================\n// Zod Schema Validation (Runtime Type Safety)\n// ========================================\n\n/**\n * Validate data using Zod schemas\n */\nexport function validateWithZod(data: unknown, type: EntityType | 'stats'): ZodValidationResult {\n    let result: ValidationResult<unknown>;\n\n    switch (type) {\n        case 'items':\n            result = validateItems(data);\n            break;\n        case 'weapons':\n            result = validateWeapons(data);\n            break;\n        case 'tomes':\n            result = validateTomes(data);\n            break;\n        case 'characters':\n            result = validateCharacters(data);\n            break;\n        case 'shrines':\n            result = validateShrines(data);\n            break;\n        case 'stats':\n            result = validateStats(data);\n            break;\n        default:\n            return { valid: false, errors: [`Unknown data type: ${type}`] };\n    }\n\n    if (result.success) {\n        return { valid: true, errors: [], data: result.data };\n    } else {\n        return { valid: false, errors: [result.error || 'Unknown validation error'] };\n    }\n}\n\n// ========================================\n// Legacy Validation (Basic Structure Checks)\n// ========================================\n\n/**\n * Entity with basic structure\n */\ninterface BasicEntity {\n    id?: string;\n    name?: string;\n    rarity?: string;\n    tier?: string;\n    description?: string;\n    detailed_description?: string;\n}\n\n/**\n * Data structure with version info and dynamic entity array access\n * Represents the common structure of all data wrapper types (ItemsData, WeaponsData, etc.)\n */\ninterface DataStructure {\n    version?: string;\n    last_updated?: string;\n    [key: string]: unknown;\n}\n\n/**\n * Validate basic data structure (runtime validation without Zod)\n */\nexport function validateDataStructure(\n    data: DataStructure | null | undefined,\n    type: EntityType\n): LegacyValidationResult {\n    const errors: string[] = [];\n\n    if (!data) {\n        errors.push(`${type}: Data is null or undefined`);\n        return { valid: false, errors };\n    }\n\n    // Check for version and last_updated\n    if (!data.version) {\n        errors.push(`${type}: Missing 'version' field`);\n    }\n\n    if (!data.last_updated) {\n        errors.push(`${type}: Missing 'last_updated' field`);\n    }\n\n    // Check for data array\n    const dataArray = data[type];\n    if (!Array.isArray(dataArray)) {\n        errors.push(`${type}: Data array is missing or not an array`);\n        return { valid: false, errors };\n    }\n\n    // Validate each entity\n    dataArray.forEach((entity: BasicEntity, index: number) => {\n        // Required fields for all entities\n        if (!entity.id) {\n            errors.push(`${type}[${index}]: Missing 'id' field`);\n        }\n        if (!entity.name) {\n            errors.push(`${type}[${index}]: Missing 'name' field`);\n        }\n\n        // Type-specific validations\n        if (type === 'items') {\n            if (!entity.rarity) {\n                errors.push(`${type}[${index}] (${entity.name || entity.id}): Missing 'rarity' field`);\n            }\n            if (!entity.tier) {\n                errors.push(`${type}[${index}] (${entity.name || entity.id}): Missing 'tier' field`);\n            }\n            if (!entity.detailed_description) {\n                errors.push(`${type}[${index}] (${entity.name || entity.id}): Missing 'detailed_description' field`);\n            }\n        }\n\n        if (type === 'weapons' || type === 'tomes' || type === 'characters') {\n            if (!entity.tier) {\n                errors.push(`${type}[${index}] (${entity.name || entity.id}): Missing 'tier' field`);\n            }\n        }\n    });\n\n    return { valid: errors.length === 0, errors };\n}\n\n/**\n * Validate cross-references between data types\n */\nexport function validateCrossReferences(allData: AllGameData | null | undefined): LegacyValidationResult {\n    const errors: string[] = [];\n\n    if (!allData) {\n        errors.push('Cross-reference validation: allData is null or undefined');\n        return { valid: false, errors };\n    }\n\n    // Build ID sets for quick lookup\n    const itemIds = new Set((allData.items?.items || []).map(i => i.id));\n    const weaponIds = new Set((allData.weapons?.weapons || []).map(w => w.id));\n    const tomeIds = new Set((allData.tomes?.tomes || []).map(t => t.id));\n    const characterIds = new Set((allData.characters?.characters || []).map(c => c.id));\n\n    // Validate synergies in items (if they reference other items/weapons/tomes)\n    const items = allData.items?.items || [];\n    items.forEach((item, index) => {\n        if (item.synergies) {\n            if (Array.isArray(item.synergies)) {\n                item.synergies.forEach((synergy, sIndex) => {\n                    if (typeof synergy === 'object' && synergy !== null && 'with' in synergy) {\n                        const synergyWith = (synergy as { with?: string | string[] }).with;\n                        // Check if synergy references valid entities\n                        const refs = Array.isArray(synergyWith) ? synergyWith : synergyWith ? [synergyWith] : [];\n                        refs.forEach(ref => {\n                            if (\n                                !itemIds.has(ref) &&\n                                !weaponIds.has(ref) &&\n                                !tomeIds.has(ref) &&\n                                !characterIds.has(ref)\n                            ) {\n                                errors.push(\n                                    `items[${index}] (${item.name}): synergy[${sIndex}] references unknown entity '${ref}'`\n                                );\n                            }\n                        });\n                    }\n                });\n            }\n        }\n    });\n\n    // Validate character passives that might reference items\n    const characters = allData.characters?.characters || [];\n    characters.forEach((character, index) => {\n        if ('passive_item_ref' in character) {\n            const passiveItemRef = (character as { passive_item_ref?: string }).passive_item_ref;\n            if (passiveItemRef && !itemIds.has(passiveItemRef)) {\n                errors.push(\n                    `characters[${index}] (${character.name}): passive_item_ref '${passiveItemRef}' not found in items`\n                );\n            }\n        }\n    });\n\n    // Validate weapon upgrade paths\n    const weapons = allData.weapons?.weapons || [];\n    weapons.forEach((weapon, index) => {\n        if ('upgrades_from' in weapon) {\n            const upgradesFrom = (weapon as { upgrades_from?: string }).upgrades_from;\n            if (upgradesFrom && !weaponIds.has(upgradesFrom)) {\n                errors.push(`weapons[${index}] (${weapon.name}): upgrades_from '${upgradesFrom}' not found in weapons`);\n            }\n        }\n        if ('upgrades_to' in weapon) {\n            const upgradesTo = (weapon as { upgrades_to?: string | string[] }).upgrades_to;\n            const upgradeTo = Array.isArray(upgradesTo) ? upgradesTo : upgradesTo ? [upgradesTo] : [];\n            upgradeTo.forEach(target => {\n                if (!weaponIds.has(target)) {\n                    errors.push(`weapons[${index}] (${weapon.name}): upgrades_to '${target}' not found in weapons`);\n                }\n            });\n        }\n    });\n\n    return { valid: errors.length === 0, errors };\n}\n\n/**\n * Validate rarity values\n */\nexport function validateRarity(entity: BasicEntity, type: string, index: number): string[] {\n    const errors: string[] = [];\n\n    if (entity.rarity && !VALID_RARITIES.includes(entity.rarity.toLowerCase() as Rarity)) {\n        errors.push(\n            `${type}[${index}] (${entity.name}): Invalid rarity '${entity.rarity}'. Must be one of: ${VALID_RARITIES.join(', ')}`\n        );\n    }\n\n    return errors;\n}\n\n/**\n * Validate tier values\n */\nexport function validateTier(entity: BasicEntity, type: string, index: number): string[] {\n    const errors: string[] = [];\n\n    if (entity.tier && !VALID_TIERS.includes(entity.tier as Tier)) {\n        errors.push(\n            `${type}[${index}] (${entity.name}): Invalid tier '${entity.tier}'. Must be one of: ${VALID_TIERS.join(', ')}`\n        );\n    }\n\n    return errors;\n}\n\n/**\n * Comprehensive validation of all game data\n */\nexport function validateAllData(allData: AllGameData | null | undefined): ComprehensiveValidationResult {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n\n    if (!allData) {\n        return { valid: false, errors: ['No data provided for validation'], warnings: [] };\n    }\n\n    // Validate structure for each data type\n    const dataTypes: EntityType[] = ['items', 'weapons', 'tomes', 'characters', 'shrines'];\n    dataTypes.forEach(type => {\n        const data = allData[type] as DataStructure | undefined;\n        if (data) {\n            const result = validateDataStructure(data, type);\n            errors.push(...result.errors);\n        } else {\n            warnings.push(`${type}: Data not loaded`);\n        }\n    });\n\n    // Validate rarity and tier values\n    if (allData.items?.items) {\n        allData.items.items.forEach((item, index) => {\n            errors.push(...validateRarity(item, 'items', index));\n            errors.push(...validateTier(item, 'items', index));\n        });\n    }\n\n    (['weapons', 'tomes', 'characters'] as const).forEach(type => {\n        const dataForType = allData[type] as { [key: string]: BasicEntity[] } | undefined;\n        const entities = dataForType?.[type] || [];\n        entities.forEach((entity: BasicEntity, index: number) => {\n            errors.push(...validateTier(entity, type, index));\n        });\n    });\n\n    // Validate cross-references\n    const crossRefResult = validateCrossReferences(allData);\n    errors.push(...crossRefResult.errors);\n\n    // Additional warnings for missing recommended fields\n    if (allData.items?.items) {\n        allData.items.items.forEach((item, index) => {\n            if (!item.image) {\n                warnings.push(`items[${index}] (${item.name}): Missing recommended 'image' field`);\n            }\n            if (!item.tags || item.tags.length === 0) {\n                warnings.push(`items[${index}] (${item.name}): Missing recommended 'tags' field`);\n            }\n        });\n    }\n\n    if (allData.tomes?.tomes) {\n        allData.tomes.tomes.forEach((tome, index) => {\n            if (!tome.image) {\n                warnings.push(`tomes[${index}] (${tome.name}): Missing recommended 'image' field`);\n            }\n            if (!tome.tags || tome.tags.length === 0) {\n                warnings.push(`tomes[${index}] (${tome.name}): Missing recommended 'tags' field`);\n            }\n        });\n    }\n\n    return {\n        valid: errors.length === 0,\n        errors,\n        warnings,\n    };\n}\n\n/**\n * Log validation results using wide events\n */\nexport function logValidationResults(result: ComprehensiveValidationResult): void {\n    if (result.valid) {\n        logger.info({\n            operation: 'data.validate',\n            success: true,\n            data: {\n                valid: true,\n                errorCount: 0,\n                warningCount: result.warnings.length,\n            },\n        });\n    } else {\n        logger.error({\n            operation: 'data.validate',\n            success: false,\n            data: {\n                valid: false,\n                errorCount: result.errors.length,\n                warningCount: result.warnings.length,\n                errors: result.errors.slice(0, 10), // Limit to first 10 errors\n            },\n        });\n    }\n\n    if (result.warnings.length > 0) {\n        logger.warn({\n            operation: 'data.validate',\n            data: {\n                warningCount: result.warnings.length,\n                warnings: result.warnings.slice(0, 10), // Limit to first 10 warnings\n            },\n        });\n    }\n}\n\n// ========================================\n// Note: All functions exported as ES modules\n// ========================================\n","// ========================================\n// MegaBonk Type Definitions\n// ========================================\n// Central type definitions for the entire application\n// NOTE: Properties use snake_case to match JSON data structure.\n// This is intentional for 1:1 JSON mapping without transformation.\n// ========================================\n\n/**\n * Rarity types\n */\nexport type Rarity = 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary';\n\n/**\n * Scaling track definition for items with multiple scaling paths\n */\nexport interface ScalingTrack {\n    stat: string;\n    values: number[];\n}\n\n/**\n * Tier types\n */\nexport type Tier = 'SS' | 'S' | 'A' | 'B' | 'C';\n\n/**\n * Scaling formula definition\n */\nexport interface Scaling {\n    formula: string;\n    min?: number;\n    max?: number;\n    cap?: number;\n}\n\n/**\n * Item interface\n */\nexport interface Item {\n    id: string;\n    name: string;\n    description: string;\n    tier: Tier;\n    rarity: Rarity;\n    image?: string;\n    category?: string;\n    tags?: string[];\n    cooldown?: number;\n    damage?: number | string;\n    healing?: number | string;\n    scaling?: Scaling;\n    synergies?: string[];\n    antiSynergies?: string[];\n    // Calculator/scaling properties\n    formula?: string;\n    scaling_type?: string;\n    scaling_per_stack?: number[];\n    stack_cap?: number;\n    one_and_done?: boolean;\n    stacks_well?: boolean;\n    // Compare module properties\n    base_effect?: string;\n    graph_type?: string;\n    notes?: string;\n    anti_synergies?: string[];\n    // Build planner properties\n    synergies_weapons?: string[];\n    // Modal/chart properties\n    detailed_description?: string;\n    hidden_mechanics?: string[];\n    scaling_tracks?: Record<string, ScalingTrack>;\n    scaling_formula_type?: string;\n    hyperbolic_constant?: number;\n    max_stacks?: number;\n    secondary_scaling?: number[] | { stat: string; values: number[] };\n}\n\n/**\n * Weapon upgrade definition\n */\nexport interface WeaponUpgrade {\n    level: number;\n    bonus: string;\n    cost?: number;\n}\n\n/**\n * Weapon interface\n * Note: JSON uses snake_case (base_damage) not camelCase (baseDamage)\n */\nexport interface Weapon {\n    id: string;\n    name: string;\n    description: string;\n    tier: Tier;\n    rarity?: Rarity; // Optional - not present in weapons.json\n    image?: string;\n    baseDamage?: number; // Optional - legacy, use base_damage\n    attackSpeed?: number; // Optional - not in JSON\n    range?: number;\n    upgrades?: WeaponUpgrade[];\n    scaling?: Scaling;\n    tags?: string[];\n    // JSON properties (snake_case)\n    base_damage?: number;\n    base_projectile_count?: number;\n    attack_pattern?: string;\n    upgradeable_stats?: string[] | string;\n    unlock_requirement?: string | null;\n    unlock_cost_silver?: number;\n    unlocked_by_default?: boolean;\n    best_for?: string[];\n    synergies_items?: string[];\n    synergies_tomes?: string[];\n    synergies_characters?: string[];\n    playstyle?: string;\n    pros?: string[];\n    cons?: string[];\n    build_tips?: string;\n}\n\n/**\n * Tome interface\n * Note: JSON uses stat_affected/value_per_level, not effect/stackable\n */\nexport interface Tome {\n    id: string;\n    name: string;\n    description: string;\n    tier: Tier;\n    rarity?: Rarity; // Optional - not present in tomes.json\n    image?: string;\n    effect?: string; // Optional - not in JSON, use stat_affected\n    priority?: number;\n    stackable?: boolean; // Optional - not in JSON\n    tags?: string[];\n    // JSON properties (snake_case)\n    stat_affected?: string;\n    value_per_level?: string | number;\n    max_level?: number;\n    unlocked_by_default?: boolean;\n    unlock_requirement?: string | null;\n    unlock_cost_silver?: number;\n    synergies_items?: string[];\n    synergies_weapons?: string[];\n    synergies_characters?: string[];\n    // Modal properties\n    notes?: string;\n    recommended_for?: string[];\n}\n\n/**\n * Character base stats\n */\nexport interface CharacterStats {\n    health: number;\n    damage: number;\n    speed: number;\n    luck?: number;\n}\n\n/**\n * Character interface\n * Note: JSON uses passive_ability, not passive; no baseStats in JSON\n */\nexport interface Character {\n    id: string;\n    name: string;\n    description?: string; // Optional - not present in characters.json\n    tier: Tier;\n    rarity?: Rarity; // Optional - not present in characters.json\n    image?: string;\n    baseStats?: CharacterStats; // Optional - not in JSON\n    passive?: string; // Optional - legacy, use passive_ability\n    startingWeapon?: string; // Optional - legacy, use starting_weapon\n    tags?: string[];\n    // JSON properties (snake_case)\n    passive_ability?: string;\n    passive_description?: string;\n    starting_weapon?: string;\n    synergies_weapons?: string[];\n    synergies_items?: string[];\n    synergies_tomes?: string[];\n    playstyle?: string;\n    base_hp?: number;\n    base_damage?: number;\n    unlock_requirement?: string | null;\n    unlock_cost_silver?: number;\n    unlocked_by_default?: boolean;\n    best_for?: string[];\n    strengths?: string[];\n    weaknesses?: string[];\n    build_tips?: string;\n}\n\n/**\n * Shrine interface\n * Note: JSON uses description + activation/reward, not effect\n */\nexport interface Shrine {\n    id: string;\n    name: string;\n    description: string;\n    tier: Tier;\n    image?: string;\n    effect?: string; // Optional - not in JSON, use description\n    cost?: number | string;\n    tags?: string[];\n    type?: 'stat_upgrade' | 'stat_upgrade_legendary' | 'combat' | 'utility' | 'risk_reward';\n    // JSON properties\n    icon?: string;\n    reusable?: boolean;\n    reward?: string;\n    activation?: string;\n    spawn_count?: string;\n    map_icon?: string;\n    best_for?: string[];\n    synergies_items?: string[];\n    strategy?: string;\n    notes?: string;\n}\n\n/**\n * Stats/Mechanics interface\n */\nexport interface Stats {\n    version?: string;\n    last_updated?: string;\n    mechanics?: Record<string, unknown>;\n    breakpoints?: Record<string, unknown>;\n}\n\n/**\n * Data collection wrapper types\n */\nexport interface ItemsData {\n    version: string;\n    last_updated: string;\n    items: Item[];\n}\n\nexport interface WeaponsData {\n    version: string;\n    last_updated: string;\n    weapons: Weapon[];\n}\n\nexport interface TomesData {\n    version: string;\n    last_updated: string;\n    tomes: Tome[];\n}\n\nexport interface CharactersData {\n    version: string;\n    last_updated: string;\n    characters: Character[];\n}\n\nexport interface ShrinesData {\n    version: string;\n    last_updated: string;\n    shrines: Shrine[];\n}\n\n/**\n * All game data combined\n */\nexport interface AllGameData {\n    items?: ItemsData;\n    weapons?: WeaponsData;\n    tomes?: TomesData;\n    characters?: CharactersData;\n    shrines?: ShrinesData;\n    stats?: Stats;\n    changelog?: ChangelogData;\n}\n\n/**\n * Changelog patch interface\n * Note: The changelog module extends this with ExtendedPatch to add categories and other fields\n */\nexport interface ChangelogPatch {\n    id: string;\n    version: string;\n    date: string;\n    title: string;\n    changes: string[];\n    additions?: string[];\n    fixes?: string[];\n    removals?: string[];\n}\n\n/**\n * Changelog data\n */\nexport interface ChangelogData {\n    version: string;\n    last_updated: string;\n    patches: ChangelogPatch[];\n}\n\n/**\n * Filter options\n */\nexport interface FilterOptions {\n    search?: string;\n    tier?: Tier | Tier[];\n    rarity?: Rarity | Rarity[];\n    category?: string;\n    tags?: string[];\n}\n\n/**\n * Sort options\n */\nexport type SortBy = 'name' | 'tier' | 'rarity';\n\n/**\n * View mode\n */\nexport type ViewMode = 'grid' | 'list';\n\n/**\n * Entity types (union of all game entities)\n */\nexport type Entity = Item | Weapon | Tome | Character | Shrine;\n\n/**\n * Filtered data is just an array of entities\n */\nexport type FilteredData = Entity[];\n\n/**\n * Favorites state structure - maps entity type to array of item IDs\n */\nexport interface FavoritesState {\n    items: string[];\n    weapons: string[];\n    tomes: string[];\n    characters: string[];\n    shrines: string[];\n}\n\n/**\n * Build state structure for build planner\n */\nexport interface Build {\n    character: Character | null;\n    weapon: Weapon | null;\n    tomes: Tome[];\n    items: Item[];\n    name?: string;\n    notes?: string;\n}\n\n/**\n * Entity type discriminator\n */\nexport type EntityType = 'items' | 'weapons' | 'tomes' | 'characters' | 'shrines';\n\n/**\n * Validation result\n */\nexport interface ValidationResult<T = unknown> {\n    success: boolean;\n    data?: T;\n    error?: string;\n    zodError?: unknown;\n}\n\n/**\n * Theme type\n */\nexport type Theme = 'dark' | 'light';\n\n/**\n * Web Vitals metric name\n */\nexport type MetricName = 'CLS' | 'FCP' | 'LCP' | 'TTFB' | 'INP';\n\n/**\n * Web Vitals rating\n */\nexport type MetricRating = 'good' | 'needs-improvement' | 'poor' | 'unknown';\n\n/**\n * Web Vitals metric\n */\nexport interface Metric {\n    name: MetricName;\n    value: number;\n    rating: MetricRating;\n    delta: number;\n    id: string;\n}\n\n/**\n * Stored metric\n */\nexport interface StoredMetric {\n    value: number;\n    rating: MetricRating;\n    formattedValue: string;\n    delta: number;\n    id: string;\n}\n\n// ========================================\n// Type Guards\n// ========================================\n\n/**\n * Type guard to check if entity is an Item\n * Items have rarity + tier but NOT weapon/tome/character/shrine specific fields\n */\nexport function isItem(entity: Entity | ChangelogPatch): entity is Item {\n    return (\n        'rarity' in entity &&\n        'tier' in entity &&\n        !('base_damage' in entity) &&\n        !('attack_pattern' in entity) &&\n        !('stat_affected' in entity) &&\n        !('passive_ability' in entity) &&\n        !('activation' in entity)\n    );\n}\n\n/**\n * Type guard to check if entity is a Weapon\n * Weapons have base_damage or attack_pattern (from JSON)\n */\nexport function isWeapon(entity: Entity | ChangelogPatch): entity is Weapon {\n    return 'base_damage' in entity || 'attack_pattern' in entity;\n}\n\n/**\n * Type guard to check if entity is a Tome\n * Tomes have stat_affected or value_per_level (from JSON)\n */\nexport function isTome(entity: Entity | ChangelogPatch): entity is Tome {\n    return 'stat_affected' in entity || 'value_per_level' in entity;\n}\n\n/**\n * Type guard to check if entity is a Character\n * Characters have passive_ability (from JSON)\n */\nexport function isCharacter(entity: Entity | ChangelogPatch): entity is Character {\n    return 'passive_ability' in entity;\n}\n\n/**\n * Type guard to check if entity is a Shrine\n * Shrines have activation or reward fields (from JSON)\n */\nexport function isShrine(entity: Entity | ChangelogPatch): entity is Shrine {\n    return 'activation' in entity || 'reward' in entity;\n}\n\n/**\n * Type guard to check if entity is a ChangelogPatch\n */\nexport function isChangelogPatch(entity: Entity | ChangelogPatch): entity is ChangelogPatch {\n    return 'version' in entity && 'changes' in entity;\n}\n\n// ========================================\n// DOM Element Type Guards\n// ========================================\n\n/**\n * Type guard to check if element is an HTMLInputElement\n */\nexport function isInputElement(element: Element | null): element is HTMLInputElement {\n    return element !== null && element.tagName === 'INPUT';\n}\n\n/**\n * Type guard to check if element is an HTMLSelectElement\n */\nexport function isSelectElement(element: Element | null): element is HTMLSelectElement {\n    return element !== null && element.tagName === 'SELECT';\n}\n\n/**\n * Type guard to check if element is an HTMLButtonElement\n */\nexport function isButtonElement(element: Element | null): element is HTMLButtonElement {\n    return element !== null && element.tagName === 'BUTTON';\n}\n\n/**\n * Type guard to check if element is an HTMLCanvasElement\n */\nexport function isCanvasElement(element: Element | null): element is HTMLCanvasElement {\n    return element !== null && element.tagName === 'CANVAS';\n}\n\n/**\n * Type guard to check if value is a non-null object\n */\nexport function isObject(value: unknown): value is Record<string, unknown> {\n    return typeof value === 'object' && value !== null && !Array.isArray(value);\n}\n\n/**\n * Type guard to check if value is an array\n */\nexport function isArray<T>(value: unknown): value is T[] {\n    return Array.isArray(value);\n}\n\n/**\n * Type guard to check if value is a string\n */\nexport function isString(value: unknown): value is string {\n    return typeof value === 'string';\n}\n\n/**\n * Type guard to check if value is a number\n */\nexport function isNumber(value: unknown): value is number {\n    return typeof value === 'number' && !isNaN(value);\n}\n\n// ========================================\n// Global Declarations\n// ========================================\n\n/**\n * Build-time constants defined in vite.build.config.js\n */\ndeclare const __APP_VERSION__: string;\ndeclare const __CACHE_VERSION__: string;\n\n/**\n * Global objects and functions available throughout the application\n */\ndeclare global {\n    const allData: AllGameData;\n    const ToastManager:\n        | {\n              error: (message: string) => void;\n              success: (message: string) => void;\n              warning: (message: string) => void;\n              info: (message: string) => void;\n          }\n        | undefined;\n\n    /**\n     * Window extensions for MegaBonk app\n     * These are assigned at runtime by various modules\n     */\n    interface Window {\n        // State (from store.ts)\n        // Note: currentTab uses string for flexibility with both TabName and general strings\n        currentTab?: string;\n        filteredData?: FilteredData;\n        allData?: AllGameData;\n        currentBuild?: Build;\n        compareItems?: string[];\n        favorites?: FavoritesState;\n\n        // CV functions (from computer-vision.ts, computer-vision-enhanced.ts)\n        initCV?: (gameData: AllGameData) => void;\n        initEnhancedCV?: (gameData: AllGameData) => void;\n        detectItemsWithEnhancedCV?: (\n            imageDataUrl: string,\n            strategyName?: string,\n            progressCallback?: (progress: number, status: string) => void\n        ) => Promise<unknown>;\n        resetEnhancedCVState?: () => void;\n\n        // Additional CV detection functions (for browser testing and advanced usage)\n        detectItemsWithCV?: (\n            imageDataUrl: string,\n            progressCallback?: (progress: number, status: string) => void,\n            useWorkers?: boolean\n        ) => Promise<unknown[]>;\n        detectGridPositions?: (width: number, height: number, gridSize?: number) => unknown[];\n        detectItemCounts?: (imageDataUrl: string, cells: unknown[]) => Promise<Map<string, number>>;\n        loadImageToCanvas?: (\n            imageDataUrl: string,\n            timeoutMs?: number\n        ) => Promise<{ canvas: HTMLCanvasElement; ctx: CanvasRenderingContext2D; width: number; height: number }>;\n        calculateSimilarity?: (imageData1: ImageData, imageData2: ImageData) => number;\n        calculateIoU?: (box1: unknown, box2: unknown) => number;\n        nonMaxSuppression?: (detections: unknown[], iouThreshold?: number) => unknown[];\n        getAdaptiveIconSizes?: (width: number, height: number) => number[];\n        extractCountRegion?: (cell: unknown) => unknown;\n        detectHotbarRegion?: (\n            ctx: CanvasRenderingContext2D,\n            width: number,\n            height: number\n        ) => { topY: number; bottomY: number; confidence: number };\n        detectIconEdges?: (ctx: CanvasRenderingContext2D, width: number, bandRegion: unknown) => number[];\n        detectIconScale?: (\n            ctx: CanvasRenderingContext2D,\n            width: number,\n            height: number\n        ) => { iconSize: number; confidence: number; method: string };\n        resizeImageData?: (imageData: ImageData, targetWidth: number, targetHeight: number) => ImageData | null;\n        fitsGrid?: (value: number, gridStart: number, spacing: number, tolerance: number) => boolean;\n        verifyGridPattern?: (detections: unknown[], expectedIconSize: number) => unknown;\n        runEnsembleDetection?: (\n            ctx: CanvasRenderingContext2D,\n            width: number,\n            height: number,\n            items: unknown[],\n            cell: unknown\n        ) => Promise<unknown>;\n        getCVMetrics?: () => unknown;\n        getDetectionConfig?: (width?: number, height?: number) => unknown;\n\n        // CV color functions\n        extractDominantColors?: (imageData: ImageData) => string[];\n        getDominantColor?: (imageData: ImageData) => string;\n        calculateColorVariance?: (imageData: ImageData) => number;\n        isEmptyCell?: (imageData: ImageData) => boolean;\n        detectBorderRarity?: (imageData: ImageData) => string | null;\n\n        // CV region functions\n        detectUIRegions?: (ctx: CanvasRenderingContext2D, width: number, height: number) => unknown;\n        detectScreenType?: (ctx: CanvasRenderingContext2D, width: number, height: number) => string;\n\n        // CV cache functions\n        clearDetectionCache?: () => void;\n\n        // OCR functions (from ocr.ts)\n        initOCR?: (gameData: AllGameData) => void;\n        terminateOCRWorker?: () => Promise<void>;\n        isOCRWorkerActive?: () => boolean;\n\n        // Scan build functions (from scan-build.ts, scan-build-enhanced.ts)\n        initScanBuild?: (gameData: AllGameData) => void;\n        initEnhancedScanBuild?: (gameData: AllGameData) => void;\n        handleEnhancedHybridDetect?: (imageDataUrl: string) => Promise<unknown>;\n        compareStrategiesOnImage?: (imageDataUrl: string) => Promise<unknown>;\n\n        // Advisor functions (from advisor.ts)\n        initAdvisor?: (gameData: AllGameData) => void;\n        applyScannedBuild?: (state: unknown) => void;\n\n        // UI functions (from events.ts, renderers.ts)\n        // Note: These use string for flexibility with both TabName and general strings\n        switchTab?: (tabId: string) => void;\n        renderTabContent?: (tabId: string) => void;\n        renderGlobalSearchResults?: (results: unknown[], currentTab?: string, searchQuery?: string) => void;\n\n        // Filter functions (from filters.ts)\n        clearFilters?: () => void;\n        toggleTextExpand?: (element: HTMLElement) => void;\n        globalSearch?: (query: string, allData: AllGameData) => unknown[];\n\n        // Offline UI functions (from offline-ui.ts)\n        recordDataSync?: () => void;\n        getLastSyncTime?: () => number | null;\n        updateOfflineIndicator?: (isOffline: boolean) => void;\n\n        // Skeleton loader functions (from skeleton-loader.ts)\n        showSkeletonLoading?: (containerId: string, count?: number, includeGraphs?: boolean) => void;\n        hideSkeletonLoading?: (containerId: string) => void;\n        showTabSkeleton?: (tabName: string) => void;\n        hideTabSkeleton?: (tabName: string) => void;\n\n        // Data service functions (from data-service.ts)\n        loadAllData?: () => Promise<void>;\n\n        // Test utilities (from test-utils.ts)\n        testUtils?: {\n            calculateAccuracyMetrics?: (...args: unknown[]) => unknown;\n            calculateF1Score?: (...args: unknown[]) => unknown;\n            detectResolution?: (width: number, height: number) => unknown;\n            detectUILayout?: (...args: unknown[]) => unknown;\n            generateTestReport?: (...args: unknown[]) => unknown;\n            runAutomatedTest?: (...args: unknown[]) => unknown;\n            compareDetectionResults?: (...args: unknown[]) => unknown;\n            getGridPositions?: (width: number, height: number) => unknown[];\n        };\n    }\n}\n","// ========================================\n// MegaBonk Utilities Module\n// ========================================\n\nimport { TIER_ORDER, RARITY_ORDER } from './constants.ts';\nimport type { Entity, SortBy, Tier, Rarity, EntityType } from '../types/index.ts';\n\n// ========================================\n// Null-Safe DOM Helpers\n// ========================================\n\n/**\n * Safely get element by ID with optional fallback\n */\nexport function safeGetElementById<T = HTMLElement>(id: string, fallback: T | null = null): HTMLElement | T | null {\n    return document.getElementById(id) || fallback;\n}\n\n/**\n * Safely query selector with optional fallback\n */\nexport function safeQuerySelector<T = Element>(\n    selector: string,\n    context: ParentNode = document,\n    fallback: T | null = null\n): Element | T | null {\n    return context.querySelector(selector) || fallback;\n}\n\n/**\n * Safely query selector all\n */\nexport function safeQuerySelectorAll(selector: string, context: ParentNode = document): NodeListOf<Element> {\n    return context.querySelectorAll(selector);\n}\n\n/**\n * Safely set element value\n */\nexport function safeSetValue(id: string, value: string | number): void {\n    const el = document.getElementById(id) as HTMLInputElement | null;\n    if (el) el.value = String(value);\n}\n\n/**\n * Safely set element innerHTML\n */\nexport function safeSetHTML(id: string, html: string): void {\n    const el = document.getElementById(id);\n    if (el) el.innerHTML = html;\n}\n\n// ========================================\n// Entity Image Generation\n// ========================================\n\n/**\n * Generate responsive image HTML with WebP support, fallbacks, and blur-up loading\n * Uses <picture> element for optimal format delivery\n * Implements blur-up pattern for improved perceived performance:\n * - Image starts blurred via CSS filter\n * - When image loads, blur fades out smoothly\n * - Uses loading=\"lazy\" for below-the-fold images\n */\nexport function generateResponsiveImage(\n    imagePath: string,\n    altText: string,\n    className: string = 'entity-image'\n): string {\n    if (!imagePath) return '';\n\n    // Convert .png/.jpg to .webp path\n    const webpPath = imagePath.replace(/\\.(png|jpg|jpeg)$/i, '.webp');\n    const escapedAlt = escapeHtml(altText);\n\n    // Blur-up image container with CSS blur transition\n    // - blur-up-image class adds initial blur + transition\n    // - data-loaded attribute is added by JS when image loads\n    // - data-fallback for error handling\n    return `<picture class=\"blur-up-container\">\n        <source srcset=\"${webpPath}\" type=\"image/webp\">\n        <img src=\"${imagePath}\" alt=\"${escapedAlt}\" class=\"${className} blur-up-image\" data-fallback=\"true\" data-blur-up=\"true\" loading=\"lazy\">\n    </picture>`;\n}\n\n// Bug fix: Track if image handlers are already attached to prevent memory leaks\nlet imageFallbackHandlerAttached = false;\nlet imageLoadHandlerAttached = false;\n\n/**\n * Setup global image error handler for CSP compliance\n * Should be called once on page load to handle images with data-fallback attribute\n * Bug fix: Prevents duplicate attachment if called multiple times\n */\nexport function setupImageFallbackHandler(): void {\n    // Guard against duplicate attachment\n    if (imageFallbackHandlerAttached) {\n        return;\n    }\n    imageFallbackHandlerAttached = true;\n\n    document.addEventListener(\n        'error',\n        (e: Event) => {\n            const target = e.target;\n            // Type guard to ensure target is an image element\n            if (target instanceof HTMLImageElement && target.dataset.fallback === 'true') {\n                target.style.display = 'none';\n            }\n        },\n        true\n    ); // Use capture phase to catch errors on images\n}\n\n/**\n * Setup global image load handler for blur-up effect\n * When images with data-blur-up load, removes blur by adding loaded class\n * Should be called once on page load\n */\nexport function setupBlurUpHandler(): void {\n    // Guard against duplicate attachment\n    if (imageLoadHandlerAttached) {\n        return;\n    }\n    imageLoadHandlerAttached = true;\n\n    // Handle already-loaded images (from cache)\n    const processLoadedImages = (): void => {\n        document.querySelectorAll('img[data-blur-up=\"true\"]').forEach(img => {\n            if (img instanceof HTMLImageElement && img.complete && img.naturalHeight > 0) {\n                img.classList.add('blur-up-loaded');\n            }\n        });\n    };\n\n    // Initial pass for cached images\n    processLoadedImages();\n\n    // Listen for new image loads (use capture to catch all)\n    document.addEventListener(\n        'load',\n        (e: Event) => {\n            const target = e.target;\n            if (target instanceof HTMLImageElement && target.dataset.blurUp === 'true') {\n                // Small delay to ensure image is painted before removing blur\n                requestAnimationFrame(() => {\n                    target.classList.add('blur-up-loaded');\n                });\n            }\n        },\n        true\n    ); // Use capture phase to catch load events on images\n\n    // Use MutationObserver to handle dynamically added images\n    const observer = new MutationObserver(mutations => {\n        mutations.forEach(mutation => {\n            mutation.addedNodes.forEach(node => {\n                if (node instanceof HTMLElement) {\n                    // Check if the node itself is a blur-up image\n                    if (node instanceof HTMLImageElement && node.dataset.blurUp === 'true') {\n                        if (node.complete && node.naturalHeight > 0) {\n                            node.classList.add('blur-up-loaded');\n                        }\n                    }\n                    // Check for blur-up images within added elements\n                    node.querySelectorAll?.('img[data-blur-up=\"true\"]')?.forEach(img => {\n                        if (img instanceof HTMLImageElement && img.complete && img.naturalHeight > 0) {\n                            img.classList.add('blur-up-loaded');\n                        }\n                    });\n                }\n            });\n        });\n    });\n\n    observer.observe(document.body, { childList: true, subtree: true });\n}\n\n/**\n * Generate image HTML for an entity (item, weapon, character, tome)\n */\nexport function generateEntityImage(\n    entity: Entity | null | undefined,\n    altText: string,\n    className: string = 'entity-image'\n): string {\n    if (!entity || !entity.image) return '';\n    return generateResponsiveImage(entity.image, altText, className);\n}\n\n/**\n * Generate modal image HTML\n * Accepts any object with an optional image property for flexibility with modal-specific types\n */\nexport function generateModalImage(\n    entity: { image?: string } | null | undefined,\n    altText: string,\n    type: string\n): string {\n    if (!entity || !entity.image) return '';\n    return generateResponsiveImage(entity.image, altText, `modal-${type}-image`);\n}\n\n// ========================================\n// Empty State Generation\n// ========================================\n\n/**\n * Generate empty state HTML for when no results are found\n */\nexport function generateEmptyState(icon: string, entityType: string): string {\n    return `\n        <div class=\"empty-state\">\n            <div class=\"empty-icon\">${icon}</div>\n            <h3>No ${entityType} Found</h3>\n            <p>Try adjusting your search or filter criteria.</p>\n            <button class=\"btn-secondary\" data-action=\"clear-filters\">Clear Filters</button>\n        </div>\n    `;\n}\n\n// ========================================\n// Sorting Utilities\n// ========================================\n\n/**\n * Type guard to check if object has a name property\n */\nfunction hasName(obj: unknown): obj is { name: string } {\n    return typeof obj === 'object' && obj !== null && 'name' in obj;\n}\n\n/**\n * Type guard to check if object has a tier property\n */\nfunction hasTier(obj: unknown): obj is { tier: Tier } {\n    return typeof obj === 'object' && obj !== null && 'tier' in obj;\n}\n\n/**\n * Type guard to check if object has a rarity property\n */\nfunction hasRarity(obj: unknown): obj is { rarity: Rarity } {\n    return typeof obj === 'object' && obj !== null && 'rarity' in obj;\n}\n\n/**\n * Sort data array by specified field\n * @param data - Array to sort\n * @param sortBy - Field to sort by ('name', 'tier', 'rarity')\n * @returns Sorted array (mutates original)\n */\nexport function sortData<T extends Entity[]>(data: T, sortBy: SortBy): T {\n    if (sortBy === 'name') {\n        return data.sort((a, b) => {\n            const aName = hasName(a) ? a.name : '';\n            const bName = hasName(b) ? b.name : '';\n            return aName.localeCompare(bName);\n        }) as T;\n    } else if (sortBy === 'tier') {\n        return data.sort((a, b) => {\n            const aTier = hasTier(a) ? a.tier : undefined;\n            const bTier = hasTier(b) ? b.tier : undefined;\n            return (TIER_ORDER[aTier as Tier] ?? 99) - (TIER_ORDER[bTier as Tier] ?? 99);\n        }) as T;\n    } else if (sortBy === 'rarity') {\n        return data.sort((a, b) => {\n            const aRarity = hasRarity(a) ? a.rarity : undefined;\n            const bRarity = hasRarity(b) ? b.rarity : undefined;\n            return (RARITY_ORDER[aRarity as Rarity] ?? 99) - (RARITY_ORDER[bRarity as Rarity] ?? 99);\n        }) as T;\n    }\n    return data;\n}\n\n// ========================================\n// Text Utilities\n// ========================================\n\n/**\n * Escape HTML special characters for use in data attributes\n */\nexport function escapeHtml(text: string | null | undefined): string {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML.replace(/\"/g, '&quot;');\n}\n\n/**\n * Truncate text result\n */\nexport interface TruncateResult {\n    html: string;\n    needsExpand: boolean;\n    fullText: string;\n}\n\n/**\n * Truncate text with optional expand functionality data\n */\nexport function truncateText(text: string | null | undefined, maxLength: number = 120): TruncateResult {\n    if (!text || text.length <= maxLength) {\n        return { html: text || '', needsExpand: false, fullText: text || '' };\n    }\n    return {\n        html: text.substring(0, maxLength) + '...',\n        needsExpand: true,\n        fullText: text,\n    };\n}\n\n/**\n * Generate expandable text HTML\n */\nexport function generateExpandableText(text: string, maxLength: number = 120): string {\n    const { html, needsExpand, fullText } = truncateText(text, maxLength);\n\n    if (!needsExpand) {\n        return `<div class=\"item-description\">${escapeHtml(html)}</div>`;\n    }\n\n    return `\n        <div class=\"item-description expandable-text\"\n             data-full-text=\"${escapeHtml(fullText)}\"\n             data-truncated=\"true\"\n             data-action=\"toggle-text-expand\">\n            ${escapeHtml(html)}\n            <span class=\"expand-indicator\">Click to expand</span>\n        </div>\n    `;\n}\n\n// ========================================\n// Badge/Tag Generation\n// ========================================\n\n/**\n * Generate tier label HTML\n */\nexport function generateTierLabel(tier: Tier): string {\n    return `<span class=\"tier-label\">${tier} Tier</span>`;\n}\n\n/**\n * Generate badge HTML\n */\nexport function generateBadge(text: string, className: string = ''): string {\n    return `<span class=\"badge ${className}\">${text}</span>`;\n}\n\n/**\n * Generate meta tags from array\n * Bug fix: Escape tag content to prevent XSS\n */\nexport function generateMetaTags(tags: string[] | null | undefined, limit: number = 0): string {\n    if (!tags || !tags.length) return '';\n    const displayTags = limit > 0 ? tags.slice(0, limit) : tags;\n    return displayTags.map(tag => `<span class=\"meta-tag\">${escapeHtml(tag)}</span>`).join(' ');\n}\n\n// ========================================\n// Data Lookup Utilities\n// ========================================\n\n/**\n * Find entity by ID in a data collection\n */\nexport function findEntityById<T = Entity>(\n    dataCollection: Record<string, T[] | undefined> | undefined | null,\n    key: EntityType,\n    id: string\n): T | undefined {\n    return dataCollection?.[key]?.find((e: T) => {\n        if (typeof e === 'object' && e !== null && 'id' in e) {\n            return (e as { id: string }).id === id;\n        }\n        return false;\n    });\n}\n\n// ========================================\n// URL Validation\n// ========================================\n\n/**\n * Validate that a URL is safe for external linking\n * Only allows http:// and https:// protocols\n */\nexport function isValidExternalUrl(url: string | null | undefined): boolean {\n    if (!url || typeof url !== 'string') return false;\n    try {\n        const parsed = new URL(url);\n        return parsed.protocol === 'https:' || parsed.protocol === 'http:';\n    } catch {\n        return false;\n    }\n}\n\n// ========================================\n// Performance Utilities\n// ========================================\n\n/**\n * Interface for debounced functions with cancel capability\n */\nexport interface DebouncedFunction<T extends (...args: unknown[]) => unknown> {\n    (...args: Parameters<T>): void;\n    /** Cancel any pending invocation */\n    cancel: () => void;\n}\n\n/**\n * Create a debounced version of a function\n * Delays execution until after wait milliseconds have elapsed since the last call\n * Returns a function with a .cancel() method to cancel pending invocations\n */\nexport function debounce<T extends (...args: unknown[]) => unknown>(fn: T, delay: number): DebouncedFunction<T> {\n    let timeoutId: ReturnType<typeof setTimeout> | undefined;\n\n    const debouncedFn = function (this: unknown, ...args: Parameters<T>): void {\n        clearTimeout(timeoutId);\n        timeoutId = setTimeout(() => fn.apply(this, args), delay);\n    } as DebouncedFunction<T>;\n\n    debouncedFn.cancel = (): void => {\n        clearTimeout(timeoutId);\n        timeoutId = undefined;\n    };\n\n    return debouncedFn;\n}\n","// ========================================\n// MegaBonk Centralized State Store\n// Simple pub/sub store for shared application state\n// ========================================\n\nimport type { AllGameData, Entity, Build, FavoritesState } from '../types/index.ts';\nimport { logger } from './logger.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Tab name type - includes all tabs (entity tabs + special tabs)\n */\nexport type TabName =\n    | 'items'\n    | 'weapons'\n    | 'tomes'\n    | 'characters'\n    | 'shrines'\n    | 'build-planner'\n    | 'calculator'\n    | 'advisor'\n    | 'changelog'\n    | 'about';\n\n// Re-export types for backwards compatibility\nexport type { Build, FavoritesState } from '../types/index.ts';\n\n/**\n * Complete application state interface\n */\nexport interface AppState {\n    currentTab: TabName;\n    filteredData: Entity[];\n    allData: AllGameData;\n    currentBuild: Build;\n    compareItems: string[];\n    favorites: FavoritesState;\n}\n\n/**\n * Subscriber callback type\n */\ntype Subscriber<K extends keyof AppState> = (value: AppState[K]) => void;\n\n// ========================================\n// Initial State\n// ========================================\n\nconst initialState: AppState = {\n    currentTab: 'items',\n    filteredData: [],\n    allData: {\n        items: undefined,\n        weapons: undefined,\n        tomes: undefined,\n        characters: undefined,\n        shrines: undefined,\n        stats: undefined,\n        changelog: undefined,\n    },\n    currentBuild: {\n        character: null,\n        weapon: null,\n        tomes: [],\n        items: [],\n        name: '',\n        notes: '',\n    },\n    compareItems: [],\n    favorites: {\n        items: [],\n        weapons: [],\n        tomes: [],\n        characters: [],\n        shrines: [],\n    },\n};\n\n// ========================================\n// Store State\n// ========================================\n\n// The actual state object\nlet state: AppState = { ...initialState };\n\n// Deep clone initial state for reset\nconst deepCloneInitialState = (): AppState => structuredClone(initialState);\n\n// Subscribers map: key -> Set of callbacks\n// Internal storage uses (value: unknown) => void since we store mixed callback types\n// Type safety is enforced at the subscribe() API boundary\ntype InternalSubscriber = (value: unknown) => void;\nconst subscribers = new Map<keyof AppState, Set<InternalSubscriber>>();\n\n/**\n * Window sync enabled flag - enabled by default for backwards compatibility.\n * Legacy code may access window.allData, window.currentTab, etc.\n * Performance impact is minimal (just object assignment on state change).\n * Can be disabled with disableWindowSync() if not needed.\n */\nlet windowSyncEnabled = true;\n\n/**\n * Sync a state key to the window object for backwards compatibility\n * This helper avoids 'as any' casts by using explicit property assignments\n */\nfunction syncStateKeyToWindow<K extends keyof AppState>(key: K, value: AppState[K] | undefined): void {\n    switch (key) {\n        case 'currentTab':\n            window.currentTab = value as string;\n            break;\n        case 'filteredData':\n            window.filteredData = value as Entity[];\n            break;\n        case 'allData':\n            window.allData = value as AllGameData;\n            break;\n        case 'currentBuild':\n            window.currentBuild = value as Build;\n            break;\n        case 'compareItems':\n            window.compareItems = value as string[];\n            break;\n        case 'favorites':\n            window.favorites = value as FavoritesState;\n            break;\n    }\n}\n\n// ========================================\n// Core Store API\n// ========================================\n\n/**\n * Get a value from the store\n * @param key - State key to retrieve\n * @returns The state value\n */\nexport function getState<K extends keyof AppState>(key: K): AppState[K] {\n    return state[key];\n}\n\n/**\n * Set a value in the store and notify subscribers\n * @param key - State key to set\n * @param value - New value\n */\nexport function setState<K extends keyof AppState>(key: K, value: AppState[K]): void {\n    state[key] = value;\n\n    // Sync to window for backwards compatibility\n    if (windowSyncEnabled && typeof window !== 'undefined') {\n        syncStateKeyToWindow(key, value);\n    }\n\n    // Notify subscribers\n    const keySubscribers = subscribers.get(key);\n    if (keySubscribers) {\n        keySubscribers.forEach(callback => {\n            try {\n                callback(value);\n            } catch (error) {\n                const err = error as Error;\n                logger.error({\n                    operation: 'store.subscriber_error',\n                    error: { name: err.name, message: err.message },\n                    data: { key },\n                });\n            }\n        });\n    }\n}\n\n/**\n * Subscribe to state changes for a specific key\n * @param key - State key to subscribe to\n * @param callback - Function called when value changes\n * @returns Unsubscribe function\n */\nexport function subscribe<K extends keyof AppState>(key: K, callback: Subscriber<K>): () => void {\n    if (!subscribers.has(key)) {\n        subscribers.set(key, new Set());\n    }\n\n    const keySubscribers = subscribers.get(key)!;\n    // Cast to InternalSubscriber for storage - type safety maintained at API boundary\n    const internalCallback = callback as InternalSubscriber;\n    keySubscribers.add(internalCallback);\n\n    // Return unsubscribe function\n    return () => {\n        keySubscribers.delete(internalCallback);\n        if (keySubscribers.size === 0) {\n            subscribers.delete(key);\n        }\n    };\n}\n\n/**\n * Reset the store to initial state - critical for test isolation\n */\nexport function resetStore(): void {\n    state = deepCloneInitialState();\n\n    // Clear window properties if sync is enabled\n    if (windowSyncEnabled && typeof window !== 'undefined') {\n        window.currentTab = state.currentTab;\n        window.filteredData = state.filteredData;\n        window.allData = state.allData;\n        window.currentBuild = state.currentBuild;\n        window.compareItems = state.compareItems;\n        window.favorites = state.favorites;\n    }\n\n    // Note: We don't clear subscribers here - use clearSubscribers() for full cleanup\n}\n\n/**\n * Clear all subscribers - critical for test isolation to prevent memory leaks\n * Call this in test teardown (afterEach) along with resetStore()\n */\nexport function clearSubscribers(): void {\n    subscribers.clear();\n}\n\n/**\n * Enable window property synchronization (for backwards compatibility)\n */\nexport function enableWindowSync(): void {\n    windowSyncEnabled = true;\n\n    // Sync current state to window\n    if (typeof window !== 'undefined') {\n        window.currentTab = state.currentTab;\n        window.filteredData = state.filteredData;\n        window.allData = state.allData;\n        window.currentBuild = state.currentBuild;\n        window.compareItems = state.compareItems;\n        window.favorites = state.favorites;\n    }\n}\n\n/**\n * Disable window property synchronization (useful for tests)\n */\nexport function disableWindowSync(): void {\n    windowSyncEnabled = false;\n}\n\n/**\n * Check if window sync is enabled\n */\nexport function isWindowSyncEnabled(): boolean {\n    return windowSyncEnabled;\n}\n\n/**\n * Get the entire state object (returns a shallow copy)\n * Useful for debugging or state inspection\n */\nexport function getFullState(): AppState {\n    return { ...state };\n}\n\n/**\n * Type-safe state key assignment helper\n * Uses switch statement to provide proper type narrowing for each key\n */\nfunction assignStateKey<K extends keyof AppState>(key: K, value: AppState[K]): void {\n    switch (key) {\n        case 'currentTab':\n            state.currentTab = value as TabName;\n            break;\n        case 'filteredData':\n            state.filteredData = value as Entity[];\n            break;\n        case 'allData':\n            state.allData = value as AllGameData;\n            break;\n        case 'currentBuild':\n            state.currentBuild = value as Build;\n            break;\n        case 'compareItems':\n            state.compareItems = value as string[];\n            break;\n        case 'favorites':\n            state.favorites = value as FavoritesState;\n            break;\n    }\n}\n\n/**\n * Batch update multiple state values\n * Only notifies subscribers once per key after all updates\n * @param updates - Partial state object with values to update\n */\nexport function batchUpdate(updates: Partial<AppState>): void {\n    const changedKeys = new Set<keyof AppState>();\n\n    // Update all values without notifying\n    for (const key of Object.keys(updates) as (keyof AppState)[]) {\n        const value = updates[key];\n        if (value !== undefined) {\n            assignStateKey(key, value as AppState[typeof key]);\n            changedKeys.add(key);\n\n            // Sync to window\n            if (windowSyncEnabled && typeof window !== 'undefined') {\n                syncStateKeyToWindow(key, value as AppState[typeof key]);\n            }\n        }\n    }\n\n    // Now notify subscribers for changed keys\n    changedKeys.forEach(key => {\n        const keySubscribers = subscribers.get(key);\n        if (keySubscribers) {\n            keySubscribers.forEach(callback => {\n                try {\n                    callback(state[key]);\n                } catch (error) {\n                    const err = error as Error;\n                    logger.error({\n                        operation: 'store.subscriber_error',\n                        error: { name: err.name, message: err.message },\n                        data: { key },\n                    });\n                }\n            });\n        }\n    });\n}\n\n// ========================================\n// Window sync is disabled by default for performance\n// ========================================\n// Call enableWindowSync() explicitly if backwards compatibility with\n// window.allData, window.currentTab, etc. is needed.\n// All new code should use getState() and setState() instead.\n","// ========================================\n// MegaBonk Favorites Module\n// ========================================\n\nimport type { EntityType } from '../types/index.ts';\nimport { getState, setState, type FavoritesState } from './store.ts';\nimport { ToastManager } from './toast.ts';\n\n// Re-export type for backwards compatibility\nexport type { FavoritesState } from './store.ts';\n\n// Note: Global declarations (ToastManager) are in types/index.ts\n\n// ========================================\n// Constants\n// ========================================\n\nconst FAVORITES_KEY = 'megabonk_favorites';\n\n// Track localStorage availability to prevent repeated failed operations\nlet localStorageAvailable: boolean | null = null;\n\n// ========================================\n// State\n// ========================================\n\n// Favorites state - uses centralized store\n// No local copy - always read from store for proper test isolation\n\n// ========================================\n// Helper Functions\n// ========================================\n\n/**\n * Check if localStorage is available\n * Uses a test write/read/delete cycle to verify functionality\n * Caches result to avoid repeated checks\n */\nfunction isLocalStorageAvailable(): boolean {\n    if (localStorageAvailable !== null) {\n        return localStorageAvailable;\n    }\n\n    try {\n        const testKey = '__megabonk_storage_test__';\n        localStorage.setItem(testKey, 'test');\n        const result = localStorage.getItem(testKey);\n        localStorage.removeItem(testKey);\n        localStorageAvailable = result === 'test';\n        return localStorageAvailable;\n    } catch {\n        localStorageAvailable = false;\n        return false;\n    }\n}\n\n// ========================================\n// Exported Functions\n// ========================================\n\n/**\n * Load favorites from localStorage\n * @returns True if favorites were loaded successfully (including when no favorites are stored),\n *          false if localStorage is unavailable\n */\nexport function loadFavorites(): boolean {\n    // First check if localStorage is available\n    if (!isLocalStorageAvailable()) {\n        console.debug('[favorites] localStorage unavailable - favorites will not persist');\n        try {\n            ToastManager.warning('Favorites will not be saved in this browser mode.');\n        } catch {\n            // ToastManager not initialized yet, fail silently\n        }\n        return false;\n    }\n\n    try {\n        const stored = localStorage.getItem(FAVORITES_KEY);\n        if (stored) {\n            const parsed = JSON.parse(stored);\n            // Validate structure before setting state\n            if (typeof parsed === 'object' && parsed !== null) {\n                setState('favorites', parsed as FavoritesState);\n                return true;\n            }\n        }\n        // No favorites stored, but localStorage is available - this is success\n        return true;\n    } catch (error) {\n        // Parse error or other issue\n        console.debug('[favorites] Failed to parse stored favorites:', (error as Error).message);\n        try {\n            ToastManager.warning('Could not load saved favorites. Using fresh list.');\n        } catch {\n            // ToastManager not initialized yet, fail silently\n        }\n        return false;\n    }\n}\n\n/**\n * Save favorites to localStorage\n */\nfunction saveFavorites(): void {\n    // Skip if localStorage is known to be unavailable\n    if (!isLocalStorageAvailable()) {\n        return;\n    }\n\n    try {\n        const favorites = getState('favorites');\n        localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));\n    } catch (error) {\n        const err = error as Error;\n        // Distinguish between different localStorage errors for better user feedback\n        try {\n            if (err.name === 'QuotaExceededError') {\n                // Storage is full - suggest clearing cache\n                console.debug('[favorites] localStorage quota exceeded:', err.message);\n                ToastManager.error('Storage full. Try clearing browser cache to save favorites.');\n            } else if (err.name === 'SecurityError') {\n                // Private browsing or cookies disabled\n                console.debug('[favorites] localStorage blocked (private browsing?):', err.message);\n                ToastManager.warning('Favorites disabled in private browsing mode');\n            } else {\n                // Other errors (general unavailability)\n                console.debug('[favorites] localStorage unavailable:', err.message);\n                ToastManager.error('Failed to save favorite');\n            }\n        } catch {\n            // ToastManager not initialized yet, fail silently\n        }\n    }\n}\n\n/**\n * Check if an item is favorited\n * @param tabName - Tab name (items, weapons, etc.)\n * @param itemId - Item ID\n * @returns True if favorited\n */\nexport function isFavorite(tabName: EntityType, itemId: string): boolean {\n    const favs = getState('favorites');\n    return favs[tabName]?.includes(itemId) || false;\n}\n\n/**\n * Toggle favorite status for an item\n * @param tabName - Tab name\n * @param itemId - Item ID\n * @returns New favorite status\n */\nexport function toggleFavorite(tabName: EntityType, itemId: string): boolean {\n    const favorites = getState('favorites');\n    const newFavorites = { ...favorites };\n    if (!newFavorites[tabName]) {\n        newFavorites[tabName] = [];\n    } else {\n        newFavorites[tabName] = [...newFavorites[tabName]];\n    }\n\n    const index = newFavorites[tabName].indexOf(itemId);\n    if (index > -1) {\n        // Remove from favorites\n        newFavorites[tabName].splice(index, 1);\n        setState('favorites', newFavorites);\n        saveFavorites();\n        return false;\n    } else {\n        // Add to favorites\n        newFavorites[tabName].push(itemId);\n        setState('favorites', newFavorites);\n        saveFavorites();\n        return true;\n    }\n}\n\n/**\n * Get all favorites for a tab\n * @param tabName - Tab name\n * @returns Array of favorited item IDs\n */\nexport function getFavorites(tabName: EntityType): string[] {\n    const favs = getState('favorites');\n    return favs[tabName] || [];\n}\n\n/**\n * Clear all favorites\n */\nexport function clearAllFavorites(): void {\n    setState('favorites', {\n        items: [],\n        weapons: [],\n        tomes: [],\n        characters: [],\n        shrines: [],\n    });\n    saveFavorites();\n    try {\n        ToastManager.success('All favorites cleared');\n    } catch {\n        // ToastManager not initialized yet, fail silently\n    }\n}\n","// ========================================\n// MegaBonk Search History Module\n// ========================================\n// Manages search history persistence and UI\n\nimport { escapeHtml } from './utils.ts';\nimport { MAX_SEARCH_HISTORY } from './constants.ts';\n\n// ========================================\n// Constants\n// ========================================\n\nconst SEARCH_HISTORY_KEY = 'megabonk_search_history';\n// MAX_SEARCH_HISTORY imported from constants.ts\n\n// ========================================\n// Search History Management\n// ========================================\n\n/**\n * Get search history from localStorage\n * Validates that stored data is an array of strings\n * @returns Search history array\n */\nexport function getSearchHistory(): string[] {\n    try {\n        const history = localStorage.getItem(SEARCH_HISTORY_KEY);\n        if (!history) return [];\n\n        const parsed = JSON.parse(history);\n\n        // Validate it's an array\n        if (!Array.isArray(parsed)) {\n            console.debug('[search-history] Invalid history format, expected array');\n            return [];\n        }\n\n        // Filter to only valid string entries\n        return parsed.filter((item): item is string => typeof item === 'string' && item.length > 0);\n    } catch (error) {\n        console.debug('[search-history] localStorage unavailable:', (error as Error).message);\n        return [];\n    }\n}\n\n/**\n * Add search term to history\n * @param term - Search term to add\n */\nexport function addToSearchHistory(term: string): void {\n    if (!term || term.trim().length < 2) return;\n\n    try {\n        let history = getSearchHistory();\n\n        // Remove duplicates and add to front\n        history = history.filter(item => item !== term);\n        history.unshift(term);\n\n        // Keep only MAX_SEARCH_HISTORY items\n        history = history.slice(0, MAX_SEARCH_HISTORY);\n\n        localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));\n    } catch (error) {\n        console.debug('[search-history] localStorage unavailable:', (error as Error).message);\n    }\n}\n\n/**\n * Clear search history\n */\nexport function clearSearchHistory(): void {\n    try {\n        localStorage.removeItem(SEARCH_HISTORY_KEY);\n    } catch (error) {\n        console.debug('[search-history] localStorage unavailable:', (error as Error).message);\n    }\n}\n\n/**\n * Show search history dropdown\n * @param searchInput - Search input element\n * @param onSelect - Callback when item is selected\n */\nexport function showSearchHistoryDropdown(searchInput: HTMLInputElement, onSelect: (term: string) => void): void {\n    const history = getSearchHistory();\n    if (history.length === 0) return;\n\n    // Remove existing dropdown if any\n    const existingDropdown = document.querySelector('.search-history-dropdown');\n    if (existingDropdown) {\n        existingDropdown.remove();\n    }\n\n    // Create dropdown with ARIA attributes for accessibility\n    const dropdown = document.createElement('div');\n    dropdown.className = 'search-history-dropdown';\n    dropdown.setAttribute('role', 'listbox');\n    dropdown.setAttribute('aria-label', 'Search history');\n    searchInput.setAttribute('aria-expanded', 'true');\n    searchInput.setAttribute('aria-haspopup', 'listbox');\n    dropdown.innerHTML = `\n        <div class=\"search-history-header\">\n            <span>Recent Searches</span>\n            <button class=\"clear-history-btn\" aria-label=\"Clear search history\">Clear</button>\n        </div>\n        <ul class=\"search-history-list\" role=\"group\">\n            ${history\n                .map(\n                    (term, index) => `\n                <li class=\"search-history-item\" role=\"option\" tabindex=\"0\" data-term=\"${escapeHtml(term)}\" data-index=\"${index}\" aria-selected=\"false\">\n                    ${escapeHtml(term)}\n                </li>\n            `\n                )\n                .join('')}\n        </ul>\n    `;\n\n    // Position dropdown\n    const searchBox = searchInput.parentElement;\n    if (searchBox) {\n        searchBox.style.position = 'relative';\n        searchBox.appendChild(dropdown);\n    }\n\n    // AbortController for cleanup\n    const abortController = new AbortController();\n\n    // Helper to close dropdown\n    const closeDropdown = (): void => {\n        abortController.abort();\n        searchInput.setAttribute('aria-expanded', 'false');\n        if (dropdown.parentElement) {\n            dropdown.remove();\n        }\n    };\n\n    // Clear button handler\n    const clearBtn = dropdown.querySelector('.clear-history-btn') as HTMLButtonElement | null;\n    clearBtn?.addEventListener(\n        'click',\n        e => {\n            e.stopPropagation();\n            clearSearchHistory();\n            closeDropdown();\n        },\n        { signal: abortController.signal }\n    );\n\n    const historyItems = dropdown.querySelectorAll('.search-history-item');\n    let currentIndex = -1;\n\n    // Update active item state\n    const updateActiveItem = (): void => {\n        historyItems.forEach((item, i) => {\n            const isActive = i === currentIndex;\n            item.classList.toggle('active', isActive);\n            item.setAttribute('aria-selected', isActive ? 'true' : 'false');\n            if (isActive) {\n                (item as HTMLElement).focus();\n            }\n        });\n    };\n\n    // Select current item\n    const selectCurrentItem = (): void => {\n        if (currentIndex >= 0 && currentIndex < historyItems.length) {\n            const item = historyItems[currentIndex] as HTMLElement;\n            const term = item.getAttribute('data-term');\n            if (term && searchInput) {\n                searchInput.value = term;\n                onSelect(term);\n                closeDropdown();\n            }\n        }\n    };\n\n    // Click handlers for items\n    historyItems.forEach(item => {\n        item.addEventListener(\n            'click',\n            () => {\n                const term = item.getAttribute('data-term');\n                if (term && searchInput) {\n                    searchInput.value = term;\n                    onSelect(term);\n                    closeDropdown();\n                }\n            },\n            { signal: abortController.signal }\n        );\n    });\n\n    // Keyboard navigation\n    searchInput.addEventListener(\n        'keydown',\n        (e: KeyboardEvent) => {\n            if (e.key === 'ArrowDown') {\n                e.preventDefault();\n                currentIndex = Math.min(currentIndex + 1, historyItems.length - 1);\n                updateActiveItem();\n            } else if (e.key === 'ArrowUp') {\n                e.preventDefault();\n                currentIndex = Math.max(currentIndex - 1, 0);\n                updateActiveItem();\n            } else if (e.key === 'Enter' && currentIndex >= 0) {\n                e.preventDefault();\n                selectCurrentItem();\n            }\n        },\n        { signal: abortController.signal }\n    );\n\n    // Close on click outside\n    document.addEventListener(\n        'click',\n        (e: MouseEvent) => {\n            if (!dropdown.contains(e.target as Node) && e.target !== searchInput) {\n                closeDropdown();\n            }\n        },\n        { signal: abortController.signal }\n    );\n\n    // Close on Escape\n    document.addEventListener(\n        'keydown',\n        (e: KeyboardEvent) => {\n            if (e.key === 'Escape') {\n                closeDropdown();\n                searchInput?.focus();\n            }\n        },\n        { signal: abortController.signal }\n    );\n}\n","// ========================================\n// MegaBonk Filter State Module\n// ========================================\n// Manages filter state persistence per tab\n\nimport { safeGetElementById } from './utils.ts';\nimport { isInputElement, isSelectElement } from '../types/index.ts';\n\n// ========================================\n// Constants\n// ========================================\n\nconst FILTER_STATE_KEY = 'megabonk_filter_state';\n\n// Tabs that don't have filters\nconst TABS_WITHOUT_FILTERS = ['build-planner', 'calculator', 'shrines', 'changelog'];\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Filter state interface for persistence\n */\nexport interface FilterState {\n    search: string;\n    favoritesOnly: boolean;\n    tierFilter: string;\n    sortBy: string;\n    rarityFilter?: string;\n    stackingFilter?: string;\n}\n\n// ========================================\n// Filter State Persistence\n// ========================================\n\n/**\n * Get all filter states from sessionStorage\n * @returns Object with filter states per tab\n */\nexport function getAllFilterStates(): Record<string, FilterState> {\n    try {\n        const states = window.sessionStorage.getItem(FILTER_STATE_KEY);\n        return states ? JSON.parse(states) : {};\n    } catch (error) {\n        console.debug('[filter-state] sessionStorage unavailable:', (error as Error).message);\n        return {};\n    }\n}\n\n/**\n * Save current filter state for a specific tab\n * @param tabName - Tab name\n */\nexport function saveFilterState(tabName: string): void {\n    if (!tabName || TABS_WITHOUT_FILTERS.includes(tabName)) {\n        return;\n    }\n\n    try {\n        const searchInputEl = safeGetElementById('searchInput');\n        const favoritesOnlyEl = safeGetElementById('favoritesOnly');\n        const tierFilterEl = safeGetElementById('tierFilter');\n        const sortByEl = safeGetElementById('sortBy');\n\n        const state: FilterState = {\n            search: isInputElement(searchInputEl) ? searchInputEl.value : '',\n            favoritesOnly: isInputElement(favoritesOnlyEl) ? favoritesOnlyEl.checked : false,\n            tierFilter: isSelectElement(tierFilterEl) ? tierFilterEl.value : 'all',\n            sortBy: isSelectElement(sortByEl) ? sortByEl.value : 'rarity',\n        };\n\n        // Add items-specific filters\n        if (tabName === 'items') {\n            const rarityFilterEl = safeGetElementById('rarityFilter');\n            const stackingFilterEl = safeGetElementById('stackingFilter');\n            state.rarityFilter = isSelectElement(rarityFilterEl) ? rarityFilterEl.value : 'all';\n            state.stackingFilter = isSelectElement(stackingFilterEl) ? stackingFilterEl.value : 'all';\n        }\n\n        const allStates = getAllFilterStates();\n        allStates[tabName] = state;\n\n        window.sessionStorage.setItem(FILTER_STATE_KEY, JSON.stringify(allStates));\n    } catch (error) {\n        console.debug('[filter-state] sessionStorage unavailable:', (error as Error).message);\n    }\n}\n\n/**\n * Validate that a filter state object has the expected types\n * Bug fix: Prevents corrupted localStorage from causing runtime errors\n * @param state - State object to validate\n * @returns True if state is valid\n */\nfunction isValidFilterState(state: unknown): state is FilterState {\n    if (!state || typeof state !== 'object') return false;\n    const s = state as Record<string, unknown>;\n\n    // Validate required fields are correct types\n    if (s.search !== undefined && typeof s.search !== 'string') return false;\n    if (s.favoritesOnly !== undefined && typeof s.favoritesOnly !== 'boolean') return false;\n    if (s.tierFilter !== undefined && typeof s.tierFilter !== 'string') return false;\n    if (s.sortBy !== undefined && typeof s.sortBy !== 'string') return false;\n    if (s.rarityFilter !== undefined && typeof s.rarityFilter !== 'string') return false;\n    if (s.stackingFilter !== undefined && typeof s.stackingFilter !== 'string') return false;\n\n    return true;\n}\n\n/**\n * Restore filter state for a specific tab\n * @param tabName - Tab name\n */\nexport function restoreFilterState(tabName: string): void {\n    if (!tabName || TABS_WITHOUT_FILTERS.includes(tabName)) {\n        return;\n    }\n\n    try {\n        const allStates = getAllFilterStates();\n        const state = allStates[tabName];\n\n        // Bug fix: Validate state structure before using it\n        if (!state || !isValidFilterState(state)) return;\n\n        // Restore search input\n        const searchInputEl = safeGetElementById('searchInput');\n        if (isInputElement(searchInputEl) && typeof state.search === 'string') {\n            searchInputEl.value = state.search;\n        }\n\n        // Restore favorites checkbox\n        const favoritesOnlyEl = safeGetElementById('favoritesOnly');\n        if (isInputElement(favoritesOnlyEl) && typeof state.favoritesOnly === 'boolean') {\n            favoritesOnlyEl.checked = state.favoritesOnly;\n        }\n\n        // Restore tier filter\n        const tierFilterEl = safeGetElementById('tierFilter');\n        if (isSelectElement(tierFilterEl) && typeof state.tierFilter === 'string') {\n            tierFilterEl.value = state.tierFilter;\n        }\n\n        // Restore sort order\n        const sortByEl = safeGetElementById('sortBy');\n        if (isSelectElement(sortByEl) && typeof state.sortBy === 'string') {\n            sortByEl.value = state.sortBy;\n        }\n\n        // Restore items-specific filters\n        if (tabName === 'items') {\n            const rarityFilterEl = safeGetElementById('rarityFilter');\n            if (isSelectElement(rarityFilterEl) && typeof state.rarityFilter === 'string') {\n                rarityFilterEl.value = state.rarityFilter;\n            }\n\n            const stackingFilterEl = safeGetElementById('stackingFilter');\n            if (isSelectElement(stackingFilterEl) && typeof state.stackingFilter === 'string') {\n                stackingFilterEl.value = state.stackingFilter;\n            }\n        }\n    } catch (error) {\n        console.debug('[filter-state] sessionStorage unavailable:', (error as Error).message);\n    }\n}\n\n/**\n * Clear all saved filter states\n */\nexport function clearAllFilterStates(): void {\n    try {\n        window.sessionStorage.removeItem(FILTER_STATE_KEY);\n    } catch (error) {\n        console.debug('[filter-state] sessionStorage unavailable:', (error as Error).message);\n    }\n}\n","// ========================================\n// MegaBonk Fuzzy Match Module\n// ========================================\n// Fuzzy search algorithm and advanced search parsing\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Fuzzy match result with context\n */\nexport interface FuzzyMatchResult {\n    score: number;\n    matchType: 'exact' | 'starts_with' | 'contains' | 'fuzzy' | 'none';\n    field: string;\n}\n\n/**\n * Advanced search criteria\n */\nexport interface AdvancedSearchCriteria {\n    text: string[];\n    filters: Record<string, string>;\n}\n\n// ========================================\n// Fuzzy Search Algorithm\n// ========================================\n\n// ========================================\n// Score Constants\n// ========================================\n\n// Base scores for match types\nconst SCORE_EXACT = 2000;\nconst SCORE_STARTS_WITH = 1500;\nconst SCORE_CONTAINS = 1000;\n\n// Bonus for name field matches (ensures \"Big Bonk\" appears before items with \"bonk\" in description)\nconst NAME_FIELD_BONUS = 1000;\n\n/**\n * Calculate fuzzy match score between search term and text\n * Returns both score and match type for UX context\n * @param searchTerm - Search term\n * @param text - Text to search in\n * @param fieldName - Name of field being searched (for context)\n * @returns Match result with context\n */\nexport function fuzzyMatchScore(searchTerm: string, text: string, fieldName: string = 'text'): FuzzyMatchResult {\n    // Handle null/undefined/empty inputs\n    if (!searchTerm || !text || typeof searchTerm !== 'string' || typeof text !== 'string') {\n        return { score: 0, matchType: 'none', field: fieldName };\n    }\n\n    // Trim and normalize whitespace\n    searchTerm = searchTerm.trim().toLowerCase();\n    text = text.trim().toLowerCase();\n\n    // Return early if either is empty after trimming\n    if (searchTerm.length === 0 || text.length === 0) {\n        return { score: 0, matchType: 'none', field: fieldName };\n    }\n\n    // Apply bonus for name field matches\n    const isNameField = fieldName === 'name';\n    const fieldBonus = isNameField ? NAME_FIELD_BONUS : 0;\n\n    // Exact match gets highest score\n    if (text === searchTerm) {\n        return { score: SCORE_EXACT + fieldBonus, matchType: 'exact', field: fieldName };\n    }\n\n    // Starts with search term (very relevant)\n    if (text.startsWith(searchTerm)) {\n        return { score: SCORE_STARTS_WITH + fieldBonus, matchType: 'starts_with', field: fieldName };\n    }\n\n    // Contains search term (substring match)\n    if (text.includes(searchTerm)) {\n        return { score: SCORE_CONTAINS + fieldBonus, matchType: 'contains', field: fieldName };\n    }\n\n    // Calculate fuzzy match score (character sequence)\n    let score = 0;\n    let searchIndex = 0;\n    let consecutiveMatches = 0;\n\n    for (let i = 0; i < text.length && searchIndex < searchTerm.length; i++) {\n        if (text[i] === searchTerm[searchIndex]) {\n            score += 1 + consecutiveMatches;\n            consecutiveMatches++;\n            searchIndex++;\n        } else {\n            consecutiveMatches = 0;\n        }\n    }\n\n    // Return 0 if not all characters matched\n    if (searchIndex !== searchTerm.length) {\n        return { score: 0, matchType: 'none', field: fieldName };\n    }\n\n    return { score, matchType: 'fuzzy', field: fieldName };\n}\n\n// ========================================\n// Advanced Search Syntax Parser\n// ========================================\n\n/**\n * Allowed filter keys for advanced search\n * Whitelist approach prevents prototype pollution attacks\n */\nconst ALLOWED_FILTER_KEYS = new Set([\n    // Entity properties\n    'tier',\n    'rarity',\n    'type',\n    'name',\n    'id',\n    // Item properties\n    'damage',\n    'hp',\n    'stacks_well',\n    'one_and_done',\n    'stat',\n    'priority',\n    'tags',\n    'synergy',\n    'effect',\n    'scaling_type',\n    'graph_type',\n    'multiplier',\n    'base_effect',\n    'formula',\n    // Character/Weapon properties\n    'attack_speed',\n    'movement_speed',\n    'crit_chance',\n    'crit_damage',\n    'armor',\n    'evasion',\n    // Tome properties\n    'stat_affected',\n    'value_per_level',\n]);\n\n/**\n * Parse advanced search syntax\n * Examples: \"tier:SS damage:>100 stacks_well:true fire\"\n * @param query - Search query\n * @returns Parsed search criteria\n */\nexport function parseAdvancedSearch(query: string): AdvancedSearchCriteria {\n    const criteria: AdvancedSearchCriteria = {\n        text: [],\n        filters: {},\n    };\n\n    // Handle null/undefined/non-string inputs\n    if (!query || typeof query !== 'string') return criteria;\n\n    // Trim and check for empty string\n    const trimmedQuery = query.trim();\n    if (trimmedQuery.length === 0) return criteria;\n\n    // Limit query length to prevent ReDoS attacks\n    const safeQuery = trimmedQuery.slice(0, 1000);\n\n    // Split by spaces but preserve quoted strings\n    const tokens = safeQuery.match(/(?:[^\\s\"]+|\"[^\"]*\")+/g) || [];\n\n    // Limit token count to prevent DoS\n    const maxTokens = 50;\n    const limitedTokens = tokens.slice(0, maxTokens);\n\n    limitedTokens.forEach(token => {\n        if (!token || token.length === 0) return;\n\n        // Remove quotes if present\n        token = token.replace(/^[\"'](.*)[\"']$/, '$1');\n\n        if (token.length === 0) return;\n\n        // Check if it's a filter syntax (key:value)\n        const filterMatch = token.match(/^(\\w+):([\\w><=!.+-]+)$/);\n\n        if (filterMatch) {\n            const [, key, value] = filterMatch;\n            // Only allow whitelisted filter keys to prevent prototype pollution\n            if (key && value && key.length <= 50 && value.length <= 100 && ALLOWED_FILTER_KEYS.has(key.toLowerCase())) {\n                criteria.filters[key.toLowerCase()] = value;\n            }\n        } else {\n            if (token.length <= 200) {\n                criteria.text.push(token);\n            }\n        }\n    });\n\n    return criteria;\n}\n\n/**\n * Apply advanced filter criteria to an item\n * @param item - Item to check\n * @param filters - Filter criteria\n * @returns True if item matches all filters\n */\nexport function matchesAdvancedFilters(item: Record<string, unknown>, filters: Record<string, string>): boolean {\n    for (const [key, value] of Object.entries(filters)) {\n        const itemValue = item[key];\n\n        if (itemValue === undefined || itemValue === null) {\n            return false;\n        }\n\n        if (value === undefined || value === null) {\n            continue;\n        }\n\n        // Handle comparison operators\n        if (value.startsWith('>=')) {\n            const threshold = parseFloat(value.substring(2));\n            const numValue = parseFloat(String(itemValue));\n            if (isNaN(threshold) || isNaN(numValue) || numValue < threshold) return false;\n        } else if (value.startsWith('<=')) {\n            const threshold = parseFloat(value.substring(2));\n            const numValue = parseFloat(String(itemValue));\n            if (isNaN(threshold) || isNaN(numValue) || numValue > threshold) return false;\n        } else if (value.startsWith('>')) {\n            const threshold = parseFloat(value.substring(1));\n            const numValue = parseFloat(String(itemValue));\n            if (isNaN(threshold) || isNaN(numValue) || numValue <= threshold) return false;\n        } else if (value.startsWith('<')) {\n            const threshold = parseFloat(value.substring(1));\n            const numValue = parseFloat(String(itemValue));\n            if (isNaN(threshold) || isNaN(numValue) || numValue >= threshold) return false;\n        } else if (value.startsWith('!')) {\n            if (String(itemValue).toLowerCase() === value.substring(1).toLowerCase()) return false;\n        } else {\n            // Exact match (case insensitive)\n            if (String(itemValue).toLowerCase() !== value.toLowerCase()) return false;\n        }\n    }\n\n    return true;\n}\n","// ========================================\n// MegaBonk Search Dropdown Module\n// ========================================\n// Floating search dropdown for cross-tab search results\n\nimport type { EntityType, Item, Weapon, Tome, Character, Shrine } from '../types/index.ts';\nimport type { GlobalSearchResult } from './global-search.ts';\nimport { escapeHtml, safeGetElementById, isValidExternalUrl } from './utils.ts';\nimport { logger } from './logger.ts';\n\n// ========================================\n// Constants\n// ========================================\n\nconst DROPDOWN_ID = 'searchResultsDropdown';\nconst MAX_RESULTS_PER_TYPE_DROPDOWN = 5;\n\n/**\n * Type label mapping for display\n */\nconst TYPE_LABELS: Record<EntityType, { label: string; icon: string }> = {\n    items: { label: 'Items', icon: '' },\n    weapons: { label: 'Weapons', icon: '' },\n    tomes: { label: 'Tomes', icon: '' },\n    characters: { label: 'Characters', icon: '' },\n    shrines: { label: 'Shrines', icon: '' },\n};\n\n// ========================================\n// State\n// ========================================\n\nlet focusedIndex = -1;\nlet currentResults: GlobalSearchResult[] = [];\nlet isDropdownVisible = false;\n\n// ========================================\n// Public API\n// ========================================\n\n/**\n * Check if the dropdown is currently visible\n */\nexport function isSearchDropdownVisible(): boolean {\n    return isDropdownVisible;\n}\n\n/**\n * Get the currently focused result (for Enter key navigation)\n */\nexport function getSelectedResult(): GlobalSearchResult | null {\n    if (focusedIndex >= 0 && focusedIndex < currentResults.length) {\n        return currentResults[focusedIndex] ?? null;\n    }\n    return null;\n}\n\n/**\n * Get the focused index (for testing)\n */\nexport function getFocusedIndex(): number {\n    return focusedIndex;\n}\n\n/**\n * Show the search dropdown with grouped results\n * @param results - Search results from globalSearch\n * @param query - The search query for highlighting\n */\nexport function showSearchDropdown(results: GlobalSearchResult[], query: string): void {\n    const dropdown = safeGetElementById(DROPDOWN_ID);\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n\n    if (!dropdown) {\n        logger.warn({\n            operation: 'search-dropdown.show',\n            error: { name: 'ElementNotFound', message: 'Dropdown container not found' },\n        });\n        return;\n    }\n\n    // Store results for keyboard navigation\n    currentResults = results;\n    focusedIndex = -1;\n    isDropdownVisible = true;\n\n    // Update ARIA attributes\n    if (searchInput) {\n        searchInput.setAttribute('aria-expanded', 'true');\n        searchInput.setAttribute('aria-controls', DROPDOWN_ID);\n    }\n\n    if (results.length === 0) {\n        dropdown.innerHTML = `\n            <div class=\"search-dropdown-empty\">\n                <span class=\"empty-icon\"></span>\n                <p>No results found for \"${escapeHtml(query)}\"</p>\n            </div>\n        `;\n        dropdown.hidden = false;\n        return;\n    }\n\n    // Group results by type\n    const grouped = groupResultsByType(results);\n\n    // Build HTML\n    const html = buildDropdownHTML(grouped, query);\n    dropdown.innerHTML = html;\n    dropdown.hidden = false;\n\n    logger.debug({\n        operation: 'search-dropdown.show',\n        data: { resultCount: results.length, groupCount: grouped.size },\n    });\n}\n\n/**\n * Hide the search dropdown\n */\nexport function hideSearchDropdown(): void {\n    const dropdown = safeGetElementById(DROPDOWN_ID);\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n\n    if (dropdown) {\n        dropdown.hidden = true;\n        dropdown.innerHTML = '';\n    }\n\n    if (searchInput) {\n        searchInput.setAttribute('aria-expanded', 'false');\n    }\n\n    // Reset state\n    focusedIndex = -1;\n    currentResults = [];\n    isDropdownVisible = false;\n}\n\n/**\n * Handle keyboard navigation in the dropdown\n * @param event - Keyboard event\n * @returns true if the event was handled\n */\nexport function handleDropdownKeyboard(event: KeyboardEvent): boolean {\n    if (!isDropdownVisible || currentResults.length === 0) {\n        return false;\n    }\n\n    switch (event.key) {\n        case 'ArrowDown':\n            event.preventDefault();\n            focusedIndex = Math.min(focusedIndex + 1, currentResults.length - 1);\n            updateFocusedItem();\n            return true;\n\n        case 'ArrowUp':\n            event.preventDefault();\n            focusedIndex = Math.max(focusedIndex - 1, -1);\n            updateFocusedItem();\n            return true;\n\n        case 'Enter':\n            if (focusedIndex >= 0) {\n                event.preventDefault();\n                selectFocusedItem();\n                return true;\n            }\n            return false;\n\n        case 'Escape':\n            event.preventDefault();\n            hideSearchDropdown();\n            return true;\n\n        default:\n            return false;\n    }\n}\n\n/**\n * Highlight matching text in a string\n * @param text - Text to highlight\n * @param query - Search query\n * @returns HTML with highlighted matches\n */\nexport function highlightMatches(text: string, query: string): string {\n    if (!text || !query) return escapeHtml(text || '');\n\n    const escapedText = escapeHtml(text);\n    const escapedQuery = escapeHtml(query);\n\n    // Case-insensitive match\n    const regex = new RegExp(`(${escapeRegex(escapedQuery)})`, 'gi');\n    return escapedText.replace(regex, '<mark class=\"match-highlight\">$1</mark>');\n}\n\n/**\n * Navigate to a search result\n * @param result - The search result to navigate to\n */\nexport function navigateToResult(result: GlobalSearchResult): void {\n    hideSearchDropdown();\n\n    // Clear the search input\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    if (searchInput) {\n        searchInput.value = '';\n    }\n\n    // Switch to the appropriate tab\n    if (typeof window.switchTab === 'function') {\n        window.switchTab(result.type);\n    }\n\n    // After tab switch, scroll to and highlight the item\n    requestAnimationFrame(() => {\n        const entityId = result.item.id;\n        const itemCard = document.querySelector(`[data-entity-id=\"${entityId}\"]`) as HTMLElement | null;\n        if (itemCard) {\n            itemCard.scrollIntoView({ behavior: 'smooth', block: 'center' });\n            itemCard.classList.add('search-highlight');\n            setTimeout(() => {\n                itemCard.classList.remove('search-highlight');\n            }, 2000);\n        }\n    });\n}\n\n// ========================================\n// Internal Functions\n// ========================================\n\n/**\n * Group results by entity type\n */\nfunction groupResultsByType(results: GlobalSearchResult[]): Map<EntityType, GlobalSearchResult[]> {\n    const grouped = new Map<EntityType, GlobalSearchResult[]>();\n\n    for (const result of results) {\n        const existing = grouped.get(result.type) || [];\n        if (existing.length < MAX_RESULTS_PER_TYPE_DROPDOWN) {\n            existing.push(result);\n            grouped.set(result.type, existing);\n        }\n    }\n\n    return grouped;\n}\n\n/**\n * Build the dropdown HTML\n */\nfunction buildDropdownHTML(grouped: Map<EntityType, GlobalSearchResult[]>, query: string): string {\n    const typeOrder: EntityType[] = ['items', 'weapons', 'tomes', 'characters', 'shrines'];\n    let html = '';\n    let globalIndex = 0;\n\n    for (const type of typeOrder) {\n        const typeResults = grouped.get(type);\n        if (!typeResults || typeResults.length === 0) continue;\n\n        const { label, icon } = TYPE_LABELS[type];\n\n        html += `\n            <div class=\"search-dropdown-section\" data-type=\"${type}\">\n                <div class=\"search-dropdown-header\">\n                    <span class=\"section-icon\">${icon}</span>\n                    <span class=\"section-label\">${label}</span>\n                    <span class=\"section-count\">(${typeResults.length})</span>\n                </div>\n                <div class=\"search-dropdown-items\">\n        `;\n\n        for (const result of typeResults) {\n            html += buildResultItemHTML(result, query, globalIndex);\n            globalIndex++;\n        }\n\n        html += `\n                </div>\n            </div>\n        `;\n    }\n\n    // Add keyboard hint footer\n    html += `\n        <div class=\"search-dropdown-footer\">\n            <span class=\"keyboard-hint\"> Navigate</span>\n            <span class=\"keyboard-hint\">Enter Select</span>\n            <span class=\"keyboard-hint\">Esc Close</span>\n        </div>\n    `;\n\n    return html;\n}\n\n/**\n * Build HTML for a single result item\n * Bug fix: Validate image URLs to prevent javascript: XSS and escape all user data\n */\nfunction buildResultItemHTML(result: GlobalSearchResult, query: string, index: number): string {\n    const { item, type } = result;\n    const description = getItemDescription(item, type);\n    const truncatedDesc = truncateText(description, 60);\n    const tierClass = item.tier ? `tier-${escapeHtml(item.tier.toLowerCase())}` : '';\n    // Bug fix: Validate image URL to prevent javascript: or data: XSS attacks\n    const hasValidImage = item.image && isValidExternalUrl(item.image);\n    const imageHtml = hasValidImage\n        ? `<img src=\"${escapeHtml(item.image)}\" alt=\"\" class=\"dropdown-item-image\" loading=\"lazy\">`\n        : `<span class=\"dropdown-item-icon\">${TYPE_LABELS[type].icon}</span>`;\n\n    return `\n        <div class=\"search-dropdown-item\"\n             data-index=\"${index}\"\n             data-type=\"${escapeHtml(type)}\"\n             data-id=\"${escapeHtml(item.id)}\"\n             role=\"option\"\n             tabindex=\"-1\"\n             aria-selected=\"false\">\n            <div class=\"dropdown-item-visual\">\n                ${imageHtml}\n            </div>\n            <div class=\"dropdown-item-info\">\n                <span class=\"dropdown-item-name\">${highlightMatches(item.name, query)}</span>\n                ${item.tier ? `<span class=\"tier-label ${tierClass}\">${escapeHtml(item.tier)}</span>` : ''}\n            </div>\n            <div class=\"dropdown-item-desc\">${escapeHtml(truncatedDesc)}</div>\n            <span class=\"dropdown-item-arrow\"></span>\n        </div>\n    `;\n}\n\n/**\n * Get description text based on entity type\n */\nfunction getItemDescription(item: Item | Weapon | Tome | Character | Shrine, type: EntityType): string {\n    switch (type) {\n        case 'items':\n            return (item as Item).base_effect || item.description || '';\n        case 'weapons':\n            return (item as Weapon).attack_pattern || item.description || '';\n        case 'tomes': {\n            const tome = item as Tome;\n            return `${tome.stat_affected || ''}: ${tome.value_per_level || ''}`.trim() || item.description || '';\n        }\n        case 'characters':\n            return (item as Character).passive_ability || (item as Character).description || '';\n        case 'shrines':\n            return (item as Shrine).reward || item.description || '';\n        default:\n            return item.description || '';\n    }\n}\n\n/**\n * Truncate text to a maximum length\n */\nfunction truncateText(text: string, maxLength: number): string {\n    if (!text) return '';\n    if (text.length <= maxLength) return text;\n    return text.substring(0, maxLength - 3) + '...';\n}\n\n/**\n * Escape regex special characters\n */\nfunction escapeRegex(str: string): string {\n    return str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n}\n\n/**\n * Update the visually focused item in the dropdown\n */\nfunction updateFocusedItem(): void {\n    const dropdown = safeGetElementById(DROPDOWN_ID);\n    if (!dropdown) return;\n\n    const items = dropdown.querySelectorAll('.search-dropdown-item');\n    items.forEach((item, index) => {\n        const isFocused = index === focusedIndex;\n        item.classList.toggle('keyboard-focused', isFocused);\n        item.setAttribute('aria-selected', isFocused ? 'true' : 'false');\n\n        if (isFocused) {\n            (item as HTMLElement).scrollIntoView({ block: 'nearest' });\n        }\n    });\n}\n\n/**\n * Select the currently focused item\n */\nfunction selectFocusedItem(): void {\n    const result = getSelectedResult();\n    if (result) {\n        navigateToResult(result);\n    }\n}\n\n// ========================================\n// Click Handler Setup\n// ========================================\n\n/**\n * Setup click handlers for dropdown items\n * Called once after the dropdown is created in the DOM\n */\nexport function setupDropdownClickHandlers(): void {\n    const dropdown = safeGetElementById(DROPDOWN_ID);\n    if (!dropdown) return;\n\n    dropdown.addEventListener('click', (e: MouseEvent) => {\n        const target = e.target as HTMLElement;\n        const item = target.closest('.search-dropdown-item') as HTMLElement | null;\n\n        if (item) {\n            const indexStr = item.dataset.index;\n            if (indexStr !== undefined) {\n                const index = parseInt(indexStr, 10);\n                const result = currentResults[index];\n                if (!isNaN(index) && index >= 0 && index < currentResults.length && result) {\n                    navigateToResult(result);\n                }\n            }\n        }\n    });\n\n    // Close dropdown when clicking outside\n    document.addEventListener('click', (e: MouseEvent) => {\n        const target = e.target as HTMLElement;\n        const searchInput = safeGetElementById('searchInput');\n        const dropdownEl = safeGetElementById(DROPDOWN_ID);\n\n        if (\n            isDropdownVisible &&\n            target !== searchInput &&\n            !dropdownEl?.contains(target) &&\n            !target.closest('.search-box')\n        ) {\n            hideSearchDropdown();\n        }\n    });\n}\n","// ========================================\n// MegaBonk Filters Module\n// ========================================\n// Main filter UI and data filtering logic\n// Split into focused modules for maintainability\n\nimport type { Entity, EntityType, ChangelogPatch, SortBy } from '../types/index.ts';\nimport { isItem, isShrine, isInputElement, isSelectElement } from '../types/index.ts';\nimport { safeGetElementById, safeQuerySelectorAll, sortData } from './utils.ts';\nimport { logger } from './logger.ts';\nimport { isFavorite } from './favorites.ts';\nimport { getState } from './store.ts';\n\n// Re-export from split modules for backwards compatibility\nexport {\n    getSearchHistory,\n    addToSearchHistory,\n    clearSearchHistory,\n    showSearchHistoryDropdown,\n} from './search-history.ts';\n\nexport {\n    getAllFilterStates,\n    saveFilterState,\n    restoreFilterState,\n    clearAllFilterStates,\n    type FilterState,\n} from './filter-state.ts';\n\nexport {\n    fuzzyMatchScore,\n    parseAdvancedSearch,\n    matchesAdvancedFilters,\n    type FuzzyMatchResult,\n    type AdvancedSearchCriteria,\n} from './fuzzy-match.ts';\n\nexport { globalSearch, type GlobalSearchResult } from './global-search.ts';\n\n// Import for internal use\nimport { addToSearchHistory } from './search-history.ts';\nimport { saveFilterState } from './filter-state.ts';\nimport { fuzzyMatchScore, parseAdvancedSearch, matchesAdvancedFilters } from './fuzzy-match.ts';\nimport { globalSearch } from './global-search.ts';\nimport { hideSearchDropdown } from './search-dropdown.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Item with match context (internal)\n */\ninterface ItemWithMatchContext extends Record<string, unknown> {\n    _matchContext?: {\n        score: number;\n        matchType: string;\n        field: string;\n    };\n}\n\n// ========================================\n// Filter UI\n// ========================================\n\n/**\n * Update filter dropdowns based on active tab\n * @param tabName - Current tab name\n */\nexport function updateFilters(tabName: string): void {\n    const filtersContainer = safeGetElementById('filters') as HTMLDivElement | null;\n    if (!filtersContainer) return;\n\n    filtersContainer.innerHTML = '';\n\n    if (tabName === 'items') {\n        // DISABLED: Favorites Only checkbox hidden (feature UI disabled)\n        filtersContainer.innerHTML = `\n            <label for=\"rarityFilter\">Rarity:</label>\n            <select id=\"rarityFilter\">\n                <option value=\"all\">All Rarities</option>\n                <option value=\"common\">Common</option>\n                <option value=\"uncommon\">Uncommon</option>\n                <option value=\"rare\">Rare</option>\n                <option value=\"epic\">Epic</option>\n                <option value=\"legendary\">Legendary</option>\n            </select>\n            <label for=\"tierFilter\">Tier:</label>\n            <select id=\"tierFilter\">\n                <option value=\"all\">All Tiers</option>\n                <option value=\"SS\">SS Tier</option>\n                <option value=\"S\">S Tier</option>\n                <option value=\"A\">A Tier</option>\n                <option value=\"B\">B Tier</option>\n                <option value=\"C\">C Tier</option>\n            </select>\n            <label for=\"stackingFilter\">Stacking:</label>\n            <select id=\"stackingFilter\">\n                <option value=\"all\">All</option>\n                <option value=\"stacks_well\">Stacks Well</option>\n                <option value=\"one_and_done\">One-and-Done</option>\n            </select>\n            <label for=\"sortBy\">Sort:</label>\n            <select id=\"sortBy\">\n                <option value=\"name\">Name</option>\n                <option value=\"tier\">Tier</option>\n                <option value=\"rarity\">Rarity</option>\n            </select>\n        `;\n    } else if (['weapons', 'tomes', 'characters'].includes(tabName)) {\n        // DISABLED: Favorites Only checkbox hidden (feature UI disabled)\n        filtersContainer.innerHTML = `\n            <label for=\"tierFilter\">Tier:</label>\n            <select id=\"tierFilter\">\n                <option value=\"all\">All Tiers</option>\n                <option value=\"SS\">SS Tier</option>\n                <option value=\"S\">S Tier</option>\n                <option value=\"A\">A Tier</option>\n                <option value=\"B\">B Tier</option>\n                <option value=\"C\">C Tier</option>\n            </select>\n            <label for=\"sortBy\">Sort:</label>\n            <select id=\"sortBy\">\n                <option value=\"name\">Name</option>\n                <option value=\"tier\">Tier</option>\n            </select>\n        `;\n    } else if (tabName === 'shrines') {\n        // DISABLED: Favorites Only checkbox hidden (feature UI disabled)\n        filtersContainer.innerHTML = `\n            <label for=\"typeFilter\">Type:</label>\n            <select id=\"typeFilter\">\n                <option value=\"all\">All Types</option>\n                <option value=\"stat_upgrade\">Stat Upgrade</option>\n                <option value=\"combat\">Combat</option>\n                <option value=\"utility\">Utility</option>\n                <option value=\"risk_reward\">Risk/Reward</option>\n            </select>\n        `;\n    } else if (tabName === 'changelog') {\n        filtersContainer.innerHTML = `\n            <label for=\"categoryFilter\">Category:</label>\n            <select id=\"categoryFilter\">\n                <option value=\"all\">All Categories</option>\n                <option value=\"balance\">Balance Changes</option>\n                <option value=\"new_content\">New Content</option>\n                <option value=\"bug_fixes\">Bug Fixes</option>\n                <option value=\"removed\">Removed</option>\n                <option value=\"other\">Other</option>\n            </select>\n            <label for=\"sortBy\">Sort:</label>\n            <select id=\"sortBy\">\n                <option value=\"date_desc\">Newest First</option>\n                <option value=\"date_asc\">Oldest First</option>\n            </select>\n        `;\n    }\n}\n\n/**\n * Filter data based on current filter settings\n * @param data - Data array to filter\n * @param tabName - Current tab name\n * @returns Filtered data array\n */\nexport function filterData(data: Entity[], tabName: string): Entity[] {\n    const filterStartTime = performance.now();\n    const originalCount = data.length;\n    let filtered = [...data];\n\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    const searchQuery = searchInput?.value || '';\n\n    // Advanced search with fuzzy matching\n    if (searchQuery.trim()) {\n        const criteria = parseAdvancedSearch(searchQuery);\n\n        // Apply text search with match context\n        if (criteria.text.length > 0) {\n            const searchTerm = criteria.text.join(' ').toLowerCase();\n\n            filtered = filtered\n                .map(item => {\n                    const name = item.name || '';\n                    const description = item.description || '';\n                    const baseEffect = isItem(item) ? item.base_effect || '' : '';\n                    const tags = (item.tags || []).join(' ');\n                    const rarity = isItem(item) ? item.rarity || '' : '';\n\n                    const matches = [\n                        fuzzyMatchScore(searchTerm, name, 'name'),\n                        fuzzyMatchScore(searchTerm, description, 'description'),\n                        fuzzyMatchScore(searchTerm, baseEffect, 'effect'),\n                        fuzzyMatchScore(searchTerm, tags, 'tags'),\n                        fuzzyMatchScore(searchTerm, rarity, 'rarity'),\n                    ];\n\n                    const bestMatch = matches.reduce((best, current) => (current.score > best.score ? current : best));\n\n                    return {\n                        item: { ...item, _matchContext: bestMatch } as Entity & ItemWithMatchContext,\n                        score: bestMatch.score,\n                    };\n                })\n                .filter(result => result.score > 0)\n                .sort((a, b) => b.score - a.score)\n                .map(result => result.item as Entity);\n        }\n\n        // Apply advanced filter criteria\n        if (Object.keys(criteria.filters).length > 0) {\n            filtered = filtered.filter(item =>\n                matchesAdvancedFilters(item as unknown as Record<string, unknown>, criteria.filters)\n            );\n        }\n    }\n\n    // Favorites filter\n    const favoritesOnlyEl = safeGetElementById('favoritesOnly');\n    const favoritesOnly = isInputElement(favoritesOnlyEl) ? favoritesOnlyEl.checked : false;\n    if (favoritesOnly) {\n        filtered = filtered.filter(item => isFavorite(tabName as EntityType, item.id));\n    }\n\n    // Tier filter\n    const tierFilterEl = safeGetElementById('tierFilter');\n    const tierFilter = isSelectElement(tierFilterEl) ? tierFilterEl.value : 'all';\n    if (tierFilter && tierFilter !== 'all') {\n        filtered = filtered.filter(item => item.tier === tierFilter);\n    }\n\n    // Rarity filter (items only)\n    if (tabName === 'items') {\n        const rarityFilterEl = safeGetElementById('rarityFilter');\n        const rarityFilter = isSelectElement(rarityFilterEl) ? rarityFilterEl.value : 'all';\n        if (rarityFilter && rarityFilter !== 'all') {\n            filtered = filtered.filter(item => isItem(item) && item.rarity === rarityFilter);\n        }\n\n        const stackingFilterEl = safeGetElementById('stackingFilter');\n        const stackingFilter = isSelectElement(stackingFilterEl) ? stackingFilterEl.value : 'all';\n        if (stackingFilter === 'stacks_well') {\n            filtered = filtered.filter(item => isItem(item) && item.stacks_well === true);\n        } else if (stackingFilter === 'one_and_done') {\n            filtered = filtered.filter(item => isItem(item) && item.one_and_done === true);\n        }\n    }\n\n    // Type filter (shrines only)\n    if (tabName === 'shrines') {\n        const typeFilterEl = safeGetElementById('typeFilter');\n        const typeFilter = isSelectElement(typeFilterEl) ? typeFilterEl.value : 'all';\n        if (typeFilter && typeFilter !== 'all') {\n            filtered = filtered.filter(shrine => isShrine(shrine) && shrine.type === typeFilter);\n        }\n    }\n\n    // Changelog-specific filtering\n    if (tabName === 'changelog') {\n        type PatchWithCategories = ChangelogPatch & {\n            categories?: Record<string, unknown[]>;\n        };\n        const patches = filtered as unknown as PatchWithCategories[];\n        const categoryFilterEl = safeGetElementById('categoryFilter');\n        const categoryFilter = isSelectElement(categoryFilterEl) ? categoryFilterEl.value : 'all';\n        if (categoryFilter && categoryFilter !== 'all') {\n            const filteredPatches = patches.filter(patch => {\n                if (patch.categories && categoryFilter in patch.categories) {\n                    const categoryItems = patch.categories[categoryFilter];\n                    return categoryItems && categoryItems.length > 0;\n                }\n                return false;\n            });\n            filtered = filteredPatches as unknown as Entity[];\n        }\n\n        // Date sorting - pre-compute date values for O(n) instead of O(n log n) date parsing\n        const sortByEl = safeGetElementById('sortBy');\n        const sortBy = isSelectElement(sortByEl) ? sortByEl.value : 'date_desc';\n        const patchesForSort = filtered as unknown as ChangelogPatch[];\n\n        // Pre-compute date values once (avoids repeated parsing during sort comparisons)\n        const dateCache = new Map<string, number>();\n        const defaultValue = sortBy === 'date_asc' ? Infinity : -Infinity;\n        patchesForSort.forEach(patch => {\n            // Bug fix: Handle undefined/null patch.date to prevent Map key issues and invalid dates\n            const dateKey = patch.date ?? '';\n            if (!dateCache.has(dateKey)) {\n                const d = new Date(dateKey);\n                // If date is empty or invalid, use default value for proper sorting\n                dateCache.set(dateKey, !dateKey || isNaN(d.getTime()) ? defaultValue : d.getTime());\n            }\n        });\n\n        // Sort using cached date values\n        if (sortBy === 'date_asc') {\n            patchesForSort.sort(\n                (a, b) => (dateCache.get(a.date ?? '') ?? defaultValue) - (dateCache.get(b.date ?? '') ?? defaultValue)\n            );\n        } else {\n            patchesForSort.sort(\n                (a, b) => (dateCache.get(b.date ?? '') ?? defaultValue) - (dateCache.get(a.date ?? '') ?? defaultValue)\n            );\n        }\n\n        logFilterEvent(filterStartTime, tabName, searchQuery, originalCount, patchesForSort.length);\n        return patchesForSort as unknown as Entity[];\n    }\n\n    // Standard sorting\n    const standardSortByEl = safeGetElementById('sortBy');\n    const standardSortBy = isSelectElement(standardSortByEl) ? standardSortByEl.value : null;\n    if (standardSortBy) {\n        sortData(filtered, standardSortBy as SortBy);\n    }\n\n    logFilterEvent(filterStartTime, tabName, searchQuery, originalCount, filtered.length);\n    return filtered;\n}\n\n/**\n * Log filter event for debugging\n */\nfunction logFilterEvent(\n    startTime: number,\n    tabName: string,\n    searchQuery: string,\n    originalCount: number,\n    filteredCount: number\n): void {\n    const duration = Math.round(performance.now() - startTime);\n    const tierFilterEl = safeGetElementById('tierFilter') as HTMLSelectElement | null;\n    const favoritesOnlyEl = safeGetElementById('favoritesOnly') as HTMLInputElement | null;\n\n    if (searchQuery.trim() || tierFilterEl?.value !== 'all' || favoritesOnlyEl?.checked) {\n        logger.debug({\n            operation: 'filter.apply',\n            durationMs: duration,\n            data: {\n                tabName,\n                searchQuery: searchQuery.trim(),\n                totalItems: originalCount,\n                matchedItems: filteredCount,\n            },\n        });\n    }\n}\n\n/**\n * Handle search input - renders results in main content area\n * Shows current tab's matches first, then other tabs' matches\n */\nexport function handleSearch(): void {\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    const searchQuery = searchInput?.value || '';\n    const trimmedQuery = searchQuery.trim();\n\n    // Add to search history for queries >= 2 chars\n    if (trimmedQuery.length >= 2) {\n        addToSearchHistory(trimmedQuery);\n    }\n\n    const currentTab = getState('currentTab');\n\n    // Hide the dropdown (we're using main content area instead)\n    hideSearchDropdown();\n\n    // For queries >= 2 chars, show global search results in main content\n    if (trimmedQuery.length >= 2) {\n        const allData = getState('allData');\n        if (allData && window.renderGlobalSearchResults) {\n            const results = globalSearch(trimmedQuery, allData);\n            // Render results in main content area with current tab prioritized\n            window.renderGlobalSearchResults(results, currentTab, trimmedQuery);\n        }\n    } else {\n        // No search or short query - render normal tab content\n        if (window.renderTabContent && currentTab) {\n            window.renderTabContent(currentTab);\n        }\n    }\n\n    if (currentTab) {\n        saveFilterState(currentTab);\n    }\n}\n\n/**\n * Clear all filters and search\n */\nexport function clearFilters(): void {\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    if (searchInput) searchInput.value = '';\n\n    // Hide the search dropdown\n    hideSearchDropdown();\n\n    safeQuerySelectorAll('#filters select').forEach(el => {\n        const select = el as HTMLSelectElement;\n        select.value = 'all';\n    });\n\n    const currentTab = getState('currentTab');\n    if (window.renderTabContent && currentTab) {\n        window.renderTabContent(currentTab);\n    }\n}\n\n// ========================================\n// Global Scope Exports (backwards compatibility)\n// ========================================\n\nif (typeof window !== 'undefined') {\n    Object.assign(window, {\n        updateFilters,\n        filterData,\n        handleSearch,\n        clearFilters,\n    });\n}\n","// ========================================\n// MegaBonk Global Search Module\n// ========================================\n// Cross-tab search functionality\n\nimport type { Entity, EntityType, Item, Weapon, Tome, Character, Shrine, AllGameData } from '../types/index.ts';\nimport { fuzzyMatchScore } from './fuzzy-match.ts';\nimport { MAX_GLOBAL_SEARCH_RESULTS, MAX_SEARCH_RESULTS_PER_TYPE } from './constants.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Global search result with type and score\n */\nexport interface GlobalSearchResult {\n    type: EntityType;\n    item: Item | Weapon | Tome | Character | Shrine;\n    score: number;\n}\n\n// ========================================\n// Global Search\n// ========================================\n\n/**\n * Search across all data types (items, weapons, tomes, characters, shrines)\n * Returns results sorted by match score\n * Optimized with early termination and result limits\n * @param query - Search query\n * @param allData - All game data\n * @returns Sorted array of search results\n */\nexport function globalSearch(query: string, allData: AllGameData): GlobalSearchResult[] {\n    if (!query || !query.trim()) {\n        return [];\n    }\n\n    const results: GlobalSearchResult[] = [];\n    const searchTerm = query.trim().toLowerCase();\n\n    // Prioritize fields by importance\n    const searchFields = [\n        'name',\n        'base_effect',\n        'attack_pattern',\n        'passive_ability',\n        'reward',\n        'description',\n        'effect',\n        'passive',\n        'rarity',\n    ];\n\n    // Score thresholds for early termination within field search\n    // These are boosted to account for name field bonus (+1000) in fuzzy-match.ts\n    const EXACT_MATCH_SCORE = 3000; // 2000 base + 1000 name bonus\n    const STARTS_WITH_SCORE = 2500; // 1500 base + 1000 name bonus\n    // MAX_GLOBAL_SEARCH_RESULTS and MAX_SEARCH_RESULTS_PER_TYPE imported from constants.ts\n\n    // Define data sources with their types\n    const dataSources: Array<{ type: EntityType; data: Entity[] | undefined }> = [\n        { type: 'items', data: allData.items?.items },\n        { type: 'weapons', data: allData.weapons?.weapons },\n        { type: 'tomes', data: allData.tomes?.tomes },\n        { type: 'characters', data: allData.characters?.characters },\n        { type: 'shrines', data: allData.shrines?.shrines },\n    ];\n\n    // Search each data type - don't break early to ensure all types are searched\n    for (const { type, data } of dataSources) {\n        if (!data) continue;\n\n        let resultsForType = 0;\n\n        for (const item of data) {\n            // Limit results per type to ensure variety across all data types\n            if (resultsForType >= MAX_SEARCH_RESULTS_PER_TYPE) {\n                break;\n            }\n\n            let bestScore = 0;\n\n            // Check fields in priority order\n            for (const field of searchFields) {\n                const value = (item as unknown as Record<string, unknown>)[field];\n                if (typeof value === 'string' && value) {\n                    const match = fuzzyMatchScore(searchTerm, value, field);\n                    if (match.score > bestScore) {\n                        bestScore = match.score;\n                        // Early termination for high-quality matches within item\n                        if (bestScore >= STARTS_WITH_SCORE && field === 'name') {\n                            break;\n                        }\n                        if (bestScore >= EXACT_MATCH_SCORE) {\n                            break;\n                        }\n                    }\n                }\n            }\n\n            // Check tags if no strong match yet\n            if (bestScore < STARTS_WITH_SCORE) {\n                const tags = item.tags;\n                if (Array.isArray(tags)) {\n                    const tagsString = tags.join(' ');\n                    const match = fuzzyMatchScore(searchTerm, tagsString, 'tags');\n                    if (match.score > bestScore) {\n                        bestScore = match.score;\n                    }\n                }\n            }\n\n            if (bestScore > 0) {\n                results.push({\n                    type,\n                    item: item as Item | Weapon | Tome | Character | Shrine,\n                    score: bestScore,\n                });\n                resultsForType++;\n            }\n        }\n    }\n\n    // Sort by score (highest first) and limit total results\n    return results.sort((a, b) => b.score - a.score).slice(0, MAX_GLOBAL_SEARCH_RESULTS);\n}\n","// ========================================\n// Common Renderer Utilities\n// ========================================\n\nimport { safeGetElementById } from '../utils.ts';\nimport { getDataForTab } from '../data-service.ts';\nimport { logger } from '../logger.ts';\nimport type { Entity } from '../../types/index.ts';\n\n/**\n * Helper to initialize charts with requestAnimationFrame and error handling\n * Reduces code duplication across render functions\n * @param chartInitFn - The name of the chart init function to import and call\n * @param context - Context string for logging (e.g., 'item_tab_render')\n */\nexport function initChartsAsync(chartInitFn: 'initializeItemCharts' | 'initializeTomeCharts', context: string): void {\n    requestAnimationFrame(async () => {\n        try {\n            const charts = await import('../charts.ts');\n            charts[chartInitFn]();\n        } catch (err) {\n            logger.warn({\n                operation: 'chart.init',\n                error: { name: 'ImportError', message: `Failed to initialize ${chartInitFn}`, module: 'renderers' },\n                data: { context },\n            });\n        }\n    });\n}\n\n/** Tabs that don't have countable data entities */\nconst NON_DATA_TABS = ['calculator', 'advisor', 'about', 'build-planner'];\n\n/**\n * Update item count badge\n * @param {Entity[]} filtered - Filtered data\n * @param {string} tabName - Current tab\n */\nexport function updateStats(filtered: Entity[], tabName: string): void {\n    const itemCount = safeGetElementById('item-count');\n    if (!itemCount) return;\n\n    // Hide count badge for non-data tabs (Calculator, Advisor, About, Build Planner)\n    if (NON_DATA_TABS.includes(tabName)) {\n        itemCount.style.display = 'none';\n        return;\n    }\n\n    // Show the badge for data tabs\n    itemCount.style.display = '';\n\n    const totalCount = getDataForTab(tabName).length;\n    const showingCount = filtered.length;\n\n    // Get singular/plural label based on tab\n    const categoryName = tabName && tabName.length > 0 ? tabName : 'items';\n    const label = showingCount === 1 ? categoryName.slice(0, -1) : categoryName;\n\n    // Show \"X items\" or \"X/Y items\" if filtered\n    if (showingCount === totalCount) {\n        itemCount.textContent = `${showingCount} ${label}`;\n    } else {\n        itemCount.textContent = `${showingCount}/${totalCount} ${label}`;\n    }\n}\n","// ========================================\n// MegaBonk Empty States Module\n// Option E: Hybrid approach with message, action button, and suggestions\n// ========================================\n\nimport { escapeHtml, safeGetElementById } from './utils.ts';\nimport { getState } from './store.ts';\nimport { getDataForTab } from './data-service.ts';\nimport { getFavorites } from './favorites.ts';\nimport type { Entity, EntityType } from '../types/index.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\nexport type EmptyStateType = 'favorites' | 'search' | 'filters' | 'compare' | 'generic';\n\nexport interface EmptyStateContext {\n    type: EmptyStateType;\n    tabName: EntityType;\n    searchQuery?: string;\n    hasActiveFilters?: boolean;\n}\n\ninterface SuggestedItem {\n    id: string;\n    name: string;\n    tier?: string;\n    description?: string;\n    image?: string;\n    icon?: string;\n    rarity?: string;\n}\n\n// ========================================\n// Empty State Configuration\n// ========================================\n\nconst EMPTY_STATE_CONFIG: Record<EmptyStateType, {\n    getMessage: (ctx: EmptyStateContext) => string;\n    buttonText: string;\n    buttonAction: string;\n}> = {\n    favorites: {\n        getMessage: () => 'No favorites yet! ',\n        buttonText: 'Browse Items',\n        buttonAction: 'browse',\n    },\n    compare: {\n        getMessage: () => 'Nothing to compare yet! ',\n        buttonText: 'Add Items to Compare',\n        buttonAction: 'browse',\n    },\n    search: {\n        getMessage: (ctx) => `No results for \"${escapeHtml(ctx.searchQuery || '')}\" `,\n        buttonText: 'Clear Search',\n        buttonAction: 'clear-search',\n    },\n    filters: {\n        getMessage: () => 'No items match these filters ',\n        buttonText: 'Clear Filters',\n        buttonAction: 'clear-filters',\n    },\n    generic: {\n        getMessage: () => 'No items found',\n        buttonText: 'Clear Filters',\n        buttonAction: 'clear-filters',\n    },\n};\n\n// ========================================\n// Suggestion Generators\n// ========================================\n\n/**\n * Get popular/highly-rated items for suggestions (for favorites empty state)\n */\nfunction getPopularItems(tabName: EntityType, limit: number = 4): SuggestedItem[] {\n    const data = getDataForTab(tabName) as Entity[];\n    if (!data || data.length === 0) return [];\n\n    // Sort by tier (SS > S > A > B > C) and take top items\n    const tierOrder: Record<string, number> = { SS: 0, S: 1, A: 2, B: 3, C: 4 };\n    const sorted = [...data].sort((a, b) => {\n        const tierA = tierOrder[a.tier || 'C'] ?? 5;\n        const tierB = tierOrder[b.tier || 'C'] ?? 5;\n        return tierA - tierB;\n    });\n\n    return sorted.slice(0, limit).map(item => mapEntityToSuggested(item, tabName));\n}\n\n/**\n * Get items good for comparing (different tiers for variety)\n */\nfunction getCompareableItems(tabName: EntityType, limit: number = 4): SuggestedItem[] {\n    const data = getDataForTab(tabName) as Entity[];\n    if (!data || data.length === 0) return [];\n\n    // Get one item from each tier for comparison variety\n    const byTier: Record<string, Entity[]> = {};\n    data.forEach(item => {\n        const tier = item.tier || 'C';\n        if (!byTier[tier]) byTier[tier] = [];\n        byTier[tier].push(item);\n    });\n\n    const suggestions: SuggestedItem[] = [];\n    const tiers = ['SS', 'S', 'A', 'B'];\n    \n    for (const tier of tiers) {\n        if (suggestions.length >= limit) break;\n        const tierItems = byTier[tier];\n        if (tierItems && tierItems.length > 0) {\n            // Pick a random item from this tier\n            const randomIdx = Math.floor(Math.random() * tierItems.length);\n            const item = tierItems[randomIdx];\n            if (item) {\n                suggestions.push(mapEntityToSuggested(item, tabName));\n            }\n        }\n    }\n\n    return suggestions;\n}\n\n/**\n * Get random popular items as alternatives (for search empty state)\n */\nfunction getAlternativeItems(tabName: EntityType, limit: number = 4): SuggestedItem[] {\n    const data = getDataForTab(tabName) as Entity[];\n    if (!data || data.length === 0) return [];\n\n    // Filter to only good items (S or SS tier) for suggestions\n    const goodItems = data.filter(item => item.tier === 'SS' || item.tier === 'S' || item.tier === 'A');\n    const itemPool = goodItems.length >= limit ? goodItems : data;\n\n    // Shuffle and take random items\n    const shuffled = [...itemPool].sort(() => Math.random() - 0.5);\n    return shuffled.slice(0, limit).map(item => mapEntityToSuggested(item, tabName));\n}\n\n/**\n * Get items that partially match filters (relaxed criteria)\n */\nfunction getPartialMatchItems(tabName: EntityType, limit: number = 4): SuggestedItem[] {\n    // For now, just return popular items as \"partial matches\"\n    // In a more advanced implementation, this could look at the active filter values\n    // and find items that match some but not all criteria\n    return getPopularItems(tabName, limit);\n}\n\n/**\n * Map an Entity to SuggestedItem format\n */\nfunction mapEntityToSuggested(entity: Entity, tabName: EntityType): SuggestedItem {\n    const item: SuggestedItem = {\n        id: entity.id,\n        name: entity.name || 'Unknown',\n        tier: entity.tier,\n        description: getShortDescription(entity, tabName),\n    };\n\n    // Handle image/icon based on entity type\n    if (tabName === 'shrines' && 'icon' in entity) {\n        item.icon = (entity as { icon?: string }).icon;\n    } else if ('image' in entity) {\n        item.image = (entity as { image?: string }).image;\n    }\n\n    if ('rarity' in entity) {\n        item.rarity = (entity as { rarity?: string }).rarity;\n    }\n\n    return item;\n}\n\n/**\n * Get a short description for an entity\n */\nfunction getShortDescription(entity: Entity, tabName: EntityType): string {\n    let desc = '';\n    \n    switch (tabName) {\n        case 'items':\n            desc = (entity as { base_effect?: string }).base_effect || entity.description || '';\n            break;\n        case 'weapons':\n            desc = (entity as { attack_pattern?: string }).attack_pattern || entity.description || '';\n            break;\n        case 'tomes':\n            desc = (entity as { stat_affected?: string }).stat_affected || entity.description || '';\n            break;\n        case 'characters':\n            desc = (entity as { passive_ability?: string }).passive_ability || entity.description || '';\n            break;\n        case 'shrines':\n            desc = (entity as { reward?: string }).reward || entity.description || '';\n            break;\n        default:\n            desc = entity.description || '';\n    }\n\n    // Truncate to 60 chars\n    if (desc.length > 60) {\n        return desc.substring(0, 57) + '...';\n    }\n    return desc;\n}\n\n// ========================================\n// Empty State Detection\n// ========================================\n\n/**\n * Detect what type of empty state we should show\n */\nexport function detectEmptyStateType(tabName: EntityType): EmptyStateContext {\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    const searchQuery = searchInput?.value?.trim() || '';\n    \n    const favoritesCheckbox = safeGetElementById('favoritesOnly') as HTMLInputElement | null;\n    const favoritesOnly = favoritesCheckbox?.checked || false;\n    \n    // Check if any filters are active\n    const tierFilter = safeGetElementById('tierFilter') as HTMLSelectElement | null;\n    const rarityFilter = safeGetElementById('rarityFilter') as HTMLSelectElement | null;\n    const stackingFilter = safeGetElementById('stackingFilter') as HTMLSelectElement | null;\n    const typeFilter = safeGetElementById('typeFilter') as HTMLSelectElement | null;\n    \n    const hasActiveFilters = \n        (tierFilter?.value && tierFilter.value !== 'all') ||\n        (rarityFilter?.value && rarityFilter.value !== 'all') ||\n        (stackingFilter?.value && stackingFilter.value !== 'all') ||\n        (typeFilter?.value && typeFilter.value !== 'all');\n\n    // Priority: favorites > search > filters > generic\n    if (favoritesOnly) {\n        const favorites = getFavorites(tabName);\n        if (favorites.length === 0) {\n            return { type: 'favorites', tabName };\n        }\n    }\n\n    if (searchQuery.length > 0) {\n        return { type: 'search', tabName, searchQuery };\n    }\n\n    if (hasActiveFilters) {\n        return { type: 'filters', tabName, hasActiveFilters: true };\n    }\n\n    return { type: 'generic', tabName };\n}\n\n// ========================================\n// HTML Generation\n// ========================================\n\n/**\n * Generate a suggestion card HTML\n */\nfunction generateSuggestionCard(item: SuggestedItem, tabName: EntityType): string {\n    const entityType = tabName.replace(/s$/, ''); // items -> item\n    \n    let imageHtml = '';\n    if (item.icon) {\n        imageHtml = `<span class=\"suggestion-icon\">${escapeHtml(item.icon)}</span>`;\n    } else if (item.image) {\n        imageHtml = `<img src=\"${escapeHtml(item.image)}\" alt=\"${escapeHtml(item.name)}\" class=\"suggestion-image\" loading=\"lazy\" />`;\n    } else {\n        // Fallback emoji based on tab\n        const fallbackIcons: Record<EntityType, string> = {\n            items: '',\n            weapons: '',\n            tomes: '',\n            characters: '',\n            shrines: '',\n        };\n        imageHtml = `<span class=\"suggestion-icon\">${fallbackIcons[tabName]}</span>`;\n    }\n\n    return `\n        <div class=\"suggestion-card\" \n             data-entity-type=\"${entityType}\" \n             data-entity-id=\"${escapeHtml(item.id)}\"\n             data-tab-type=\"${tabName}\"\n             role=\"button\"\n             tabindex=\"0\">\n            <div class=\"suggestion-visual\">\n                ${imageHtml}\n            </div>\n            <div class=\"suggestion-info\">\n                <span class=\"suggestion-name\">${escapeHtml(item.name)}</span>\n                ${item.tier ? `<span class=\"suggestion-tier tier-${item.tier}\">${item.tier}</span>` : ''}\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Generate the full empty state HTML with suggestions\n */\nexport function generateEmptyStateWithSuggestions(context: EmptyStateContext): string {\n    const config = EMPTY_STATE_CONFIG[context.type];\n    const message = config.getMessage(context);\n    const { buttonText, buttonAction } = config;\n\n    // Get appropriate suggestions based on empty state type\n    let suggestions: SuggestedItem[] = [];\n    switch (context.type) {\n        case 'favorites':\n            suggestions = getPopularItems(context.tabName, 4);\n            break;\n        case 'compare':\n            suggestions = getCompareableItems(context.tabName, 4);\n            break;\n        case 'search':\n            suggestions = getAlternativeItems(context.tabName, 4);\n            break;\n        case 'filters':\n            suggestions = getPartialMatchItems(context.tabName, 4);\n            break;\n        default:\n            suggestions = getPopularItems(context.tabName, 4);\n    }\n\n    const suggestionsHtml = suggestions.length > 0 \n        ? `\n            <div class=\"empty-state-suggestions\">\n                <span class=\"suggestions-label\">Try these instead:</span>\n                <div class=\"suggestions-grid\">\n                    ${suggestions.map(item => generateSuggestionCard(item, context.tabName)).join('')}\n                </div>\n            </div>\n        `\n        : '';\n\n    return `\n        <div class=\"empty-state empty-state-enhanced\">\n            <div class=\"empty-state-content\">\n                <h3 class=\"empty-state-message\">${message}</h3>\n                <button class=\"empty-state-action btn-primary\" data-action=\"${buttonAction}\">\n                    ${escapeHtml(buttonText)}\n                </button>\n            </div>\n            ${suggestionsHtml}\n        </div>\n    `;\n}\n\n/**\n * Generate empty state for compare mode\n */\nexport function generateCompareEmptyState(): string {\n    // For compare mode, we suggest items from the items tab\n    const context: EmptyStateContext = { type: 'compare', tabName: 'items' };\n    return generateEmptyStateWithSuggestions(context);\n}\n\n// ========================================\n// Event Handlers\n// ========================================\n\n/**\n * Handle clicks on empty state elements\n * This should be called from event delegation in events-core.ts\n */\nexport function handleEmptyStateClick(target: Element): boolean {\n    // Handle action button clicks\n    if (target.classList.contains('empty-state-action')) {\n        const action = (target as HTMLElement).dataset.action;\n        \n        switch (action) {\n            case 'browse':\n                // Clear filters and show all items\n                clearFiltersAndSearch();\n                return true;\n            case 'clear-search':\n                clearSearch();\n                return true;\n            case 'clear-filters':\n                clearFiltersAndSearch();\n                return true;\n        }\n    }\n\n    // Handle suggestion card clicks\n    if (target.classList.contains('suggestion-card') || target.closest('.suggestion-card')) {\n        const card = target.classList.contains('suggestion-card') \n            ? target as HTMLElement \n            : target.closest('.suggestion-card') as HTMLElement;\n        \n        if (card) {\n            const entityType = card.dataset.entityType;\n            const entityId = card.dataset.entityId;\n            \n            if (entityType && entityId) {\n                // Open the detail modal for this item\n                import('./modal.ts').then(({ openDetailModal }) => {\n                    openDetailModal(entityType as EntityType, entityId);\n                });\n                return true;\n            }\n        }\n    }\n\n    return false;\n}\n\n/**\n * Clear search input\n */\nfunction clearSearch(): void {\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    if (searchInput) {\n        searchInput.value = '';\n        // Trigger re-render\n        const currentTab = getState('currentTab');\n        if (window.renderTabContent && currentTab) {\n            window.renderTabContent(currentTab);\n        }\n    }\n}\n\n/**\n * Clear all filters and search\n */\nfunction clearFiltersAndSearch(): void {\n    // Clear search\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    if (searchInput) searchInput.value = '';\n\n    // Clear favorites only checkbox\n    const favoritesCheckbox = safeGetElementById('favoritesOnly') as HTMLInputElement | null;\n    if (favoritesCheckbox) favoritesCheckbox.checked = false;\n\n    // Clear all select filters\n    const selects = document.querySelectorAll('#filters select');\n    selects.forEach(select => {\n        (select as HTMLSelectElement).value = 'all';\n    });\n\n    // Trigger re-render\n    const currentTab = getState('currentTab');\n    if (window.renderTabContent && currentTab) {\n        window.renderTabContent(currentTab);\n    }\n}\n\n// ========================================\n// Window Type Declarations\n// ========================================\n\ndeclare global {\n    interface Window {\n        renderTabContent?: (tabName: string) => void;\n    }\n}\n","// ========================================\n// Weapon Renderer\n// ========================================\n\nimport {\n    generateEntityImage,\n    generateTierLabel,\n    escapeHtml,\n    safeGetElementById,\n    generateMetaTags,\n} from '../utils.ts';\nimport { detectEmptyStateType, generateEmptyStateWithSuggestions } from '../empty-states.ts';\nimport type { Weapon } from './types.ts';\n\n/**\n * Render weapons grid\n * Uses DocumentFragment for batch DOM updates to prevent layout thrashing\n * @param {Array} weapons - Weapons to render\n */\nexport function renderWeapons(weapons: Weapon[]): void {\n    const container = safeGetElementById('weaponsContainer');\n    if (!container) return;\n\n    if (weapons.length === 0) {\n        const context = detectEmptyStateType('weapons');\n        container.innerHTML = generateEmptyStateWithSuggestions(context);\n        return;\n    }\n\n    // Use DocumentFragment to batch all DOM operations\n    const fragment = document.createDocumentFragment();\n\n    weapons.forEach(weapon => {\n        const card = document.createElement('div');\n        card.className = 'item-card weapon-card clickable-card';\n        card.tabIndex = 0;\n        card.dataset.entityType = 'weapon';\n        card.dataset.entityId = weapon.id;\n\n        const imageHtml = generateEntityImage(weapon, weapon.name);\n        // DISABLED: Favorites feature UI hidden (module kept for data persistence)\n        // const isFav = typeof isFavorite === 'function' ? isFavorite('weapons', weapon.id) : false;\n\n        card.innerHTML = `\n            <div class=\"item-header\">\n                ${imageHtml}\n                <div class=\"item-title\">\n                    <div class=\"item-name\">${escapeHtml(weapon.name)}</div>\n                    ${generateTierLabel(weapon.tier)}\n                </div>\n                <!-- DISABLED: Favorite button hidden\n                <button class=\"favorite-btn\" data-tab=\"weapons\" data-id=\"${weapon.id}\" title=\"Add to favorites\" aria-label=\"Add to favorites\">\n                    \n                </button>\n                -->\n            </div>\n            <div class=\"item-effect\">${escapeHtml(weapon.attack_pattern)}</div>\n            <div class=\"item-description\">${escapeHtml(weapon.description)}</div>\n            <div class=\"item-meta\">\n                ${generateMetaTags(Array.isArray(weapon.upgradeable_stats) ? weapon.upgradeable_stats : weapon.upgradeable_stats ? [weapon.upgradeable_stats] : null, 4)}\n            </div>\n        `;\n\n        fragment.appendChild(card);\n    });\n\n    // Single DOM operation - clear and append atomically to avoid flash\n    container.innerHTML = '';\n    container.appendChild(fragment);\n}\n","// ========================================\n// Global Search Results Rendering\n// ========================================\n\nimport {\n    generateEntityImage,\n    generateTierLabel,\n    escapeHtml,\n    safeGetElementById,\n} from '../utils.ts';\nimport { generateEmptyStateWithSuggestions, type EmptyStateContext } from '../empty-states.ts';\nimport { getState } from '../store.ts';\nimport type { GlobalSearchResult } from '../filters.ts';\nimport type {\n    Item as BaseItem,\n    Weapon as BaseWeapon,\n    Tome as BaseTome,\n    Character as BaseCharacter,\n    Shrine as BaseShrine,\n    Entity,\n    EntityType,\n} from '../../types/index.ts';\nimport type { Shrine } from './types.ts';\n\n/**\n * Type label mapping for display\n */\nconst TYPE_LABELS: Record<EntityType, { label: string; icon: string }> = {\n    items: { label: 'Items', icon: '' },\n    weapons: { label: 'Weapons', icon: '' },\n    tomes: { label: 'Tomes', icon: '' },\n    characters: { label: 'Characters', icon: '' },\n    shrines: { label: 'Shrines', icon: '' },\n};\n\n/**\n * Maximum results to show per category in global search\n */\nconst MAX_RESULTS_PER_TYPE = 10;\n\n/**\n * Render global search results grouped by type\n * Prioritizes the current tab's results at the top\n * @param {GlobalSearchResult[]} results - Search results sorted by score\n * @param {string} currentTab - Current active tab for prioritization\n * @param {string} searchQuery - The search query for display\n */\nexport function renderGlobalSearchResults(\n    results: GlobalSearchResult[],\n    currentTab?: string,\n    searchQuery?: string\n): void {\n    // Get the main content container - use the currently active tab panel's container\n    const activeTabPanel = document.querySelector('.tab-content.active');\n    const container =\n        (activeTabPanel?.querySelector('.items-grid, .items-container') as HTMLElement | null) ||\n        safeGetElementById('itemsContainer');\n    if (!container) return;\n\n    // Update stats to show global search mode\n    const itemCount = safeGetElementById('item-count');\n    if (itemCount) {\n        itemCount.textContent = `${results.length} results across all categories`;\n    }\n\n    // Clear container\n    container.innerHTML = '';\n\n    if (results.length === 0) {\n        // Use enhanced empty state with suggestions\n        const currentTab = getState('currentTab') as EntityType;\n        const validTab = ['items', 'weapons', 'tomes', 'characters', 'shrines'].includes(currentTab) \n            ? currentTab \n            : 'items';\n        const context: EmptyStateContext = {\n            type: 'search',\n            tabName: validTab,\n            searchQuery: searchQuery || '',\n        };\n        container.innerHTML = generateEmptyStateWithSuggestions(context);\n        return;\n    }\n\n    // Group results by type\n    const grouped = new Map<EntityType, GlobalSearchResult[]>();\n    for (const result of results) {\n        const existing = grouped.get(result.type) || [];\n        if (existing.length < MAX_RESULTS_PER_TYPE) {\n            existing.push(result);\n            grouped.set(result.type, existing);\n        }\n    }\n\n    // Determine type order - prioritize current tab if it's a searchable entity type\n    const baseTypeOrder: EntityType[] = ['items', 'weapons', 'tomes', 'characters', 'shrines'];\n    let typeOrder: EntityType[];\n\n    if (currentTab && baseTypeOrder.includes(currentTab as EntityType)) {\n        // Put current tab first, then others in original order\n        const currentTabType = currentTab as EntityType;\n        typeOrder = [currentTabType, ...baseTypeOrder.filter(t => t !== currentTabType)];\n    } else {\n        typeOrder = baseTypeOrder;\n    }\n\n    // Render each group\n    for (const type of typeOrder) {\n        const typeResults = grouped.get(type);\n        if (!typeResults || typeResults.length === 0) continue;\n\n        const { label, icon } = TYPE_LABELS[type];\n        const isCurrentTab = type === currentTab;\n\n        // Create section header\n        const sectionHeader = document.createElement('div');\n        sectionHeader.className = `global-search-section-header${isCurrentTab ? ' current-tab-section' : ''}`;\n        sectionHeader.innerHTML = `\n            <span class=\"section-icon\">${icon}</span>\n            <span class=\"section-title\">${label}${isCurrentTab ? ' (Current Tab)' : ''}</span>\n            <span class=\"section-count\">(${typeResults.length})</span>\n        `;\n        container.appendChild(sectionHeader);\n\n        // Create section container for results\n        const sectionContainer = document.createElement('div');\n        sectionContainer.className = `global-search-section${isCurrentTab ? ' current-tab-results' : ''}`;\n        sectionContainer.dataset.type = type;\n\n        // Render each result\n        for (const result of typeResults) {\n            const card = createSearchResultCard(result);\n            sectionContainer.appendChild(card);\n        }\n\n        container.appendChild(sectionContainer);\n    }\n}\n\n/**\n * Create a compact search result card\n * @param {GlobalSearchResult} result - Search result\n * @returns {HTMLElement} Card element\n */\nfunction createSearchResultCard(result: GlobalSearchResult): HTMLElement {\n    const { type, item } = result;\n    const card = document.createElement('div');\n    card.className = 'search-result-card';\n    card.dataset.entityType = type.slice(0, -1); // Remove trailing 's' (items -> item)\n    card.dataset.entityId = item.id;\n    card.dataset.tabType = type;\n\n    // Get item details based on type\n    // All entity types have 'tier' property\n    const name = item.name || 'Unknown';\n    const tier = item.tier || '';\n    const description = getItemDescription(item, type);\n\n    // Generate image or icon\n    let imageHtml = '';\n    if (type === 'shrines' && 'icon' in item) {\n        imageHtml = `<span class=\"search-result-icon\">${(item as Shrine).icon}</span>`;\n    } else {\n        imageHtml = generateEntityImage(item as Entity, name);\n    }\n\n    card.innerHTML = `\n        <div class=\"search-result-content\">\n            ${imageHtml}\n            <div class=\"search-result-info\">\n                <div class=\"search-result-name\">${escapeHtml(name)}</div>\n                ${tier ? generateTierLabel(tier) : ''}\n                <div class=\"search-result-description\">${escapeHtml(truncateSearchDescription(description, 80))}</div>\n            </div>\n        </div>\n        <div class=\"search-result-action\">\n            <span class=\"go-to-icon\"></span>\n        </div>\n    `;\n\n    return card;\n}\n\n/**\n * Get appropriate description text for an item based on its type\n */\nfunction getItemDescription(item: BaseItem | BaseWeapon | BaseTome | BaseCharacter | BaseShrine, type: EntityType): string {\n    switch (type) {\n        case 'items':\n            return (item as BaseItem).base_effect || item.description || '';\n        case 'weapons':\n            return (item as BaseWeapon).attack_pattern || item.description || '';\n        case 'tomes': {\n            const tome = item as BaseTome;\n            return `${tome.stat_affected || ''}: ${tome.value_per_level || ''}`.trim() || item.description || '';\n        }\n        case 'characters':\n            return (item as BaseCharacter).passive_ability || (item as BaseCharacter).description || '';\n        case 'shrines':\n            return (item as BaseShrine).reward || item.description || '';\n        default:\n            return item.description || '';\n    }\n}\n\n/**\n * Truncate description for search results\n */\nfunction truncateSearchDescription(text: string, maxLength: number): string {\n    if (!text) return '';\n    if (text.length <= maxLength) return text;\n    return text.substring(0, maxLength - 3) + '...';\n}\n","// ========================================\n// MegaBonk Module Registry\n// ========================================\n// Typed function registry for cross-module communication\n// Replaces window globals with a type-safe alternative\n// ========================================\n\nimport type { AllGameData, Character, Weapon, Item, Tome } from '../types/index.ts';\nimport type { TabName } from './store.ts';\n\n// Re-export TabName for convenience\nexport type { TabName };\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Build state for scan-build module\n */\nexport interface BuildState {\n    character: Character | null;\n    weapon: Weapon | null;\n    items: Item[];\n    tomes: Tome[];\n}\n\n/**\n * Callback type for build state changes\n */\nexport type BuildStateCallback = (state: BuildState) => void;\n\n/**\n * Registry of cross-module functions\n * Each function is nullable - null means not yet registered\n */\ninterface ModuleRegistry {\n    // Core navigation\n    switchTab: ((tabName: TabName) => void) | null;\n    renderTabContent: ((tabName: string) => void) | null;\n\n    // Advisor module\n    initAdvisor: ((gameData: AllGameData) => void) | null;\n    applyScannedBuild: ((state: BuildState) => void) | null;\n\n    // Scan build module\n    initScanBuild: ((gameData: AllGameData, callback?: BuildStateCallback) => void) | null;\n\n    // CV/OCR modules (optional, may not be loaded)\n    initCV: ((gameData: AllGameData) => void) | null;\n    initOCR: ((gameData: AllGameData) => void) | null;\n    initEnhancedCV: (() => Promise<void>) | null;\n    detectItemsWithEnhancedCV: ((imageData: ImageData) => Promise<unknown>) | null;\n    initEnhancedScanBuild: ((gameData: AllGameData) => void) | null;\n    handleEnhancedHybridDetect: (() => Promise<void>) | null;\n    compareStrategiesOnImage: ((imageData: ImageData) => Promise<unknown>) | null;\n}\n\n// ========================================\n// Registry State\n// ========================================\n\n/**\n * The module registry instance\n * All functions start as null until registered\n */\nconst registry: ModuleRegistry = {\n    switchTab: null,\n    renderTabContent: null,\n    initAdvisor: null,\n    applyScannedBuild: null,\n    initScanBuild: null,\n    initCV: null,\n    initOCR: null,\n    initEnhancedCV: null,\n    detectItemsWithEnhancedCV: null,\n    initEnhancedScanBuild: null,\n    handleEnhancedHybridDetect: null,\n    compareStrategiesOnImage: null,\n};\n\n// ========================================\n// Registry Functions\n// ========================================\n\n/**\n * Register a function in the module registry\n * @param name - The function name in the registry\n * @param fn - The function to register\n */\nexport function registerFunction<K extends keyof ModuleRegistry>(name: K, fn: ModuleRegistry[K]): void {\n    registry[name] = fn;\n}\n\n/**\n * Get a function from the registry\n * @param name - The function name to retrieve\n * @returns The function or null if not registered\n */\nexport function getFunction<K extends keyof ModuleRegistry>(name: K): ModuleRegistry[K] {\n    return registry[name];\n}\n\n/**\n * Call a registered function with arguments\n * Returns undefined if the function is not registered\n * @param name - The function name to call\n * @param args - Arguments to pass to the function\n * @returns The function's return value or undefined\n */\nexport function callFunction<K extends keyof ModuleRegistry>(\n    name: K,\n    ...args: ModuleRegistry[K] extends ((...args: infer A) => unknown) | null ? A : never[]\n): ModuleRegistry[K] extends ((...args: unknown[]) => infer R) | null ? R | undefined : undefined {\n    const fn = registry[name];\n    if (fn) {\n        type ReturnType = ModuleRegistry[K] extends ((...args: unknown[]) => infer R) | null ? R | undefined : undefined;\n        return (fn as (...args: unknown[]) => unknown)(...args) as ReturnType;\n    }\n    type UndefinedReturn = ModuleRegistry[K] extends ((...args: unknown[]) => infer R) | null ? R | undefined : undefined;\n    return undefined as UndefinedReturn;\n}\n\n/**\n * Check if a function is registered\n * @param name - The function name to check\n * @returns True if the function is registered\n */\nexport function isRegistered<K extends keyof ModuleRegistry>(name: K): boolean {\n    return registry[name] !== null;\n}\n\n/**\n * Unregister a function from the registry\n * Useful for cleanup in tests\n * @param name - The function name to unregister\n */\nexport function unregisterFunction<K extends keyof ModuleRegistry>(name: K): void {\n    registry[name] = null;\n}\n\n/**\n * Clear all registered functions\n * Useful for test cleanup\n */\nexport function clearRegistry(): void {\n    const keys = Object.keys(registry) as (keyof ModuleRegistry)[];\n    keys.forEach(key => {\n        registry[key] = null;\n    });\n}\n\n/**\n * Get list of registered function names\n * @returns Array of registered function names\n */\nexport function getRegisteredFunctions(): (keyof ModuleRegistry)[] {\n    return (Object.keys(registry) as (keyof ModuleRegistry)[]).filter(key => registry[key] !== null);\n}\n","// ========================================\n// Tab Content Renderer (Orchestrator)\n// ========================================\n\nimport { safeGetElementById } from '../utils.ts';\nimport { getDataForTab, allData } from '../data-service.ts';\nimport type { AllGameData } from '../../types/index.ts';\nimport { filterData } from '../filters.ts';\nimport { setState } from '../store.ts';\nimport { registerFunction } from '../registry.ts';\nimport type { Entity, ChangelogPatch } from '../../types/index.ts';\n\nimport { updateStats } from './common.ts';\nimport { renderItems } from './items.ts';\nimport { renderWeapons } from './weapons.ts';\nimport { renderTomes } from './tomes.ts';\nimport { renderCharacters } from './characters.ts';\nimport { renderShrines } from './shrines.ts';\nimport { renderGlobalSearchResults } from './global-search.ts';\nimport type { Item, Weapon, Tome, Character, Shrine } from './types.ts';\n\n// NOTE: Calculator button listener tracking moved to data attribute on element\n// to properly handle DOM recreation scenarios\n\n/**\n * Render content for the current tab\n * Uses dynamic imports for tab-specific modules to enable code splitting\n * @param {string} tabName - Tab to render\n */\nexport async function renderTabContent(tabName: string): Promise<void> {\n    if (tabName === 'build-planner') {\n        const { renderBuildPlanner } = await import('../build-planner.ts');\n        renderBuildPlanner();\n        // Initialize screenshot import feature\n        const { initBuildPlannerScan } = await import('../build-planner-scan.ts');\n        initBuildPlannerScan(allData as AllGameData);\n        // Hide item count badge for build planner tab\n        updateStats([], tabName);\n        return;\n    }\n\n    if (tabName === 'calculator') {\n        const { populateCalculatorItems, calculateBreakpoint } = await import('../calculator.ts');\n        populateCalculatorItems();\n        // Use data attribute to track listener on the actual element\n        // This handles DOM recreation scenarios (HMR, re-renders) correctly\n        const calcBtn = safeGetElementById('calc-button');\n        if (calcBtn && !calcBtn.dataset.listenerAttached) {\n            calcBtn.addEventListener('click', calculateBreakpoint);\n            calcBtn.dataset.listenerAttached = 'true';\n        }\n        // Hide item count badge for calculator tab\n        updateStats([], tabName);\n        return;\n    }\n\n    if (tabName === 'advisor') {\n        // Advisor has its own content, just hide the count badge\n        updateStats([], tabName);\n        return;\n    }\n\n    if (tabName === 'changelog') {\n        const { updateChangelogStats, renderChangelog } = await import('../changelog.ts');\n        const data = getDataForTab(tabName) as ChangelogPatch[];\n        // filterData works with any array having name/description fields\n        const filtered = filterData(data as unknown as Entity[], tabName) as unknown as ChangelogPatch[];\n        setState('filteredData', filtered as unknown as Entity[]);\n        updateChangelogStats(filtered);\n        renderChangelog(filtered);\n        return;\n    }\n\n    if (tabName === 'about') {\n        const { renderAbout, updateAboutStats } = await import('../about.ts');\n        updateAboutStats();\n        renderAbout();\n        return;\n    }\n\n    const data = getDataForTab(tabName) as Entity[];\n    if (!data) return;\n\n    const filtered = filterData(data, tabName);\n    setState('filteredData', filtered);\n\n    updateStats(filtered, tabName);\n\n    // Render based on type\n    switch (tabName) {\n        case 'items':\n            await renderItems(filtered as Item[]);\n            break;\n        case 'weapons':\n            renderWeapons(filtered as Weapon[]);\n            break;\n        case 'tomes':\n            renderTomes(filtered as Tome[]);\n            break;\n        case 'characters':\n            renderCharacters(filtered as Character[]);\n            break;\n        case 'shrines':\n            renderShrines(filtered as Shrine[]);\n            break;\n    }\n}\n\n// ========================================\n// Registry & Global Assignments\n// ========================================\n// Register renderTabContent for type-safe cross-module access\nregisterFunction('renderTabContent', renderTabContent);\n// Keep window assignment for backwards compatibility during migration\nif (typeof window !== 'undefined') {\n    // Type assertions: functions use specific types but window uses generic types for flexibility\n    window.renderTabContent = renderTabContent as typeof window.renderTabContent;\n    window.renderGlobalSearchResults = renderGlobalSearchResults as typeof window.renderGlobalSearchResults;\n}\n","// ========================================\n// Item Renderer\n// ========================================\n\nimport {\n    generateEntityImage,\n    generateTierLabel,\n    escapeHtml,\n    safeGetElementById,\n    truncateText,\n} from '../utils.ts';\nimport { initChartsAsync } from './common.ts';\nimport { detectEmptyStateType, generateEmptyStateWithSuggestions } from '../empty-states.ts';\nimport { FEATURES } from '../constants.ts';\nimport type { Item } from './types.ts';\n\n/**\n * Render items grid\n * Uses DocumentFragment for batch DOM updates to prevent layout thrashing\n * @param {Array} items - Items to render\n */\nexport async function renderItems(items: Item[]): Promise<void> {\n    const container = safeGetElementById('itemsContainer');\n    if (!container) return;\n\n    if (items.length === 0) {\n        const context = detectEmptyStateType('items');\n        container.innerHTML = generateEmptyStateWithSuggestions(context);\n        return;\n    }\n\n    // Cache compare items lookup once instead of per-item\n    // Dynamic import for code splitting - module is preloaded by tab-loader\n    // Only load compare module if feature is enabled\n    let compareItems: string[] = [];\n    if (FEATURES.COMPARE_ITEMS) {\n        const { getCompareItems } = await import('../compare.ts');\n        compareItems = getCompareItems();\n    }\n\n    // Use DocumentFragment to batch all DOM operations - prevents multiple reflows\n    const fragment = document.createDocumentFragment();\n\n    items.forEach(item => {\n        const card = document.createElement('div');\n        card.className = `item-card rarity-${item.rarity} clickable-card`;\n        card.tabIndex = 0;\n        card.dataset.entityType = 'item';\n        card.dataset.entityId = item.id;\n\n        // Stacking type determines text and CSS class for color coding\n        const stackText = item.one_and_done ? 'One-and-Done' : item.stacks_well ? 'Stacks Well' : 'Limited';\n        const stackClass = item.one_and_done ? 'tag-one-and-done' : item.stacks_well ? 'tag-stacks-well' : 'tag-limited';\n        const imageHtml = generateEntityImage(item, item.name);\n\n        // Determine if this item should show a scaling graph\n        const showGraph = item.scaling_per_stack && !item.one_and_done && item.graph_type !== 'flat';\n        const graphHtml = showGraph\n            ? `\n            <div class=\"item-graph-container\">\n                <canvas id=\"chart-${item.id}\" class=\"scaling-chart\"></canvas>\n            </div>\n        `\n            : `\n            <div class=\"item-graph-placeholder\">\n                <span>${item.one_and_done ? 'One-and-done: no scaling benefit from stacks' : 'Flat bonus: does not scale'}</span>\n            </div>\n        `;\n\n        // Handle expandable description\n        const { html: descHtml, needsExpand, fullText } = truncateText(item.detailed_description, 120);\n\n        // DISABLED: Favorites feature UI hidden (module kept for data persistence)\n        // const isFav = typeof isFavorite === 'function' ? isFavorite('items', item.id) : false;\n        \n        // Compare checkbox - only render if feature is enabled\n        const compareCheckboxHtml = FEATURES.COMPARE_ITEMS\n            ? `<label class=\"compare-checkbox-label\" title=\"Add to comparison\">\n                    <input type=\"checkbox\" class=\"compare-checkbox\" data-id=\"${item.id}\" ${compareItems.includes(item.id) ? 'checked' : ''}>\n                    <span>+</span>\n                </label>`\n            : '';\n        \n        card.innerHTML = `\n            <div class=\"item-header\">\n                ${imageHtml}\n                <div class=\"item-title\">\n                    <div class=\"item-name\">${escapeHtml(item.name)}</div>\n                    ${generateTierLabel(item.tier)}\n                </div>\n                ${compareCheckboxHtml}\n            </div>\n            <div class=\"item-effect\">${escapeHtml(item.base_effect)}</div>\n            <div class=\"item-description ${needsExpand ? 'expandable-text' : ''}\"\n                 ${needsExpand ? `data-full-text=\"${escapeHtml(fullText)}\" data-truncated=\"true\"` : ''}>\n                ${descHtml}\n                ${needsExpand ? '<span class=\"expand-indicator\">Click to expand</span>' : ''}\n            </div>\n            <div class=\"item-meta\">\n                <span class=\"meta-tag ${stackClass}\">${stackText}</span>\n            </div>\n            ${graphHtml}\n        `;\n\n        fragment.appendChild(card);\n    });\n\n    // Single DOM operation - clear and append atomically to avoid flash\n    container.innerHTML = '';\n    container.appendChild(fragment);\n\n    // Initialize charts after DOM is painted\n    initChartsAsync('initializeItemCharts', 'item_tab_render');\n}\n","// ========================================\n// Tome Renderer\n// ========================================\n\nimport {\n    generateEntityImage,\n    escapeHtml,\n    safeGetElementById,\n} from '../utils.ts';\nimport { initChartsAsync } from './common.ts';\nimport { detectEmptyStateType, generateEmptyStateWithSuggestions } from '../empty-states.ts';\nimport type { Tome } from './types.ts';\n\n/**\n * Render tomes grid\n * Uses DocumentFragment for batch DOM updates to prevent layout thrashing\n * @param {Array} tomes - Tomes to render\n */\nexport function renderTomes(tomes: Tome[]): void {\n    const container = safeGetElementById('tomesContainer');\n    if (!container) return;\n\n    if (tomes.length === 0) {\n        const context = detectEmptyStateType('tomes');\n        container.innerHTML = generateEmptyStateWithSuggestions(context);\n        return;\n    }\n\n    // Use DocumentFragment to batch all DOM operations\n    const fragment = document.createDocumentFragment();\n\n    tomes.forEach(tome => {\n        const card = document.createElement('div');\n        card.className = 'item-card tome-card clickable-card';\n        card.tabIndex = 0;\n        card.dataset.entityType = 'tome';\n        card.dataset.entityId = tome.id;\n\n        const imageHtml = generateEntityImage(tome, tome.name);\n        // DISABLED: Favorites feature UI hidden (module kept for data persistence)\n        // const isFav = typeof isFavorite === 'function' ? isFavorite('tomes', tome.id) : false;\n\n        // Check if tome has valid progression data (numeric value in value_per_level)\n        const valueStr = typeof tome.value_per_level === 'number' ? String(tome.value_per_level) : tome.value_per_level;\n        const hasProgression = valueStr && /[+-]?[\\d.]+/.test(valueStr);\n        const graphHtml = hasProgression\n            ? `\n            <div class=\"tome-graph-container\">\n                <canvas id=\"tome-chart-${tome.id}\" class=\"scaling-chart\"></canvas>\n            </div>\n        `\n            : `\n            <div class=\"tome-graph-placeholder\">\n                <span>No progression data available</span>\n            </div>\n        `;\n\n        card.innerHTML = `\n            <div class=\"item-header\">\n                ${imageHtml}\n                <div class=\"item-title\">\n                    <div class=\"item-name\">${escapeHtml(tome.name)}</div>\n                    <span class=\"tier-label\">${tome.tier} Tier  Priority ${tome.priority}</span>\n                </div>\n                <!-- DISABLED: Favorite button hidden\n                <button class=\"favorite-btn\" data-tab=\"tomes\" data-id=\"${tome.id}\" title=\"Add to favorites\" aria-label=\"Add to favorites\">\n                    \n                </button>\n                -->\n            </div>\n            <div class=\"item-effect\">${escapeHtml(tome.stat_affected)}: ${escapeHtml(String(tome.value_per_level))}</div>\n            <div class=\"item-description\">${escapeHtml(tome.description)}</div>\n            ${graphHtml}\n        `;\n\n        fragment.appendChild(card);\n    });\n\n    // Single DOM operation - clear and append atomically to avoid flash\n    container.innerHTML = '';\n    container.appendChild(fragment);\n\n    // Initialize charts after DOM is painted\n    initChartsAsync('initializeTomeCharts', 'tome_tab_render');\n}\n","// ========================================\n// Character Renderer\n// ========================================\n\nimport {\n    generateEntityImage,\n    generateTierLabel,\n    escapeHtml,\n    safeGetElementById,\n} from '../utils.ts';\nimport { detectEmptyStateType, generateEmptyStateWithSuggestions } from '../empty-states.ts';\nimport type { Character } from './types.ts';\n\n/**\n * Render characters grid\n * Uses DocumentFragment for batch DOM updates to prevent layout thrashing\n * @param {Array} characters - Characters to render\n */\nexport function renderCharacters(characters: Character[]): void {\n    const container = safeGetElementById('charactersContainer');\n    if (!container) return;\n\n    if (characters.length === 0) {\n        const context = detectEmptyStateType('characters');\n        container.innerHTML = generateEmptyStateWithSuggestions(context);\n        return;\n    }\n\n    // Use DocumentFragment to batch all DOM operations\n    const fragment = document.createDocumentFragment();\n\n    characters.forEach(char => {\n        const card = document.createElement('div');\n        card.className = 'item-card character-card clickable-card';\n        card.tabIndex = 0;\n        card.dataset.entityType = 'character';\n        card.dataset.entityId = char.id;\n\n        const imageHtml = generateEntityImage(char, char.name);\n        // DISABLED: Favorites feature UI hidden (module kept for data persistence)\n        // const isFav = typeof isFavorite === 'function' ? isFavorite('characters', char.id) : false;\n\n        card.innerHTML = `\n            <div class=\"item-header\">\n                ${imageHtml}\n                <div class=\"item-title\">\n                    <div class=\"item-name\">${escapeHtml(char.name)}</div>\n                    ${generateTierLabel(char.tier)}\n                </div>\n                <!-- DISABLED: Favorite button hidden\n                <button class=\"favorite-btn\" data-tab=\"characters\" data-id=\"${char.id}\" title=\"Add to favorites\" aria-label=\"Add to favorites\">\n                    \n                </button>\n                -->\n            </div>\n            <div class=\"item-effect\">${escapeHtml(char.passive_ability)}</div>\n            <div class=\"item-description\">${escapeHtml(char.passive_description)}</div>\n            <div class=\"item-meta\">\n                <span class=\"meta-tag\">${escapeHtml(char.starting_weapon)}</span>\n                <span class=\"meta-tag\">${escapeHtml(char.playstyle)}</span>\n            </div>\n        `;\n\n        fragment.appendChild(card);\n    });\n\n    // Single DOM operation - clear and append atomically to avoid flash\n    container.innerHTML = '';\n    container.appendChild(fragment);\n}\n","// ========================================\n// Shrine Renderer\n// ========================================\n\nimport {\n    escapeHtml,\n    safeGetElementById,\n} from '../utils.ts';\nimport { detectEmptyStateType, generateEmptyStateWithSuggestions } from '../empty-states.ts';\nimport type { Shrine } from './types.ts';\n\n/**\n * Render shrines grid\n * Uses DocumentFragment for batch DOM updates to prevent layout thrashing\n * @param {Array} shrines - Shrines to render\n */\nexport function renderShrines(shrines: Shrine[]): void {\n    const container = safeGetElementById('shrinesContainer');\n    if (!container) return;\n\n    if (shrines.length === 0) {\n        const context = detectEmptyStateType('shrines');\n        container.innerHTML = generateEmptyStateWithSuggestions(context);\n        return;\n    }\n\n    // Use DocumentFragment to batch all DOM operations\n    const fragment = document.createDocumentFragment();\n\n    shrines.forEach(shrine => {\n        const card = document.createElement('div');\n        card.className = 'item-card shrine-card clickable-card';\n        card.tabIndex = 0;\n        card.dataset.entityType = 'shrine';\n        card.dataset.entityId = shrine.id;\n\n        // DISABLED: Favorites feature UI hidden (module kept for data persistence)\n        // const isFav = typeof isFavorite === 'function' ? isFavorite('shrines', shrine.id) : false;\n\n        card.innerHTML = `\n            <div class=\"item-header\">\n                <span class=\"shrine-icon-large\">${escapeHtml(shrine.icon || '')}</span>\n                <div class=\"item-title\">\n                    <div class=\"item-name\">${escapeHtml(shrine.name)}</div>\n                    ${shrine.type ? `<span class=\"tier-label\">${escapeHtml(shrine.type.replace('_', ' '))}</span>` : ''}\n                </div>\n                <!-- DISABLED: Favorite button hidden\n                <button class=\"favorite-btn\" data-tab=\"shrines\" data-id=\"${escapeHtml(shrine.id)}\" title=\"Add to favorites\" aria-label=\"Add to favorites\">\n                    \n                </button>\n                -->\n            </div>\n            <div class=\"item-effect\">${escapeHtml(shrine.description)}</div>\n            <div class=\"item-description\">${shrine.reward ? escapeHtml(shrine.reward) : ''}</div>\n            <div class=\"item-meta\">\n                ${shrine.reusable !== undefined ? (shrine.reusable ? '<span class=\"meta-tag\">Reusable</span>' : '<span class=\"meta-tag\">One-time</span>') : ''}\n            </div>\n        `;\n\n        fragment.appendChild(card);\n    });\n\n    // Single DOM operation - clear and append atomically to avoid flash\n    container.innerHTML = '';\n    container.appendChild(fragment);\n}\n","// ========================================\n// MegaBonk Skeleton Loader Module\n// ========================================\n// Provides skeleton loading states for improved perceived performance\n// Skeletons match the actual card layouts for seamless transitions\n\nimport { safeGetElementById } from './utils.ts';\n\n// ========================================\n// Constants\n// ========================================\n\nconst DEFAULT_SKELETON_COUNT = 6;\n\n// ========================================\n// Skeleton Templates\n// ========================================\n\n/**\n * Generate a skeleton card for items/weapons/tomes (with optional graph)\n * Matches the .item-card layout from cards.css\n */\nfunction generateItemSkeletonCard(includeGraph: boolean = false): string {\n    const graphHtml = includeGraph\n        ? `<div class=\"skeleton-graph\">\n               <div class=\"skeleton-element\" style=\"height: 150px; margin-top: 1rem; border-radius: 6px;\"></div>\n           </div>`\n        : '';\n\n    return `\n        <div class=\"skeleton-card skeleton-card--item\">\n            <!-- Header: image + title area -->\n            <div class=\"skeleton-header\">\n                <div class=\"skeleton-element skeleton-image\"></div>\n                <div class=\"skeleton-title\">\n                    <div class=\"skeleton-element skeleton-name\"></div>\n                    <div class=\"skeleton-badges\">\n                        <div class=\"skeleton-element skeleton-badge\"></div>\n                        <div class=\"skeleton-element skeleton-badge skeleton-badge--small\"></div>\n                    </div>\n                </div>\n            </div>\n            \n            <!-- Effect text (main content) -->\n            <div class=\"skeleton-element skeleton-text skeleton-effect\"></div>\n            <div class=\"skeleton-element skeleton-text skeleton-effect short\"></div>\n            \n            <!-- Description -->\n            <div class=\"skeleton-element skeleton-text skeleton-description\"></div>\n            \n            <!-- Meta tags -->\n            <div class=\"skeleton-meta\">\n                <div class=\"skeleton-element skeleton-tag\"></div>\n                <div class=\"skeleton-element skeleton-tag\"></div>\n                <div class=\"skeleton-element skeleton-tag skeleton-tag--small\"></div>\n            </div>\n            \n            ${graphHtml}\n            \n            <!-- View details button -->\n            <div class=\"skeleton-element skeleton-button\"></div>\n        </div>\n    `;\n}\n\n/**\n * Generate a skeleton card for characters\n * Characters have a different layout with stats display\n */\nfunction generateCharacterSkeletonCard(): string {\n    return `\n        <div class=\"skeleton-card skeleton-card--character\">\n            <!-- Header with larger image -->\n            <div class=\"skeleton-header\">\n                <div class=\"skeleton-element skeleton-image skeleton-image--large\"></div>\n                <div class=\"skeleton-title\">\n                    <div class=\"skeleton-element skeleton-name\"></div>\n                    <div class=\"skeleton-element skeleton-subtitle\"></div>\n                </div>\n            </div>\n            \n            <!-- Stats grid -->\n            <div class=\"skeleton-stats\">\n                <div class=\"skeleton-stat-row\">\n                    <div class=\"skeleton-element skeleton-stat-label\"></div>\n                    <div class=\"skeleton-element skeleton-stat-value\"></div>\n                </div>\n                <div class=\"skeleton-stat-row\">\n                    <div class=\"skeleton-element skeleton-stat-label\"></div>\n                    <div class=\"skeleton-element skeleton-stat-value\"></div>\n                </div>\n                <div class=\"skeleton-stat-row\">\n                    <div class=\"skeleton-element skeleton-stat-label\"></div>\n                    <div class=\"skeleton-element skeleton-stat-value\"></div>\n                </div>\n            </div>\n            \n            <!-- Description -->\n            <div class=\"skeleton-element skeleton-text\"></div>\n            \n            <!-- Button -->\n            <div class=\"skeleton-element skeleton-button\"></div>\n        </div>\n    `;\n}\n\n/**\n * Generate a skeleton card for shrines\n * Shrines have a simpler layout\n */\nfunction generateShrineSkeletonCard(): string {\n    return `\n        <div class=\"skeleton-card skeleton-card--shrine\">\n            <!-- Header -->\n            <div class=\"skeleton-header skeleton-header--centered\">\n                <div class=\"skeleton-element skeleton-image skeleton-image--shrine\"></div>\n                <div class=\"skeleton-element skeleton-name skeleton-name--centered\"></div>\n            </div>\n            \n            <!-- Effect description -->\n            <div class=\"skeleton-element skeleton-text\"></div>\n            <div class=\"skeleton-element skeleton-text short\"></div>\n            \n            <!-- Button -->\n            <div class=\"skeleton-element skeleton-button\"></div>\n        </div>\n    `;\n}\n\n/**\n * Generate a skeleton card for weapons\n * Weapons show upgrade paths and different stats\n */\nfunction generateWeaponSkeletonCard(): string {\n    return `\n        <div class=\"skeleton-card skeleton-card--weapon\">\n            <!-- Header -->\n            <div class=\"skeleton-header\">\n                <div class=\"skeleton-element skeleton-image\"></div>\n                <div class=\"skeleton-title\">\n                    <div class=\"skeleton-element skeleton-name\"></div>\n                    <div class=\"skeleton-badges\">\n                        <div class=\"skeleton-element skeleton-badge\"></div>\n                    </div>\n                </div>\n            </div>\n            \n            <!-- Weapon stats -->\n            <div class=\"skeleton-weapon-stats\">\n                <div class=\"skeleton-element skeleton-stat-bar\"></div>\n                <div class=\"skeleton-element skeleton-stat-bar skeleton-stat-bar--short\"></div>\n            </div>\n            \n            <!-- Description -->\n            <div class=\"skeleton-element skeleton-text\"></div>\n            <div class=\"skeleton-element skeleton-text short\"></div>\n            \n            <!-- Meta tags -->\n            <div class=\"skeleton-meta\">\n                <div class=\"skeleton-element skeleton-tag\"></div>\n                <div class=\"skeleton-element skeleton-tag\"></div>\n            </div>\n            \n            <!-- Button -->\n            <div class=\"skeleton-element skeleton-button\"></div>\n        </div>\n    `;\n}\n\n/**\n * Get skeleton generator for a specific tab\n */\nfunction getSkeletonGenerator(tabName: string): () => string {\n    switch (tabName) {\n        case 'items':\n            return () => generateItemSkeletonCard(true);\n        case 'weapons':\n            return generateWeaponSkeletonCard;\n        case 'tomes':\n            return () => generateItemSkeletonCard(true);\n        case 'characters':\n            return generateCharacterSkeletonCard;\n        case 'shrines':\n            return generateShrineSkeletonCard;\n        default:\n            return () => generateItemSkeletonCard(false);\n    }\n}\n\n// ========================================\n// Skeleton Management\n// ========================================\n\n/**\n * Show skeleton loading state in a container\n * @param containerId - ID of the container element\n * @param count - Number of skeleton cards to show\n * @param includeGraphs - Whether skeletons should include graph placeholders (deprecated, use tabName)\n */\nexport function showSkeletonLoading(\n    containerId: string,\n    count: number = DEFAULT_SKELETON_COUNT,\n    includeGraphs: boolean = false\n): void {\n    const container = safeGetElementById(containerId);\n    if (!container) return;\n\n    // Store original content (if needed for restoration)\n    container.dataset.hadContent = container.innerHTML.length > 0 ? 'true' : 'false';\n\n    // Use the includeGraphs parameter for backwards compatibility\n    const generateCard = () => generateItemSkeletonCard(includeGraphs);\n\n    // Generate skeleton cards\n    const skeletons = Array(count)\n        .fill(null)\n        .map(() => generateCard())\n        .join('');\n\n    container.innerHTML = `<div class=\"skeleton-container\">${skeletons}</div>`;\n    container.setAttribute('aria-busy', 'true');\n    container.setAttribute('aria-label', 'Loading content');\n}\n\n/**\n * Show skeleton loading state with tab-specific cards\n * @param containerId - ID of the container element\n * @param tabName - Name of the tab to generate appropriate skeletons\n * @param count - Number of skeleton cards to show\n */\nexport function showTabSkeletonLoading(\n    containerId: string,\n    tabName: string,\n    count: number = DEFAULT_SKELETON_COUNT\n): void {\n    const container = safeGetElementById(containerId);\n    if (!container) return;\n\n    container.dataset.hadContent = container.innerHTML.length > 0 ? 'true' : 'false';\n\n    const generateCard = getSkeletonGenerator(tabName);\n\n    const skeletons = Array(count)\n        .fill(null)\n        .map(() => generateCard())\n        .join('');\n\n    container.innerHTML = `<div class=\"skeleton-container\">${skeletons}</div>`;\n    container.setAttribute('aria-busy', 'true');\n    container.setAttribute('aria-label', 'Loading content');\n}\n\n/**\n * Hide skeleton loading state\n * @param containerId - ID of the container element\n */\nexport function hideSkeletonLoading(containerId: string): void {\n    const container = safeGetElementById(containerId);\n    if (!container) return;\n\n    // Find and remove skeleton container if present\n    const skeletonContainer = container.querySelector('.skeleton-container');\n    if (skeletonContainer) {\n        skeletonContainer.remove();\n    }\n\n    container.removeAttribute('aria-busy');\n    container.removeAttribute('aria-label');\n}\n\n/**\n * Check if a container is showing skeleton loading\n * @param containerId - ID of the container element\n * @returns True if skeleton is showing\n */\nexport function isShowingSkeleton(containerId: string): boolean {\n    const container = safeGetElementById(containerId);\n    if (!container) return false;\n\n    return container.querySelector('.skeleton-container') !== null;\n}\n\n/**\n * Show skeleton loading for the current tab\n * Uses tab-specific skeleton layouts\n * @param tabName - Name of the tab\n */\nexport function showTabSkeleton(tabName: string): void {\n    const containerMap: Record<string, { id: string; count: number }> = {\n        items: { id: 'itemsContainer', count: 8 },\n        weapons: { id: 'weaponsContainer', count: 6 },\n        tomes: { id: 'tomesContainer', count: 6 },\n        characters: { id: 'charactersContainer', count: 6 },\n        shrines: { id: 'shrinesContainer', count: 4 },\n    };\n\n    const config = containerMap[tabName];\n    if (config) {\n        showTabSkeletonLoading(config.id, tabName, config.count);\n    }\n}\n\n/**\n * Hide skeleton loading for the current tab\n * @param tabName - Name of the tab\n */\nexport function hideTabSkeleton(tabName: string): void {\n    const containerMap: Record<string, string> = {\n        items: 'itemsContainer',\n        weapons: 'weaponsContainer',\n        tomes: 'tomesContainer',\n        characters: 'charactersContainer',\n        shrines: 'shrinesContainer',\n    };\n\n    const containerId = containerMap[tabName];\n    if (containerId) {\n        hideSkeletonLoading(containerId);\n    }\n}\n\n// ========================================\n// Global Scope Exports (backwards compatibility)\n// ========================================\n\nif (typeof window !== 'undefined') {\n    Object.assign(window, {\n        showSkeletonLoading,\n        showTabSkeletonLoading,\n        hideSkeletonLoading,\n        showTabSkeleton,\n        hideTabSkeleton,\n    });\n}\n","// ========================================\n// MegaBonk Tab Loader Module\n// ========================================\n// Handles lazy loading of tab-specific modules for code splitting\n// This reduces initial bundle size by deferring heavy modules\n\nimport { logger } from './logger.ts';\nimport type { TabName } from './store.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Module cache entry\n */\ninterface ModuleCache {\n    loaded: boolean;\n    loading: Promise<void> | null;\n    error: Error | null;\n}\n\n/**\n * Tab module loaders map\n */\ntype TabModuleLoader = () => Promise<void>;\n\n// ========================================\n// Module Cache\n// ========================================\n\n// Cache to track loaded modules and prevent duplicate imports\nconst moduleCache: Map<string, ModuleCache> = new Map();\n\n// ========================================\n// Tab-Specific Module Loaders\n// ========================================\n\n/**\n * Lazy load the build planner module\n */\nasync function loadBuildPlannerModule(): Promise<void> {\n    await import('./build-planner.ts');\n    logger.debug({\n        operation: 'tab_loader.loaded',\n        data: { module: 'build-planner' },\n    });\n}\n\n/**\n * Lazy load the calculator module\n */\nasync function loadCalculatorModule(): Promise<void> {\n    await import('./calculator.ts');\n    logger.debug({\n        operation: 'tab_loader.loaded',\n        data: { module: 'calculator' },\n    });\n}\n\n/**\n * Lazy load the advisor module and its dependencies\n */\nasync function loadAdvisorModule(): Promise<void> {\n    // Load scan-build first as advisor may depend on it\n    await import('./scan-build.ts');\n    await import('./advisor.ts');\n    \n    // Initialize scan-build with already-loaded game data\n    // This is needed because data-service.ts loads before scan-build.ts (lazy-loaded)\n    const { getState } = await import('./store.ts');\n    const allData = getState('allData');\n    const windowWithScanBuild = window as Window & { initScanBuild?: (data: unknown) => void };\n    if (typeof windowWithScanBuild.initScanBuild === 'function' && allData && Object.keys(allData).length > 0) {\n        windowWithScanBuild.initScanBuild(allData);\n    }\n    \n    logger.debug({\n        operation: 'tab_loader.loaded',\n        data: { module: 'advisor' },\n    });\n}\n\n/**\n * Lazy load the changelog module\n */\nasync function loadChangelogModule(): Promise<void> {\n    await import('./changelog.ts');\n    logger.debug({\n        operation: 'tab_loader.loaded',\n        data: { module: 'changelog' },\n    });\n}\n\n/**\n * Lazy load the compare module\n */\nasync function loadCompareModule(): Promise<void> {\n    await import('./compare.ts');\n    logger.debug({\n        operation: 'tab_loader.loaded',\n        data: { module: 'compare' },\n    });\n}\n\n/**\n * Lazy load the charts module\n */\nasync function loadChartsModule(): Promise<void> {\n    await import('./charts.ts');\n    logger.debug({\n        operation: 'tab_loader.loaded',\n        data: { module: 'charts' },\n    });\n}\n\n// ========================================\n// Tab to Module Mapping\n// ========================================\n\n/**\n * Map of tabs to their required module loaders\n * Tabs not in this map use only core modules (already loaded)\n */\nconst TAB_MODULES: Partial<Record<TabName, TabModuleLoader[]>> = {\n    'build-planner': [loadBuildPlannerModule],\n    calculator: [loadCalculatorModule],\n    advisor: [loadAdvisorModule],\n    changelog: [loadChangelogModule],\n    // Items and tomes need charts for scaling graphs\n    items: [loadChartsModule, loadCompareModule],\n    tomes: [loadChartsModule],\n};\n\n// ========================================\n// Core API\n// ========================================\n\n/**\n * Load modules required for a specific tab\n * Uses caching to prevent duplicate loads\n * @param tabName - The tab to load modules for\n * @returns Promise that resolves when all modules are loaded\n */\nexport async function loadTabModules(tabName: TabName): Promise<void> {\n    const loaders = TAB_MODULES[tabName];\n\n    // No special modules needed for this tab\n    if (!loaders || loaders.length === 0) {\n        return;\n    }\n\n    const startTime = performance.now();\n\n    // Load all required modules in parallel\n    const loadPromises = loaders.map(loader => loadModuleWithCache(loader));\n\n    try {\n        await Promise.all(loadPromises);\n\n        const duration = Math.round(performance.now() - startTime);\n        if (duration > 50) {\n            logger.debug({\n                operation: 'tab_loader.complete',\n                durationMs: duration,\n                data: { tabName, moduleCount: loaders.length },\n            });\n        }\n    } catch (error) {\n        logger.error({\n            operation: 'tab_loader.error',\n            error: {\n                name: (error as Error).name,\n                message: (error as Error).message,\n                module: 'tab-loader',\n            },\n            data: { tabName },\n        });\n        throw error;\n    }\n}\n\n/**\n * Load a module with caching\n * Prevents duplicate loads and handles concurrent requests\n * @param loader - The module loader function\n * @returns Promise that resolves when module is loaded\n */\nasync function loadModuleWithCache(loader: TabModuleLoader): Promise<void> {\n    const key = loader.name || loader.toString().slice(0, 50);\n\n    // Check if already loaded\n    const cached = moduleCache.get(key);\n    if (cached?.loaded) {\n        return;\n    }\n\n    // Check if currently loading (handle concurrent requests)\n    if (cached?.loading) {\n        return cached.loading;\n    }\n\n    // Start loading\n    const loadingPromise = loader();\n    moduleCache.set(key, {\n        loaded: false,\n        loading: loadingPromise,\n        error: null,\n    });\n\n    try {\n        await loadingPromise;\n        moduleCache.set(key, {\n            loaded: true,\n            loading: null,\n            error: null,\n        });\n    } catch (error) {\n        moduleCache.set(key, {\n            loaded: false,\n            loading: null,\n            error: error as Error,\n        });\n        throw error;\n    }\n}\n\n/**\n * Preload modules for likely-to-be-visited tabs\n * Call this after initial render to warm the cache\n */\nexport function preloadCommonModules(): void {\n    // Use requestIdleCallback if available, otherwise setTimeout\n    const schedulePreload =\n        typeof requestIdleCallback !== 'undefined' ? requestIdleCallback : (cb: () => void) => setTimeout(cb, 1000);\n\n    schedulePreload(() => {\n        // Preload compare module (often used from items tab)\n        loadModuleWithCache(loadCompareModule).catch(() => {\n            // Silently ignore preload failures\n        });\n    });\n}\n\n/**\n * Check if a module is already loaded\n * @param moduleName - Name of the module to check\n * @returns True if module is loaded\n */\nexport function isModuleLoaded(moduleName: string): boolean {\n    const cached = moduleCache.get(moduleName);\n    return cached?.loaded ?? false;\n}\n\n/**\n * Clear the module cache (useful for testing)\n */\nexport function clearModuleCache(): void {\n    moduleCache.clear();\n}\n\n/**\n * Get the list of modules required for a tab\n * @param tabName - The tab name\n * @returns Array of module names (for debugging)\n */\nexport function getTabModules(tabName: TabName): string[] {\n    const loaders = TAB_MODULES[tabName];\n    if (!loaders) return [];\n    return loaders.map(l => l.name || 'anonymous');\n}\n","// ========================================\n// Tab Management Module\n// Tab switching, loading, and persistence\n// ========================================\n\nimport { logger } from './logger.ts';\nimport { saveFilterState, updateFilters, restoreFilterState } from './filters.ts';\nimport { renderTabContent } from './renderers.ts';\nimport { getState, setState, type TabName } from './store.ts';\nimport { registerFunction } from './registry.ts';\nimport { showTabSkeleton } from './skeleton-loader.ts';\nimport { loadTabModules, preloadCommonModules } from './tab-loader.ts';\n\n// LocalStorage key for persisting tab selection\nconst TAB_STORAGE_KEY = 'megabonk-current-tab';\n\n// Valid tab names for validation\nexport const VALID_TABS: TabName[] = [\n    'items',\n    'weapons',\n    'tomes',\n    'characters',\n    'shrines',\n    'build-planner',\n    'calculator',\n    'advisor',\n    'changelog',\n    'about',\n];\n\n// Track tab switch timing to prevent rapid switching issues\nlet lastTabSwitchTime = 0;\nconst TAB_SWITCH_DEBOUNCE_MS = 100;\n\n// Lock to prevent concurrent tab switches (race condition fix)\nlet tabSwitchInProgress = false;\n\n// Current tab state - kept for backwards compatibility\nexport let currentTab: TabName = getState('currentTab');\n\n/**\n * Reset internal timers for testing purposes\n * @internal\n */\nexport function __resetTimersForTesting(): void {\n    lastTabSwitchTime = 0;\n    tabSwitchInProgress = false;\n}\n\n/**\n * Get the current tab (backwards compatibility)\n */\nexport function getCurrentTab(): TabName {\n    return getState('currentTab');\n}\n\n/**\n * Check if tab switch should proceed (validation and debouncing)\n * @returns true if switch should proceed, false otherwise\n */\nfunction shouldProceedWithTabSwitch(tabName: TabName): boolean {\n    // Runtime validation\n    if (!VALID_TABS.includes(tabName)) {\n        logger.warn({\n            operation: 'tab.switch',\n            error: { name: 'InvalidTabError', message: `Invalid tab name: ${tabName}` },\n        });\n        return false;\n    }\n\n    // Debounce rapid switches\n    const now = Date.now();\n    if (now - lastTabSwitchTime < TAB_SWITCH_DEBOUNCE_MS) {\n        return false;\n    }\n\n    // Prevent concurrent switches\n    if (tabSwitchInProgress) {\n        logger.info({\n            operation: 'tab.switch.skipped',\n            data: { reason: 'switch_in_progress', requestedTab: tabName },\n        });\n        return false;\n    }\n\n    return true;\n}\n\n/**\n * Check if this is the initial render (no content rendered yet)\n */\nfunction isInitialTabRender(): boolean {\n    return !document.querySelector('#itemsContainer .item-card') &&\n           !document.querySelector('#weaponsContainer .item-card') &&\n           !document.querySelector('#tomesContainer .item-card');\n}\n\n/**\n * Save current tab state and destroy charts\n */\nasync function cleanupPreviousTab(previousTab: TabName): Promise<void> {\n    if (previousTab && typeof saveFilterState === 'function') {\n        saveFilterState(previousTab);\n    }\n\n    try {\n        const { destroyAllCharts } = await import('./charts.ts');\n        destroyAllCharts();\n    } catch {\n        // Charts module may not be loaded yet, that's fine\n    }\n}\n\n/**\n * Update global state for the new tab\n */\nfunction updateTabState(tabName: TabName, previousTab: TabName): void {\n    setState('currentTab', tabName);\n    currentTab = tabName;\n    localStorage.setItem(TAB_STORAGE_KEY, tabName);\n    logger.setContext('currentTab', tabName);\n\n    // Get item count for logging\n    let itemCount = 0;\n    if (typeof allData !== 'undefined' && allData) {\n        const tabDataMap: Record<string, unknown[] | undefined> = {\n            items: allData.items?.items,\n            weapons: allData.weapons?.weapons,\n            tomes: allData.tomes?.tomes,\n            characters: allData.characters?.characters,\n            shrines: allData.shrines?.shrines,\n        };\n        const tabData = tabDataMap[tabName];\n        if (Array.isArray(tabData)) {\n            itemCount = tabData.length;\n        }\n    }\n\n    logger.info({\n        operation: 'tab.switch',\n        data: { fromTab: previousTab, toTab: tabName, itemCount },\n    });\n}\n\n/**\n * Update UI elements for the new tab\n */\nfunction updateTabUI(tabName: TabName): void {\n    // Update tab buttons\n    document.querySelectorAll<HTMLButtonElement>('.tab-btn').forEach(btn => {\n        const isActive = btn.getAttribute('data-tab') === tabName;\n        btn.classList.toggle('active', isActive);\n        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');\n    });\n\n    // Update tab content visibility\n    document.querySelectorAll<HTMLElement>('.tab-content').forEach(content => {\n        content.classList.remove('active');\n    });\n    const tabContent = document.getElementById(`${tabName}-tab`) as HTMLElement | null;\n    if (tabContent) {\n        tabContent.classList.add('active');\n    }\n\n    // Update filters\n    updateFilters(tabName);\n    restoreFilterState(tabName);\n}\n\n/**\n * Load modules and render content for the tab\n */\nasync function loadAndRenderTab(tabName: TabName): Promise<void> {\n    showTabSkeleton(tabName);\n\n    try {\n        await loadTabModules(tabName);\n    } catch (error) {\n        logger.error({\n            operation: 'tab.module_load_failed',\n            error: {\n                name: (error as Error).name,\n                message: (error as Error).message,\n                module: 'events-tabs',\n            },\n            data: { tabName },\n        });\n    }\n\n    await renderTabContent(tabName);\n}\n\n/**\n * Switch to a different tab\n * Loads tab-specific modules lazily for better initial load performance\n * @param {string} tabName - Tab name to switch to\n */\nexport async function switchTab(tabName: TabName): Promise<void> {\n    if (!shouldProceedWithTabSwitch(tabName)) {\n        return;\n    }\n\n    tabSwitchInProgress = true;\n    lastTabSwitchTime = Date.now();\n\n    try {\n        const previousTab = getState('currentTab');\n\n        // Skip if already on this tab (unless initial render)\n        if (previousTab === tabName && !isInitialTabRender()) {\n            return;\n        }\n\n        await cleanupPreviousTab(previousTab);\n        updateTabState(tabName, previousTab);\n        updateTabUI(tabName);\n        await loadAndRenderTab(tabName);\n    } finally {\n        tabSwitchInProgress = false;\n    }\n}\n\n/**\n * Preload modules for common tabs after initial render\n * Call this after the app has initialized\n */\nexport function scheduleModulePreload(): void {\n    // Use requestIdleCallback if available for non-blocking preload\n    if (typeof requestIdleCallback !== 'undefined') {\n        requestIdleCallback(() => preloadCommonModules());\n    } else {\n        setTimeout(preloadCommonModules, 2000);\n    }\n}\n\n/**\n * Get the saved tab from localStorage\n * Returns the saved tab if valid, otherwise defaults to 'items'\n * @returns Valid tab name\n */\nexport function getSavedTab(): TabName {\n    const saved = localStorage.getItem(TAB_STORAGE_KEY);\n    if (saved && VALID_TABS.includes(saved as TabName)) {\n        return saved as TabName;\n    }\n    return 'items'; // Default fallback\n}\n\n// ========================================\n// Registry & Global Assignments\n// ========================================\n// Register switchTab for type-safe cross-module access\nregisterFunction('switchTab', switchTab);\n\n// Keep window assignment for backwards compatibility during migration\nif (typeof window !== 'undefined') {\n    // Type assertion: switchTab accepts TabName but window type uses string for flexibility\n    window.switchTab = switchTab as typeof window.switchTab;\n}\n","// ========================================\n// Recently Viewed Module\n// ========================================\n// Tracks and displays recently viewed items/entities\n// ========================================\n\nimport { allData } from './data-service.ts';\nimport { logger } from './logger.ts';\nimport { escapeHtml, generateEntityImage } from './utils.ts';\nimport { MAX_RECENT_ITEMS } from './constants.ts';\nimport type { EntityType, Entity } from '../types/index.ts';\nimport type { Item, Weapon, Tome, Character, Shrine } from '../types/index.ts';\n\n// ========================================\n// Types\n// ========================================\n\ninterface RecentlyViewedEntry {\n    type: EntityType;\n    id: string;\n    timestamp: number;\n}\n\n// ========================================\n// Constants\n// ========================================\n\nconst STORAGE_KEY = 'megabonk-recently-viewed';\n// MAX_RECENT_ITEMS imported from constants.ts\nconst TABS_WITH_RECENT: EntityType[] = ['items', 'weapons', 'tomes', 'characters', 'shrines'];\n\n// ========================================\n// State\n// ========================================\n\nlet recentlyViewed: RecentlyViewedEntry[] = [];\n\n// ========================================\n// Storage Operations\n// ========================================\n\n/**\n * Load recently viewed items from localStorage\n */\nexport function loadRecentlyViewed(): void {\n    try {\n        const stored = localStorage.getItem(STORAGE_KEY);\n        if (stored) {\n            recentlyViewed = JSON.parse(stored);\n            // Clean up old entries (older than 7 days)\n            const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;\n            recentlyViewed = recentlyViewed.filter(entry => entry.timestamp > weekAgo);\n            saveRecentlyViewed();\n        }\n    } catch (error) {\n        logger.warn({\n            operation: 'recently-viewed.load',\n            error: { name: 'StorageError', message: 'Failed to load recently viewed', module: 'recently-viewed' },\n        });\n        recentlyViewed = [];\n    }\n}\n\n/**\n * Save recently viewed items to localStorage\n */\nfunction saveRecentlyViewed(): void {\n    try {\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(recentlyViewed));\n    } catch (error) {\n        logger.warn({\n            operation: 'recently-viewed.save',\n            error: { name: 'StorageError', message: 'Failed to save recently viewed', module: 'recently-viewed' },\n        });\n    }\n}\n\n// ========================================\n// Core Functions\n// ========================================\n\n/**\n * Add an item to recently viewed\n */\nexport function addToRecentlyViewed(type: EntityType, id: string): void {\n    if (!TABS_WITH_RECENT.includes(type)) return;\n\n    // Remove existing entry for this item if present\n    recentlyViewed = recentlyViewed.filter(entry => !(entry.type === type && entry.id === id));\n\n    // Add new entry at the beginning\n    recentlyViewed.unshift({\n        type,\n        id,\n        timestamp: Date.now(),\n    });\n\n    // Keep only MAX_RECENT_ITEMS\n    if (recentlyViewed.length > MAX_RECENT_ITEMS) {\n        recentlyViewed = recentlyViewed.slice(0, MAX_RECENT_ITEMS);\n    }\n\n    saveRecentlyViewed();\n}\n\n/**\n * Get recently viewed items\n */\nexport function getRecentlyViewed(): RecentlyViewedEntry[] {\n    return [...recentlyViewed];\n}\n\n/**\n * Get recently viewed items for a specific tab\n */\nexport function getRecentlyViewedForTab(type: EntityType): RecentlyViewedEntry[] {\n    return recentlyViewed.filter(entry => entry.type === type);\n}\n\n/**\n * Clear all recently viewed items\n */\nexport function clearRecentlyViewed(): void {\n    recentlyViewed = [];\n    saveRecentlyViewed();\n}\n\n/**\n * Get entity data for a recently viewed entry\n * Returns null if entity not found or data not loaded\n */\nexport function getEntityForEntry(entry: RecentlyViewedEntry): Entity | null {\n    const { type, id } = entry;\n\n    // Helper to safely find and return entity\n    const findEntity = <T extends Entity>(\n        collection: T[] | undefined,\n        predicate: (item: T) => boolean\n    ): Entity | null => {\n        if (!collection) return null;\n        const found = collection.find(predicate);\n        return found ?? null;\n    };\n\n    switch (type) {\n        case 'items':\n            return findEntity(allData.items?.items as Item[] | undefined, (i: Item) => i.id === id);\n        case 'weapons':\n            return findEntity(allData.weapons?.weapons as Weapon[] | undefined, (w: Weapon) => w.id === id);\n        case 'tomes':\n            return findEntity(allData.tomes?.tomes as Tome[] | undefined, (t: Tome) => t.id === id);\n        case 'characters':\n            return findEntity(allData.characters?.characters as Character[] | undefined, (c: Character) => c.id === id);\n        case 'shrines':\n            return findEntity(allData.shrines?.shrines as Shrine[] | undefined, (s: Shrine) => s.id === id);\n        default:\n            return null;\n    }\n}\n\n// ========================================\n// UI Rendering\n// ========================================\n\n/**\n * Render the recently viewed section\n */\nexport function renderRecentlyViewedSection(containerSelector: string = '#tab-content'): void {\n    // Remove existing section if present\n    const existingSection = document.querySelector('.recently-viewed-section');\n    if (existingSection) {\n        existingSection.remove();\n    }\n\n    // Get all recent items (not tab-specific)\n    const recent = getRecentlyViewed();\n    if (recent.length === 0) return;\n\n    // Get entity data for each entry\n    const recentWithData = recent\n        .map(entry => ({\n            entry,\n            entity: getEntityForEntry(entry),\n        }))\n        .filter(item => item.entity !== null);\n\n    if (recentWithData.length === 0) return;\n\n    // Create section HTML\n    const section = document.createElement('div');\n    section.className = 'recently-viewed-section';\n    section.innerHTML = `\n        <div class=\"recently-viewed-header\">\n            <h3> Recently Viewed</h3>\n            <button class=\"clear-recent-btn\" aria-label=\"Clear recently viewed\">Clear</button>\n        </div>\n        <div class=\"recently-viewed-items\">\n            ${recentWithData\n                .map(({ entry, entity }) => {\n                    const name = entity?.name || 'Unknown';\n                    const imageHtml = entity ? generateEntityImage(entity, name, 'recent-image') : '';\n                    return `\n                    <div class=\"recent-item\" data-type=\"${entry.type}\" data-id=\"${entry.id}\" role=\"button\" tabindex=\"0\">\n                        ${imageHtml || '<span class=\"recent-icon\"></span>'}\n                        <span class=\"recent-name\">${escapeHtml(name)}</span>\n                    </div>\n                `;\n                })\n                .join('')}\n        </div>\n    `;\n\n    // Add event listeners\n    const clearBtn = section.querySelector('.clear-recent-btn');\n    clearBtn?.addEventListener('click', () => {\n        clearRecentlyViewed();\n        section.remove();\n    });\n\n    // Add click handlers for items\n    const items = section.querySelectorAll('.recent-item');\n    items.forEach(item => {\n        const handleClick = () => {\n            const type = (item as HTMLElement).dataset.type as EntityType;\n            const id = (item as HTMLElement).dataset.id;\n            if (type && id) {\n                // Trigger modal open\n                import('./modal.ts')\n                    .then(({ openDetailModal }) => {\n                        openDetailModal(type, id);\n                    })\n                    .catch(err => {\n                        logger.warn({\n                            operation: 'recently-viewed.open_modal',\n                            error: { name: 'ImportError', message: (err as Error).message, module: 'recently-viewed' },\n                        });\n                    });\n            }\n        };\n\n        item.addEventListener('click', handleClick);\n        item.addEventListener('keypress', e => {\n            if ((e as KeyboardEvent).key === 'Enter' || (e as KeyboardEvent).key === ' ') {\n                handleClick();\n            }\n        });\n    });\n\n    // Insert at the beginning of tab content\n    const container = document.querySelector(containerSelector);\n    if (container) {\n        const firstChild = container.firstElementChild;\n        if (firstChild) {\n            container.insertBefore(section, firstChild);\n        } else {\n            container.appendChild(section);\n        }\n    }\n}\n\n// ========================================\n// Integration Hook\n// ========================================\n\n/**\n * Hook to be called when a modal is opened\n * This integrates with the existing modal system\n */\nexport function onModalOpened(type: EntityType, id: string): void {\n    addToRecentlyViewed(type, id);\n}\n\n// ========================================\n// Initialization\n// ========================================\n\n/**\n * Initialize the recently viewed module\n */\nexport function initRecentlyViewed(): void {\n    loadRecentlyViewed();\n\n    logger.info({\n        operation: 'recently-viewed.init',\n        data: { count: recentlyViewed.length },\n    });\n}\n","// ========================================\n// Similar Items Module\n// ========================================\n// Provides \"Items Like This\" recommendations based on item properties\n// ========================================\n\nimport { allData } from './data-service.ts';\nimport { escapeHtml, generateEntityImage } from './utils.ts';\nimport { logger } from './logger.ts';\nimport type { Item, Weapon, Tome, Character, Entity, EntityType } from '../types/index.ts';\n\n// ========================================\n// Type Guards\n// ========================================\n\n/**\n * Type guard to check if entity is an Item\n */\nfunction isItem(entity: Entity): entity is Item {\n    return entity && typeof entity === 'object' && 'base_effect' in entity;\n}\n\n/**\n * Type guard to check if entity is a Weapon\n */\nfunction isWeapon(entity: Entity): entity is Weapon {\n    return entity && typeof entity === 'object' && 'attack_pattern' in entity;\n}\n\n/**\n * Type guard to check if entity is a Tome\n */\nfunction isTome(entity: Entity): entity is Tome {\n    return entity && typeof entity === 'object' && 'stat_affected' in entity;\n}\n\n/**\n * Type guard to check if entity is a Character\n */\nfunction isCharacter(entity: Entity): entity is Character {\n    return entity && typeof entity === 'object' && 'passive_ability' in entity;\n}\n\n// ========================================\n// Types\n// ========================================\n\ninterface SimilarItem {\n    entity: Entity;\n    type: EntityType;\n    score: number;\n    reasons: string[];\n}\n\ninterface SimilarityConfig {\n    maxResults: number;\n    minScore: number;\n}\n\n// ========================================\n// Constants\n// ========================================\n\nconst DEFAULT_CONFIG: SimilarityConfig = {\n    maxResults: 5,\n    minScore: 0.2,\n};\n\n// Stat keywords for matching\nconst STAT_KEYWORDS = [\n    'damage',\n    'crit',\n    'attack speed',\n    'hp',\n    'health',\n    'armor',\n    'defence',\n    'dodge',\n    'knockback',\n    'pierce',\n    'burn',\n    'freeze',\n    'poison',\n    'lifesteal',\n    'area',\n    'range',\n    'projectile',\n    'explosion',\n    'chain',\n    'bounce',\n];\n\n// ========================================\n// Similarity Calculation\n// ========================================\n\n/**\n * Calculate similarity score between two items\n * Optimized with early exit checks for performance\n */\nfunction calculateItemSimilarity(item1: Item, item2: Item): { score: number; reasons: string[] } {\n    if (item1.id === item2.id) return { score: 0, reasons: [] };\n\n    let score = 0;\n    const reasons: string[] = [];\n\n    // Early exit: items with completely different tiers and rarities are unlikely to be similar\n    const tierMatch = item1.tier === item2.tier;\n    const rarityMatch = item1.rarity === item2.rarity;\n\n    // If neither tier nor rarity matches, only continue if there might be effect synergy\n    if (!tierMatch && !rarityMatch) {\n        const effect1 = (item1.base_effect || '').toLowerCase();\n        const effect2 = (item2.base_effect || '').toLowerCase();\n\n        // Quick check: if no shared keywords, return early with 0 score\n        const hasSharedKeyword = STAT_KEYWORDS.some(keyword => effect1.includes(keyword) && effect2.includes(keyword));\n        if (!hasSharedKeyword && !item1.synergies?.some(s => item2.synergies?.includes(s))) {\n            return { score: 0, reasons: [] };\n        }\n    }\n\n    // Same tier - high relevance\n    if (tierMatch) {\n        score += 0.25;\n        reasons.push(`Same tier (${item1.tier})`);\n    }\n\n    // Same rarity\n    if (rarityMatch) {\n        score += 0.15;\n        reasons.push(`Same rarity`);\n    }\n\n    // Similar stacking behavior\n    if (item1.one_and_done === item2.one_and_done) {\n        score += 0.1;\n        if (item1.one_and_done) {\n            reasons.push('Both one-and-done');\n        }\n    }\n\n    if (item1.stacks_well === item2.stacks_well && item1.stacks_well) {\n        score += 0.1;\n        reasons.push('Both stack well');\n    }\n\n    // Shared synergies - Bug fix: Add null guard for both arrays before filtering\n    // Bug fix: Filter out empty strings to prevent false positive matches\n    // (every string .includes(''), so empty synergies would match everything)\n    if (item1.synergies?.length && item2.synergies?.length) {\n        const shared = item1.synergies.filter(s => s.length > 0 && item2.synergies?.includes(s));\n        if (shared.length > 0) {\n            score += Math.min(shared.length * 0.15, 0.3);\n            reasons.push(`Shared synergies`);\n        }\n    }\n\n    // Similar effect keywords\n    const effect1 = (item1.base_effect || '').toLowerCase();\n    const effect2 = (item2.base_effect || '').toLowerCase();\n\n    const sharedKeywords = STAT_KEYWORDS.filter(keyword => effect1.includes(keyword) && effect2.includes(keyword));\n\n    if (sharedKeywords.length > 0) {\n        score += Math.min(sharedKeywords.length * 0.1, 0.3);\n        // Safe access: length check guarantees sharedKeywords[0] exists\n        reasons.push(`Similar effects (${sharedKeywords[0] ?? 'shared'})`);\n    }\n\n    // Same scaling type\n    if (item1.scaling_formula_type && item1.scaling_formula_type === item2.scaling_formula_type) {\n        score += 0.1;\n    }\n\n    return { score, reasons };\n}\n\n/**\n * Calculate similarity score between two weapons\n * Optimized with early exit checks for performance\n */\nfunction calculateWeaponSimilarity(weapon1: Weapon, weapon2: Weapon): { score: number; reasons: string[] } {\n    if (weapon1.id === weapon2.id) return { score: 0, reasons: [] };\n\n    // Early exit: weapons with different tier AND playstyle are unlikely to be similar\n    const tierMatch = weapon1.tier === weapon2.tier;\n    const playstyleMatch = weapon1.playstyle === weapon2.playstyle;\n\n    if (!tierMatch && !playstyleMatch) {\n        // Check if they share any best_for tags before continuing\n        const sharedBestFor = weapon1.best_for?.some(b => weapon2.best_for?.includes(b));\n        if (!sharedBestFor) {\n            return { score: 0, reasons: [] };\n        }\n    }\n\n    let score = 0;\n    const reasons: string[] = [];\n\n    // Same tier\n    if (tierMatch) {\n        score += 0.3;\n        reasons.push(`Same tier (${weapon1.tier})`);\n    }\n\n    // Similar playstyle\n    if (playstyleMatch) {\n        score += 0.25;\n        reasons.push(`Same playstyle`);\n    }\n\n    // Similar attack pattern keywords\n    const pattern1 = (weapon1.attack_pattern || '').toLowerCase();\n    const pattern2 = (weapon2.attack_pattern || '').toLowerCase();\n\n    const patternKeywords = ['melee', 'ranged', 'projectile', 'aoe', 'single target', 'multi-hit'];\n    const sharedPatterns = patternKeywords.filter(k => pattern1.includes(k) && pattern2.includes(k));\n\n    if (sharedPatterns.length > 0) {\n        score += 0.2;\n        reasons.push(`Similar attack style`);\n    }\n\n    // Shared best_for tags\n    // Bug fix: Filter out empty strings to prevent false positive matches\n    if (weapon1.best_for && weapon2.best_for) {\n        const shared = weapon1.best_for.filter(b => b.length > 0 && weapon2.best_for?.includes(b));\n        if (shared.length > 0) {\n            score += Math.min(shared.length * 0.15, 0.25);\n            reasons.push(`Similar use cases`);\n        }\n    }\n\n    return { score, reasons };\n}\n\n/**\n * Calculate similarity score between two tomes\n * Optimized with early exit checks for performance\n */\nfunction calculateTomeSimilarity(tome1: Tome, tome2: Tome): { score: number; reasons: string[] } {\n    if (tome1.id === tome2.id) return { score: 0, reasons: [] };\n\n    // Early exit: tomes with different tier AND different stat category are unlikely to be similar\n    const tierMatch = tome1.tier === tome2.tier;\n    const statMatch = tome1.stat_affected === tome2.stat_affected;\n    const priorityDiff = Math.abs((tome1.priority || 0) - (tome2.priority || 0));\n\n    if (!tierMatch && !statMatch && priorityDiff > 2) {\n        return { score: 0, reasons: [] };\n    }\n\n    let score = 0;\n    const reasons: string[] = [];\n\n    // Same tier\n    if (tierMatch) {\n        score += 0.25;\n        reasons.push(`Same tier (${tome1.tier})`);\n    }\n\n    // Similar priority\n    if (priorityDiff <= 1) {\n        score += 0.2;\n        reasons.push(`Similar priority`);\n    }\n\n    // Same stat affected\n    if (statMatch && tome1.stat_affected) {\n        score += 0.35;\n        reasons.push(`Same stat (${tome1.stat_affected})`);\n    }\n\n    // Similar stat category\n    const statCategories: Record<string, string[]> = {\n        offensive: ['damage', 'crit', 'attack speed'],\n        defensive: ['hp', 'armor', 'dodge'],\n        utility: ['movement', 'cooldown', 'experience'],\n    };\n\n    for (const [category, stats] of Object.entries(statCategories)) {\n        const stat1Lower = (tome1.stat_affected || '').toLowerCase();\n        const stat2Lower = (tome2.stat_affected || '').toLowerCase();\n        const inCategory1 = stats.some(s => stat1Lower.includes(s));\n        const inCategory2 = stats.some(s => stat2Lower.includes(s));\n        if (inCategory1 && inCategory2 && tome1.stat_affected !== tome2.stat_affected) {\n            score += 0.15;\n            reasons.push(`Both ${category}`);\n            break;\n        }\n    }\n\n    return { score, reasons };\n}\n\n/**\n * Calculate similarity score between two characters\n * Optimized with early exit checks for performance\n */\nfunction calculateCharacterSimilarity(char1: Character, char2: Character): { score: number; reasons: string[] } {\n    if (char1.id === char2.id) return { score: 0, reasons: [] };\n\n    // Early exit: characters with different tier AND playstyle are unlikely to be similar\n    const tierMatch = char1.tier === char2.tier;\n    const playstyleMatch = char1.playstyle === char2.playstyle;\n\n    if (!tierMatch && !playstyleMatch) {\n        // Check for shared synergy items before continuing\n        const sharedSynergies = char1.synergies_items?.some(s => char2.synergies_items?.includes(s));\n        if (!sharedSynergies) {\n            return { score: 0, reasons: [] };\n        }\n    }\n\n    let score = 0;\n    const reasons: string[] = [];\n\n    // Same tier\n    if (tierMatch) {\n        score += 0.25;\n        reasons.push(`Same tier (${char1.tier})`);\n    }\n\n    // Same playstyle\n    if (playstyleMatch) {\n        score += 0.35;\n        reasons.push(`Same playstyle`);\n    }\n\n    // Shared synergy items\n    // Bug fix: Filter out empty strings to prevent false positive matches\n    if (char1.synergies_items && char2.synergies_items) {\n        const shared = char1.synergies_items.filter(s => s.length > 0 && char2.synergies_items?.includes(s));\n        if (shared.length > 0) {\n            score += Math.min(shared.length * 0.1, 0.2);\n            reasons.push(`Similar item synergies`);\n        }\n    }\n\n    // Similar passive keywords\n    const passive1 = (char1.passive_description || '').toLowerCase();\n    const passive2 = (char2.passive_description || '').toLowerCase();\n\n    const passiveKeywords = ['damage', 'crit', 'hp', 'speed', 'armor', 'lifesteal'];\n    const sharedPassive = passiveKeywords.filter(k => passive1.includes(k) && passive2.includes(k));\n\n    if (sharedPassive.length > 0) {\n        score += 0.15;\n        reasons.push(`Similar passive`);\n    }\n\n    return { score, reasons };\n}\n\n// ========================================\n// Main API\n// ========================================\n\n/**\n * Find similar items for a given item\n */\nexport function findSimilarItems(type: EntityType, id: string, config: Partial<SimilarityConfig> = {}): SimilarItem[] {\n    const { maxResults, minScore } = { ...DEFAULT_CONFIG, ...config };\n\n    let sourceEntity: Entity | undefined;\n    let candidates: { entity: Entity; type: EntityType }[] = [];\n\n    // Bug fix: Add explicit null guards before .find() to prevent TypeError\n    switch (type) {\n        case 'items': {\n            const itemsArray = allData.items?.items;\n            sourceEntity = itemsArray ? itemsArray.find(i => i.id === id) : undefined;\n            candidates = (itemsArray || []).map(i => ({ entity: i as Entity, type: 'items' as EntityType }));\n            break;\n        }\n        case 'weapons': {\n            const weaponsArray = allData.weapons?.weapons;\n            sourceEntity = weaponsArray ? weaponsArray.find(w => w.id === id) : undefined;\n            candidates = (weaponsArray || []).map(w => ({\n                entity: w as Entity,\n                type: 'weapons' as EntityType,\n            }));\n            break;\n        }\n        case 'tomes': {\n            const tomesArray = allData.tomes?.tomes;\n            sourceEntity = tomesArray ? tomesArray.find(t => t.id === id) : undefined;\n            candidates = (tomesArray || []).map(t => ({ entity: t as Entity, type: 'tomes' as EntityType }));\n            break;\n        }\n        case 'characters': {\n            const charsArray = allData.characters?.characters;\n            sourceEntity = charsArray ? charsArray.find(c => c.id === id) : undefined;\n            candidates = (charsArray || []).map(c => ({\n                entity: c as Entity,\n                type: 'characters' as EntityType,\n            }));\n            break;\n        }\n        default:\n            return [];\n    }\n\n    if (!sourceEntity) {\n        logger.warn({\n            operation: 'similar-items.find',\n            data: { type, id, reason: 'source_not_found' },\n        });\n        return [];\n    }\n\n    // Calculate similarity for all candidates\n    const results: SimilarItem[] = [];\n\n    for (const candidate of candidates) {\n        let similarity: { score: number; reasons: string[] };\n\n        // Use type guards for safe type narrowing instead of unsafe casts\n        switch (type) {\n            case 'items':\n                if (isItem(sourceEntity) && isItem(candidate.entity)) {\n                    similarity = calculateItemSimilarity(sourceEntity, candidate.entity);\n                } else {\n                    continue;\n                }\n                break;\n            case 'weapons':\n                if (isWeapon(sourceEntity) && isWeapon(candidate.entity)) {\n                    similarity = calculateWeaponSimilarity(sourceEntity, candidate.entity);\n                } else {\n                    continue;\n                }\n                break;\n            case 'tomes':\n                if (isTome(sourceEntity) && isTome(candidate.entity)) {\n                    similarity = calculateTomeSimilarity(sourceEntity, candidate.entity);\n                } else {\n                    continue;\n                }\n                break;\n            case 'characters':\n                if (isCharacter(sourceEntity) && isCharacter(candidate.entity)) {\n                    similarity = calculateCharacterSimilarity(sourceEntity, candidate.entity);\n                } else {\n                    continue;\n                }\n                break;\n            default:\n                continue;\n        }\n\n        if (similarity.score >= minScore) {\n            results.push({\n                entity: candidate.entity,\n                type: candidate.type,\n                score: similarity.score,\n                reasons: similarity.reasons,\n            });\n        }\n    }\n\n    // Sort by score descending and limit results\n    return results.sort((a, b) => b.score - a.score).slice(0, maxResults);\n}\n\n/**\n * Render similar items section HTML\n */\nexport function renderSimilarItemsSection(type: EntityType, id: string): string {\n    const similarItems = findSimilarItems(type, id);\n\n    if (similarItems.length === 0) {\n        return '';\n    }\n\n    const itemsHtml = similarItems\n        .map(item => {\n            const imageHtml = generateEntityImage(item.entity, item.entity.name || 'Unknown', 'similar-item-image');\n            const reason = item.reasons[0] || 'Similar';\n            const itemName = escapeHtml(item.entity.name || 'Unknown');\n\n            return `\n            <div class=\"similar-item-card\" data-type=\"${item.type}\" data-id=\"${item.entity.id}\" \n                 role=\"button\" tabindex=\"0\" aria-label=\"View ${itemName}: ${escapeHtml(reason)}\">\n                ${imageHtml || '<span class=\"similar-item-icon\"></span>'}\n                <div class=\"similar-item-name\">${itemName}</div>\n                <div class=\"similar-item-reason\">${escapeHtml(reason)}</div>\n            </div>\n        `;\n        })\n        .join('');\n\n    return `\n        <div class=\"similar-items-section\">\n            <h3> Items Like This</h3>\n            <div class=\"similar-items-grid\">\n                ${itemsHtml}\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Setup click and keyboard handlers for similar items\n * Call this after inserting the similar items HTML\n */\nexport function setupSimilarItemsHandlers(container: HTMLElement): void {\n    const cards = container.querySelectorAll('.similar-item-card');\n\n    cards.forEach(card => {\n        const handleActivation = (): void => {\n            const type = (card as HTMLElement).dataset.type as EntityType;\n            const id = (card as HTMLElement).dataset.id;\n\n            if (type && id) {\n                // Open modal for this item\n                import('./modal.ts').then(({ openDetailModal }) => {\n                    openDetailModal(type, id);\n                });\n            }\n        };\n\n        card.addEventListener('click', handleActivation);\n\n        // Keyboard accessibility: Enter or Space activates the card\n        card.addEventListener('keydown', (e: Event) => {\n            const keyEvent = e as KeyboardEvent;\n            if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {\n                keyEvent.preventDefault();\n                handleActivation();\n            }\n        });\n    });\n}\n","/**\n * Formula Renderer Module\n * Renders mathematical formulas using CSS-only styling with stacked fractions\n * No external library dependencies - pure HTML/CSS rendering\n */\n\n// Variables to highlight in formulas (sorted by length to avoid partial replacements)\nconst FORMULA_VARIABLES = [\n    'Damage Multiplier',\n    'Attack Speed Bonus',\n    'Total Proc Chance',\n    'Explosion Chance',\n    'Lightning Chance',\n    'Dragonfire Chance',\n    'Movement Speed',\n    'Number of Lives',\n    'Enemies Cursed',\n    'Freeze Chance',\n    'Poison Chance',\n    'Bloodmark Chance',\n    'Megacrit Chance',\n    'Attack Speed',\n    'Crit Chance',\n    'Stack Count',\n    'Current HP%',\n    'Max HP%',\n    'Overheal',\n    'Lifesteal',\n    'Base HP',\n    'Max HP',\n    'Internal',\n    'Stacks',\n    'Radius',\n    'Damage',\n    'Evasion',\n    'Poison',\n    'Speed',\n    'Kills',\n    'Regen',\n    'Base',\n    'HP',\n];\n\n/**\n * Escape HTML special characters to prevent XSS\n */\nfunction escapeHtml(text: string): string {\n    return text\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;')\n        .replace(/\"/g, '&quot;')\n        .replace(/'/g, '&#039;');\n}\n\n/**\n * Convert a fraction pattern (X / Y) to stacked HTML\n * Handles parenthesized expressions like (1 + Internal)\n */\nfunction renderFraction(numerator: string, denominator: string): string {\n    const numHtml = highlightVariables(escapeHtml(numerator.trim()));\n    const denHtml = highlightVariables(escapeHtml(denominator.trim()));\n    return `<span class=\"formula-fraction\"><span class=\"formula-num\">${numHtml}</span><span class=\"formula-den\">${denHtml}</span></span>`;\n}\n\n/**\n * Highlight known variables in the formula\n * Variables are sorted by length (descending) to avoid partial replacements\n * Uses placeholders to prevent nested replacements\n */\nfunction highlightVariables(text: string): string {\n    let result = text;\n    const placeholders: string[] = [];\n\n    // Sort by length descending to match longer phrases first (e.g., \"Max HP\" before \"HP\")\n    const sortedVariables = [...FORMULA_VARIABLES].sort((a, b) => b.length - a.length);\n\n    for (const variable of sortedVariables) {\n        const escaped = escapeHtml(variable);\n        const regex = new RegExp(`\\\\b${escaped}\\\\b`, 'g');\n        // Replace with a placeholder to prevent subsequent matches inside this text\n        result = result.replace(regex, () => {\n            const placeholder = `__VAR_${placeholders.length}__`;\n            placeholders.push(`<span class=\"formula-var\">${escaped}</span>`);\n            return placeholder;\n        });\n    }\n\n    // Replace all placeholders with actual HTML\n    for (let i = 0; i < placeholders.length; i++) {\n        result = result.replace(`__VAR_${i}__`, placeholders[i] ?? '');\n    }\n\n    return result;\n}\n\n/**\n * Parse and render fractions in a formula string\n * Detects patterns like \"X / Y\" and \"X / (expression)\"\n */\nfunction parseFractions(formula: string): string {\n    // Pattern to match fractions: handles \"X / Y\" and \"X / (expression)\"\n    // Using a simpler approach: find \"/\" and determine numerator/denominator\n\n    let result = formula;\n\n    // Handle parenthesized denominators: X / (...)\n    result = result.replace(/(\\w+(?:\\s*[%*]?\\s*\\w+)*)\\s*\\/\\s*\\(([^)]+)\\)/g, (_, num, den) =>\n        renderFraction(num, `(${den})`)\n    );\n\n    // Handle simple fractions: X / Y (word or number)\n    // But avoid replacing already-processed fractions or \"/\" in text like \"stack/copy\"\n    result = result.replace(/(\\d+(?:\\.\\d+)?|\\w+)\\s*\\/\\s*(\\d+(?:\\.\\d+)?)/g, (match, num, den) => {\n        // Skip if it's a word/word pattern like \"stack/copy\"\n        if (/^[a-zA-Z]+\\/[a-zA-Z]+$/.test(match)) {\n            return match;\n        }\n        return renderFraction(num, den);\n    });\n\n    return result;\n}\n\n/**\n * Render a formula string to styled HTML\n * @param formula - The formula text to render\n * @returns HTML string with styled formula\n */\nexport function renderFormula(formula: string): string {\n    if (!formula) {\n        return '';\n    }\n\n    // Check if this is a descriptive text rather than a math formula\n    const isMathFormula = /[=+\\-*/]/.test(formula);\n\n    if (!isMathFormula) {\n        return `<span class=\"formula-text\">${escapeHtml(formula)}</span>`;\n    }\n\n    // Process the formula\n    let html = escapeHtml(formula);\n\n    // Unescape the fractions we're about to process (they need raw /)\n    html = formula;\n\n    // Parse and render fractions first (before escaping)\n    html = parseFractions(html);\n\n    // Now escape any remaining HTML (but preserve our already-rendered spans)\n    // We need to be careful here - only escape text nodes\n\n    // Actually, let's rebuild: escape first, then add styling\n    let processed = escapeHtml(formula);\n\n    // Style standalone equals signs (surrounded by whitespace, indicating math equals not HTML attribute)\n    // This must be done BEFORE adding HTML with class= attributes\n    processed = processed.replace(/(\\s)=(\\s)/g, '$1<span class=\"formula-eq\">=</span>$2');\n    // Also handle = at start of string or after certain chars\n    processed = processed.replace(/^=(\\s)/, '<span class=\"formula-eq\">=</span>$1');\n\n    // Style multiplication symbol\n    processed = processed.replace(//g, '<span class=\"formula-op\"></span>');\n\n    // Highlight variables (this adds HTML with class= attributes)\n    processed = highlightVariables(processed);\n\n    // Now handle fractions (need original for fraction detection)\n    // Re-parse with fraction handling\n    let withFractions = formula;\n\n    // Handle parenthesized denominators: X / (...)\n    withFractions = withFractions.replace(/(\\w+(?:\\s*[%*]?\\s*\\w+)*)\\s*\\/\\s*\\(([^)]+)\\)/g, (_, num, den) =>\n        renderFraction(num, `(${den})`)\n    );\n\n    // Handle simple word/number over number fractions\n    withFractions = withFractions.replace(/(\\d+(?:\\.\\d+)?)\\s*\\/\\s*(\\d+(?:\\.\\d+)?)/g, (_, num, den) =>\n        renderFraction(num, den)\n    );\n\n    // If fractions were found, use that version, otherwise use the processed one\n    if (withFractions !== formula) {\n        // Apply other styling to the fraction version\n        let finalHtml = withFractions;\n\n        // Style operators FIRST (before adding HTML with class= attributes)\n        finalHtml = finalHtml.replace(/(\\s)=(\\s)/g, '$1<span class=\"formula-eq\">=</span>$2');\n        finalHtml = finalHtml.replace(//g, '<span class=\"formula-op\"></span>');\n\n        // Then highlight variables (this adds HTML with class= attributes)\n        finalHtml = highlightVariables(finalHtml);\n\n        return `<span class=\"formula-container\">${finalHtml}</span>`;\n    }\n\n    return `<span class=\"formula-container\">${processed}</span>`;\n}\n\n/**\n * Render a formula for display mode (centered, larger)\n * @param formula - The formula text to render\n * @returns HTML string with styled formula in display mode\n */\nexport function renderFormulaDisplay(formula: string): string {\n    if (!formula) {\n        return '';\n    }\n\n    const rendered = renderFormula(formula);\n\n    // Wrap in display container for larger, centered display\n    return `<div class=\"formula-display\">${rendered}</div>`;\n}\n","// ========================================\n// MegaBonk Modal Items Module\n// Item modal rendering\n// ========================================\n\nimport { safeGetElementById, generateModalImage, escapeHtml } from './utils.ts';\nimport { logger } from './logger.ts';\nimport { renderFormulaDisplay } from './formula-renderer.ts';\nimport { getChartModule, getCurrentModalSessionId, incrementModalSessionId, tabHandlers } from './modal-core.ts';\nimport type { ChartOptions } from './modal-core.ts';\nimport type { Item } from '../types/index.ts';\n\n/**\n * Render item modal content\n * @param data - Item data\n * @returns HTML content\n */\nexport function renderItemModal(data: Item): string {\n    const showGraph = data.scaling_per_stack && !data.one_and_done && data.graph_type !== 'flat';\n    const hasScalingTracks = data.scaling_tracks && Object.keys(data.scaling_tracks).length > 0;\n\n    // Generate scaling tracks tabs if item has multiple tracks\n    let graphHtml = '';\n    if (hasScalingTracks) {\n        const trackKeys = Object.keys(data.scaling_tracks!);\n        const tabsHtml = trackKeys\n            .map(\n                (key, idx) =>\n                    `<button class=\"scaling-tab ${idx === 0 ? 'active' : ''}\" data-track=\"${key}\" data-item-id=\"${data.id}\" role=\"tab\" aria-selected=\"${idx === 0 ? 'true' : 'false'}\" aria-controls=\"modal-chart-${data.id}\">${data.scaling_tracks![key]?.stat || key}</button>`\n            )\n            .join('');\n\n        graphHtml = `\n            <div class=\"scaling-tracks-container\">\n                <div class=\"scaling-tabs\" role=\"tablist\" aria-label=\"Scaling tracks\">${tabsHtml}</div>\n                <div class=\"modal-graph-container\" role=\"tabpanel\">\n                    <canvas id=\"modal-chart-${data.id}\" class=\"scaling-chart\" aria-label=\"Scaling chart for ${escapeHtml(data.name)}\"></canvas>\n                </div>\n            </div>\n        `;\n    } else if (showGraph) {\n        graphHtml = `\n            <div class=\"modal-graph-container\">\n                <canvas id=\"modal-chart-${data.id}\" class=\"scaling-chart\" aria-label=\"Scaling chart for ${escapeHtml(data.name)}\"></canvas>\n            </div>\n        `;\n    }\n\n    // Hidden mechanics section (prominent)\n    const hiddenMechanicsHtml = data.hidden_mechanics?.length\n        ? `\n        <div class=\"hidden-mechanics\">\n            <h4><span class=\"hidden-mechanics-icon\"></span> Hidden Mechanics</h4>\n            <ul>\n                ${data.hidden_mechanics.map(m => `<li>${escapeHtml(m)}</li>`).join('')}\n            </ul>\n        </div>\n    `\n        : '';\n\n    // Hyperbolic scaling indicator\n    const hyperbolicWarning =\n        data.scaling_formula_type === 'hyperbolic'\n            ? `\n        <div class=\"hyperbolic-warning\">\n            <span class=\"warning-icon\"></span>\n            <span>Hyperbolic Scaling: Displayed values have diminishing returns</span>\n        </div>\n    `\n            : '';\n\n    const imageHtml = generateModalImage(data, data.name, 'item');\n\n    const content = `\n        ${imageHtml}\n        <div class=\"item-badges\">\n            <span class=\"badge rarity-${escapeHtml(data.rarity || '')}\">${escapeHtml(data.rarity || '')}</span>\n            <span class=\"badge tier-${escapeHtml(data.tier || '')}\">${escapeHtml(data.tier || '')} Tier</span>\n        </div>\n        ${\n            data.one_and_done\n                ? `\n            <div class=\"one-and-done-warning\">\n                <span class=\"warning-icon\">!</span>\n                <span>One-and-Done: Additional copies provide no benefit</span>\n            </div>\n        `\n                : ''\n        }\n        ${hyperbolicWarning}\n        ${\n            data.max_stacks || (data.stack_cap && data.stack_cap <= 100)\n                ? `\n            <div class=\"stack-info\">\n                <strong>Stack Limit:</strong> ${data.max_stacks || data.stack_cap} stacks\n            </div>\n        `\n                : ''\n        }\n        <div class=\"item-effect\" style=\"margin-top: 1rem;\">${escapeHtml(data.base_effect || '')}</div>\n        <p>${escapeHtml(data.detailed_description || '')}</p>\n        ${hiddenMechanicsHtml}\n        ${graphHtml}\n        ${data.formula ? `<div class=\"item-formula\"><strong>Formula:</strong> ${renderFormulaDisplay(data.formula)}</div>` : ''}\n        ${data.synergies?.length ? `<div class=\"synergies-section\"><h3>Synergies</h3><div class=\"synergy-list\">${data.synergies.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div></div>` : ''}\n        ${data.anti_synergies?.length ? `<div class=\"anti-synergies-section\"><h3>Anti-Synergies</h3><div class=\"antisynergy-list\">${data.anti_synergies.map(s => `<span class=\"antisynergy-tag\">${escapeHtml(s)}</span>`).join('')}</div></div>` : ''}\n    `;\n\n    // Bug fix #10: Use requestAnimationFrame for more reliable chart initialization\n    // Initialize chart after modal is displayed and DOM is ready\n    // Bug fix: Use session ID to cancel stale initialization attempts when modal changes\n    // Bug fix #11: Wait for modal animation to complete before chart init (fixes mobile blank charts)\n    const sessionId = incrementModalSessionId();\n    let initAttempts = 0;\n    const MAX_INIT_ATTEMPTS = 50; // Prevent infinite loop - ~830ms max wait\n    const MODAL_ANIMATION_DELAY = 350; // CSS modal animation is 300ms, add buffer\n    const initChart = async (): Promise<void> => {\n        // Check if this initialization is still valid (modal wasn't reopened with different content)\n        if (sessionId !== getCurrentModalSessionId()) {\n            return; // Stale initialization, abort\n        }\n\n        // Check if modal is still active before continuing\n        const modal = safeGetElementById('itemModal');\n        if (!modal || !modal.classList.contains('active')) {\n            return; // Modal closed, stop trying\n        }\n\n        const canvas = document.getElementById(`modal-chart-${data.id}`) as HTMLCanvasElement | null;\n        if (!canvas) {\n            initAttempts++;\n            if (initAttempts < MAX_INIT_ATTEMPTS) {\n                // Canvas not ready yet, try again\n                requestAnimationFrame(initChart);\n            }\n            // If max attempts reached, silently give up (modal may have closed)\n            return;\n        }\n\n        // Use cached chart module to avoid repeated import overhead\n        const chartModule = await getChartModule();\n        if (!chartModule) {\n            return; // Can't render charts without the module\n        }\n\n        // Re-check session ID after async operation to prevent stale chart creation\n        if (sessionId !== getCurrentModalSessionId()) {\n            return; // Modal changed during import, abort\n        }\n\n        const { getEffectiveStackCap, createScalingChart } = chartModule;\n\n        if (hasScalingTracks && data.scaling_tracks) {\n            // Initialize with first track\n            const trackKeys = Object.keys(data.scaling_tracks);\n            if (trackKeys.length === 0) return; // Guard against empty scaling_tracks\n            const firstTrackKey = trackKeys[0];\n            const firstTrack = firstTrackKey ? data.scaling_tracks[firstTrackKey] : undefined;\n            const effectiveCap = getEffectiveStackCap(data);\n            const chartOptions: ChartOptions = {\n                scalingFormulaType: data.scaling_formula_type || 'linear',\n                hyperbolicConstant: data.hyperbolic_constant || 1.0,\n                maxStacks: data.max_stacks || 0,\n            };\n            if (firstTrack) {\n                createScalingChart(\n                    `modal-chart-${data.id}`,\n                    firstTrack.values,\n                    firstTrack.stat,\n                    data.scaling_type || '',\n                    true,\n                    undefined,\n                    effectiveCap,\n                    chartOptions\n                );\n            }\n\n            // Add tab click handlers\n            setupScalingTabHandlers(data);\n        } else if (showGraph) {\n            const effectiveCap = getEffectiveStackCap(data);\n            const chartOptions: ChartOptions = {\n                scalingFormulaType: data.scaling_formula_type || 'linear',\n                hyperbolicConstant: data.hyperbolic_constant || 1.0,\n                maxStacks: data.max_stacks || 0,\n            };\n            createScalingChart(\n                `modal-chart-${data.id}`,\n                data.scaling_per_stack!,\n                data.name,\n                data.scaling_type || '',\n                true,\n                data.secondary_scaling || undefined,\n                effectiveCap,\n                chartOptions\n            );\n        }\n    };\n    // Wait for modal animation to complete before initializing chart\n    // This ensures the canvas has its final dimensions for Chart.js to measure\n    setTimeout(() => requestAnimationFrame(initChart), MODAL_ANIMATION_DELAY);\n\n    return content;\n}\n\n/**\n * Setup tab click handlers for scaling tracks using event delegation\n * Bug fix #7: Use event delegation instead of adding listeners to each tab\n * @param data - Item data with scaling_tracks\n */\nfunction setupScalingTabHandlers(data: Item): void {\n    // Use event delegation on the container to avoid memory leaks\n    const container = document.querySelector('.scaling-tabs') as HTMLElement | null;\n    if (!container) return;\n\n    // Store handler reference for potential cleanup\n    const handleTabClick = async (e: Event): Promise<void> => {\n        const target = e.target as HTMLElement;\n        const tab = target.closest(`.scaling-tab[data-item-id=\"${data.id}\"]`) as HTMLButtonElement | null;\n        if (!tab) return;\n\n        // Update active state and ARIA\n        const tabs = container.querySelectorAll(`.scaling-tab[data-item-id=\"${data.id}\"]`);\n        tabs.forEach(t => {\n            t.classList.remove('active');\n            t.setAttribute('aria-selected', 'false');\n        });\n        tab.classList.add('active');\n        tab.setAttribute('aria-selected', 'true');\n\n        // Use cached chart module to avoid repeated import overhead\n        const chartModule = await getChartModule();\n        if (!chartModule) {\n            return; // Can't render charts without the module\n        }\n        const { getEffectiveStackCap, createScalingChart } = chartModule;\n\n        // Get track data and redraw chart\n        const trackKey = tab.dataset.track;\n        if (!trackKey) {\n            logger.warn({\n                operation: 'chart.init',\n                data: { context: 'tab_switch', reason: 'missing_data_track_attribute' },\n            });\n            return;\n        }\n        const track = data.scaling_tracks?.[trackKey];\n        if (!track) return;\n\n        const effectiveCap = getEffectiveStackCap(data);\n        const chartOptions: ChartOptions = {\n            scalingFormulaType: data.scaling_formula_type || 'linear',\n            hyperbolicConstant: data.hyperbolic_constant || 1.0,\n            maxStacks: data.max_stacks || 0,\n        };\n        createScalingChart(\n            `modal-chart-${data.id}`,\n            track.values,\n            track.stat,\n            data.scaling_type || '',\n            true,\n            undefined,\n            effectiveCap,\n            chartOptions\n        );\n    };\n\n    // Remove any existing handler before adding new one\n    const existingHandler = tabHandlers.get(container);\n    if (existingHandler) {\n        container.removeEventListener('click', existingHandler);\n    }\n    tabHandlers.set(container, handleTabClick);\n    container.addEventListener('click', handleTabClick);\n}\n","// ========================================\n// MegaBonk Modal Weapons Module\n// Weapon modal rendering\n// ========================================\n\nimport { generateModalImage, escapeHtml } from './utils.ts';\nimport type { Weapon } from '../types/index.ts';\n\n/**\n * Render weapon modal content\n * Bug fix: Escape all user-controlled values to prevent XSS\n * @param data - Weapon data\n * @returns HTML content\n */\nexport function renderWeaponModal(data: Weapon): string {\n    const imageHtml = generateModalImage(data, data.name, 'weapon');\n\n    // Build upgradeable stats as tags (escaped)\n    const upgradeableStatsHtml =\n        Array.isArray(data.upgradeable_stats) && data.upgradeable_stats.length\n            ? `<div class=\"tag-list\">${data.upgradeable_stats.map(s => `<span class=\"meta-tag\">${escapeHtml(s)}</span>`).join('')}</div>`\n            : '<span class=\"text-muted\">None</span>';\n\n    // Build synergies section if any exist (all values escaped)\n    const hasSynergies =\n        data.synergies_items?.length || data.synergies_tomes?.length || data.synergies_characters?.length;\n    const synergiesHtml = hasSynergies\n        ? `\n        <div class=\"synergies-section\">\n            <h3>Synergies</h3>\n            ${\n                data.synergies_items?.length\n                    ? `\n                <div class=\"synergy-group\">\n                    <h4>Items</h4>\n                    <div class=\"synergy-list\">${data.synergies_items.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div>\n                </div>\n            `\n                    : ''\n            }\n            ${\n                data.synergies_tomes?.length\n                    ? `\n                <div class=\"synergy-group\">\n                    <h4>Tomes</h4>\n                    <div class=\"synergy-list\">${data.synergies_tomes.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div>\n                </div>\n            `\n                    : ''\n            }\n            ${\n                data.synergies_characters?.length\n                    ? `\n                <div class=\"synergy-group\">\n                    <h4>Characters</h4>\n                    <div class=\"synergy-list\">${data.synergies_characters.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div>\n                </div>\n            `\n                    : ''\n            }\n        </div>\n    `\n        : '';\n\n    // Build pros/cons section if any exist (all values escaped)\n    const hasProsOrCons = data.pros?.length || data.cons?.length;\n    const prosConsHtml = hasProsOrCons\n        ? `\n        <div class=\"strengths-weaknesses\">\n            <div class=\"strengths\">\n                <h4>Pros</h4>\n                <ul>${data.pros?.map(p => `<li>${escapeHtml(p)}</li>`).join('') || '<li>None listed</li>'}</ul>\n            </div>\n            <div class=\"weaknesses\">\n                <h4>Cons</h4>\n                <ul>${data.cons?.map(c => `<li>${escapeHtml(c)}</li>`).join('') || '<li>None listed</li>'}</ul>\n            </div>\n        </div>\n    `\n        : '';\n\n    return `\n        ${imageHtml}\n        <div class=\"item-badges\">\n            <span class=\"badge tier-${escapeHtml(data.tier || '')}\">${escapeHtml(data.tier || '')} Tier</span>\n            ${data.playstyle ? `<span class=\"badge\">${escapeHtml(data.playstyle)}</span>` : ''}\n        </div>\n        <div class=\"weapon-stats-section\">\n            <div><strong>Base Damage:</strong> ${escapeHtml(String(data.base_damage || ''))}${data.base_projectile_count ? `  ${escapeHtml(String(data.base_projectile_count))} projectiles` : ''}</div>\n            <div><strong>Attack Pattern:</strong> ${escapeHtml(data.attack_pattern || '')}</div>\n        </div>\n        <p class=\"weapon-description\">${escapeHtml(data.description || '')}</p>\n        ${\n            data.best_for?.length\n                ? `\n            <div class=\"weapon-section\">\n                <h3>Best For</h3>\n                <div class=\"tag-list\">${data.best_for.map(b => `<span class=\"meta-tag\">${escapeHtml(b)}</span>`).join('')}</div>\n            </div>\n        `\n                : ''\n        }\n        <div class=\"weapon-section\">\n            <h3>Upgradeable Stats</h3>\n            ${upgradeableStatsHtml}\n        </div>\n        ${prosConsHtml}\n        ${synergiesHtml}\n        ${\n            data.build_tips\n                ? `\n            <div class=\"build-tips\">\n                <h3>Build Tips</h3>\n                <p>${escapeHtml(data.build_tips)}</p>\n            </div>\n        `\n                : ''\n        }\n        ${\n            data.unlock_requirement\n                ? `\n            <div class=\"unlock-requirement\">\n                <strong>Unlock:</strong> ${escapeHtml(data.unlock_requirement)}\n            </div>\n        `\n                : ''\n        }\n    `;\n}\n","// ========================================\n// MegaBonk Modal Characters Module\n// Character modal rendering\n// ========================================\n\nimport { generateModalImage, escapeHtml } from './utils.ts';\nimport type { Character } from '../types/index.ts';\n\n/**\n * Render character modal content\n * Bug fix: Escape all user-controlled values to prevent XSS\n * @param data - Character data\n * @returns HTML content\n */\nexport function renderCharacterModal(data: Character): string {\n    const imageHtml = generateModalImage(data, data.name, 'character');\n\n    return `\n        ${imageHtml}\n        <div class=\"item-badges\">\n            <span class=\"badge tier-${escapeHtml(data.tier || '')}\">${escapeHtml(data.tier || '')} Tier</span>\n            <span class=\"badge\">${escapeHtml(data.playstyle || '')}</span>\n        </div>\n        <div class=\"character-passive\">\n            <strong>${escapeHtml(data.passive_ability || '')}</strong>\n            <p>${escapeHtml(data.passive_description || '')}</p>\n        </div>\n        <div class=\"character-meta\">\n            <div><strong>Starting Weapon:</strong> ${escapeHtml(data.starting_weapon || '')}</div>\n            <div><strong>Base HP:</strong> ${escapeHtml(String(data.base_hp || ''))} | <strong>Base Damage:</strong> ${escapeHtml(String(data.base_damage || ''))}</div>\n            ${data.unlock_requirement ? `<div><strong>Unlock:</strong> ${escapeHtml(data.unlock_requirement)}</div>` : ''}\n        </div>\n        ${\n            data.best_for?.length\n                ? `\n            <div class=\"character-section\">\n                <h3>Best For</h3>\n                <div class=\"tag-list\">${data.best_for.map(b => `<span class=\"meta-tag\">${escapeHtml(b)}</span>`).join('')}</div>\n            </div>\n        `\n                : ''\n        }\n        <div class=\"strengths-weaknesses\">\n            <div class=\"strengths\">\n                <h4>Strengths</h4>\n                <ul>${data.strengths?.map(s => `<li>${escapeHtml(s)}</li>`).join('') || '<li>None listed</li>'}</ul>\n            </div>\n            <div class=\"weaknesses\">\n                <h4>Weaknesses</h4>\n                <ul>${data.weaknesses?.map(w => `<li>${escapeHtml(w)}</li>`).join('') || '<li>None listed</li>'}</ul>\n            </div>\n        </div>\n        <div class=\"synergies-section\">\n            <h3>Synergies</h3>\n            ${\n                data.synergies_weapons?.length\n                    ? `\n                <div class=\"synergy-group\">\n                    <h4>Weapons</h4>\n                    <div class=\"synergy-list\">${data.synergies_weapons.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div>\n                </div>\n            `\n                    : ''\n            }\n            ${\n                data.synergies_items?.length\n                    ? `\n                <div class=\"synergy-group\">\n                    <h4>Items</h4>\n                    <div class=\"synergy-list\">${data.synergies_items.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div>\n                </div>\n            `\n                    : ''\n            }\n            ${\n                data.synergies_tomes?.length\n                    ? `\n                <div class=\"synergy-group\">\n                    <h4>Tomes</h4>\n                    <div class=\"synergy-list\">${data.synergies_tomes.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div>\n                </div>\n            `\n                    : ''\n            }\n        </div>\n        ${\n            data.build_tips\n                ? `\n            <div class=\"build-tips\">\n                <h3>Build Tips</h3>\n                <p>${escapeHtml(data.build_tips)}</p>\n            </div>\n        `\n                : ''\n        }\n    `;\n}\n","// ========================================\n// MegaBonk Modal Entities Module\n// Tome, Shrine, and other entity modals\n// ========================================\n\nimport { escapeHtml } from './utils.ts';\nimport { renderFormulaDisplay } from './formula-renderer.ts';\nimport { getChartModule, getCurrentModalSessionId, incrementModalSessionId } from './modal-core.ts';\nimport type { Tome, Shrine } from '../types/index.ts';\n\n/**\n * Render tome modal content\n * Bug fix: Escape all user-controlled values to prevent XSS\n * @param data - Tome data\n * @returns HTML content\n */\nexport async function renderTomeModal(data: Tome): Promise<string> {\n    // Capture session ID for stale check after async operations\n    const sessionId = incrementModalSessionId();\n\n    // Use cached chart module to avoid repeated import overhead\n    const chartModule = await getChartModule();\n    if (!chartModule) {\n        // Return basic content without charts (escaped)\n        return `\n            <div class=\"item-badges\">\n                <span class=\"badge tier-${escapeHtml(data.tier || '')}\">${escapeHtml(data.tier || '')} Tier</span>\n                <span class=\"badge\" style=\"background: var(--bg-dark);\">Priority: ${escapeHtml(String(data.priority || ''))}</span>\n            </div>\n            <p>${escapeHtml(data.description || '')}</p>\n            <p class=\"error-message\">Charts unavailable</p>\n        `;\n    }\n\n    // Check if modal changed during import\n    if (sessionId !== getCurrentModalSessionId()) {\n        return ''; // Modal changed, return empty\n    }\n\n    const { calculateTomeProgression, createScalingChart } = chartModule;\n\n    const progression = calculateTomeProgression(data);\n    const graphHtml = progression\n        ? `\n        <div class=\"modal-graph-container\">\n            <canvas id=\"modal-tome-chart-${escapeHtml(data.id)}\" class=\"scaling-chart\"></canvas>\n        </div>\n    `\n        : '';\n\n    const content = `\n        <div class=\"item-badges\">\n            <span class=\"badge tier-${escapeHtml(data.tier || '')}\">${escapeHtml(data.tier || '')} Tier</span>\n            <span class=\"badge\" style=\"background: var(--bg-dark);\">Priority: ${escapeHtml(String(data.priority || ''))}</span>\n        </div>\n        <div class=\"tome-effect\" style=\"margin-top: 1rem;\">\n            <strong>Stat:</strong> ${escapeHtml(data.stat_affected || '')}\n        </div>\n        <p>${escapeHtml(data.description || '')}</p>\n        ${graphHtml}\n        <div class=\"item-formula\"><strong>Per Level:</strong> ${renderFormulaDisplay(String(data.value_per_level))}</div>\n        ${data.notes ? `<div class=\"item-notes\">${escapeHtml(data.notes)}</div>` : ''}\n        <div class=\"item-notes\"><strong>Recommended for:</strong> ${Array.isArray(data.recommended_for) ? escapeHtml(data.recommended_for.join(', ')) : 'General use'}</div>\n    `;\n\n    // Initialize chart after modal is displayed using requestAnimationFrame with session check\n    // Bug fix #11: Wait for modal animation (300ms) before chart init to ensure proper canvas sizing\n    const MODAL_ANIMATION_DELAY = 350;\n    if (progression) {\n        setTimeout(() => {\n            requestAnimationFrame(() => {\n                // Verify modal hasn't changed before creating chart\n                if (sessionId !== getCurrentModalSessionId()) return;\n                const canvas = document.getElementById(`modal-tome-chart-${data.id}`);\n                if (canvas) {\n                    createScalingChart(\n                        `modal-tome-chart-${data.id}`,\n                        progression,\n                        data.name,\n                        data.stat_affected || '',\n                        true\n                    );\n                }\n            });\n        }, MODAL_ANIMATION_DELAY);\n    }\n\n    return content;\n}\n\n/**\n * Render shrine modal content\n * Bug fix: Escape all user-controlled values to prevent XSS\n * @param data - Shrine data\n * @returns HTML content\n */\nexport function renderShrineModal(data: Shrine): string {\n    return `\n        <div class=\"shrine-modal-header\">\n            <span class=\"shrine-icon-modal\">${escapeHtml(data.icon || '')}</span>\n            <div class=\"item-badges\">\n                ${data.type ? `<span class=\"badge\">${escapeHtml(data.type.replace('_', ' '))}</span>` : ''}\n                ${data.reusable !== undefined ? (data.reusable ? '<span class=\"badge\">Reusable</span>' : '<span class=\"badge\">One-time</span>') : ''}\n            </div>\n        </div>\n        <div class=\"shrine-description-full\">\n            <p>${escapeHtml(data.description || '')}</p>\n        </div>\n        ${\n            data.reward\n                ? `<div class=\"shrine-detail-section\">\n            <strong>Reward</strong>\n            <p>${escapeHtml(data.reward)}</p>\n        </div>`\n                : ''\n        }\n        ${\n            data.activation\n                ? `\n            <div class=\"shrine-detail-section\">\n                <strong>Activation</strong>\n                <p>${escapeHtml(data.activation)}</p>\n            </div>\n        `\n                : ''\n        }\n        ${\n            data.spawn_count\n                ? `\n            <div class=\"shrine-detail-section\">\n                <strong>Spawn Rate</strong>\n                <p>${escapeHtml(String(data.spawn_count))}</p>\n            </div>\n        `\n                : ''\n        }\n        ${\n            data.best_for?.length\n                ? `\n            <div class=\"shrine-detail-section\">\n                <strong>Best For</strong>\n                <div class=\"tag-list\">${data.best_for.map(b => `<span class=\"meta-tag\">${escapeHtml(b)}</span>`).join('')}</div>\n            </div>\n        `\n                : ''\n        }\n        ${\n            data.synergies_items?.length\n                ? `\n            <div class=\"synergies-section\">\n                <h3>Item Synergies</h3>\n                <div class=\"synergy-list\">${data.synergies_items.map(s => `<span class=\"synergy-tag\">${escapeHtml(s)}</span>`).join('')}</div>\n            </div>\n        `\n                : ''\n        }\n        ${\n            data.strategy\n                ? `\n            <div class=\"shrine-strategy\">\n                <strong>Strategy</strong>\n                <p>${escapeHtml(data.strategy)}</p>\n            </div>\n        `\n                : ''\n        }\n        ${\n            data.notes\n                ? `\n            <div class=\"item-notes\" style=\"margin-top: 1rem;\">\n                <em>${escapeHtml(data.notes)}</em>\n            </div>\n        `\n                : ''\n        }\n    `;\n}\n","// ========================================\n// MegaBonk Modal Core Module\n// Core modal infrastructure, open/close, event handling\n// ========================================\n\nimport { allData } from './data-service.ts';\nimport { ToastManager } from './toast.ts';\nimport { safeGetElementById } from './utils.ts';\nimport { onModalOpened } from './recently-viewed.ts';\nimport { renderSimilarItemsSection, setupSimilarItemsHandlers } from './similar-items.ts';\nimport type { EntityType, Item, Weapon, Tome, Character, Shrine } from '../types/index.ts';\n\n// Import entity-specific renderers\nimport { renderItemModal } from './modal-items.ts';\nimport { renderWeaponModal } from './modal-weapons.ts';\nimport { renderCharacterModal } from './modal-characters.ts';\nimport { renderTomeModal, renderShrineModal } from './modal-entities.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Chart options for scaling visualization\n */\nexport interface ChartOptions {\n    scalingFormulaType: string;\n    hyperbolicConstant: number;\n    maxStacks: number;\n}\n\n/**\n * Union type of all modal entity types\n */\nexport type ModalEntity = Item | Weapon | Tome | Character | Shrine;\n\n// ========================================\n// Chart Module Cache\n// ========================================\n// Cache the chart module import to avoid repeated async import overhead\n// ES modules are already cached by the browser, but this avoids the async/await overhead\ntype ChartModule = typeof import('./charts.ts');\nlet cachedChartModule: ChartModule | null = null;\n\n// Track close timeout to cancel if modal is reopened quickly\nlet modalCloseTimeout: ReturnType<typeof setTimeout> | null = null;\n\n/**\n * Get the cached chart module or load it\n * @returns Promise resolving to the chart module\n */\nexport async function getChartModule(): Promise<ChartModule | null> {\n    if (cachedChartModule) {\n        return cachedChartModule;\n    }\n    try {\n        cachedChartModule = await import('./charts.ts');\n        return cachedChartModule;\n    } catch {\n        return null;\n    }\n}\n\n// ========================================\n// Focus Trap State\n// ========================================\n\n// WeakMap to track tab click handlers per container (prevents memory leaks)\nexport const tabHandlers = new WeakMap<HTMLElement, (e: Event) => void>();\n\n// Track current modal session to cancel stale chart initializations\nlet _currentModalSessionId = 0;\n\nexport function getCurrentModalSessionId(): number {\n    return _currentModalSessionId;\n}\n\nexport function incrementModalSessionId(): number {\n    _currentModalSessionId++;\n    return _currentModalSessionId;\n}\n\n// Focus trap state for modal accessibility\nlet focusTrapActive = false;\nlet focusableElements: Element[] = [];\nlet firstFocusableElement: Element | null | undefined = null;\nlet lastFocusableElement: Element | null | undefined = null;\n\n// MutationObserver for cleanup on abnormal modal removal\nlet modalObserver: MutationObserver | null = null;\n\n/**\n * Handle keyboard events for modal (focus trap + Escape to close)\n * @param e - Keyboard event\n */\nfunction handleModalKeydown(e: KeyboardEvent): void {\n    if (!focusTrapActive) return;\n\n    // Guard: Check if modal element still exists in DOM and is active\n    // This prevents stale listeners from causing errors on abnormal modal close\n    const modal = safeGetElementById('itemModal');\n    if (!modal || !modal.classList.contains('active')) {\n        deactivateFocusTrap(); // Clean up stale listener\n        return;\n    }\n\n    // Handle Escape key to close modal\n    if (e.key === 'Escape') {\n        e.preventDefault();\n        closeModal();\n        return;\n    }\n\n    if (e.key === 'Tab') {\n        if (e.shiftKey) {\n            // Shift + Tab\n            if (document.activeElement === firstFocusableElement) {\n                e.preventDefault();\n                (lastFocusableElement as HTMLElement)?.focus();\n            }\n        } else {\n            // Tab\n            if (document.activeElement === lastFocusableElement) {\n                e.preventDefault();\n                (firstFocusableElement as HTMLElement)?.focus();\n            }\n        }\n    }\n}\n\n/**\n * Activate focus trap for modal\n * @param modal - Modal element\n */\nexport function activateFocusTrap(modal: HTMLElement): void {\n    // Get all focusable elements\n    const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])';\n    focusableElements = Array.from(modal.querySelectorAll(focusableSelectors));\n\n    if (focusableElements.length > 0) {\n        firstFocusableElement = focusableElements[0];\n        lastFocusableElement = focusableElements[focusableElements.length - 1];\n\n        // Focus the modal title for better screen reader context\n        // Make title programmatically focusable and focus it\n        const modalTitle = modal.querySelector('#modal-title, h2') as HTMLElement | null;\n        if (modalTitle) {\n            modalTitle.tabIndex = -1;\n            modalTitle.focus();\n        } else {\n            // Fallback to first focusable element if no title\n            (firstFocusableElement as HTMLElement)?.focus();\n        }\n    }\n\n    focusTrapActive = true;\n    document.addEventListener('keydown', handleModalKeydown);\n\n    // Setup MutationObserver to cleanup if modal is removed abnormally\n    // This prevents state leaks if modal closes without calling deactivateFocusTrap\n    if (modalObserver) {\n        modalObserver.disconnect();\n    }\n    modalObserver = new MutationObserver(mutations => {\n        for (const mutation of mutations) {\n            // Check if modal was removed from DOM\n            if (mutation.type === 'childList') {\n                for (const removed of mutation.removedNodes) {\n                    if (removed === modal || (removed instanceof Element && removed.contains(modal))) {\n                        deactivateFocusTrap();\n                        return;\n                    }\n                }\n            }\n            // Check if modal display was set to none or active class removed\n            if (mutation.type === 'attributes' && mutation.target === modal) {\n                const modalEl = modal as HTMLElement;\n                if (modalEl.style.display === 'none' || !modalEl.classList.contains('active')) {\n                    deactivateFocusTrap();\n                    return;\n                }\n            }\n        }\n    });\n\n    // Observe the modal's parent and the modal itself for changes\n    if (modal.parentNode) {\n        modalObserver.observe(modal.parentNode, { childList: true });\n    }\n    modalObserver.observe(modal, { attributes: true, attributeFilter: ['style', 'class'] });\n}\n\n/**\n * Deactivate focus trap and cleanup all associated state\n */\nexport function deactivateFocusTrap(): void {\n    focusTrapActive = false;\n    document.removeEventListener('keydown', handleModalKeydown);\n    focusableElements = [];\n    firstFocusableElement = null;\n    lastFocusableElement = null;\n\n    // Cleanup MutationObserver\n    if (modalObserver) {\n        modalObserver.disconnect();\n        modalObserver = null;\n    }\n}\n\n/**\n * Open detail modal for any entity type\n * @param type - Entity type (items, weapons, tomes, characters, shrines)\n * @param id - Entity ID\n */\nexport async function openDetailModal(type: EntityType, id: string): Promise<void> {\n    let data: ModalEntity | undefined;\n\n    // Bug fix: Add explicit null guards before .find() to prevent TypeError\n    // when data arrays are not yet loaded\n    switch (type) {\n        case 'items': {\n            const itemsArray = allData.items?.items;\n            data = itemsArray ? itemsArray.find(i => i.id === id) : undefined;\n            break;\n        }\n        case 'weapons': {\n            const weaponsArray = allData.weapons?.weapons;\n            data = weaponsArray ? weaponsArray.find(w => w.id === id) : undefined;\n            break;\n        }\n        case 'tomes': {\n            const tomesArray = allData.tomes?.tomes;\n            data = tomesArray ? tomesArray.find(t => t.id === id) : undefined;\n            break;\n        }\n        case 'characters': {\n            const charsArray = allData.characters?.characters;\n            data = charsArray ? charsArray.find(c => c.id === id) : undefined;\n            break;\n        }\n        case 'shrines': {\n            const shrinesArray = allData.shrines?.shrines;\n            data = shrinesArray ? shrinesArray.find(s => s.id === id) : undefined;\n            break;\n        }\n    }\n\n    // Bug fix #11: Show error toast instead of failing silently\n    if (!data) {\n        ToastManager.error(`Could not find ${type} with ID: ${id}`);\n        return;\n    }\n\n    const modal = safeGetElementById('itemModal');\n    const modalBody = safeGetElementById('modalBody');\n    if (!modal || !modalBody) return;\n\n    let content = `<h2 id=\"modal-title\">${data.name}</h2>`;\n\n    if (type === 'items') {\n        content += renderItemModal(data as Item);\n    } else if (type === 'weapons') {\n        content += renderWeaponModal(data as Weapon);\n    } else if (type === 'tomes') {\n        content += await renderTomeModal(data as Tome);\n    } else if (type === 'characters') {\n        content += renderCharacterModal(data as Character);\n    } else if (type === 'shrines') {\n        content += renderShrineModal(data as Shrine);\n    }\n\n    // Add similar items section (for items, weapons, tomes, characters)\n    if (type !== 'shrines') {\n        content += renderSimilarItemsSection(type, id);\n    }\n\n    modalBody.innerHTML = content;\n    \n    // Cancel any pending close timeout to prevent race condition\n    if (modalCloseTimeout) {\n        clearTimeout(modalCloseTimeout);\n        modalCloseTimeout = null;\n    }\n    \n    modal.style.display = 'block';\n\n    // Track this view in recently viewed\n    onModalOpened(type, id);\n\n    // Trigger animation after display is set\n    requestAnimationFrame(() => {\n        modal.classList.add('active');\n        // Prevent body scroll on mobile when modal is open\n        document.body.classList.add('modal-open');\n\n        // Activate focus trap for accessibility\n        activateFocusTrap(modal);\n\n        // Setup handlers for similar items\n        setupSimilarItemsHandlers(modalBody);\n    });\n}\n\n/**\n * Close the detail modal with animation\n */\nexport function closeModal(): void {\n    const modal = safeGetElementById('itemModal');\n    if (modal) {\n        // Deactivate focus trap before closing\n        deactivateFocusTrap();\n\n        modal.classList.remove('active');\n        // Re-enable body scroll on mobile\n        document.body.classList.remove('modal-open');\n        // Wait for animation to complete before hiding\n        // Store timeout reference so it can be cancelled if modal is reopened\n        modalCloseTimeout = setTimeout(() => {\n            modal.style.display = 'none';\n            modalCloseTimeout = null;\n        }, 300);\n    }\n}\n","// ========================================\n// Core Events Module\n// Event delegation infrastructure and handlers\n// ========================================\n\nimport { ToastManager } from './toast.ts';\nimport { safeGetElementById, debounce, escapeHtml } from './utils.ts';\nimport { logger } from './logger.ts';\nimport { loadAllData } from './data-service.ts';\nimport { closeModal, openDetailModal } from './modal.ts';\nimport { toggleFavorite } from './favorites.ts';\nimport { clearFilters, saveFilterState } from './filters.ts';\nimport {\n    handleDropdownKeyboard,\n    isSearchDropdownVisible,\n    hideSearchDropdown,\n    setupDropdownClickHandlers,\n} from './search-dropdown.ts';\nimport { renderTabContent } from './renderers.ts';\nimport { getState, type TabName } from './store.ts';\nimport { switchTab } from './events-tabs.ts';\nimport { handleSearchResultClick, clearHighlightTimeout, setupSearchListeners } from './events-search.ts';\n\nimport type { EntityType } from '../types/index.ts';\n\n// ========================================\n// Memory Management: AbortController for event cleanup\n// ========================================\nlet eventAbortController: AbortController | null = null;\n\n// Track scroll/resize listener cleanup functions to prevent memory leaks\nlet scrollListenerCleanup: (() => void) | null = null;\nlet resizeListenerCleanup: (() => void) | null = null;\n\n// Track modal close timing to prevent double-handling from click+touchend events\nlet lastModalCloseTime = 0;\nconst MODAL_CLOSE_DEBOUNCE_MS = 300;\n\n/**\n * Reset modal close timer for testing\n * @internal\n */\nexport function __resetModalTimerForTesting(): void {\n    lastModalCloseTime = 0;\n}\n\n/**\n * Check if AbortSignal is properly supported in addEventListener\n * jsdom has incomplete AbortSignal support that causes TypeErrors\n */\nfunction isAbortSignalSupported(): boolean {\n    if (typeof AbortController === 'undefined') return false;\n\n    try {\n        const controller = new AbortController();\n        const testHandler = (): void => {};\n        const testDiv = document.createElement('div');\n        testDiv.addEventListener('test', testHandler, { signal: controller.signal });\n        testDiv.removeEventListener('test', testHandler);\n        return true;\n    } catch {\n        return false;\n    }\n}\n\n// Cache the result - check once at module load\nlet _abortSignalSupported: boolean | null = null;\nfunction getAbortSignalSupported(): boolean {\n    if (_abortSignalSupported === null) {\n        _abortSignalSupported = isAbortSignalSupported();\n    }\n    return _abortSignalSupported;\n}\n\n/**\n * Get or create the AbortController for event listeners\n * Returns undefined if AbortSignal isn't properly supported (e.g., jsdom)\n */\nfunction getEventAbortSignal(): AbortSignal | undefined {\n    if (!getAbortSignalSupported()) {\n        return undefined;\n    }\n\n    if (!eventAbortController) {\n        eventAbortController = new AbortController();\n    }\n    return eventAbortController.signal;\n}\n\n/**\n * Get event listener options with optional signal\n * Returns options that work in both browser and jsdom environments\n */\nexport function getListenerOptions(options?: { passive?: boolean }): AddEventListenerOptions | undefined {\n    const signal = getEventAbortSignal();\n    if (signal) {\n        return options ? { ...options, signal } : { signal };\n    }\n    return options;\n}\n\n/**\n * Clean up tab scroll/resize listeners\n * Prevents memory leaks from accumulated listeners\n */\nexport function cleanupTabScrollListeners(): void {\n    if (scrollListenerCleanup) {\n        scrollListenerCleanup();\n        scrollListenerCleanup = null;\n    }\n    if (resizeListenerCleanup) {\n        resizeListenerCleanup();\n        resizeListenerCleanup = null;\n    }\n}\n\n/**\n * Cleanup all event listeners registered via getEventAbortSignal()\n * Call this when reinitializing the app or cleaning up\n */\nexport function cleanupEventListeners(): void {\n    // Clean up any pending highlight timeouts\n    clearHighlightTimeout();\n\n    // Clean up scroll/resize listeners to prevent memory leaks\n    cleanupTabScrollListeners();\n\n    if (eventAbortController) {\n        eventAbortController.abort();\n        eventAbortController = null;\n        logger.info({\n            operation: 'events.cleanup',\n            data: { message: 'All event listeners cleaned up' },\n        });\n    }\n}\n\n/**\n * Toggle text expansion on click\n * @param {HTMLElement} element - The expandable text element\n */\nexport function toggleTextExpand(element: HTMLElement): void {\n    if (!element.dataset.fullText) return;\n\n    const isTruncated = element.dataset.truncated === 'true';\n    const fullText = element.dataset.fullText;\n\n    const textSpan = document.createElement('span');\n    const indicator = document.createElement('span');\n    indicator.className = 'expand-indicator';\n\n    if (isTruncated) {\n        textSpan.textContent = fullText;\n        indicator.textContent = 'Click to collapse';\n        element.innerHTML = '';\n        element.appendChild(textSpan);\n        element.appendChild(indicator);\n        element.dataset.truncated = 'false';\n        element.classList.add('expanded');\n    } else {\n        const truncated = fullText.length > 120 ? fullText.substring(0, 120) + '...' : fullText;\n        textSpan.textContent = truncated;\n        indicator.textContent = 'Click to expand';\n        element.innerHTML = '';\n        element.appendChild(textSpan);\n        element.appendChild(indicator);\n        element.dataset.truncated = 'true';\n        element.classList.remove('expanded');\n    }\n}\n\n// ========================================\n// Keyboard Event Handlers\n// ========================================\n\n/**\n * Handle Escape key to close modals and dropdowns\n */\nfunction handleEscapeKey(): void {\n    if (isSearchDropdownVisible()) {\n        hideSearchDropdown();\n        return;\n    }\n    closeModal();\n    import('./compare.ts')\n        .then(({ closeCompareModal }) => closeCompareModal())\n        .catch(err => {\n            logger.warn({\n                operation: 'import.compare',\n                error: { name: 'ImportError', message: err.message },\n            });\n            const compareModal = safeGetElementById('compareModal') as HTMLElement | null;\n            if (compareModal) {\n                compareModal.style.display = 'none';\n                compareModal.classList.remove('active');\n            }\n        });\n}\n\n/**\n * Handle arrow key navigation between tabs\n */\nfunction handleTabArrowNavigation(e: KeyboardEvent, target: HTMLButtonElement): void {\n    e.preventDefault();\n    const tabButtons = Array.from(document.querySelectorAll<HTMLButtonElement>('.tab-btn'));\n    if (tabButtons.length === 0) return;\n    const currentIndex = tabButtons.indexOf(target);\n    if (currentIndex === -1) return;\n\n    const nextIndex = e.key === 'ArrowRight'\n        ? (currentIndex + 1) % tabButtons.length\n        : (currentIndex - 1 + tabButtons.length) % tabButtons.length;\n\n    const nextTab = tabButtons[nextIndex];\n    if (nextTab) {\n        nextTab.focus();\n        const tabName = nextTab.getAttribute('data-tab') as TabName | null;\n        if (tabName && typeof switchTab === 'function') {\n            switchTab(tabName);\n        }\n    }\n}\n\n/**\n * Handle number key shortcuts for tab switching\n */\nfunction handleNumberKeyTabSwitch(e: KeyboardEvent): void {\n    const tabMap: Record<string, TabName> = {\n        1: 'items', 2: 'weapons', 3: 'tomes', 4: 'characters', 5: 'shrines',\n        6: 'build-planner', 7: 'calculator', 8: 'advisor', 9: 'changelog',\n    };\n    const tabName = tabMap[e.key];\n    if (tabName && typeof switchTab === 'function') {\n        e.preventDefault();\n        switchTab(tabName);\n    }\n}\n\n/**\n * Handle Enter/Space activation on breakpoint cards\n */\nfunction handleBreakpointCardActivation(e: KeyboardEvent, target: HTMLElement): void {\n    e.preventDefault();\n    const itemId = target.dataset.item;\n    const targetVal = target.dataset.target;\n    if (itemId && targetVal) {\n        const parsedTarget = parseInt(targetVal, 10);\n        if (!isNaN(parsedTarget)) {\n            import('./calculator.ts')\n                .then(({ quickCalc }) => quickCalc(itemId, parsedTarget))\n                .catch(err => {\n                    logger.warn({\n                        operation: 'import.calculator',\n                        error: { name: 'ImportError', message: err.message },\n                    });\n                });\n        }\n    }\n}\n\n/**\n * Handle keyboard events for navigation, shortcuts, and accessibility\n */\nfunction handleKeydownDelegation(e: KeyboardEvent): void {\n    const target = e.target as HTMLElement;\n    const isSearchInputFocused = target.id === 'searchInput';\n\n    if (isSearchInputFocused && isSearchDropdownVisible()) {\n        if (handleDropdownKeyboard(e)) {\n            return;\n        }\n    }\n\n    if (e.key === 'Escape') {\n        handleEscapeKey();\n        return;\n    }\n\n    if ((e.ctrlKey && e.key === 'k') || e.key === '/') {\n        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {\n            return;\n        }\n        e.preventDefault();\n        const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n        if (searchInput) {\n            searchInput.focus();\n            searchInput.select();\n        }\n        return;\n    }\n\n    if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && target.classList.contains('tab-btn')) {\n        handleTabArrowNavigation(e, target as HTMLButtonElement);\n        return;\n    }\n\n    if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.altKey && !e.metaKey) {\n        if (target.tagName !== 'INPUT' && target.tagName !== 'TEXTAREA') {\n            handleNumberKeyTabSwitch(e);\n        }\n        return;\n    }\n\n    if ((e.key === 'Enter' || e.key === ' ') && target.classList.contains('breakpoint-card')) {\n        handleBreakpointCardActivation(e, target);\n        return;\n    }\n\n    // Handle Enter/Space on suggestion cards (accessibility)\n    if ((e.key === 'Enter' || e.key === ' ') && target.classList.contains('suggestion-card')) {\n        e.preventDefault();\n        import('./empty-states.ts')\n            .then(({ handleEmptyStateClick }) => {\n                handleEmptyStateClick(target);\n            })\n            .catch(err => logger.warn({ operation: 'import.empty-states', error: { name: 'ImportError', message: err.message } }));\n        return;\n    }\n\n    // Handle Enter/Space on item cards (accessibility) - opens detail modal\n    if ((e.key === 'Enter' || e.key === ' ') && target.classList.contains('clickable-card')) {\n        e.preventDefault();\n        handleCardClick(target);\n    }\n}\n\n// ========================================\n// Click Event Handlers\n// ========================================\n\n/**\n * Handle View Details button click\n */\nfunction handleViewDetailsClick(target: HTMLElement): void {\n    const type = target.dataset.type as EntityType | undefined;\n    const id = target.dataset.id;\n    if (type && id) openDetailModal(type, id);\n}\n\n/**\n * Handle item card click to open detail modal\n */\nfunction handleCardClick(target: HTMLElement): void {\n    const card = target.closest('.item-card') as HTMLElement | null;\n    if (!card) return;\n    \n    // Map card classes/data to entity types\n    const entityType = card.dataset.entityType as EntityType | undefined;\n    const entityId = card.dataset.entityId;\n    \n    if (entityType && entityId) {\n        // Map singular entity types to plural tab names\n        const typeMap: Record<string, EntityType> = {\n            'item': 'items',\n            'weapon': 'weapons',\n            'tome': 'tomes',\n            'character': 'characters',\n            'shrine': 'shrines',\n        };\n        const type = typeMap[entityType] || entityType as EntityType;\n        openDetailModal(type, entityId);\n    }\n}\n\n/**\n * Handle compare checkbox click with debouncing\n */\nfunction handleCompareCheckboxClick(e: MouseEvent, target: Element): void {\n    const label = target.closest('.compare-checkbox-label') as HTMLElement;\n    const checkbox = label?.querySelector('.compare-checkbox') as HTMLInputElement | null;\n    if (!checkbox) return;\n\n    const now = Date.now();\n    const lastToggle = parseInt(checkbox.dataset.lastToggle || '0', 10);\n    if (now - lastToggle < 100) return;\n    checkbox.dataset.lastToggle = now.toString();\n\n    const id = checkbox.dataset.id || checkbox.value;\n    if (id) {\n        e.preventDefault();\n        checkbox.checked = !checkbox.checked;\n        import('./compare.ts')\n            .then(({ toggleCompareItem }) => toggleCompareItem(id))\n            .catch(err => logger.warn({ operation: 'import.compare', error: { name: 'ImportError', message: err.message } }));\n    }\n}\n\n/**\n * Handle remove from comparison button click\n */\nfunction handleRemoveCompareClick(target: Element): void {\n    const btn = target.classList.contains('remove-compare-btn')\n        ? (target as HTMLElement)\n        : (target.closest('.remove-compare-btn') as HTMLElement | null);\n    const id = btn?.dataset.removeId;\n    if (id) {\n        import('./compare.ts')\n            .then(({ toggleCompareItem, updateCompareDisplay }) => {\n                toggleCompareItem(id);\n                updateCompareDisplay();\n            })\n            .catch(err => logger.warn({ operation: 'import.compare', error: { name: 'ImportError', message: err.message } }));\n    }\n}\n\n/**\n * Handle breakpoint card click for quick calc\n */\nfunction handleBreakpointCardClick(target: Element): void {\n    const card = target.closest('.breakpoint-card') as HTMLElement | null;\n    const itemId = card?.dataset.item;\n    const targetVal = card?.dataset.target;\n    if (itemId && targetVal) {\n        const parsedTarget = parseInt(targetVal, 10);\n        if (!isNaN(parsedTarget)) {\n            import('./calculator.ts')\n                .then(({ quickCalc }) => quickCalc(itemId, parsedTarget))\n                .catch(err => logger.warn({ operation: 'import.calculator', error: { name: 'ImportError', message: err.message } }));\n        }\n    }\n}\n\n/**\n * Handle favorite button click\n */\nfunction handleFavoriteClick(target: Element): void {\n    const btn = (target.classList.contains('favorite-btn') ? target : target.closest('.favorite-btn')) as HTMLButtonElement | null;\n    const tabName = btn?.dataset.tab as TabName | undefined;\n    const itemId = btn?.dataset.id;\n\n    const isEntityTab = (tab: TabName | undefined): tab is EntityType => {\n        return tab === 'items' || tab === 'weapons' || tab === 'tomes' || tab === 'characters' || tab === 'shrines';\n    };\n\n    if (btn && tabName && isEntityTab(tabName) && itemId && typeof toggleFavorite === 'function') {\n        const nowFavorited = toggleFavorite(tabName, itemId);\n        btn.classList.toggle('favorited', nowFavorited);\n        btn.textContent = nowFavorited ? '' : '';\n        btn.title = nowFavorited ? 'Remove from favorites' : 'Add to favorites';\n        btn.setAttribute('aria-label', nowFavorited ? 'Remove from favorites' : 'Add to favorites');\n        if (typeof ToastManager !== 'undefined') {\n            ToastManager.success(nowFavorited ? 'Added to favorites' : 'Removed from favorites');\n        }\n    }\n}\n\n/**\n * Check if we're on mobile (480px)\n */\nfunction isMobileViewport(): boolean {\n    return window.matchMedia('(max-width: 480px)').matches;\n}\n\n/**\n * Handle item card click (for mobile - whole card is tappable)\n * Bug fix: Use card's data attributes directly instead of looking for hidden view-details-btn\n */\nfunction handleItemCardClick(target: Element): void {\n    const card = target.closest('.item-card') as HTMLElement | null;\n    if (!card) return;\n    \n    // Use card's data attributes (same as handleCardClick)\n    const entityType = card.dataset.entityType as EntityType | undefined;\n    const entityId = card.dataset.entityId;\n    \n    if (entityType && entityId) {\n        // Map singular entity types to plural tab names\n        const typeMap: Record<string, EntityType> = {\n            'item': 'items',\n            'weapon': 'weapons',\n            'tome': 'tomes',\n            'character': 'characters',\n            'shrine': 'shrines',\n        };\n        const type = typeMap[entityType] || entityType as EntityType;\n        openDetailModal(type, entityId);\n    }\n}\n\n/**\n * Handle click events via delegation\n */\nfunction handleClickDelegation(e: MouseEvent): void {\n    const target = e.target;\n\n    if (!(target instanceof Element)) {\n        return;\n    }\n\n    if (target.classList.contains('view-details-btn')) {\n        handleViewDetailsClick(target as HTMLElement);\n        return;\n    }\n    \n    // On mobile, make entire card tappable (but not if clicking specific elements)\n    if (isMobileViewport() && target.closest('.item-card')) {\n        // Don't trigger if clicking on interactive elements within the card\n        const isInteractive = target.closest('.favorite-btn, .compare-checkbox-label, .expandable-text, a, button');\n        if (!isInteractive) {\n            handleItemCardClick(target);\n            return;\n        }\n    }\n\n    // Handle card click to open detail modal (but not if clicking interactive elements)\n    if (target.closest('.item-card') && \n        !target.closest('.favorite-btn') && \n        !target.closest('.compare-checkbox-label') &&\n        !target.closest('.expandable-text') &&\n        !target.classList.contains('view-details-btn')) {\n        handleCardClick(target as HTMLElement);\n        return;\n    }\n\n    if (target.closest('.compare-checkbox-label') && !target.classList.contains('compare-checkbox')) {\n        handleCompareCheckboxClick(e, target);\n        return;\n    }\n\n    if (target.classList.contains('expandable-text') || target.closest('.expandable-text')) {\n        const expandable = target.classList.contains('expandable-text')\n            ? (target as HTMLElement)\n            : (target.closest('.expandable-text') as HTMLElement | null);\n        if (expandable) toggleTextExpand(expandable);\n        return;\n    }\n\n    if (target.classList.contains('remove-compare-btn') || target.closest('.remove-compare-btn')) {\n        handleRemoveCompareClick(target);\n        return;\n    }\n\n    if (target.classList.contains('btn-secondary') && target.textContent?.includes('Clear Filters')) {\n        clearFilters();\n        return;\n    }\n\n    if (target.classList.contains('changelog-expand-btn')) {\n        import('./changelog.ts')\n            .then(({ toggleChangelogExpand }) => toggleChangelogExpand(target as HTMLButtonElement))\n            .catch(err => logger.warn({ operation: 'import.changelog', error: { name: 'ImportError', message: err.message } }));\n        return;\n    }\n\n    if (target.classList.contains('entity-link')) {\n        e.preventDefault();\n        const htmlTarget = target as HTMLElement;\n        const type = htmlTarget.dataset.entityType as EntityType | undefined;\n        const id = htmlTarget.dataset.entityId;\n        if (type && id) openDetailModal(type, id);\n        return;\n    }\n\n    if (target.closest('.breakpoint-card')) {\n        handleBreakpointCardClick(target);\n        return;\n    }\n\n    if (target.classList.contains('favorite-btn') || target.closest('.favorite-btn')) {\n        handleFavoriteClick(target);\n        return;\n    }\n\n    if (target.closest('.search-result-card')) {\n        handleSearchResultClick(target);\n        return;\n    }\n\n    // Handle empty state action buttons and suggestion cards\n    if (target.classList.contains('empty-state-action') || target.closest('.suggestion-card')) {\n        import('./empty-states.ts')\n            .then(({ handleEmptyStateClick }) => {\n                handleEmptyStateClick(target);\n            })\n            .catch(err => logger.warn({ operation: 'import.empty-states', error: { name: 'ImportError', message: err.message } }));\n        return;\n    }\n}\n\n// ========================================\n// Change Event Handlers\n// ========================================\n\n/**\n * Handle change events via delegation\n */\nfunction handleChangeDelegation(e: Event): void {\n    const target = e.target as HTMLElement;\n\n    if (target.classList.contains('tome-checkbox') || target.classList.contains('item-checkbox')) {\n        import('./build-planner.ts')\n            .then(({ updateBuildAnalysis }) => updateBuildAnalysis())\n            .catch(err => logger.warn({ operation: 'import.build-planner', error: { name: 'ImportError', message: err.message } }));\n        return;\n    }\n\n    if (target.closest('#filters') && target.tagName === 'SELECT') {\n        const tab = getState('currentTab');\n        if (tab) {\n            renderTabContent(tab);\n            if (typeof saveFilterState === 'function') saveFilterState(tab);\n        }\n        return;\n    }\n\n    if ((target as HTMLInputElement).id === 'favoritesOnly') {\n        const tab = getState('currentTab');\n        if (tab) {\n            renderTabContent(tab);\n            if (typeof saveFilterState === 'function') saveFilterState(tab);\n        }\n        return;\n    }\n}\n\n// ========================================\n// Event Delegation Setup\n// ========================================\n\n/**\n * Setup all event delegation handlers\n */\nexport function setupEventDelegation(): void {\n    document.addEventListener('keydown', handleKeydownDelegation, getListenerOptions());\n    document.addEventListener('click', handleClickDelegation, getListenerOptions());\n    document.addEventListener('change', handleChangeDelegation, getListenerOptions());\n    window.addEventListener('pagehide', () => cleanupEventListeners(), getListenerOptions());\n}\n\n// ========================================\n// UI Component Setup\n// ========================================\n\n/**\n * Setup tab button click listeners\n */\nexport function setupTabButtonListeners(): void {\n    document.querySelectorAll<HTMLButtonElement>('.tab-btn').forEach(btn => {\n        btn.addEventListener(\n            'click',\n            () => {\n                const tabName = btn.getAttribute('data-tab') as TabName | null;\n                if (tabName) switchTab(tabName);\n            },\n            getListenerOptions()\n        );\n    });\n}\n\n/**\n * Setup tab scroll indicators for mobile\n */\nexport function setupTabScrollIndicators(): void {\n    const tabContainer = document.querySelector('.tabs .container') as HTMLElement | null;\n    const tabButtons = document.querySelector('.tab-buttons') as HTMLElement | null;\n\n    if (!tabContainer || !tabButtons) return;\n\n    cleanupTabScrollListeners();\n\n    const updateTabScrollIndicators = (): void => {\n        const canScrollLeft = tabButtons.scrollLeft > 5;\n        const canScrollRight = tabButtons.scrollLeft < tabButtons.scrollWidth - tabButtons.clientWidth - 5;\n        tabContainer.classList.toggle('can-scroll-left', canScrollLeft);\n        tabContainer.classList.toggle('can-scroll-right', canScrollRight);\n    };\n\n    let scrollRAFPending = false;\n    const throttledScrollHandler = (): void => {\n        if (scrollRAFPending) return;\n        scrollRAFPending = true;\n        requestAnimationFrame(() => {\n            updateTabScrollIndicators();\n            scrollRAFPending = false;\n        });\n    };\n\n    const debouncedResizeHandler = debounce(updateTabScrollIndicators, 100);\n\n    tabButtons.addEventListener('scroll', throttledScrollHandler, getListenerOptions({ passive: true }));\n    window.addEventListener('resize', debouncedResizeHandler, getListenerOptions());\n\n    scrollListenerCleanup = () => tabButtons.removeEventListener('scroll', throttledScrollHandler);\n    resizeListenerCleanup = () => window.removeEventListener('resize', debouncedResizeHandler);\n\n    setTimeout(updateTabScrollIndicators, 100);\n}\n\n/**\n * Setup modal close and backdrop listeners\n */\nexport function setupModalListeners(): void {\n    document.querySelectorAll<HTMLElement>('.close').forEach(closeBtn => {\n        closeBtn.addEventListener('click', closeModal, getListenerOptions());\n    });\n\n    const closeCompare = safeGetElementById('closeCompare') as HTMLButtonElement | null;\n    if (closeCompare) {\n        closeCompare.addEventListener(\n            'click',\n            () => {\n                import('./compare.ts')\n                    .then(({ closeCompareModal }) => closeCompareModal())\n                    .catch(err => logger.warn({ operation: 'import.compare', error: { name: 'ImportError', message: err.message } }));\n            },\n            getListenerOptions()\n        );\n    }\n\n    const handleModalBackdropInteraction = (e: MouseEvent | TouchEvent): void => {\n        const now = Date.now();\n        if (now - lastModalCloseTime < MODAL_CLOSE_DEBOUNCE_MS) return;\n\n        const target = e.target as HTMLElement;\n        const itemModal = safeGetElementById('itemModal') as HTMLElement | null;\n        const compareModal = safeGetElementById('compareModal') as HTMLElement | null;\n\n        if (itemModal && itemModal.classList.contains('active')) {\n            const modalContent = itemModal.querySelector('.modal-content');\n            if (target === itemModal || (itemModal.contains(target) && !modalContent?.contains(target))) {\n                lastModalCloseTime = now;\n                closeModal();\n                return;\n            }\n        }\n\n        if (compareModal && compareModal.classList.contains('active')) {\n            const modalContent = compareModal.querySelector('.modal-content');\n            if (target === compareModal || (compareModal.contains(target) && !modalContent?.contains(target))) {\n                lastModalCloseTime = now;\n                import('./compare.ts')\n                    .then(({ closeCompareModal }) => closeCompareModal())\n                    .catch(err => logger.warn({ operation: 'import.compare', error: { name: 'ImportError', message: err.message } }));\n            }\n        }\n    };\n\n    window.addEventListener('click', handleModalBackdropInteraction, getListenerOptions());\n    window.addEventListener('touchend', handleModalBackdropInteraction, getListenerOptions());\n}\n\n/**\n * Setup compare button listener\n */\nexport function setupCompareButtonListener(): void {\n    const compareBtn = safeGetElementById('compare-btn') as HTMLButtonElement | null;\n    if (compareBtn) {\n        compareBtn.addEventListener(\n            'click',\n            () => {\n                import('./compare.ts')\n                    .then(({ openCompareModal }) => openCompareModal())\n                    .catch(err => logger.warn({ operation: 'import.compare', error: { name: 'ImportError', message: err.message } }));\n            },\n            getListenerOptions()\n        );\n    }\n}\n\n/**\n * Setup mobile filter toggle button\n */\nexport function setupFilterToggle(): void {\n    const toggleBtn = safeGetElementById('filter-toggle-btn') as HTMLButtonElement | null;\n    const filters = safeGetElementById('filters') as HTMLElement | null;\n    \n    if (!toggleBtn || !filters) return;\n    \n    toggleBtn.addEventListener('click', () => {\n        const isExpanded = filters.classList.toggle('filters-expanded');\n        toggleBtn.classList.toggle('active', isExpanded);\n        toggleBtn.setAttribute('aria-expanded', String(isExpanded));\n    }, getListenerOptions());\n}\n\n/**\n * Setup sticky search bar that hides on scroll down, shows on scroll up\n */\nexport function setupStickySearchHideOnScroll(): void {\n    const controls = document.querySelector('.controls') as HTMLElement | null;\n    if (!controls) return;\n    \n    // Only enable on mobile\n    const isMobile = window.matchMedia('(max-width: 768px)');\n    if (!isMobile.matches) return;\n    \n    let lastScrollY = window.scrollY;\n    let ticking = false;\n    const scrollThreshold = 10; // Minimum scroll to trigger hide/show\n    \n    const handleScroll = (): void => {\n        if (ticking) return;\n        \n        ticking = true;\n        requestAnimationFrame(() => {\n            const currentScrollY = window.scrollY;\n            const scrollDelta = currentScrollY - lastScrollY;\n            \n            // Don't hide if we're at the top\n            if (currentScrollY <= 0) {\n                controls.classList.remove('controls-hidden');\n            } else if (scrollDelta > scrollThreshold) {\n                // Scrolling down - hide\n                controls.classList.add('controls-hidden');\n            } else if (scrollDelta < -scrollThreshold) {\n                // Scrolling up - show\n                controls.classList.remove('controls-hidden');\n            }\n            \n            lastScrollY = currentScrollY;\n            ticking = false;\n        });\n    };\n    \n    window.addEventListener('scroll', handleScroll, getListenerOptions({ passive: true }));\n    \n    // Re-check on resize\n    isMobile.addEventListener('change', (e) => {\n        if (!e.matches) {\n            controls.classList.remove('controls-hidden');\n        }\n    });\n}\n\n/**\n * Setup all event listeners\n */\nexport function setupEventListeners(): void {\n    setupTabButtonListeners();\n    setupTabScrollIndicators();\n    setupSearchListeners(getListenerOptions);\n    setupModalListeners();\n    setupCompareButtonListener();\n    setupFilterToggle();\n    setupStickySearchHideOnScroll();\n    setupEventDelegation();\n    setupDropdownClickHandlers();\n}\n\n// ========================================\n// Loading & Error UI Functions\n// ========================================\n\n/**\n * Show loading overlay\n */\nexport function showLoading(): void {\n    const overlay = safeGetElementById('loading-overlay') as HTMLElement | null;\n    if (overlay) overlay.style.display = 'flex';\n}\n\n/**\n * Hide loading overlay\n */\nexport function hideLoading(): void {\n    const overlay = safeGetElementById('loading-overlay') as HTMLElement | null;\n    if (overlay) overlay.style.display = 'none';\n}\n\n/**\n * Show error message banner\n * @param {string} message - Error message to display\n * @param {boolean} isRetryable - Whether to show retry button\n */\nexport function showErrorMessage(message: string, isRetryable: boolean = true): void {\n    let errorContainer = safeGetElementById('error-container') as HTMLElement | null;\n    let isNewContainer = false;\n\n    if (!errorContainer) {\n        errorContainer = document.createElement('div');\n        errorContainer.id = 'error-container';\n        errorContainer.className = 'error-container';\n        document.body.prepend(errorContainer);\n        isNewContainer = true;\n    }\n\n    if (!isNewContainer) {\n        const messagePara = errorContainer.querySelector<HTMLParagraphElement>('.error-content p');\n        if (messagePara) {\n            messagePara.textContent = message;\n            errorContainer.style.display = 'block';\n            return;\n        }\n    }\n\n    errorContainer.innerHTML = `\n        <div class=\"error-message\">\n            <span class=\"error-icon\"></span>\n            <div class=\"error-content\">\n                <strong>Error Loading Data</strong>\n                <p>${escapeHtml(message)}</p>\n            </div>\n            ${isRetryable ? '<button class=\"btn-primary error-retry-btn\">Retry</button>' : ''}\n            <button class=\"error-close\">&times;</button>\n        </div>\n    `;\n    errorContainer.style.display = 'block';\n\n    const retryBtn = errorContainer.querySelector<HTMLButtonElement>('.error-retry-btn');\n    if (retryBtn && !retryBtn.dataset.listenerAttached) {\n        retryBtn.dataset.listenerAttached = 'true';\n        retryBtn.addEventListener('click', () => {\n            dismissError();\n            loadAllData();\n        });\n    }\n\n    const closeBtn = errorContainer.querySelector<HTMLButtonElement>('.error-close');\n    if (closeBtn && !closeBtn.dataset.listenerAttached) {\n        closeBtn.dataset.listenerAttached = 'true';\n        closeBtn.addEventListener('click', dismissError);\n    }\n}\n\n/**\n * Dismiss error message\n */\nexport function dismissError(): void {\n    const errorContainer = safeGetElementById('error-container') as HTMLElement | null;\n    if (errorContainer) errorContainer.style.display = 'none';\n}\n","// ========================================\n// Search Events Module\n// Search functionality, filtering, and results navigation\n// ========================================\n\nimport { safeGetElementById, debounce } from './utils.ts';\nimport { handleSearch } from './filters.ts';\nimport { showSearchHistoryDropdown } from './search-history.ts';\nimport type { TabName } from './store.ts';\nimport type { EntityType } from '../types/index.ts';\nimport { switchTab } from './events-tabs.ts';\nimport { openDetailModal } from './modal.ts';\n\n/**\n * Clear highlight timeout (no-op, kept for backward compatibility)\n * Previously used for scroll-highlight behavior, now modal opens directly\n */\nexport function clearHighlightTimeout(): void {\n    // No-op - highlight behavior replaced with modal\n}\n\n/**\n * Get event listener options with optional signal\n * Imported function type for compatibility\n */\ntype GetListenerOptionsFn = (options?: { passive?: boolean }) => AddEventListenerOptions | undefined;\n\n/**\n * Setup search input listeners\n * @param getListenerOptions - Function to get listener options with AbortSignal\n */\nexport function setupSearchListeners(getListenerOptions: GetListenerOptionsFn): void {\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    if (!searchInput) return;\n\n    searchInput.addEventListener('input', debounce(handleSearch, 300), getListenerOptions());\n\n    searchInput.addEventListener(\n        'focus',\n        () => {\n            const currentQuery = searchInput.value.trim();\n            if (currentQuery.length >= 2) {\n                handleSearch();\n            } else if (typeof showSearchHistoryDropdown === 'function') {\n                showSearchHistoryDropdown(searchInput, handleSearch);\n            }\n        },\n        getListenerOptions()\n    );\n}\n\n/**\n * Handle search result card click to open detail modal\n * @param target - The clicked element\n */\nexport async function handleSearchResultClick(target: Element): Promise<void> {\n    const card = target.closest('.search-result-card') as HTMLElement | null;\n    const tabType = card?.dataset.tabType as TabName | undefined;\n    const entityId = card?.dataset.entityId;\n\n    if (!tabType || !entityId) return;\n\n    // Switch to the correct tab so user is on the right tab when modal closes\n    if (typeof switchTab === 'function') {\n        await switchTab(tabType);\n    }\n\n    // Clear search input after opening modal\n    const searchInput = safeGetElementById('searchInput') as HTMLInputElement | null;\n    if (searchInput) searchInput.value = '';\n\n    // Open the detail modal directly\n    await openDetailModal(tabType as EntityType, entityId);\n}\n","// ========================================\n// MegaBonk Offline UI Module\n// ========================================\n// Handles offline UI indicators and cached data display\n\nimport { safeGetElementById } from './utils.ts';\nimport { ToastManager } from './toast.ts';\nimport { logger } from './logger.ts';\n\n// ========================================\n// Constants\n// ========================================\n\nconst LAST_SYNC_KEY = 'megabonk_last_sync';\nconst OFFLINE_INDICATOR_ID = 'offline-indicator';\n\n// ========================================\n// Sync Time Tracking\n// ========================================\n\n/**\n * Record the last successful data sync time\n */\nexport function recordDataSync(): void {\n    try {\n        const timestamp = Date.now();\n        localStorage.setItem(LAST_SYNC_KEY, timestamp.toString());\n        logger.debug({\n            operation: 'offline.sync_recorded',\n            data: { timestamp },\n        });\n    } catch (error) {\n        // Silently fail if localStorage is unavailable\n        logger.debug({\n            operation: 'offline.sync_record_failed',\n            error: { message: (error as Error).message, name: 'StorageError', module: 'offline-ui' },\n        });\n    }\n}\n\n/**\n * Get the last sync timestamp\n * @returns Timestamp in milliseconds or null if never synced\n */\nexport function getLastSyncTime(): number | null {\n    try {\n        const stored = localStorage.getItem(LAST_SYNC_KEY);\n        return stored ? parseInt(stored, 10) : null;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * Format a timestamp as a relative time string\n * @param timestamp - Timestamp in milliseconds\n * @returns Human-readable relative time string\n */\nexport function formatRelativeTime(timestamp: number): string {\n    const now = Date.now();\n    const diff = now - timestamp;\n\n    const seconds = Math.floor(diff / 1000);\n    const minutes = Math.floor(seconds / 60);\n    const hours = Math.floor(minutes / 60);\n    const days = Math.floor(hours / 24);\n\n    if (days > 0) {\n        return days === 1 ? '1 day ago' : `${days} days ago`;\n    }\n    if (hours > 0) {\n        return hours === 1 ? '1 hour ago' : `${hours} hours ago`;\n    }\n    if (minutes > 0) {\n        return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;\n    }\n    return 'just now';\n}\n\n// ========================================\n// Offline UI Management\n// ========================================\n\n/**\n * Create the offline indicator element\n * @returns The created indicator element\n */\nexport function createOfflineIndicator(): HTMLElement {\n    const existing = safeGetElementById(OFFLINE_INDICATOR_ID);\n    if (existing) {\n        return existing;\n    }\n\n    const indicator = document.createElement('div');\n    indicator.id = OFFLINE_INDICATOR_ID;\n    indicator.className = 'offline-indicator';\n    indicator.setAttribute('role', 'status');\n    indicator.setAttribute('aria-live', 'polite');\n    indicator.style.display = 'none';\n    document.body.prepend(indicator);\n\n    return indicator;\n}\n\n/**\n * Update the offline indicator content and visibility\n * @param isOffline - Whether the app is currently offline\n */\nexport function updateOfflineIndicator(isOffline: boolean): void {\n    const indicator = safeGetElementById(OFFLINE_INDICATOR_ID);\n    if (!indicator) return;\n\n    if (isOffline) {\n        const lastSync = getLastSyncTime();\n        let message = \"You're offline - using cached data\";\n\n        if (lastSync) {\n            const relativeTime = formatRelativeTime(lastSync);\n            message = `You're offline - using data from ${relativeTime}`;\n        }\n\n        indicator.innerHTML = `\n            <span class=\"offline-icon\"></span>\n            <span class=\"offline-message\">${message}</span>\n            <button class=\"offline-retry-btn\" aria-label=\"Retry connection\">Retry</button>\n        `;\n\n        // Add retry button handler\n        const retryBtn = indicator.querySelector('.offline-retry-btn');\n        if (retryBtn) {\n            retryBtn.addEventListener('click', () => {\n                if (navigator.onLine) {\n                    updateOfflineIndicator(false);\n                    ToastManager.success('Back online!');\n                    // Optionally reload data\n                    if (typeof window.loadAllData === 'function') {\n                        window.loadAllData();\n                    }\n                } else {\n                    ToastManager.info('Still offline. Please check your connection.');\n                }\n            });\n        }\n\n        indicator.style.display = 'flex';\n    } else {\n        indicator.style.display = 'none';\n    }\n}\n\n/**\n * Setup offline event listeners\n */\nexport function setupOfflineListeners(): void {\n    // Ensure the indicator element exists\n    createOfflineIndicator();\n\n    const handleOnline = (): void => {\n        updateOfflineIndicator(false);\n        logger.info({\n            operation: 'app.online',\n            data: { previousState: 'offline' },\n        });\n        // DISABLED: \"Back online\" toast notification hidden\n        // ToastManager.success('Back online!');\n        recordDataSync();\n    };\n\n    const handleOffline = (): void => {\n        updateOfflineIndicator(true);\n        logger.info({\n            operation: 'app.offline',\n            data: { previousState: 'online' },\n        });\n    };\n\n    window.addEventListener('online', handleOnline);\n    window.addEventListener('offline', handleOffline);\n\n    // Initial state check\n    if (!navigator.onLine) {\n        updateOfflineIndicator(true);\n    }\n}\n\n// ========================================\n// Global Scope Exports (backwards compatibility)\n// ========================================\n\nif (typeof window !== 'undefined') {\n    Object.assign(window, {\n        recordDataSync,\n        getLastSyncTime,\n        updateOfflineIndicator,\n    });\n}\n","// ========================================\n// MegaBonk Data Service Module\n// ========================================\n\nimport { ToastManager } from './toast.ts';\nimport { validateAllData, logValidationResults, validateWithZod } from './data-validation.ts';\nimport { logger } from './logger.ts';\nimport { getSavedTab } from './events.ts';\nimport { getState, setState } from './store.ts';\nimport { recordDataSync } from './offline-ui.ts';\nimport type { AllGameData, Entity, EntityType, ChangelogData, ChangelogPatch } from '../types/index.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Data type union including changelog\n */\ntype DataType = EntityType | 'stats' | 'changelog';\n\n/**\n * Enhanced error with fetch metadata for retry logic\n */\ninterface FetchError extends Error {\n    type?: 'timeout' | 'network' | 'cors' | 'parse' | 'http' | 'unknown';\n    retriable?: boolean;\n}\n\n// ========================================\n// UI Helper Functions\n// ========================================\n\nfunction showLoading(): void {\n    const overlay = document.getElementById('loading-overlay');\n    if (overlay) overlay.style.display = 'flex';\n}\n\nfunction hideLoading(): void {\n    const overlay = document.getElementById('loading-overlay');\n    if (overlay) overlay.style.display = 'none';\n}\n\nfunction showErrorMessage(message: string): void {\n    ToastManager.error(message);\n    const mainContent = document.getElementById('main-content');\n    if (mainContent) {\n        // Use textContent to prevent XSS - error messages should be displayed as plain text\n        const errorDiv = document.createElement('div');\n        errorDiv.className = 'error-message';\n        errorDiv.textContent = message;\n        mainContent.innerHTML = '';\n        mainContent.appendChild(errorDiv);\n    }\n}\n\nfunction safeGetElementById(id: string): HTMLElement | null {\n    return document.getElementById(id);\n}\n\n// Global data storage - uses centralized store as single source of truth\n// Export getter for backwards compatibility with modules that import allData\nfunction getCurrentData(): AllGameData {\n    return getState('allData');\n}\n\n// ========================================\n// Data Validation\n// ========================================\n\n/**\n * Validate data structure\n */\nfunction validateData(data: unknown, type: DataType): boolean {\n    if (!data || typeof data !== 'object') {\n        return false;\n    }\n\n    // Skip Zod validation for changelog (schema not yet implemented)\n    if (type === 'changelog') {\n        const changelogData = data as ChangelogData;\n        if (!changelogData.patches || !Array.isArray(changelogData.patches)) {\n            return false;\n        }\n        return true;\n    }\n\n    // Use Zod validation for typed data (items, weapons, tomes, characters, shrines, stats)\n    // Validation errors are logged by the validation module itself\n    // Return the actual validation result to properly reject corrupt data\n    const result = validateWithZod(data, type);\n    return result.valid;\n}\n\n// ========================================\n// Data Loading\n// ========================================\n\n/**\n * Result of loading data (for testing)\n */\nexport interface LoadDataResult {\n    success: boolean;\n    data?: AllGameData;\n    error?: Error;\n}\n\n/**\n * Pure function to load data from URLs (testable)\n * This is a simplified version without retry logic for unit testing\n * @param urls - Object with URLs for each data type\n * @returns Promise with load result\n */\nexport async function loadDataFromUrls(urls: {\n    items: string;\n    weapons: string;\n    tomes: string;\n    characters: string;\n    shrines: string;\n    stats: string;\n}): Promise<LoadDataResult> {\n    try {\n        const [itemsRes, weaponsRes, tomesRes, charsRes, shrinesRes, statsRes] = await Promise.all([\n            fetch(urls.items),\n            fetch(urls.weapons),\n            fetch(urls.tomes),\n            fetch(urls.characters),\n            fetch(urls.shrines),\n            fetch(urls.stats),\n        ]);\n\n        // Bug fix: Check response.ok before parsing JSON to catch HTTP errors\n        const responses = [\n            { res: itemsRes, name: 'items', url: urls.items },\n            { res: weaponsRes, name: 'weapons', url: urls.weapons },\n            { res: tomesRes, name: 'tomes', url: urls.tomes },\n            { res: charsRes, name: 'characters', url: urls.characters },\n            { res: shrinesRes, name: 'shrines', url: urls.shrines },\n            { res: statsRes, name: 'stats', url: urls.stats },\n        ];\n\n        for (const { res, name, url } of responses) {\n            if (!res.ok) {\n                throw new Error(`Failed to load ${name} from ${url}: HTTP ${res.status} ${res.statusText}`);\n            }\n        }\n\n        // Parse JSON only after verifying all responses are OK\n        const [items, weapons, tomes, characters, shrines, stats] = await Promise.all([\n            itemsRes.json(),\n            weaponsRes.json(),\n            tomesRes.json(),\n            charsRes.json(),\n            shrinesRes.json(),\n            statsRes.json(),\n        ]);\n\n        const data: AllGameData = {\n            items,\n            weapons,\n            tomes,\n            characters,\n            shrines,\n            stats,\n            changelog: undefined,\n        };\n\n        return { success: true, data };\n    } catch (error) {\n        return { success: false, error: error as Error };\n    }\n}\n\n/**\n * Categorize fetch errors for better error handling\n */\nfunction categorizeFetchError(error: Error, url: string): { type: string; retriable: boolean; message: string } {\n    const errorMessage = error.message.toLowerCase();\n\n    if (error.name === 'AbortError' || errorMessage.includes('timeout')) {\n        return { type: 'timeout', retriable: true, message: `Request timed out: ${url}` };\n    }\n\n    if (errorMessage.includes('network') || errorMessage.includes('failed to fetch')) {\n        return { type: 'network', retriable: true, message: `Network error: ${url}` };\n    }\n\n    if (errorMessage.includes('cors')) {\n        return { type: 'cors', retriable: false, message: `CORS error: ${url}` };\n    }\n\n    if (errorMessage.includes('json')) {\n        return { type: 'parse', retriable: false, message: `JSON parse error: ${url}` };\n    }\n\n    return { type: 'unknown', retriable: true, message: error.message };\n}\n\n/**\n * Fetch with timeout to prevent indefinite waiting\n */\nasync function fetchWithTimeout(url: string, timeout: number = 30000): Promise<Response> {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n    try {\n        const response = await fetch(url, { signal: controller.signal });\n        clearTimeout(timeoutId);\n        return response;\n    } catch (error) {\n        clearTimeout(timeoutId);\n        const categorized = categorizeFetchError(error as Error, url);\n        const enhancedError = new Error(categorized.message) as FetchError;\n        enhancedError.type = categorized.type as FetchError['type'];\n        enhancedError.retriable = categorized.retriable;\n        throw enhancedError;\n    }\n}\n\n/**\n * Fetch with retry and exponential backoff\n * Only retries on retriable errors (network, timeout)\n */\nasync function fetchWithRetry(url: string, maxRetries: number = 4, initialDelay: number = 2000): Promise<Response> {\n    let lastError: FetchError | undefined;\n\n    for (let attempt = 0; attempt <= maxRetries; attempt++) {\n        try {\n            const response = await fetchWithTimeout(url);\n\n            if (response.ok) {\n                return response;\n            }\n\n            // HTTP error - categorize by status code\n            const status = response.status;\n            const retriable = status >= 500 || status === 429; // Server errors and rate limiting are retriable\n            lastError = new Error(`HTTP ${status}: ${response.statusText}`) as FetchError;\n            lastError.type = 'http';\n            lastError.retriable = retriable;\n\n            // Don't retry non-retriable HTTP errors (4xx except 429)\n            if (!retriable) {\n                break;\n            }\n        } catch (error) {\n            lastError = error as FetchError;\n\n            // Don't retry non-retriable errors\n            if (lastError.retriable === false) {\n                break;\n            }\n        }\n\n        // Don't wait after the last attempt\n        if (attempt < maxRetries) {\n            const delay = initialDelay * Math.pow(2, attempt); // Exponential backoff\n            logger.debug({\n                operation: 'data.fetch_retry',\n                data: {\n                    url,\n                    attempt: attempt + 1,\n                    maxRetries,\n                    delayMs: delay,\n                    errorType: lastError?.type,\n                },\n            });\n            await new Promise(resolve => setTimeout(resolve, delay));\n        }\n    }\n\n    throw new Error(`Failed to fetch ${url} after ${maxRetries + 1} attempts: ${lastError?.message}`);\n}\n\n/**\n * Load all game data from JSON files\n */\nexport async function loadAllData(): Promise<void> {\n    showLoading();\n    const loadStartTime = performance.now();\n\n    try {\n        const responses = await Promise.all([\n            fetchWithRetry('./data/items.json'),\n            fetchWithRetry('./data/weapons.json'),\n            fetchWithRetry('./data/tomes.json'),\n            fetchWithRetry('./data/characters.json'),\n            fetchWithRetry('./data/shrines.json'),\n            fetchWithRetry('./data/stats.json'),\n            fetchWithRetry('./data/changelog.json'),\n        ]);\n\n        // Check for HTTP errors and parse JSON safely\n        const [items, weapons, tomes, characters, shrines, stats, changelog] = await Promise.all(\n            responses.map(async r => {\n                if (!r.ok) {\n                    throw new Error(`Failed to load ${r.url}: ${r.status} ${r.statusText}`);\n                }\n                return r.json();\n            })\n        );\n\n        // Validate all data\n        const dataTypes: Array<{ data: unknown; type: DataType }> = [\n            { data: items, type: 'items' },\n            { data: weapons, type: 'weapons' },\n            { data: tomes, type: 'tomes' },\n            { data: characters, type: 'characters' },\n            { data: shrines, type: 'shrines' },\n            { data: stats, type: 'stats' },\n            { data: changelog, type: 'changelog' },\n        ];\n\n        for (const { data, type } of dataTypes) {\n            if (!validateData(data, type)) {\n                throw new Error(`Data validation failed for ${type}. Data may be corrupted.`);\n            }\n        }\n\n        // Update store as single source of truth\n        const newData = { items, weapons, tomes, characters, shrines, stats, changelog };\n        setState('allData', newData);\n\n        // Invalidate build stats cache when data changes\n        // Using dynamic import to avoid blocking and circular dependency\n        import('./build-planner.ts')\n            .then(({ invalidateBuildStatsCache }) => invalidateBuildStatsCache())\n            .catch(error => {\n                // Log the error for debugging - build planner might not be loaded yet\n                logger.debug({\n                    operation: 'data.cache_invalidation',\n                    data: {\n                        module: 'build-planner',\n                        reason: 'module_not_loaded',\n                        error: (error as Error).message,\n                    },\n                });\n            });\n\n        // Run comprehensive validation\n        const validationResult = validateAllData(newData);\n        logValidationResults(validationResult);\n\n        // Log data load wide event\n        const loadDuration = Math.round(performance.now() - loadStartTime);\n        logger.info({\n            operation: 'data.load',\n            durationMs: loadDuration,\n            success: true,\n            data: {\n                filesLoaded: ['items', 'weapons', 'tomes', 'characters', 'shrines', 'stats', 'changelog'],\n                itemCounts: {\n                    items: items?.items?.length || 0,\n                    weapons: weapons?.weapons?.length || 0,\n                    tomes: tomes?.tomes?.length || 0,\n                    characters: characters?.characters?.length || 0,\n                    shrines: shrines?.shrines?.length || 0,\n                },\n                validationResults: {\n                    valid: validationResult.valid,\n                    errorCount: validationResult.errors.length,\n                    warningCount: validationResult.warnings.length,\n                },\n                version: items?.version || 'unknown',\n            },\n        });\n\n        // Show warning if validation fails critically\n        if (!validationResult.valid && validationResult.errors.length > 10) {\n            ToastManager.warning('Some game data may be incomplete. Check console for details.');\n        }\n\n        // Update version info\n        const versionEl = safeGetElementById('version');\n        const updatedEl = safeGetElementById('last-updated');\n        if (versionEl) versionEl.textContent = `Version: ${items?.version || 'Unknown'}`;\n        if (updatedEl) updatedEl.textContent = `Last Updated: ${items?.last_updated || 'Unknown'}`;\n\n        hideLoading();\n\n        // Record successful data sync for offline indicator\n        recordDataSync();\n\n        // Initialize UI - restore saved tab or default to 'items'\n        // Note: switchTab is a global function from script.js\n        const windowWithSwitchTab = window as Window & { switchTab?: (tab: string) => void };\n        if (typeof windowWithSwitchTab.switchTab === 'function') {\n            windowWithSwitchTab.switchTab(getSavedTab());\n        }\n\n        // Load build from URL if present\n        // Note: loadBuildFromURL is a global function from build-planner.js\n        const windowWithLoadBuild = window as Window & { loadBuildFromURL?: () => void };\n        if (typeof windowWithLoadBuild.loadBuildFromURL === 'function') {\n            windowWithLoadBuild.loadBuildFromURL();\n        }\n\n        // Initialize advisor with loaded data\n        // Note: initAdvisor is a global function from advisor.ts\n        const windowWithAdvisor = window as Window & { initAdvisor?: (data: AllGameData) => void };\n        if (typeof windowWithAdvisor.initAdvisor === 'function') {\n            windowWithAdvisor.initAdvisor(newData);\n        }\n\n        // Initialize scan build module\n        // Note: initScanBuild is a global function from scan-build.ts\n        const windowWithScanBuild = window as Window & { initScanBuild?: (data: AllGameData) => void };\n        if (typeof windowWithScanBuild.initScanBuild === 'function') {\n            windowWithScanBuild.initScanBuild(newData);\n        }\n    } catch (error) {\n        const loadDuration = Math.round(performance.now() - loadStartTime);\n        const err = error as Error;\n\n        logger.error({\n            operation: 'data.load',\n            durationMs: loadDuration,\n            success: false,\n            error: {\n                name: err.name,\n                message: err.message,\n                stack: err.stack,\n                module: 'data-service',\n                retriable: true, // Network errors are often transient\n            },\n        });\n\n        hideLoading();\n        showErrorMessage(`Could not load game data. ${err.message || 'Please check your connection and try again.'}`);\n    }\n}\n\n/**\n * Get data array for a specific tab\n */\nexport function getDataForTab(tabName: string): Entity[] | ChangelogPatch[] {\n    return getDataForTabFromData(getCurrentData(), tabName);\n}\n\n/**\n * Pure function to get data array for a specific tab (testable)\n * @param data - All game data object\n * @param tabName - Tab name to get data for\n * @returns Array of entities for the tab\n */\nexport function getDataForTabFromData(data: AllGameData, tabName: string): Entity[] | ChangelogPatch[] {\n    switch (tabName) {\n        case 'items':\n            return data.items?.items || [];\n        case 'weapons':\n            return data.weapons?.weapons || [];\n        case 'tomes':\n            return data.tomes?.tomes || [];\n        case 'characters':\n            return data.characters?.characters || [];\n        case 'shrines':\n            return data.shrines?.shrines || [];\n        case 'changelog':\n            return data.changelog?.patches || [];\n        default:\n            return [];\n    }\n}\n\n/**\n * Get all data object\n */\nexport function getAllData(): AllGameData {\n    return getState('allData');\n}\n\n// Export allData getter for backwards compatibility\n// Uses Object.defineProperty to create a getter that always returns current store value\nexport const allData: AllGameData = new Proxy({} as AllGameData, {\n    get(_target, prop) {\n        return getCurrentData()[prop as keyof AllGameData];\n    },\n    set() {\n        throw new Error('allData is read-only. Use setState(\"allData\", data) to update.');\n    },\n});\n","// ========================================\n// MegaBonk DOM Cache Module\n// Caches frequently accessed DOM elements to avoid repeated queries\n// ========================================\n\n/**\n * Type for cached DOM elements\n */\ntype CachedElement = HTMLElement | Element | NodeListOf<Element> | null;\n\n/**\n * DOM element cache with automatic invalidation\n */\nclass DOMCache {\n    private cache: Map<string, CachedElement>;\n    private initialized: boolean;\n\n    constructor() {\n        this.cache = new Map();\n        this.initialized = false;\n    }\n\n    /**\n     * Initialize cache with commonly accessed elements\n     */\n    init(): void {\n        if (this.initialized) return;\n\n        // Common elements\n        this.cache.set('searchInput', document.getElementById('searchInput'));\n        this.cache.set('favoritesOnly', document.getElementById('favoritesOnly'));\n        this.cache.set('filters', document.getElementById('filters'));\n        this.cache.set('itemCount', document.getElementById('item-count'));\n        this.cache.set('mainContent', document.getElementById('main-content'));\n        this.cache.set('modalOverlay', document.getElementById('modal-overlay'));\n        this.cache.set('compareButton', document.getElementById('compare-button'));\n        this.cache.set('compareCount', document.querySelector('.compare-count'));\n\n        // Tab buttons (cache as NodeList)\n        this.cache.set('tabButtons', document.querySelectorAll('.tab-btn'));\n\n        // Tab content containers\n        this.cache.set('itemsContainer', document.getElementById('itemsContainer'));\n        this.cache.set('weaponsContainer', document.getElementById('weaponsContainer'));\n        this.cache.set('tomesContainer', document.getElementById('tomesContainer'));\n        this.cache.set('charactersContainer', document.getElementById('charactersContainer'));\n        this.cache.set('shrinesContainer', document.getElementById('shrinesContainer'));\n\n        this.initialized = true;\n    }\n\n    /**\n     * Get cached element by key\n     * @param key - Cache key\n     * @returns Cached element or null\n     */\n    get(key: string): CachedElement {\n        if (!this.initialized) this.init();\n        return this.cache.get(key) || null;\n    }\n\n    /**\n     * Set or update cached element\n     * @param key - Cache key\n     * @param element - Element to cache\n     */\n    set(key: string, element: CachedElement): void {\n        this.cache.set(key, element);\n    }\n\n    /**\n     * Invalidate specific cache entry\n     * @param key - Cache key to invalidate\n     */\n    invalidate(key: string): void {\n        this.cache.delete(key);\n    }\n\n    /**\n     * Invalidate all cache entries\n     */\n    invalidateAll(): void {\n        this.cache.clear();\n        this.initialized = false;\n    }\n\n    /**\n     * Refresh specific cached element\n     * @param key - Cache key\n     * @param selector - CSS selector or element ID\n     * @param isId - Whether selector is an ID (default: true)\n     */\n    refresh(key: string, selector: string, isId: boolean = true): void {\n        const element = isId ? document.getElementById(selector) : document.querySelector(selector);\n        if (element) {\n            this.cache.set(key, element);\n        } else {\n            this.cache.delete(key);\n        }\n    }\n}\n\n// Create global DOM cache instance\nexport const domCache = new DOMCache();\n\n// ========================================\n// Convenience Helper Functions\n// ========================================\n\n/**\n * Get search input element (cached)\n * @returns HTMLInputElement or null\n */\nexport function getSearchInput(): HTMLElement | null {\n    return domCache.get('searchInput') as HTMLElement | null;\n}\n\n/**\n * Get favorites checkbox element (cached)\n * @returns HTMLInputElement or null\n */\nexport function getFavoritesCheckbox(): HTMLElement | null {\n    return domCache.get('favoritesOnly') as HTMLElement | null;\n}\n\n/**\n * Get filters container (cached)\n * @returns HTMLElement or null\n */\nexport function getFiltersContainer(): HTMLElement | null {\n    return domCache.get('filters') as HTMLElement | null;\n}\n\n/**\n * Get item count element (cached)\n * @returns HTMLElement or null\n */\nexport function getItemCount(): HTMLElement | null {\n    return domCache.get('itemCount') as HTMLElement | null;\n}\n\n/**\n * Get all tab buttons (cached NodeList)\n * @returns NodeListOf<Element> or null\n */\nexport function getTabButtons(): NodeListOf<Element> | null {\n    return domCache.get('tabButtons') as NodeListOf<Element> | null;\n}\n\n/**\n * Get container for specific tab\n * @param tabName - Tab name (items, weapons, tomes, etc.)\n * @returns HTMLElement or null\n */\nexport function getTabContainer(tabName: string): HTMLElement | null {\n    const key = `${tabName}Container`;\n    return domCache.get(key) as HTMLElement | null;\n}\n\n/**\n * Get modal overlay (cached)\n * @returns HTMLElement or null\n */\nexport function getModalOverlay(): HTMLElement | null {\n    return domCache.get('modalOverlay') as HTMLElement | null;\n}\n\n/**\n * Get compare button (cached)\n * @returns HTMLButtonElement or null\n */\nexport function getCompareButton(): HTMLElement | null {\n    return domCache.get('compareButton') as HTMLElement | null;\n}\n\n/**\n * Get filter element by ID (with caching)\n * @param filterId - Filter element ID\n * @returns HTMLElement or null\n */\nexport function getFilterElement(filterId: string): HTMLElement | null {\n    const cached = domCache.get(`filter_${filterId}`);\n    if (cached) return cached as HTMLElement | null;\n\n    const element = document.getElementById(filterId);\n    if (element) {\n        domCache.set(`filter_${filterId}`, element);\n    }\n    return element;\n}\n\n/**\n * Invalidate cache when DOM structure changes\n * Call this after dynamically adding/removing elements\n */\nexport function invalidateDOMCache(): void {\n    domCache.invalidateAll();\n}\n\n/**\n * Refresh cache after filter updates\n * Filters are recreated when switching tabs\n */\nexport function refreshFilterCache(): void {\n    // Invalidate filter-related cache entries\n    domCache.invalidate('rarityFilter');\n    domCache.invalidate('tierFilter');\n    domCache.invalidate('stackingFilter');\n    domCache.invalidate('sortBy');\n    domCache.invalidate('favoritesOnly');\n}\n","// ========================================\n// Breadcrumbs Module\n// ========================================\n// Tracks user actions for debugging and error reporting\n// Implements circular buffer of last N user actions\n// ========================================\n\nimport { logger } from './logger.ts';\nimport { getState } from './store.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Breadcrumb action types\n */\nexport type BreadcrumbType =\n    | 'tab_switch'\n    | 'search'\n    | 'filter_change'\n    | 'item_click'\n    | 'modal_open'\n    | 'modal_close'\n    | 'build_update'\n    | 'compare_toggle'\n    | 'favorite_toggle'\n    | 'navigation'\n    | 'keyboard_shortcut'\n    | 'error'\n    | 'custom';\n\n/**\n * Breadcrumb entry\n */\nexport interface Breadcrumb {\n    type: BreadcrumbType;\n    timestamp: number;\n    message: string;\n    data?: Record<string, unknown>;\n    category?: string;\n}\n\n/**\n * Breadcrumb configuration\n */\nexport interface BreadcrumbConfig {\n    maxBreadcrumbs: number;\n    enableAutoCapture: boolean;\n    enableConsoleLog: boolean;\n}\n\n// ========================================\n// State\n// ========================================\n\nconst DEFAULT_MAX_BREADCRUMBS = 50;\nlet breadcrumbs: Breadcrumb[] = [];\nlet config: BreadcrumbConfig = {\n    maxBreadcrumbs: DEFAULT_MAX_BREADCRUMBS,\n    enableAutoCapture: true,\n    enableConsoleLog: false,\n};\n\n// ========================================\n// Core Functions\n// ========================================\n\n/**\n * Configure breadcrumbs system\n * @param newConfig - Partial configuration to apply\n */\nexport function configureBreadcrumbs(newConfig: Partial<BreadcrumbConfig>): void {\n    config = { ...config, ...newConfig };\n}\n\n/**\n * Get current configuration\n * @returns Current breadcrumb configuration\n */\nexport function getBreadcrumbConfig(): BreadcrumbConfig {\n    return { ...config };\n}\n\n/**\n * Add a breadcrumb to the trail\n * @param breadcrumb - Breadcrumb to add\n */\nexport function addBreadcrumb(\n    type: BreadcrumbType,\n    message: string,\n    data?: Record<string, unknown>,\n    category?: string\n): void {\n    const breadcrumb: Breadcrumb = {\n        type,\n        timestamp: Date.now(),\n        message,\n        data,\n        category,\n    };\n\n    // Add to circular buffer\n    breadcrumbs.push(breadcrumb);\n\n    // Maintain max size\n    if (breadcrumbs.length > config.maxBreadcrumbs) {\n        breadcrumbs = breadcrumbs.slice(-config.maxBreadcrumbs);\n    }\n\n    // Log if enabled\n    if (config.enableConsoleLog) {\n        console.debug('[Breadcrumb]', type, message, data);\n    }\n}\n\n/**\n * Get all breadcrumbs (copy)\n * @returns Array of breadcrumbs\n */\nexport function getBreadcrumbs(): Breadcrumb[] {\n    return [...breadcrumbs];\n}\n\n/**\n * Get breadcrumbs for a specific time range\n * @param sinceMs - Milliseconds ago to start from\n * @returns Filtered breadcrumbs\n */\nexport function getRecentBreadcrumbs(sinceMs: number = 60000): Breadcrumb[] {\n    const cutoff = Date.now() - sinceMs;\n    return breadcrumbs.filter(b => b.timestamp >= cutoff);\n}\n\n/**\n * Clear all breadcrumbs\n */\nexport function clearBreadcrumbs(): void {\n    breadcrumbs = [];\n}\n\n/**\n * Export breadcrumbs as JSON string\n * @returns JSON string of breadcrumbs\n */\nexport function exportBreadcrumbs(): string {\n    return JSON.stringify(\n        {\n            exported: Date.now(),\n            count: breadcrumbs.length,\n            breadcrumbs: breadcrumbs,\n        },\n        null,\n        2\n    );\n}\n\n// ========================================\n// Auto-Capture Helpers\n// ========================================\n\n/**\n * Record a tab switch\n * @param fromTab - Previous tab\n * @param toTab - New tab\n */\nexport function recordTabSwitch(fromTab: string, toTab: string): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('tab_switch', `Switched from ${fromTab} to ${toTab}`, { fromTab, toTab }, 'navigation');\n}\n\n/**\n * Record a search action\n * @param query - Search query\n * @param resultCount - Number of results\n */\nexport function recordSearch(query: string, resultCount?: number): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('search', `Searched: \"${query}\"`, { query, resultCount }, 'filter');\n}\n\n/**\n * Record a filter change\n * @param filterName - Filter that changed\n * @param value - New value\n */\nexport function recordFilterChange(filterName: string, value: unknown): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('filter_change', `Filter ${filterName} changed to ${value}`, { filterName, value }, 'filter');\n}\n\n/**\n * Record an item click/selection\n * @param itemId - Item ID\n * @param itemName - Item name\n * @param action - Type of action\n */\nexport function recordItemClick(itemId: string, itemName: string, action: string = 'clicked'): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('item_click', `Item ${action}: ${itemName}`, { itemId, itemName, action }, 'interaction');\n}\n\n/**\n * Record a modal opening\n * @param modalType - Type of modal\n * @param entityId - Related entity ID\n */\nexport function recordModalOpen(modalType: string, entityId?: string): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('modal_open', `Opened ${modalType} modal`, { modalType, entityId }, 'ui');\n}\n\n/**\n * Record a modal closing\n * @param modalType - Type of modal\n */\nexport function recordModalClose(modalType: string): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('modal_close', `Closed ${modalType} modal`, { modalType }, 'ui');\n}\n\n/**\n * Record a build update\n * @param action - Build action type\n * @param details - Additional details\n */\nexport function recordBuildUpdate(action: string, details?: Record<string, unknown>): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('build_update', `Build ${action}`, details, 'build');\n}\n\n/**\n * Record a compare toggle\n * @param itemId - Item ID\n * @param added - Whether item was added or removed\n */\nexport function recordCompareToggle(itemId: string, added: boolean): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb(\n        'compare_toggle',\n        `${added ? 'Added to' : 'Removed from'} compare: ${itemId}`,\n        { itemId, added },\n        'compare'\n    );\n}\n\n/**\n * Record a favorite toggle\n * @param entityId - Entity ID\n * @param entityType - Type of entity\n * @param favorited - Whether favorited or unfavorited\n */\nexport function recordFavoriteToggle(entityId: string, entityType: string, favorited: boolean): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb(\n        'favorite_toggle',\n        `${favorited ? 'Favorited' : 'Unfavorited'} ${entityType}: ${entityId}`,\n        { entityId, entityType, favorited },\n        'favorite'\n    );\n}\n\n/**\n * Record a keyboard shortcut\n * @param shortcut - Shortcut pressed\n * @param action - Action triggered\n */\nexport function recordKeyboardShortcut(shortcut: string, action: string): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('keyboard_shortcut', `Keyboard: ${shortcut}  ${action}`, { shortcut, action }, 'keyboard');\n}\n\n/**\n * Record an error\n * @param error - Error object\n * @param context - Additional context\n */\nexport function recordError(error: Error, context?: string): void {\n    // Always record errors regardless of enableAutoCapture\n    addBreadcrumb(\n        'error',\n        `Error: ${error.message}`,\n        {\n            name: error.name,\n            message: error.message,\n            stack: error.stack,\n            context,\n        },\n        'error'\n    );\n}\n\n/**\n * Record a custom breadcrumb\n * @param message - Custom message\n * @param data - Additional data\n * @param category - Category\n */\nexport function recordCustom(message: string, data?: Record<string, unknown>, category?: string): void {\n    if (!config.enableAutoCapture) return;\n\n    addBreadcrumb('custom', message, data, category);\n}\n\n// ========================================\n// State Snapshot\n// ========================================\n\n/**\n * Capture current application state snapshot\n * Used for error reporting\n * @returns State snapshot with sensitive data redacted\n */\nexport function captureStateSnapshot(): Record<string, unknown> {\n    try {\n        const currentTab = getState('currentTab');\n        const filteredData = getState('filteredData');\n        const currentBuild = getState('currentBuild');\n        const compareItems = getState('compareItems');\n\n        return {\n            timestamp: Date.now(),\n            currentTab,\n            filteredDataCount: filteredData?.length ?? 0,\n            currentBuild: currentBuild\n                ? {\n                      hasCharacter: !!currentBuild.character,\n                      hasWeapon: !!currentBuild.weapon,\n                      tomesCount: currentBuild.tomes?.length ?? 0,\n                      itemsCount: currentBuild.items?.length ?? 0,\n                  }\n                : null,\n            compareItemsCount: compareItems?.length ?? 0,\n            windowSize: {\n                width: typeof window !== 'undefined' ? window.innerWidth : 0,\n                height: typeof window !== 'undefined' ? window.innerHeight : 0,\n            },\n            userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'unknown',\n            online: typeof navigator !== 'undefined' ? navigator.onLine : true,\n            url: typeof window !== 'undefined' ? window.location.href : 'unknown',\n        };\n    } catch (error) {\n        return {\n            timestamp: Date.now(),\n            error: 'Failed to capture state snapshot',\n            message: (error as Error).message,\n        };\n    }\n}\n\n// ========================================\n// Error Report Builder\n// ========================================\n\n/**\n * Build comprehensive error report with breadcrumbs and state\n * @param error - The error that occurred\n * @param context - Additional context\n * @returns Error report object\n */\nexport function buildErrorReport(error: Error, context?: string): Record<string, unknown> {\n    // Record the error as a breadcrumb\n    recordError(error, context);\n\n    return {\n        timestamp: Date.now(),\n        error: {\n            name: error.name,\n            message: error.message,\n            stack: error.stack,\n        },\n        context,\n        stateSnapshot: captureStateSnapshot(),\n        breadcrumbs: getRecentBreadcrumbs(300000), // Last 5 minutes\n        sessionId: logger.getSessionId(),\n    };\n}\n\n// ========================================\n// Integration Helpers\n// ========================================\n\n/**\n * Initialize breadcrumbs with error boundary integration\n */\nexport function initBreadcrumbs(): void {\n    logger.info({\n        operation: 'breadcrumbs.init',\n        data: { maxBreadcrumbs: config.maxBreadcrumbs },\n    });\n}\n\n/**\n * Cleanup breadcrumbs\n */\nexport function cleanupBreadcrumbs(): void {\n    clearBreadcrumbs();\n}\n","// ========================================\n// Error Boundary Module\n// ========================================\n// Provides module-level error recovery and graceful degradation\n// Includes state snapshots and breadcrumb integration\n// ========================================\n\nimport { ToastManager } from './toast.ts';\nimport { logger } from './logger.ts';\nimport { recordError, captureStateSnapshot, getRecentBreadcrumbs, type Breadcrumb } from './breadcrumbs.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Error boundary state\n */\ninterface ErrorBoundary {\n    fallback: ((error: Error) => unknown) | null;\n    errorCount: number;\n    lastError: Error | null;\n}\n\n/**\n * Error boundary options\n */\nexport interface ErrorBoundaryOptions {\n    fallback?: ((error: Error) => unknown) | null;\n    silent?: boolean;\n    maxRetries?: number;\n    onError?: ((error: Error, retries: number) => Promise<void> | void) | null;\n}\n\n/**\n * Module initialization options\n */\nexport interface ModuleInitOptions {\n    required?: boolean;\n    gracefulDegradation?: boolean;\n}\n\n/**\n * Error statistics for a module\n */\nexport interface ErrorStats {\n    errorCount: number;\n    lastError: Error | null;\n}\n\n/**\n * Degraded module result\n */\ninterface DegradedModuleResult {\n    degraded: boolean;\n    error: Error;\n}\n\n/**\n * Enhanced error report with state snapshot and breadcrumbs\n */\nexport interface ErrorReport {\n    timestamp: number;\n    error: {\n        name: string;\n        message: string;\n        stack?: string;\n        module?: string;\n    };\n    stateSnapshot: Record<string, unknown>;\n    breadcrumbs: Breadcrumb[];\n    context?: string;\n    sessionId?: string;\n}\n\n// ========================================\n// Error Boundary State\n// ========================================\n\n/**\n * Error boundary configuration\n */\nconst errorBoundaries = new Map<string, ErrorBoundary>();\n\n/**\n * Register an error boundary for a module\n * @param moduleName - Name of the module\n * @param fallbackFn - Fallback function to execute on error\n */\nexport function registerErrorBoundary(moduleName: string, fallbackFn: (error: Error) => unknown): void {\n    errorBoundaries.set(moduleName, {\n        fallback: fallbackFn,\n        errorCount: 0,\n        lastError: null,\n    });\n}\n\n/**\n * Wrap a function with error boundary protection\n * @param moduleName - Name of the module\n * @param fn - Function to wrap\n * @param options - Configuration options\n * @returns Wrapped function with error handling\n */\nexport function withErrorBoundary<TArgs extends unknown[], TReturn>(\n    moduleName: string,\n    fn: (...args: TArgs) => TReturn,\n    options: ErrorBoundaryOptions = {}\n): (...args: TArgs) => Promise<Awaited<TReturn> | undefined> {\n    const { fallback = null, silent = false, maxRetries = 0, onError = null } = options;\n\n    return async function (...args: TArgs): Promise<Awaited<TReturn> | undefined> {\n        const boundary = errorBoundaries.get(moduleName);\n        let retries = 0;\n\n        while (retries <= maxRetries) {\n            try {\n                return await fn(...args);\n            } catch (error) {\n                const err = error as Error;\n\n                // Record error in breadcrumbs\n                recordError(err, moduleName);\n\n                // Capture state snapshot for debugging\n                const stateSnapshot = captureStateSnapshot();\n                const recentBreadcrumbs = getRecentBreadcrumbs(60000); // Last 60 seconds\n\n                // Log error with wide event including state snapshot\n                logger.error({\n                    operation: 'error.boundary',\n                    error: {\n                        name: err.name,\n                        message: err.message,\n                        stack: err.stack,\n                        module: moduleName,\n                    },\n                    data: {\n                        retries,\n                        maxRetries,\n                        phase: 'caught',\n                        stateSnapshot,\n                        breadcrumbCount: recentBreadcrumbs.length,\n                    },\n                });\n\n                // Update boundary stats\n                if (boundary) {\n                    boundary.errorCount++;\n                    boundary.lastError = err;\n                }\n\n                // Call custom error handler\n                if (onError) {\n                    try {\n                        await onError(err, retries);\n                    } catch (handlerError) {\n                        const hErr = handlerError as Error;\n                        logger.error({\n                            operation: 'error.boundary',\n                            error: {\n                                name: hErr.name,\n                                message: hErr.message,\n                                stack: hErr.stack,\n                                module: moduleName,\n                            },\n                            data: { phase: 'handler_failed' },\n                        });\n                    }\n                }\n\n                // Retry logic\n                if (retries < maxRetries) {\n                    retries++;\n                    const delay = Math.min(1000 * Math.pow(2, retries), 10000);\n                    await new Promise(resolve => setTimeout(resolve, delay));\n                    continue;\n                }\n\n                // Show user notification if not silent\n                if (!silent) {\n                    try {\n                        ToastManager.error(`An error occurred in ${moduleName}. Some features may not work correctly.`);\n                    } catch {\n                        // ToastManager not initialized yet, fail silently\n                    }\n                }\n\n                // Execute fallback\n                if (fallback) {\n                    try {\n                        return (await fallback(err)) as Awaited<TReturn>;\n                    } catch (fallbackError) {\n                        const fErr = fallbackError as Error;\n                        logger.error({\n                            operation: 'error.boundary',\n                            error: {\n                                name: fErr.name,\n                                message: fErr.message,\n                                stack: fErr.stack,\n                                module: moduleName,\n                            },\n                            data: { phase: 'fallback_failed', recoveryAttempted: true, recoverySucceeded: false },\n                        });\n                        // Re-throw fallback error so caller knows recovery failed\n                        throw fErr;\n                    }\n                }\n\n                // Execute registered boundary fallback\n                if (boundary && boundary.fallback) {\n                    try {\n                        return (await boundary.fallback(err)) as Awaited<TReturn>;\n                    } catch (boundaryError) {\n                        const bErr = boundaryError as Error;\n                        logger.error({\n                            operation: 'error.boundary',\n                            error: {\n                                name: bErr.name,\n                                message: bErr.message,\n                                stack: bErr.stack,\n                                module: moduleName,\n                            },\n                            data: {\n                                phase: 'boundary_fallback_failed',\n                                recoveryAttempted: true,\n                                recoverySucceeded: false,\n                            },\n                        });\n                    }\n                }\n\n                // Re-throw if no recovery options\n                throw err;\n            }\n        }\n\n        // Unreachable but TypeScript needs this\n        return undefined;\n    };\n}\n\n/**\n * Wrap module initialization with error boundary\n * @param moduleName - Module name\n * @param initFn - Initialization function\n * @param options - Configuration options\n * @returns Promise resolving to initialization result or degraded mode result\n */\nexport async function safeModuleInit<T = unknown>(\n    moduleName: string,\n    initFn: () => T | Promise<T>,\n    options: ModuleInitOptions = {}\n): Promise<T | DegradedModuleResult | undefined> {\n    const { required = false, gracefulDegradation = true } = options;\n\n    const wrappedInit = withErrorBoundary(moduleName, initFn, {\n        silent: false,\n        maxRetries: 0,\n        fallback: gracefulDegradation\n            ? async (error: Error): Promise<DegradedModuleResult> => {\n                  logger.warn({\n                      operation: 'module.degraded',\n                      error: {\n                          name: error.name,\n                          message: error.message,\n                          stack: error.stack,\n                          module: moduleName,\n                      },\n                      data: { moduleName, gracefulDegradation: true },\n                  });\n                  return { degraded: true, error };\n              }\n            : null,\n        onError: async (error: Error): Promise<void> => {\n            logger.error({\n                operation: 'module.init.failed',\n                error: {\n                    name: error.name,\n                    message: error.message,\n                    stack: error.stack,\n                    module: moduleName,\n                    retriable: true, // Module initialization can often be retried\n                },\n                data: { moduleName, required },\n            });\n\n            if (required) {\n                // Show critical error\n                try {\n                    ToastManager.error(`Critical error: ${moduleName} failed to load. Please refresh the page.`);\n                } catch {\n                    // ToastManager not initialized yet, fail silently\n                }\n            }\n        },\n    });\n\n    return await wrappedInit();\n}\n\n/**\n * Get error stats for a module\n * @param moduleName - Module name\n * @returns Error statistics\n */\nexport function getErrorStats(moduleName: string): ErrorStats {\n    const boundary = errorBoundaries.get(moduleName);\n    if (!boundary) {\n        return { errorCount: 0, lastError: null };\n    }\n    return {\n        errorCount: boundary.errorCount,\n        lastError: boundary.lastError,\n    };\n}\n\n/**\n * Reset error stats for a module\n * @param moduleName - Module name\n */\nexport function resetErrorStats(moduleName: string): void {\n    const boundary = errorBoundaries.get(moduleName);\n    if (boundary) {\n        boundary.errorCount = 0;\n        boundary.lastError = null;\n    }\n}\n\n/**\n * Get all registered error boundaries\n * @returns All error boundaries\n */\nexport function getAllErrorBoundaries(): Map<string, ErrorBoundary> {\n    return new Map(errorBoundaries);\n}\n\n// ========================================\n// Error Report Builder\n// ========================================\n\n/**\n * Build a comprehensive error report with state snapshot and breadcrumbs\n * @param error - The error that occurred\n * @param moduleName - Optional module name where error occurred\n * @returns Complete error report\n */\nexport function buildErrorReport(error: Error, moduleName?: string): ErrorReport {\n    // Record error in breadcrumbs first\n    recordError(error, moduleName);\n\n    const stateSnapshot = captureStateSnapshot();\n    const breadcrumbs = getRecentBreadcrumbs(300000); // Last 5 minutes\n\n    return {\n        timestamp: Date.now(),\n        error: {\n            name: error.name,\n            message: error.message,\n            stack: error.stack,\n            module: moduleName,\n        },\n        stateSnapshot,\n        breadcrumbs,\n        context: moduleName,\n        sessionId: logger.getSessionId(),\n    };\n}\n\n/**\n * Export error report as JSON string for debugging\n * @param error - The error that occurred\n * @param moduleName - Optional module name\n * @returns JSON string of error report\n */\nexport function exportErrorReport(error: Error, moduleName?: string): string {\n    const report = buildErrorReport(error, moduleName);\n    return JSON.stringify(report, null, 2);\n}\n\n// ========================================\n// Global Error Handlers\n// ========================================\n\n/**\n * Initialize global error handlers for uncaught exceptions and rejections\n * Call this once during app initialization\n */\nexport function initGlobalErrorHandlers(): void {\n    // Handle uncaught promise rejections\n    if (typeof window !== 'undefined') {\n        window.addEventListener('unhandledrejection', (event: PromiseRejectionEvent) => {\n            const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));\n\n            // Record error and capture state\n            recordError(error, 'global');\n            const stateSnapshot = captureStateSnapshot();\n            const recentBreadcrumbs = getRecentBreadcrumbs(60000);\n\n            logger.error({\n                operation: 'error.unhandled_rejection',\n                error: {\n                    name: error.name,\n                    message: error.message,\n                    stack: error.stack,\n                },\n                data: {\n                    type: 'unhandledrejection',\n                    prevented: false,\n                    stateSnapshot,\n                    breadcrumbCount: recentBreadcrumbs.length,\n                },\n            });\n\n            // Prevent default browser console error (optional - remove if you want both)\n            // event.preventDefault();\n        });\n\n        // Handle uncaught errors\n        window.addEventListener('error', (event: ErrorEvent) => {\n            const error = event.error || new Error(event.message);\n\n            // Record error and capture state\n            recordError(error, 'global');\n            const stateSnapshot = captureStateSnapshot();\n            const recentBreadcrumbs = getRecentBreadcrumbs(60000);\n\n            logger.error({\n                operation: 'error.uncaught',\n                error: {\n                    name: event.error?.name || 'Error',\n                    message: event.message,\n                    stack: event.error?.stack,\n                },\n                data: {\n                    type: 'error',\n                    filename: event.filename,\n                    lineno: event.lineno,\n                    colno: event.colno,\n                    stateSnapshot,\n                    breadcrumbCount: recentBreadcrumbs.length,\n                },\n            });\n        });\n\n        logger.info({\n            operation: 'error.handlers_initialized',\n            data: { handlers: ['unhandledrejection', 'error'] },\n        });\n    }\n}\n","// ========================================\n// Keyboard Shortcuts Module\n// ========================================\n// Provides keyboard navigation and shortcuts help modal\n// ========================================\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Individual keyboard shortcut definition\n */\ninterface Shortcut {\n    keys: string[];\n    description: string;\n}\n\n/**\n * Shortcut category definition\n */\ninterface ShortcutCategory {\n    category: string;\n    shortcuts: Shortcut[];\n}\n\n// ========================================\n// Module State\n// ========================================\n\n/**\n * Reference to the keydown handler for cleanup\n * We store the handler function so we can remove it later\n */\nlet keydownHandler: ((e: KeyboardEvent) => void) | null = null;\n\n// ========================================\n// Constants\n// ========================================\n\n/**\n * Keyboard shortcut definitions\n */\nconst SHORTCUTS: readonly ShortcutCategory[] = Object.freeze([\n    {\n        category: 'Navigation',\n        shortcuts: [\n            { keys: ['1'], description: 'Switch to Items tab' },\n            { keys: ['2'], description: 'Switch to Weapons tab' },\n            { keys: ['3'], description: 'Switch to Tomes tab' },\n            { keys: ['4'], description: 'Switch to Characters tab' },\n            { keys: ['5'], description: 'Switch to Shrines tab' },\n            { keys: ['6'], description: 'Switch to Build Planner tab' },\n            { keys: ['7'], description: 'Switch to Calculator tab' },\n            { keys: ['8'], description: 'Switch to Changelog tab' },\n        ],\n    },\n    {\n        category: 'Search & Filter',\n        shortcuts: [\n            { keys: ['/'], description: 'Focus search box' },\n            { keys: ['Ctrl', 'F'], description: 'Focus search box (alternative)' },\n            { keys: ['Escape'], description: 'Clear search and focus' },\n            { keys: ['Ctrl', 'K'], description: 'Clear all filters' },\n        ],\n    },\n    {\n        category: 'View',\n        shortcuts: [\n            { keys: ['G'], description: 'Toggle grid view' },\n            { keys: ['L'], description: 'Toggle list view' },\n            { keys: ['C'], description: 'Toggle compare mode' },\n            { keys: ['T'], description: 'Toggle dark/light theme' },\n        ],\n    },\n    {\n        category: 'Modal',\n        shortcuts: [\n            { keys: ['Escape'], description: 'Close modal/dialog' },\n            { keys: ['Enter'], description: 'Confirm action in modal' },\n        ],\n    },\n    {\n        category: 'Help',\n        shortcuts: [\n            { keys: ['?'], description: 'Show keyboard shortcuts' },\n            { keys: ['Shift', '?'], description: 'Show keyboard shortcuts' },\n        ],\n    },\n]);\n\n// ========================================\n// Exported Functions\n// ========================================\n\n/**\n * Show keyboard shortcuts modal\n */\nexport function showShortcutsModal(): void {\n    // Remove existing modal if any\n    const existing = document.getElementById('shortcuts-modal');\n    if (existing) {\n        existing.remove();\n        return;\n    }\n\n    // Create modal\n    const modal = document.createElement('div');\n    modal.id = 'shortcuts-modal';\n    modal.className = 'modal shortcuts-modal';\n\n    const categoriesHtml = SHORTCUTS.map(\n        category => `\n        <div class=\"shortcuts-category\">\n            <h3 class=\"shortcuts-category-title\">${category.category}</h3>\n            <div class=\"shortcuts-list\">\n                ${category.shortcuts\n                    .map(\n                        shortcut => `\n                    <div class=\"shortcut-item\">\n                        <div class=\"shortcut-keys\">\n                            ${shortcut.keys\n                                .map(key => `<kbd class=\"shortcut-key\">${key}</kbd>`)\n                                .join('<span class=\"key-separator\">+</span>')}\n                        </div>\n                        <div class=\"shortcut-description\">${shortcut.description}</div>\n                    </div>\n                `\n                    )\n                    .join('')}\n            </div>\n        </div>\n    `\n    ).join('');\n\n    modal.innerHTML = `\n        <div class=\"modal-content shortcuts-modal-content\">\n            <button class=\"modal-close\" id=\"shortcuts-modal-close\">&times;</button>\n            <div class=\"modal-header\">\n                <h2> Keyboard Shortcuts</h2>\n                <p class=\"modal-subtitle\">Navigate faster with keyboard shortcuts</p>\n            </div>\n            <div class=\"modal-body shortcuts-modal-body\">\n                ${categoriesHtml}\n            </div>\n            <div class=\"modal-footer\">\n                <p class=\"shortcuts-tip\">\n                     Tip: Press <kbd>?</kbd> anytime to toggle this help\n                </p>\n            </div>\n        </div>\n    `;\n\n    document.body.appendChild(modal);\n    \n    // Set display to block first (CSS has display: none by default)\n    modal.style.display = 'block';\n\n    // Use AbortController to clean up all listeners when modal closes\n    const abortController = new AbortController();\n    const { signal } = abortController;\n\n    const closeModal = (): void => {\n        abortController.abort(); // Clean up all listeners\n        modal.classList.remove('active');\n        document.body.classList.remove('modal-open');\n        // Wait for animation before removing\n        setTimeout(() => {\n            modal.remove();\n        }, 300);\n    };\n\n    // Add event listeners with signal for automatic cleanup\n    const closeBtn = document.getElementById('shortcuts-modal-close');\n    if (closeBtn) {\n        closeBtn.addEventListener('click', closeModal, { signal });\n    }\n\n    // Close on backdrop click\n    modal.addEventListener(\n        'click',\n        (e: MouseEvent) => {\n            if (e.target === modal) {\n                closeModal();\n            }\n        },\n        { signal }\n    );\n\n    // Close on Escape\n    document.addEventListener(\n        'keydown',\n        (e: KeyboardEvent) => {\n            if (e.key === 'Escape') {\n                closeModal();\n            }\n        },\n        { signal }\n    );\n\n    // Show modal with animation\n    requestAnimationFrame(() => {\n        modal.classList.add('active');\n        // Prevent body scroll on mobile when modal is open\n        document.body.classList.add('modal-open');\n    });\n}\n\n/**\n * Clean up keyboard shortcut event listeners\n * Call this in test teardown or when unmounting\n */\nexport function cleanupKeyboardShortcuts(): void {\n    if (keydownHandler) {\n        document.removeEventListener('keydown', keydownHandler);\n        keydownHandler = null;\n    }\n}\n\n/**\n * Setup keyboard shortcut handlers\n */\nexport function setupKeyboardShortcuts(): void {\n    // Clean up existing listener first to prevent stacking\n    cleanupKeyboardShortcuts();\n\n    keydownHandler = (e: KeyboardEvent) => {\n        // Ignore shortcuts when typing in inputs\n        const target = e.target as HTMLElement;\n        if (target && target.matches && target.matches('input, textarea, select')) {\n            return;\n        }\n\n        // Help modal toggle\n        if (e.key === '?' || (e.shiftKey && e.key === '?')) {\n            e.preventDefault();\n            showShortcutsModal();\n            return;\n        }\n\n        // Tab navigation (1-9)\n        if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey) {\n            e.preventDefault();\n            const tabs = [\n                'items',\n                'weapons',\n                'tomes',\n                'characters',\n                'shrines',\n                'build-planner',\n                'calculator',\n                'advisor',\n                'changelog',\n            ];\n            const tabIndex = parseInt(e.key) - 1;\n            const tabBtn = document.querySelector<HTMLElement>(`[data-tab=\"${tabs[tabIndex]}\"]`);\n            if (tabBtn) {\n                tabBtn.click();\n            }\n            return;\n        }\n\n        // Search focus\n        if (e.key === '/' || (e.ctrlKey && e.key === 'f')) {\n            e.preventDefault();\n            const searchInput = document.getElementById('searchInput') as HTMLInputElement | null;\n            if (searchInput) {\n                searchInput.focus();\n                searchInput.select();\n            }\n            return;\n        }\n\n        // Clear filters\n        if (e.ctrlKey && e.key === 'k') {\n            e.preventDefault();\n            const clearBtn = document.querySelector<HTMLElement>('[onclick=\"clearFilters()\"]');\n            if (clearBtn) {\n                clearBtn.click();\n            }\n            return;\n        }\n\n        // Escape - clear search and focus\n        if (e.key === 'Escape') {\n            const searchInput = document.getElementById('searchInput') as HTMLInputElement | null;\n            if (searchInput && searchInput.value) {\n                e.preventDefault();\n                searchInput.value = '';\n                searchInput.dispatchEvent(new Event('input', { bubbles: true }));\n                searchInput.blur();\n            }\n            return;\n        }\n\n        // View toggles\n        if (e.key.toLowerCase() === 'g') {\n            e.preventDefault();\n            const gridBtn = document.querySelector<HTMLElement>('[data-view=\"grid\"]');\n            if (gridBtn) {\n                gridBtn.click();\n            }\n            return;\n        }\n\n        if (e.key.toLowerCase() === 'l') {\n            e.preventDefault();\n            const listBtn = document.querySelector<HTMLElement>('[data-view=\"list\"]');\n            if (listBtn) {\n                listBtn.click();\n            }\n            return;\n        }\n\n        if (e.key.toLowerCase() === 'c') {\n            e.preventDefault();\n            const compareBtn = document.getElementById('compare-mode-toggle');\n            if (compareBtn) {\n                compareBtn.click();\n            }\n            return;\n        }\n\n        // Theme toggle\n        if (e.key.toLowerCase() === 't') {\n            e.preventDefault();\n            const themeBtn = document.getElementById('theme-toggle');\n            if (themeBtn) {\n                themeBtn.click();\n            }\n            return;\n        }\n    };\n\n    document.addEventListener('keydown', keydownHandler);\n}\n\n/**\n * Get all registered shortcuts\n * @returns All shortcuts\n */\nexport function getAllShortcuts(): readonly ShortcutCategory[] {\n    return SHORTCUTS;\n}\n","// ========================================\n// Theme Manager Module\n// ========================================\n// Handles dark/light theme switching with localStorage persistence\n// ========================================\n\nimport type { Theme } from '../types/index.ts';\nimport { logger } from './logger.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Theme CSS variables map\n */\ninterface ThemeVariables {\n    '--rarity-common': string;\n    '--rarity-uncommon': string;\n    '--rarity-rare': string;\n    '--rarity-epic': string;\n    '--rarity-legendary': string;\n    '--bg-primary': string;\n    '--bg-elevated': string;\n    '--bg-subtle': string;\n    '--text-primary': string;\n    '--text-secondary': string;\n    '--accent': string;\n    '--accent-hover': string;\n    '--chart-line': string;\n    '--chart-fill': string;\n    '--chart-grid': string;\n    '--chart-text': string;\n    '--tier-ss': string;\n    '--tier-s': string;\n    '--tier-a': string;\n    '--tier-b': string;\n    '--tier-c': string;\n}\n\n/**\n * Theme constants record\n */\ninterface ThemeConstants {\n    DARK: 'dark';\n    LIGHT: 'light';\n}\n\n// ========================================\n// Constants\n// ========================================\n\n/**\n * Theme constants\n */\nconst THEMES: Readonly<ThemeConstants> = Object.freeze({\n    DARK: 'dark',\n    LIGHT: 'light',\n});\n\nconst STORAGE_KEY = 'megabonk-theme';\n\n/**\n * Light theme CSS variables\n */\nconst LIGHT_THEME: Readonly<ThemeVariables> = Object.freeze({\n    // Rarity colors (adjusted for light mode)\n    '--rarity-common': '#4a7c4a',\n    '--rarity-uncommon': '#2a8ca0',\n    '--rarity-rare': '#9c2db0',\n    '--rarity-epic': '#6b3cc6',\n    '--rarity-legendary': '#c08000',\n\n    // Backgrounds\n    '--bg-primary': '#ffffff',\n    '--bg-elevated': '#f5f5f5',\n    '--bg-subtle': '#e5e5e5',\n\n    // Text\n    '--text-primary': '#1a1a1a',\n    '--text-secondary': '#666666',\n\n    // Interactive\n    '--accent': '#d62f4a',\n    '--accent-hover': '#c91d38',\n\n    // Chart colors\n    '--chart-line': '#d62f4a',\n    '--chart-fill': 'rgba(214, 47, 74, 0.1)',\n    '--chart-grid': 'rgba(0, 0, 0, 0.1)',\n    '--chart-text': '#666666',\n\n    // Tier colors (same as dark mode)\n    '--tier-ss': '#ffd700',\n    '--tier-s': '#22c55e',\n    '--tier-a': '#3b82f6',\n    '--tier-b': '#f59e0b',\n    '--tier-c': '#ef4444',\n});\n\n/**\n * Dark theme CSS variables (default)\n */\nconst DARK_THEME: Readonly<ThemeVariables> = Object.freeze({\n    '--rarity-common': '#6b9b6b',\n    '--rarity-uncommon': '#5bb8d0',\n    '--rarity-rare': '#c94de0',\n    '--rarity-epic': '#8b5cf6',\n    '--rarity-legendary': '#f0a800',\n\n    '--bg-primary': '#0f0f14',\n    '--bg-elevated': '#1a1a24',\n    '--bg-subtle': '#252530',\n\n    '--text-primary': '#ffffff',\n    '--text-secondary': '#8b8b9b',\n\n    '--accent': '#e94560',\n    '--accent-hover': '#ff6b8a',\n\n    '--chart-line': '#e94560',\n    '--chart-fill': 'rgba(233, 69, 96, 0.2)',\n    '--chart-grid': 'rgba(255, 255, 255, 0.1)',\n    '--chart-text': '#8b8b9b',\n\n    '--tier-ss': '#ffd700',\n    '--tier-s': '#22c55e',\n    '--tier-a': '#3b82f6',\n    '--tier-b': '#f59e0b',\n    '--tier-c': '#ef4444',\n});\n\n// ========================================\n// ThemeManager Class\n// ========================================\n\n/**\n * ThemeManager class\n */\nclass ThemeManager {\n    private currentTheme: Theme;\n\n    constructor() {\n        this.currentTheme = this.getStoredTheme() || this.getSystemTheme();\n    }\n\n    /**\n     * Get stored theme from localStorage\n     * @returns Stored theme or null\n     */\n    getStoredTheme(): Theme | null {\n        try {\n            const stored = localStorage.getItem(STORAGE_KEY);\n            if (stored === 'dark' || stored === 'light') {\n                return stored as Theme;\n            }\n            return null;\n        } catch (error) {\n            // localStorage may be unavailable in some contexts (private browsing, etc.)\n            console.debug('[theme-manager] localStorage unavailable for reading theme:', (error as Error).message);\n            return null;\n        }\n    }\n\n    /**\n     * Get system theme preference\n     * @returns System theme (dark or light)\n     */\n    getSystemTheme(): Theme {\n        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {\n            return THEMES.DARK;\n        }\n        return THEMES.LIGHT;\n    }\n\n    /**\n     * Apply theme variables to document\n     * @param theme - Theme to apply\n     */\n    applyTheme(theme: Theme): void {\n        const root = document.documentElement;\n        const themeVars = theme === THEMES.LIGHT ? LIGHT_THEME : DARK_THEME;\n\n        Object.entries(themeVars).forEach(([property, value]) => {\n            root.style.setProperty(property, value);\n        });\n\n        // Update data-theme attribute\n        root.setAttribute('data-theme', theme);\n\n        // Update current theme\n        this.currentTheme = theme;\n\n        // Store preference\n        try {\n            localStorage.setItem(STORAGE_KEY, theme);\n        } catch (error) {\n            logger.warn({\n                operation: 'theme.storage',\n                error: { name: 'StorageError', message: 'Failed to store theme preference', module: 'theme-manager' },\n            });\n        }\n    }\n\n    /**\n     * Toggle between dark and light themes\n     * @returns New theme\n     */\n    toggleTheme(): Theme {\n        const newTheme: Theme = this.currentTheme === THEMES.DARK ? THEMES.LIGHT : THEMES.DARK;\n        this.applyTheme(newTheme);\n        return newTheme;\n    }\n\n    /**\n     * Set specific theme\n     * @param theme - Theme to set\n     */\n    setTheme(theme: Theme): void {\n        if (theme === THEMES.DARK || theme === THEMES.LIGHT) {\n            this.applyTheme(theme);\n        }\n    }\n\n    /**\n     * Get current theme\n     * @returns Current theme\n     */\n    getTheme(): Theme {\n        return this.currentTheme;\n    }\n\n    /**\n     * Initialize theme manager\n     */\n    init(): void {\n        // Apply initial theme\n        this.applyTheme(this.currentTheme);\n\n        // Listen for system theme changes\n        if (window.matchMedia) {\n            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e: MediaQueryListEvent) => {\n                // Only auto-switch if no user preference is stored\n                if (!this.getStoredTheme()) {\n                    const newTheme: Theme = e.matches ? THEMES.DARK : THEMES.LIGHT;\n                    this.applyTheme(newTheme);\n                }\n            });\n        }\n\n        // Create and add theme toggle button\n        this.createThemeToggleButton();\n    }\n\n    /**\n     * Create theme toggle button in UI\n     */\n    createThemeToggleButton(): void {\n        // Check if button already exists\n        if (document.getElementById('theme-toggle')) {\n            return;\n        }\n\n        // Create button\n        const button = document.createElement('button');\n        button.id = 'theme-toggle';\n        button.className = 'theme-toggle';\n        button.setAttribute('aria-label', 'Toggle theme');\n        button.setAttribute('title', 'Toggle dark/light theme (T)');\n\n        // Update button content based on current theme\n        const updateButtonContent = (): void => {\n            button.innerHTML =\n                this.currentTheme === THEMES.DARK\n                    ? '' // Sun for light mode\n                    : ''; // Moon for dark mode\n        };\n\n        updateButtonContent();\n\n        // Add click handler\n        button.addEventListener('click', () => {\n            this.toggleTheme();\n            updateButtonContent();\n        });\n\n        // Add to page (top-right corner)\n        document.body.appendChild(button);\n    }\n}\n\n// ========================================\n// Exports\n// ========================================\n\n// Create singleton instance\nconst themeManager = new ThemeManager();\n\n// Export singleton instance\nexport { themeManager, THEMES };\n","let e=-1;const t=t=>{addEventListener(\"pageshow\",(n=>{n.persisted&&(e=n.timeStamp,t(n))}),!0)},n=(e,t,n,i)=>{let s,o;return r=>{t.value>=0&&(r||i)&&(o=t.value-(s??0),(o||void 0===s)&&(s=t.value,t.delta=o,t.rating=((e,t)=>e>t[1]?\"poor\":e>t[0]?\"needs-improvement\":\"good\")(t.value,n),e(t)))}},i=e=>{requestAnimationFrame((()=>requestAnimationFrame((()=>e()))))},s=()=>{const e=performance.getEntriesByType(\"navigation\")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},o=()=>{const e=s();return e?.activationStart??0},r=(t,n=-1)=>{const i=s();let r=\"navigate\";e>=0?r=\"back-forward-cache\":i&&(document.prerendering||o()>0?r=\"prerender\":document.wasDiscarded?r=\"restore\":i.type&&(r=i.type.replace(/_/g,\"-\")));return{name:t,value:n,rating:\"good\",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:r}},c=new WeakMap;function a(e,t){return c.get(e)||c.set(e,new t),c.get(e)}class d{t;i=0;o=[];h(e){if(e.hadRecentInput)return;const t=this.o[0],n=this.o.at(-1);this.i&&t&&n&&e.startTime-n.startTime<1e3&&e.startTime-t.startTime<5e3?(this.i+=e.value,this.o.push(e)):(this.i=e.value,this.o=[e]),this.t?.(e)}}const h=(e,t,n={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){const i=new PerformanceObserver((e=>{Promise.resolve().then((()=>{t(e.getEntries())}))}));return i.observe({type:e,buffered:!0,...n}),i}}catch{}},f=e=>{let t=!1;return()=>{t||(e(),t=!0)}};let u=-1;const l=new Set,m=()=>\"hidden\"!==document.visibilityState||document.prerendering?1/0:0,p=e=>{if(\"hidden\"===document.visibilityState){if(\"visibilitychange\"===e.type)for(const e of l)e();isFinite(u)||(u=\"visibilitychange\"===e.type?e.timeStamp:0,removeEventListener(\"prerenderingchange\",p,!0))}},v=()=>{if(u<0){const e=o(),n=document.prerendering?void 0:globalThis.performance.getEntriesByType(\"visibility-state\").filter((t=>\"hidden\"===t.name&&t.startTime>e))[0]?.startTime;u=n??m(),addEventListener(\"visibilitychange\",p,!0),addEventListener(\"prerenderingchange\",p,!0),t((()=>{setTimeout((()=>{u=m()}))}))}return{get firstHiddenTime(){return u},onHidden(e){l.add(e)}}},g=e=>{document.prerendering?addEventListener(\"prerenderingchange\",(()=>e()),!0):e()},y=[1800,3e3],E=(e,s={})=>{g((()=>{const c=v();let a,d=r(\"FCP\");const f=h(\"paint\",(e=>{for(const t of e)\"first-contentful-paint\"===t.name&&(f.disconnect(),t.startTime<c.firstHiddenTime&&(d.value=Math.max(t.startTime-o(),0),d.entries.push(t),a(!0)))}));f&&(a=n(e,d,y,s.reportAllChanges),t((t=>{d=r(\"FCP\"),a=n(e,d,y,s.reportAllChanges),i((()=>{d.value=performance.now()-t.timeStamp,a(!0)}))})))}))},b=[.1,.25],L=(e,s={})=>{const o=v();E(f((()=>{let c,f=r(\"CLS\",0);const u=a(s,d),l=e=>{for(const t of e)u.h(t);u.i>f.value&&(f.value=u.i,f.entries=u.o,c())},m=h(\"layout-shift\",l);m&&(c=n(e,f,b,s.reportAllChanges),o.onHidden((()=>{l(m.takeRecords()),c(!0)})),t((()=>{u.i=0,f=r(\"CLS\",0),c=n(e,f,b,s.reportAllChanges),i((()=>c()))})),setTimeout(c))})))};let P=0,T=1/0,_=0;const M=e=>{for(const t of e)t.interactionId&&(T=Math.min(T,t.interactionId),_=Math.max(_,t.interactionId),P=_?(_-T)/7+1:0)};let w;const C=()=>w?P:performance.interactionCount??0,I=()=>{\"interactionCount\"in performance||w||(w=h(\"event\",M,{type:\"event\",buffered:!0,durationThreshold:0}))};let F=0;class k{u=[];l=new Map;m;p;v(){F=C(),this.u.length=0,this.l.clear()}L(){const e=Math.min(this.u.length-1,Math.floor((C()-F)/50));return this.u[e]}h(e){if(this.m?.(e),!e.interactionId&&\"first-input\"!==e.entryType)return;const t=this.u.at(-1);let n=this.l.get(e.interactionId);if(n||this.u.length<10||e.duration>t.P){if(n?e.duration>n.P?(n.entries=[e],n.P=e.duration):e.duration===n.P&&e.startTime===n.entries[0].startTime&&n.entries.push(e):(n={id:e.interactionId,entries:[e],P:e.duration},this.l.set(n.id,n),this.u.push(n)),this.u.sort(((e,t)=>t.P-e.P)),this.u.length>10){const e=this.u.splice(10);for(const t of e)this.l.delete(t.id)}this.p?.(n)}}}const A=e=>{const t=globalThis.requestIdleCallback||setTimeout;\"hidden\"===document.visibilityState?e():(e=f(e),addEventListener(\"visibilitychange\",e,{once:!0,capture:!0}),t((()=>{e(),removeEventListener(\"visibilitychange\",e,{capture:!0})})))},B=[200,500],S=(e,i={})=>{if(!globalThis.PerformanceEventTiming||!(\"interactionId\"in PerformanceEventTiming.prototype))return;const s=v();g((()=>{I();let o,c=r(\"INP\");const d=a(i,k),f=e=>{A((()=>{for(const t of e)d.h(t);const t=d.L();t&&t.P!==c.value&&(c.value=t.P,c.entries=t.entries,o())}))},u=h(\"event\",f,{durationThreshold:i.durationThreshold??40});o=n(e,c,B,i.reportAllChanges),u&&(u.observe({type:\"first-input\",buffered:!0}),s.onHidden((()=>{f(u.takeRecords()),o(!0)})),t((()=>{d.v(),c=r(\"INP\"),o=n(e,c,B,i.reportAllChanges)})))}))};class N{m;h(e){this.m?.(e)}}const q=[2500,4e3],x=(e,s={})=>{g((()=>{const c=v();let d,u=r(\"LCP\");const l=a(s,N),m=e=>{s.reportAllChanges||(e=e.slice(-1));for(const t of e)l.h(t),t.startTime<c.firstHiddenTime&&(u.value=Math.max(t.startTime-o(),0),u.entries=[t],d())},p=h(\"largest-contentful-paint\",m);if(p){d=n(e,u,q,s.reportAllChanges);const o=f((()=>{m(p.takeRecords()),p.disconnect(),d(!0)})),c=e=>{e.isTrusted&&(A(o),removeEventListener(e.type,c,{capture:!0}))};for(const e of[\"keydown\",\"click\",\"visibilitychange\"])addEventListener(e,c,{capture:!0});t((t=>{u=r(\"LCP\"),d=n(e,u,q,s.reportAllChanges),i((()=>{u.value=performance.now()-t.timeStamp,d(!0)}))}))}}))},H=[800,1800],O=e=>{document.prerendering?g((()=>O(e))):\"complete\"!==document.readyState?addEventListener(\"load\",(()=>O(e)),!0):setTimeout(e)},$=(e,i={})=>{let c=r(\"TTFB\"),a=n(e,c,H,i.reportAllChanges);O((()=>{const d=s();d&&(c.value=Math.max(d.responseStart-o(),0),c.entries=[d],a(!0),t((()=>{c=r(\"TTFB\",0),a=n(e,c,H,i.reportAllChanges),a(!0)})))}))};export{b as CLSThresholds,y as FCPThresholds,B as INPThresholds,q as LCPThresholds,H as TTFBThresholds,L as onCLS,E as onFCP,S as onINP,x as onLCP,$ as onTTFB};\n","// ========================================\n// Web Vitals Monitoring Module\n// ========================================\n// Tracks Core Web Vitals: CLS, FCP, LCP, TTFB, INP\n// (Note: INP replaced FID in web-vitals v4+)\n// ========================================\n\nimport { onCLS, onFCP, onLCP, onTTFB, onINP, type Metric as WebVitalsMetric } from 'web-vitals';\nimport type { MetricName, MetricRating, StoredMetric } from '../types/index.ts';\nimport { logger } from './logger.ts';\n\n// ========================================\n// Type Definitions\n// ========================================\n\n/**\n * Threshold configuration for a metric\n */\ninterface MetricThreshold {\n    good: number;\n    needsImprovement: number;\n}\n\n/**\n * All metric thresholds\n */\ninterface Thresholds {\n    LCP: MetricThreshold;\n    CLS: MetricThreshold;\n    FCP: MetricThreshold;\n    TTFB: MetricThreshold;\n    INP: MetricThreshold;\n}\n\n/**\n * Stored metrics collection\n */\ninterface MetricsCollection {\n    CLS: StoredMetric | null;\n    FCP: StoredMetric | null;\n    LCP: StoredMetric | null;\n    TTFB: StoredMetric | null;\n    INP: StoredMetric | null;\n}\n\n/**\n * Global gtag function declaration\n */\ndeclare global {\n    const gtag: ((command: string, eventName: string, params: Record<string, unknown>) => void) | undefined;\n}\n\n// ========================================\n// Constants\n// ========================================\n\n/**\n * Web Vitals thresholds (in milliseconds or score)\n */\nconst THRESHOLDS: Readonly<Thresholds> = Object.freeze({\n    // Largest Contentful Paint\n    LCP: {\n        good: 2500,\n        needsImprovement: 4000,\n    },\n    // Cumulative Layout Shift (score, not ms)\n    CLS: {\n        good: 0.1,\n        needsImprovement: 0.25,\n    },\n    // First Contentful Paint\n    FCP: {\n        good: 1800,\n        needsImprovement: 3000,\n    },\n    // Time to First Byte\n    TTFB: {\n        good: 800,\n        needsImprovement: 1800,\n    },\n    // Interaction to Next Paint (replaces FID)\n    INP: {\n        good: 200,\n        needsImprovement: 500,\n    },\n});\n\n/**\n * Store collected metrics\n */\nconst metrics: MetricsCollection = {\n    CLS: null,\n    FCP: null,\n    LCP: null,\n    TTFB: null,\n    INP: null,\n};\n\n// ========================================\n// Helper Functions\n// ========================================\n\n/**\n * Get rating for a metric value (utility function for custom use)\n * @param name - Metric name\n * @param value - Metric value\n * @returns Rating: 'good', 'needs-improvement', 'poor', or 'unknown'\n */\nexport function getRating(name: MetricName, value: number): MetricRating {\n    const threshold = THRESHOLDS[name];\n    if (!threshold) return 'unknown';\n\n    if (value <= threshold.good) return 'good';\n    if (value <= threshold.needsImprovement) return 'needs-improvement';\n    return 'poor';\n}\n\n/**\n * Format metric value for display\n * @param name - Metric name\n * @param value - Metric value\n * @returns Formatted value\n */\nfunction formatValue(name: MetricName, value: number): string {\n    if (name === 'CLS') {\n        return value.toFixed(3);\n    }\n    return `${Math.round(value)}ms`;\n}\n\n/**\n * Log metric to console\n * @param metric - Web Vitals metric object\n */\nfunction logMetric(metric: WebVitalsMetric): void {\n    const { name, value, rating, delta, id } = metric;\n    const formattedValue = formatValue(name as MetricName, value);\n    const emoji = rating === 'good' ? '' : rating === 'needs-improvement' ? '' : '';\n\n    console.log(`[Web Vitals] ${emoji} ${name}: ${formattedValue} (${rating})`);\n\n    // Store metric\n    metrics[name as MetricName] = {\n        value,\n        rating: rating as MetricRating,\n        formattedValue,\n        delta,\n        id,\n    };\n}\n\n/**\n * Send metric to analytics (placeholder)\n * Replace this with your actual analytics integration (Google Analytics, Plausible, etc.)\n * @param metric - Web Vitals metric object\n */\nfunction sendToAnalytics(metric: WebVitalsMetric): void {\n    // Example: Google Analytics 4\n    if (typeof gtag !== 'undefined') {\n        gtag('event', metric.name, {\n            value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value),\n            metric_id: metric.id,\n            metric_value: metric.value,\n            metric_delta: metric.delta,\n            metric_rating: metric.rating,\n        });\n    }\n\n    // Example: Custom analytics endpoint\n    // fetch('/api/analytics/web-vitals', {\n    //     method: 'POST',\n    //     headers: { 'Content-Type': 'application/json' },\n    //     body: JSON.stringify({\n    //         name: metric.name,\n    //         value: metric.value,\n    //         rating: metric.rating,\n    //         delta: metric.delta,\n    //         id: metric.id,\n    //         url: window.location.href,\n    //         userAgent: navigator.userAgent\n    //     })\n    // }).catch(err => console.error('Failed to send analytics:', err));\n}\n\n/**\n * Handle metric callback\n * @param metric - Web Vitals metric object\n */\nfunction handleMetric(metric: WebVitalsMetric): void {\n    logMetric(metric);\n    sendToAnalytics(metric);\n}\n\n// ========================================\n// Exported Functions\n// ========================================\n\n/**\n * Initialize Web Vitals monitoring\n */\nexport function initWebVitals(): void {\n    try {\n        // Track Core Web Vitals\n        onCLS(handleMetric);\n        onFCP(handleMetric);\n        onLCP(handleMetric);\n        onTTFB(handleMetric);\n        onINP(handleMetric); // Replaces deprecated FID metric\n\n        logger.info({\n            operation: 'webvitals.init',\n            data: { status: 'initialized' },\n        });\n\n        // Log summary after page load\n        window.addEventListener('load', () => {\n            setTimeout(() => {\n                logSummary();\n            }, 3000); // Wait 3s for metrics to be collected\n        });\n    } catch (error) {\n        const err = error as Error;\n        logger.error({\n            operation: 'webvitals.init',\n            error: { name: err.name, message: err.message },\n        });\n    }\n}\n\n/**\n * Get all collected metrics\n * @returns All metrics\n */\nexport function getMetrics(): MetricsCollection {\n    return { ...metrics };\n}\n\n/**\n * Log summary of all metrics\n */\nexport function logSummary(): void {\n    console.groupCollapsed('[Web Vitals] Performance Summary');\n\n    const collectedMetrics = Object.entries(metrics).filter(([_, value]) => value !== null) as Array<\n        [MetricName, StoredMetric]\n    >;\n\n    if (collectedMetrics.length === 0) {\n        console.log('No metrics collected yet');\n        console.groupEnd();\n        return;\n    }\n\n    collectedMetrics.forEach(([name, data]) => {\n        const emoji = data.rating === 'good' ? '' : data.rating === 'needs-improvement' ? '' : '';\n        console.log(`${emoji} ${name}: ${data.formattedValue} (${data.rating})`);\n    });\n\n    // Overall score\n    const goodCount = collectedMetrics.filter(([_, data]) => data.rating === 'good').length;\n    const total = collectedMetrics.length;\n    const score = Math.round((goodCount / total) * 100);\n\n    console.log(`\\nOverall Score: ${score}% (${goodCount}/${total} metrics good)`);\n    console.groupEnd();\n}\n\n/**\n * Create performance badge UI element\n * Shows a small badge with the overall performance score\n */\nexport function createPerformanceBadge(): void {\n    // Wait for metrics to be collected\n    setTimeout(() => {\n        const badge = document.createElement('div');\n        badge.id = 'perf-badge';\n        badge.className = 'perf-badge';\n        badge.style.cssText = `\n            position: fixed;\n            bottom: 1rem;\n            left: 1rem;\n            padding: 0.5rem 1rem;\n            background: var(--bg-elevated);\n            border: 1px solid var(--bg-subtle);\n            border-radius: 0.5rem;\n            font-size: 0.75rem;\n            color: var(--text-secondary);\n            cursor: pointer;\n            z-index: 998;\n            transition: all 0.3s;\n            opacity: 0.7;\n        `;\n\n        const collectedMetrics = Object.entries(metrics).filter(([_, value]) => value !== null) as Array<\n            [MetricName, StoredMetric]\n        >;\n        const goodCount = collectedMetrics.filter(([_, data]) => data.rating === 'good').length;\n        const total = collectedMetrics.length;\n        const score = total > 0 ? Math.round((goodCount / total) * 100) : 0;\n\n        const emoji = score >= 80 ? '' : score >= 60 ? '' : '';\n        badge.textContent = `${emoji} Perf: ${score}%`;\n        badge.title = 'Click to view Web Vitals details';\n\n        badge.addEventListener('click', () => {\n            logSummary();\n        });\n\n        badge.addEventListener('mouseenter', () => {\n            badge.style.opacity = '1';\n        });\n\n        badge.addEventListener('mouseleave', () => {\n            badge.style.opacity = '0.7';\n        });\n\n        // Only show in development mode\n        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {\n            document.body.appendChild(badge);\n        }\n    }, 3000);\n}\n\n// Export thresholds for reference\nexport { THRESHOLDS };\n","// ========================================\n// Mobile Bottom Navigation Module\n// ========================================\n// Provides a thumb-friendly bottom navigation for mobile users\n// with an accessible slide-up \"More\" drawer\n// ========================================\n\nimport { getState, setState, subscribe, type TabName } from './store.ts';\nimport { safeGetElementById, safeQuerySelector, safeQuerySelectorAll } from './utils.ts';\nimport { logger } from './logger.ts';\n\n// ========================================\n// Types\n// ========================================\n\ninterface MoreMenuConfig {\n    tab: string;\n    label: string;\n    icon: string;\n}\n\n// ========================================\n// Constants\n// ========================================\n\nconst MORE_MENU_TABS: MoreMenuConfig[] = [\n    { tab: 'build-planner', label: 'Build', icon: '' },\n    { tab: 'advisor', label: 'Advisor', icon: '' },\n    { tab: 'characters', label: 'Characters', icon: '' },\n    { tab: 'calculator', label: 'Calculator', icon: '' },\n    { tab: 'changelog', label: 'Changelog', icon: '' },\n    { tab: 'about', label: 'About', icon: '' },\n];\n\nconst MORE_TAB_NAMES = MORE_MENU_TABS.map(t => t.tab);\n\n// ========================================\n// State\n// ========================================\n\nlet isMenuOpen = false;\nlet previouslyFocusedElement: HTMLElement | null = null;\nlet focusableElements: HTMLElement[] = [];\n\n// ========================================\n// More Menu Component\n// ========================================\n\n/**\n * Create the \"More\" menu drawer HTML\n */\nfunction createMoreMenu(): HTMLElement {\n    const menu = document.createElement('div');\n    menu.id = 'more-menu';\n    menu.className = 'more-menu';\n    menu.setAttribute('role', 'dialog');\n    menu.setAttribute('aria-modal', 'true');\n    menu.setAttribute('aria-label', 'Additional navigation tabs');\n\n    const currentTab = getState('currentTab');\n\n    menu.innerHTML = `\n        <div class=\"more-menu-backdrop\" aria-hidden=\"true\"></div>\n        <div class=\"more-menu-drawer\" role=\"document\">\n            <div class=\"more-menu-handle\" aria-hidden=\"true\"></div>\n            <div class=\"more-menu-header\">\n                <span class=\"more-menu-title\" id=\"more-menu-title\">More Options</span>\n                <button class=\"more-menu-close\" aria-label=\"Close menu\" type=\"button\">\n                    <span aria-hidden=\"true\"></span>\n                </button>\n            </div>\n            <div class=\"more-menu-items\" role=\"menu\" aria-labelledby=\"more-menu-title\">\n                ${MORE_MENU_TABS.map(({ tab, label, icon }) => `\n                    <button \n                        class=\"more-menu-item${currentTab === tab ? ' current' : ''}\" \n                        data-tab=\"${tab}\" \n                        role=\"menuitem\"\n                        tabindex=\"0\"\n                        aria-current=\"${currentTab === tab ? 'page' : 'false'}\"\n                    >\n                        <span class=\"menu-icon\" aria-hidden=\"true\">${icon}</span>\n                        <span class=\"menu-label\">${label}</span>\n                    </button>\n                `).join('')}\n            </div>\n        </div>\n    `;\n\n    return menu;\n}\n\n/**\n * Update menu items to reflect current tab\n */\nfunction updateMenuItems(currentTab: string): void {\n    const menu = safeGetElementById('more-menu');\n    if (!menu) return;\n\n    const items = menu.querySelectorAll('.more-menu-item');\n    items.forEach(item => {\n        const btn = item as HTMLElement;\n        const tab = btn.dataset.tab;\n        const isCurrent = tab === currentTab;\n        \n        btn.classList.toggle('current', isCurrent);\n        btn.setAttribute('aria-current', isCurrent ? 'page' : 'false');\n    });\n}\n\n/**\n * Get all focusable elements within the menu\n */\nfunction getFocusableElements(): HTMLElement[] {\n    const menu = safeGetElementById('more-menu');\n    if (!menu) return [];\n\n    return Array.from(\n        menu.querySelectorAll<HTMLElement>(\n            'button:not([disabled]), [tabindex]:not([tabindex=\"-1\"])'\n        )\n    ).filter(el => el.offsetParent !== null); // Filter out hidden elements\n}\n\n/**\n * Trap focus within the menu\n */\nfunction handleFocusTrap(e: KeyboardEvent): void {\n    if (e.key !== 'Tab' || !isMenuOpen) return;\n\n    focusableElements = getFocusableElements();\n    if (focusableElements.length === 0) return;\n\n    const firstElement = focusableElements[0];\n    const lastElement = focusableElements[focusableElements.length - 1];\n\n    if (e.shiftKey) {\n        // Shift + Tab: moving backwards\n        if (document.activeElement === firstElement) {\n            e.preventDefault();\n            lastElement?.focus();\n        }\n    } else {\n        // Tab: moving forwards\n        if (document.activeElement === lastElement) {\n            e.preventDefault();\n            firstElement?.focus();\n        }\n    }\n}\n\n/**\n * Handle keyboard navigation within menu\n */\nfunction handleKeyboardNavigation(e: KeyboardEvent): void {\n    if (!isMenuOpen) return;\n\n    const menu = safeGetElementById('more-menu');\n    if (!menu) return;\n\n    switch (e.key) {\n        case 'Escape':\n            e.preventDefault();\n            hideMoreMenu();\n            break;\n\n        case 'ArrowDown':\n        case 'ArrowRight': {\n            e.preventDefault();\n            const items = Array.from(menu.querySelectorAll('.more-menu-item')) as HTMLElement[];\n            const currentIndex = items.findIndex(item => item === document.activeElement);\n            const nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;\n            items[nextIndex]?.focus();\n            break;\n        }\n\n        case 'ArrowUp':\n        case 'ArrowLeft': {\n            e.preventDefault();\n            const items = Array.from(menu.querySelectorAll('.more-menu-item')) as HTMLElement[];\n            const currentIndex = items.findIndex(item => item === document.activeElement);\n            const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;\n            items[prevIndex]?.focus();\n            break;\n        }\n\n        case 'Home': {\n            e.preventDefault();\n            const items = menu.querySelectorAll('.more-menu-item');\n            (items[0] as HTMLElement)?.focus();\n            break;\n        }\n\n        case 'End': {\n            e.preventDefault();\n            const items = menu.querySelectorAll('.more-menu-item');\n            (items[items.length - 1] as HTMLElement)?.focus();\n            break;\n        }\n    }\n}\n\n/**\n * Show the more menu with animation\n */\nfunction showMoreMenu(): void {\n    // Save the currently focused element to restore later\n    previouslyFocusedElement = document.activeElement as HTMLElement;\n\n    let menu = safeGetElementById('more-menu');\n\n    if (!menu) {\n        menu = createMoreMenu();\n        document.body.appendChild(menu);\n        setupMenuEventListeners(menu);\n    } else {\n        // Update items in case current tab changed\n        const currentTab = getState('currentTab');\n        if (currentTab) {\n            updateMenuItems(currentTab);\n        }\n    }\n\n    isMenuOpen = true;\n    menu.classList.add('active');\n    document.body.classList.add('more-menu-open');\n\n    // Add keyboard event listeners\n    document.addEventListener('keydown', handleKeyboardNavigation);\n    document.addEventListener('keydown', handleFocusTrap);\n\n    // Focus the first menu item after animation\n    requestAnimationFrame(() => {\n        const firstItem = menu!.querySelector('.more-menu-item') as HTMLElement;\n        firstItem?.focus();\n    });\n\n    logger.debug({\n        operation: 'mobile-nav.more-menu',\n        data: { action: 'open' }\n    });\n}\n\n/**\n * Hide the more menu\n */\nfunction hideMoreMenu(): void {\n    const menu = safeGetElementById('more-menu');\n    if (!menu) return;\n\n    isMenuOpen = false;\n    menu.classList.remove('active');\n    document.body.classList.remove('more-menu-open');\n\n    // Remove keyboard event listeners\n    document.removeEventListener('keydown', handleKeyboardNavigation);\n    document.removeEventListener('keydown', handleFocusTrap);\n\n    // Restore focus to the previously focused element (the More button)\n    if (previouslyFocusedElement) {\n        previouslyFocusedElement.focus();\n        previouslyFocusedElement = null;\n    }\n\n    logger.debug({\n        operation: 'mobile-nav.more-menu',\n        data: { action: 'close' }\n    });\n}\n\n/**\n * Toggle the more menu\n */\nfunction toggleMoreMenu(): void {\n    if (isMenuOpen) {\n        hideMoreMenu();\n    } else {\n        showMoreMenu();\n    }\n}\n\n/**\n * Setup event listeners for the menu\n */\nfunction setupMenuEventListeners(menu: HTMLElement): void {\n    // Backdrop click to close\n    const backdrop = menu.querySelector('.more-menu-backdrop');\n    backdrop?.addEventListener('click', hideMoreMenu);\n\n    // Close button click\n    const closeBtn = menu.querySelector('.more-menu-close');\n    closeBtn?.addEventListener('click', hideMoreMenu);\n\n    // Menu item clicks - use event delegation\n    const itemsContainer = menu.querySelector('.more-menu-items');\n    itemsContainer?.addEventListener('click', (e: Event) => {\n        const target = e.target as HTMLElement;\n        const item = target.closest('.more-menu-item') as HTMLElement | null;\n        \n        if (item) {\n            const tab = item.dataset.tab;\n            if (tab) {\n                switchTab(tab);\n                hideMoreMenu();\n            }\n        }\n    });\n\n    // Handle Enter/Space on menu items for keyboard users\n    itemsContainer?.addEventListener('keydown', (e: Event) => {\n        const keyEvent = e as KeyboardEvent;\n        if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {\n            const target = keyEvent.target as HTMLElement;\n            if (target.classList.contains('more-menu-item')) {\n                keyEvent.preventDefault();\n                const tab = target.dataset.tab;\n                if (tab) {\n                    switchTab(tab);\n                    hideMoreMenu();\n                }\n            }\n        }\n    });\n}\n\n// ========================================\n// Tab Switching\n// ========================================\n\n/**\n * Switch to a tab (triggers existing tab system)\n */\nfunction switchTab(tabName: string): void {\n    // Find and click the corresponding tab button in the main nav\n    const tabBtn = safeQuerySelector(`.tab-btn[data-tab=\"${tabName}\"]`) as HTMLElement | null;\n\n    if (tabBtn) {\n        tabBtn.click();\n    } else {\n        // Fallback: directly set state and trigger render\n        setState('currentTab', tabName as TabName);\n    }\n}\n\n/**\n * Update mobile nav active state based on current tab\n */\nfunction updateMobileNavState(currentTab: string): void {\n    const navItems = safeQuerySelectorAll('.mobile-bottom-nav .nav-item');\n\n    // Check if current tab is in the \"more\" menu\n    const isMoreTab = MORE_TAB_NAMES.includes(currentTab);\n    const currentMoreTab = isMoreTab ? MORE_MENU_TABS.find(t => t.tab === currentTab) : null;\n\n    navItems.forEach(item => {\n        const btn = item as HTMLElement;\n        const tab = btn.dataset.tab;\n\n        if (tab === 'more') {\n            // Update the More button to show current tab if viewing a More tab\n            const iconSpan = btn.querySelector('.nav-icon');\n            const labelSpan = btn.querySelector('span:not(.nav-icon)');\n            \n            if (isMoreTab && currentMoreTab) {\n                // Show current tab's icon and label\n                if (iconSpan) iconSpan.textContent = currentMoreTab.icon;\n                if (labelSpan) labelSpan.textContent = currentMoreTab.label;\n                btn.classList.add('active');\n                btn.setAttribute('aria-label', `${currentMoreTab.label} (tap for more options)`);\n            } else {\n                // Reset to default More button\n                if (iconSpan) iconSpan.textContent = '';\n                if (labelSpan) labelSpan.textContent = 'More';\n                btn.classList.remove('active');\n                btn.setAttribute('aria-label', 'More tabs');\n            }\n            btn.setAttribute('aria-expanded', 'false');\n        } else if (tab === currentTab) {\n            btn.classList.add('active');\n        } else {\n            btn.classList.remove('active');\n        }\n    });\n\n    // Also update menu items if menu exists\n    updateMenuItems(currentTab);\n}\n\n// ========================================\n// Event Handlers\n// ========================================\n\n/**\n * Handle mobile nav item clicks\n */\nfunction handleNavClick(e: Event): void {\n    const target = e.target as HTMLElement;\n    const navItem = target.closest('.nav-item') as HTMLElement | null;\n\n    if (!navItem) return;\n\n    const tab = navItem.dataset.tab;\n\n    if (tab === 'more') {\n        toggleMoreMenu();\n    } else if (tab) {\n        // Close menu if open when switching to a main nav tab\n        if (isMenuOpen) {\n            hideMoreMenu();\n        }\n        switchTab(tab);\n    }\n}\n\n// ========================================\n// Initialization\n// ========================================\n\n/**\n * Initialize mobile bottom navigation\n */\nexport function initMobileNav(): void {\n    const mobileNav = safeQuerySelector('.mobile-bottom-nav');\n\n    if (!mobileNav) {\n        logger.warn({\n            operation: 'mobile-nav.init',\n            data: { reason: 'mobile_nav_not_found' }\n        });\n        return;\n    }\n\n    // Add click listener using event delegation\n    mobileNav.addEventListener('click', handleNavClick);\n\n    // Setup aria-expanded on the More button\n    const moreBtn = mobileNav.querySelector('[data-tab=\"more\"]');\n    if (moreBtn) {\n        moreBtn.setAttribute('aria-expanded', 'false');\n        moreBtn.setAttribute('aria-haspopup', 'dialog');\n    }\n\n    // Subscribe to tab changes to update nav state\n    subscribe('currentTab', (newTab) => {\n        updateMobileNavState(newTab as string);\n    });\n\n    // Initialize with current tab\n    const currentTab = getState('currentTab');\n    if (currentTab) {\n        updateMobileNavState(currentTab as string);\n    }\n\n    logger.info({\n        operation: 'mobile-nav.init',\n        data: { status: 'initialized' }\n    });\n}\n\n// ========================================\n// CSS Injection (Deprecated - now in mobile-nav.css)\n// ========================================\n\n/**\n * Inject additional CSS for the more menu\n * @deprecated CSS is now in mobile-nav.css - this function is kept for backwards compatibility\n */\nexport function injectMoreMenuStyles(): void {\n    // CSS is now in mobile-nav.css file\n    // This function is kept for backwards compatibility but does nothing\n    logger.debug({\n        operation: 'mobile-nav.styles',\n        data: { note: 'CSS now in mobile-nav.css, injectMoreMenuStyles is deprecated' }\n    });\n}\n\n// Export for external use\nexport { hideMoreMenu, showMoreMenu, toggleMoreMenu };\n","// ========================================\n// Mobile Filter Bottom Sheet Module\n// ========================================\n// Provides a mobile-friendly bottom sheet for filter options\n// Similar UX to the more-menu drawer\n// ========================================\n\nimport { getState, subscribe } from './store.ts';\nimport { safeGetElementById, safeQuerySelector } from './utils.ts';\nimport { logger } from './logger.ts';\nimport { saveFilterState } from './filter-state.ts';\n\n// ========================================\n// Types\n// ========================================\n\ninterface FilterConfig {\n    id: string;\n    label: string;\n    type: 'select' | 'checkbox';\n    options?: { value: string; label: string }[];\n}\n\ntype TabFilters = Record<string, FilterConfig[]>;\n\n// ========================================\n// Filter Configurations per Tab\n// ========================================\n\nconst TAB_FILTERS: TabFilters = {\n    items: [\n        {\n            id: 'favoritesOnly',\n            label: ' Favorites Only',\n            type: 'checkbox',\n        },\n        {\n            id: 'rarityFilter',\n            label: 'Rarity',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All Rarities' },\n                { value: 'common', label: 'Common' },\n                { value: 'uncommon', label: 'Uncommon' },\n                { value: 'rare', label: 'Rare' },\n                { value: 'epic', label: 'Epic' },\n                { value: 'legendary', label: 'Legendary' },\n            ],\n        },\n        {\n            id: 'tierFilter',\n            label: 'Tier',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All Tiers' },\n                { value: 'SS', label: 'SS Tier' },\n                { value: 'S', label: 'S Tier' },\n                { value: 'A', label: 'A Tier' },\n                { value: 'B', label: 'B Tier' },\n                { value: 'C', label: 'C Tier' },\n            ],\n        },\n        {\n            id: 'stackingFilter',\n            label: 'Stacking',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All' },\n                { value: 'stacks_well', label: 'Stacks Well' },\n                { value: 'one_and_done', label: 'One-and-Done' },\n            ],\n        },\n        {\n            id: 'sortBy',\n            label: 'Sort By',\n            type: 'select',\n            options: [\n                { value: 'name', label: 'Name' },\n                { value: 'tier', label: 'Tier' },\n                { value: 'rarity', label: 'Rarity' },\n            ],\n        },\n    ],\n    weapons: [\n        {\n            id: 'favoritesOnly',\n            label: ' Favorites Only',\n            type: 'checkbox',\n        },\n        {\n            id: 'tierFilter',\n            label: 'Tier',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All Tiers' },\n                { value: 'SS', label: 'SS Tier' },\n                { value: 'S', label: 'S Tier' },\n                { value: 'A', label: 'A Tier' },\n                { value: 'B', label: 'B Tier' },\n                { value: 'C', label: 'C Tier' },\n            ],\n        },\n        {\n            id: 'sortBy',\n            label: 'Sort By',\n            type: 'select',\n            options: [\n                { value: 'name', label: 'Name' },\n                { value: 'tier', label: 'Tier' },\n            ],\n        },\n    ],\n    tomes: [\n        {\n            id: 'favoritesOnly',\n            label: ' Favorites Only',\n            type: 'checkbox',\n        },\n        {\n            id: 'tierFilter',\n            label: 'Tier',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All Tiers' },\n                { value: 'SS', label: 'SS Tier' },\n                { value: 'S', label: 'S Tier' },\n                { value: 'A', label: 'A Tier' },\n                { value: 'B', label: 'B Tier' },\n                { value: 'C', label: 'C Tier' },\n            ],\n        },\n        {\n            id: 'sortBy',\n            label: 'Sort By',\n            type: 'select',\n            options: [\n                { value: 'name', label: 'Name' },\n                { value: 'tier', label: 'Tier' },\n            ],\n        },\n    ],\n    characters: [\n        {\n            id: 'favoritesOnly',\n            label: ' Favorites Only',\n            type: 'checkbox',\n        },\n        {\n            id: 'tierFilter',\n            label: 'Tier',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All Tiers' },\n                { value: 'SS', label: 'SS Tier' },\n                { value: 'S', label: 'S Tier' },\n                { value: 'A', label: 'A Tier' },\n                { value: 'B', label: 'B Tier' },\n                { value: 'C', label: 'C Tier' },\n            ],\n        },\n        {\n            id: 'sortBy',\n            label: 'Sort By',\n            type: 'select',\n            options: [\n                { value: 'name', label: 'Name' },\n                { value: 'tier', label: 'Tier' },\n            ],\n        },\n    ],\n    shrines: [\n        {\n            id: 'favoritesOnly',\n            label: ' Favorites Only',\n            type: 'checkbox',\n        },\n        {\n            id: 'typeFilter',\n            label: 'Type',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All Types' },\n                { value: 'stat_upgrade', label: 'Stat Upgrade' },\n                { value: 'combat', label: 'Combat' },\n                { value: 'utility', label: 'Utility' },\n                { value: 'risk_reward', label: 'Risk/Reward' },\n            ],\n        },\n    ],\n    changelog: [\n        {\n            id: 'categoryFilter',\n            label: 'Category',\n            type: 'select',\n            options: [\n                { value: 'all', label: 'All Categories' },\n                { value: 'balance', label: 'Balance Changes' },\n                { value: 'new_content', label: 'New Content' },\n                { value: 'bug_fixes', label: 'Bug Fixes' },\n                { value: 'removed', label: 'Removed' },\n                { value: 'other', label: 'Other' },\n            ],\n        },\n        {\n            id: 'sortBy',\n            label: 'Sort By',\n            type: 'select',\n            options: [\n                { value: 'date_desc', label: 'Newest First' },\n                { value: 'date_asc', label: 'Oldest First' },\n            ],\n        },\n    ],\n};\n\n// ========================================\n// State\n// ========================================\n\nlet isSheetOpen = false;\nlet previouslyFocusedElement: HTMLElement | null = null;\n\n// ========================================\n// Filter Bottom Sheet Component\n// ========================================\n\n/**\n * Create the filter bottom sheet HTML\n */\nfunction createFilterSheet(tabName: string): HTMLElement {\n    const sheet = document.createElement('div');\n    sheet.id = 'filter-bottom-sheet';\n    sheet.className = 'filter-bottom-sheet';\n    sheet.setAttribute('role', 'dialog');\n    sheet.setAttribute('aria-modal', 'true');\n    sheet.setAttribute('aria-label', 'Filter options');\n\n    const filters = TAB_FILTERS[tabName] || [];\n\n    sheet.innerHTML = `\n        <div class=\"filter-sheet-backdrop\" aria-hidden=\"true\"></div>\n        <div class=\"filter-sheet-drawer\" role=\"document\">\n            <div class=\"filter-sheet-handle\" aria-hidden=\"true\"></div>\n            <div class=\"filter-sheet-header\">\n                <span class=\"filter-sheet-title\" id=\"filter-sheet-title\">Filters</span>\n                <div class=\"filter-sheet-actions\">\n                    <button class=\"filter-sheet-clear\" type=\"button\">Clear All</button>\n                    <button class=\"filter-sheet-close\" aria-label=\"Close filters\" type=\"button\">\n                        <span aria-hidden=\"true\"></span>\n                    </button>\n                </div>\n            </div>\n            <div class=\"filter-sheet-content\" id=\"filter-sheet-content\">\n                ${renderFilterGroups(filters)}\n            </div>\n            <div class=\"filter-sheet-apply\">\n                <button type=\"button\" id=\"filter-sheet-apply-btn\">Apply Filters</button>\n            </div>\n        </div>\n    `;\n\n    return sheet;\n}\n\n/**\n * Render filter groups HTML\n */\nfunction renderFilterGroups(filters: FilterConfig[]): string {\n    return filters\n        .map(filter => {\n            if (filter.type === 'checkbox') {\n                return `\n                    <div class=\"filter-group\">\n                        <label class=\"filter-group-checkbox\">\n                            <input type=\"checkbox\" id=\"sheet-${filter.id}\" data-filter-id=\"${filter.id}\" />\n                            <span class=\"checkbox-label\">${filter.label}</span>\n                        </label>\n                    </div>\n                `;\n            } else {\n                return `\n                    <div class=\"filter-group\">\n                        <label class=\"filter-group-label\" for=\"sheet-${filter.id}\">${filter.label}</label>\n                        <select id=\"sheet-${filter.id}\" data-filter-id=\"${filter.id}\">\n                            ${filter.options?.map(opt => `<option value=\"${opt.value}\">${opt.label}</option>`).join('')}\n                        </select>\n                    </div>\n                `;\n            }\n        })\n        .join('');\n}\n\n/**\n * Sync filter values from main filters to bottom sheet\n */\nfunction syncFiltersToSheet(): void {\n    const sheet = safeGetElementById('filter-bottom-sheet');\n    if (!sheet) return;\n\n    const sheetInputs = sheet.querySelectorAll<HTMLInputElement | HTMLSelectElement>('[data-filter-id]');\n\n    sheetInputs.forEach(sheetInput => {\n        const filterId = sheetInput.dataset.filterId;\n        if (!filterId) return;\n\n        const mainInput = safeGetElementById(filterId) as HTMLInputElement | HTMLSelectElement | null;\n\n        if (mainInput) {\n            if (sheetInput instanceof HTMLInputElement && sheetInput.type === 'checkbox') {\n                sheetInput.checked = (mainInput as HTMLInputElement).checked;\n            } else if (sheetInput instanceof HTMLSelectElement && mainInput instanceof HTMLSelectElement) {\n                sheetInput.value = mainInput.value;\n            }\n        }\n    });\n}\n\n/**\n * Apply filter values from bottom sheet to main filters\n */\nfunction applyFiltersFromSheet(): void {\n    const sheet = safeGetElementById('filter-bottom-sheet');\n    if (!sheet) return;\n\n    const sheetInputs = sheet.querySelectorAll<HTMLInputElement | HTMLSelectElement>('[data-filter-id]');\n\n    sheetInputs.forEach(sheetInput => {\n        const filterId = sheetInput.dataset.filterId;\n        if (!filterId) return;\n\n        const mainInput = safeGetElementById(filterId) as HTMLInputElement | HTMLSelectElement | null;\n\n        if (mainInput) {\n            if (sheetInput instanceof HTMLInputElement && sheetInput.type === 'checkbox') {\n                (mainInput as HTMLInputElement).checked = sheetInput.checked;\n            } else if (sheetInput instanceof HTMLSelectElement && mainInput instanceof HTMLSelectElement) {\n                mainInput.value = sheetInput.value;\n            }\n\n            // Trigger change event on main input to update UI\n            mainInput.dispatchEvent(new Event('change', { bubbles: true }));\n        }\n    });\n\n    // Save filter state\n    const currentTab = getState('currentTab');\n    if (currentTab) {\n        saveFilterState(currentTab);\n    }\n}\n\n/**\n * Clear all filters in the bottom sheet\n */\nfunction clearSheetFilters(): void {\n    const sheet = safeGetElementById('filter-bottom-sheet');\n    if (!sheet) return;\n\n    const sheetInputs = sheet.querySelectorAll<HTMLInputElement | HTMLSelectElement>('[data-filter-id]');\n\n    sheetInputs.forEach(sheetInput => {\n        if (sheetInput instanceof HTMLInputElement && sheetInput.type === 'checkbox') {\n            sheetInput.checked = false;\n        } else if (sheetInput instanceof HTMLSelectElement) {\n            sheetInput.value = 'all';\n        }\n    });\n}\n\n/**\n * Count active filters\n */\nfunction countActiveFilters(): number {\n    let count = 0;\n    const currentTab = getState('currentTab');\n    const filters = TAB_FILTERS[currentTab || ''] || [];\n\n    filters.forEach(filter => {\n        const input = safeGetElementById(filter.id) as HTMLInputElement | HTMLSelectElement | null;\n        if (!input) return;\n\n        if (input instanceof HTMLInputElement && input.type === 'checkbox') {\n            if (input.checked) count++;\n        } else if (input instanceof HTMLSelectElement) {\n            if (input.value !== 'all' && input.value !== 'name' && input.value !== 'date_desc') {\n                count++;\n            }\n        }\n    });\n\n    return count;\n}\n\n/**\n * Update filter button badge\n */\nfunction updateFilterBadge(): void {\n    const btn = safeQuerySelector('.mobile-filter-btn') as HTMLElement | null;\n    if (!btn) return;\n\n    const count = countActiveFilters();\n    const badge = btn.querySelector('.filter-badge') as HTMLElement | null;\n\n    if (badge) {\n        badge.textContent = count.toString();\n    }\n\n    btn.classList.toggle('has-filters', count > 0);\n}\n\n// ========================================\n// Show/Hide Logic\n// ========================================\n\n/**\n * Handle keyboard navigation within sheet\n */\nfunction handleKeyboardNavigation(e: KeyboardEvent): void {\n    if (!isSheetOpen) return;\n\n    if (e.key === 'Escape') {\n        e.preventDefault();\n        hideFilterSheet();\n    }\n}\n\n/**\n * Handle focus trapping\n */\nfunction handleFocusTrap(e: KeyboardEvent): void {\n    if (e.key !== 'Tab' || !isSheetOpen) return;\n\n    const sheet = safeGetElementById('filter-bottom-sheet');\n    if (!sheet) return;\n\n    const focusableElements = Array.from(\n        sheet.querySelectorAll<HTMLElement>(\n            'button:not([disabled]), select, input, [tabindex]:not([tabindex=\"-1\"])'\n        )\n    ).filter(el => el.offsetParent !== null);\n\n    if (focusableElements.length === 0) return;\n\n    const firstElement = focusableElements[0];\n    const lastElement = focusableElements[focusableElements.length - 1];\n\n    if (e.shiftKey) {\n        if (document.activeElement === firstElement) {\n            e.preventDefault();\n            lastElement?.focus();\n        }\n    } else {\n        if (document.activeElement === lastElement) {\n            e.preventDefault();\n            firstElement?.focus();\n        }\n    }\n}\n\n/**\n * Show the filter bottom sheet\n */\nexport function showFilterSheet(): void {\n    previouslyFocusedElement = document.activeElement as HTMLElement;\n\n    const currentTab = getState('currentTab') || 'items';\n    let sheet = safeGetElementById('filter-bottom-sheet');\n\n    // Check if filters exist for this tab\n    if (!TAB_FILTERS[currentTab]) {\n        logger.debug({\n            operation: 'mobile-filters.show',\n            data: { tab: currentTab, reason: 'no_filters_for_tab' },\n        });\n        return;\n    }\n\n    if (!sheet) {\n        sheet = createFilterSheet(currentTab);\n        document.body.appendChild(sheet);\n        setupSheetEventListeners(sheet);\n    } else {\n        // Update content if tab changed\n        const content = sheet.querySelector('#filter-sheet-content');\n        if (content) {\n            const filters = TAB_FILTERS[currentTab] || [];\n            content.innerHTML = renderFilterGroups(filters);\n        }\n    }\n\n    // Sync current filter values\n    syncFiltersToSheet();\n\n    isSheetOpen = true;\n    sheet.classList.add('active');\n    document.body.classList.add('filter-sheet-open');\n\n    // Add keyboard listeners\n    document.addEventListener('keydown', handleKeyboardNavigation);\n    document.addEventListener('keydown', handleFocusTrap);\n\n    // Focus first input after animation\n    requestAnimationFrame(() => {\n        const firstInput = sheet!.querySelector('select, input') as HTMLElement;\n        firstInput?.focus();\n    });\n\n    logger.debug({\n        operation: 'mobile-filters.sheet',\n        data: { action: 'open', tab: currentTab },\n    });\n}\n\n/**\n * Hide the filter bottom sheet\n */\nexport function hideFilterSheet(): void {\n    const sheet = safeGetElementById('filter-bottom-sheet');\n    if (!sheet) return;\n\n    isSheetOpen = false;\n    sheet.classList.remove('active');\n    document.body.classList.remove('filter-sheet-open');\n\n    // Remove keyboard listeners\n    document.removeEventListener('keydown', handleKeyboardNavigation);\n    document.removeEventListener('keydown', handleFocusTrap);\n\n    // Restore focus\n    if (previouslyFocusedElement) {\n        previouslyFocusedElement.focus();\n        previouslyFocusedElement = null;\n    }\n\n    logger.debug({\n        operation: 'mobile-filters.sheet',\n        data: { action: 'close' },\n    });\n}\n\n/**\n * Toggle the filter bottom sheet\n */\nexport function toggleFilterSheet(): void {\n    if (isSheetOpen) {\n        hideFilterSheet();\n    } else {\n        showFilterSheet();\n    }\n}\n\n/**\n * Setup event listeners for the sheet\n */\nfunction setupSheetEventListeners(sheet: HTMLElement): void {\n    // Backdrop click to close\n    const backdrop = sheet.querySelector('.filter-sheet-backdrop');\n    backdrop?.addEventListener('click', hideFilterSheet);\n\n    // Close button\n    const closeBtn = sheet.querySelector('.filter-sheet-close');\n    closeBtn?.addEventListener('click', hideFilterSheet);\n\n    // Clear button\n    const clearBtn = sheet.querySelector('.filter-sheet-clear');\n    clearBtn?.addEventListener('click', () => {\n        clearSheetFilters();\n    });\n\n    // Apply button\n    const applyBtn = sheet.querySelector('#filter-sheet-apply-btn');\n    applyBtn?.addEventListener('click', () => {\n        applyFiltersFromSheet();\n        hideFilterSheet();\n        updateFilterBadge();\n    });\n}\n\n/**\n * Create the mobile filter button\n */\nfunction createMobileFilterButton(): HTMLElement {\n    const btn = document.createElement('button');\n    btn.className = 'mobile-filter-btn';\n    btn.type = 'button';\n    btn.setAttribute('aria-label', 'Open filters');\n    btn.setAttribute('aria-haspopup', 'dialog');\n    btn.setAttribute('aria-expanded', 'false');\n\n    btn.innerHTML = `\n        <span class=\"filter-icon\" aria-hidden=\"true\"></span>\n        <span>Filters</span>\n        <span class=\"filter-badge\" aria-hidden=\"true\">0</span>\n    `;\n\n    btn.addEventListener('click', () => {\n        toggleFilterSheet();\n        btn.setAttribute('aria-expanded', isSheetOpen ? 'true' : 'false');\n    });\n\n    return btn;\n}\n\n/**\n * Inject the mobile filter button into the controls\n */\nfunction injectMobileFilterButton(): void {\n    const controls = safeQuerySelector('.controls .container');\n    if (!controls) return;\n\n    // Check if button already exists\n    if (safeQuerySelector('.mobile-filter-btn')) return;\n\n    const btn = createMobileFilterButton();\n\n    // Insert after search box\n    const searchBox = controls.querySelector('.search-box');\n    if (searchBox) {\n        searchBox.after(btn);\n    } else {\n        controls.appendChild(btn);\n    }\n}\n\n// ========================================\n// Initialization\n// ========================================\n\n/**\n * Initialize mobile filters\n */\nexport function initMobileFilters(): void {\n    // Inject the mobile filter button\n    injectMobileFilterButton();\n\n    // Subscribe to tab changes to update badge\n    subscribe('currentTab', () => {\n        // Small delay to let filters update\n        setTimeout(() => {\n            updateFilterBadge();\n        }, 100);\n    });\n\n    // Also listen for filter changes on main filters\n    const filtersContainer = safeGetElementById('filters');\n    if (filtersContainer) {\n        filtersContainer.addEventListener('change', () => {\n            updateFilterBadge();\n        });\n    }\n\n    // Initial badge update\n    updateFilterBadge();\n\n    logger.info({\n        operation: 'mobile-filters.init',\n        data: { status: 'initialized' },\n    });\n}\n\n// Export for external use\nexport { updateFilterBadge };\n","// ========================================\n// Image Recognition Debug Module\n// ========================================\n// Visual debugging tools for image recognition\n// Provides overlays, logging, and validation utilities\n// ========================================\n\nimport type {\n    DebugRegion,\n    DebugOverlayOptions,\n    DebugLogEntry,\n    DebugStats,\n    CVDetectionResult,\n    DetectionResults,\n    BoundingBox,\n    SlotInfo,\n    ColorAnalysis,\n    ValidationTestCase,\n    ValidationResult,\n} from '../types/computer-vision';\n\n// ========================================\n// Default Configuration\n// ========================================\n\nconst DEFAULT_DEBUG_OPTIONS: DebugOverlayOptions = {\n    showRegionBounds: true,\n    showSlotGrid: true,\n    showConfidenceLabels: true,\n    showDetectionBoxes: true,\n    showVarianceHeatmap: false,\n    showDominantColors: false,\n    regionColors: {\n        items: '#00ff88',\n        weapons: '#ff6b6b',\n        tomes: '#4ecdc4',\n        character: '#f7dc6f',\n        unknown: '#95a5a6',\n    },\n    fontSize: 12,\n    lineWidth: 2,\n};\n\n// ========================================\n// Module State\n// ========================================\n\n// Safe localStorage access for SSR/testing environments\nfunction getLocalStorage(): Storage | null {\n    if (typeof window !== 'undefined' && window.localStorage) {\n        return window.localStorage;\n    }\n    return null;\n}\n\nlet debugEnabled = getLocalStorage()?.getItem('megabonk_cv_debug') === 'true';\nlet debugOptions: DebugOverlayOptions = { ...DEFAULT_DEBUG_OPTIONS };\nconst debugLogs: DebugLogEntry[] = [];\nconst debugStats: DebugStats = {\n    totalDetections: 0,\n    successfulMatches: 0,\n    falsePositives: 0,\n    averageConfidence: 0,\n    averageProcessingTime: 0,\n    regionDetectionAccuracy: 0,\n    templateCacheHits: 0,\n    templateCacheMisses: 0,\n};\n\n// Confidence history for calculating averages\nconst confidenceHistory: number[] = [];\nconst processingTimeHistory: number[] = [];\n\n// ========================================\n// Debug Mode Control\n// ========================================\n\n/**\n * Enable or disable debug mode\n */\nexport function setDebugEnabled(enabled: boolean): void {\n    debugEnabled = enabled;\n    getLocalStorage()?.setItem('megabonk_cv_debug', String(enabled));\n    log('config', `Debug mode ${enabled ? 'enabled' : 'disabled'}`, undefined, 'info');\n}\n\n/**\n * Check if debug mode is enabled\n */\nexport function isDebugEnabled(): boolean {\n    return debugEnabled;\n}\n\n/**\n * Set debug overlay options\n */\nexport function setDebugOptions(options: Partial<DebugOverlayOptions>): void {\n    debugOptions = { ...debugOptions, ...options };\n    log('config', 'Debug options updated', options, 'info');\n}\n\n/**\n * Get current debug options\n */\nexport function getDebugOptions(): DebugOverlayOptions {\n    return { ...debugOptions };\n}\n\n// ========================================\n// Debug Logging\n// ========================================\n\n/**\n * Log a debug message\n */\nexport function log(category: string, message: string, data?: unknown, level: DebugLogEntry['level'] = 'debug'): void {\n    const entry: DebugLogEntry = {\n        timestamp: Date.now(),\n        category,\n        message,\n        data,\n        level,\n    };\n\n    debugLogs.push(entry);\n\n    // Keep only last 500 entries\n    if (debugLogs.length > 500) {\n        debugLogs.shift();\n    }\n\n    // Console output if debug enabled\n    if (debugEnabled) {\n        const prefix = `[CV:${category}]`;\n        const style = {\n            debug: 'color: #888',\n            info: 'color: #4ecdc4',\n            warn: 'color: #f7dc6f',\n            error: 'color: #ff6b6b',\n        }[level];\n\n        console.groupCollapsed(`%c${prefix} ${message}`, style);\n        if (data !== undefined) {\n            if (typeof data === 'object' && data !== null) {\n                console.table(data);\n            } else {\n                console.log(data);\n            }\n        }\n        console.trace('Stack trace');\n        console.groupEnd();\n    }\n}\n\n/**\n * Get all debug logs\n */\nexport function getLogs(): DebugLogEntry[] {\n    return [...debugLogs];\n}\n\n/**\n * Get logs filtered by category\n */\nexport function getLogsByCategory(category: string): DebugLogEntry[] {\n    return debugLogs.filter(entry => entry.category === category);\n}\n\n/**\n * Get logs filtered by level\n */\nexport function getLogsByLevel(level: DebugLogEntry['level']): DebugLogEntry[] {\n    return debugLogs.filter(entry => entry.level === level);\n}\n\n/**\n * Clear all logs\n */\nexport function clearLogs(): void {\n    debugLogs.length = 0;\n    log('system', 'Logs cleared', undefined, 'info');\n}\n\n/**\n * Export logs as JSON\n */\nexport function exportLogs(): string {\n    return JSON.stringify(debugLogs, null, 2);\n}\n\n// ========================================\n// Debug Statistics\n// ========================================\n\n/**\n * Record a detection result for statistics\n */\nexport function recordDetection(result: DetectionResults): void {\n    debugStats.totalDetections++;\n\n    const totalItems = result.items.length + result.weapons.length + result.tomes.length + (result.character ? 1 : 0);\n    debugStats.successfulMatches += totalItems;\n\n    // Update confidence average\n    const confidences = [\n        ...result.items.map(d => d.confidence),\n        ...result.weapons.map(d => d.confidence),\n        ...result.tomes.map(d => d.confidence),\n        ...(result.character ? [result.character.confidence] : []),\n    ];\n\n    if (confidences.length > 0) {\n        const avgConfidence = confidences.reduce((a, b) => a + b, 0) / confidences.length;\n        confidenceHistory.push(avgConfidence);\n        if (confidenceHistory.length > 100) confidenceHistory.shift();\n        debugStats.averageConfidence = confidenceHistory.reduce((a, b) => a + b, 0) / confidenceHistory.length;\n    }\n\n    // Update processing time average\n    processingTimeHistory.push(result.processingTime);\n    if (processingTimeHistory.length > 100) processingTimeHistory.shift();\n    debugStats.averageProcessingTime = processingTimeHistory.reduce((a, b) => a + b, 0) / processingTimeHistory.length;\n\n    log('stats', 'Detection recorded', {\n        totalItems,\n        avgConfidence: debugStats.averageConfidence.toFixed(3),\n        processingTime: result.processingTime,\n    });\n}\n\n/**\n * Record a cache hit/miss\n */\nexport function recordCacheAccess(hit: boolean): void {\n    if (hit) {\n        debugStats.templateCacheHits++;\n    } else {\n        debugStats.templateCacheMisses++;\n    }\n}\n\n/**\n * Get current statistics\n */\nexport function getStats(): DebugStats {\n    return { ...debugStats };\n}\n\n/**\n * Reset statistics\n */\nexport function resetStats(): void {\n    Object.assign(debugStats, {\n        totalDetections: 0,\n        successfulMatches: 0,\n        falsePositives: 0,\n        averageConfidence: 0,\n        averageProcessingTime: 0,\n        regionDetectionAccuracy: 0,\n        templateCacheHits: 0,\n        templateCacheMisses: 0,\n    });\n    confidenceHistory.length = 0;\n    processingTimeHistory.length = 0;\n    log('stats', 'Statistics reset', undefined, 'info');\n}\n\n// ========================================\n// Debug Overlay Rendering\n// ========================================\n\n/**\n * Create a debug overlay canvas from an image\n */\nexport function createDebugCanvas(\n    sourceImage: HTMLImageElement | HTMLCanvasElement | ImageBitmap,\n    width?: number,\n    height?: number\n): HTMLCanvasElement {\n    const canvas = document.createElement('canvas');\n    canvas.width = width ?? sourceImage.width;\n    canvas.height = height ?? sourceImage.height;\n\n    const ctx = canvas.getContext('2d', { willReadFrequently: true });\n    if (ctx) {\n        ctx.drawImage(sourceImage, 0, 0, canvas.width, canvas.height);\n    }\n\n    return canvas;\n}\n\n/**\n * Draw debug regions on a canvas\n */\nexport function drawDebugRegions(\n    canvas: HTMLCanvasElement,\n    regions: DebugRegion[],\n    options: Partial<DebugOverlayOptions> = {}\n): void {\n    const opts = { ...debugOptions, ...options };\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    regions.forEach(region => {\n        // Draw region box\n        ctx.strokeStyle = region.color;\n        ctx.lineWidth = opts.lineWidth;\n\n        // Set line style\n        if (region.strokeStyle === 'dashed') {\n            ctx.setLineDash([8, 4]);\n        } else if (region.strokeStyle === 'dotted') {\n            ctx.setLineDash([2, 2]);\n        } else {\n            ctx.setLineDash([]);\n        }\n\n        ctx.strokeRect(region.x, region.y, region.width, region.height);\n\n        // Fill with transparency if specified\n        if (region.fillOpacity && region.fillOpacity > 0) {\n            ctx.fillStyle = region.color;\n            ctx.globalAlpha = region.fillOpacity;\n            ctx.fillRect(region.x, region.y, region.width, region.height);\n            ctx.globalAlpha = 1;\n        }\n\n        // Draw label\n        if (opts.showConfidenceLabels && region.label) {\n            ctx.font = `${opts.fontSize}px monospace`;\n            ctx.fillStyle = region.color;\n\n            const labelText =\n                region.confidence !== undefined\n                    ? `${region.label} (${(region.confidence * 100).toFixed(1)}%)`\n                    : region.label;\n\n            // Draw label background\n            const textMetrics = ctx.measureText(labelText);\n            const labelX = region.x;\n            const labelY = region.y - 4;\n\n            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';\n            ctx.fillRect(labelX - 2, labelY - opts.fontSize, textMetrics.width + 4, opts.fontSize + 4);\n\n            ctx.fillStyle = region.color;\n            ctx.fillText(labelText, labelX, labelY);\n        }\n    });\n\n    // Reset line dash\n    ctx.setLineDash([]);\n}\n\n/**\n * Draw slot grid on a canvas\n */\nexport function drawSlotGrid(\n    canvas: HTMLCanvasElement,\n    slots: SlotInfo[],\n    _color: string = '#ffffff',\n    options: Partial<DebugOverlayOptions> = {}\n): void {\n    const opts = { ...debugOptions, ...options };\n    if (!opts.showSlotGrid) return;\n\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    slots.forEach(slot => {\n        // Draw slot border\n        ctx.strokeStyle = slot.occupied ? '#00ff88' : '#666666';\n        ctx.lineWidth = slot.occupied ? 2 : 1;\n        ctx.setLineDash(slot.occupied ? [] : [4, 4]);\n        ctx.strokeRect(slot.x, slot.y, slot.width, slot.height);\n\n        // Draw slot index\n        if (opts.showConfidenceLabels) {\n            ctx.font = `${opts.fontSize - 2}px monospace`;\n            ctx.fillStyle = slot.occupied ? '#00ff88' : '#666666';\n            ctx.fillText(String(slot.index), slot.x + slot.width / 2 - 4, slot.y + slot.height / 2 + 4);\n        }\n\n        // Draw variance info if available\n        if (slot.variance !== undefined && opts.showVarianceHeatmap) {\n            const intensity = Math.min(255, Math.floor(slot.variance));\n            ctx.fillStyle = `rgba(255, ${255 - intensity}, 0, 0.3)`;\n            ctx.fillRect(slot.x, slot.y, slot.width, slot.height);\n        }\n    });\n\n    ctx.setLineDash([]);\n}\n\n/**\n * Draw detection boxes for matched items\n */\nexport function drawDetectionBoxes(\n    canvas: HTMLCanvasElement,\n    detections: CVDetectionResult[],\n    color: string = '#00ff88',\n    options: Partial<DebugOverlayOptions> = {}\n): void {\n    const opts = { ...debugOptions, ...options };\n    if (!opts.showDetectionBoxes) return;\n\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    detections.forEach(detection => {\n        if (!detection.position) return;\n\n        const pos = detection.position;\n\n        // Draw detection box\n        ctx.strokeStyle = color;\n        ctx.lineWidth = opts.lineWidth;\n        ctx.strokeRect(pos.x, pos.y, pos.width, pos.height);\n\n        // Draw entity name and confidence\n        if (opts.showConfidenceLabels) {\n            ctx.font = `bold ${opts.fontSize}px monospace`;\n\n            const label = `${detection.entity.name} (${(detection.confidence * 100).toFixed(0)}%)`;\n            const textMetrics = ctx.measureText(label);\n\n            // Background\n            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';\n            ctx.fillRect(pos.x, pos.y + pos.height + 2, textMetrics.width + 8, opts.fontSize + 6);\n\n            // Text\n            ctx.fillStyle = color;\n            ctx.fillText(label, pos.x + 4, pos.y + pos.height + opts.fontSize + 2);\n        }\n    });\n}\n\n/**\n * Create a complete debug overlay from detection results\n */\nexport function createDebugOverlay(\n    imageDataUrl: string,\n    results: DetectionResults,\n    options: Partial<DebugOverlayOptions> = {}\n): Promise<string> {\n    return new Promise((resolve, reject) => {\n        const img = new Image();\n        img.onload = () => {\n            const canvas = createDebugCanvas(img);\n            const opts = { ...debugOptions, ...options };\n\n            // Draw region bounds\n            if (opts.showRegionBounds) {\n                const debugRegions: DebugRegion[] = results.regions.map(region => ({\n                    ...region,\n                    label: region.label ?? region.type,\n                    color: getRegionColor(region.type, opts),\n                    strokeStyle: 'solid' as const,\n                    fillOpacity: 0.1,\n                }));\n                drawDebugRegions(canvas, debugRegions, opts);\n            }\n\n            // Draw slot grids\n            if (opts.showSlotGrid) {\n                results.regions.forEach(region => {\n                    if (region.slots) {\n                        drawSlotGrid(canvas, region.slots, getRegionColor(region.type, opts), opts);\n                    }\n                });\n            }\n\n            // Draw item detections\n            if (opts.showDetectionBoxes) {\n                drawDetectionBoxes(canvas, results.items, opts.regionColors.items, opts);\n                drawDetectionBoxes(canvas, results.weapons, opts.regionColors.weapons, opts);\n                drawDetectionBoxes(canvas, results.tomes, opts.regionColors.tomes, opts);\n                if (results.character) {\n                    drawDetectionBoxes(canvas, [results.character], opts.regionColors.character, opts);\n                }\n            }\n\n            // Draw stats overlay\n            drawStatsOverlay(canvas, results, opts);\n\n            resolve(canvas.toDataURL('image/png'));\n        };\n        img.onerror = () => reject(new Error('Failed to load image for debug overlay'));\n        img.src = imageDataUrl;\n    });\n}\n\n/**\n * Get color for a region type\n */\nfunction getRegionColor(type: string, options: DebugOverlayOptions): string {\n    switch (type) {\n        case 'items_hotbar':\n            return options.regionColors.items;\n        case 'weapons_region':\n            return options.regionColors.weapons;\n        case 'tomes_region':\n            return options.regionColors.tomes;\n        case 'character_portrait':\n            return options.regionColors.character;\n        default:\n            return options.regionColors.unknown;\n    }\n}\n\n/**\n * Draw statistics overlay on canvas\n */\nfunction drawStatsOverlay(canvas: HTMLCanvasElement, results: DetectionResults, options: DebugOverlayOptions): void {\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    const padding = 10;\n    const lineHeight = options.fontSize + 4;\n    const boxWidth = 200;\n    const lines = [\n        `Resolution: ${results.imageSize.width}x${results.imageSize.height}`,\n        `Items: ${results.items.length}`,\n        `Weapons: ${results.weapons.length}`,\n        `Tomes: ${results.tomes.length}`,\n        `Character: ${results.character?.entity.name ?? 'None'}`,\n        `Confidence: ${(results.confidence * 100).toFixed(1)}%`,\n        `Time: ${results.processingTime}ms`,\n    ];\n    const boxHeight = lines.length * lineHeight + padding * 2;\n\n    // Draw background\n    ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';\n    ctx.fillRect(canvas.width - boxWidth - padding, padding, boxWidth, boxHeight);\n\n    // Draw border\n    ctx.strokeStyle = '#00ff88';\n    ctx.lineWidth = 1;\n    ctx.strokeRect(canvas.width - boxWidth - padding, padding, boxWidth, boxHeight);\n\n    // Draw text\n    ctx.font = `${options.fontSize}px monospace`;\n    ctx.fillStyle = '#ffffff';\n\n    lines.forEach((line, i) => {\n        ctx.fillText(line, canvas.width - boxWidth - padding + 8, padding + lineHeight * (i + 1));\n    });\n}\n\n// ========================================\n// Validation Utilities\n// ========================================\n\n/**\n * Validate detection results against expected values\n */\nexport function validateDetectionResults(results: DetectionResults, testCase: ValidationTestCase): ValidationResult {\n    const startTime = Date.now();\n\n    const detectedItems = results.items.map(d => d.entity.name);\n    const detectedWeapons = results.weapons.map(d => d.entity.name);\n    const detectedTomes = results.tomes.map(d => d.entity.name);\n    const detectedCharacter = results.character?.entity.name;\n\n    // Calculate matches, misses, and false positives\n    const matchedItems = testCase.expectedItems.filter(e => detectedItems.includes(e));\n    const missedItems = testCase.expectedItems.filter(e => !detectedItems.includes(e));\n    const falsePositiveItems = detectedItems.filter(d => !testCase.expectedItems.includes(d));\n\n    const matchedWeapons = testCase.expectedWeapons.filter(e => detectedWeapons.includes(e));\n    const missedWeapons = testCase.expectedWeapons.filter(e => !detectedWeapons.includes(e));\n    const falsePositiveWeapons = detectedWeapons.filter(d => !testCase.expectedWeapons.includes(d));\n\n    const matchedTomes = testCase.expectedTomes.filter(e => detectedTomes.includes(e));\n    const missedTomes = testCase.expectedTomes.filter(e => !detectedTomes.includes(e));\n    const falsePositiveTomes = detectedTomes.filter(d => !testCase.expectedTomes.includes(d));\n\n    const characterMatch = testCase.expectedCharacter ? detectedCharacter === testCase.expectedCharacter : true;\n\n    // Calculate accuracy\n    const itemAccuracy = testCase.expectedItems.length > 0 ? matchedItems.length / testCase.expectedItems.length : 1;\n    const weaponAccuracy =\n        testCase.expectedWeapons.length > 0 ? matchedWeapons.length / testCase.expectedWeapons.length : 1;\n    const tomeAccuracy = testCase.expectedTomes.length > 0 ? matchedTomes.length / testCase.expectedTomes.length : 1;\n\n    const totalExpected =\n        testCase.expectedItems.length +\n        testCase.expectedWeapons.length +\n        testCase.expectedTomes.length +\n        (testCase.expectedCharacter ? 1 : 0);\n    const totalMatched =\n        matchedItems.length +\n        matchedWeapons.length +\n        matchedTomes.length +\n        (characterMatch && testCase.expectedCharacter ? 1 : 0);\n    const overallAccuracy = totalExpected > 0 ? totalMatched / totalExpected : 1;\n\n    // Calculate region accuracy if annotated regions provided\n    let regionAccuracy = 1;\n    if (testCase.annotatedRegions && testCase.annotatedRegions.length > 0) {\n        let regionMatches = 0;\n        testCase.annotatedRegions.forEach(expected => {\n            const found = results.regions.find(\n                detected =>\n                    detected.type === expected.type &&\n                    Math.abs(detected.x - expected.x) < 50 &&\n                    Math.abs(detected.y - expected.y) < 50\n            );\n            if (found) regionMatches++;\n        });\n        regionAccuracy = regionMatches / testCase.annotatedRegions.length;\n    }\n\n    const result: ValidationResult = {\n        testCase,\n        passed:\n            overallAccuracy >= 0.8 &&\n            falsePositiveItems.length === 0 &&\n            falsePositiveWeapons.length === 0 &&\n            falsePositiveTomes.length === 0,\n        matched: {\n            items: matchedItems,\n            weapons: matchedWeapons,\n            tomes: matchedTomes,\n            character: characterMatch ? detectedCharacter : undefined,\n        },\n        missed: {\n            items: missedItems,\n            weapons: missedWeapons,\n            tomes: missedTomes,\n            character: characterMatch ? undefined : testCase.expectedCharacter,\n        },\n        falsePositives: {\n            items: falsePositiveItems,\n            weapons: falsePositiveWeapons,\n            tomes: falsePositiveTomes,\n        },\n        accuracy: {\n            items: itemAccuracy,\n            weapons: weaponAccuracy,\n            tomes: tomeAccuracy,\n            overall: overallAccuracy,\n        },\n        regionAccuracy,\n        processingTime: Date.now() - startTime,\n    };\n\n    log(\n        'validation',\n        `Validation ${result.passed ? 'PASSED' : 'FAILED'}: ${testCase.name}`,\n        {\n            accuracy: result.accuracy,\n            missed: result.missed,\n            falsePositives: result.falsePositives,\n        },\n        result.passed ? 'info' : 'warn'\n    );\n\n    return result;\n}\n\n// ========================================\n// Color Analysis Debug\n// ========================================\n\n/**\n * Analyze colors in a region for debugging\n */\nexport function analyzeRegionColors(imageData: ImageData, region: BoundingBox): ColorAnalysis {\n    const colors: Map<string, number> = new Map();\n    let totalR = 0,\n        totalG = 0,\n        totalB = 0;\n    let totalBrightness = 0;\n    let count = 0;\n\n    const startX = Math.max(0, Math.floor(region.x));\n    const startY = Math.max(0, Math.floor(region.y));\n    const endX = Math.min(imageData.width, Math.floor(region.x + region.width));\n    const endY = Math.min(imageData.height, Math.floor(region.y + region.height));\n\n    for (let y = startY; y < endY; y++) {\n        for (let x = startX; x < endX; x++) {\n            const idx = (y * imageData.width + x) * 4;\n            const r = imageData.data[idx] ?? 0;\n            const g = imageData.data[idx + 1] ?? 0;\n            const b = imageData.data[idx + 2] ?? 0;\n\n            totalR += r;\n            totalG += g;\n            totalB += b;\n            totalBrightness += (r + g + b) / 3;\n            count++;\n\n            // Quantize color for histogram (reduce to 32 levels per channel)\n            const qr = Math.floor(r / 8) * 8;\n            const qg = Math.floor(g / 8) * 8;\n            const qb = Math.floor(b / 8) * 8;\n            const colorKey = `${qr},${qg},${qb}`;\n            colors.set(colorKey, (colors.get(colorKey) ?? 0) + 1);\n        }\n    }\n\n    // Find dominant colors\n    const sortedColors = [...colors.entries()].sort((a, b) => b[1] - a[1]).slice(0, 5);\n    const dominantColors = sortedColors.map(([color, freq]) => {\n        const parts = color.split(',').map(Number);\n        const r = parts[0] ?? 0;\n        const g = parts[1] ?? 0;\n        const b = parts[2] ?? 0;\n        return {\n            color: `rgb(${r}, ${g}, ${b})`,\n            percentage: (freq / count) * 100,\n            rgb: { r, g, b },\n        };\n    });\n\n    const avgR = Math.round(totalR / count);\n    const avgG = Math.round(totalG / count);\n    const avgB = Math.round(totalB / count);\n\n    // Calculate saturation\n    const max = Math.max(avgR, avgG, avgB);\n    const min = Math.min(avgR, avgG, avgB);\n    const saturation = max === 0 ? 0 : ((max - min) / max) * 100;\n\n    return {\n        dominantColors,\n        averageColor: `rgb(${avgR}, ${avgG}, ${avgB})`,\n        brightness: totalBrightness / count,\n        contrast: max - min,\n        saturation,\n    };\n}\n\n// ========================================\n// Export Debug Image\n// ========================================\n\n/**\n * Download debug overlay as image file\n */\nexport function downloadDebugImage(dataUrl: string, filename: string = 'debug-overlay.png'): void {\n    const link = document.createElement('a');\n    link.href = dataUrl;\n    link.download = filename;\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    log('export', `Downloaded debug image: ${filename}`, undefined, 'info');\n}\n\n// ========================================\n// Console Debug Commands\n// ========================================\n\n/**\n * Register debug commands on window for console access\n */\nexport function registerDebugCommands(): void {\n    if (typeof window === 'undefined') return;\n\n    (window as unknown as Record<string, unknown>).cvDebug = {\n        enable: () => setDebugEnabled(true),\n        disable: () => setDebugEnabled(false),\n        getLogs: () => getLogs(),\n        getStats: () => getStats(),\n        clearLogs: () => clearLogs(),\n        resetStats: () => resetStats(),\n        exportLogs: () => exportLogs(),\n        setOptions: (opts: Partial<DebugOverlayOptions>) => setDebugOptions(opts),\n        getOptions: () => getDebugOptions(),\n    };\n\n    log('system', 'Debug commands registered. Access via window.cvDebug', undefined, 'info');\n}\n\n// Auto-register debug commands\nif (typeof window !== 'undefined') {\n    registerDebugCommands();\n}\n","// ========================================\n// MegaBonk DOM Utilities Module\n// ========================================\n// Shared DOM manipulation patterns\n// ========================================\n\n/**\n * Options for creating an element\n */\nexport interface ElementOptions {\n    className?: string;\n    id?: string;\n    attributes?: Record<string, string>;\n    dataset?: Record<string, string>;\n    innerHTML?: string;\n    textContent?: string;\n    children?: HTMLElement[];\n}\n\n/**\n * Create an HTML element with options\n * Uses DOM API (not innerHTML) for XSS safety\n * @param tag - HTML tag name\n * @param options - Element configuration options\n * @returns Created element\n */\nexport function createElement<K extends keyof HTMLElementTagNameMap>(\n    tag: K,\n    options: ElementOptions = {}\n): HTMLElementTagNameMap[K] {\n    const el = document.createElement(tag);\n\n    if (options.className) {\n        el.className = options.className;\n    }\n\n    if (options.id) {\n        el.id = options.id;\n    }\n\n    if (options.attributes) {\n        for (const [key, value] of Object.entries(options.attributes)) {\n            el.setAttribute(key, value);\n        }\n    }\n\n    if (options.dataset) {\n        for (const [key, value] of Object.entries(options.dataset)) {\n            el.dataset[key] = value;\n        }\n    }\n\n    // Note: Use textContent for user content (safe), innerHTML only for trusted HTML\n    if (options.textContent !== undefined) {\n        el.textContent = options.textContent;\n    } else if (options.innerHTML !== undefined) {\n        el.innerHTML = options.innerHTML;\n    }\n\n    if (options.children) {\n        for (const child of options.children) {\n            el.appendChild(child);\n        }\n    }\n\n    return el;\n}\n\n/**\n * Create a progress indicator element\n * @param initialStatus - Initial status text\n * @returns Progress element with update methods\n */\nexport interface ProgressIndicator {\n    element: HTMLElement;\n    update: (progress: number, status: string) => void;\n    remove: () => void;\n}\n\nexport function createProgressIndicator(initialStatus: string = 'Initializing...'): ProgressIndicator {\n    const progressDiv = createElement('div', {\n        className: 'scan-progress-overlay',\n        innerHTML: `\n            <div class=\"scan-progress-content\">\n                <div class=\"scan-progress-spinner\"></div>\n                <div class=\"scan-progress-text\">${initialStatus}</div>\n                <div class=\"scan-progress-bar\">\n                    <div class=\"scan-progress-fill\" style=\"width: 0%\"></div>\n                </div>\n            </div>\n        `,\n    });\n\n    return {\n        element: progressDiv,\n\n        update: (progress: number, status: string) => {\n            const textEl = progressDiv.querySelector('.scan-progress-text');\n            const fillEl = progressDiv.querySelector('.scan-progress-fill') as HTMLElement | null;\n\n            if (textEl) {\n                textEl.textContent = status;\n            }\n\n            if (fillEl) {\n                fillEl.style.width = `${Math.min(100, Math.max(0, progress))}%`;\n            }\n        },\n\n        remove: () => {\n            progressDiv.remove();\n        },\n    };\n}\n\n/**\n * Event listener cleanup manager\n * Tracks listeners for easy bulk removal\n */\nexport interface EventListenerManager {\n    /** Add event listener with automatic tracking */\n    add: <K extends keyof HTMLElementEventMap>(\n        element: HTMLElement | Document,\n        type: K,\n        handler: (ev: HTMLElementEventMap[K]) => void,\n        options?: AddEventListenerOptions\n    ) => void;\n    /** Add event listener using AbortController signal */\n    addWithSignal: <K extends keyof HTMLElementEventMap>(\n        element: HTMLElement | Document,\n        type: K,\n        handler: (ev: HTMLElementEventMap[K]) => void,\n        options?: Omit<AddEventListenerOptions, 'signal'>\n    ) => void;\n    /** Remove all tracked listeners */\n    removeAll: () => void;\n    /** Get AbortController signal for external use */\n    getSignal: () => AbortSignal;\n}\n\nexport function createEventListenerManager(): EventListenerManager {\n    const cleanups: Array<() => void> = [];\n    let abortController: AbortController | null = null;\n\n    const ensureAbortController = () => {\n        if (!abortController) {\n            abortController = new AbortController();\n        }\n        return abortController;\n    };\n\n    return {\n        add: <K extends keyof HTMLElementEventMap>(\n            element: HTMLElement | Document,\n            type: K,\n            handler: (ev: HTMLElementEventMap[K]) => void,\n            options?: AddEventListenerOptions\n        ) => {\n            element.addEventListener(type, handler as EventListener, options);\n            cleanups.push(() => element.removeEventListener(type, handler as EventListener, options));\n        },\n\n        addWithSignal: <K extends keyof HTMLElementEventMap>(\n            element: HTMLElement | Document,\n            type: K,\n            handler: (ev: HTMLElementEventMap[K]) => void,\n            options?: Omit<AddEventListenerOptions, 'signal'>\n        ) => {\n            const controller = ensureAbortController();\n            element.addEventListener(type, handler as EventListener, { ...options, signal: controller.signal });\n        },\n\n        removeAll: () => {\n            // Clean up manually tracked listeners\n            while (cleanups.length > 0) {\n                const cleanup = cleanups.pop();\n                try {\n                    cleanup?.();\n                } catch {\n                    // Element may have been removed from DOM\n                }\n            }\n\n            // Abort all signal-tracked listeners\n            if (abortController) {\n                abortController.abort();\n                abortController = null;\n            }\n        },\n\n        getSignal: () => ensureAbortController().signal,\n    };\n}\n\n/**\n * Download content as a file\n * @param content - Content string to download\n * @param filename - Suggested filename\n * @param mimeType - MIME type (default: application/json)\n */\nexport function downloadFile(\n    content: string,\n    filename: string,\n    mimeType: string = 'application/json'\n): void {\n    const blob = new Blob([content], { type: mimeType });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = filename;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n}\n\n/**\n * Download JSON data as a file\n * @param data - Data to serialize and download\n * @param filename - Suggested filename (without extension)\n * @param pretty - Whether to pretty-print JSON (default: true)\n */\nexport function downloadJson(\n    data: unknown,\n    filename: string,\n    pretty: boolean = true\n): void {\n    const json = pretty ? JSON.stringify(data, null, 2) : JSON.stringify(data);\n    const fullFilename = filename.endsWith('.json') ? filename : `${filename}.json`;\n    downloadFile(json, fullFilename, 'application/json');\n}\n\n/**\n * Render items into a container using DocumentFragment for performance\n * @param container - Container element\n * @param items - Items to render\n * @param renderFn - Function to render each item into an element\n */\nexport function renderWithFragment<T>(\n    container: HTMLElement,\n    items: T[],\n    renderFn: (item: T, index: number) => HTMLElement\n): void {\n    container.innerHTML = '';\n    const fragment = document.createDocumentFragment();\n\n    items.forEach((item, index) => {\n        fragment.appendChild(renderFn(item, index));\n    });\n\n    container.appendChild(fragment);\n}\n\n/**\n * Create a card element with common structure\n * @param className - Card class name\n * @param content - Inner HTML content\n * @param dataset - Data attributes\n * @returns Card element\n */\nexport function createCard(\n    className: string,\n    content: string,\n    dataset?: Record<string, string>\n): HTMLElement {\n    return createElement('div', {\n        className,\n        innerHTML: content,\n        dataset,\n    });\n}\n\n/**\n * Create a button element\n * @param text - Button text\n * @param className - CSS class\n * @param onClick - Click handler\n * @param attributes - Additional attributes\n * @returns Button element\n */\nexport function createButton(\n    text: string,\n    className: string,\n    onClick?: (e: MouseEvent) => void,\n    attributes?: Record<string, string>\n): HTMLButtonElement {\n    const btn = createElement('button', {\n        className,\n        textContent: text,\n        attributes,\n    });\n\n    if (onClick) {\n        btn.addEventListener('click', onClick);\n    }\n\n    return btn;\n}\n","// ========================================\n// Debug UI Module\n// ========================================\n// Handles the debug panel UI interactions\n// and integrates with the CV debug system\n// Enhanced with breadcrumb display and new debug controls\n// ========================================\n\nimport {\n    setDebugEnabled,\n    isDebugEnabled,\n    setDebugOptions,\n    getDebugOptions,\n    getLogs,\n    getStats,\n    clearLogs,\n    resetStats,\n    exportLogs,\n    downloadDebugImage,\n} from './image-recognition-debug';\nimport { logger, requestTimer } from './logger';\nimport { getBreadcrumbs, clearBreadcrumbs, exportBreadcrumbs, captureStateSnapshot } from './breadcrumbs';\nimport { createEventListenerManager, downloadJson as downloadJsonFile } from './dom-utils.ts';\n\nimport type { DebugLogEntry } from '../types/computer-vision';\n\n// ========================================\n// State\n// ========================================\n\nlet isExpanded = false;\nlet currentLogFilter: string = 'all';\nlet lastOverlayUrl: string | null = null;\nlet updateIntervalId: number | null = null;\nlet currentConfidenceThreshold: number = 0.7;\nlet activeDebugTab: 'logs' | 'breadcrumbs' | 'requests' | 'state' = 'logs';\n\n// Use centralized event listener manager for cleanup\nconst eventManager = createEventListenerManager();\n\n// ========================================\n// Initialization\n// ========================================\n\n/**\n * Initialize the debug panel UI\n */\nexport function initDebugPanel(): void {\n    // Bug fix: Clean up any existing state before reinitializing to prevent memory leaks\n    cleanupDebugPanel();\n\n    const panel = document.getElementById('debug-panel');\n    const expandBtn = document.getElementById('debug-expand-btn');\n    const debugModeCheckbox = document.getElementById('scan-debug-mode') as HTMLInputElement;\n    const panelContent = document.getElementById('debug-panel-content');\n\n    if (!panel || !expandBtn || !debugModeCheckbox || !panelContent) {\n        logger.warn({\n            operation: 'debug_ui.init',\n            data: {\n                reason: 'missing_elements',\n                hasPanel: !!panel,\n                hasExpandBtn: !!expandBtn,\n                hasCheckbox: !!debugModeCheckbox,\n                hasContent: !!panelContent,\n            },\n        });\n        return;\n    }\n\n    // Initialize checkbox state from stored setting\n    debugModeCheckbox.checked = isDebugEnabled();\n    if (debugModeCheckbox.checked) {\n        panel.classList.add('active');\n    }\n\n    // Debug mode toggle - track for cleanup using event manager\n    eventManager.add(debugModeCheckbox, 'change', () => {\n        setDebugEnabled(debugModeCheckbox.checked);\n        panel.classList.toggle('active', debugModeCheckbox.checked);\n    });\n\n    // Expand/collapse toggle - track for cleanup\n    eventManager.add(expandBtn, 'click', (e: Event) => {\n        e.stopPropagation();\n        toggleExpanded(panel, panelContent);\n    });\n\n    // Initialize overlay options\n    initOverlayOptions();\n\n    // Initialize log filter\n    initLogFilter();\n\n    // Initialize action buttons\n    initActionButtons();\n\n    // Update stats periodically when panel is visible\n    // Store interval ID for cleanup\n    updateIntervalId = window.setInterval(() => {\n        if (isExpanded) {\n            updateStats();\n            updateLogViewer();\n        }\n    }, 1000);\n}\n\n/**\n * Cleanup debug panel resources\n * Removes all event listeners and clears intervals to prevent memory leaks\n */\nexport function cleanupDebugPanel(): void {\n    // Clear the update interval\n    if (updateIntervalId !== null) {\n        clearInterval(updateIntervalId);\n        updateIntervalId = null;\n    }\n\n    // Remove all tracked event listeners using centralized manager\n    eventManager.removeAll();\n\n    isExpanded = false;\n    lastOverlayUrl = null;\n}\n\n/**\n * Toggle panel expanded state\n */\nfunction toggleExpanded(panel: HTMLElement, content: HTMLElement): void {\n    isExpanded = !isExpanded;\n    panel.classList.toggle('expanded', isExpanded);\n    content.style.display = isExpanded ? 'block' : 'none';\n\n    if (isExpanded) {\n        updateStats();\n        updateLogViewer();\n    }\n}\n\n// ========================================\n// Overlay Options\n// ========================================\n\n/**\n * Initialize overlay option checkboxes\n * Uses centralized event manager for cleanup\n */\nfunction initOverlayOptions(): void {\n    const options = getDebugOptions();\n\n    const optionMap: Record<string, keyof typeof options> = {\n        'debug-show-regions': 'showRegionBounds',\n        'debug-show-slots': 'showSlotGrid',\n        'debug-show-labels': 'showConfidenceLabels',\n        'debug-show-detections': 'showDetectionBoxes',\n        'debug-show-heatmap': 'showVarianceHeatmap',\n        'debug-show-colors': 'showDominantColors',\n    };\n\n    Object.entries(optionMap).forEach(([elementId, optionKey]) => {\n        const checkbox = document.getElementById(elementId) as HTMLInputElement;\n        if (checkbox) {\n            // Set initial state\n            checkbox.checked = options[optionKey] as boolean;\n\n            // Handle changes using centralized event manager\n            eventManager.add(checkbox, 'change', () => {\n                setDebugOptions({ [optionKey]: checkbox.checked });\n            });\n        }\n    });\n}\n\n// ========================================\n// Statistics Display\n// ========================================\n\n/**\n * Update the statistics display\n */\nexport function updateStats(): void {\n    const stats = getStats();\n\n    const totalEl = document.getElementById('debug-stat-total');\n    const confidenceEl = document.getElementById('debug-stat-confidence');\n    const timeEl = document.getElementById('debug-stat-time');\n    const cacheEl = document.getElementById('debug-stat-cache');\n\n    if (totalEl) {\n        totalEl.textContent = String(stats.totalDetections);\n    }\n\n    if (confidenceEl) {\n        confidenceEl.textContent = stats.averageConfidence > 0 ? `${(stats.averageConfidence * 100).toFixed(1)}%` : '-';\n    }\n\n    if (timeEl) {\n        timeEl.textContent = stats.averageProcessingTime > 0 ? `${stats.averageProcessingTime.toFixed(0)}ms` : '-';\n    }\n\n    if (cacheEl) {\n        const total = stats.templateCacheHits + stats.templateCacheMisses;\n        cacheEl.textContent = total > 0 ? `${stats.templateCacheHits}/${total}` : '0/0';\n    }\n}\n\n// ========================================\n// Log Viewer\n// ========================================\n\n/**\n * Initialize log filter dropdown\n * Uses centralized event manager for cleanup\n */\nfunction initLogFilter(): void {\n    const filterSelect = document.getElementById('debug-log-filter') as HTMLSelectElement;\n    if (filterSelect) {\n        eventManager.add(filterSelect, 'change', () => {\n            currentLogFilter = filterSelect.value;\n            updateLogViewer();\n        });\n    }\n}\n\n/**\n * Update the log viewer with current logs\n */\nexport function updateLogViewer(): void {\n    const viewer = document.getElementById('debug-log-viewer');\n    if (!viewer) return;\n\n    let logs = getLogs();\n\n    // Apply filter\n    if (currentLogFilter !== 'all') {\n        logs = logs.filter(log => log.level === currentLogFilter);\n    }\n\n    // Get most recent 50 logs\n    const recentLogs = logs.slice(-50).reverse();\n\n    if (recentLogs.length === 0) {\n        viewer.innerHTML = '<p class=\"debug-log-empty\">No logs yet. Run a detection to see logs.</p>';\n        return;\n    }\n\n    viewer.innerHTML = recentLogs.map(log => formatLogEntry(log)).join('');\n}\n\n/**\n * Format a single log entry for display\n */\nfunction formatLogEntry(log: DebugLogEntry): string {\n    const time = new Date(log.timestamp).toLocaleTimeString('en-US', {\n        hour12: false,\n        hour: '2-digit',\n        minute: '2-digit',\n        second: '2-digit',\n    });\n\n    return `\n        <div class=\"debug-log-entry ${escapeHtml(log.level)}\">\n            <span class=\"debug-log-time\">${time}</span>\n            <span class=\"debug-log-category\">${escapeHtml(log.category)}</span>\n            <span class=\"debug-log-message\">${escapeHtml(log.message)}</span>\n        </div>\n    `;\n}\n\n/**\n * Escape HTML in log messages\n */\nfunction escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n}\n\n// ========================================\n// Action Buttons\n// ========================================\n\n/**\n * Initialize action buttons\n * Uses centralized event manager for cleanup\n */\nfunction initActionButtons(): void {\n    // Export logs - use dom-utils downloadFile\n    const exportBtn = document.getElementById('debug-export-logs');\n    if (exportBtn) {\n        eventManager.add(exportBtn, 'click', () => {\n            const logsJson = exportLogs();\n            downloadJsonFile(JSON.parse(logsJson), `megabonk-debug-logs-${Date.now()}`);\n        });\n    }\n\n    // Clear logs\n    const clearBtn = document.getElementById('debug-clear-logs');\n    if (clearBtn) {\n        eventManager.add(clearBtn, 'click', () => {\n            clearLogs();\n            updateLogViewer();\n        });\n    }\n\n    // Reset stats\n    const resetBtn = document.getElementById('debug-reset-stats');\n    if (resetBtn) {\n        eventManager.add(resetBtn, 'click', () => {\n            resetStats();\n            updateStats();\n        });\n    }\n\n    // Download overlay\n    const downloadBtn = document.getElementById('debug-download-overlay') as HTMLButtonElement;\n    if (downloadBtn) {\n        eventManager.add(downloadBtn, 'click', () => {\n            if (lastOverlayUrl) {\n                downloadDebugImage(lastOverlayUrl, `debug-overlay-${Date.now()}.png`);\n            }\n        });\n    }\n}\n\n/**\n * Set the last overlay URL for download\n */\nexport function setLastOverlayUrl(url: string | null): void {\n    lastOverlayUrl = url;\n    const downloadBtn = document.getElementById('debug-download-overlay') as HTMLButtonElement;\n    if (downloadBtn) {\n        downloadBtn.disabled = !url;\n    }\n}\n\n// ========================================\n// Enhanced Debug Controls\n// ========================================\n\n/**\n * Initialize confidence threshold slider\n * Uses centralized event manager for cleanup\n */\nexport function initConfidenceSlider(): void {\n    const slider = document.getElementById('debug-confidence-slider') as HTMLInputElement;\n    const valueDisplay = document.getElementById('debug-confidence-value');\n\n    if (slider && valueDisplay) {\n        slider.value = String(currentConfidenceThreshold * 100);\n        valueDisplay.textContent = `${Math.round(currentConfidenceThreshold * 100)}%`;\n\n        eventManager.add(slider, 'input', () => {\n            currentConfidenceThreshold = parseInt(slider.value, 10) / 100;\n            valueDisplay.textContent = `${slider.value}%`;\n\n            logger.debug({\n                operation: 'debug_ui.threshold_changed',\n                data: { threshold: currentConfidenceThreshold },\n            });\n        });\n    }\n}\n\n/**\n * Get current confidence threshold\n */\nexport function getConfidenceThreshold(): number {\n    return currentConfidenceThreshold;\n}\n\n/**\n * Set confidence threshold programmatically\n */\nexport function setConfidenceThreshold(threshold: number): void {\n    currentConfidenceThreshold = Math.max(0, Math.min(1, threshold));\n\n    const slider = document.getElementById('debug-confidence-slider') as HTMLInputElement;\n    const valueDisplay = document.getElementById('debug-confidence-value');\n\n    if (slider) {\n        slider.value = String(Math.round(currentConfidenceThreshold * 100));\n    }\n    if (valueDisplay) {\n        valueDisplay.textContent = `${Math.round(currentConfidenceThreshold * 100)}%`;\n    }\n}\n\n// ========================================\n// Breadcrumb Display\n// ========================================\n\n/**\n * Update breadcrumb viewer\n */\nexport function updateBreadcrumbViewer(): void {\n    const viewer = document.getElementById('debug-breadcrumb-viewer');\n    if (!viewer) return;\n\n    const breadcrumbs = getBreadcrumbs();\n    const recent = breadcrumbs.slice(-30).reverse();\n\n    if (recent.length === 0) {\n        viewer.innerHTML =\n            '<p class=\"debug-log-empty\">No breadcrumbs yet. Interact with the app to see breadcrumbs.</p>';\n        return;\n    }\n\n    viewer.innerHTML = recent\n        .map(crumb => {\n            const time = new Date(crumb.timestamp).toLocaleTimeString('en-US', {\n                hour12: false,\n                hour: '2-digit',\n                minute: '2-digit',\n                second: '2-digit',\n            });\n\n            const typeClass = crumb.type === 'error' ? 'error' : 'info';\n\n            return `\n                <div class=\"debug-log-entry ${typeClass}\">\n                    <span class=\"debug-log-time\">${time}</span>\n                    <span class=\"debug-log-category\">${escapeHtml(crumb.type)}</span>\n                    <span class=\"debug-log-message\">${escapeHtml(crumb.message)}</span>\n                </div>\n            `;\n        })\n        .join('');\n}\n\n/**\n * Initialize breadcrumb controls\n * Uses centralized event manager for cleanup\n */\nexport function initBreadcrumbControls(): void {\n    const clearBtn = document.getElementById('debug-clear-breadcrumbs');\n    if (clearBtn) {\n        eventManager.add(clearBtn, 'click', () => {\n            clearBreadcrumbs();\n            updateBreadcrumbViewer();\n        });\n    }\n\n    const exportBtn = document.getElementById('debug-export-breadcrumbs');\n    if (exportBtn) {\n        eventManager.add(exportBtn, 'click', () => {\n            const json = exportBreadcrumbs();\n            downloadJsonFile(JSON.parse(json), `megabonk-breadcrumbs-${Date.now()}`);\n        });\n    }\n}\n\n// ========================================\n// Request Timing Display\n// ========================================\n\n/**\n * Update request timing viewer\n */\nexport function updateRequestViewer(): void {\n    const viewer = document.getElementById('debug-request-viewer');\n    if (!viewer) return;\n\n    const stats = requestTimer.getStats();\n\n    if (stats.totalRequests === 0) {\n        viewer.innerHTML = '<p class=\"debug-log-empty\">No requests tracked yet.</p>';\n        return;\n    }\n\n    let html = `\n        <div class=\"debug-stats-row\">\n            <span>Total Requests:</span>\n            <span>${stats.totalRequests}</span>\n        </div>\n        <div class=\"debug-stats-row\">\n            <span>Successful:</span>\n            <span class=\"success\">${stats.successfulRequests}</span>\n        </div>\n        <div class=\"debug-stats-row\">\n            <span>Failed:</span>\n            <span class=\"error\">${stats.failedRequests}</span>\n        </div>\n        <div class=\"debug-stats-row\">\n            <span>Cached:</span>\n            <span>${stats.cachedRequests}</span>\n        </div>\n        <div class=\"debug-stats-row\">\n            <span>Avg Duration:</span>\n            <span>${stats.averageDurationMs}ms</span>\n        </div>\n    `;\n\n    if (stats.slowestRequest) {\n        html += `\n            <div class=\"debug-stats-row warning\">\n                <span>Slowest:</span>\n                <span>${stats.slowestRequest.durationMs}ms (${stats.slowestRequest.url.slice(-30)})</span>\n            </div>\n        `;\n    }\n\n    html += '<hr><h4>Recent Requests</h4>';\n\n    stats.recentRequests.reverse().forEach(req => {\n        const statusClass = (req.status ?? 0) === 0 ? 'error' : (req.status ?? 0) >= 400 ? 'warning' : 'success';\n        html += `\n            <div class=\"debug-log-entry ${statusClass}\">\n                <span class=\"debug-log-time\">${req.durationMs || 0}ms</span>\n                <span class=\"debug-log-category\">${req.method} ${req.status}</span>\n                <span class=\"debug-log-message\">${escapeHtml(req.url.slice(-50))}</span>\n            </div>\n        `;\n    });\n\n    viewer.innerHTML = html;\n}\n\n// ========================================\n// State Snapshot Display\n// ========================================\n\n/**\n * Update state snapshot viewer\n */\nexport function updateStateViewer(): void {\n    const viewer = document.getElementById('debug-state-viewer');\n    if (!viewer) return;\n\n    const snapshot = captureStateSnapshot();\n\n    const html = `\n        <pre class=\"debug-state-json\">${escapeHtml(JSON.stringify(snapshot, null, 2))}</pre>\n    `;\n\n    viewer.innerHTML = html;\n}\n\n/**\n * Initialize state controls\n * Uses centralized event manager for cleanup\n */\nexport function initStateControls(): void {\n    const refreshBtn = document.getElementById('debug-refresh-state');\n    if (refreshBtn) {\n        eventManager.add(refreshBtn, 'click', () => {\n            updateStateViewer();\n        });\n    }\n\n    const exportBtn = document.getElementById('debug-export-state');\n    if (exportBtn) {\n        eventManager.add(exportBtn, 'click', () => {\n            const snapshot = captureStateSnapshot();\n            downloadJsonFile(snapshot, `megabonk-state-${Date.now()}`);\n        });\n    }\n}\n\n// ========================================\n// Debug Tab Switching\n// ========================================\n\n/**\n * Initialize debug tab switching\n * Uses centralized event manager for cleanup\n */\nexport function initDebugTabs(): void {\n    const tabButtons = document.querySelectorAll('[data-debug-tab]');\n\n    tabButtons.forEach(btn => {\n        eventManager.add(btn as HTMLElement, 'click', () => {\n            const tab = (btn as HTMLElement).dataset.debugTab as typeof activeDebugTab;\n            switchDebugTab(tab);\n        });\n    });\n}\n\n/**\n * Switch active debug tab\n */\nexport function switchDebugTab(tab: typeof activeDebugTab): void {\n    activeDebugTab = tab;\n\n    // Update tab buttons\n    document.querySelectorAll('[data-debug-tab]').forEach(btn => {\n        btn.classList.toggle('active', (btn as HTMLElement).dataset.debugTab === tab);\n    });\n\n    // Update tab content\n    document.querySelectorAll('[data-debug-content]').forEach(content => {\n        const contentTab = (content as HTMLElement).dataset.debugContent;\n        (content as HTMLElement).style.display = contentTab === tab ? 'block' : 'none';\n    });\n\n    // Update content\n    switch (tab) {\n        case 'logs':\n            updateLogViewer();\n            break;\n        case 'breadcrumbs':\n            updateBreadcrumbViewer();\n            break;\n        case 'requests':\n            updateRequestViewer();\n            break;\n        case 'state':\n            updateStateViewer();\n            break;\n    }\n}\n\n// Download utility moved to dom-utils.ts (downloadJson, downloadFile)\n\n// ========================================\n// Export\n// ========================================\n\nexport { isDebugEnabled, setDebugEnabled };\n","// ========================================\n// MegaBonk Pull-to-Refresh Module\n// ========================================\n// Enables pull-down gesture to refresh data on touch devices\n\nimport { loadAllData } from './data-service.ts';\nimport { logger } from './logger.ts';\nimport { ToastManager } from './toast.ts';\n\n// ========================================\n// Constants\n// ========================================\n\nconst PULL_THRESHOLD = 120; // Pixels to pull before refresh triggers (increased from 80 to reduce accidental triggers)\nconst MAX_PULL_DISTANCE = 150; // Maximum visual pull distance\nconst RESISTANCE_FACTOR = 0.3; // Resistance when pulling past threshold (reduced for smoother feel)\n\n// ========================================\n// State\n// ========================================\n\ninterface PullRefreshState {\n    startY: number;\n    currentY: number;\n    isPulling: boolean;\n    isRefreshing: boolean;\n    indicator: HTMLElement | null;\n}\n\nconst state: PullRefreshState = {\n    startY: 0,\n    currentY: 0,\n    isPulling: false,\n    isRefreshing: false,\n    indicator: null,\n};\n\n// ========================================\n// Detection\n// ========================================\n\n/**\n * Check if we're on a touch device\n */\nfunction isTouchDevice(): boolean {\n    return 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n}\n\n/**\n * Check if page is scrolled to the top\n */\nfunction isAtTop(): boolean {\n    return window.scrollY <= 0;\n}\n\n// ========================================\n// UI\n// ========================================\n\n/**\n * Create the pull-to-refresh indicator element\n */\nfunction createIndicator(): HTMLElement {\n    const indicator = document.createElement('div');\n    indicator.className = 'pull-refresh-indicator';\n    indicator.innerHTML = `\n        <div class=\"pull-refresh-content\">\n            <div class=\"pull-refresh-spinner\"></div>\n            <span class=\"pull-refresh-text\">Pull to refresh</span>\n        </div>\n    `;\n    document.body.prepend(indicator);\n    return indicator;\n}\n\n/**\n * Update the indicator position and state\n */\nfunction updateIndicator(distance: number, isRefreshing: boolean = false): void {\n    if (!state.indicator) return;\n\n    const progress = Math.min(distance / PULL_THRESHOLD, 1);\n    const clampedDistance = Math.min(distance, MAX_PULL_DISTANCE);\n\n    state.indicator.style.setProperty('--pull-distance', `${clampedDistance}px`);\n    state.indicator.style.setProperty('--pull-progress', `${progress}`);\n    \n    const textEl = state.indicator.querySelector('.pull-refresh-text');\n    if (textEl) {\n        if (isRefreshing) {\n            textEl.textContent = 'Refreshing...';\n        } else if (distance >= PULL_THRESHOLD) {\n            textEl.textContent = 'Release to refresh';\n        } else {\n            textEl.textContent = 'Pull to refresh';\n        }\n    }\n\n    state.indicator.classList.toggle('active', distance > 0);\n    state.indicator.classList.toggle('threshold-reached', distance >= PULL_THRESHOLD);\n    state.indicator.classList.toggle('refreshing', isRefreshing);\n}\n\n/**\n * Reset the indicator to hidden state\n */\nfunction resetIndicator(): void {\n    if (!state.indicator) return;\n    \n    state.indicator.classList.add('resetting');\n    updateIndicator(0, false);\n    \n    setTimeout(() => {\n        state.indicator?.classList.remove('active', 'threshold-reached', 'refreshing', 'resetting');\n    }, 300);\n}\n\n// ========================================\n// Touch Handlers\n// ========================================\n\nfunction handleTouchStart(e: TouchEvent): void {\n    // Only enable when at top of page and not already refreshing\n    if (!isAtTop() || state.isRefreshing) return;\n    \n    const touch = e.touches[0];\n    if (!touch) return;\n    \n    state.startY = touch.clientY;\n    state.isPulling = true;\n}\n\nfunction handleTouchMove(e: TouchEvent): void {\n    if (!state.isPulling || state.isRefreshing) return;\n    if (!isAtTop()) {\n        state.isPulling = false;\n        return;\n    }\n\n    const touch = e.touches[0];\n    if (!touch) return;\n    \n    state.currentY = touch.clientY;\n    let distance = state.currentY - state.startY;\n\n    // Only allow pulling down\n    if (distance < 0) {\n        distance = 0;\n        state.isPulling = false;\n        return;\n    }\n\n    // Apply resistance after threshold\n    if (distance > PULL_THRESHOLD) {\n        const overPull = distance - PULL_THRESHOLD;\n        distance = PULL_THRESHOLD + (overPull * RESISTANCE_FACTOR);\n    }\n\n    // Prevent default scrolling when pulling\n    if (distance > 10) {\n        e.preventDefault();\n    }\n\n    updateIndicator(distance);\n}\n\nasync function handleTouchEnd(): Promise<void> {\n    if (!state.isPulling) return;\n    state.isPulling = false;\n\n    const distance = state.currentY - state.startY;\n\n    if (distance >= PULL_THRESHOLD && !state.isRefreshing) {\n        await triggerRefresh();\n    } else {\n        resetIndicator();\n    }\n\n    state.startY = 0;\n    state.currentY = 0;\n}\n\n// ========================================\n// Refresh Logic\n// ========================================\n\n/**\n * Trigger a data refresh\n */\nasync function triggerRefresh(): Promise<void> {\n    state.isRefreshing = true;\n    updateIndicator(PULL_THRESHOLD, true);\n\n    logger.info({\n        operation: 'pull-refresh.triggered',\n        data: { source: 'touch-gesture' },\n    });\n\n    const startTime = performance.now();\n\n    try {\n        await loadAllData();\n        \n        const duration = Math.round(performance.now() - startTime);\n        logger.info({\n            operation: 'pull-refresh.complete',\n            durationMs: duration,\n            success: true,\n        });\n        \n        ToastManager.success('Data refreshed!');\n    } catch (error) {\n        const err = error as Error;\n        logger.error({\n            operation: 'pull-refresh.failed',\n            error: {\n                name: err.name,\n                message: err.message,\n                module: 'pull-refresh',\n            },\n        });\n        ToastManager.error('Failed to refresh data');\n    } finally {\n        state.isRefreshing = false;\n        resetIndicator();\n    }\n}\n\n// ========================================\n// Initialization\n// ========================================\n\n/**\n * Initialize pull-to-refresh functionality\n * Only activates on touch devices\n */\nexport function initPullRefresh(): void {\n    // Only enable on touch devices\n    if (!isTouchDevice()) {\n        logger.debug({\n            operation: 'pull-refresh.skip',\n            data: { reason: 'not_touch_device' },\n        });\n        return;\n    }\n\n    // Create the indicator element\n    state.indicator = createIndicator();\n\n    // Add touch event listeners with passive: false for preventDefault\n    document.addEventListener('touchstart', handleTouchStart, { passive: true });\n    document.addEventListener('touchmove', handleTouchMove, { passive: false });\n    document.addEventListener('touchend', handleTouchEnd, { passive: true });\n\n    logger.info({\n        operation: 'pull-refresh.init',\n        data: { enabled: true },\n    });\n}\n\n/**\n * Clean up pull-to-refresh (for testing)\n */\nexport function cleanupPullRefresh(): void {\n    document.removeEventListener('touchstart', handleTouchStart);\n    document.removeEventListener('touchmove', handleTouchMove);\n    document.removeEventListener('touchend', handleTouchEnd);\n\n    if (state.indicator) {\n        state.indicator.remove();\n        state.indicator = null;\n    }\n\n    state.isPulling = false;\n    state.isRefreshing = false;\n}\n\n// ========================================\n// Global Exports\n// ========================================\n\nif (typeof window !== 'undefined') {\n    Object.assign(window, {\n        initPullRefresh,\n        cleanupPullRefresh,\n    });\n}\n","// ========================================\n// OCR Utility Functions\n// ========================================\n\n/** Default timeout for OCR operations (60 seconds) */\nexport const OCR_TIMEOUT_MS = 60000;\n\n/** Maximum retries for OCR operations */\nexport const OCR_MAX_RETRIES = 2;\n\n/**\n * Wrap a promise with a timeout\n * Rejects with TimeoutError if the promise doesn't resolve within the timeout\n */\nexport function withTimeout<T>(promise: Promise<T>, timeoutMs: number, operationName: string): Promise<T> {\n    return new Promise((resolve, reject) => {\n        const timeoutId = setTimeout(() => {\n            reject(new Error(`${operationName} timed out after ${timeoutMs}ms`));\n        }, timeoutMs);\n\n        promise\n            .then(result => {\n                clearTimeout(timeoutId);\n                resolve(result);\n            })\n            .catch(error => {\n                clearTimeout(timeoutId);\n                reject(error);\n            });\n    });\n}\n\n/**\n * Sleep for a given number of milliseconds\n */\nexport function sleep(ms: number): Promise<void> {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Split text into searchable segments (by newlines and common delimiters)\n */\nexport function splitIntoSegments(text: string): string[] {\n    // Split by newlines first\n    const lines = text.split('\\n');\n    const segments: string[] = [];\n\n    for (const line of lines) {\n        const trimmed = line.trim();\n        if (trimmed.length <= 2) continue;\n\n        // If line is very long (e.g., repeated items), also split by common delimiters\n        if (trimmed.length > 50) {\n            // Split by common OCR/game delimiters: comma, semicolon, pipe, tab\n            const subSegments = trimmed.split(/[,;|\\t]+/);\n            for (const seg of subSegments) {\n                const segTrimmed = seg.trim();\n                if (segTrimmed.length > 2) {\n                    segments.push(segTrimmed);\n                }\n            }\n        } else {\n            segments.push(trimmed);\n        }\n    }\n\n    return segments;\n}\n\n/**\n * Extract item counts from text (looks for patterns like \"x3\", \"2\", etc.)\n */\nexport function extractItemCounts(text: string): Map<string, number> {\n    const counts = new Map<string, number>();\n\n    // Pattern: \"item name x3\" or \"item name 2\" or \"item name (3)\"\n    const patterns = [/(.+?)\\s*[x]\\s*(\\d+)/gi, /(.+?)\\s*\\((\\d+)\\)/gi, /(.+?)\\s*:\\s*(\\d+)/gi];\n\n    for (const pattern of patterns) {\n        const matches = text.matchAll(pattern);\n        for (const match of matches) {\n            const name = match[1]?.trim();\n            const countStr = match[2];\n            if (name && countStr) {\n                const count = parseInt(countStr, 10);\n                if (!isNaN(count) && count > 0) {\n                    counts.set(name.toLowerCase(), count);\n                }\n            }\n        }\n    }\n\n    return counts;\n}\n","// ========================================\n// Tesseract Worker Management\n// ========================================\n// Handles lazy loading and lifecycle of Tesseract.js workers\n\nimport { logger } from '../logger.ts';\n\n// Lazy-loaded Tesseract module reference\nlet tesseractModule: typeof import('tesseract.js') | null = null;\n\n// Track active Tesseract workers for cleanup\nlet activeWorker: Awaited<ReturnType<typeof import('tesseract.js').createWorker>> | null = null;\nlet workerInitPromise: Promise<void> | null = null;\n\n/**\n * Lazy load Tesseract.js only when needed\n * This reduces initial bundle size since OCR may not be used in every session\n */\nexport async function getTesseract(): Promise<typeof import('tesseract.js')> {\n    if (!tesseractModule) {\n        logger.info({\n            operation: 'ocr.lazy_load',\n            data: { module: 'tesseract.js', phase: 'start' },\n        });\n        tesseractModule = await import('tesseract.js');\n        logger.info({\n            operation: 'ocr.lazy_load',\n            data: { module: 'tesseract.js', phase: 'complete' },\n        });\n    }\n    return tesseractModule;\n}\n\n/**\n * Get or create a reusable Tesseract worker\n * Workers are expensive to create, so we reuse them\n * Bug fix: Use mutex pattern to prevent race condition where multiple\n * concurrent calls could create multiple workers\n */\nexport async function getOrCreateWorker(): Promise<Awaited<ReturnType<typeof import('tesseract.js').createWorker>>> {\n    // If worker exists and is ready, return it\n    if (activeWorker) {\n        return activeWorker;\n    }\n\n    // Bug fix: If initialization is in progress, wait for it and return the result\n    // This prevents multiple concurrent callers from each creating their own worker\n    if (workerInitPromise) {\n        await workerInitPromise;\n        // After awaiting, worker should be ready (or failed)\n        if (activeWorker) {\n            return activeWorker;\n        }\n        // If still no worker after waiting, fall through to create new one\n        // This handles the case where previous initialization failed\n    }\n\n    // Create the initialization promise BEFORE any async operations\n    // This ensures concurrent callers will see the promise and wait\n    const Tesseract = await getTesseract();\n\n    // Double-check after async operation - another caller may have created the worker\n    if (activeWorker) {\n        return activeWorker;\n    }\n\n    // Create initialization promise that will be awaited by concurrent callers\n    workerInitPromise = (async () => {\n        // Triple-check inside the promise to handle edge cases\n        if (activeWorker) {\n            return;\n        }\n\n        logger.info({\n            operation: 'ocr.worker_init',\n            data: { phase: 'start' },\n        });\n\n        try {\n            const worker = await Tesseract.createWorker('eng', 1, {\n                logger: (info: { status: string; progress: number }) => {\n                    if (info.status === 'loading tesseract core' || info.status === 'initializing api') {\n                        logger.debug({\n                            operation: 'ocr.worker_progress',\n                            data: { status: info.status, progress: info.progress },\n                        });\n                    }\n                },\n            });\n\n            // Only assign if still no active worker (prevent overwriting)\n            if (!activeWorker) {\n                activeWorker = worker;\n            } else {\n                // Another caller won the race, terminate the duplicate\n                await worker.terminate();\n            }\n\n            logger.info({\n                operation: 'ocr.worker_init',\n                data: { phase: 'complete' },\n            });\n        } catch (error) {\n            logger.error({\n                operation: 'ocr.worker_init',\n                error: {\n                    name: (error as Error).name,\n                    message: (error as Error).message,\n                    module: 'ocr',\n                },\n            });\n            throw error;\n        }\n    })();\n\n    try {\n        await workerInitPromise;\n    } finally {\n        // Always clear the promise when done, even on error\n        workerInitPromise = null;\n    }\n\n    if (!activeWorker) {\n        throw new Error('Failed to initialize OCR worker');\n    }\n\n    return activeWorker;\n}\n\n/**\n * Terminate the Tesseract worker to free memory\n * Call this when OCR is no longer needed\n */\nexport async function terminateOCRWorker(): Promise<void> {\n    if (activeWorker) {\n        logger.info({\n            operation: 'ocr.worker_terminate',\n            data: { phase: 'start' },\n        });\n\n        try {\n            await activeWorker.terminate();\n            activeWorker = null;\n            workerInitPromise = null;\n\n            logger.info({\n                operation: 'ocr.worker_terminate',\n                data: { phase: 'complete' },\n            });\n        } catch (error) {\n            logger.warn({\n                operation: 'ocr.worker_terminate',\n                error: {\n                    name: (error as Error).name,\n                    message: (error as Error).message,\n                    module: 'ocr',\n                },\n            });\n            // Force cleanup even if terminate fails\n            activeWorker = null;\n            workerInitPromise = null;\n        }\n    }\n}\n\n/**\n * Check if OCR worker is currently active\n */\nexport function isOCRWorkerActive(): boolean {\n    return activeWorker !== null;\n}\n\n/**\n * Reset worker state (for testing)\n */\nexport function __resetWorkerForTesting(): void {\n    activeWorker = null;\n    workerInitPromise = null;\n}\n","/**\n * Fuse.js v7.1.0 - Lightweight fuzzy-search (http://fusejs.io)\n *\n * Copyright (c) 2025 Kiro Risk (http://kiro.me)\n * All Rights Reserved. Apache Software License 2.0\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n */\n\nfunction isArray(value) {\n  return !Array.isArray\n    ? getTag(value) === '[object Array]'\n    : Array.isArray(value)\n}\n\n// Adapted from: https://github.com/lodash/lodash/blob/master/.internal/baseToString.js\nconst INFINITY = 1 / 0;\nfunction baseToString(value) {\n  // Exit early for strings to avoid a performance hit in some environments.\n  if (typeof value == 'string') {\n    return value\n  }\n  let result = value + '';\n  return result == '0' && 1 / value == -INFINITY ? '-0' : result\n}\n\nfunction toString(value) {\n  return value == null ? '' : baseToString(value)\n}\n\nfunction isString(value) {\n  return typeof value === 'string'\n}\n\nfunction isNumber(value) {\n  return typeof value === 'number'\n}\n\n// Adapted from: https://github.com/lodash/lodash/blob/master/isBoolean.js\nfunction isBoolean(value) {\n  return (\n    value === true ||\n    value === false ||\n    (isObjectLike(value) && getTag(value) == '[object Boolean]')\n  )\n}\n\nfunction isObject(value) {\n  return typeof value === 'object'\n}\n\n// Checks if `value` is object-like.\nfunction isObjectLike(value) {\n  return isObject(value) && value !== null\n}\n\nfunction isDefined(value) {\n  return value !== undefined && value !== null\n}\n\nfunction isBlank(value) {\n  return !value.trim().length\n}\n\n// Gets the `toStringTag` of `value`.\n// Adapted from: https://github.com/lodash/lodash/blob/master/.internal/getTag.js\nfunction getTag(value) {\n  return value == null\n    ? value === undefined\n      ? '[object Undefined]'\n      : '[object Null]'\n    : Object.prototype.toString.call(value)\n}\n\nconst EXTENDED_SEARCH_UNAVAILABLE = 'Extended search is not available';\n\nconst INCORRECT_INDEX_TYPE = \"Incorrect 'index' type\";\n\nconst LOGICAL_SEARCH_INVALID_QUERY_FOR_KEY = (key) =>\n  `Invalid value for key ${key}`;\n\nconst PATTERN_LENGTH_TOO_LARGE = (max) =>\n  `Pattern length exceeds max of ${max}.`;\n\nconst MISSING_KEY_PROPERTY = (name) => `Missing ${name} property in key`;\n\nconst INVALID_KEY_WEIGHT_VALUE = (key) =>\n  `Property 'weight' in key '${key}' must be a positive integer`;\n\nconst hasOwn = Object.prototype.hasOwnProperty;\n\nclass KeyStore {\n  constructor(keys) {\n    this._keys = [];\n    this._keyMap = {};\n\n    let totalWeight = 0;\n\n    keys.forEach((key) => {\n      let obj = createKey(key);\n\n      this._keys.push(obj);\n      this._keyMap[obj.id] = obj;\n\n      totalWeight += obj.weight;\n    });\n\n    // Normalize weights so that their sum is equal to 1\n    this._keys.forEach((key) => {\n      key.weight /= totalWeight;\n    });\n  }\n  get(keyId) {\n    return this._keyMap[keyId]\n  }\n  keys() {\n    return this._keys\n  }\n  toJSON() {\n    return JSON.stringify(this._keys)\n  }\n}\n\nfunction createKey(key) {\n  let path = null;\n  let id = null;\n  let src = null;\n  let weight = 1;\n  let getFn = null;\n\n  if (isString(key) || isArray(key)) {\n    src = key;\n    path = createKeyPath(key);\n    id = createKeyId(key);\n  } else {\n    if (!hasOwn.call(key, 'name')) {\n      throw new Error(MISSING_KEY_PROPERTY('name'))\n    }\n\n    const name = key.name;\n    src = name;\n\n    if (hasOwn.call(key, 'weight')) {\n      weight = key.weight;\n\n      if (weight <= 0) {\n        throw new Error(INVALID_KEY_WEIGHT_VALUE(name))\n      }\n    }\n\n    path = createKeyPath(name);\n    id = createKeyId(name);\n    getFn = key.getFn;\n  }\n\n  return { path, id, weight, src, getFn }\n}\n\nfunction createKeyPath(key) {\n  return isArray(key) ? key : key.split('.')\n}\n\nfunction createKeyId(key) {\n  return isArray(key) ? key.join('.') : key\n}\n\nfunction get(obj, path) {\n  let list = [];\n  let arr = false;\n\n  const deepGet = (obj, path, index) => {\n    if (!isDefined(obj)) {\n      return\n    }\n    if (!path[index]) {\n      // If there's no path left, we've arrived at the object we care about.\n      list.push(obj);\n    } else {\n      let key = path[index];\n\n      const value = obj[key];\n\n      if (!isDefined(value)) {\n        return\n      }\n\n      // If we're at the last value in the path, and if it's a string/number/bool,\n      // add it to the list\n      if (\n        index === path.length - 1 &&\n        (isString(value) || isNumber(value) || isBoolean(value))\n      ) {\n        list.push(toString(value));\n      } else if (isArray(value)) {\n        arr = true;\n        // Search each item in the array.\n        for (let i = 0, len = value.length; i < len; i += 1) {\n          deepGet(value[i], path, index + 1);\n        }\n      } else if (path.length) {\n        // An object. Recurse further.\n        deepGet(value, path, index + 1);\n      }\n    }\n  };\n\n  // Backwards compatibility (since path used to be a string)\n  deepGet(obj, isString(path) ? path.split('.') : path, 0);\n\n  return arr ? list : list[0]\n}\n\nconst MatchOptions = {\n  // Whether the matches should be included in the result set. When `true`, each record in the result\n  // set will include the indices of the matched characters.\n  // These can consequently be used for highlighting purposes.\n  includeMatches: false,\n  // When `true`, the matching function will continue to the end of a search pattern even if\n  // a perfect match has already been located in the string.\n  findAllMatches: false,\n  // Minimum number of characters that must be matched before a result is considered a match\n  minMatchCharLength: 1\n};\n\nconst BasicOptions = {\n  // When `true`, the algorithm continues searching to the end of the input even if a perfect\n  // match is found before the end of the same input.\n  isCaseSensitive: false,\n  // When `true`, the algorithm will ignore diacritics (accents) in comparisons\n  ignoreDiacritics: false,\n  // When true, the matching function will continue to the end of a search pattern even if\n  includeScore: false,\n  // List of properties that will be searched. This also supports nested properties.\n  keys: [],\n  // Whether to sort the result list, by score\n  shouldSort: true,\n  // Default sort function: sort by ascending score, ascending index\n  sortFn: (a, b) =>\n    a.score === b.score ? (a.idx < b.idx ? -1 : 1) : a.score < b.score ? -1 : 1\n};\n\nconst FuzzyOptions = {\n  // Approximately where in the text is the pattern expected to be found?\n  location: 0,\n  // At what point does the match algorithm give up. A threshold of '0.0' requires a perfect match\n  // (of both letters and location), a threshold of '1.0' would match anything.\n  threshold: 0.6,\n  // Determines how close the match must be to the fuzzy location (specified above).\n  // An exact letter match which is 'distance' characters away from the fuzzy location\n  // would score as a complete mismatch. A distance of '0' requires the match be at\n  // the exact location specified, a threshold of '1000' would require a perfect match\n  // to be within 800 characters of the fuzzy location to be found using a 0.8 threshold.\n  distance: 100\n};\n\nconst AdvancedOptions = {\n  // When `true`, it enables the use of unix-like search commands\n  useExtendedSearch: false,\n  // The get function to use when fetching an object's properties.\n  // The default will search nested paths *ie foo.bar.baz*\n  getFn: get,\n  // When `true`, search will ignore `location` and `distance`, so it won't matter\n  // where in the string the pattern appears.\n  // More info: https://fusejs.io/concepts/scoring-theory.html#fuzziness-score\n  ignoreLocation: false,\n  // When `true`, the calculation for the relevance score (used for sorting) will\n  // ignore the field-length norm.\n  // More info: https://fusejs.io/concepts/scoring-theory.html#field-length-norm\n  ignoreFieldNorm: false,\n  // The weight to determine how much field length norm effects scoring.\n  fieldNormWeight: 1\n};\n\nvar Config = {\n  ...BasicOptions,\n  ...MatchOptions,\n  ...FuzzyOptions,\n  ...AdvancedOptions\n};\n\nconst SPACE = /[^ ]+/g;\n\n// Field-length norm: the shorter the field, the higher the weight.\n// Set to 3 decimals to reduce index size.\nfunction norm(weight = 1, mantissa = 3) {\n  const cache = new Map();\n  const m = Math.pow(10, mantissa);\n\n  return {\n    get(value) {\n      const numTokens = value.match(SPACE).length;\n\n      if (cache.has(numTokens)) {\n        return cache.get(numTokens)\n      }\n\n      // Default function is 1/sqrt(x), weight makes that variable\n      const norm = 1 / Math.pow(numTokens, 0.5 * weight);\n\n      // In place of `toFixed(mantissa)`, for faster computation\n      const n = parseFloat(Math.round(norm * m) / m);\n\n      cache.set(numTokens, n);\n\n      return n\n    },\n    clear() {\n      cache.clear();\n    }\n  }\n}\n\nclass FuseIndex {\n  constructor({\n    getFn = Config.getFn,\n    fieldNormWeight = Config.fieldNormWeight\n  } = {}) {\n    this.norm = norm(fieldNormWeight, 3);\n    this.getFn = getFn;\n    this.isCreated = false;\n\n    this.setIndexRecords();\n  }\n  setSources(docs = []) {\n    this.docs = docs;\n  }\n  setIndexRecords(records = []) {\n    this.records = records;\n  }\n  setKeys(keys = []) {\n    this.keys = keys;\n    this._keysMap = {};\n    keys.forEach((key, idx) => {\n      this._keysMap[key.id] = idx;\n    });\n  }\n  create() {\n    if (this.isCreated || !this.docs.length) {\n      return\n    }\n\n    this.isCreated = true;\n\n    // List is Array<String>\n    if (isString(this.docs[0])) {\n      this.docs.forEach((doc, docIndex) => {\n        this._addString(doc, docIndex);\n      });\n    } else {\n      // List is Array<Object>\n      this.docs.forEach((doc, docIndex) => {\n        this._addObject(doc, docIndex);\n      });\n    }\n\n    this.norm.clear();\n  }\n  // Adds a doc to the end of the index\n  add(doc) {\n    const idx = this.size();\n\n    if (isString(doc)) {\n      this._addString(doc, idx);\n    } else {\n      this._addObject(doc, idx);\n    }\n  }\n  // Removes the doc at the specified index of the index\n  removeAt(idx) {\n    this.records.splice(idx, 1);\n\n    // Change ref index of every subsquent doc\n    for (let i = idx, len = this.size(); i < len; i += 1) {\n      this.records[i].i -= 1;\n    }\n  }\n  getValueForItemAtKeyId(item, keyId) {\n    return item[this._keysMap[keyId]]\n  }\n  size() {\n    return this.records.length\n  }\n  _addString(doc, docIndex) {\n    if (!isDefined(doc) || isBlank(doc)) {\n      return\n    }\n\n    let record = {\n      v: doc,\n      i: docIndex,\n      n: this.norm.get(doc)\n    };\n\n    this.records.push(record);\n  }\n  _addObject(doc, docIndex) {\n    let record = { i: docIndex, $: {} };\n\n    // Iterate over every key (i.e, path), and fetch the value at that key\n    this.keys.forEach((key, keyIndex) => {\n      let value = key.getFn ? key.getFn(doc) : this.getFn(doc, key.path);\n\n      if (!isDefined(value)) {\n        return\n      }\n\n      if (isArray(value)) {\n        let subRecords = [];\n        const stack = [{ nestedArrIndex: -1, value }];\n\n        while (stack.length) {\n          const { nestedArrIndex, value } = stack.pop();\n\n          if (!isDefined(value)) {\n            continue\n          }\n\n          if (isString(value) && !isBlank(value)) {\n            let subRecord = {\n              v: value,\n              i: nestedArrIndex,\n              n: this.norm.get(value)\n            };\n\n            subRecords.push(subRecord);\n          } else if (isArray(value)) {\n            value.forEach((item, k) => {\n              stack.push({\n                nestedArrIndex: k,\n                value: item\n              });\n            });\n          } else ;\n        }\n        record.$[keyIndex] = subRecords;\n      } else if (isString(value) && !isBlank(value)) {\n        let subRecord = {\n          v: value,\n          n: this.norm.get(value)\n        };\n\n        record.$[keyIndex] = subRecord;\n      }\n    });\n\n    this.records.push(record);\n  }\n  toJSON() {\n    return {\n      keys: this.keys,\n      records: this.records\n    }\n  }\n}\n\nfunction createIndex(\n  keys,\n  docs,\n  { getFn = Config.getFn, fieldNormWeight = Config.fieldNormWeight } = {}\n) {\n  const myIndex = new FuseIndex({ getFn, fieldNormWeight });\n  myIndex.setKeys(keys.map(createKey));\n  myIndex.setSources(docs);\n  myIndex.create();\n  return myIndex\n}\n\nfunction parseIndex(\n  data,\n  { getFn = Config.getFn, fieldNormWeight = Config.fieldNormWeight } = {}\n) {\n  const { keys, records } = data;\n  const myIndex = new FuseIndex({ getFn, fieldNormWeight });\n  myIndex.setKeys(keys);\n  myIndex.setIndexRecords(records);\n  return myIndex\n}\n\nfunction computeScore$1(\n  pattern,\n  {\n    errors = 0,\n    currentLocation = 0,\n    expectedLocation = 0,\n    distance = Config.distance,\n    ignoreLocation = Config.ignoreLocation\n  } = {}\n) {\n  const accuracy = errors / pattern.length;\n\n  if (ignoreLocation) {\n    return accuracy\n  }\n\n  const proximity = Math.abs(expectedLocation - currentLocation);\n\n  if (!distance) {\n    // Dodge divide by zero error.\n    return proximity ? 1.0 : accuracy\n  }\n\n  return accuracy + proximity / distance\n}\n\nfunction convertMaskToIndices(\n  matchmask = [],\n  minMatchCharLength = Config.minMatchCharLength\n) {\n  let indices = [];\n  let start = -1;\n  let end = -1;\n  let i = 0;\n\n  for (let len = matchmask.length; i < len; i += 1) {\n    let match = matchmask[i];\n    if (match && start === -1) {\n      start = i;\n    } else if (!match && start !== -1) {\n      end = i - 1;\n      if (end - start + 1 >= minMatchCharLength) {\n        indices.push([start, end]);\n      }\n      start = -1;\n    }\n  }\n\n  // (i-1 - start) + 1 => i - start\n  if (matchmask[i - 1] && i - start >= minMatchCharLength) {\n    indices.push([start, i - 1]);\n  }\n\n  return indices\n}\n\n// Machine word size\nconst MAX_BITS = 32;\n\nfunction search(\n  text,\n  pattern,\n  patternAlphabet,\n  {\n    location = Config.location,\n    distance = Config.distance,\n    threshold = Config.threshold,\n    findAllMatches = Config.findAllMatches,\n    minMatchCharLength = Config.minMatchCharLength,\n    includeMatches = Config.includeMatches,\n    ignoreLocation = Config.ignoreLocation\n  } = {}\n) {\n  if (pattern.length > MAX_BITS) {\n    throw new Error(PATTERN_LENGTH_TOO_LARGE(MAX_BITS))\n  }\n\n  const patternLen = pattern.length;\n  // Set starting location at beginning text and initialize the alphabet.\n  const textLen = text.length;\n  // Handle the case when location > text.length\n  const expectedLocation = Math.max(0, Math.min(location, textLen));\n  // Highest score beyond which we give up.\n  let currentThreshold = threshold;\n  // Is there a nearby exact match? (speedup)\n  let bestLocation = expectedLocation;\n\n  // Performance: only computer matches when the minMatchCharLength > 1\n  // OR if `includeMatches` is true.\n  const computeMatches = minMatchCharLength > 1 || includeMatches;\n  // A mask of the matches, used for building the indices\n  const matchMask = computeMatches ? Array(textLen) : [];\n\n  let index;\n\n  // Get all exact matches, here for speed up\n  while ((index = text.indexOf(pattern, bestLocation)) > -1) {\n    let score = computeScore$1(pattern, {\n      currentLocation: index,\n      expectedLocation,\n      distance,\n      ignoreLocation\n    });\n\n    currentThreshold = Math.min(score, currentThreshold);\n    bestLocation = index + patternLen;\n\n    if (computeMatches) {\n      let i = 0;\n      while (i < patternLen) {\n        matchMask[index + i] = 1;\n        i += 1;\n      }\n    }\n  }\n\n  // Reset the best location\n  bestLocation = -1;\n\n  let lastBitArr = [];\n  let finalScore = 1;\n  let binMax = patternLen + textLen;\n\n  const mask = 1 << (patternLen - 1);\n\n  for (let i = 0; i < patternLen; i += 1) {\n    // Scan for the best match; each iteration allows for one more error.\n    // Run a binary search to determine how far from the match location we can stray\n    // at this error level.\n    let binMin = 0;\n    let binMid = binMax;\n\n    while (binMin < binMid) {\n      const score = computeScore$1(pattern, {\n        errors: i,\n        currentLocation: expectedLocation + binMid,\n        expectedLocation,\n        distance,\n        ignoreLocation\n      });\n\n      if (score <= currentThreshold) {\n        binMin = binMid;\n      } else {\n        binMax = binMid;\n      }\n\n      binMid = Math.floor((binMax - binMin) / 2 + binMin);\n    }\n\n    // Use the result from this iteration as the maximum for the next.\n    binMax = binMid;\n\n    let start = Math.max(1, expectedLocation - binMid + 1);\n    let finish = findAllMatches\n      ? textLen\n      : Math.min(expectedLocation + binMid, textLen) + patternLen;\n\n    // Initialize the bit array\n    let bitArr = Array(finish + 2);\n\n    bitArr[finish + 1] = (1 << i) - 1;\n\n    for (let j = finish; j >= start; j -= 1) {\n      let currentLocation = j - 1;\n      let charMatch = patternAlphabet[text.charAt(currentLocation)];\n\n      if (computeMatches) {\n        // Speed up: quick bool to int conversion (i.e, `charMatch ? 1 : 0`)\n        matchMask[currentLocation] = +!!charMatch;\n      }\n\n      // First pass: exact match\n      bitArr[j] = ((bitArr[j + 1] << 1) | 1) & charMatch;\n\n      // Subsequent passes: fuzzy match\n      if (i) {\n        bitArr[j] |=\n          ((lastBitArr[j + 1] | lastBitArr[j]) << 1) | 1 | lastBitArr[j + 1];\n      }\n\n      if (bitArr[j] & mask) {\n        finalScore = computeScore$1(pattern, {\n          errors: i,\n          currentLocation,\n          expectedLocation,\n          distance,\n          ignoreLocation\n        });\n\n        // This match will almost certainly be better than any existing match.\n        // But check anyway.\n        if (finalScore <= currentThreshold) {\n          // Indeed it is\n          currentThreshold = finalScore;\n          bestLocation = currentLocation;\n\n          // Already passed `loc`, downhill from here on in.\n          if (bestLocation <= expectedLocation) {\n            break\n          }\n\n          // When passing `bestLocation`, don't exceed our current distance from `expectedLocation`.\n          start = Math.max(1, 2 * expectedLocation - bestLocation);\n        }\n      }\n    }\n\n    // No hope for a (better) match at greater error levels.\n    const score = computeScore$1(pattern, {\n      errors: i + 1,\n      currentLocation: expectedLocation,\n      expectedLocation,\n      distance,\n      ignoreLocation\n    });\n\n    if (score > currentThreshold) {\n      break\n    }\n\n    lastBitArr = bitArr;\n  }\n\n  const result = {\n    isMatch: bestLocation >= 0,\n    // Count exact matches (those with a score of 0) to be \"almost\" exact\n    score: Math.max(0.001, finalScore)\n  };\n\n  if (computeMatches) {\n    const indices = convertMaskToIndices(matchMask, minMatchCharLength);\n    if (!indices.length) {\n      result.isMatch = false;\n    } else if (includeMatches) {\n      result.indices = indices;\n    }\n  }\n\n  return result\n}\n\nfunction createPatternAlphabet(pattern) {\n  let mask = {};\n\n  for (let i = 0, len = pattern.length; i < len; i += 1) {\n    const char = pattern.charAt(i);\n    mask[char] = (mask[char] || 0) | (1 << (len - i - 1));\n  }\n\n  return mask\n}\n\nconst stripDiacritics = String.prototype.normalize\n    ? ((str) => str.normalize('NFD').replace(/[\\u0300-\\u036F\\u0483-\\u0489\\u0591-\\u05BD\\u05BF\\u05C1\\u05C2\\u05C4\\u05C5\\u05C7\\u0610-\\u061A\\u064B-\\u065F\\u0670\\u06D6-\\u06DC\\u06DF-\\u06E4\\u06E7\\u06E8\\u06EA-\\u06ED\\u0711\\u0730-\\u074A\\u07A6-\\u07B0\\u07EB-\\u07F3\\u07FD\\u0816-\\u0819\\u081B-\\u0823\\u0825-\\u0827\\u0829-\\u082D\\u0859-\\u085B\\u08D3-\\u08E1\\u08E3-\\u0903\\u093A-\\u093C\\u093E-\\u094F\\u0951-\\u0957\\u0962\\u0963\\u0981-\\u0983\\u09BC\\u09BE-\\u09C4\\u09C7\\u09C8\\u09CB-\\u09CD\\u09D7\\u09E2\\u09E3\\u09FE\\u0A01-\\u0A03\\u0A3C\\u0A3E-\\u0A42\\u0A47\\u0A48\\u0A4B-\\u0A4D\\u0A51\\u0A70\\u0A71\\u0A75\\u0A81-\\u0A83\\u0ABC\\u0ABE-\\u0AC5\\u0AC7-\\u0AC9\\u0ACB-\\u0ACD\\u0AE2\\u0AE3\\u0AFA-\\u0AFF\\u0B01-\\u0B03\\u0B3C\\u0B3E-\\u0B44\\u0B47\\u0B48\\u0B4B-\\u0B4D\\u0B56\\u0B57\\u0B62\\u0B63\\u0B82\\u0BBE-\\u0BC2\\u0BC6-\\u0BC8\\u0BCA-\\u0BCD\\u0BD7\\u0C00-\\u0C04\\u0C3E-\\u0C44\\u0C46-\\u0C48\\u0C4A-\\u0C4D\\u0C55\\u0C56\\u0C62\\u0C63\\u0C81-\\u0C83\\u0CBC\\u0CBE-\\u0CC4\\u0CC6-\\u0CC8\\u0CCA-\\u0CCD\\u0CD5\\u0CD6\\u0CE2\\u0CE3\\u0D00-\\u0D03\\u0D3B\\u0D3C\\u0D3E-\\u0D44\\u0D46-\\u0D48\\u0D4A-\\u0D4D\\u0D57\\u0D62\\u0D63\\u0D82\\u0D83\\u0DCA\\u0DCF-\\u0DD4\\u0DD6\\u0DD8-\\u0DDF\\u0DF2\\u0DF3\\u0E31\\u0E34-\\u0E3A\\u0E47-\\u0E4E\\u0EB1\\u0EB4-\\u0EB9\\u0EBB\\u0EBC\\u0EC8-\\u0ECD\\u0F18\\u0F19\\u0F35\\u0F37\\u0F39\\u0F3E\\u0F3F\\u0F71-\\u0F84\\u0F86\\u0F87\\u0F8D-\\u0F97\\u0F99-\\u0FBC\\u0FC6\\u102B-\\u103E\\u1056-\\u1059\\u105E-\\u1060\\u1062-\\u1064\\u1067-\\u106D\\u1071-\\u1074\\u1082-\\u108D\\u108F\\u109A-\\u109D\\u135D-\\u135F\\u1712-\\u1714\\u1732-\\u1734\\u1752\\u1753\\u1772\\u1773\\u17B4-\\u17D3\\u17DD\\u180B-\\u180D\\u1885\\u1886\\u18A9\\u1920-\\u192B\\u1930-\\u193B\\u1A17-\\u1A1B\\u1A55-\\u1A5E\\u1A60-\\u1A7C\\u1A7F\\u1AB0-\\u1ABE\\u1B00-\\u1B04\\u1B34-\\u1B44\\u1B6B-\\u1B73\\u1B80-\\u1B82\\u1BA1-\\u1BAD\\u1BE6-\\u1BF3\\u1C24-\\u1C37\\u1CD0-\\u1CD2\\u1CD4-\\u1CE8\\u1CED\\u1CF2-\\u1CF4\\u1CF7-\\u1CF9\\u1DC0-\\u1DF9\\u1DFB-\\u1DFF\\u20D0-\\u20F0\\u2CEF-\\u2CF1\\u2D7F\\u2DE0-\\u2DFF\\u302A-\\u302F\\u3099\\u309A\\uA66F-\\uA672\\uA674-\\uA67D\\uA69E\\uA69F\\uA6F0\\uA6F1\\uA802\\uA806\\uA80B\\uA823-\\uA827\\uA880\\uA881\\uA8B4-\\uA8C5\\uA8E0-\\uA8F1\\uA8FF\\uA926-\\uA92D\\uA947-\\uA953\\uA980-\\uA983\\uA9B3-\\uA9C0\\uA9E5\\uAA29-\\uAA36\\uAA43\\uAA4C\\uAA4D\\uAA7B-\\uAA7D\\uAAB0\\uAAB2-\\uAAB4\\uAAB7\\uAAB8\\uAABE\\uAABF\\uAAC1\\uAAEB-\\uAAEF\\uAAF5\\uAAF6\\uABE3-\\uABEA\\uABEC\\uABED\\uFB1E\\uFE00-\\uFE0F\\uFE20-\\uFE2F]/g, ''))\n    : ((str) => str);\n\nclass BitapSearch {\n  constructor(\n    pattern,\n    {\n      location = Config.location,\n      threshold = Config.threshold,\n      distance = Config.distance,\n      includeMatches = Config.includeMatches,\n      findAllMatches = Config.findAllMatches,\n      minMatchCharLength = Config.minMatchCharLength,\n      isCaseSensitive = Config.isCaseSensitive,\n      ignoreDiacritics = Config.ignoreDiacritics,\n      ignoreLocation = Config.ignoreLocation\n    } = {}\n  ) {\n    this.options = {\n      location,\n      threshold,\n      distance,\n      includeMatches,\n      findAllMatches,\n      minMatchCharLength,\n      isCaseSensitive,\n      ignoreDiacritics,\n      ignoreLocation\n    };\n\n    pattern = isCaseSensitive ? pattern : pattern.toLowerCase();\n    pattern = ignoreDiacritics ? stripDiacritics(pattern) : pattern;\n    this.pattern = pattern;\n\n    this.chunks = [];\n\n    if (!this.pattern.length) {\n      return\n    }\n\n    const addChunk = (pattern, startIndex) => {\n      this.chunks.push({\n        pattern,\n        alphabet: createPatternAlphabet(pattern),\n        startIndex\n      });\n    };\n\n    const len = this.pattern.length;\n\n    if (len > MAX_BITS) {\n      let i = 0;\n      const remainder = len % MAX_BITS;\n      const end = len - remainder;\n\n      while (i < end) {\n        addChunk(this.pattern.substr(i, MAX_BITS), i);\n        i += MAX_BITS;\n      }\n\n      if (remainder) {\n        const startIndex = len - MAX_BITS;\n        addChunk(this.pattern.substr(startIndex), startIndex);\n      }\n    } else {\n      addChunk(this.pattern, 0);\n    }\n  }\n\n  searchIn(text) {\n    const { isCaseSensitive, ignoreDiacritics, includeMatches } = this.options;\n\n    text = isCaseSensitive ? text : text.toLowerCase();\n    text = ignoreDiacritics ? stripDiacritics(text) : text;\n\n    // Exact match\n    if (this.pattern === text) {\n      let result = {\n        isMatch: true,\n        score: 0\n      };\n\n      if (includeMatches) {\n        result.indices = [[0, text.length - 1]];\n      }\n\n      return result\n    }\n\n    // Otherwise, use Bitap algorithm\n    const {\n      location,\n      distance,\n      threshold,\n      findAllMatches,\n      minMatchCharLength,\n      ignoreLocation\n    } = this.options;\n\n    let allIndices = [];\n    let totalScore = 0;\n    let hasMatches = false;\n\n    this.chunks.forEach(({ pattern, alphabet, startIndex }) => {\n      const { isMatch, score, indices } = search(text, pattern, alphabet, {\n        location: location + startIndex,\n        distance,\n        threshold,\n        findAllMatches,\n        minMatchCharLength,\n        includeMatches,\n        ignoreLocation\n      });\n\n      if (isMatch) {\n        hasMatches = true;\n      }\n\n      totalScore += score;\n\n      if (isMatch && indices) {\n        allIndices = [...allIndices, ...indices];\n      }\n    });\n\n    let result = {\n      isMatch: hasMatches,\n      score: hasMatches ? totalScore / this.chunks.length : 1\n    };\n\n    if (hasMatches && includeMatches) {\n      result.indices = allIndices;\n    }\n\n    return result\n  }\n}\n\nclass BaseMatch {\n  constructor(pattern) {\n    this.pattern = pattern;\n  }\n  static isMultiMatch(pattern) {\n    return getMatch(pattern, this.multiRegex)\n  }\n  static isSingleMatch(pattern) {\n    return getMatch(pattern, this.singleRegex)\n  }\n  search(/*text*/) {}\n}\n\nfunction getMatch(pattern, exp) {\n  const matches = pattern.match(exp);\n  return matches ? matches[1] : null\n}\n\n// Token: 'file\n\nclass ExactMatch extends BaseMatch {\n  constructor(pattern) {\n    super(pattern);\n  }\n  static get type() {\n    return 'exact'\n  }\n  static get multiRegex() {\n    return /^=\"(.*)\"$/\n  }\n  static get singleRegex() {\n    return /^=(.*)$/\n  }\n  search(text) {\n    const isMatch = text === this.pattern;\n\n    return {\n      isMatch,\n      score: isMatch ? 0 : 1,\n      indices: [0, this.pattern.length - 1]\n    }\n  }\n}\n\n// Token: !fire\n\nclass InverseExactMatch extends BaseMatch {\n  constructor(pattern) {\n    super(pattern);\n  }\n  static get type() {\n    return 'inverse-exact'\n  }\n  static get multiRegex() {\n    return /^!\"(.*)\"$/\n  }\n  static get singleRegex() {\n    return /^!(.*)$/\n  }\n  search(text) {\n    const index = text.indexOf(this.pattern);\n    const isMatch = index === -1;\n\n    return {\n      isMatch,\n      score: isMatch ? 0 : 1,\n      indices: [0, text.length - 1]\n    }\n  }\n}\n\n// Token: ^file\n\nclass PrefixExactMatch extends BaseMatch {\n  constructor(pattern) {\n    super(pattern);\n  }\n  static get type() {\n    return 'prefix-exact'\n  }\n  static get multiRegex() {\n    return /^\\^\"(.*)\"$/\n  }\n  static get singleRegex() {\n    return /^\\^(.*)$/\n  }\n  search(text) {\n    const isMatch = text.startsWith(this.pattern);\n\n    return {\n      isMatch,\n      score: isMatch ? 0 : 1,\n      indices: [0, this.pattern.length - 1]\n    }\n  }\n}\n\n// Token: !^fire\n\nclass InversePrefixExactMatch extends BaseMatch {\n  constructor(pattern) {\n    super(pattern);\n  }\n  static get type() {\n    return 'inverse-prefix-exact'\n  }\n  static get multiRegex() {\n    return /^!\\^\"(.*)\"$/\n  }\n  static get singleRegex() {\n    return /^!\\^(.*)$/\n  }\n  search(text) {\n    const isMatch = !text.startsWith(this.pattern);\n\n    return {\n      isMatch,\n      score: isMatch ? 0 : 1,\n      indices: [0, text.length - 1]\n    }\n  }\n}\n\n// Token: .file$\n\nclass SuffixExactMatch extends BaseMatch {\n  constructor(pattern) {\n    super(pattern);\n  }\n  static get type() {\n    return 'suffix-exact'\n  }\n  static get multiRegex() {\n    return /^\"(.*)\"\\$$/\n  }\n  static get singleRegex() {\n    return /^(.*)\\$$/\n  }\n  search(text) {\n    const isMatch = text.endsWith(this.pattern);\n\n    return {\n      isMatch,\n      score: isMatch ? 0 : 1,\n      indices: [text.length - this.pattern.length, text.length - 1]\n    }\n  }\n}\n\n// Token: !.file$\n\nclass InverseSuffixExactMatch extends BaseMatch {\n  constructor(pattern) {\n    super(pattern);\n  }\n  static get type() {\n    return 'inverse-suffix-exact'\n  }\n  static get multiRegex() {\n    return /^!\"(.*)\"\\$$/\n  }\n  static get singleRegex() {\n    return /^!(.*)\\$$/\n  }\n  search(text) {\n    const isMatch = !text.endsWith(this.pattern);\n    return {\n      isMatch,\n      score: isMatch ? 0 : 1,\n      indices: [0, text.length - 1]\n    }\n  }\n}\n\nclass FuzzyMatch extends BaseMatch {\n  constructor(\n    pattern,\n    {\n      location = Config.location,\n      threshold = Config.threshold,\n      distance = Config.distance,\n      includeMatches = Config.includeMatches,\n      findAllMatches = Config.findAllMatches,\n      minMatchCharLength = Config.minMatchCharLength,\n      isCaseSensitive = Config.isCaseSensitive,\n      ignoreDiacritics = Config.ignoreDiacritics,\n      ignoreLocation = Config.ignoreLocation\n    } = {}\n  ) {\n    super(pattern);\n    this._bitapSearch = new BitapSearch(pattern, {\n      location,\n      threshold,\n      distance,\n      includeMatches,\n      findAllMatches,\n      minMatchCharLength,\n      isCaseSensitive,\n      ignoreDiacritics,\n      ignoreLocation\n    });\n  }\n  static get type() {\n    return 'fuzzy'\n  }\n  static get multiRegex() {\n    return /^\"(.*)\"$/\n  }\n  static get singleRegex() {\n    return /^(.*)$/\n  }\n  search(text) {\n    return this._bitapSearch.searchIn(text)\n  }\n}\n\n// Token: 'file\n\nclass IncludeMatch extends BaseMatch {\n  constructor(pattern) {\n    super(pattern);\n  }\n  static get type() {\n    return 'include'\n  }\n  static get multiRegex() {\n    return /^'\"(.*)\"$/\n  }\n  static get singleRegex() {\n    return /^'(.*)$/\n  }\n  search(text) {\n    let location = 0;\n    let index;\n\n    const indices = [];\n    const patternLen = this.pattern.length;\n\n    // Get all exact matches\n    while ((index = text.indexOf(this.pattern, location)) > -1) {\n      location = index + patternLen;\n      indices.push([index, location - 1]);\n    }\n\n    const isMatch = !!indices.length;\n\n    return {\n      isMatch,\n      score: isMatch ? 0 : 1,\n      indices\n    }\n  }\n}\n\n// Order is important. DO NOT CHANGE.\nconst searchers = [\n  ExactMatch,\n  IncludeMatch,\n  PrefixExactMatch,\n  InversePrefixExactMatch,\n  InverseSuffixExactMatch,\n  SuffixExactMatch,\n  InverseExactMatch,\n  FuzzyMatch\n];\n\nconst searchersLen = searchers.length;\n\n// Regex to split by spaces, but keep anything in quotes together\nconst SPACE_RE = / +(?=(?:[^\\\"]*\\\"[^\\\"]*\\\")*[^\\\"]*$)/;\nconst OR_TOKEN = '|';\n\n// Return a 2D array representation of the query, for simpler parsing.\n// Example:\n// \"^core go$ | rb$ | py$ xy$\" => [[\"^core\", \"go$\"], [\"rb$\"], [\"py$\", \"xy$\"]]\nfunction parseQuery(pattern, options = {}) {\n  return pattern.split(OR_TOKEN).map((item) => {\n    let query = item\n      .trim()\n      .split(SPACE_RE)\n      .filter((item) => item && !!item.trim());\n\n    let results = [];\n    for (let i = 0, len = query.length; i < len; i += 1) {\n      const queryItem = query[i];\n\n      // 1. Handle multiple query match (i.e, once that are quoted, like `\"hello world\"`)\n      let found = false;\n      let idx = -1;\n      while (!found && ++idx < searchersLen) {\n        const searcher = searchers[idx];\n        let token = searcher.isMultiMatch(queryItem);\n        if (token) {\n          results.push(new searcher(token, options));\n          found = true;\n        }\n      }\n\n      if (found) {\n        continue\n      }\n\n      // 2. Handle single query matches (i.e, once that are *not* quoted)\n      idx = -1;\n      while (++idx < searchersLen) {\n        const searcher = searchers[idx];\n        let token = searcher.isSingleMatch(queryItem);\n        if (token) {\n          results.push(new searcher(token, options));\n          break\n        }\n      }\n    }\n\n    return results\n  })\n}\n\n// These extended matchers can return an array of matches, as opposed\n// to a singl match\nconst MultiMatchSet = new Set([FuzzyMatch.type, IncludeMatch.type]);\n\n/**\n * Command-like searching\n * ======================\n *\n * Given multiple search terms delimited by spaces.e.g. `^jscript .python$ ruby !java`,\n * search in a given text.\n *\n * Search syntax:\n *\n * | Token       | Match type                 | Description                            |\n * | ----------- | -------------------------- | -------------------------------------- |\n * | `jscript`   | fuzzy-match                | Items that fuzzy match `jscript`       |\n * | `=scheme`   | exact-match                | Items that are `scheme`                |\n * | `'python`   | include-match              | Items that include `python`            |\n * | `!ruby`     | inverse-exact-match        | Items that do not include `ruby`       |\n * | `^java`     | prefix-exact-match         | Items that start with `java`           |\n * | `!^earlang` | inverse-prefix-exact-match | Items that do not start with `earlang` |\n * | `.js$`      | suffix-exact-match         | Items that end with `.js`              |\n * | `!.go$`     | inverse-suffix-exact-match | Items that do not end with `.go`       |\n *\n * A single pipe character acts as an OR operator. For example, the following\n * query matches entries that start with `core` and end with either`go`, `rb`,\n * or`py`.\n *\n * ```\n * ^core go$ | rb$ | py$\n * ```\n */\nclass ExtendedSearch {\n  constructor(\n    pattern,\n    {\n      isCaseSensitive = Config.isCaseSensitive,\n      ignoreDiacritics = Config.ignoreDiacritics,\n      includeMatches = Config.includeMatches,\n      minMatchCharLength = Config.minMatchCharLength,\n      ignoreLocation = Config.ignoreLocation,\n      findAllMatches = Config.findAllMatches,\n      location = Config.location,\n      threshold = Config.threshold,\n      distance = Config.distance\n    } = {}\n  ) {\n    this.query = null;\n    this.options = {\n      isCaseSensitive,\n      ignoreDiacritics,\n      includeMatches,\n      minMatchCharLength,\n      findAllMatches,\n      ignoreLocation,\n      location,\n      threshold,\n      distance\n    };\n\n    pattern = isCaseSensitive ? pattern : pattern.toLowerCase();\n    pattern = ignoreDiacritics ? stripDiacritics(pattern) : pattern;\n    this.pattern = pattern;\n    this.query = parseQuery(this.pattern, this.options);\n  }\n\n  static condition(_, options) {\n    return options.useExtendedSearch\n  }\n\n  searchIn(text) {\n    const query = this.query;\n\n    if (!query) {\n      return {\n        isMatch: false,\n        score: 1\n      }\n    }\n\n    const { includeMatches, isCaseSensitive, ignoreDiacritics } = this.options;\n\n    text = isCaseSensitive ? text : text.toLowerCase();\n    text = ignoreDiacritics ? stripDiacritics(text) : text;\n\n    let numMatches = 0;\n    let allIndices = [];\n    let totalScore = 0;\n\n    // ORs\n    for (let i = 0, qLen = query.length; i < qLen; i += 1) {\n      const searchers = query[i];\n\n      // Reset indices\n      allIndices.length = 0;\n      numMatches = 0;\n\n      // ANDs\n      for (let j = 0, pLen = searchers.length; j < pLen; j += 1) {\n        const searcher = searchers[j];\n        const { isMatch, indices, score } = searcher.search(text);\n\n        if (isMatch) {\n          numMatches += 1;\n          totalScore += score;\n          if (includeMatches) {\n            const type = searcher.constructor.type;\n            if (MultiMatchSet.has(type)) {\n              allIndices = [...allIndices, ...indices];\n            } else {\n              allIndices.push(indices);\n            }\n          }\n        } else {\n          totalScore = 0;\n          numMatches = 0;\n          allIndices.length = 0;\n          break\n        }\n      }\n\n      // OR condition, so if TRUE, return\n      if (numMatches) {\n        let result = {\n          isMatch: true,\n          score: totalScore / numMatches\n        };\n\n        if (includeMatches) {\n          result.indices = allIndices;\n        }\n\n        return result\n      }\n    }\n\n    // Nothing was matched\n    return {\n      isMatch: false,\n      score: 1\n    }\n  }\n}\n\nconst registeredSearchers = [];\n\nfunction register(...args) {\n  registeredSearchers.push(...args);\n}\n\nfunction createSearcher(pattern, options) {\n  for (let i = 0, len = registeredSearchers.length; i < len; i += 1) {\n    let searcherClass = registeredSearchers[i];\n    if (searcherClass.condition(pattern, options)) {\n      return new searcherClass(pattern, options)\n    }\n  }\n\n  return new BitapSearch(pattern, options)\n}\n\nconst LogicalOperator = {\n  AND: '$and',\n  OR: '$or'\n};\n\nconst KeyType = {\n  PATH: '$path',\n  PATTERN: '$val'\n};\n\nconst isExpression = (query) =>\n  !!(query[LogicalOperator.AND] || query[LogicalOperator.OR]);\n\nconst isPath = (query) => !!query[KeyType.PATH];\n\nconst isLeaf = (query) =>\n  !isArray(query) && isObject(query) && !isExpression(query);\n\nconst convertToExplicit = (query) => ({\n  [LogicalOperator.AND]: Object.keys(query).map((key) => ({\n    [key]: query[key]\n  }))\n});\n\n// When `auto` is `true`, the parse function will infer and initialize and add\n// the appropriate `Searcher` instance\nfunction parse(query, options, { auto = true } = {}) {\n  const next = (query) => {\n    let keys = Object.keys(query);\n\n    const isQueryPath = isPath(query);\n\n    if (!isQueryPath && keys.length > 1 && !isExpression(query)) {\n      return next(convertToExplicit(query))\n    }\n\n    if (isLeaf(query)) {\n      const key = isQueryPath ? query[KeyType.PATH] : keys[0];\n\n      const pattern = isQueryPath ? query[KeyType.PATTERN] : query[key];\n\n      if (!isString(pattern)) {\n        throw new Error(LOGICAL_SEARCH_INVALID_QUERY_FOR_KEY(key))\n      }\n\n      const obj = {\n        keyId: createKeyId(key),\n        pattern\n      };\n\n      if (auto) {\n        obj.searcher = createSearcher(pattern, options);\n      }\n\n      return obj\n    }\n\n    let node = {\n      children: [],\n      operator: keys[0]\n    };\n\n    keys.forEach((key) => {\n      const value = query[key];\n\n      if (isArray(value)) {\n        value.forEach((item) => {\n          node.children.push(next(item));\n        });\n      }\n    });\n\n    return node\n  };\n\n  if (!isExpression(query)) {\n    query = convertToExplicit(query);\n  }\n\n  return next(query)\n}\n\n// Practical scoring function\nfunction computeScore(\n  results,\n  { ignoreFieldNorm = Config.ignoreFieldNorm }\n) {\n  results.forEach((result) => {\n    let totalScore = 1;\n\n    result.matches.forEach(({ key, norm, score }) => {\n      const weight = key ? key.weight : null;\n\n      totalScore *= Math.pow(\n        score === 0 && weight ? Number.EPSILON : score,\n        (weight || 1) * (ignoreFieldNorm ? 1 : norm)\n      );\n    });\n\n    result.score = totalScore;\n  });\n}\n\nfunction transformMatches(result, data) {\n  const matches = result.matches;\n  data.matches = [];\n\n  if (!isDefined(matches)) {\n    return\n  }\n\n  matches.forEach((match) => {\n    if (!isDefined(match.indices) || !match.indices.length) {\n      return\n    }\n\n    const { indices, value } = match;\n\n    let obj = {\n      indices,\n      value\n    };\n\n    if (match.key) {\n      obj.key = match.key.src;\n    }\n\n    if (match.idx > -1) {\n      obj.refIndex = match.idx;\n    }\n\n    data.matches.push(obj);\n  });\n}\n\nfunction transformScore(result, data) {\n  data.score = result.score;\n}\n\nfunction format(\n  results,\n  docs,\n  {\n    includeMatches = Config.includeMatches,\n    includeScore = Config.includeScore\n  } = {}\n) {\n  const transformers = [];\n\n  if (includeMatches) transformers.push(transformMatches);\n  if (includeScore) transformers.push(transformScore);\n\n  return results.map((result) => {\n    const { idx } = result;\n\n    const data = {\n      item: docs[idx],\n      refIndex: idx\n    };\n\n    if (transformers.length) {\n      transformers.forEach((transformer) => {\n        transformer(result, data);\n      });\n    }\n\n    return data\n  })\n}\n\nclass Fuse {\n  constructor(docs, options = {}, index) {\n    this.options = { ...Config, ...options };\n\n    if (\n      this.options.useExtendedSearch &&\n      !true\n    ) {\n      throw new Error(EXTENDED_SEARCH_UNAVAILABLE)\n    }\n\n    this._keyStore = new KeyStore(this.options.keys);\n\n    this.setCollection(docs, index);\n  }\n\n  setCollection(docs, index) {\n    this._docs = docs;\n\n    if (index && !(index instanceof FuseIndex)) {\n      throw new Error(INCORRECT_INDEX_TYPE)\n    }\n\n    this._myIndex =\n      index ||\n      createIndex(this.options.keys, this._docs, {\n        getFn: this.options.getFn,\n        fieldNormWeight: this.options.fieldNormWeight\n      });\n  }\n\n  add(doc) {\n    if (!isDefined(doc)) {\n      return\n    }\n\n    this._docs.push(doc);\n    this._myIndex.add(doc);\n  }\n\n  remove(predicate = (/* doc, idx */) => false) {\n    const results = [];\n\n    for (let i = 0, len = this._docs.length; i < len; i += 1) {\n      const doc = this._docs[i];\n      if (predicate(doc, i)) {\n        this.removeAt(i);\n        i -= 1;\n        len -= 1;\n\n        results.push(doc);\n      }\n    }\n\n    return results\n  }\n\n  removeAt(idx) {\n    this._docs.splice(idx, 1);\n    this._myIndex.removeAt(idx);\n  }\n\n  getIndex() {\n    return this._myIndex\n  }\n\n  search(query, { limit = -1 } = {}) {\n    const {\n      includeMatches,\n      includeScore,\n      shouldSort,\n      sortFn,\n      ignoreFieldNorm\n    } = this.options;\n\n    let results = isString(query)\n      ? isString(this._docs[0])\n        ? this._searchStringList(query)\n        : this._searchObjectList(query)\n      : this._searchLogical(query);\n\n    computeScore(results, { ignoreFieldNorm });\n\n    if (shouldSort) {\n      results.sort(sortFn);\n    }\n\n    if (isNumber(limit) && limit > -1) {\n      results = results.slice(0, limit);\n    }\n\n    return format(results, this._docs, {\n      includeMatches,\n      includeScore\n    })\n  }\n\n  _searchStringList(query) {\n    const searcher = createSearcher(query, this.options);\n    const { records } = this._myIndex;\n    const results = [];\n\n    // Iterate over every string in the index\n    records.forEach(({ v: text, i: idx, n: norm }) => {\n      if (!isDefined(text)) {\n        return\n      }\n\n      const { isMatch, score, indices } = searcher.searchIn(text);\n\n      if (isMatch) {\n        results.push({\n          item: text,\n          idx,\n          matches: [{ score, value: text, norm, indices }]\n        });\n      }\n    });\n\n    return results\n  }\n\n  _searchLogical(query) {\n\n    const expression = parse(query, this.options);\n\n    const evaluate = (node, item, idx) => {\n      if (!node.children) {\n        const { keyId, searcher } = node;\n\n        const matches = this._findMatches({\n          key: this._keyStore.get(keyId),\n          value: this._myIndex.getValueForItemAtKeyId(item, keyId),\n          searcher\n        });\n\n        if (matches && matches.length) {\n          return [\n            {\n              idx,\n              item,\n              matches\n            }\n          ]\n        }\n\n        return []\n      }\n\n      const res = [];\n      for (let i = 0, len = node.children.length; i < len; i += 1) {\n        const child = node.children[i];\n        const result = evaluate(child, item, idx);\n        if (result.length) {\n          res.push(...result);\n        } else if (node.operator === LogicalOperator.AND) {\n          return []\n        }\n      }\n      return res\n    };\n\n    const records = this._myIndex.records;\n    const resultMap = {};\n    const results = [];\n\n    records.forEach(({ $: item, i: idx }) => {\n      if (isDefined(item)) {\n        let expResults = evaluate(expression, item, idx);\n\n        if (expResults.length) {\n          // Dedupe when adding\n          if (!resultMap[idx]) {\n            resultMap[idx] = { idx, item, matches: [] };\n            results.push(resultMap[idx]);\n          }\n          expResults.forEach(({ matches }) => {\n            resultMap[idx].matches.push(...matches);\n          });\n        }\n      }\n    });\n\n    return results\n  }\n\n  _searchObjectList(query) {\n    const searcher = createSearcher(query, this.options);\n    const { keys, records } = this._myIndex;\n    const results = [];\n\n    // List is Array<Object>\n    records.forEach(({ $: item, i: idx }) => {\n      if (!isDefined(item)) {\n        return\n      }\n\n      let matches = [];\n\n      // Iterate over every key (i.e, path), and fetch the value at that key\n      keys.forEach((key, keyIndex) => {\n        matches.push(\n          ...this._findMatches({\n            key,\n            value: item[keyIndex],\n            searcher\n          })\n        );\n      });\n\n      if (matches.length) {\n        results.push({\n          idx,\n          item,\n          matches\n        });\n      }\n    });\n\n    return results\n  }\n  _findMatches({ key, value, searcher }) {\n    if (!isDefined(value)) {\n      return []\n    }\n\n    let matches = [];\n\n    if (isArray(value)) {\n      value.forEach(({ v: text, i: idx, n: norm }) => {\n        if (!isDefined(text)) {\n          return\n        }\n\n        const { isMatch, score, indices } = searcher.searchIn(text);\n\n        if (isMatch) {\n          matches.push({\n            score,\n            key,\n            value: text,\n            idx,\n            norm,\n            indices\n          });\n        }\n      });\n    } else {\n      const { v: text, n: norm } = value;\n\n      const { isMatch, score, indices } = searcher.searchIn(text);\n\n      if (isMatch) {\n        matches.push({ score, key, value: text, norm, indices });\n      }\n    }\n\n    return matches\n  }\n}\n\nFuse.version = '7.1.0';\nFuse.createIndex = createIndex;\nFuse.parseIndex = parseIndex;\nFuse.config = Config;\n\n{\n  Fuse.parseQuery = parse;\n}\n\n{\n  register(ExtendedSearch);\n}\n\nexport { Fuse as default };\n","// ========================================\n// Entity Detection from OCR Text\n// ========================================\n// Fuzzy matching to detect items, tomes, characters, weapons\n\nimport type { AllGameData, Item, Tome, Character, Weapon } from '../../types/index.ts';\nimport Fuse from 'fuse.js';\nimport { logger } from '../logger.ts';\nimport { splitIntoSegments } from './utils.ts';\nimport type { DetectionResult, EntityWithId, DetectEntitiesOptions, AutoDetectResult, OCRProgressCallback } from './types.ts';\nimport { extractTextFromImage } from './extraction.ts';\n\n// Fuse.js instances for fuzzy matching\nlet itemFuse: Fuse<Item> | null = null;\nlet tomeFuse: Fuse<Tome> | null = null;\nlet characterFuse: Fuse<Character> | null = null;\nlet weaponFuse: Fuse<Weapon> | null = null;\n\n/**\n * Initialize OCR module with game data\n */\nexport function initOCR(gameData: AllGameData): void {\n    // Initialize Fuse.js for fuzzy matching\n    const fuseOptions = {\n        includeScore: true,\n        threshold: 0.5, // 0 = perfect match, 1 = match anything (0.5 allows for OCR errors)\n        keys: ['name'],\n        ignoreLocation: true,\n    };\n\n    if (gameData.items?.items) {\n        itemFuse = new Fuse(gameData.items.items, fuseOptions);\n    }\n\n    if (gameData.tomes?.tomes) {\n        tomeFuse = new Fuse(gameData.tomes.tomes, fuseOptions);\n    }\n\n    if (gameData.characters?.characters) {\n        characterFuse = new Fuse(gameData.characters.characters, fuseOptions);\n    }\n\n    if (gameData.weapons?.weapons) {\n        weaponFuse = new Fuse(gameData.weapons.weapons, fuseOptions);\n    }\n\n    logger.info({\n        operation: 'ocr.init',\n        data: {\n            itemsIndexed: gameData.items?.items.length || 0,\n            tomesIndexed: gameData.tomes?.tomes.length || 0,\n            charactersIndexed: gameData.characters?.characters.length || 0,\n            weaponsIndexed: gameData.weapons?.weapons.length || 0,\n        },\n    });\n}\n\n/**\n * Generic helper to detect entities from text using a Fuse index\n * Reduces code duplication across detectItemsFromText, detectTomesFromText, etc.\n */\nfunction detectEntitiesFromText<T extends EntityWithId>(\n    text: string,\n    fuseInstance: Fuse<T> | null,\n    options: DetectEntitiesOptions\n): DetectionResult[] {\n    if (!fuseInstance) return [];\n\n    const segments = splitIntoSegments(text);\n    const detections: DetectionResult[] = [];\n    const seenEntities = new Set<string>();\n\n    let bestUnmatchedScore = 1;\n    let bestUnmatchedName = '';\n\n    for (const segment of segments) {\n        const results = fuseInstance.search(segment);\n        // Guard against empty results array before accessing first element\n        if (results.length === 0) continue;\n        const match = results[0];\n        const score = match?.score;\n\n        if (match && score !== undefined) {\n            // Track best unmatched score for debugging\n            if (options.debug && score >= 0.5 && score < bestUnmatchedScore) {\n                bestUnmatchedScore = score;\n                bestUnmatchedName = match.item.name;\n            }\n\n            // Only include matches with confidence > 50% (score < 0.5)\n            if (score < 0.5 && !seenEntities.has(match.item.id)) {\n                seenEntities.add(match.item.id);\n                detections.push({\n                    type: options.type,\n                    // Type assertion through unknown: T extends EntityWithId includes Item/Tome/Character/Weapon\n                    entity: match.item as unknown as Item | Tome | Character | Weapon,\n                    confidence: 1 - score, // Fuse score is 0 (best) to 1 (worst), invert it\n                    rawText: segment,\n                });\n\n                if (options.debug) {\n                    logger.debug({\n                        operation: `ocr.${options.type}_matched`,\n                        data: {\n                            segment: segment.substring(0, 30),\n                            matchedEntity: match.item.name,\n                            score: score.toFixed(3),\n                        },\n                    });\n                }\n            }\n        }\n    }\n\n    // Log summary for debugging when nothing matched\n    if (options.debug && detections.length === 0 && segments.length > 0) {\n        logger.debug({\n            operation: `ocr.no_${options.type}s_matched`,\n            data: {\n                segmentsChecked: segments.length,\n                bestScore: bestUnmatchedScore < 1 ? bestUnmatchedScore.toFixed(3) : 'none',\n                bestMatch: bestUnmatchedName || 'none',\n                sampleSegments: segments.slice(0, 5).map(s => s.substring(0, 20)),\n            },\n        });\n    }\n\n    return detections;\n}\n\n/**\n * Detect items from extracted text\n */\nexport function detectItemsFromText(text: string): DetectionResult[] {\n    return detectEntitiesFromText(text, itemFuse, { type: 'item', debug: true });\n}\n\n/**\n * Detect tomes from extracted text\n */\nexport function detectTomesFromText(text: string): DetectionResult[] {\n    return detectEntitiesFromText(text, tomeFuse, { type: 'tome' });\n}\n\n/**\n * Detect character from extracted text\n */\nexport function detectCharacterFromText(text: string): DetectionResult | null {\n    if (!characterFuse) return null;\n\n    const results = characterFuse.search(text);\n    // Guard against empty results array\n    if (results.length === 0) return null;\n    const match = results[0];\n    const score = match?.score;\n\n    if (match && score !== undefined && score < 0.5) {\n        return {\n            type: 'character',\n            entity: match.item,\n            confidence: 1 - score,\n            rawText: text,\n        };\n    }\n\n    return null;\n}\n\n/**\n * Detect characters from extracted text (multiple lines)\n */\nexport function detectCharactersFromText(text: string): DetectionResult[] {\n    return detectEntitiesFromText(text, characterFuse, { type: 'character' });\n}\n\n/**\n * Detect weapon from extracted text\n */\nexport function detectWeaponFromText(text: string): DetectionResult | null {\n    if (!weaponFuse) return null;\n\n    const results = weaponFuse.search(text);\n    // Guard against empty results array\n    if (results.length === 0) return null;\n    const match = results[0];\n    const score = match?.score;\n\n    if (match && score !== undefined && score < 0.5) {\n        return {\n            type: 'weapon',\n            entity: match.item,\n            confidence: 1 - score,\n            rawText: text,\n        };\n    }\n\n    return null;\n}\n\n/**\n * Detect weapons from extracted text (multiple lines)\n */\nexport function detectWeaponsFromText(text: string): DetectionResult[] {\n    return detectEntitiesFromText(text, weaponFuse, { type: 'weapon' });\n}\n\n/**\n * Auto-detect all entities from image\n */\nexport async function autoDetectFromImage(\n    imageDataUrl: string,\n    progressCallback?: OCRProgressCallback\n): Promise<AutoDetectResult> {\n    try {\n        // Extract text from image\n        if (progressCallback) {\n            progressCallback(0, 'Starting OCR...');\n        }\n\n        const text = await extractTextFromImage(imageDataUrl, progressCallback);\n\n        if (progressCallback) {\n            progressCallback(100, 'Matching detected text...');\n        }\n\n        // Detect entities\n        const items = detectItemsFromText(text);\n        const tomes = detectTomesFromText(text);\n        const character = detectCharacterFromText(text);\n        const weapon = detectWeaponFromText(text);\n\n        logger.info({\n            operation: 'ocr.auto_detect',\n            data: {\n                itemsDetected: items.length,\n                tomesDetected: tomes.length,\n                characterDetected: character ? 1 : 0,\n                weaponDetected: weapon ? 1 : 0,\n            },\n        });\n\n        return {\n            items,\n            tomes,\n            character,\n            weapon,\n            rawText: text,\n        };\n    } catch (error) {\n        logger.error({\n            operation: 'ocr.auto_detect',\n            error: {\n                name: (error as Error).name,\n                message: (error as Error).message,\n                module: 'ocr',\n            },\n        });\n        throw error;\n    }\n}\n\n/**\n * Reset detection state (for testing)\n */\nexport function __resetDetectionForTesting(): void {\n    itemFuse = null;\n    tomeFuse = null;\n    characterFuse = null;\n    weaponFuse = null;\n}\n","// ========================================\n// Text Extraction from Images\n// ========================================\n// Core OCR functionality using Tesseract.js\n\nimport { logger } from '../logger.ts';\nimport { getOrCreateWorker, terminateOCRWorker } from './worker.ts';\nimport { withTimeout, sleep, OCR_TIMEOUT_MS, OCR_MAX_RETRIES } from './utils.ts';\nimport type { TesseractResult, OCRProgressCallback } from './types.ts';\n\n/**\n * Extract text from image using Tesseract OCR\n * Includes timeout protection and retry logic\n * Tesseract is lazy-loaded on first use\n */\nexport async function extractTextFromImage(\n    imageDataUrl: string,\n    progressCallback?: OCRProgressCallback,\n    timeoutMs: number = OCR_TIMEOUT_MS,\n    maxRetries: number = OCR_MAX_RETRIES\n): Promise<string> {\n    let lastError: Error | null = null;\n\n    // Initialize worker (reused across calls)\n    if (progressCallback) {\n        progressCallback(0, 'Loading OCR engine...');\n    }\n\n    for (let attempt = 0; attempt <= maxRetries; attempt++) {\n        try {\n            logger.info({\n                operation: 'ocr.extract_text',\n                data: { phase: 'start', attempt: attempt + 1, maxRetries: maxRetries + 1 },\n            });\n\n            if (attempt > 0 && progressCallback) {\n                progressCallback(0, `Retrying OCR (attempt ${attempt + 1}/${maxRetries + 1})...`);\n            }\n\n            // Get or create reusable worker\n            const worker = await getOrCreateWorker();\n\n            // Progress tracking for recognition\n            let lastProgress = 0;\n            const progressInterval = progressCallback\n                ? setInterval(() => {\n                      // Simulate progress since worker.recognize doesn't have progress callback\n                      if (lastProgress < 90) {\n                          lastProgress += 10;\n                          progressCallback(lastProgress, `Recognizing text... ${lastProgress}%`);\n                      }\n                  }, 500)\n                : null;\n\n            // Use worker.recognize instead of Tesseract.recognize (reuses worker)\n            const recognizePromise = worker.recognize(imageDataUrl);\n\n            // Wrap with timeout to prevent indefinite waiting\n            const result = (await withTimeout(recognizePromise, timeoutMs, 'OCR recognition')) as TesseractResult;\n\n            // Clear progress interval\n            if (progressInterval) {\n                clearInterval(progressInterval);\n            }\n\n            const extractedText = result.data.text;\n\n            logger.info({\n                operation: 'ocr.extract_text',\n                data: {\n                    phase: 'complete',\n                    attempt: attempt + 1,\n                    textLength: extractedText.length,\n                    confidence: result.data.confidence,\n                    textPreview: extractedText.substring(0, 500).replace(/\\n/g, ' | '),\n                },\n            });\n\n            return extractedText;\n        } catch (error) {\n            lastError = error as Error;\n\n            logger.warn({\n                operation: 'ocr.extract_text',\n                data: {\n                    phase: 'retry',\n                    attempt: attempt + 1,\n                    maxRetries: maxRetries + 1,\n                    willRetry: attempt < maxRetries,\n                },\n                error: {\n                    name: lastError.name,\n                    message: lastError.message,\n                    module: 'ocr',\n                },\n            });\n\n            // If worker failed, terminate it so a fresh one is created on retry\n            if (lastError.message.includes('worker') || lastError.message.includes('timeout')) {\n                await terminateOCRWorker();\n            }\n\n            // Don't sleep after the last attempt\n            if (attempt < maxRetries) {\n                // Exponential backoff: 1s, 2s, 4s...\n                const backoffMs = Math.min(1000 * Math.pow(2, attempt), 8000);\n                await sleep(backoffMs);\n            }\n        }\n    }\n\n    // All retries exhausted\n    logger.error({\n        operation: 'ocr.extract_text',\n        error: {\n            name: lastError?.name || 'UnknownError',\n            message: lastError?.message || 'OCR failed after all retries',\n            module: 'ocr',\n            retriable: false, // All retries have been exhausted\n        },\n    });\n\n    throw lastError || new Error('OCR failed after all retries');\n}\n","// ========================================\n// MegaBonk OCR Module\n// ========================================\n// Handles text extraction from screenshots using Tesseract.js\n// Tesseract is lazy-loaded to reduce initial bundle size\n// ========================================\n\n// Re-export all types\nexport type {\n    TesseractResult,\n    DetectionResult,\n    StackCountResult,\n    OCRProgressCallback,\n    EntityWithId,\n    DetectEntitiesOptions,\n    AutoDetectResult,\n} from './types.ts';\n\n// Re-export utilities\nexport {\n    OCR_TIMEOUT_MS,\n    OCR_MAX_RETRIES,\n    withTimeout,\n    sleep,\n    splitIntoSegments,\n    extractItemCounts,\n} from './utils.ts';\n\n// Re-export worker management\nexport {\n    getTesseract,\n    getOrCreateWorker,\n    terminateOCRWorker,\n    isOCRWorkerActive,\n} from './worker.ts';\n\n// Re-export preprocessing\nexport {\n    preprocessForDigits,\n    loadImage,\n    createCanvasFromImage,\n} from './preprocessing.ts';\n\n// Re-export text extraction\nexport { extractTextFromImage } from './extraction.ts';\n\n// Re-export entity detection\nexport {\n    initOCR,\n    detectItemsFromText,\n    detectTomesFromText,\n    detectCharacterFromText,\n    detectCharactersFromText,\n    detectWeaponFromText,\n    detectWeaponsFromText,\n    autoDetectFromImage,\n} from './detection.ts';\n\n// Re-export stack count detection\nexport {\n    detectStackCount,\n    detectStackCountsBatch,\n} from './stack-count.ts';\n\n// Import for window assignments and reset\nimport { initOCR } from './detection.ts';\nimport { terminateOCRWorker, isOCRWorkerActive, __resetWorkerForTesting } from './worker.ts';\nimport { __resetDetectionForTesting } from './detection.ts';\n\n/**\n * Reset OCR module state (for testing)\n */\nexport async function __resetForTesting(): Promise<void> {\n    __resetDetectionForTesting();\n    __resetWorkerForTesting();\n    await terminateOCRWorker();\n}\n\n// ========================================\n// Global Assignments\n// ========================================\n// Window interface extensions are in types/index.ts\n\nwindow.initOCR = initOCR;\nwindow.terminateOCRWorker = terminateOCRWorker;\nwindow.isOCRWorkerActive = isOCRWorkerActive;\n","// ========================================\n// CV Module State and Cache Management\n// ========================================\n\nimport type { AllGameData, Item } from '../../types/index.ts';\nimport type { CVDetectionResult, TemplateData, GridPreset, GridPresetsFile } from './types.ts';\nimport { logger } from '../logger.ts';\n\n// ========================================\n// Module State\n// ========================================\n\nlet allData: AllGameData = {};\n\nconst itemTemplates = new Map<string, TemplateData>();\nconst templatesByColor = new Map<string, Item[]>();\nlet templatesLoaded = false;\nlet priorityTemplatesLoaded = false;\nlet standardTemplatesLoading = false; // Guard against concurrent standard template loads\n\n// Detection result cache (key = image hash, value = results)\nconst detectionCache = new Map<string, { results: CVDetectionResult[]; timestamp: number }>();\n\n// ========================================\n// LRU Cache Implementation\n// ========================================\n\n/**\n * LRU (Least Recently Used) Cache\n * Provides O(1) get/set operations with automatic eviction\n */\nclass LRUCache<K, V> {\n    private cache: Map<K, V>;\n    private maxSize: number;\n\n    constructor(maxSize: number) {\n        this.cache = new Map();\n        this.maxSize = maxSize;\n    }\n\n    /**\n     * Get value from cache, moving it to most recently used\n     */\n    get(key: K): V | undefined {\n        const value = this.cache.get(key);\n        if (value !== undefined) {\n            // Move to end (most recently used) by deleting and re-adding\n            this.cache.delete(key);\n            this.cache.set(key, value);\n        }\n        return value;\n    }\n\n    /**\n     * Set value in cache, evicting LRU entry if full\n     */\n    set(key: K, value: V): void {\n        // If key exists, delete it first (will be re-added at end)\n        if (this.cache.has(key)) {\n            this.cache.delete(key);\n        } else if (this.cache.size >= this.maxSize) {\n            // Evict least recently used (first entry in Map)\n            const firstKey = this.cache.keys().next().value;\n            if (firstKey !== undefined) {\n                this.cache.delete(firstKey);\n            }\n        }\n        this.cache.set(key, value);\n    }\n\n    /**\n     * Check if key exists in cache\n     */\n    has(key: K): boolean {\n        return this.cache.has(key);\n    }\n\n    /**\n     * Delete a specific key\n     */\n    delete(key: K): boolean {\n        return this.cache.delete(key);\n    }\n\n    /**\n     * Clear the entire cache\n     */\n    clear(): void {\n        this.cache.clear();\n    }\n\n    /**\n     * Get current size of cache\n     */\n    get size(): number {\n        return this.cache.size;\n    }\n\n    /**\n     * Get all entries (for iteration)\n     */\n    entries(): IterableIterator<[K, V]> {\n        return this.cache.entries();\n    }\n}\n\n// Resized template cache using LRU (key = templateId_width_height, value = ImageData)\nconst RESIZED_CACHE_SIZE = 500;\nconst resizedTemplateCache = new LRUCache<string, ImageData>(RESIZED_CACHE_SIZE);\n\n// Multi-scale template variants (pre-generated at common sizes for faster matching)\n// Key: itemId, Value: Map of size -> ImageData\nconst multiScaleTemplates = new Map<string, Map<number, ImageData>>();\n\n// Bug fix: Limit multi-scale templates to prevent unbounded memory growth\n// Max ~300 items * 8 sizes = 2400 entries, but we limit to 2000 to be safe\nconst MAX_MULTI_SCALE_TEMPLATES = 2000;\n\n// Common icon sizes used in different resolutions\nexport const COMMON_ICON_SIZES = [32, 38, 40, 44, 48, 55, 64, 72] as const;\n\n// ========================================\n// Cache Constants\n// ========================================\n\nexport const CACHE_TTL = 1000 * 60 * 15; // 15 minutes\nexport const MAX_CACHE_SIZE = 50; // Maximum number of cache entries\n\n// Timer for periodic cache cleanup\nlet cacheCleanupTimer: ReturnType<typeof setInterval> | null = null;\n\n// ========================================\n// State Getters\n// ========================================\n\nexport function getAllData(): AllGameData {\n    return allData;\n}\n\nexport function getItemTemplates(): Map<string, TemplateData> {\n    return itemTemplates;\n}\n\nexport function getTemplatesByColor(): Map<string, Item[]> {\n    return templatesByColor;\n}\n\nexport function isTemplatesLoaded(): boolean {\n    return templatesLoaded;\n}\n\nexport function isPriorityTemplatesLoaded(): boolean {\n    return priorityTemplatesLoaded;\n}\n\nexport function isStandardTemplatesLoading(): boolean {\n    return standardTemplatesLoading;\n}\n\nexport function setStandardTemplatesLoading(loading: boolean): void {\n    standardTemplatesLoading = loading;\n}\n\nexport function getDetectionCache(): Map<string, { results: CVDetectionResult[]; timestamp: number }> {\n    return detectionCache;\n}\n\nexport function getResizedTemplate(templateId: string, width: number, height: number): ImageData | undefined {\n    const key = `${templateId}_${width}_${height}`;\n    // LRU cache automatically moves accessed item to most recently used\n    return resizedTemplateCache.get(key);\n}\n\nexport function setResizedTemplate(templateId: string, width: number, height: number, imageData: ImageData): void {\n    const key = `${templateId}_${width}_${height}`;\n    // LRU cache automatically handles eviction\n    resizedTemplateCache.set(key, imageData);\n}\n\nexport function getResizedTemplateCacheSize(): number {\n    return resizedTemplateCache.size;\n}\n\nexport function getMultiScaleTemplates(): Map<string, Map<number, ImageData>> {\n    return multiScaleTemplates;\n}\n\nexport function getMultiScaleTemplate(itemId: string, size: number): ImageData | undefined {\n    return multiScaleTemplates.get(itemId)?.get(size);\n}\n\nexport function setMultiScaleTemplate(itemId: string, size: number, imageData: ImageData): void {\n    // Bug fix: Enforce maximum size limit to prevent unbounded memory growth\n    const currentCount = getMultiScaleTemplateCount();\n    if (currentCount >= MAX_MULTI_SCALE_TEMPLATES) {\n        // Evict oldest entries (first item in the map)\n        const firstKey = multiScaleTemplates.keys().next().value;\n        if (firstKey !== undefined) {\n            multiScaleTemplates.delete(firstKey);\n            logger.info({\n                operation: 'cv.state.multi_scale_eviction',\n                data: { evictedItemId: firstKey, currentCount },\n            });\n        }\n    }\n\n    if (!multiScaleTemplates.has(itemId)) {\n        multiScaleTemplates.set(itemId, new Map());\n    }\n    multiScaleTemplates.get(itemId)!.set(size, imageData);\n}\n\nexport function hasMultiScaleTemplates(itemId: string): boolean {\n    return multiScaleTemplates.has(itemId) && multiScaleTemplates.get(itemId)!.size > 0;\n}\n\nexport function getMultiScaleTemplateCount(): number {\n    let count = 0;\n    multiScaleTemplates.forEach(sizes => {\n        count += sizes.size;\n    });\n    return count;\n}\n\nexport function getCacheCleanupTimer(): ReturnType<typeof setInterval> | null {\n    return cacheCleanupTimer;\n}\n\n// ========================================\n// State Setters\n// ========================================\n\nexport function setAllData(data: AllGameData): void {\n    allData = data;\n}\n\nexport function setTemplatesLoaded(loaded: boolean): void {\n    templatesLoaded = loaded;\n}\n\nexport function setPriorityTemplatesLoaded(loaded: boolean): void {\n    priorityTemplatesLoaded = loaded;\n}\n\nexport function setCacheCleanupTimer(timer: ReturnType<typeof setInterval> | null): void {\n    cacheCleanupTimer = timer;\n}\n\n// ========================================\n// State Reset (for cleanup)\n// ========================================\n\nexport function resetState(): void {\n    allData = {};\n    itemTemplates.clear();\n    templatesByColor.clear();\n    templatesLoaded = false;\n    priorityTemplatesLoaded = false;\n    standardTemplatesLoading = false;\n    detectionCache.clear();\n    resizedTemplateCache.clear();\n    multiScaleTemplates.clear();\n    gridPresets = null;\n    gridPresetsLoaded = false;\n    if (cacheCleanupTimer) {\n        clearInterval(cacheCleanupTimer);\n        cacheCleanupTimer = null;\n    }\n}\n\n// ========================================\n// Grid Presets State\n// ========================================\n\nlet gridPresets: GridPresetsFile | null = null;\nlet gridPresetsLoaded = false;\n\n/**\n * Load grid presets from the data directory\n */\nexport async function loadGridPresets(): Promise<GridPresetsFile | null> {\n    if (gridPresetsLoaded && gridPresets) {\n        return gridPresets;\n    }\n\n    try {\n        const response = await fetch('data/grid-presets.json');\n        if (!response.ok) {\n            logger.warn({\n                operation: 'cv.state.grid_presets_not_found',\n                data: { status: response.status },\n            });\n            gridPresetsLoaded = true;\n            return null;\n        }\n\n        gridPresets = await response.json();\n        gridPresetsLoaded = true;\n        logger.info({\n            operation: 'cv.state.grid_presets_loaded',\n            data: { presetCount: Object.keys(gridPresets?.presets || {}).length },\n        });\n        return gridPresets;\n    } catch (e) {\n        logger.warn({\n            operation: 'cv.state.grid_presets_load_error',\n            error: {\n                name: (e as Error).name,\n                message: (e as Error).message,\n            },\n        });\n        gridPresetsLoaded = true;\n        return null;\n    }\n}\n\n/**\n * Get a preset for a specific resolution\n */\nexport function getPresetForResolution(width: number, height: number): GridPreset | null {\n    if (!gridPresets?.presets) return null;\n    const key = `${width}x${height}`;\n    return gridPresets.presets[key] || null;\n}\n\n/**\n * Find best matching preset by aspect ratio (fallback when exact resolution not found)\n */\nexport function findPresetByAspectRatio(width: number, height: number): GridPreset | null {\n    if (!gridPresets?.presets) return null;\n    if (!Number.isFinite(width) || !Number.isFinite(height) || width <= 0 || height <= 0) {\n        return null;\n    }\n\n    const targetRatio = width / height;\n    let bestMatch: GridPreset | null = null;\n    let bestScore = Infinity;\n\n    for (const preset of Object.values(gridPresets.presets)) {\n        const presetRatio = preset.resolution.width / preset.resolution.height;\n        const ratioDiff = Math.abs(presetRatio - targetRatio);\n\n        // Prefer closer aspect ratio and closer total resolution\n        const sizeDiff = Math.abs(preset.resolution.width * preset.resolution.height - width * height) / 1000000;\n        const score = ratioDiff * 10 + sizeDiff;\n\n        if (score < bestScore) {\n            bestScore = score;\n            bestMatch = preset;\n        }\n    }\n\n    return bestMatch;\n}\n\n/**\n * Get all loaded presets\n */\nexport function getAllGridPresets(): Record<string, GridPreset> {\n    return gridPresets?.presets || {};\n}\n\n/**\n * Check if grid presets have been loaded\n */\nexport function isGridPresetsLoaded(): boolean {\n    return gridPresetsLoaded;\n}\n\n/**\n * Scale calibration values from one resolution to another\n */\nexport function scaleCalibrationToResolution(\n    calibration: GridPreset['calibration'],\n    fromHeight: number,\n    toHeight: number\n): GridPreset['calibration'] {\n    const scale = toHeight / fromHeight;\n    return {\n        xOffset: Math.round(calibration.xOffset * scale),\n        yOffset: Math.round(calibration.yOffset * scale),\n        iconWidth: Math.round(calibration.iconWidth * scale),\n        iconHeight: Math.round(calibration.iconHeight * scale),\n        xSpacing: Math.round(calibration.xSpacing * scale),\n        ySpacing: Math.round(calibration.ySpacing * scale),\n        iconsPerRow: calibration.iconsPerRow, // These don't scale\n        numRows: calibration.numRows,\n    };\n}\n","// ========================================\n// CV Training Data Loader\n// ========================================\n// Loads validated training samples for multi-template matching\n\nimport { logger } from '../logger.ts';\n\n// ========================================\n// Types\n// ========================================\n\nexport interface TrainingSample {\n    id: string;\n    file: string;\n    source_resolution: string;\n    source_image: string;\n    validation_type: 'verified' | 'corrected' | 'corrected_from_empty';\n    original_confidence: number;\n    dimensions: { w: number; h: number };\n    added_at: string;\n}\n\nexport interface TrainingItemData {\n    name: string;\n    sample_count: number;\n    samples: TrainingSample[];\n}\n\n/**\n * Source statistics for training data\n */\nexport interface TrainingSourceStats {\n    count: number;\n    weight: number;\n}\n\nexport interface TrainingIndex {\n    version: string;\n    created_at: string;\n    updated_at: string;\n    total_samples: number;\n    sources?: {\n        ground_truth?: TrainingSourceStats;\n        verified?: TrainingSourceStats;\n        corrected?: TrainingSourceStats;\n        corrected_from_empty?: TrainingSourceStats;\n    };\n    items: Record<string, TrainingItemData>;\n}\n\nexport interface TrainingTemplate {\n    imageData: ImageData;\n    weight: number; // 1.2 for corrected, 1.0 for verified, 0.8 for uncorrected\n    resolution: string;\n    validationType: string;\n    sourceImage: string; // e.g., \"pc-1080p/level_803_russian_stress_test.jpg\"\n}\n\n// ========================================\n// State\n// ========================================\n\n// Map of item_id -> array of training templates\nconst trainingTemplates = new Map<string, TrainingTemplate[]>();\nlet trainingDataLoaded = false;\nlet trainingDataLoadingInProgress = false; // Prevent concurrent load attempts\nlet trainingIndex: TrainingIndex | null = null;\n\n// Track available source images and which are enabled\nconst availableSources = new Set<string>();\nconst enabledSources = new Set<string>();\n\n// Session templates - added during this session via corrections/exports\n// These are immediately available for detection without running import script\nconst sessionTemplates = new Map<string, TrainingTemplate[]>();\nlet sessionTemplateCount = 0;\n\n// Base path for training data (relative to app root)\n// Can be overridden with setTrainingDataBasePath() for library consumers\nlet trainingDataBasePath = '/data/training-data/';\n\n/**\n * Set the base path for training data\n * Useful for library consumers who have different directory structures\n * @param path The base path (should end with /)\n */\nexport function setTrainingDataBasePath(path: string): void {\n    trainingDataBasePath = path.endsWith('/') ? path : path + '/';\n}\n\n// ========================================\n// Getters\n// ========================================\n\nexport function getTrainingTemplates(): Map<string, TrainingTemplate[]> {\n    return trainingTemplates;\n}\n\nexport function isTrainingDataLoaded(): boolean {\n    return trainingDataLoaded;\n}\n\nexport function getTrainingIndex(): TrainingIndex | null {\n    return trainingIndex;\n}\n\nexport function getTrainingTemplatesForItem(itemId: string): TrainingTemplate[] {\n    const templates = trainingTemplates.get(itemId) || [];\n    const sessionTpls = sessionTemplates.get(itemId) || [];\n\n    // Combine loaded templates with session templates\n    let combined: TrainingTemplate[];\n\n    // If no sources are enabled or all sources are enabled, return all\n    if (enabledSources.size === 0 || enabledSources.size === availableSources.size) {\n        combined = [...templates, ...sessionTpls];\n    } else {\n        // Filter by enabled sources (session templates always included)\n        combined = [...templates.filter(t => enabledSources.has(t.sourceImage)), ...sessionTpls];\n    }\n\n    return combined;\n}\n\n// ========================================\n// Session Template Management\n// ========================================\n\n// Max session templates per item to prevent memory bloat\nconst MAX_SESSION_TEMPLATES_PER_ITEM = 10;\n\n/**\n * Add a template to the session pool (immediately available for detection)\n * @param itemId The item ID this template represents\n * @param imageData The ImageData of the cropped icon\n * @param metadata Additional metadata about the template\n * @returns true if template was added, false if duplicate or limit reached\n */\nexport function addSessionTemplate(\n    itemId: string,\n    imageData: ImageData,\n    metadata: {\n        resolution?: string;\n        validationType?: 'corrected' | 'verified' | 'corrected_from_empty';\n        sourceImage?: string;\n        originalConfidence?: number;\n    } = {}\n): boolean {\n    const sourceImage = metadata.sourceImage || `session_${Date.now()}`;\n\n    // Initialize array if needed\n    if (!sessionTemplates.has(itemId)) {\n        sessionTemplates.set(itemId, []);\n    }\n\n    const existingTemplates = sessionTemplates.get(itemId)!;\n\n    // Check for duplicate (same source image and resolution)\n    const isDuplicate = existingTemplates.some(\n        t => t.sourceImage === sourceImage && t.resolution === (metadata.resolution || 'unknown')\n    );\n\n    if (isDuplicate) {\n        logger.info({\n            operation: 'cv.training.session_template_duplicate',\n            data: { itemId, sourceImage },\n        });\n        return false;\n    }\n\n    // Check per-item limit\n    if (existingTemplates.length >= MAX_SESSION_TEMPLATES_PER_ITEM) {\n        logger.info({\n            operation: 'cv.training.session_template_limit_reached',\n            data: { itemId, limit: MAX_SESSION_TEMPLATES_PER_ITEM },\n        });\n        return false;\n    }\n\n    const template: TrainingTemplate = {\n        imageData,\n        weight: getTemplateWeight(metadata.validationType || 'corrected'),\n        resolution: metadata.resolution || 'unknown',\n        validationType: metadata.validationType || 'corrected',\n        sourceImage,\n    };\n\n    existingTemplates.push(template);\n    sessionTemplateCount++;\n\n    logger.info({\n        operation: 'cv.training.session_template_added',\n        data: { itemId, sessionCount: sessionTemplateCount, validationType: metadata.validationType },\n    });\n\n    return true;\n}\n\n/**\n * Get the count of session templates added this session\n */\nexport function getSessionTemplateCount(): number {\n    return sessionTemplateCount;\n}\n\n/**\n * Get session templates for a specific item\n */\nexport function getSessionTemplatesForItem(itemId: string): TrainingTemplate[] {\n    return sessionTemplates.get(itemId) || [];\n}\n\n/**\n * Clear all session templates (e.g., on page reload)\n */\nexport function clearSessionTemplates(): void {\n    sessionTemplates.clear();\n    sessionTemplateCount = 0;\n    logger.info({ operation: 'cv.training.session_templates_cleared' });\n}\n\n/**\n * Get all items that have session templates\n */\nexport function getSessionTemplateItems(): string[] {\n    return Array.from(sessionTemplates.keys());\n}\n\n// ========================================\n// Source Management\n// ========================================\n\n/**\n * Get all available training data sources\n */\nexport function getAvailableSources(): string[] {\n    return Array.from(availableSources).sort();\n}\n\n/**\n * Get currently enabled sources\n */\nexport function getEnabledSources(): string[] {\n    return Array.from(enabledSources).sort();\n}\n\n/**\n * Enable a specific source\n */\nexport function enableSource(source: string): void {\n    if (availableSources.has(source)) {\n        enabledSources.add(source);\n    }\n}\n\n/**\n * Disable a specific source\n */\nexport function disableSource(source: string): void {\n    enabledSources.delete(source);\n}\n\n/**\n * Set which sources are enabled (replaces current selection)\n */\nexport function setEnabledSources(sources: string[]): void {\n    enabledSources.clear();\n    for (const source of sources) {\n        if (availableSources.has(source)) {\n            enabledSources.add(source);\n        }\n    }\n}\n\n/**\n * Enable all sources\n */\nexport function enableAllSources(): void {\n    enabledSources.clear();\n    for (const source of availableSources) {\n        enabledSources.add(source);\n    }\n}\n\n/**\n * Check if a source is enabled\n */\nexport function isSourceEnabled(source: string): boolean {\n    // If no explicit selection, all are considered enabled\n    if (enabledSources.size === 0) return true;\n    return enabledSources.has(source);\n}\n\n// ========================================\n// Weight Calculation\n// ========================================\n\nfunction getTemplateWeight(validationType: string): number {\n    switch (validationType) {\n        case 'corrected':\n        case 'corrected_from_empty':\n            return 1.2; // Most valuable - human-labeled\n        case 'verified':\n            return 1.0; // Confirmed correct\n        default:\n            return 0.8; // Unreviewed\n    }\n}\n\n// ========================================\n// Loading Functions\n// ========================================\n\n/**\n * Load a single training image as ImageData\n */\nasync function loadTrainingImage(imagePath: string): Promise<ImageData | null> {\n    return new Promise(resolve => {\n        const img = new Image();\n        let resolved = false;\n\n        // Timeout after 5 seconds\n        const timeout = setTimeout(() => {\n            if (!resolved) {\n                resolved = true;\n                logger.warn({\n                    operation: 'cv.training.load_image_timeout',\n                    data: { imagePath, timeoutMs: 5000 },\n                });\n                resolve(null);\n            }\n        }, 5000);\n\n        img.onload = () => {\n            if (resolved) return;\n            resolved = true;\n            clearTimeout(timeout);\n\n            try {\n                const canvas = document.createElement('canvas');\n                canvas.width = img.width;\n                canvas.height = img.height;\n                const ctx = canvas.getContext('2d', { willReadFrequently: true });\n\n                if (!ctx) {\n                    logger.warn({\n                        operation: 'cv.training.canvas_context_failed',\n                        data: { imagePath, width: img.width, height: img.height },\n                    });\n                    resolve(null);\n                    return;\n                }\n\n                ctx.drawImage(img, 0, 0);\n                const imageData = ctx.getImageData(0, 0, img.width, img.height);\n                resolve(imageData);\n            } catch (error) {\n                logger.warn({\n                    operation: 'cv.training.load_image_processing_error',\n                    error: { name: (error as Error).name, message: (error as Error).message },\n                    data: { imagePath },\n                });\n                resolve(null);\n            }\n        };\n\n        img.onerror = (event) => {\n            if (resolved) return;\n            resolved = true;\n            clearTimeout(timeout);\n            logger.warn({\n                operation: 'cv.training.load_image_failed',\n                data: { imagePath, error: event instanceof ErrorEvent ? event.message : 'Unknown error' },\n            });\n            resolve(null);\n        };\n\n        img.src = trainingDataBasePath + imagePath;\n    });\n}\n\n/**\n * Load training data index and all training templates\n */\nexport async function loadTrainingData(): Promise<boolean> {\n    if (trainingDataLoaded) {\n        logger.info({\n            operation: 'cv.training.already_loaded',\n            data: { templateCount: trainingTemplates.size },\n        });\n        return true;\n    }\n\n    // Prevent concurrent load attempts\n    if (trainingDataLoadingInProgress) {\n        logger.info({\n            operation: 'cv.training.load_in_progress',\n            data: { message: 'Training data load already in progress' },\n        });\n        return false;\n    }\n\n    trainingDataLoadingInProgress = true;\n\n    try {\n        // Load index file\n        const indexPath = trainingDataBasePath + 'index.json';\n        const response = await fetch(indexPath);\n\n        if (!response.ok) {\n            logger.info({\n                operation: 'cv.training.no_index',\n                data: { status: response.status, message: 'No training data index found' },\n            });\n            trainingDataLoaded = true; // Mark as loaded (just no data)\n            return true;\n        }\n\n        const index: TrainingIndex = await response.json();\n        trainingIndex = index;\n\n        logger.info({\n            operation: 'cv.training.index_loaded',\n            data: {\n                version: index.version,\n                totalSamples: index.total_samples,\n                itemCount: Object.keys(index.items).length,\n            },\n        });\n\n        // Load training templates for each item\n        let loadedCount = 0;\n        let failedCount = 0;\n\n        for (const [itemId, itemData] of Object.entries(index.items)) {\n            const templates: TrainingTemplate[] = [];\n\n            for (const sample of itemData.samples) {\n                const imageData = await loadTrainingImage(sample.file);\n\n                if (imageData) {\n                    // Track this source\n                    availableSources.add(sample.source_image);\n\n                    templates.push({\n                        imageData,\n                        weight: getTemplateWeight(sample.validation_type),\n                        resolution: sample.source_resolution,\n                        validationType: sample.validation_type,\n                        sourceImage: sample.source_image,\n                    });\n                    loadedCount++;\n                } else {\n                    failedCount++;\n                }\n            }\n\n            if (templates.length > 0) {\n                trainingTemplates.set(itemId, templates);\n            }\n        }\n\n        trainingDataLoaded = true;\n\n        // Enable all sources by default\n        enableAllSources();\n\n        logger.info({\n            operation: 'cv.training.load_complete',\n            data: {\n                loadedTemplates: loadedCount,\n                failedTemplates: failedCount,\n                itemsWithTemplates: trainingTemplates.size,\n                sourcesFound: availableSources.size,\n            },\n        });\n\n        trainingDataLoadingInProgress = false;\n        return true;\n    } catch (error) {\n        logger.warn({\n            operation: 'cv.training.load_error',\n            error: {\n                name: (error as Error).name,\n                message: (error as Error).message,\n            },\n        });\n\n        // Don't mark as loaded on error - allow retry\n        // Just reset the loading flag so another attempt can be made\n        trainingDataLoadingInProgress = false;\n        return false;\n    }\n}\n\n/**\n * Get training data statistics\n */\nexport function getTrainingStats(): {\n    loaded: boolean;\n    totalItems: number;\n    totalTemplates: number;\n    itemsWithMostSamples: { id: string; count: number }[];\n} {\n    let totalTemplates = 0;\n    const itemCounts: { id: string; count: number }[] = [];\n\n    for (const [itemId, templates] of trainingTemplates) {\n        totalTemplates += templates.length;\n        itemCounts.push({ id: itemId, count: templates.length });\n    }\n\n    // Sort by count descending\n    itemCounts.sort((a, b) => b.count - a.count);\n\n    return {\n        loaded: trainingDataLoaded,\n        totalItems: trainingTemplates.size,\n        totalTemplates,\n        itemsWithMostSamples: itemCounts.slice(0, 10),\n    };\n}\n\n/**\n * Clear training data (for cleanup)\n */\nexport function clearTrainingData(): void {\n    trainingTemplates.clear();\n    trainingDataLoaded = false;\n    trainingDataLoadingInProgress = false;\n    trainingIndex = null;\n    availableSources.clear();\n    enabledSources.clear();\n}\n\n/**\n * Training data version info\n */\nexport interface TrainingDataVersion {\n    version: string;\n    createdAt: string;\n    updatedAt: string;\n    totalSamples: number;\n    sources: {\n        verified: number;\n        corrected: number;\n        corrected_from_empty: number;\n    };\n    itemCount: number;\n}\n\n/**\n * Get training data version and statistics\n * Useful for tracking accuracy improvements over time\n */\nexport function getTrainingDataVersion(): TrainingDataVersion | null {\n    if (!trainingIndex) return null;\n\n    // Count samples by validation type\n    const sourceCounts = {\n        verified: 0,\n        corrected: 0,\n        corrected_from_empty: 0,\n    };\n\n    for (const itemData of Object.values(trainingIndex.items)) {\n        for (const sample of itemData.samples) {\n            if (sample.validation_type in sourceCounts) {\n                sourceCounts[sample.validation_type as keyof typeof sourceCounts]++;\n            }\n        }\n    }\n\n    return {\n        version: trainingIndex.version,\n        createdAt: trainingIndex.created_at,\n        updatedAt: trainingIndex.updated_at,\n        totalSamples: trainingIndex.total_samples,\n        sources: sourceCounts,\n        itemCount: Object.keys(trainingIndex.items).length,\n    };\n}\n\n/**\n * Log training data version on startup (for debugging)\n */\nexport function logTrainingDataVersion(): void {\n    const version = getTrainingDataVersion();\n    if (version) {\n        logger.info({\n            operation: 'cv.training.version_info',\n            data: {\n                version: version.version,\n                totalSamples: version.totalSamples,\n                itemCount: version.itemCount,\n                sources: version.sources,\n                updatedAt: version.updatedAt,\n            },\n        });\n    }\n}\n","// ========================================\n// CV Core - Initialization and Cleanup\n// ========================================\n\nimport type { AllGameData } from '../../types/index.ts';\nimport { logger } from '../logger.ts';\nimport {\n    getItemTemplates,\n    getTemplatesByColor,\n    getDetectionCache,\n    getCacheCleanupTimer,\n    setAllData,\n    setTemplatesLoaded,\n    setPriorityTemplatesLoaded,\n    setCacheCleanupTimer,\n    isTemplatesLoaded,\n    isPriorityTemplatesLoaded as isPriorityTemplatesLoadedState,\n    CACHE_TTL,\n    MAX_CACHE_SIZE,\n} from './state.ts';\nimport { loadTrainingData, clearTrainingData, isTrainingDataLoaded } from './training.ts';\n\n// ========================================\n// Cache Cleanup\n// ========================================\n\n/**\n * Start periodic cache cleanup to prevent memory leaks\n * Runs every 5 minutes to evict expired entries\n */\nexport function startCacheCleanup(): void {\n    if (getCacheCleanupTimer()) return; // Already running\n\n    const timer = setInterval(\n        () => {\n            const now = Date.now();\n            let evicted = 0;\n            const detectionCache = getDetectionCache();\n\n            // Evict expired cache entries\n            for (const [key, entry] of detectionCache.entries()) {\n                if (now - entry.timestamp > CACHE_TTL) {\n                    detectionCache.delete(key);\n                    evicted++;\n                }\n            }\n\n            // If still over max size, evict oldest entries\n            if (detectionCache.size > MAX_CACHE_SIZE) {\n                const entries = Array.from(detectionCache.entries());\n                entries.sort((a, b) => a[1].timestamp - b[1].timestamp);\n\n                const toEvict = detectionCache.size - MAX_CACHE_SIZE + 10; // Evict 10 extra\n                for (let i = 0; i < toEvict && i < entries.length; i++) {\n                    const entry = entries[i];\n                    if (entry) {\n                        detectionCache.delete(entry[0]);\n                        evicted++;\n                    }\n                }\n            }\n\n            if (evicted > 0) {\n                logger.info({\n                    operation: 'cv.cache_cleanup',\n                    data: { evicted, remaining: detectionCache.size },\n                });\n            }\n        },\n        5 * 60 * 1000\n    ); // Run every 5 minutes\n\n    setCacheCleanupTimer(timer);\n}\n\n/**\n * Stop periodic cache cleanup\n */\nexport function stopCacheCleanup(): void {\n    const timer = getCacheCleanupTimer();\n    if (timer) {\n        clearInterval(timer);\n        setCacheCleanupTimer(null);\n    }\n}\n\n// ========================================\n// Initialization and Cleanup\n// ========================================\n\n/**\n * Cleanup all CV module resources (templates, caches, timers)\n * Call this when the app is being unloaded or CV is no longer needed\n */\nexport function cleanupCV(): void {\n    // Stop periodic cleanup\n    stopCacheCleanup();\n\n    // Clear all caches\n    getDetectionCache().clear();\n    getItemTemplates().clear();\n    getTemplatesByColor().clear();\n\n    // Clear training data\n    clearTrainingData();\n\n    // Reset state\n    setTemplatesLoaded(false);\n    setPriorityTemplatesLoaded(false);\n    setAllData({});\n\n    logger.info({\n        operation: 'cv.cleanup',\n        data: { message: 'CV module cleaned up' },\n    });\n}\n\n/**\n * Initialize computer vision module\n */\nexport function initCV(gameData: AllGameData): void {\n    // Bug fix #4: Handle null/undefined gameData\n    setAllData(gameData || {});\n\n    // Start periodic cache cleanup to prevent memory leaks\n    startCacheCleanup();\n\n    // Load training data in background (non-blocking)\n    // Training data enhances detection but isn't required for basic functionality\n    if (!isTrainingDataLoaded()) {\n        loadTrainingData().catch(error => {\n            logger.warn({\n                operation: 'cv.training.background_load_error',\n                error: {\n                    name: (error as Error).name,\n                    message: (error as Error).message,\n                    stack: (error as Error).stack?.split('\\n').slice(0, 3).join(' -> '),\n                },\n                data: {\n                    phase: 'background_init',\n                    itemsAvailable: gameData?.items?.items?.length || 0,\n                },\n            });\n        });\n    }\n\n    logger.info({\n        operation: 'cv.init',\n        data: {\n            itemsCount: gameData?.items?.items?.length || 0,\n        },\n    });\n}\n\n/**\n * Check if all templates are fully loaded (not just priority)\n * Use this to prevent detection with incomplete template set\n */\nexport function isFullyLoaded(): boolean {\n    return isTemplatesLoaded();\n}\n\n/**\n * Check if priority templates are loaded (enough for basic detection)\n */\nexport function isPriorityLoaded(): boolean {\n    return isPriorityTemplatesLoadedState();\n}\n","// ========================================\n// CV Color Utilities\n// Helper functions and color space conversions\n// ========================================\n\n/**\n * Convert RGB to HSL color space\n * Returns { h: 0-360, s: 0-100, l: 0-100 }\n */\nexport function rgbToHsl(r: number, g: number, b: number): { h: number; s: number; l: number } {\n    r /= 255;\n    g /= 255;\n    b /= 255;\n    const max = Math.max(r, g, b);\n    const min = Math.min(r, g, b);\n    let h = 0;\n    let s = 0;\n    const l = (max + min) / 2;\n\n    if (max !== min) {\n        const d = max - min;\n        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\n        switch (max) {\n            case r:\n                h = ((g - b) / d + (g < b ? 6 : 0)) / 6;\n                break;\n            case g:\n                h = ((b - r) / d + 2) / 6;\n                break;\n            case b:\n                h = ((r - g) / d + 4) / 6;\n                break;\n        }\n    }\n\n    return { h: h * 360, s: s * 100, l: l * 100 };\n}\n\n// ========================================\n// Rarity Border Color Definitions (HSL ranges)\n// ========================================\n\nexport interface RarityColorDef {\n    name: string;\n    h: [number, number];\n    s: [number, number];\n    l: [number, number];\n    rgb: { r: [number, number]; g: [number, number]; b: [number, number] };\n}\n\nexport const RARITY_BORDER_COLORS: Record<string, RarityColorDef> = {\n    common: {\n        name: 'common',\n        // Gray - low saturation\n        h: [0, 360],\n        s: [0, 25],\n        l: [35, 75],\n        rgb: { r: [100, 200], g: [100, 200], b: [100, 200] },\n    },\n    uncommon: {\n        name: 'uncommon',\n        // Green - widened ranges for noise tolerance\n        h: [85, 155],\n        s: [30, 100],\n        l: [20, 70],\n        rgb: { r: [0, 150], g: [100, 255], b: [0, 150] },\n    },\n    rare: {\n        name: 'rare',\n        // Blue - widened red range to include pure blue [0, 128, 255]\n        h: [190, 250],\n        s: [50, 100],\n        l: [35, 70],\n        rgb: { r: [0, 150], g: [60, 220], b: [150, 255] },\n    },\n    epic: {\n        name: 'epic',\n        // Purple - widened green range to include [128, 0, 255]\n        h: [260, 320],\n        s: [40, 100],\n        l: [25, 70],\n        rgb: { r: [100, 220], g: [0, 150], b: [150, 255] },\n    },\n    legendary: {\n        name: 'legendary',\n        // Orange/Gold - widened blue range to include pure orange [255, 165, 0]\n        h: [15, 55],\n        s: [70, 100],\n        l: [40, 80],\n        rgb: { r: [200, 255], g: [80, 220], b: [0, 150] },\n    },\n};\n\n/**\n * Get adjacent/related colors for a given primary color\n * Used for expanded color filtering when exact match fails\n */\nexport function getAdjacentColors(color: string): string[] {\n    // Define color adjacency relationships based on color wheel and common variations\n    const adjacencyMap: Record<string, string[]> = {\n        red: ['orange', 'magenta', 'purple'],\n        orange: ['red', 'yellow'],\n        yellow: ['orange', 'lime', 'green'],\n        green: ['lime', 'cyan', 'yellow'],\n        lime: ['green', 'yellow', 'cyan'],\n        cyan: ['green', 'blue', 'lime'],\n        blue: ['cyan', 'purple', 'navy'],\n        purple: ['blue', 'magenta', 'red'],\n        magenta: ['purple', 'red'],\n        gray: ['black', 'white'],\n        black: ['gray'],\n        white: ['gray'],\n    };\n\n    return adjacencyMap[color] || [];\n}\n\n/**\n * Get all color candidates for filtering, including adjacent colors\n * Returns array of colors in priority order: [exact, ...adjacent]\n */\nexport function getColorCandidates(color: string): string[] {\n    const adjacent = getAdjacentColors(color);\n    return [color, ...adjacent];\n}\n\n// ========================================\n// Empty Cell Detection Constants\n// ========================================\n\nexport const EMPTY_CELL_MEAN_THRESHOLD = 40; // Very dark cells are empty\n\n// New detection method thresholds (Ideas #1, #2, #3, #7)\nexport const EMPTY_DETECTION_CONFIG = {\n    // #1: Confidence threshold - discard matches below this after template matching\n    MIN_CONFIDENCE: 0.5,\n    // #2: Saturation check - low saturation cells are likely empty (grey backgrounds)\n    MAX_SATURATION: 0.15,\n    // #3: Histogram width - cells with few distinct colors are likely empty\n    // Value of 3 means cells with 2 colors are considered empty (solid backgrounds)\n    MIN_HISTOGRAM_BINS: 3,\n    // #7: Center/edge ratio - uniform cells (no icon in center) are likely empty\n    // Value of 1.1 means center variance should be at least 10% higher than edges\n    // Lower threshold to avoid false positives on small/synthetic test images\n    MIN_CENTER_EDGE_RATIO: 1.1,\n\n    // Toggle which methods are active\n    methods: {\n        useVariance: true, // Existing method (variance + edge density)\n        useConfidenceThreshold: true, // #1: Post-match confidence filter\n        useSaturation: true, // #2: Low saturation = empty (good for grey backgrounds)\n        useHistogram: true, // #3: Few colors = empty (enabled)\n        useCenterEdge: true, // #7: Uniform = empty (enabled)\n    },\n};\n\n// ========================================\n// Color Calculation Utilities\n// ========================================\n\n/**\n * Calculate color variance to detect empty cells or low-detail regions\n */\nexport function calculateColorVariance(imageData: ImageData): number {\n    const pixels = imageData.data;\n    let sumR = 0;\n    let sumG = 0;\n    let sumB = 0;\n    let count = 0;\n\n    for (let i = 0; i < pixels.length; i += 16) {\n        sumR += pixels[i] ?? 0;\n        sumG += pixels[i + 1] ?? 0;\n        sumB += pixels[i + 2] ?? 0;\n        count++;\n    }\n\n    const meanR = sumR / count;\n    const meanG = sumG / count;\n    const meanB = sumB / count;\n\n    let varianceSum = 0;\n    for (let i = 0; i < pixels.length; i += 16) {\n        const diffR = (pixels[i] ?? 0) - meanR;\n        const diffG = (pixels[i + 1] ?? 0) - meanG;\n        const diffB = (pixels[i + 2] ?? 0) - meanB;\n        varianceSum += diffR * diffR + diffG * diffG + diffB * diffB;\n    }\n\n    return varianceSum / count;\n}\n\n/**\n * #2: Calculate average color saturation (HSL-based)\n * Returns value from 0 (grayscale) to 1 (fully saturated)\n *\n * Why it works: Item icons have vibrant colors (high saturation)\n * while stone/brick backgrounds are grey (low saturation)\n */\nexport function calculateAverageSaturation(imageData: ImageData): number {\n    const pixels = imageData.data;\n    let totalSaturation = 0;\n    let count = 0;\n\n    // Sample every 4th pixel for performance\n    for (let i = 0; i < pixels.length; i += 16) {\n        const r = pixels[i] ?? 0;\n        const g = pixels[i + 1] ?? 0;\n        const b = pixels[i + 2] ?? 0;\n\n        const max = Math.max(r, g, b);\n        const min = Math.min(r, g, b);\n\n        // Saturation formula (HSL-based)\n        // Saturation = 0 when max == min (pure grey)\n        let saturation = 0;\n        if (max !== min) {\n            const lightness = (max + min) / 2;\n            if (lightness <= 127.5) {\n                saturation = (max - min) / (max + min);\n            } else {\n                saturation = (max - min) / (510 - max - min);\n            }\n        }\n\n        totalSaturation += saturation;\n        count++;\n    }\n\n    return count > 0 ? totalSaturation / count : 0;\n}\n\n/**\n * #3: Calculate color histogram width (number of distinct color bins)\n * Returns count of occupied bins (0-512)\n *\n * Why it works: Item icons have multiple distinct colors (outline, fill, highlights)\n * while backgrounds have few colors (grey variations)\n */\nexport function calculateHistogramWidth(imageData: ImageData): number {\n    const pixels = imageData.data;\n    const bins = new Set<number>();\n\n    // Sample every 4th pixel for performance\n    for (let i = 0; i < pixels.length; i += 16) {\n        const r = pixels[i] ?? 0;\n        const g = pixels[i + 1] ?? 0;\n        const b = pixels[i + 2] ?? 0;\n\n        // Quantize to 32 bins (5 bits per channel  8 levels each)\n        // This gives 8*8*8 = 512 possible unique bins\n        const rBin = Math.floor(r / 32);\n        const gBin = Math.floor(g / 32);\n        const bBin = Math.floor(b / 32);\n        const binIndex = (rBin << 6) | (gBin << 3) | bBin;\n\n        bins.add(binIndex);\n    }\n\n    return bins.size;\n}\n\n/**\n * #7: Calculate center vs edge variance ratio\n * Returns ratio of center variance to edge variance\n *\n * Why it works: Item icons are centered, so center region should be\n * more detailed than edges. Uniform backgrounds have ratio ~1.0\n */\nexport function calculateCenterEdgeRatio(imageData: ImageData): number {\n    const pixels = imageData.data;\n    const width = imageData.width;\n    const height = imageData.height;\n\n    // Define center region (inner 50%) and edge region (outer 25% ring)\n    const marginX = Math.floor(width * 0.25);\n    const marginY = Math.floor(height * 0.25);\n\n    // Calculate variance for center region\n    let centerSumR = 0,\n        centerSumG = 0,\n        centerSumB = 0;\n    let centerSumSqR = 0,\n        centerSumSqG = 0,\n        centerSumSqB = 0;\n    let centerCount = 0;\n\n    // Calculate variance for edge region\n    let edgeSumR = 0,\n        edgeSumG = 0,\n        edgeSumB = 0;\n    let edgeSumSqR = 0,\n        edgeSumSqG = 0,\n        edgeSumSqB = 0;\n    let edgeCount = 0;\n\n    for (let y = 0; y < height; y += 2) {\n        for (let x = 0; x < width; x += 2) {\n            const idx = (y * width + x) * 4;\n            const r = pixels[idx] ?? 0;\n            const g = pixels[idx + 1] ?? 0;\n            const b = pixels[idx + 2] ?? 0;\n\n            // Check if this pixel is in center or edge region\n            const inCenterX = x >= marginX && x < width - marginX;\n            const inCenterY = y >= marginY && y < height - marginY;\n\n            if (inCenterX && inCenterY) {\n                // Center region\n                centerSumR += r;\n                centerSumG += g;\n                centerSumB += b;\n                centerSumSqR += r * r;\n                centerSumSqG += g * g;\n                centerSumSqB += b * b;\n                centerCount++;\n            } else {\n                // Edge region\n                edgeSumR += r;\n                edgeSumG += g;\n                edgeSumB += b;\n                edgeSumSqR += r * r;\n                edgeSumSqG += g * g;\n                edgeSumSqB += b * b;\n                edgeCount++;\n            }\n        }\n    }\n\n    // Calculate variances\n    if (centerCount === 0 || edgeCount === 0) return 1.0;\n\n    const centerMeanR = centerSumR / centerCount;\n    const centerMeanG = centerSumG / centerCount;\n    const centerMeanB = centerSumB / centerCount;\n    const centerVariance =\n        centerSumSqR / centerCount -\n        centerMeanR * centerMeanR +\n        (centerSumSqG / centerCount - centerMeanG * centerMeanG) +\n        (centerSumSqB / centerCount - centerMeanB * centerMeanB);\n\n    const edgeMeanR = edgeSumR / edgeCount;\n    const edgeMeanG = edgeSumG / edgeCount;\n    const edgeMeanB = edgeSumB / edgeCount;\n    const edgeVariance =\n        edgeSumSqR / edgeCount -\n        edgeMeanR * edgeMeanR +\n        (edgeSumSqG / edgeCount - edgeMeanG * edgeMeanG) +\n        (edgeSumSqB / edgeCount - edgeMeanB * edgeMeanB);\n\n    // Return ratio (add 1 to avoid division by zero)\n    return centerVariance / (edgeVariance + 1);\n}\n\n/**\n * Calculate edge density using gradient detection\n * Returns ratio of edge pixels to total pixels (0-1)\n */\nexport function calculateEdgeDensity(imageData: ImageData): number {\n    const pixels = imageData.data;\n    const width = imageData.width;\n    const height = imageData.height;\n    let edgePixels = 0;\n    let totalPixels = 0;\n\n    // Simple gradient detection: compare each pixel to neighbors\n    for (let y = 1; y < height - 1; y += 2) {\n        for (let x = 1; x < width - 1; x += 2) {\n            const idx = (y * width + x) * 4;\n\n            // Get grayscale values\n            const center = ((pixels[idx] ?? 0) + (pixels[idx + 1] ?? 0) + (pixels[idx + 2] ?? 0)) / 3;\n            const right = ((pixels[idx + 4] ?? 0) + (pixels[idx + 5] ?? 0) + (pixels[idx + 6] ?? 0)) / 3;\n            const bottom =\n                ((pixels[idx + width * 4] ?? 0) +\n                    (pixels[idx + width * 4 + 1] ?? 0) +\n                    (pixels[idx + width * 4 + 2] ?? 0)) /\n                3;\n\n            // Calculate gradient magnitude\n            const gradX = Math.abs(right - center);\n            const gradY = Math.abs(bottom - center);\n            const gradient = gradX + gradY;\n\n            if (gradient > 30) {\n                edgePixels++;\n            }\n            totalPixels++;\n        }\n    }\n\n    return totalPixels > 0 ? edgePixels / totalPixels : 0;\n}\n","// ========================================\n// CV Color Extraction\n// Extracting colors from images, dominant color detection\n// ========================================\n\n/**\n * Extract dominant colors from image region\n * Useful for icon-based matching\n */\nexport function extractDominantColors(\n    imageData: ImageData,\n    numColors: number = 5\n): { r: number; g: number; b: number; frequency: number }[] {\n    const pixels = imageData.data;\n    const colorMap = new Map<string, number>();\n\n    // Sample pixels (every 4th pixel for performance)\n    for (let i = 0; i < pixels.length; i += 16) {\n        const r = Math.floor((pixels[i] ?? 0) / 32) * 32;\n        const g = Math.floor((pixels[i + 1] ?? 0) / 32) * 32;\n        const b = Math.floor((pixels[i + 2] ?? 0) / 32) * 32;\n        const key = `${r},${g},${b}`;\n\n        colorMap.set(key, (colorMap.get(key) || 0) + 1);\n    }\n\n    // Get top colors\n    const sortedColors = Array.from(colorMap.entries())\n        .sort((a, b) => b[1] - a[1])\n        .slice(0, numColors)\n        .map(([key, freq]) => {\n            const parts = key.split(',').map(Number);\n            return { r: parts[0] ?? 0, g: parts[1] ?? 0, b: parts[2] ?? 0, frequency: freq };\n        });\n\n    return sortedColors;\n}\n\n/**\n * Hierarchical color category with detailed information\n * Provides richer color matching for better pre-filtering\n */\nexport interface DetailedColorCategory {\n    primary: string; // Main color category\n    secondary: string; // More specific subcategory\n    saturation: 'low' | 'medium' | 'high';\n    brightness: 'dark' | 'medium' | 'bright';\n}\n\n/**\n * Get detailed hierarchical color category from ImageData\n * More accurate than simple dominant color for template matching\n */\nexport function getDetailedColorCategory(imageData: ImageData): DetailedColorCategory {\n    const pixels = imageData.data;\n    let sumR = 0;\n    let sumG = 0;\n    let sumB = 0;\n    let count = 0;\n\n    // Sample pixels (skip alpha, sample every 4th pixel)\n    for (let i = 0; i < pixels.length; i += 16) {\n        sumR += pixels[i] ?? 0;\n        sumG += pixels[i + 1] ?? 0;\n        sumB += pixels[i + 2] ?? 0;\n        count++;\n    }\n\n    if (count === 0) {\n        return { primary: 'gray', secondary: 'neutral', saturation: 'low', brightness: 'medium' };\n    }\n\n    const avgR = sumR / count;\n    const avgG = sumG / count;\n    const avgB = sumB / count;\n\n    // Calculate HSL-like values\n    const maxChannel = Math.max(avgR, avgG, avgB);\n    const minChannel = Math.min(avgR, avgG, avgB);\n    const diff = maxChannel - minChannel;\n    const lightness = (maxChannel + minChannel) / 2;\n    const saturationValue = diff === 0 ? 0 : diff / (255 - Math.abs(2 * lightness - 255));\n\n    // Determine saturation level\n    let saturation: 'low' | 'medium' | 'high';\n    if (saturationValue < 0.2) saturation = 'low';\n    else if (saturationValue < 0.5) saturation = 'medium';\n    else saturation = 'high';\n\n    // Determine brightness level\n    let brightness: 'dark' | 'medium' | 'bright';\n    if (lightness < 80) brightness = 'dark';\n    else if (lightness < 180) brightness = 'medium';\n    else brightness = 'bright';\n\n    // Determine primary and secondary colors\n    let primary: string;\n    let secondary: string;\n\n    // Low saturation = achromatic\n    if (diff < 30) {\n        primary = 'gray';\n        if (lightness < 60) secondary = 'black';\n        else if (lightness > 200) secondary = 'white';\n        else secondary = 'neutral';\n        return { primary, secondary, saturation, brightness };\n    }\n\n    // Chromatic colors - determine by dominant channel\n    if (avgR >= avgG && avgR >= avgB) {\n        // Red dominant\n        primary = 'red';\n        if (avgG > avgB * 1.5 && avgG > 100) {\n            secondary = avgG > 180 ? 'yellow' : 'orange';\n        } else if (avgB > avgG * 1.2 && avgB > 80) {\n            secondary = 'magenta';\n        } else {\n            secondary = avgR > 200 ? 'bright_red' : 'dark_red';\n        }\n    } else if (avgG >= avgR && avgG >= avgB) {\n        // Green dominant\n        primary = 'green';\n        if (avgB > avgR * 1.3 && avgB > 80) {\n            secondary = 'cyan';\n        } else if (avgR > avgB && avgR > 100) {\n            secondary = 'lime';\n        } else {\n            secondary = avgG > 200 ? 'bright_green' : 'forest';\n        }\n    } else {\n        // Blue dominant\n        primary = 'blue';\n        if (avgR > avgG * 1.3 && avgR > 80) {\n            secondary = 'purple';\n        } else if (avgG > avgR && avgG > 100) {\n            secondary = 'sky';\n        } else {\n            secondary = avgB > 200 ? 'bright_blue' : 'navy';\n        }\n    }\n\n    return { primary, secondary, saturation, brightness };\n}\n\n/**\n * Get dominant color category from ImageData (legacy function)\n * Used for color-based pre-filtering\n */\nexport function getDominantColor(imageData: ImageData): string {\n    const detailed = getDetailedColorCategory(imageData);\n\n    // Map detailed category to simple color string for backward compatibility\n    if (detailed.primary === 'gray') {\n        if (detailed.secondary === 'black') return 'black';\n        if (detailed.secondary === 'white') return 'white';\n        return 'gray';\n    }\n\n    // Use secondary for more specific colors where available\n    if (detailed.secondary === 'yellow' || detailed.secondary === 'orange') {\n        return detailed.secondary;\n    }\n    if (detailed.secondary === 'cyan' || detailed.secondary === 'lime') {\n        return detailed.secondary;\n    }\n    if (detailed.secondary === 'purple' || detailed.secondary === 'magenta') {\n        return detailed.secondary;\n    }\n\n    return detailed.primary;\n}\n\n/**\n * Extract border pixels from an image region\n * Used for rarity detection\n */\nexport function extractBorderPixels(imageData: ImageData, borderWidth: number = 2): Uint8ClampedArray {\n    const { width, height, data } = imageData;\n    const borderPixels: number[] = [];\n\n    // Top and bottom borders\n    for (let x = 0; x < width; x++) {\n        for (let y = 0; y < borderWidth; y++) {\n            // Top border\n            const topIndex = (y * width + x) * 4;\n            borderPixels.push(data[topIndex] ?? 0, data[topIndex + 1] ?? 0, data[topIndex + 2] ?? 0);\n\n            // Bottom border\n            const bottomIndex = ((height - 1 - y) * width + x) * 4;\n            borderPixels.push(data[bottomIndex] ?? 0, data[bottomIndex + 1] ?? 0, data[bottomIndex + 2] ?? 0);\n        }\n    }\n\n    // Left and right borders\n    for (let y = borderWidth; y < height - borderWidth; y++) {\n        for (let x = 0; x < borderWidth; x++) {\n            // Left border\n            const leftIndex = (y * width + x) * 4;\n            borderPixels.push(data[leftIndex] ?? 0, data[leftIndex + 1] ?? 0, data[leftIndex + 2] ?? 0);\n\n            // Right border\n            const rightIndex = (y * width + (width - 1 - x)) * 4;\n            borderPixels.push(data[rightIndex] ?? 0, data[rightIndex + 1] ?? 0, data[rightIndex + 2] ?? 0);\n        }\n    }\n\n    return new Uint8ClampedArray(borderPixels);\n}\n","// ========================================\n// CV Color Matching\n// Color comparison, similarity, and matching algorithms\n// ========================================\n\nimport {\n    rgbToHsl,\n    RARITY_BORDER_COLORS,\n    EMPTY_CELL_MEAN_THRESHOLD,\n    EMPTY_DETECTION_CONFIG,\n    calculateAverageSaturation,\n    calculateHistogramWidth,\n    calculateCenterEdgeRatio,\n    calculateEdgeDensity,\n} from './color-utils.js';\nimport { extractBorderPixels, type DetailedColorCategory } from './color-extraction.js';\n\n/**\n * Check if a color matches a specific rarity border color\n */\nexport function matchesRarityColor(r: number, g: number, b: number, rarity: string): boolean {\n    const def = RARITY_BORDER_COLORS[rarity];\n    if (!def) return false;\n\n    // Quick RGB range check first (faster)\n    if (r < def.rgb.r[0] || r > def.rgb.r[1]) return false;\n    if (g < def.rgb.g[0] || g > def.rgb.g[1]) return false;\n    if (b < def.rgb.b[0] || b > def.rgb.b[1]) return false;\n\n    // HSL check for more accuracy\n    const hsl = rgbToHsl(r, g, b);\n\n    // Handle hue wraparound for red/orange\n    let hueMatch = false;\n    if (def.h[0] <= def.h[1]) {\n        hueMatch = hsl.h >= def.h[0] && hsl.h <= def.h[1];\n    } else {\n        hueMatch = hsl.h >= def.h[0] || hsl.h <= def.h[1];\n    }\n\n    const satMatch = hsl.s >= def.s[0] && hsl.s <= def.s[1];\n    const lumMatch = hsl.l >= def.l[0] && hsl.l <= def.l[1];\n\n    return hueMatch && satMatch && lumMatch;\n}\n\n/**\n * Detect rarity at a specific pixel\n * Returns rarity string or null if no match\n */\nexport function detectRarityAtPixel(r: number, g: number, b: number): string | null {\n    for (const rarity of Object.keys(RARITY_BORDER_COLORS)) {\n        if (matchesRarityColor(r, g, b, rarity)) {\n            return rarity;\n        }\n    }\n    return null;\n}\n\n/**\n * Calculate color category match score between two detailed categories\n * Returns score from 0 (no match) to 1 (perfect match)\n */\nexport function matchColorCategories(category1: DetailedColorCategory, category2: DetailedColorCategory): number {\n    let score = 0;\n\n    // Primary color match (most important)\n    if (category1.primary === category2.primary) {\n        score += 0.5;\n        // Bonus for secondary match\n        if (category1.secondary === category2.secondary) {\n            score += 0.25;\n        }\n    }\n\n    // Saturation match\n    if (category1.saturation === category2.saturation) {\n        score += 0.15;\n    } else if (\n        (category1.saturation === 'low' && category2.saturation === 'medium') ||\n        (category1.saturation === 'medium' && category2.saturation === 'low') ||\n        (category1.saturation === 'medium' && category2.saturation === 'high') ||\n        (category1.saturation === 'high' && category2.saturation === 'medium')\n    ) {\n        score += 0.08; // Adjacent saturation levels\n    }\n\n    // Brightness match\n    if (category1.brightness === category2.brightness) {\n        score += 0.1;\n    }\n\n    return score;\n}\n\n/**\n * Check if cell color matches inventory background\n * Inventory backgrounds are typically dark, low-saturation colors.\n */\nexport function isInventoryBackground(imageData: ImageData): boolean {\n    const pixels = imageData.data;\n    let darkLowSatPixels = 0;\n    let count = 0;\n\n    const width = imageData.width;\n    const height = imageData.height;\n    const margin = Math.floor(Math.min(width, height) * 0.2);\n\n    for (let y = margin; y < height - margin; y += 2) {\n        for (let x = margin; x < width - margin; x += 2) {\n            const idx = (y * width + x) * 4;\n            const r = pixels[idx] ?? 0;\n            const g = pixels[idx + 1] ?? 0;\n            const b = pixels[idx + 2] ?? 0;\n\n            // Check if pixel is dark and low-saturation\n            const brightness = (r + g + b) / 3;\n            const maxChannel = Math.max(r, g, b);\n            const minChannel = Math.min(r, g, b);\n            const saturation = maxChannel - minChannel;\n\n            // Dark (< 80 brightness) and low saturation (< 40 spread)\n            if (brightness < 80 && saturation < 40) {\n                darkLowSatPixels++;\n            }\n            count++;\n        }\n    }\n\n    // If >60% of center pixels are dark & low-saturation, likely empty background\n    return count > 0 && darkLowSatPixels / count > 0.6;\n}\n\n/**\n * Check if a cell is likely empty (mostly uniform background)\n * Uses multiple signals: variance, edge density, background color, saturation, histogram\n *\n * Strategy: Be generous with empty detection (use higher variance threshold),\n * but use edge density to rescue cells that have low variance but contain items.\n *\n * New methods (#2, #3, #7) provide additional detection for textured backgrounds\n * like grey brick that fool the basic variance check.\n */\nexport function isEmptyCell(imageData: ImageData): boolean {\n    const pixels = imageData.data;\n    const methods = EMPTY_DETECTION_CONFIG.methods;\n\n    let sumR = 0;\n    let sumG = 0;\n    let sumB = 0;\n    let sumSquareR = 0;\n    let sumSquareG = 0;\n    let sumSquareB = 0;\n    let count = 0;\n\n    // Sample every 4th pixel for performance\n    for (let i = 0; i < pixels.length; i += 16) {\n        const r = pixels[i] ?? 0;\n        const g = pixels[i + 1] ?? 0;\n        const b = pixels[i + 2] ?? 0;\n\n        sumR += r;\n        sumG += g;\n        sumB += b;\n        sumSquareR += r * r;\n        sumSquareG += g * g;\n        sumSquareB += b * b;\n        count++;\n    }\n\n    if (count === 0) return true;\n\n    // Calculate variance for each channel\n    const meanR = sumR / count;\n    const meanG = sumG / count;\n    const meanB = sumB / count;\n\n    const varianceR = sumSquareR / count - meanR * meanR;\n    const varianceG = sumSquareG / count - meanG * meanG;\n    const varianceB = sumSquareB / count - meanB * meanB;\n\n    const totalVariance = varianceR + varianceG + varianceB;\n    const meanGray = (meanR + meanG + meanB) / 3;\n\n    // Check 1: Very dark cells are empty (meanGray < 40)\n    if (meanGray < EMPTY_CELL_MEAN_THRESHOLD) {\n        return true;\n    }\n\n    // ----------------------------------------\n    // Method #2: Saturation check (good for grey/brick backgrounds)\n    // Low saturation + moderate variance = likely empty textured background\n    // ----------------------------------------\n    if (methods.useSaturation) {\n        const saturation = calculateAverageSaturation(imageData);\n        // Low saturation (< 15%) combined with moderate variance = empty\n        // This catches grey brick that has variance ~400-600 but no color\n        if (saturation < EMPTY_DETECTION_CONFIG.MAX_SATURATION && totalVariance < 800) {\n            return true;\n        }\n    }\n\n    // ----------------------------------------\n    // Method #3: Histogram width check (experimental)\n    // Few distinct colors = likely empty background\n    // ----------------------------------------\n    if (methods.useHistogram) {\n        const histWidth = calculateHistogramWidth(imageData);\n        if (histWidth < EMPTY_DETECTION_CONFIG.MIN_HISTOGRAM_BINS) {\n            return true;\n        }\n    }\n\n    // ----------------------------------------\n    // Method #7: Center/edge ratio check (experimental)\n    // Uniform variance across cell = likely empty (no centered icon)\n    // ----------------------------------------\n    if (methods.useCenterEdge) {\n        const ratio = calculateCenterEdgeRatio(imageData);\n        if (ratio < EMPTY_DETECTION_CONFIG.MIN_CENTER_EDGE_RATIO) {\n            return true;\n        }\n    }\n\n    // ----------------------------------------\n    // Original variance-based checks\n    // ----------------------------------------\n    if (methods.useVariance) {\n        // Check 2: Low variance = likely empty\n        // Use higher threshold (500) to catch empty cells\n        if (totalVariance < 500) {\n            // If variance is VERY low (< 150), definitely empty - no further checks\n            if (totalVariance < 150) {\n                return true;\n            }\n\n            // For moderate variance (150-500), check if it has significant edges\n            // Items have edges (icon outlines), empty backgrounds don't\n            const edgeDensity = calculateEdgeDensity(imageData);\n\n            // Low edges (< 5%) = empty background\n            if (edgeDensity < 0.05) {\n                return true;\n            }\n\n            // Has some edges but matches inventory background = still empty\n            if (edgeDensity < 0.12 && isInventoryBackground(imageData)) {\n                return true;\n            }\n        }\n\n        // Check 3: Matches inventory background color (even with higher variance)\n        // Some empty cells have texture/noise but are clearly background\n        if (totalVariance < 800 && isInventoryBackground(imageData)) {\n            const edgeDensity = calculateEdgeDensity(imageData);\n            if (edgeDensity < 0.08) {\n                return true;\n            }\n        }\n    }\n\n    return false;\n}\n\n/**\n * Detect rarity from border color using HSL-based matching\n * Returns rarity string or null if no clear match\n */\nexport function detectBorderRarity(imageData: ImageData): string | null {\n    const borderPixels = extractBorderPixels(imageData, 3);\n\n    // Count votes for each rarity based on individual pixel matching\n    const rarityVotes: Record<string, number> = {\n        common: 0,\n        uncommon: 0,\n        rare: 0,\n        epic: 0,\n        legendary: 0,\n    };\n\n    let totalPixels = 0;\n\n    for (let i = 0; i < borderPixels.length; i += 3) {\n        const r = borderPixels[i] ?? 0;\n        const g = borderPixels[i + 1] ?? 0;\n        const b = borderPixels[i + 2] ?? 0;\n\n        const rarity = detectRarityAtPixel(r, g, b);\n        if (rarity) {\n            rarityVotes[rarity] = (rarityVotes[rarity] ?? 0) + 1;\n        }\n        totalPixels++;\n    }\n\n    // Find rarity with most votes\n    let bestMatch: string | null = null;\n    let bestVotes = 0;\n\n    for (const [rarity, votes] of Object.entries(rarityVotes)) {\n        if (votes > bestVotes) {\n            bestVotes = votes;\n            bestMatch = rarity;\n        }\n    }\n\n    // Require at least 10% of border pixels to match\n    const minVoteRatio = 0.1;\n    if (bestVotes < totalPixels * minVoteRatio) {\n        return null;\n    }\n\n    return bestMatch;\n}\n\n/**\n * Count rarity border pixels in a horizontal scan line\n * Used for hotbar detection\n */\nexport function countRarityBorderPixels(imageData: ImageData): {\n    total: number;\n    rarityCount: number;\n    colorfulCount: number;\n    rarityCounts: Record<string, number>;\n} {\n    const pixels = imageData.data;\n    let rarityCount = 0;\n    let colorfulCount = 0;\n    const rarityCounts: Record<string, number> = {};\n\n    for (let i = 0; i < pixels.length; i += 4) {\n        const r = pixels[i] ?? 0;\n        const g = pixels[i + 1] ?? 0;\n        const b = pixels[i + 2] ?? 0;\n\n        // Check if colorful (potential border)\n        const saturation = Math.max(r, g, b) - Math.min(r, g, b);\n        if (saturation > 40) colorfulCount++;\n\n        // Check specific rarity\n        const rarity = detectRarityAtPixel(r, g, b);\n        if (rarity) {\n            rarityCount++;\n            rarityCounts[rarity] = (rarityCounts[rarity] || 0) + 1;\n        }\n    }\n\n    return {\n        total: pixels.length / 4,\n        rarityCount,\n        colorfulCount,\n        rarityCounts,\n    };\n}\n","// ========================================\n// CV Template Loading\n// ========================================\n\nimport type { Item } from '../../types/index.ts';\nimport { logger } from '../logger.ts';\nimport {\n    getAllData,\n    getItemTemplates,\n    getTemplatesByColor,\n    getDetectionCache,\n    isTemplatesLoaded,\n    setTemplatesLoaded,\n    setPriorityTemplatesLoaded,\n    isStandardTemplatesLoading,\n    setStandardTemplatesLoading,\n    setMultiScaleTemplate,\n    getMultiScaleTemplateCount,\n    COMMON_ICON_SIZES,\n} from './state.ts';\nimport { getDominantColor } from './color.ts';\n\n// ========================================\n// Multi-Scale Template Generation\n// ========================================\n\n/**\n * Generate multi-scale variants of a template for faster matching\n * Pre-computes resized versions at common icon sizes\n */\nfunction generateMultiScaleVariants(itemId: string, canvas: HTMLCanvasElement, ctx: CanvasRenderingContext2D): void {\n    const width = canvas.width;\n    const height = canvas.height;\n\n    // Generate variants at common sizes (skip if already that size)\n    for (const targetSize of COMMON_ICON_SIZES) {\n        if (targetSize === width && targetSize === height) {\n            // Store original as-is\n            const imageData = ctx.getImageData(0, 0, width, height);\n            setMultiScaleTemplate(itemId, targetSize, imageData);\n            continue;\n        }\n\n        // Create resized canvas\n        const resizedCanvas = document.createElement('canvas');\n        resizedCanvas.width = targetSize;\n        resizedCanvas.height = targetSize;\n        const resizedCtx = resizedCanvas.getContext('2d', { willReadFrequently: true });\n\n        if (!resizedCtx) continue;\n\n        // Use high-quality scaling\n        resizedCtx.imageSmoothingEnabled = true;\n        resizedCtx.imageSmoothingQuality = 'high';\n        resizedCtx.drawImage(canvas, 0, 0, width, height, 0, 0, targetSize, targetSize);\n\n        const imageData = resizedCtx.getImageData(0, 0, targetSize, targetSize);\n        setMultiScaleTemplate(itemId, targetSize, imageData);\n    }\n}\n\n// ========================================\n// Template Prioritization\n// ========================================\n\n/**\n * Categorize items by priority (common items first)\n */\nexport function prioritizeItems(items: Item[]): { priority: Item[]; standard: Item[] } {\n    const priority: Item[] = [];\n    const standard: Item[] = [];\n\n    // High-priority items (common, frequently seen)\n    const priorityRarities = ['common', 'uncommon'];\n\n    items.forEach(item => {\n        if (priorityRarities.includes(item.rarity)) {\n            priority.push(item);\n        } else {\n            standard.push(item);\n        }\n    });\n\n    return { priority, standard };\n}\n\n// ========================================\n// Template Loading\n// ========================================\n\n/**\n * Load item templates progressively (priority items first)\n */\nexport async function loadTemplatesBatch(\n    items: Item[]\n): Promise<{ loaded: number; failed: number; failedIds: string[] }> {\n    let loaded = 0;\n    const failedIds: string[] = [];\n    const itemTemplates = getItemTemplates();\n\n    const loadPromises = items.map(async item => {\n        try {\n            // Skip items without images\n            if (!item.image) return;\n            // Try WebP first (smaller), fallback to PNG\n            // Only replace .png extension at the end of the path\n            const imagePath = item.image.endsWith('.png')\n                ? item.image.slice(0, -4) + '.webp'\n                : item.image.replace(/\\.png$/, '.webp');\n            const img = new Image();\n\n            await new Promise<void>((resolve, reject) => {\n                img.onload = () => {\n                    const canvas = document.createElement('canvas');\n                    canvas.width = img.width;\n                    canvas.height = img.height;\n                    const ctx = canvas.getContext('2d', { willReadFrequently: true });\n\n                    if (!ctx) {\n                        reject(new Error('Failed to get canvas context'));\n                        return;\n                    }\n\n                    ctx.drawImage(img, 0, 0);\n\n                    itemTemplates.set(item.id, {\n                        image: img,\n                        canvas,\n                        ctx,\n                        width: img.width,\n                        height: img.height,\n                    });\n\n                    // Generate multi-scale variants for faster matching\n                    generateMultiScaleVariants(item.id, canvas, ctx);\n\n                    loaded++;\n                    resolve();\n                };\n\n                img.onerror = () => {\n                    // Try PNG fallback\n                    const pngImg = new Image();\n                    pngImg.onload = () => {\n                        const canvas = document.createElement('canvas');\n                        canvas.width = pngImg.width;\n                        canvas.height = pngImg.height;\n                        const ctx = canvas.getContext('2d', { willReadFrequently: true });\n\n                        if (!ctx) {\n                            reject(new Error('Failed to get canvas context'));\n                            return;\n                        }\n\n                        ctx.drawImage(pngImg, 0, 0);\n\n                        itemTemplates.set(item.id, {\n                            image: pngImg,\n                            canvas,\n                            ctx,\n                            width: pngImg.width,\n                            height: pngImg.height,\n                        });\n\n                        // Generate multi-scale variants for faster matching\n                        generateMultiScaleVariants(item.id, canvas, ctx);\n\n                        loaded++;\n                        resolve();\n                    };\n                    pngImg.onerror = () => reject(new Error(`Failed to load: ${item.image}`));\n                    pngImg.src = item.image!;\n                };\n\n                img.src = imagePath;\n            });\n        } catch (error) {\n            failedIds.push(item.id);\n            logger.error({\n                operation: 'cv.load_template',\n                error: {\n                    name: (error as Error).name,\n                    message: (error as Error).message,\n                },\n                data: { itemId: item.id, itemName: item.name },\n            });\n        }\n    });\n\n    await Promise.all(loadPromises);\n\n    // Log summary if there were failures\n    if (failedIds.length > 0) {\n        logger.warn({\n            operation: 'cv.load_template_batch',\n            data: {\n                totalAttempted: items.length,\n                loaded,\n                failed: failedIds.length,\n                failedIds: failedIds.slice(0, 10), // Limit to first 10 for brevity\n            },\n        });\n    }\n\n    return { loaded, failed: failedIds.length, failedIds };\n}\n\n/**\n * Group loaded templates by dominant color\n */\nexport function groupTemplatesByColor(items: Item[]): void {\n    const itemTemplates = getItemTemplates();\n    const templatesByColor = getTemplatesByColor();\n\n    items.forEach(item => {\n        const template = itemTemplates.get(item.id);\n        if (!template) return;\n\n        const imageData = template.ctx.getImageData(0, 0, template.width, template.height);\n        const colorCategory = getDominantColor(imageData);\n\n        if (!templatesByColor.has(colorCategory)) {\n            templatesByColor.set(colorCategory, []);\n        }\n        templatesByColor.get(colorCategory)!.push(item);\n    });\n}\n\n/**\n * Load all item template images into memory (with progressive loading)\n */\nexport async function loadItemTemplates(): Promise<void> {\n    if (isTemplatesLoaded()) return;\n\n    const itemTemplates = getItemTemplates();\n    const templatesByColor = getTemplatesByColor();\n\n    // Clear old templates before loading new ones to prevent memory leaks\n    // This handles cases where loadItemTemplates is called after a data refresh\n    if (itemTemplates.size > 0) {\n        itemTemplates.clear();\n        templatesByColor.clear();\n        setPriorityTemplatesLoaded(false);\n        logger.info({\n            operation: 'cv.load_templates',\n            data: { phase: 'clearing_old_templates' },\n        });\n    }\n\n    const items = getAllData().items?.items || [];\n\n    logger.info({\n        operation: 'cv.load_templates',\n        data: { phase: 'start', totalItems: items.length },\n    });\n\n    // Prioritize items (common/uncommon first)\n    const { priority, standard } = prioritizeItems(items);\n\n    // Load priority items first\n    const priorityResult = await loadTemplatesBatch(priority);\n    groupTemplatesByColor(priority);\n    setPriorityTemplatesLoaded(true);\n\n    logger.info({\n        operation: 'cv.load_templates',\n        data: {\n            phase: 'priority_complete',\n            priorityLoaded: priorityResult.loaded,\n            priorityFailed: priorityResult.failed,\n            priorityTotal: priority.length,\n        },\n    });\n\n    // Load remaining items in background (non-blocking)\n    // Use setTimeout(0) to yield to the event loop without arbitrary delay\n    // Guard against concurrent loads with isStandardTemplatesLoading flag\n    if (isStandardTemplatesLoading()) {\n        logger.info({\n            operation: 'cv.load_templates',\n            data: { phase: 'skipped_standard', reason: 'already_loading' },\n        });\n        return;\n    }\n    setStandardTemplatesLoading(true);\n\n    setTimeout(async () => {\n        try {\n            const standardResult = await loadTemplatesBatch(standard);\n            groupTemplatesByColor(standard);\n            setTemplatesLoaded(true);\n            setStandardTemplatesLoading(false);\n\n            logger.info({\n                operation: 'cv.load_templates',\n                data: {\n                    phase: 'complete',\n                    priorityLoaded: priorityResult.loaded,\n                    priorityFailed: priorityResult.failed,\n                    standardLoaded: standardResult.loaded,\n                    standardFailed: standardResult.failed,\n                    total: items.length,\n                    multiScaleVariants: getMultiScaleTemplateCount(),\n                    colorGroups: Object.fromEntries(\n                        Array.from(templatesByColor.entries()).map(([color, items]) => [color, items.length])\n                    ),\n                },\n            });\n        } catch (error) {\n            logger.error({\n                operation: 'cv.load_templates',\n                data: {\n                    phase: 'error',\n                    error: error instanceof Error ? error.message : String(error),\n                },\n            });\n            // Still mark as loaded to prevent infinite retries\n            setTemplatesLoaded(true);\n            setStandardTemplatesLoading(false);\n        }\n    }, 0);\n}\n\n// ========================================\n// Cache Management\n// ========================================\n\n/**\n * Clear detection cache\n */\nexport function clearDetectionCache(): void {\n    getDetectionCache().clear();\n    logger.info({\n        operation: 'cv.cache_cleared',\n        data: { cleared: true },\n    });\n}\n","// ========================================\n// Scoring Configuration Module\n// ========================================\n// Optimized metric weights and confidence thresholds\n// Based on ablation testing results\n\n/**\n * Metric weight configuration\n */\nexport interface MetricWeights {\n    /** Normalized Cross-Correlation weight */\n    ncc: number;\n    /** Structural Similarity Index weight */\n    ssim: number;\n    /** Color histogram similarity weight */\n    histogram: number;\n    /** Edge-based similarity weight */\n    edge: number;\n}\n\n/**\n * Agreement bonus configuration\n */\nexport interface AgreementConfig {\n    /** Enable agreement bonus */\n    enabled: boolean;\n    /** Threshold for counting a metric as \"agreeing\" */\n    threshold: number;\n    /** Minimum metrics above threshold for bonus */\n    minMetricsForBonus: number;\n    /** Bonus per agreeing metric (cumulative) */\n    bonusPerMetric: number;\n    /** Maximum total bonus */\n    maxBonus: number;\n}\n\n/**\n * Rarity-specific confidence thresholds\n */\nexport interface RarityThresholds {\n    common: number;\n    uncommon: number;\n    rare: number;\n    epic: number;\n    legendary: number;\n    unknown: number;\n}\n\n/**\n * Complete scoring configuration\n */\nexport interface ScoringConfig {\n    /** Metric weights (should sum to ~1.0) */\n    weights: MetricWeights;\n    /** Agreement bonus settings */\n    agreement: AgreementConfig;\n    /** Base confidence threshold */\n    baseThreshold: number;\n    /** Per-rarity threshold adjustments */\n    rarityThresholds: RarityThresholds;\n    /** Minimum confidence to report detection */\n    minConfidence: number;\n    /** Maximum confidence (cap) */\n    maxConfidence: number;\n}\n\n/**\n * Default scoring configuration\n * Based on ablation results showing:\n * - SSIM is most reliable (weight 0.35)\n * - NCC is fast and decent (weight 0.25)\n * - Histogram helps with color matching (weight 0.25)\n * - Edge is slower but robust (weight 0.15)\n */\nexport const DEFAULT_SCORING_CONFIG: ScoringConfig = {\n    weights: {\n        ssim: 0.35,\n        ncc: 0.25,\n        histogram: 0.25,\n        edge: 0.15,\n    },\n    agreement: {\n        enabled: true,\n        threshold: 0.55,\n        minMetricsForBonus: 2,\n        bonusPerMetric: 0.02,\n        maxBonus: 0.06,\n    },\n    baseThreshold: 0.45,\n    rarityThresholds: {\n        common: -0.03, // Lower threshold (common items are easy to identify)\n        uncommon: -0.02, // Slightly lower\n        rare: 0.0, // No adjustment\n        epic: 0.02, // Slightly higher (rarer = need more confidence)\n        legendary: 0.05, // Higher threshold (rarest items need highest confidence)\n        unknown: 0.05, // Higher threshold when uncertain\n    },\n    minConfidence: 0.35,\n    maxConfidence: 0.99,\n};\n\n/**\n * Optimized scoring configuration\n * Tuned for higher precision (fewer false positives)\n */\nexport const PRECISION_SCORING_CONFIG: ScoringConfig = {\n    weights: {\n        ssim: 0.4,\n        ncc: 0.2,\n        histogram: 0.25,\n        edge: 0.15,\n    },\n    agreement: {\n        enabled: true,\n        threshold: 0.6,\n        minMetricsForBonus: 3,\n        bonusPerMetric: 0.015,\n        maxBonus: 0.045,\n    },\n    baseThreshold: 0.55,\n    rarityThresholds: {\n        common: -0.02, // Lower threshold (common items are easy to identify)\n        uncommon: -0.01, // Slightly lower\n        rare: 0.0,\n        epic: 0.02, // Higher (rarer = need more confidence)\n        legendary: 0.04, // Highest (rarest items need highest confidence)\n        unknown: 0.08,\n    },\n    minConfidence: 0.45,\n    maxConfidence: 0.99,\n};\n\n/**\n * Recall-optimized scoring configuration\n * Tuned for higher recall (fewer missed items)\n */\nexport const RECALL_SCORING_CONFIG: ScoringConfig = {\n    weights: {\n        ssim: 0.3,\n        ncc: 0.3,\n        histogram: 0.25,\n        edge: 0.15,\n    },\n    agreement: {\n        enabled: true,\n        threshold: 0.5,\n        minMetricsForBonus: 2,\n        bonusPerMetric: 0.025,\n        maxBonus: 0.075,\n    },\n    baseThreshold: 0.38,\n    rarityThresholds: {\n        common: -0.05, // Most lenient (common items easy to identify)\n        uncommon: -0.03,\n        rare: -0.02,\n        epic: 0.0, // Neutral\n        legendary: 0.03, // Stricter (rarest items need more confidence)\n        unknown: 0.02,\n    },\n    minConfidence: 0.3,\n    maxConfidence: 0.99,\n};\n\n/**\n * Fast scoring configuration\n * Minimal metrics for speed\n */\nexport const FAST_SCORING_CONFIG: ScoringConfig = {\n    weights: {\n        ssim: 0.5,\n        ncc: 0.5,\n        histogram: 0.0, // Skip histogram\n        edge: 0.0, // Skip edge\n    },\n    agreement: {\n        enabled: false, // Disable for speed\n        threshold: 0.55,\n        minMetricsForBonus: 2,\n        bonusPerMetric: 0.0,\n        maxBonus: 0.0,\n    },\n    baseThreshold: 0.5,\n    rarityThresholds: {\n        common: 0.0,\n        uncommon: 0.0,\n        rare: 0.0,\n        epic: 0.0,\n        legendary: 0.0,\n        unknown: 0.05,\n    },\n    minConfidence: 0.4,\n    maxConfidence: 0.99,\n};\n\n// Active configuration\nlet activeConfig = DEFAULT_SCORING_CONFIG;\n\n/**\n * Set active scoring configuration\n */\nexport function setScoringConfig(config: ScoringConfig): void {\n    activeConfig = config;\n}\n\n/**\n * Get active scoring configuration\n */\nexport function getScoringConfig(): ScoringConfig {\n    return activeConfig;\n}\n\n/**\n * Get confidence threshold for a specific rarity\n */\nexport function getThresholdForRarity(rarity?: string): number {\n    const config = activeConfig;\n    const base = config.baseThreshold;\n\n    if (!rarity) {\n        // Bug fix: Apply minConfidence check consistently for unknown rarity\n        return Math.max(config.minConfidence, base + config.rarityThresholds.unknown);\n    }\n\n    const key = rarity.toLowerCase() as keyof RarityThresholds;\n    const adjustment = config.rarityThresholds[key] ?? config.rarityThresholds.unknown;\n\n    return Math.max(config.minConfidence, base + adjustment);\n}\n\n/**\n * Calculate weighted similarity score\n */\nexport function calculateWeightedScore(ncc: number, ssim: number, histogram: number, edge: number): number {\n    const config = activeConfig;\n    const w = config.weights;\n\n    // Calculate base weighted score\n    let score = ncc * w.ncc + ssim * w.ssim + histogram * w.histogram + edge * w.edge;\n\n    // Apply agreement bonus\n    if (config.agreement.enabled) {\n        const scores = [ncc, ssim, histogram, edge];\n        const weights = [w.ncc, w.ssim, w.histogram, w.edge];\n\n        // Only count metrics that are enabled (weight > 0)\n        const enabledScores = scores.filter((_, i) => (weights[i] ?? 0) > 0);\n        const aboveThreshold = enabledScores.filter(s => s >= config.agreement.threshold).length;\n\n        if (aboveThreshold >= config.agreement.minMetricsForBonus) {\n            const bonus = Math.min(\n                (aboveThreshold - config.agreement.minMetricsForBonus + 1) * config.agreement.bonusPerMetric,\n                config.agreement.maxBonus\n            );\n            score += bonus;\n        }\n    }\n\n    // Clamp to valid range\n    return Math.max(config.minConfidence, Math.min(config.maxConfidence, score));\n}\n\n/**\n * Check if score passes threshold for rarity\n */\nexport function passesThreshold(score: number, rarity?: string): boolean {\n    return score >= getThresholdForRarity(rarity);\n}\n\n/**\n * Get grade for a confidence score (for UI display)\n */\nexport function getConfidenceGrade(score: number): {\n    grade: 'A' | 'B' | 'C' | 'D' | 'F';\n    label: string;\n    color: string;\n} {\n    if (score >= 0.85) {\n        return { grade: 'A', label: 'Excellent', color: '#4CAF50' };\n    } else if (score >= 0.7) {\n        return { grade: 'B', label: 'Good', color: '#8BC34A' };\n    } else if (score >= 0.55) {\n        return { grade: 'C', label: 'Fair', color: '#FFC107' };\n    } else if (score >= 0.4) {\n        return { grade: 'D', label: 'Poor', color: '#FF9800' };\n    } else {\n        return { grade: 'F', label: 'Fail', color: '#F44336' };\n    }\n}\n\n/**\n * Describe scoring configuration for debugging\n */\nexport function describeScoringConfig(): string {\n    const config = activeConfig;\n    const w = config.weights;\n\n    return (\n        `Weights: SSIM=${w.ssim}, NCC=${w.ncc}, Hist=${w.histogram}, Edge=${w.edge}\\n` +\n        `Agreement: ${config.agreement.enabled ? 'ON' : 'OFF'} (threshold=${config.agreement.threshold})\\n` +\n        `Base threshold: ${config.baseThreshold}\\n` +\n        `Rarity adjustments: Common=${config.rarityThresholds.common}, Legendary=${config.rarityThresholds.legendary}`\n    );\n}\n\n/**\n * Merge partial config with defaults\n */\nexport function mergeWithDefaults(partial: Partial<ScoringConfig>): ScoringConfig {\n    return {\n        weights: { ...DEFAULT_SCORING_CONFIG.weights, ...partial.weights },\n        agreement: { ...DEFAULT_SCORING_CONFIG.agreement, ...partial.agreement },\n        baseThreshold: partial.baseThreshold ?? DEFAULT_SCORING_CONFIG.baseThreshold,\n        rarityThresholds: { ...DEFAULT_SCORING_CONFIG.rarityThresholds, ...partial.rarityThresholds },\n        minConfidence: partial.minConfidence ?? DEFAULT_SCORING_CONFIG.minConfidence,\n        maxConfidence: partial.maxConfidence ?? DEFAULT_SCORING_CONFIG.maxConfidence,\n    };\n}\n","// ========================================\n// Resolution-Adaptive Strategy Profiles\n// ========================================\n// Detection parameters optimized for different screen resolutions\n// Handles scaling of UI elements, icon sizes, and detection thresholds\n\n/**\n * Resolution tier based on vertical pixels\n */\nexport type ResolutionTier = 'low' | 'medium' | 'high' | 'ultra';\n\n/**\n * Common resolution presets with their display names\n */\nexport interface ResolutionInfo {\n    width: number;\n    height: number;\n    name: string;\n    tier: ResolutionTier;\n    aspectRatio: string;\n}\n\n/**\n * Detection strategy profile for a resolution tier\n */\nexport interface StrategyProfile {\n    /** Resolution tier this profile is for */\n    tier: ResolutionTier;\n    /** Display name */\n    name: string;\n\n    // Grid Detection\n    /** Expected icon size in pixels */\n    iconSize: { min: number; max: number; typical: number };\n    /** Expected icon spacing in pixels */\n    spacing: { min: number; max: number; typical: number };\n    /** Maximum number of hotbar rows to detect */\n    maxHotbarRows: number;\n    /** Icons per row (typical) */\n    iconsPerRow: { min: number; max: number; typical: number };\n\n    // Template Matching\n    /** Template scale factors to try */\n    templateScales: number[];\n    /** Minimum confidence threshold */\n    minConfidence: number;\n    /** NMS IoU threshold */\n    nmsThreshold: number;\n\n    // Cell Extraction\n    /** Cell margin as percentage of icon size */\n    cellMarginPercent: number;\n    /** Border margin for rarity detection */\n    borderMarginPercent: number;\n\n    // Count Detection\n    /** Expected count text height in pixels */\n    countTextHeight: { min: number; max: number };\n    /** Count text position relative to cell */\n    countTextPosition: 'bottom-right' | 'bottom-center' | 'top-right';\n\n    // Performance\n    /** Skip every N pixels during scanning for speed */\n    scanStep: number;\n    /** Maximum cells to process in parallel */\n    batchSize: number;\n}\n\n/**\n * Common resolution presets\n */\nexport const RESOLUTION_PRESETS: ResolutionInfo[] = [\n    { width: 1280, height: 720, name: '720p', tier: 'low', aspectRatio: '16:9' },\n    { width: 1366, height: 768, name: '768p', tier: 'low', aspectRatio: '16:9' },\n    { width: 1600, height: 900, name: '900p', tier: 'medium', aspectRatio: '16:9' },\n    { width: 1920, height: 1080, name: '1080p', tier: 'medium', aspectRatio: '16:9' },\n    { width: 2560, height: 1440, name: '1440p', tier: 'high', aspectRatio: '16:9' },\n    { width: 3840, height: 2160, name: '4K', tier: 'ultra', aspectRatio: '16:9' },\n    // Ultrawide\n    { width: 2560, height: 1080, name: '1080p UW', tier: 'medium', aspectRatio: '21:9' },\n    { width: 3440, height: 1440, name: '1440p UW', tier: 'high', aspectRatio: '21:9' },\n    // Mobile/Tablet\n    { width: 1920, height: 1200, name: 'WUXGA', tier: 'medium', aspectRatio: '16:10' },\n    { width: 2560, height: 1600, name: 'WQXGA', tier: 'high', aspectRatio: '16:10' },\n];\n\n/**\n * Strategy profile for low resolution (720p, 768p)\n * Icons are smaller, need more sensitive detection\n */\nexport const LOW_RES_PROFILE: StrategyProfile = {\n    tier: 'low',\n    name: 'Low Resolution (720p)',\n    iconSize: { min: 28, max: 48, typical: 36 },\n    spacing: { min: 2, max: 8, typical: 4 },\n    maxHotbarRows: 2,\n    iconsPerRow: { min: 6, max: 12, typical: 10 },\n    templateScales: [0.75, 0.85, 1.0],\n    minConfidence: 0.4,\n    nmsThreshold: 0.35,\n    cellMarginPercent: 8,\n    borderMarginPercent: 6,\n    countTextHeight: { min: 8, max: 14 },\n    countTextPosition: 'bottom-right',\n    scanStep: 1,\n    batchSize: 20,\n};\n\n/**\n * Strategy profile for medium resolution (900p, 1080p)\n * Standard detection parameters\n */\nexport const MEDIUM_RES_PROFILE: StrategyProfile = {\n    tier: 'medium',\n    name: 'Medium Resolution (1080p)',\n    iconSize: { min: 36, max: 64, typical: 48 },\n    spacing: { min: 3, max: 10, typical: 5 },\n    maxHotbarRows: 2,\n    iconsPerRow: { min: 6, max: 12, typical: 10 },\n    templateScales: [0.9, 1.0, 1.1],\n    minConfidence: 0.45,\n    nmsThreshold: 0.4,\n    cellMarginPercent: 6,\n    borderMarginPercent: 5,\n    countTextHeight: { min: 10, max: 18 },\n    countTextPosition: 'bottom-right',\n    scanStep: 2,\n    batchSize: 30,\n};\n\n/**\n * Strategy profile for high resolution (1440p)\n * Larger icons, can use faster scanning\n */\nexport const HIGH_RES_PROFILE: StrategyProfile = {\n    tier: 'high',\n    name: 'High Resolution (1440p)',\n    iconSize: { min: 48, max: 80, typical: 64 },\n    spacing: { min: 4, max: 12, typical: 7 },\n    maxHotbarRows: 2,\n    iconsPerRow: { min: 6, max: 12, typical: 10 },\n    templateScales: [1.0, 1.15, 1.3],\n    minConfidence: 0.45,\n    nmsThreshold: 0.4,\n    cellMarginPercent: 5,\n    borderMarginPercent: 4,\n    countTextHeight: { min: 14, max: 24 },\n    countTextPosition: 'bottom-right',\n    scanStep: 2,\n    batchSize: 40,\n};\n\n/**\n * Strategy profile for ultra resolution (4K)\n * Very large icons, aggressive performance optimization\n */\nexport const ULTRA_RES_PROFILE: StrategyProfile = {\n    tier: 'ultra',\n    name: 'Ultra Resolution (4K)',\n    iconSize: { min: 72, max: 128, typical: 96 },\n    spacing: { min: 6, max: 16, typical: 10 },\n    maxHotbarRows: 2,\n    iconsPerRow: { min: 6, max: 12, typical: 10 },\n    templateScales: [1.2, 1.5, 1.8],\n    minConfidence: 0.45,\n    nmsThreshold: 0.4,\n    cellMarginPercent: 4,\n    borderMarginPercent: 3,\n    countTextHeight: { min: 20, max: 36 },\n    countTextPosition: 'bottom-right',\n    scanStep: 4,\n    batchSize: 50,\n};\n\n/**\n * All profiles indexed by tier\n */\nexport const STRATEGY_PROFILES: Record<ResolutionTier, StrategyProfile> = {\n    low: LOW_RES_PROFILE,\n    medium: MEDIUM_RES_PROFILE,\n    high: HIGH_RES_PROFILE,\n    ultra: ULTRA_RES_PROFILE,\n};\n\n/**\n * Get resolution tier from image dimensions\n */\nexport function getResolutionTier(_width: number, height: number): ResolutionTier {\n    if (height <= 800) return 'low';\n    if (height <= 1200) return 'medium';\n    if (height <= 1800) return 'high';\n    return 'ultra';\n}\n\n/**\n * Get strategy profile for image dimensions\n */\nexport function getProfileForResolution(width: number, height: number): StrategyProfile {\n    const tier = getResolutionTier(width, height);\n    return STRATEGY_PROFILES[tier];\n}\n\n/**\n * Get the closest resolution preset for given dimensions\n */\nexport function getClosestPreset(width: number, height: number): ResolutionInfo | null {\n    let closest: ResolutionInfo | null = null;\n    let minDiff = Infinity;\n\n    for (const preset of RESOLUTION_PRESETS) {\n        const diff = Math.abs(preset.width - width) + Math.abs(preset.height - height);\n        if (diff < minDiff) {\n            minDiff = diff;\n            closest = preset;\n        }\n    }\n\n    return closest;\n}\n\n/**\n * Calculate scale factor from base resolution (720p)\n */\nexport function getScaleFromBase(height: number, baseHeight: number = 720): number {\n    return height / baseHeight;\n}\n\n/**\n * Scale a value from base resolution to target resolution\n */\nexport function scaleValue(value: number, height: number, baseHeight: number = 720): number {\n    return Math.round(value * getScaleFromBase(height, baseHeight));\n}\n\n/**\n * Get expected icon size for a resolution\n */\nexport function getExpectedIconSize(height: number): { min: number; max: number; typical: number } {\n    const profile = getProfileForResolution(0, height);\n    return profile.iconSize;\n}\n\n/**\n * Get expected cell stride (icon + spacing) for a resolution\n */\nexport function getExpectedCellStride(height: number): number {\n    const profile = getProfileForResolution(0, height);\n    return profile.iconSize.typical + profile.spacing.typical;\n}\n\n/**\n * Interpolate profile values for intermediate resolutions\n * Creates a smooth transition between resolution tiers\n */\nexport function interpolateProfile(width: number, height: number): StrategyProfile {\n    const tier = getResolutionTier(width, height);\n    const baseProfile = STRATEGY_PROFILES[tier];\n\n    // For resolutions at tier boundaries, interpolate\n    let nextTier: ResolutionTier | null = null;\n    let blendFactor = 0;\n\n    if (tier === 'low' && height > 700) {\n        nextTier = 'medium';\n        blendFactor = (height - 700) / 100; // Blend from 700 to 800\n    } else if (tier === 'medium' && height > 1100) {\n        nextTier = 'high';\n        blendFactor = (height - 1100) / 100;\n    } else if (tier === 'high' && height > 1700) {\n        nextTier = 'ultra';\n        blendFactor = (height - 1700) / 100;\n    }\n\n    if (!nextTier || blendFactor <= 0) {\n        return baseProfile;\n    }\n\n    blendFactor = Math.min(1, blendFactor);\n    const nextProfile = STRATEGY_PROFILES[nextTier];\n\n    // Interpolate numeric values\n    const lerp = (a: number, b: number) => Math.round(a + (b - a) * blendFactor);\n\n    return {\n        ...baseProfile,\n        tier: blendFactor > 0.5 ? nextTier : tier,\n        iconSize: {\n            min: lerp(baseProfile.iconSize.min, nextProfile.iconSize.min),\n            max: lerp(baseProfile.iconSize.max, nextProfile.iconSize.max),\n            typical: lerp(baseProfile.iconSize.typical, nextProfile.iconSize.typical),\n        },\n        spacing: {\n            min: lerp(baseProfile.spacing.min, nextProfile.spacing.min),\n            max: lerp(baseProfile.spacing.max, nextProfile.spacing.max),\n            typical: lerp(baseProfile.spacing.typical, nextProfile.spacing.typical),\n        },\n        countTextHeight: {\n            min: lerp(baseProfile.countTextHeight.min, nextProfile.countTextHeight.min),\n            max: lerp(baseProfile.countTextHeight.max, nextProfile.countTextHeight.max),\n        },\n        cellMarginPercent:\n            baseProfile.cellMarginPercent +\n            (nextProfile.cellMarginPercent - baseProfile.cellMarginPercent) * blendFactor,\n        borderMarginPercent:\n            baseProfile.borderMarginPercent +\n            (nextProfile.borderMarginPercent - baseProfile.borderMarginPercent) * blendFactor,\n        minConfidence:\n            baseProfile.minConfidence + (nextProfile.minConfidence - baseProfile.minConfidence) * blendFactor,\n        scanStep: blendFactor > 0.5 ? nextProfile.scanStep : baseProfile.scanStep,\n    };\n}\n\n/**\n * Get template scales optimized for this resolution\n */\nexport function getTemplateScales(height: number): number[] {\n    const profile = getProfileForResolution(0, height);\n    return profile.templateScales;\n}\n\n/**\n * Describe the resolution and profile for debugging\n */\nexport function describeResolution(width: number, height: number): string {\n    const preset = getClosestPreset(width, height);\n    const profile = getProfileForResolution(width, height);\n    const scale = getScaleFromBase(height);\n\n    return `Resolution: ${width}x${height} (${preset?.name ?? 'custom'})\nTier: ${profile.tier}\nScale from 720p: ${scale.toFixed(2)}x\nExpected icon size: ${profile.iconSize.typical}px (${profile.iconSize.min}-${profile.iconSize.max})\nExpected spacing: ${profile.spacing.typical}px\nCount text height: ${profile.countTextHeight.min}-${profile.countTextHeight.max}px\nTemplate scales: ${profile.templateScales.join(', ')}`;\n}\n\n/**\n * Validate that detected icon size is reasonable for resolution\n */\nexport function validateIconSize(detectedSize: number, height: number): boolean {\n    const profile = getProfileForResolution(0, height);\n    return detectedSize >= profile.iconSize.min * 0.8 && detectedSize <= profile.iconSize.max * 1.2;\n}\n\n/**\n * Get recommended scan region for hotbar detection\n */\nexport function getHotbarScanRegion(\n    width: number,\n    height: number\n): {\n    xStart: number;\n    xEnd: number;\n    yStart: number;\n    yEnd: number;\n} {\n    const profile = getProfileForResolution(width, height);\n    const maxRowsHeight = profile.maxHotbarRows * (profile.iconSize.max + profile.spacing.max);\n\n    // Hotbar is typically in bottom 15-25% of screen\n    const bottomMargin = Math.round(height * 0.02); // 2% from bottom\n    const topOfRegion = height - maxRowsHeight - bottomMargin;\n\n    // Center 70% of width (avoid UI elements at edges)\n    const sideMargin = Math.round(width * 0.15);\n\n    return {\n        xStart: sideMargin,\n        xEnd: width - sideMargin,\n        yStart: Math.max(Math.round(height * 0.7), topOfRegion),\n        yEnd: height - bottomMargin,\n    };\n}\n\n/**\n * Get recommended scan region for count text detection\n */\nexport function getCountTextRegion(\n    cellX: number,\n    cellY: number,\n    cellWidth: number,\n    cellHeight: number,\n    height: number\n): { x: number; y: number; width: number; height: number } {\n    const profile = getProfileForResolution(0, height);\n    const textHeight = profile.countTextHeight.max;\n    const textWidth = Math.round(cellWidth * 0.4); // Text is typically 40% of cell width\n\n    switch (profile.countTextPosition) {\n        case 'bottom-center':\n            return {\n                x: cellX + Math.round((cellWidth - textWidth) / 2),\n                y: cellY + cellHeight - textHeight,\n                width: textWidth,\n                height: textHeight,\n            };\n        case 'top-right':\n            return {\n                x: cellX + cellWidth - textWidth,\n                y: cellY,\n                width: textWidth,\n                height: textHeight,\n            };\n        case 'bottom-right':\n        default:\n            return {\n                x: cellX + cellWidth - textWidth,\n                y: cellY + cellHeight - textHeight,\n                width: textWidth,\n                height: textHeight,\n            };\n    }\n}\n","// ========================================\n// CV Detection Configuration\n// ========================================\n\nimport { getThresholdForRarity } from './scoring-config.ts';\nimport { getResolutionTier } from './resolution-profiles.ts';\n\n// ========================================\n// Worker Path Configuration\n// ========================================\n\n/** Base path for worker scripts - can be overridden for subdirectory deployments */\nlet workerBasePath = '';\n\n/**\n * Set the base path for worker scripts\n * Useful for deployments where the app is not at the root URL\n * @param path The base path (e.g., '/megabonk' or '' for root)\n */\nexport function setWorkerBasePath(path: string): void {\n    // Normalize: remove trailing slash if present\n    workerBasePath = path.endsWith('/') ? path.slice(0, -1) : path;\n}\n\n/**\n * Get the full path to a worker script\n */\nexport function getWorkerPath(workerName: string): string {\n    return `${workerBasePath}/workers/${workerName}`;\n}\n\n// ========================================\n// Detection Lock (Race Condition Prevention)\n// ========================================\n\n/**\n * Race condition fix: Lock to prevent concurrent CV detection runs\n * Without this, multiple detectItemsWithCV calls could corrupt shared state:\n * - Metrics collector accumulates overlapping data\n * - Cache operations could conflict\n * - Progress callbacks would interleave confusingly\n */\nlet cvDetectionInProgress = false;\n\nexport function isCVDetectionInProgress(): boolean {\n    return cvDetectionInProgress;\n}\n\nexport function setCVDetectionInProgress(value: boolean): void {\n    cvDetectionInProgress = value;\n}\n\n// ========================================\n// Image Loading Configuration\n// ========================================\n\n/** Default timeout for image loading (30 seconds) */\nexport const IMAGE_LOAD_TIMEOUT_MS = 30000;\n\n// ========================================\n// Dynamic Confidence Thresholds\n// ========================================\n\n/**\n * Get dynamic minimum confidence threshold based on resolution and scoring config\n * Uses scoring-config.ts for rarity-aware thresholds\n */\nexport function getDynamicMinConfidence(width?: number, height?: number, rarity?: string): number {\n    // Get base threshold from scoring config (rarity-aware)\n    const baseThreshold = getThresholdForRarity(rarity);\n\n    // Adjust based on resolution tier if dimensions provided\n    if (width && height) {\n        const tier = getResolutionTier(width, height);\n        // Lower threshold for low-res (harder to match), higher for high-res\n        const tierAdjustment = {\n            low: -0.05, // 720p: more lenient\n            medium: 0, // 1080p: baseline\n            high: 0.02, // 1440p: slightly stricter\n            ultra: 0.03, // 4K: stricter (clearer images)\n        };\n        return Math.max(0.35, Math.min(0.75, baseThreshold + tierAdjustment[tier]));\n    }\n\n    return baseThreshold;\n}\n","// ========================================\n// CV Detection Utility Functions\n// ========================================\n\nimport { logger } from '../logger.ts';\nimport type { CVDetectionResult, ROI } from './types.ts';\n\n// ========================================\n// Similarity / Geometry Utilities\n// ========================================\n\n/**\n * Calculate Intersection over Union (IoU) between two boxes\n * Used for Non-Maximum Suppression\n */\nexport function calculateIoU(box1: ROI, box2: ROI): number {\n    const x1 = Math.max(box1.x, box2.x);\n    const y1 = Math.max(box1.y, box2.y);\n    const x2 = Math.min(box1.x + box1.width, box2.x + box2.width);\n    const y2 = Math.min(box1.y + box1.height, box2.y + box2.height);\n\n    const intersectionWidth = Math.max(0, x2 - x1);\n    const intersectionHeight = Math.max(0, y2 - y1);\n    const intersectionArea = intersectionWidth * intersectionHeight;\n\n    const box1Area = box1.width * box1.height;\n    const box2Area = box2.width * box2.height;\n    const unionArea = box1Area + box2Area - intersectionArea;\n\n    return unionArea > 0 ? intersectionArea / unionArea : 0;\n}\n\n/**\n * Non-Maximum Suppression to remove overlapping detections\n * Keeps highest confidence detection when boxes overlap\n */\nexport function nonMaxSuppression(detections: CVDetectionResult[], iouThreshold: number = 0.3): CVDetectionResult[] {\n    if (detections.length === 0) return [];\n\n    // Sort by confidence (highest first)\n    const sorted = [...detections].sort((a, b) => b.confidence - a.confidence);\n    const kept: CVDetectionResult[] = [];\n\n    for (const detection of sorted) {\n        if (!detection.position) {\n            kept.push(detection);\n            continue;\n        }\n\n        // Check if this detection overlaps with any already kept\n        let shouldKeep = true;\n        for (const keptDetection of kept) {\n            if (!keptDetection.position) continue;\n\n            const iou = calculateIoU(detection.position, keptDetection.position);\n            if (iou > iouThreshold) {\n                shouldKeep = false;\n                break;\n            }\n        }\n\n        if (shouldKeep) {\n            kept.push(detection);\n        }\n    }\n\n    return kept;\n}\n\n// ========================================\n// Image Data Utilities\n// ========================================\n\n/**\n * Resize ImageData to target dimensions\n * Returns null if canvas context cannot be obtained\n * Exported for use by CV Validator and other library consumers\n */\nexport function resizeImageData(imageData: ImageData, targetWidth: number, targetHeight: number): ImageData | null {\n    const canvas = document.createElement('canvas');\n    canvas.width = imageData.width;\n    canvas.height = imageData.height;\n\n    const ctx = canvas.getContext('2d', { willReadFrequently: true });\n    if (!ctx) {\n        logger.warn({\n            operation: 'cv.resize_image_data',\n            error: { name: 'CanvasError', message: 'Failed to get source canvas 2D context' },\n        });\n        return null;\n    }\n    ctx.putImageData(imageData, 0, 0);\n\n    // Create output canvas\n    const outputCanvas = document.createElement('canvas');\n    outputCanvas.width = targetWidth;\n    outputCanvas.height = targetHeight;\n\n    const outputCtx = outputCanvas.getContext('2d', { willReadFrequently: true });\n    if (!outputCtx) {\n        logger.warn({\n            operation: 'cv.resize_image_data',\n            error: { name: 'CanvasError', message: 'Failed to get output canvas 2D context' },\n        });\n        return null;\n    }\n    outputCtx.drawImage(canvas, 0, 0, imageData.width, imageData.height, 0, 0, targetWidth, targetHeight);\n\n    return outputCtx.getImageData(0, 0, targetWidth, targetHeight);\n}\n\n// ========================================\n// Region Extraction Utilities\n// ========================================\n\n/**\n * Extract icon region from cell, excluding count number area\n * Count numbers are typically in bottom-right corner (last 25-30% of cell)\n */\nexport function extractIconRegion(ctx: CanvasRenderingContext2D, cell: ROI): ImageData {\n    // Extract 80% of cell to avoid count number area in bottom-right\n    let iconWidth = Math.floor(cell.width * 0.8);\n    let iconHeight = Math.floor(cell.height * 0.8);\n\n    // Ensure minimum size\n    iconWidth = Math.max(1, iconWidth);\n    iconHeight = Math.max(1, iconHeight);\n\n    // Bounds check: ensure we don't exceed canvas dimensions\n    const canvasWidth = ctx.canvas.width;\n    const canvasHeight = ctx.canvas.height;\n\n    const safeX = Math.max(0, Math.min(cell.x, canvasWidth - 1));\n    const safeY = Math.max(0, Math.min(cell.y, canvasHeight - 1));\n    const safeWidth = Math.min(iconWidth, canvasWidth - safeX);\n    const safeHeight = Math.min(iconHeight, canvasHeight - safeY);\n\n    // Return empty ImageData if dimensions are invalid\n    if (safeWidth <= 0 || safeHeight <= 0) {\n        return ctx.createImageData(1, 1);\n    }\n\n    return ctx.getImageData(safeX, safeY, safeWidth, safeHeight);\n}\n\n/**\n * Extract count region from cell (bottom-right corner)\n */\nexport function extractCountRegion(cell: ROI): ROI {\n    const countSize = Math.min(25, Math.floor(cell.width * 0.25));\n\n    return {\n        x: cell.x + cell.width - countSize,\n        y: cell.y + cell.height - countSize,\n        width: countSize,\n        height: countSize,\n        label: `${cell.label || 'cell'}_count`,\n    };\n}\n\n// ========================================\n// Caching Utilities\n// ========================================\n\n/**\n * Generate hash from image data URL for caching\n * Uses DJB2 hash algorithm with higher sample count for better collision resistance\n */\nexport function hashImageDataUrl(dataUrl: string): string {\n    const len = dataUrl.length;\n    let hash1 = 5381; // DJB2 initial value\n    let hash2 = 0;\n\n    // Sample more characters for better collision resistance\n    // Use 500 samples instead of 100, and include start/middle/end regions\n    const sampleCount = Math.min(500, len);\n    const step = Math.max(1, Math.floor(len / sampleCount));\n\n    // DJB2 hash on sampled characters\n    // Use >>> 0 inside loop to keep values as unsigned 32-bit integers\n    // This prevents overflow beyond JS safe integer range\n    for (let i = 0; i < len; i += step) {\n        const char = dataUrl.charCodeAt(i);\n        hash1 = (((hash1 << 5) + hash1) ^ char) >>> 0; // hash * 33 ^ char, kept as uint32\n    }\n\n    // Secondary hash from end of string for additional uniqueness\n    const endSampleStart = Math.max(0, len - 1000);\n    for (let i = endSampleStart; i < len; i += 10) {\n        const char = dataUrl.charCodeAt(i);\n        hash2 = ((hash2 << 5) + hash2 + char) >>> 0; // kept as uint32\n    }\n\n    // Combine both hashes with length for final key\n    // Use >>> 0 to ensure unsigned 32-bit integer\n    return `img_${(hash1 >>> 0).toString(16)}_${(hash2 >>> 0).toString(16)}_${len}`;\n}\n\n// ========================================\n// Template Size Utilities\n// ========================================\n\nimport { COMMON_ICON_SIZES } from './state.ts';\n\n/**\n * Find the closest pre-generated template size\n */\nexport function findClosestTemplateSize(targetSize: number): number {\n    let closest: number = COMMON_ICON_SIZES[0] ?? 48;\n    let minDiff = Math.abs(targetSize - closest);\n\n    for (const size of COMMON_ICON_SIZES) {\n        const diff = Math.abs(targetSize - size);\n        if (diff < minDiff) {\n            minDiff = diff;\n            closest = size;\n        }\n    }\n\n    return closest;\n}\n","// ========================================\n// Hotbar Region Detection\n// ========================================\n\nimport { calculateColorVariance, countRarityBorderPixels } from '../color.ts';\nimport type { HotbarRegion } from './grid-types.ts';\n\n/**\n * Enhanced hotbar region detection using rarity border analysis\n * Returns the Y coordinates of the detected hotbar band\n */\nexport function detectHotbarRegion(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    height: number\n): HotbarRegion {\n    // Scan bottom 35% of screen (hotbar is at very bottom)\n    const scanStartY = Math.floor(height * 0.65);\n    const scanEndY = height - 5;\n\n    // Sample center 70% of width (hotbar is centered)\n    const sampleStartX = Math.floor(width * 0.15);\n    const sampleWidth = Math.floor(width * 0.7);\n\n    // Analyze horizontal strips\n    const stripHeight = 2;\n    const strips: Array<{\n        y: number;\n        rarityRatio: number;\n        colorfulRatio: number;\n        variance: number;\n    }> = [];\n\n    for (let y = scanStartY; y < scanEndY; y += stripHeight) {\n        const imageData = ctx.getImageData(sampleStartX, y, sampleWidth, stripHeight);\n        const stats = countRarityBorderPixels(imageData);\n        const variance = calculateColorVariance(imageData);\n\n        strips.push({\n            y,\n            rarityRatio: stats.rarityCount / stats.total,\n            colorfulRatio: stats.colorfulCount / stats.total,\n            variance,\n        });\n    }\n\n    // Find the best hotbar band using sliding window\n    const windowSize = 35; // ~70px window\n    let bestScore = 0;\n    let bestBandStart = scanStartY;\n    let bestBandEnd = scanEndY;\n\n    for (let i = 0; i < strips.length - windowSize; i++) {\n        const windowSlice = strips.slice(i, i + windowSize);\n\n        const avgRarityRatio = windowSlice.reduce((s, d) => s + d.rarityRatio, 0) / windowSlice.length;\n        const avgColorful = windowSlice.reduce((s, d) => s + d.colorfulRatio, 0) / windowSlice.length;\n        const avgVariance = windowSlice.reduce((s, d) => s + d.variance, 0) / windowSlice.length;\n\n        let score = 0;\n\n        // Rarity borders are a strong signal\n        if (avgRarityRatio > 0.01) {\n            score += avgRarityRatio * 200;\n        }\n\n        // Colorful pixels indicate icons\n        if (avgColorful > 0.03) {\n            score += avgColorful * 80;\n        }\n\n        // High variance means varied content (icons)\n        if (avgVariance > 200) {\n            score += Math.min(30, avgVariance / 50);\n        }\n\n        // Prefer lower on screen (hotbar is at very bottom)\n        const firstStrip = windowSlice[0];\n        const lastStrip = windowSlice[windowSlice.length - 1];\n        if (!firstStrip || !lastStrip) continue;\n\n        const yPosition = firstStrip.y / height;\n        if (yPosition > 0.88) {\n            score += 30;\n        } else if (yPosition > 0.82) {\n            score += 15;\n        }\n\n        if (score > bestScore) {\n            bestScore = score;\n            bestBandStart = firstStrip.y;\n            bestBandEnd = lastStrip.y + stripHeight;\n        }\n    }\n\n    // Constrain band height\n    const maxBandHeight = Math.floor(height * 0.15);\n    const minBandHeight = Math.floor(height * 0.05);\n\n    if (bestBandEnd - bestBandStart > maxBandHeight) {\n        bestBandStart = bestBandEnd - maxBandHeight;\n    }\n    if (bestBandEnd - bestBandStart < minBandHeight) {\n        bestBandStart = bestBandEnd - minBandHeight;\n    }\n\n    // Fallback if nothing detected\n    if (bestScore < 10) {\n        bestBandStart = Math.floor(height * 0.85);\n        bestBandEnd = height - 5;\n    }\n\n    return {\n        topY: bestBandStart,\n        bottomY: bestBandEnd,\n        confidence: Math.min(1, bestScore / 100),\n    };\n}\n","// ========================================\n// Icon Edge Detection\n// ========================================\n\nimport { detectRarityAtPixel } from '../color.ts';\n\n/**\n * Detect vertical edges (icon borders) using rarity colors\n * Returns X positions of detected edges\n */\nexport function detectIconEdges(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    bandRegion: { topY: number; bottomY: number }\n): number[] {\n    const { topY, bottomY } = bandRegion;\n    const bandHeight = bottomY - topY;\n\n    // Only scan center 70% of width\n    const scanStartX = Math.floor(width * 0.15);\n    const scanEndX = Math.floor(width * 0.85);\n\n    // Scan multiple horizontal lines within the band\n    const scanYOffsets = [0.1, 0.25, 0.5, 0.75, 0.9];\n    const edgeCounts = new Map<number, number>();\n\n    for (const yOffset of scanYOffsets) {\n        const scanY = Math.floor(topY + bandHeight * yOffset);\n        if (scanY >= ctx.canvas.height) continue;\n\n        const lineData = ctx.getImageData(scanStartX, scanY, scanEndX - scanStartX, 1);\n        const pixels = lineData.data;\n\n        let inBorder = false;\n        let borderStart = -1;\n\n        for (let localX = 0; localX < scanEndX - scanStartX; localX++) {\n            const x = localX + scanStartX;\n            const idx = localX * 4;\n            const r = pixels[idx] ?? 0;\n            const g = pixels[idx + 1] ?? 0;\n            const b = pixels[idx + 2] ?? 0;\n\n            const rarity = detectRarityAtPixel(r, g, b);\n\n            if (rarity && !inBorder) {\n                inBorder = true;\n                borderStart = x;\n            } else if (!rarity && inBorder) {\n                const borderWidth = x - borderStart;\n\n                // Valid borders are 2-8 pixels wide\n                if (borderWidth >= 2 && borderWidth <= 8) {\n                    // Record edge at start of border\n                    const bucket = Math.round(borderStart / 4) * 4; // 4px tolerance\n                    edgeCounts.set(bucket, (edgeCounts.get(bucket) || 0) + 1);\n                }\n\n                inBorder = false;\n            }\n        }\n    }\n\n    // Filter to edges detected in multiple scan lines\n    const consistentEdges: number[] = [];\n    for (const [x, count] of edgeCounts) {\n        if (count >= 2) {\n            consistentEdges.push(x);\n        }\n    }\n\n    // Sort by X position\n    consistentEdges.sort((a, b) => a - b);\n\n    // Filter by spacing consistency\n    return filterByConsistentSpacing(consistentEdges);\n}\n\n/**\n * Filter edges to keep only those with consistent spacing\n */\nexport function filterByConsistentSpacing(edges: number[]): number[] {\n    if (edges.length < 3) return edges;\n\n    // Calculate gaps\n    const gaps: Array<{ gap: number; fromIdx: number; toIdx: number }> = [];\n    for (let i = 1; i < edges.length; i++) {\n        const current = edges[i];\n        const previous = edges[i - 1];\n        if (current === undefined || previous === undefined) continue;\n\n        const gap = current - previous;\n        if (gap > 20 && gap < 120) {\n            gaps.push({ gap, fromIdx: i - 1, toIdx: i });\n        }\n    }\n\n    if (gaps.length < 2) return edges;\n\n    // Find mode gap (most common spacing)\n    const gapCounts = new Map<number, number>();\n    const tolerance = 4;\n\n    for (const { gap } of gaps) {\n        const bucket = Math.round(gap / tolerance) * tolerance;\n        gapCounts.set(bucket, (gapCounts.get(bucket) || 0) + 1);\n    }\n\n    let modeGap = 0;\n    let modeCount = 0;\n    for (const [bucket, count] of gapCounts) {\n        if (count > modeCount) {\n            modeCount = count;\n            modeGap = bucket;\n        }\n    }\n\n    if (modeCount < 2) return edges;\n\n    // Keep edges that fit the mode spacing\n    const consistentIndices = new Set<number>();\n    for (const { gap, fromIdx, toIdx } of gaps) {\n        if (Math.abs(gap - modeGap) <= tolerance) {\n            consistentIndices.add(fromIdx);\n            consistentIndices.add(toIdx);\n        }\n    }\n\n    return edges.filter((_, idx) => consistentIndices.has(idx));\n}\n","// ========================================\n// MegaBonk Test Utilities Module\n// ========================================\n// Utilities for testing image recognition accuracy\n// ========================================\n\nimport type { DetectionResult } from './ocr/index.ts';\nimport type { CVDetectionResult } from './computer-vision.ts';\nimport type { Character, Weapon } from '../types/index.ts';\nimport { logger } from './logger.ts';\n\n/** Detection function result type for automated testing */\nexport interface DetectionFnResult {\n    items: DetectionResult[] | CVDetectionResult[];\n    tomes: DetectionResult[] | CVDetectionResult[];\n    character: Character | null;\n    weapon: Weapon | null;\n}\n\n/** Detection result for comparison (with name identifier) */\ninterface ComparisonDetectionResult {\n    items: (DetectionResult | CVDetectionResult)[];\n    name: string;\n}\n\n// Test result structure\nexport interface TestResult {\n    imageName: string;\n    resolution: string;\n    uiLayout: 'pc' | 'steam_deck' | 'unknown';\n    detectionMode: 'manual' | 'ocr' | 'hybrid';\n    expectedItems: string[];\n    detectedItems: string[];\n    accuracy: number;\n    precision: number;\n    recall: number;\n    confidenceScores: number[];\n    processingTime: number;\n    errors: string[];\n}\n\n// Ground truth for validation\nexport interface GroundTruth {\n    items: string[];\n    tomes: string[];\n    character?: string;\n    weapon?: string;\n}\n\n/**\n * Calculate detection accuracy metrics\n */\nexport function calculateAccuracyMetrics(\n    detected: DetectionResult[] | CVDetectionResult[],\n    groundTruth: string[]\n): {\n    accuracy: number;\n    precision: number;\n    recall: number;\n    truePositives: number;\n    falsePositives: number;\n    falseNegatives: number;\n} {\n    const detectedNames = detected.map(d => d.entity.name.toLowerCase());\n    const truthNames = groundTruth.map(name => name.toLowerCase());\n\n    // True Positives: Detected and in ground truth\n    const truePositives = detectedNames.filter(name => truthNames.includes(name)).length;\n\n    // False Positives: Detected but not in ground truth\n    const falsePositives = detectedNames.filter(name => !truthNames.includes(name)).length;\n\n    // False Negatives: In ground truth but not detected\n    const falseNegatives = truthNames.filter(name => !detectedNames.includes(name)).length;\n\n    // Accuracy: (TP) / (TP + FP + FN)\n    const total = truePositives + falsePositives + falseNegatives;\n    const accuracy = total > 0 ? truePositives / total : 0;\n\n    // Precision: TP / (TP + FP) - Of what we detected, how much was correct?\n    const precision = truePositives + falsePositives > 0 ? truePositives / (truePositives + falsePositives) : 0;\n\n    // Recall: TP / (TP + FN) - Of what should be detected, how much did we find?\n    const recall = truePositives + falseNegatives > 0 ? truePositives / (truePositives + falseNegatives) : 0;\n\n    return {\n        accuracy,\n        precision,\n        recall,\n        truePositives,\n        falsePositives,\n        falseNegatives,\n    };\n}\n\n/**\n * Calculate F1 score (harmonic mean of precision and recall)\n */\nexport function calculateF1Score(precision: number, recall: number): number {\n    if (precision + recall === 0) return 0;\n    return (2 * precision * recall) / (precision + recall);\n}\n\n/**\n * Detect image resolution category\n */\nexport function detectResolution(\n    width: number,\n    height: number\n): {\n    category: '720p' | '1080p' | '1440p' | '4K' | 'steam_deck' | 'custom';\n    width: number;\n    height: number;\n} {\n    // Steam Deck: 1280x800\n    if (width === 1280 && height === 800) {\n        return { category: 'steam_deck', width, height };\n    }\n\n    // 720p: 1280x720\n    if (Math.abs(width - 1280) < 50 && Math.abs(height - 720) < 50) {\n        return { category: '720p', width, height };\n    }\n\n    // 1080p: 1920x1080\n    if (Math.abs(width - 1920) < 50 && Math.abs(height - 1080) < 50) {\n        return { category: '1080p', width, height };\n    }\n\n    // 1440p: 2560x1440\n    if (Math.abs(width - 2560) < 50 && Math.abs(height - 1440) < 50) {\n        return { category: '1440p', width, height };\n    }\n\n    // 4K: 3840x2160\n    if (Math.abs(width - 3840) < 50 && Math.abs(height - 2160) < 50) {\n        return { category: '4K', width, height };\n    }\n\n    return { category: 'custom', width, height };\n}\n\n/**\n * Detect UI layout type based on resolution and aspect ratio\n */\nexport function detectUILayout(width: number, height: number): 'pc' | 'steam_deck' | 'unknown' {\n    const aspectRatio = width / height;\n\n    // Steam Deck: 16:10 aspect ratio (1.6)\n    if (Math.abs(aspectRatio - 1.6) < 0.1) {\n        return 'steam_deck';\n    }\n\n    // PC: 16:9 aspect ratio (1.777...)\n    if (Math.abs(aspectRatio - 1.7777) < 0.1) {\n        return 'pc';\n    }\n\n    return 'unknown';\n}\n\n/**\n * Generate test report\n */\nexport function generateTestReport(results: TestResult[]): string {\n    let report = '# MegaBonk Image Recognition Test Report\\n\\n';\n    report += `**Total Tests:** ${results.length}\\n`;\n    report += `**Generated:** ${new Date().toISOString()}\\n\\n`;\n\n    // Overall statistics\n    const avgAccuracy = results.reduce((sum, r) => sum + r.accuracy, 0) / results.length;\n    const avgPrecision = results.reduce((sum, r) => sum + r.precision, 0) / results.length;\n    const avgRecall = results.reduce((sum, r) => sum + r.recall, 0) / results.length;\n    const avgProcessingTime = results.reduce((sum, r) => sum + r.processingTime, 0) / results.length;\n\n    report += '## Overall Performance\\n\\n';\n    report += `- **Average Accuracy:** ${(avgAccuracy * 100).toFixed(2)}%\\n`;\n    report += `- **Average Precision:** ${(avgPrecision * 100).toFixed(2)}%\\n`;\n    report += `- **Average Recall:** ${(avgRecall * 100).toFixed(2)}%\\n`;\n    report += `- **Average Processing Time:** ${avgProcessingTime.toFixed(2)}ms\\n\\n`;\n\n    // By resolution\n    const byResolution = groupBy(results, r => r.resolution);\n    report += '## Performance by Resolution\\n\\n';\n    for (const [resolution, resResults] of Object.entries(byResolution)) {\n        const resAvgAccuracy = resResults.reduce((sum, r) => sum + r.accuracy, 0) / resResults.length;\n        report += `- **${resolution}:** ${(resAvgAccuracy * 100).toFixed(2)}% accuracy (${resResults.length} tests)\\n`;\n    }\n    report += '\\n';\n\n    // By UI layout\n    const byLayout = groupBy(results, r => r.uiLayout);\n    report += '## Performance by UI Layout\\n\\n';\n    for (const [layout, layoutResults] of Object.entries(byLayout)) {\n        const layoutAvgAccuracy = layoutResults.reduce((sum, r) => sum + r.accuracy, 0) / layoutResults.length;\n        report += `- **${layout}:** ${(layoutAvgAccuracy * 100).toFixed(2)}% accuracy (${layoutResults.length} tests)\\n`;\n    }\n    report += '\\n';\n\n    // By detection mode\n    const byMode = groupBy(results, r => r.detectionMode);\n    report += '## Performance by Detection Mode\\n\\n';\n    for (const [mode, modeResults] of Object.entries(byMode)) {\n        const modeAvgAccuracy = modeResults.reduce((sum, r) => sum + r.accuracy, 0) / modeResults.length;\n        report += `- **${mode}:** ${(modeAvgAccuracy * 100).toFixed(2)}% accuracy (${modeResults.length} tests)\\n`;\n    }\n    report += '\\n';\n\n    // Individual test results\n    report += '## Individual Test Results\\n\\n';\n    results.forEach((result, i) => {\n        report += `### Test ${i + 1}: ${result.imageName}\\n\\n`;\n        report += `- **Resolution:** ${result.resolution}\\n`;\n        report += `- **UI Layout:** ${result.uiLayout}\\n`;\n        report += `- **Detection Mode:** ${result.detectionMode}\\n`;\n        report += `- **Accuracy:** ${(result.accuracy * 100).toFixed(2)}%\\n`;\n        report += `- **Precision:** ${(result.precision * 100).toFixed(2)}%\\n`;\n        report += `- **Recall:** ${(result.recall * 100).toFixed(2)}%\\n`;\n        report += `- **Processing Time:** ${result.processingTime.toFixed(2)}ms\\n`;\n\n        if (result.errors.length > 0) {\n            report += `- **Errors:** ${result.errors.join(', ')}\\n`;\n        }\n\n        report += '\\n';\n    });\n\n    return report;\n}\n\n/**\n * Helper to group array by key\n */\nfunction groupBy<T>(array: T[], keyFn: (item: T) => string): Record<string, T[]> {\n    return array.reduce(\n        (groups, item) => {\n            const key = keyFn(item);\n            if (!groups[key]) {\n                groups[key] = [];\n            }\n            groups[key].push(item);\n            return groups;\n        },\n        {} as Record<string, T[]>\n    );\n}\n\n/**\n * Load test image URLs (sample screenshots)\n */\nexport function getTestImageURLs(): {\n    name: string;\n    url: string;\n    type: 'gameplay' | 'pause_menu';\n    resolution: string;\n    groundTruth: GroundTruth;\n}[] {\n    return [\n        // Note: These are placeholder URLs - replace with actual MegaBonk screenshots\n        {\n            name: 'pc_1080p_pause_menu',\n            url: '/test-images/pc_1080p_pause.png',\n            type: 'pause_menu',\n            resolution: '1920x1080',\n            groundTruth: {\n                items: ['Battery', 'Gym Sauce', 'Anvil'],\n                tomes: ['Damage Tome', 'Crit Tome'],\n                character: 'CL4NK',\n                weapon: 'Hammer',\n            },\n        },\n        {\n            name: 'steam_deck_pause_menu',\n            url: '/test-images/steam_deck_pause.png',\n            type: 'pause_menu',\n            resolution: '1280x800',\n            groundTruth: {\n                items: ['Battery', 'Jetpack', 'Ice Cube'],\n                tomes: ['Speed Tome'],\n                character: 'Monke',\n                weapon: 'Sword',\n            },\n        },\n        {\n            name: 'pc_1440p_gameplay',\n            url: '/test-images/pc_1440p_gameplay.png',\n            type: 'gameplay',\n            resolution: '2560x1440',\n            groundTruth: {\n                items: ['Spicy Meatball', 'Big Bonk'],\n                tomes: [],\n            },\n        },\n    ];\n}\n\n/**\n * Run automated test on image\n */\nexport async function runAutomatedTest(\n    imageDataUrl: string,\n    groundTruth: GroundTruth,\n    detectionFn: (imageUrl: string) => Promise<DetectionFnResult>,\n    detectionMode: 'ocr' | 'hybrid'\n): Promise<TestResult> {\n    const startTime = performance.now();\n\n    try {\n        // Detect resolution\n        const img = new Image();\n        await new Promise((resolve, reject) => {\n            img.onload = resolve;\n            img.onerror = reject;\n            img.src = imageDataUrl;\n        });\n\n        const resolution = detectResolution(img.width, img.height);\n        const uiLayout = detectUILayout(img.width, img.height);\n\n        // Run detection\n        const results = await detectionFn(imageDataUrl);\n\n        // Calculate metrics\n        const itemMetrics = calculateAccuracyMetrics(results.items, groundTruth.items);\n\n        const processingTime = performance.now() - startTime;\n\n        const detectedItems = results.items.map(d => d.entity.name);\n        const confidenceScores = results.items.map(d => d.confidence);\n\n        logger.info({\n            operation: 'test.automated_test',\n            data: {\n                resolution: `${resolution.width}x${resolution.height}`,\n                uiLayout,\n                detectionMode,\n                accuracy: itemMetrics.accuracy,\n                processingTime,\n            },\n        });\n\n        return {\n            imageName: 'automated_test',\n            resolution: `${resolution.width}x${resolution.height}`,\n            uiLayout,\n            detectionMode,\n            expectedItems: groundTruth.items,\n            detectedItems,\n            accuracy: itemMetrics.accuracy,\n            precision: itemMetrics.precision,\n            recall: itemMetrics.recall,\n            confidenceScores,\n            processingTime,\n            errors: [],\n        };\n    } catch (error) {\n        const processingTime = performance.now() - startTime;\n\n        return {\n            imageName: 'automated_test',\n            resolution: 'unknown',\n            uiLayout: 'unknown',\n            detectionMode,\n            expectedItems: groundTruth.items,\n            detectedItems: [],\n            accuracy: 0,\n            precision: 0,\n            recall: 0,\n            confidenceScores: [],\n            processingTime,\n            errors: [(error as Error).message],\n        };\n    }\n}\n\n/**\n * Compare two detection results\n */\nexport function compareDetectionResults(\n    result1: ComparisonDetectionResult,\n    result2: ComparisonDetectionResult\n): {\n    onlyIn1: string[];\n    onlyIn2: string[];\n    inBoth: string[];\n    agreement: number;\n} {\n    const items1 = result1.items.map(i => i.entity.name);\n    const items2 = result2.items.map(i => i.entity.name);\n\n    const set1 = new Set(items1);\n    const set2 = new Set(items2);\n\n    const onlyIn1 = items1.filter(item => !set2.has(item));\n    const onlyIn2 = items2.filter(item => !set1.has(item));\n    const inBoth = items1.filter(item => set2.has(item));\n\n    const agreement = inBoth.length / Math.max(items1.length, items2.length, 1);\n\n    return {\n        onlyIn1,\n        onlyIn2,\n        inBoth,\n        agreement,\n    };\n}\n\n// ========================================\n// Global Assignments\n// ========================================\nif (typeof window !== 'undefined') {\n    // Type assertion: functions use specific types but window interface uses generic types for flexibility\n    window.testUtils = {\n        calculateAccuracyMetrics,\n        calculateF1Score,\n        detectResolution,\n        detectUILayout,\n        generateTestReport,\n        runAutomatedTest,\n        compareDetectionResults,\n    } as typeof window.testUtils;\n}\n","// ========================================\n// Adaptive Icon Scale Detection\n// ========================================\n\nimport { logger } from '../../logger.ts';\nimport { detectResolution } from '../../test-utils.ts';\nimport type { ROI } from '../types.ts';\nimport type { ScaleDetectionResult } from './grid-types.ts';\nimport { detectHotbarRegion } from './hotbar-detection.ts';\nimport { detectIconEdges } from './edge-detection.ts';\n\n/**\n * Get adaptive icon sizes based on image dimensions\n * Returns array of sizes to try for multi-scale detection\n */\nexport function getAdaptiveIconSizes(width: number, height: number): number[] {\n    const resolution = detectResolution(width, height);\n\n    // Base sizes for each resolution\n    const baseSizes: Record<string, number[]> = {\n        '720p': [32, 38, 44],\n        '1080p': [40, 48, 56],\n        '1440p': [48, 55, 64],\n        '4K': [64, 72, 80],\n        steam_deck: [36, 42, 48],\n    };\n\n    return baseSizes[resolution.category] || [40, 50, 60];\n}\n\n/**\n * Dynamically detect icon scale from border analysis\n * More accurate than resolution-based estimation\n */\nexport function detectIconScale(ctx: CanvasRenderingContext2D, width: number, height: number): ScaleDetectionResult {\n    // First try to detect from edge analysis\n    const hotbar = detectHotbarRegion(ctx, width, height);\n\n    if (hotbar.confidence < 0.3) {\n        // Low confidence in hotbar detection, use resolution fallback\n        const sizes = getAdaptiveIconSizes(width, height);\n        return {\n            iconSize: sizes[1] || 48,\n            confidence: 0.5,\n            method: 'resolution_fallback',\n        };\n    }\n\n    const edges = detectIconEdges(ctx, width, hotbar);\n\n    if (edges.length < 2) {\n        // Not enough edges detected, use resolution fallback\n        const sizes = getAdaptiveIconSizes(width, height);\n        return {\n            iconSize: sizes[1] || 48,\n            confidence: 0.4,\n            method: 'resolution_fallback',\n        };\n    }\n\n    // Compute spacings between edges\n    const spacings: number[] = [];\n    for (let i = 1; i < edges.length; i++) {\n        const current = edges[i];\n        const previous = edges[i - 1];\n        if (current === undefined || previous === undefined) continue;\n\n        const spacing = current - previous;\n        // Valid icon sizes are between 25 and 100 pixels\n        if (spacing >= 25 && spacing <= 100) {\n            spacings.push(spacing);\n        }\n    }\n\n    if (spacings.length < 2) {\n        const sizes = getAdaptiveIconSizes(width, height);\n        return {\n            iconSize: sizes[1] || 48,\n            confidence: 0.4,\n            method: 'resolution_fallback',\n        };\n    }\n\n    // Find mode spacing (most common)\n    const tolerance = 4;\n    const buckets = new Map<number, number>();\n    for (const spacing of spacings) {\n        const bucket = Math.round(spacing / tolerance) * tolerance;\n        buckets.set(bucket, (buckets.get(bucket) || 0) + 1);\n    }\n\n    let modeSpacing = 0;\n    let modeCount = 0;\n    for (const [bucket, count] of buckets) {\n        if (count > modeCount) {\n            modeCount = count;\n            modeSpacing = bucket;\n        }\n    }\n\n    // Calculate confidence based on consistency\n    const matchingSpacings = spacings.filter(s => Math.abs(s - modeSpacing) <= tolerance).length;\n    const confidence = Math.min(0.95, matchingSpacings / spacings.length);\n\n    logger.info({\n        operation: 'cv.scale_detection',\n        data: {\n            edgesFound: edges.length,\n            spacings: spacings.length,\n            detectedSize: modeSpacing,\n            confidence,\n        },\n    });\n\n    return {\n        iconSize: modeSpacing,\n        confidence,\n        method: 'edge_analysis',\n    };\n}\n\n/**\n * Detect grid structure in image (for item grids)\n * Returns potential grid positions with dynamic detection\n * @deprecated Use detectIconsWithSlidingWindow for better accuracy\n */\nexport function detectGridPositions(width: number, height: number, _gridSize: number = 64): ROI[] {\n    // Use resolution-appropriate grid size\n    const resolution = detectResolution(width, height);\n\n    // MegaBonk icons are approximately 40-48px depending on resolution\n    const gridSizes: Record<string, number> = {\n        '720p': 38,\n        '1080p': 45,\n        '1440p': 55,\n        '4K': 70,\n        steam_deck: 40,\n    };\n\n    const adaptiveGridSize = gridSizes[resolution.category] || 45;\n\n    const positions: ROI[] = [];\n    const margin = 50; // Hotbar has margins on sides\n    const spacing = Math.floor(adaptiveGridSize * 0.12); // Small gap between icons\n\n    // MegaBonk hotbar is at the VERY BOTTOM of the screen (last 5-8%)\n    // For 1080p: approximately y=1020-1030\n    const hotbarY = height - adaptiveGridSize - 15; // 15px from bottom edge\n\n    for (let x = margin; x < width - margin - adaptiveGridSize; x += adaptiveGridSize + spacing) {\n        positions.push({\n            x,\n            y: hotbarY,\n            width: adaptiveGridSize,\n            height: adaptiveGridSize,\n            label: `cell_${positions.length}`,\n        });\n    }\n\n    // Limit to reasonable number of cells (typical inventory has 15-25 slots)\n    return positions.slice(0, 30);\n}\n","// ========================================\n// Grid Pattern Verification\n// ========================================\n\nimport { logger } from '../../logger.ts';\nimport type { CVDetectionResult } from '../types.ts';\nimport type { GridVerificationResult } from './grid-types.ts';\n\n/**\n * Find the mode (most common value) in an array with tolerance\n */\nexport function findMode(values: number[], tolerance: number): { mode: number; count: number; stdDev: number } {\n    if (values.length === 0) {\n        return { mode: 0, count: 0, stdDev: 0 };\n    }\n\n    const buckets = new Map<number, number[]>();\n    for (const value of values) {\n        const bucket = Math.round(value / tolerance) * tolerance;\n        if (!buckets.has(bucket)) {\n            buckets.set(bucket, []);\n        }\n        buckets.get(bucket)!.push(value);\n    }\n\n    let mode = 0;\n    let maxCount = 0;\n    let modeValues: number[] = [];\n    for (const [bucket, vals] of buckets) {\n        if (vals.length > maxCount) {\n            maxCount = vals.length;\n            mode = bucket;\n            modeValues = vals;\n        }\n    }\n\n    // Calculate standard deviation of values in the mode bucket\n    let stdDev = 0;\n    if (modeValues.length > 1) {\n        const mean = modeValues.reduce((a, b) => a + b, 0) / modeValues.length;\n        const variance = modeValues.reduce((sum, v) => sum + (v - mean) ** 2, 0) / modeValues.length;\n        stdDev = Math.sqrt(variance);\n    }\n\n    return { mode, count: maxCount, stdDev };\n}\n\n/**\n * Calculate adaptive tolerance based on actual spacing variance\n * Uses 2 * standard deviation, clamped to reasonable range\n */\nexport function calculateAdaptiveTolerance(spacings: number[], expectedIconSize: number, baseStdDev: number): number {\n    // Base tolerance from expected icon size\n    const baseTolerance = expectedIconSize * 0.2; // 20% base\n\n    if (spacings.length < 3 || baseStdDev === 0) {\n        return baseTolerance;\n    }\n\n    // Adaptive tolerance: 2 * stdDev, but clamped\n    const adaptiveTolerance = baseStdDev * 2;\n\n    // Clamp between 15% and 35% of expected icon size\n    const minTolerance = expectedIconSize * 0.15;\n    const maxTolerance = expectedIconSize * 0.35;\n\n    return Math.max(minTolerance, Math.min(maxTolerance, Math.max(adaptiveTolerance, baseTolerance)));\n}\n\n/**\n * Check if a value fits within a grid with given spacing\n * @internal Reserved for future grid validation enhancements\n */\nexport function fitsGrid(value: number, gridStart: number, spacing: number, tolerance: number): boolean {\n    if (spacing <= 0) return true;\n    const offset = (value - gridStart) % spacing;\n    return offset <= tolerance || offset >= spacing - tolerance;\n}\n\n/**\n * Cluster detections into rows based on Y position\n * Returns array of rows, each containing positions with similar Y\n */\nexport function clusterByY(\n    positions: Array<{ x: number; y: number; detection: CVDetectionResult }>,\n    yTolerance: number\n): Array<Array<{ x: number; y: number; detection: CVDetectionResult }>> {\n    if (positions.length === 0) return [];\n\n    // Sort by Y\n    const sorted = [...positions].sort((a, b) => a.y - b.y);\n    const firstItem = sorted[0];\n    if (!firstItem) return [];\n\n    const rows: Array<Array<{ x: number; y: number; detection: CVDetectionResult }>> = [];\n    let currentRow: typeof positions = [firstItem];\n\n    for (let i = 1; i < sorted.length; i++) {\n        const current = sorted[i];\n        const previous = sorted[i - 1];\n        if (!current || !previous) continue;\n\n        const yDiff = current.y - previous.y;\n        if (yDiff <= yTolerance) {\n            // Same row\n            currentRow.push(current);\n        } else {\n            // New row\n            rows.push(currentRow);\n            currentRow = [current];\n        }\n    }\n    rows.push(currentRow);\n\n    return rows;\n}\n\n/**\n * Verify that detections form a consistent grid pattern\n * Uses row-aware verification and adaptive tolerance for better accuracy\n */\nexport function verifyGridPattern(detections: CVDetectionResult[], expectedIconSize: number): GridVerificationResult {\n    // Need at least 3 detections to verify a pattern\n    if (detections.length < 3) {\n        return {\n            isValid: true, // Trust small sets\n            confidence: 0.5,\n            filteredDetections: detections,\n            gridParams: null,\n        };\n    }\n\n    // Extract positions\n    const positions = detections\n        .filter(d => d.position)\n        .map(d => ({\n            x: d.position!.x,\n            y: d.position!.y,\n            detection: d,\n        }));\n\n    if (positions.length < 3) {\n        return {\n            isValid: true,\n            confidence: 0.5,\n            filteredDetections: detections,\n            gridParams: null,\n        };\n    }\n\n    // Phase 1: Cluster into rows (row-aware approach)\n    const yClusterTolerance = expectedIconSize * 0.3;\n    const rows = clusterByY(positions, yClusterTolerance);\n\n    // Phase 2: Calculate X spacings within each row\n    const allXSpacings: number[] = [];\n    for (const row of rows) {\n        if (row.length < 2) continue;\n        const sortedRow = [...row].sort((a, b) => a.x - b.x);\n        for (let i = 1; i < sortedRow.length; i++) {\n            const current = sortedRow[i];\n            const previous = sortedRow[i - 1];\n            if (!current || !previous) continue;\n\n            const gap = current.x - previous.x;\n            if (gap > expectedIconSize * 0.5 && gap < expectedIconSize * 2.5) {\n                allXSpacings.push(gap);\n            }\n        }\n    }\n\n    // Phase 3: Calculate Y spacings between row centers\n    const ySpacings: number[] = [];\n    if (rows.length > 1) {\n        // Calculate row centers\n        const rowCenters = rows\n            .map(row => {\n                const avgY = row.reduce((sum, p) => sum + p.y, 0) / row.length;\n                return avgY;\n            })\n            .sort((a, b) => a - b);\n\n        for (let i = 1; i < rowCenters.length; i++) {\n            const current = rowCenters[i];\n            const previous = rowCenters[i - 1];\n            if (current === undefined || previous === undefined) continue;\n\n            const gap = current - previous;\n            if (gap > expectedIconSize * 0.5 && gap < expectedIconSize * 2.5) {\n                ySpacings.push(gap);\n            }\n        }\n    }\n\n    // Find mode spacing with variance tracking\n    const baseTolerance = Math.max(6, expectedIconSize * 0.15);\n    const xMode = findMode(allXSpacings, baseTolerance);\n    const yMode =\n        ySpacings.length > 0 ? findMode(ySpacings, baseTolerance) : { mode: expectedIconSize, count: 0, stdDev: 0 };\n\n    // Use expected icon size as fallback\n    const xSpacing = xMode.count >= 2 ? xMode.mode : expectedIconSize;\n    const ySpacing = yMode.count >= 2 ? yMode.mode : expectedIconSize;\n\n    // Calculate adaptive tolerance based on observed variance\n    const xTolerance = calculateAdaptiveTolerance(allXSpacings, expectedIconSize, xMode.stdDev);\n    const yTolerance = calculateAdaptiveTolerance(ySpacings, expectedIconSize, yMode.stdDev);\n    const tolerance = Math.max(xTolerance, yTolerance);\n\n    // Phase 4: Filter detections using row-aware validation\n    // Instead of strict grid origin check, verify that items are consistently spaced\n    const filtered: typeof positions = [];\n\n    for (const row of rows) {\n        if (row.length === 0) continue;\n\n        // For each row, verify X spacing between adjacent items\n        const sortedRow = [...row].sort((a, b) => a.x - b.x);\n\n        // Always include the first item in each row\n        const firstInRow = sortedRow[0];\n        if (firstInRow) {\n            filtered.push(firstInRow);\n        }\n\n        // Check remaining items: they should be at consistent spacing from previous\n        for (let i = 1; i < sortedRow.length; i++) {\n            const current = sortedRow[i];\n            const previous = sortedRow[i - 1];\n            if (!current || !previous) continue;\n\n            const gap = current.x - previous.x;\n\n            // Accept if gap is close to expected spacing (within tolerance)\n            const isConsistentSpacing = Math.abs(gap - xSpacing) <= tolerance;\n\n            // Also accept if gap is a multiple of spacing (skipped slots)\n            const isMultipleSpacing =\n                (gap > xSpacing * 1.5 && Math.abs((gap % xSpacing) - 0) <= tolerance) ||\n                Math.abs((gap % xSpacing) - xSpacing) <= tolerance;\n\n            if (isConsistentSpacing || isMultipleSpacing) {\n                filtered.push(current);\n            }\n        }\n    }\n\n    // Calculate confidence based on how many detections fit\n    const fitRatio = filtered.length / positions.length;\n\n    // More lenient validity check:\n    // - At least 70% fit, OR\n    // - At most 2 outliers for small sets, OR\n    // - At least 80% of each row fits (row-aware)\n    const maxOutliers = Math.max(2, Math.ceil(positions.length * 0.15));\n    const isValid =\n        fitRatio >= 0.7 || positions.length - filtered.length <= maxOutliers || filtered.length >= positions.length - 2;\n\n    logger.info({\n        operation: 'cv.grid_verification',\n        data: {\n            totalDetections: positions.length,\n            filteredDetections: filtered.length,\n            rows: rows.length,\n            xSpacing,\n            ySpacing,\n            tolerance,\n            adaptiveXTolerance: xTolerance,\n            fitRatio,\n            isValid,\n        },\n    });\n\n    return {\n        isValid,\n        confidence: fitRatio,\n        filteredDetections: filtered.map(p => p.detection),\n        gridParams: {\n            xSpacing,\n            ySpacing,\n            tolerance,\n        },\n    };\n}\n","// ========================================\n// CV Similarity Calculation Module\n// ========================================\n// Advanced similarity methods for template matching\n// Based on scientific testing showing +41.8% F1 improvement\n\nimport { applyAdaptivePreprocessing, type SceneAnalysis, analyzeScene } from './adaptive-preprocessing.ts';\nimport { calculateWeightedScore, passesThreshold, getThresholdForRarity } from './scoring-config.ts';\n\n/**\n * Simple image data interface for cross-module compatibility\n */\ninterface SimpleImageData {\n    data: Uint8ClampedArray | number[];\n    width: number;\n    height: number;\n}\n\n/**\n * Preprocessing options\n */\nexport interface PreprocessOptions {\n    /** Use adaptive preprocessing based on scene analysis */\n    useAdaptive?: boolean;\n    /** Pre-computed scene analysis (avoids re-analyzing) */\n    sceneAnalysis?: SceneAnalysis;\n}\n\n// ========================================\n// Preprocessing Functions\n// ========================================\n\n/**\n * Enhance contrast of image\n * Scientific testing showed +29% F1 improvement\n */\nexport function enhanceContrast(imageData: SimpleImageData, factor: number = 1.5): SimpleImageData {\n    const data = new Uint8ClampedArray(imageData.data);\n    const midpoint = 128;\n    for (let i = 0; i < data.length; i += 4) {\n        data[i] = Math.min(255, Math.max(0, midpoint + ((data[i] ?? 0) - midpoint) * factor));\n        data[i + 1] = Math.min(255, Math.max(0, midpoint + ((data[i + 1] ?? 0) - midpoint) * factor));\n        data[i + 2] = Math.min(255, Math.max(0, midpoint + ((data[i + 2] ?? 0) - midpoint) * factor));\n    }\n    return { data, width: imageData.width, height: imageData.height };\n}\n\n/**\n * Normalize colors to full range\n * Scientific testing showed +10% cumulative F1 improvement\n */\nexport function normalizeColors(imageData: SimpleImageData): SimpleImageData {\n    const data = new Uint8ClampedArray(imageData.data);\n    let minR = 255,\n        maxR = 0,\n        minG = 255,\n        maxG = 0,\n        minB = 255,\n        maxB = 0;\n\n    for (let i = 0; i < data.length; i += 4) {\n        minR = Math.min(minR, data[i] ?? 0);\n        maxR = Math.max(maxR, data[i] ?? 0);\n        minG = Math.min(minG, data[i + 1] ?? 0);\n        maxG = Math.max(maxG, data[i + 1] ?? 0);\n        minB = Math.min(minB, data[i + 2] ?? 0);\n        maxB = Math.max(maxB, data[i + 2] ?? 0);\n    }\n\n    const rangeR = maxR - minR || 1;\n    const rangeG = maxG - minG || 1;\n    const rangeB = maxB - minB || 1;\n\n    // Minimum range threshold to avoid amplifying noise\n    // If range is < 20, the image is nearly uniform and normalization would amplify tiny variations\n    const MIN_RANGE_THRESHOLD = 20;\n\n    for (let i = 0; i < data.length; i += 4) {\n        // Only normalize channels with sufficient range to avoid noise amplification\n        if (rangeR >= MIN_RANGE_THRESHOLD) {\n            data[i] = Math.round((((data[i] ?? 0) - minR) / rangeR) * 255);\n        }\n        if (rangeG >= MIN_RANGE_THRESHOLD) {\n            data[i + 1] = Math.round((((data[i + 1] ?? 0) - minG) / rangeG) * 255);\n        }\n        if (rangeB >= MIN_RANGE_THRESHOLD) {\n            data[i + 2] = Math.round((((data[i + 2] ?? 0) - minB) / rangeB) * 255);\n        }\n    }\n\n    return { data, width: imageData.width, height: imageData.height };\n}\n\n/**\n * Apply preprocessing pipeline (contrast enhancement + color normalization)\n */\nexport function preprocessImage(imageData: SimpleImageData): SimpleImageData {\n    let processed = enhanceContrast(imageData);\n    processed = normalizeColors(processed);\n    return processed;\n}\n\n// ========================================\n// Similarity Calculation Methods\n// ========================================\n\n/**\n * Normalized Cross-Correlation (NCC) similarity\n * Basic method - fast but less accurate\n */\nexport function calculateNCC(imageData1: SimpleImageData, imageData2: SimpleImageData): number {\n    const pixels1 = imageData1.data;\n    const pixels2 = imageData2.data;\n\n    let sum1 = 0,\n        sum2 = 0,\n        sumProduct = 0,\n        sumSquare1 = 0,\n        sumSquare2 = 0,\n        count = 0;\n\n    const len = Math.min(pixels1.length, pixels2.length);\n    for (let i = 0; i < len; i += 4) {\n        const gray1 = ((pixels1[i] ?? 0) + (pixels1[i + 1] ?? 0) + (pixels1[i + 2] ?? 0)) / 3;\n        const gray2 = ((pixels2[i] ?? 0) + (pixels2[i + 1] ?? 0) + (pixels2[i + 2] ?? 0)) / 3;\n\n        sum1 += gray1;\n        sum2 += gray2;\n        sumProduct += gray1 * gray2;\n        sumSquare1 += gray1 * gray1;\n        sumSquare2 += gray2 * gray2;\n        count++;\n    }\n\n    if (count === 0) return 0;\n\n    const mean1 = sum1 / count;\n    const mean2 = sum2 / count;\n\n    const numerator = sumProduct / count - mean1 * mean2;\n    // Note: variance can become slightly negative due to floating-point precision errors\n    // This causes Math.sqrt to return NaN, so we need to handle this case\n    const variance1 = sumSquare1 / count - mean1 * mean1;\n    const variance2 = sumSquare2 / count - mean2 * mean2;\n    const product = variance1 * variance2;\n    // Handle negative product (floating-point error) or zero variance\n    if (product <= 0) return 0;\n    const denominator = Math.sqrt(product);\n\n    // Check for NaN (can occur from floating-point edge cases) or zero denominator\n    if (denominator === 0 || !Number.isFinite(denominator)) return 0;\n\n    const result = (numerator / denominator + 1) / 2;\n    // Ensure result is in valid range [0, 1]\n    return Math.max(0, Math.min(1, result));\n}\n\n/**\n * SSIM (Structural Similarity Index) - Global version\n * More robust than NCC for image comparison\n * Note: With stabilization constants C1/C2, SSIM returns [0, 1] for typical images\n */\nexport function calculateSSIM(img1: SimpleImageData, img2: SimpleImageData): number {\n    if (img1.width !== img2.width || img1.height !== img2.height) return 0;\n\n    const data1 = img1.data;\n    const data2 = img2.data;\n    const n = data1.length / 4;\n\n    if (n === 0) return 0;\n\n    let mean1 = 0,\n        mean2 = 0;\n    const gray1: number[] = [];\n    const gray2: number[] = [];\n\n    for (let i = 0; i < data1.length; i += 4) {\n        const g1 = ((data1[i] ?? 0) + (data1[i + 1] ?? 0) + (data1[i + 2] ?? 0)) / 3;\n        const g2 = ((data2[i] ?? 0) + (data2[i + 1] ?? 0) + (data2[i + 2] ?? 0)) / 3;\n        gray1.push(g1);\n        gray2.push(g2);\n        mean1 += g1;\n        mean2 += g2;\n    }\n\n    mean1 /= n;\n    mean2 /= n;\n\n    let var1 = 0,\n        var2 = 0,\n        covar = 0;\n\n    for (let i = 0; i < n; i++) {\n        const d1 = (gray1[i] ?? 0) - mean1;\n        const d2 = (gray2[i] ?? 0) - mean2;\n        var1 += d1 * d1;\n        var2 += d2 * d2;\n        covar += d1 * d2;\n    }\n\n    var1 /= n;\n    var2 /= n;\n    covar /= n;\n\n    const C1 = (0.01 * 255) ** 2;\n    const C2 = (0.03 * 255) ** 2;\n\n    const ssim = ((2 * mean1 * mean2 + C1) * (2 * covar + C2)) / ((mean1 ** 2 + mean2 ** 2 + C1) * (var1 + var2 + C2));\n\n    // SSIM with stabilization constants already returns [0, 1] for typical images\n    // Clamp to ensure valid range (no transformation needed)\n    return Math.max(0, Math.min(1, ssim));\n}\n\n/**\n * Windowed SSIM (Structural Similarity Index)\n * Uses sliding window approach for better local structure comparison\n * More accurate than global SSIM for template matching\n */\nexport function calculateWindowedSSIM(img1: SimpleImageData, img2: SimpleImageData): number {\n    if (img1.width !== img2.width || img1.height !== img2.height) return 0;\n\n    const width = img1.width;\n    const height = img1.height;\n    const windowSize = 8; // 8x8 windows - good balance of locality and speed\n    const stepSize = 4; // 50% overlap for smoother results\n\n    // SSIM constants\n    const K1 = 0.01;\n    const K2 = 0.03;\n    const L = 255; // Dynamic range\n    const C1 = (K1 * L) ** 2;\n    const C2 = (K2 * L) ** 2;\n\n    // Convert to grayscale arrays for faster access\n    const gray1 = new Float32Array(width * height);\n    const gray2 = new Float32Array(width * height);\n\n    for (let i = 0; i < width * height; i++) {\n        const idx = i * 4;\n        gray1[i] = ((img1.data[idx] ?? 0) + (img1.data[idx + 1] ?? 0) + (img1.data[idx + 2] ?? 0)) / 3;\n        gray2[i] = ((img2.data[idx] ?? 0) + (img2.data[idx + 1] ?? 0) + (img2.data[idx + 2] ?? 0)) / 3;\n    }\n\n    let totalSSIM = 0;\n    let windowCount = 0;\n\n    // Slide window across image\n    for (let wy = 0; wy <= height - windowSize; wy += stepSize) {\n        for (let wx = 0; wx <= width - windowSize; wx += stepSize) {\n            // Compute local statistics for this window\n            let mean1 = 0,\n                mean2 = 0;\n            const windowPixels = windowSize * windowSize;\n\n            // First pass: compute means\n            for (let dy = 0; dy < windowSize; dy++) {\n                for (let dx = 0; dx < windowSize; dx++) {\n                    const idx = (wy + dy) * width + (wx + dx);\n                    mean1 += gray1[idx] ?? 0;\n                    mean2 += gray2[idx] ?? 0;\n                }\n            }\n            mean1 /= windowPixels;\n            mean2 /= windowPixels;\n\n            // Second pass: compute variances and covariance\n            let var1 = 0,\n                var2 = 0,\n                covar = 0;\n            for (let dy = 0; dy < windowSize; dy++) {\n                for (let dx = 0; dx < windowSize; dx++) {\n                    const idx = (wy + dy) * width + (wx + dx);\n                    const d1 = (gray1[idx] ?? 0) - mean1;\n                    const d2 = (gray2[idx] ?? 0) - mean2;\n                    var1 += d1 * d1;\n                    var2 += d2 * d2;\n                    covar += d1 * d2;\n                }\n            }\n            var1 /= windowPixels;\n            var2 /= windowPixels;\n            covar /= windowPixels;\n\n            // Compute local SSIM\n            const numerator = (2 * mean1 * mean2 + C1) * (2 * covar + C2);\n            const denominator = (mean1 ** 2 + mean2 ** 2 + C1) * (var1 + var2 + C2);\n            // Bug fix: Clamp local SSIM to [0, 1] before accumulating\n            // Edge cases with uniform windows can produce values slightly outside range\n            const localSSIM = Math.max(0, Math.min(1, numerator / denominator));\n\n            totalSSIM += localSSIM;\n            windowCount++;\n        }\n    }\n\n    if (windowCount === 0) {\n        // Fallback to global SSIM for very small images\n        return calculateSSIM(img1, img2);\n    }\n\n    // Average SSIM across all windows, clamped to [0, 1]\n    return Math.max(0, Math.min(1, totalSSIM / windowCount));\n}\n\n/**\n * Color histogram comparison\n * Compares color distribution - robust to position shifts and small variations\n */\nexport function calculateHistogramSimilarity(imageData1: SimpleImageData, imageData2: SimpleImageData): number {\n    const bins = 8; // 8 bins per channel = 512 combinations\n    const binSize = 256 / bins;\n\n    // Build histograms for both images\n    const hist1 = new Array(bins * bins * bins).fill(0) as number[];\n    const hist2 = new Array(bins * bins * bins).fill(0) as number[];\n\n    const pixels1 = imageData1.data;\n    const pixels2 = imageData2.data;\n\n    let count1 = 0,\n        count2 = 0;\n\n    // Build histogram 1\n    for (let i = 0; i < pixels1.length; i += 4) {\n        const rBin = Math.min(bins - 1, Math.floor((pixels1[i] ?? 0) / binSize));\n        const gBin = Math.min(bins - 1, Math.floor((pixels1[i + 1] ?? 0) / binSize));\n        const bBin = Math.min(bins - 1, Math.floor((pixels1[i + 2] ?? 0) / binSize));\n        const idx = rBin * bins * bins + gBin * bins + bBin;\n        hist1[idx] = (hist1[idx] ?? 0) + 1;\n        count1++;\n    }\n\n    // Build histogram 2\n    for (let i = 0; i < pixels2.length; i += 4) {\n        const rBin = Math.min(bins - 1, Math.floor((pixels2[i] ?? 0) / binSize));\n        const gBin = Math.min(bins - 1, Math.floor((pixels2[i + 1] ?? 0) / binSize));\n        const bBin = Math.min(bins - 1, Math.floor((pixels2[i + 2] ?? 0) / binSize));\n        const idx = rBin * bins * bins + gBin * bins + bBin;\n        hist2[idx] = (hist2[idx] ?? 0) + 1;\n        count2++;\n    }\n\n    if (count1 === 0 || count2 === 0) return 0;\n\n    // Normalize histograms\n    for (let i = 0; i < hist1.length; i++) {\n        hist1[i] = (hist1[i] ?? 0) / count1;\n        hist2[i] = (hist2[i] ?? 0) / count2;\n    }\n\n    // Calculate intersection (similarity)\n    let intersection = 0;\n    for (let i = 0; i < hist1.length; i++) {\n        intersection += Math.min(hist1[i] ?? 0, hist2[i] ?? 0);\n    }\n\n    return intersection;\n}\n\n/**\n * Edge-based similarity using Sobel-like edge detection\n * Compares edge patterns - robust to color/lighting variations\n */\nexport function calculateEdgeSimilarity(imageData1: SimpleImageData, imageData2: SimpleImageData): number {\n    const { width: w1, height: h1 } = imageData1;\n    const { width: w2, height: h2 } = imageData2;\n\n    if (w1 !== w2 || h1 !== h2) return 0;\n\n    const pixels1 = imageData1.data;\n    const pixels2 = imageData2.data;\n\n    // Convert to grayscale and detect edges\n    const getGray = (pixels: Uint8ClampedArray | number[], x: number, y: number, width: number): number => {\n        const idx = (y * width + x) * 4;\n        return ((pixels[idx] ?? 0) + (pixels[idx + 1] ?? 0) + (pixels[idx + 2] ?? 0)) / 3;\n    };\n\n    // Simple edge detection (gradient magnitude)\n    const getEdge = (\n        pixels: Uint8ClampedArray | number[],\n        x: number,\n        y: number,\n        width: number,\n        height: number\n    ): number => {\n        if (x <= 0 || x >= width - 1 || y <= 0 || y >= height - 1) return 0;\n\n        const gx = getGray(pixels, x + 1, y, width) - getGray(pixels, x - 1, y, width);\n        const gy = getGray(pixels, x, y + 1, width) - getGray(pixels, x, y - 1, width);\n\n        return Math.sqrt(gx * gx + gy * gy);\n    };\n\n    // Compare edge patterns\n    let sumProduct = 0,\n        sumSq1 = 0,\n        sumSq2 = 0;\n\n    for (let y = 1; y < h1 - 1; y += 2) {\n        // Sample every other pixel for speed\n        for (let x = 1; x < w1 - 1; x += 2) {\n            const e1 = getEdge(pixels1, x, y, w1, h1);\n            const e2 = getEdge(pixels2, x, y, w2, h2);\n\n            sumProduct += e1 * e2;\n            sumSq1 += e1 * e1;\n            sumSq2 += e2 * e2;\n        }\n    }\n\n    const denominator = Math.sqrt(sumSq1 * sumSq2);\n    if (denominator === 0) return 0;\n\n    // Bug fix: Clamp result to [0, 1] - edge correlation can be negative\n    // when edges are anti-correlated, but similarity should be non-negative\n    const correlation = sumProduct / denominator;\n    return Math.max(0, Math.min(1, correlation));\n}\n\n// ========================================\n// Combined Similarity (Main Export)\n// ========================================\n\n/**\n * Detailed similarity result with metric breakdown\n */\nexport interface SimilarityResult {\n    /** Final combined score */\n    score: number;\n    /** Individual metric scores */\n    metrics: {\n        ncc: number;\n        ssim: number;\n        histogram: number;\n        edge: number;\n    };\n    /** Whether score passes threshold for given rarity */\n    passesThreshold: boolean;\n    /** Threshold that was applied */\n    threshold: number;\n}\n\n/**\n * Combined similarity score using multiple methods\n * Uses preprocessing (contrast + normalization) and multiple similarity metrics\n * Scientific testing showed +41.8% F1 improvement with this approach\n */\nexport function calculateCombinedSimilarity(imageData1: SimpleImageData, imageData2: SimpleImageData): number {\n    // Apply preprocessing (scientifically validated: +41.8% F1 improvement)\n    const processed1 = preprocessImage(imageData1);\n    const processed2 = preprocessImage(imageData2);\n\n    // Calculate multiple similarity metrics\n    const ncc = calculateNCC(processed1, processed2);\n    const histogram = calculateHistogramSimilarity(processed1, processed2);\n    // Use windowed SSIM for better local structure comparison\n    const ssim = calculateWindowedSSIM(processed1, processed2);\n    const edge = calculateEdgeSimilarity(processed1, processed2);\n\n    // Use configurable weights from scoring-config\n    return calculateWeightedScore(ncc, ssim, histogram, edge);\n}\n\n/**\n * Combined similarity with detailed metric breakdown\n * Returns all metric scores for analysis and debugging\n */\nexport function calculateDetailedSimilarity(\n    imageData1: SimpleImageData,\n    imageData2: SimpleImageData,\n    rarity?: string\n): SimilarityResult {\n    // Apply preprocessing\n    const processed1 = preprocessImage(imageData1);\n    const processed2 = preprocessImage(imageData2);\n\n    // Calculate all metrics\n    const metrics = {\n        ncc: calculateNCC(processed1, processed2),\n        ssim: calculateWindowedSSIM(processed1, processed2),\n        histogram: calculateHistogramSimilarity(processed1, processed2),\n        edge: calculateEdgeSimilarity(processed1, processed2),\n    };\n\n    // Calculate weighted score using config\n    const score = calculateWeightedScore(metrics.ncc, metrics.ssim, metrics.histogram, metrics.edge);\n    const threshold = getThresholdForRarity(rarity);\n\n    return {\n        score,\n        metrics,\n        passesThreshold: score >= threshold,\n        threshold,\n    };\n}\n\n/**\n * Check if similarity score passes threshold for a specific rarity\n * Useful for filtering detections by rarity-specific thresholds\n */\nexport function similarityPassesThreshold(score: number, rarity?: string): boolean {\n    return passesThreshold(score, rarity);\n}\n\n/**\n * Calculate similarity using the enhanced method (wrapper for detection.ts compatibility)\n * This is the main function to use for template matching\n */\nexport function calculateEnhancedSimilarity(imageData1: ImageData, imageData2: ImageData): number {\n    return calculateCombinedSimilarity(imageData1, imageData2);\n}\n\n/**\n * Calculate similarity with adaptive preprocessing\n * Uses scene analysis to determine optimal preprocessing parameters\n */\nexport function calculateAdaptiveSimilarity(\n    imageData1: SimpleImageData,\n    imageData2: SimpleImageData,\n    options?: PreprocessOptions\n): number {\n    let processed1: SimpleImageData;\n    let processed2: SimpleImageData;\n\n    if (options?.useAdaptive) {\n        // Use adaptive preprocessing\n        processed1 = applyAdaptivePreprocessing(imageData1);\n        processed2 = applyAdaptivePreprocessing(imageData2);\n    } else {\n        // Use standard preprocessing\n        processed1 = preprocessImage(imageData1);\n        processed2 = preprocessImage(imageData2);\n    }\n\n    // Calculate multiple similarity metrics\n    const ncc = calculateNCC(processed1, processed2);\n    const histogram = calculateHistogramSimilarity(processed1, processed2);\n    const ssim = calculateWindowedSSIM(processed1, processed2);\n    const edge = calculateEdgeSimilarity(processed1, processed2);\n\n    // Use configurable weights from scoring-config\n    return calculateWeightedScore(ncc, ssim, histogram, edge);\n}\n\n/**\n * Calculate similarity with adaptive preprocessing and rarity awareness\n * Returns detailed result with metric breakdown\n */\nexport function calculateAdaptiveDetailedSimilarity(\n    imageData1: SimpleImageData,\n    imageData2: SimpleImageData,\n    rarity?: string,\n    options?: PreprocessOptions\n): SimilarityResult {\n    let processed1: SimpleImageData;\n    let processed2: SimpleImageData;\n\n    if (options?.useAdaptive) {\n        processed1 = applyAdaptivePreprocessing(imageData1);\n        processed2 = applyAdaptivePreprocessing(imageData2);\n    } else {\n        processed1 = preprocessImage(imageData1);\n        processed2 = preprocessImage(imageData2);\n    }\n\n    // Calculate all metrics\n    const metrics = {\n        ncc: calculateNCC(processed1, processed2),\n        ssim: calculateWindowedSSIM(processed1, processed2),\n        histogram: calculateHistogramSimilarity(processed1, processed2),\n        edge: calculateEdgeSimilarity(processed1, processed2),\n    };\n\n    // Calculate weighted score using config\n    const score = calculateWeightedScore(metrics.ncc, metrics.ssim, metrics.histogram, metrics.edge);\n    const threshold = getThresholdForRarity(rarity);\n\n    return {\n        score,\n        metrics,\n        passesThreshold: score >= threshold,\n        threshold,\n    };\n}\n\n/**\n * Analyze scene and return analysis for reuse\n */\nexport function getSceneAnalysis(imageData: SimpleImageData): SceneAnalysis {\n    return analyzeScene(imageData);\n}\n","// ========================================\n// Template Ranking Module\n// ========================================\n// Tracks template performance and ranks them based on historical accuracy\n// Used to prioritize templates that consistently match well\n\n/**\n * Performance metrics for a single template\n */\nexport interface TemplatePerformance {\n    templateId: string;\n    itemId: string;\n    /** Number of times this template was used */\n    usageCount: number;\n    /** Number of successful matches (verified correct) */\n    successCount: number;\n    /** Number of failed matches (false positives or misses) */\n    failureCount: number;\n    /** Average confidence when matched */\n    avgConfidence: number;\n    /** Items this template is often confused with */\n    confusionItems: Map<string, number>;\n    /** Optimal confidence threshold for this template */\n    optimalThreshold: number;\n    /** Last updated timestamp */\n    lastUpdated: number;\n}\n\n/**\n * Ranking entry for quick lookup\n */\nexport interface TemplateRanking {\n    templateId: string;\n    itemId: string;\n    /** Computed rank score (higher = better) */\n    rankScore: number;\n    /** Success rate (0-1) */\n    successRate: number;\n    /** Whether this template should be skipped */\n    shouldSkip: boolean;\n    /** Recommended confidence threshold */\n    threshold: number;\n}\n\n/**\n * Skip list entry\n */\nexport interface SkipListEntry {\n    templateId: string;\n    itemId: string;\n    reason: 'low_success_rate' | 'high_confusion' | 'manual';\n    successRate: number;\n    addedAt: number;\n}\n\n/**\n * Configuration for ranking system\n */\nexport interface RankingConfig {\n    /** Minimum usage count before ranking is reliable */\n    minUsageCount: number;\n    /** Success rate below this triggers skip list */\n    skipThreshold: number;\n    /** Minimum confidence for counting as success */\n    minConfidenceForSuccess: number;\n    /** Weight for success rate in rank score */\n    successRateWeight: number;\n    /** Weight for confidence in rank score */\n    confidenceWeight: number;\n    /** Decay factor for old data (0-1) */\n    timeDecay: number;\n}\n\n/**\n * Default ranking configuration\n */\nexport const DEFAULT_RANKING_CONFIG: RankingConfig = {\n    minUsageCount: 5,\n    skipThreshold: 0.1, // Skip if <10% success rate\n    minConfidenceForSuccess: 0.5,\n    successRateWeight: 0.7,\n    confidenceWeight: 0.3,\n    timeDecay: 0.95, // 5% decay per day\n};\n\n// Storage\nconst performanceData = new Map<string, TemplatePerformance>();\nconst rankingCache = new Map<string, TemplateRanking>();\nconst skipList = new Map<string, SkipListEntry>();\n\nlet config = DEFAULT_RANKING_CONFIG;\nlet lastCacheUpdate = 0;\nconst CACHE_TTL = 60000; // 1 minute\n\n/**\n * Set ranking configuration\n */\nexport function setRankingConfig(newConfig: Partial<RankingConfig>): void {\n    config = { ...config, ...newConfig };\n    invalidateCache();\n}\n\n/**\n * Get current ranking configuration\n */\nexport function getRankingConfig(): RankingConfig {\n    return config;\n}\n\n/**\n * Record a template match result\n */\nexport function recordMatchResult(\n    templateId: string,\n    itemId: string,\n    success: boolean,\n    confidence: number,\n    confusedWith?: string\n): void {\n    const key = templateId;\n\n    let perf = performanceData.get(key);\n    if (!perf) {\n        perf = {\n            templateId,\n            itemId,\n            usageCount: 0,\n            successCount: 0,\n            failureCount: 0,\n            avgConfidence: 0,\n            confusionItems: new Map(),\n            optimalThreshold: 0.5,\n            lastUpdated: Date.now(),\n        };\n        performanceData.set(key, perf);\n    }\n\n    // Update counts\n    perf.usageCount++;\n    if (success && confidence >= config.minConfidenceForSuccess) {\n        perf.successCount++;\n    } else {\n        perf.failureCount++;\n    }\n\n    // Update average confidence (running average)\n    perf.avgConfidence = (perf.avgConfidence * (perf.usageCount - 1) + confidence) / perf.usageCount;\n\n    // Track confusion\n    if (!success && confusedWith) {\n        const currentCount = perf.confusionItems.get(confusedWith) || 0;\n        perf.confusionItems.set(confusedWith, currentCount + 1);\n    }\n\n    // Update optimal threshold based on success pattern\n    updateOptimalThreshold(perf);\n\n    perf.lastUpdated = Date.now();\n\n    // Check if should be added to skip list\n    checkForSkipList(perf);\n\n    invalidateCache();\n}\n\n/**\n * Update optimal confidence threshold for a template\n */\nfunction updateOptimalThreshold(perf: TemplatePerformance): void {\n    if (perf.usageCount < config.minUsageCount) {\n        perf.optimalThreshold = 0.5; // Default\n        return;\n    }\n\n    const successRate = perf.successCount / perf.usageCount;\n\n    // If high success rate, can use lower threshold\n    // If low success rate, need higher threshold\n    perf.optimalThreshold = 0.4 + (1 - successRate) * 0.3;\n\n    // Clamp to reasonable range\n    perf.optimalThreshold = Math.max(0.35, Math.min(0.7, perf.optimalThreshold));\n}\n\n/**\n * Check if template should be added to skip list\n */\nfunction checkForSkipList(perf: TemplatePerformance): void {\n    if (perf.usageCount < config.minUsageCount) {\n        return;\n    }\n\n    const successRate = perf.successCount / perf.usageCount;\n\n    if (successRate < config.skipThreshold) {\n        // Add to skip list\n        skipList.set(perf.templateId, {\n            templateId: perf.templateId,\n            itemId: perf.itemId,\n            reason: 'low_success_rate',\n            successRate,\n            addedAt: Date.now(),\n        });\n    } else {\n        // Remove from skip list if improved\n        skipList.delete(perf.templateId);\n    }\n\n    // Check for high confusion\n    const totalConfusions = Array.from(perf.confusionItems.values()).reduce((a, b) => a + b, 0);\n    const confusionRate = totalConfusions / perf.usageCount;\n\n    if (confusionRate > 0.5) {\n        skipList.set(perf.templateId, {\n            templateId: perf.templateId,\n            itemId: perf.itemId,\n            reason: 'high_confusion',\n            successRate,\n            addedAt: Date.now(),\n        });\n    }\n}\n\n/**\n * Get ranking for a template\n */\nexport function getTemplateRanking(templateId: string): TemplateRanking | null {\n    updateCacheIfNeeded();\n    return rankingCache.get(templateId) || null;\n}\n\n/**\n * Get rankings for all templates of an item\n */\nexport function getRankingsForItem(itemId: string): TemplateRanking[] {\n    updateCacheIfNeeded();\n\n    const rankings: TemplateRanking[] = [];\n    for (const [, ranking] of rankingCache) {\n        if (ranking.itemId === itemId) {\n            rankings.push(ranking);\n        }\n    }\n\n    return rankings.sort((a, b) => b.rankScore - a.rankScore);\n}\n\n/**\n * Get top N templates for an item by ranking\n */\nexport function getTopTemplates(itemId: string, count: number = 3): TemplateRanking[] {\n    return getRankingsForItem(itemId).slice(0, count);\n}\n\n/**\n * Check if template is on skip list\n */\nexport function shouldSkipTemplate(templateId: string): boolean {\n    return skipList.has(templateId);\n}\n\n/**\n * Get skip list entry\n */\nexport function getSkipListEntry(templateId: string): SkipListEntry | null {\n    return skipList.get(templateId) || null;\n}\n\n/**\n * Get all skip list entries\n */\nexport function getSkipList(): SkipListEntry[] {\n    return Array.from(skipList.values());\n}\n\n/**\n * Manually add template to skip list\n */\nexport function addToSkipList(templateId: string, itemId: string): void {\n    skipList.set(templateId, {\n        templateId,\n        itemId,\n        reason: 'manual',\n        successRate: 0,\n        addedAt: Date.now(),\n    });\n    invalidateCache();\n}\n\n/**\n * Remove template from skip list\n */\nexport function removeFromSkipList(templateId: string): void {\n    skipList.delete(templateId);\n    invalidateCache();\n}\n\n/**\n * Clear skip list\n */\nexport function clearSkipList(): void {\n    skipList.clear();\n    invalidateCache();\n}\n\n/**\n * Get confusion matrix for an item\n * Returns which items this item is commonly confused with\n */\nexport function getConfusionMatrix(itemId: string): Map<string, number> {\n    const confusion = new Map<string, number>();\n\n    for (const [, perf] of performanceData) {\n        if (perf.itemId === itemId) {\n            for (const [confusedItem, count] of perf.confusionItems) {\n                const current = confusion.get(confusedItem) || 0;\n                confusion.set(confusedItem, current + count);\n            }\n        }\n    }\n\n    return confusion;\n}\n\n/**\n * Get recommended threshold for an item (average of template thresholds)\n */\nexport function getRecommendedThreshold(itemId: string): number {\n    const perfs = Array.from(performanceData.values()).filter(p => p.itemId === itemId);\n\n    if (perfs.length === 0) {\n        return 0.5; // Default\n    }\n\n    const totalThreshold = perfs.reduce((sum, p) => sum + p.optimalThreshold, 0);\n    return totalThreshold / perfs.length;\n}\n\n/**\n * Update ranking cache\n */\nfunction updateCacheIfNeeded(): void {\n    const now = Date.now();\n    if (now - lastCacheUpdate < CACHE_TTL) {\n        return;\n    }\n\n    rankingCache.clear();\n\n    for (const [templateId, perf] of performanceData) {\n        const ranking = calculateRanking(perf);\n        rankingCache.set(templateId, ranking);\n    }\n\n    lastCacheUpdate = now;\n}\n\n/**\n * Calculate ranking for a template\n */\nfunction calculateRanking(perf: TemplatePerformance): TemplateRanking {\n    const successRate = perf.usageCount > 0 ? perf.successCount / perf.usageCount : 0;\n\n    // Apply time decay\n    const daysSinceUpdate = (Date.now() - perf.lastUpdated) / (1000 * 60 * 60 * 24);\n    const decayFactor = Math.pow(config.timeDecay, daysSinceUpdate);\n\n    // Calculate rank score\n    const rankScore =\n        (successRate * config.successRateWeight + perf.avgConfidence * config.confidenceWeight) * decayFactor;\n\n    return {\n        templateId: perf.templateId,\n        itemId: perf.itemId,\n        rankScore,\n        successRate,\n        shouldSkip: skipList.has(perf.templateId),\n        threshold: perf.optimalThreshold,\n    };\n}\n\n/**\n * Invalidate ranking cache\n */\nfunction invalidateCache(): void {\n    lastCacheUpdate = 0;\n}\n\n/**\n * Export performance data for persistence\n */\nexport function exportPerformanceData(): {\n    performance: Array<Omit<TemplatePerformance, 'confusionItems'> & { confusionItems: Array<[string, number]> }>;\n    skipList: SkipListEntry[];\n} {\n    const performance = Array.from(performanceData.values()).map(p => {\n        const { confusionItems, ...rest } = p;\n        return {\n            ...rest,\n            confusionItems: Array.from(confusionItems.entries()),\n        };\n    });\n\n    return {\n        performance,\n        skipList: Array.from(skipList.values()),\n    };\n}\n\n/**\n * Import performance data from persistence\n */\nexport function importPerformanceData(data: {\n    performance: Array<Omit<TemplatePerformance, 'confusionItems'> & { confusionItems: Array<[string, number]> }>;\n    skipList: SkipListEntry[];\n}): void {\n    performanceData.clear();\n    skipList.clear();\n\n    for (const perf of data.performance) {\n        performanceData.set(perf.templateId, {\n            ...perf,\n            confusionItems: new Map(perf.confusionItems),\n        });\n    }\n\n    for (const entry of data.skipList) {\n        skipList.set(entry.templateId, entry);\n    }\n\n    invalidateCache();\n}\n\n/**\n * Get summary statistics\n */\nexport function getRankingStats(): {\n    totalTemplates: number;\n    rankedTemplates: number;\n    skippedTemplates: number;\n    avgSuccessRate: number;\n    avgConfidence: number;\n} {\n    updateCacheIfNeeded();\n\n    const rankings = Array.from(rankingCache.values());\n\n    const totalSuccessRate = rankings.reduce((sum, r) => sum + r.successRate, 0);\n    const perfs = Array.from(performanceData.values());\n    const totalConfidence = perfs.reduce((sum, p) => sum + p.avgConfidence, 0);\n\n    return {\n        totalTemplates: performanceData.size,\n        rankedTemplates: rankings.filter(r => !r.shouldSkip).length,\n        skippedTemplates: skipList.size,\n        avgSuccessRate: rankings.length > 0 ? totalSuccessRate / rankings.length : 0,\n        avgConfidence: perfs.length > 0 ? totalConfidence / perfs.length : 0,\n    };\n}\n\n/**\n * Clear all performance data\n */\nexport function clearPerformanceData(): void {\n    performanceData.clear();\n    rankingCache.clear();\n    skipList.clear();\n    lastCacheUpdate = 0;\n}\n","// ========================================\n// Weighted Voting Module for CV Detection\n// ========================================\n// Combines scores from multiple templates using ensemble voting\n// Improves accuracy by reducing false positives from individual matches\n\nimport { passesThreshold } from './scoring-config.ts';\nimport { getTemplateRanking } from './template-ranking.ts';\n\n/**\n * A single vote from a template match\n */\nexport interface TemplateVote {\n    /** Template identifier */\n    templateId: string;\n    /** Item ID this template represents */\n    itemId: string;\n    /** Confidence score from matching */\n    confidence: number;\n    /** Item rarity for threshold adjustment */\n    rarity?: string;\n    /** Individual metric scores */\n    metrics?: {\n        ncc: number;\n        ssim: number;\n        histogram: number;\n        edge: number;\n    };\n}\n\n/**\n * Result from voting aggregation\n */\nexport interface VotingResult {\n    /** Winning item ID */\n    itemId: string;\n    /** Final aggregated confidence */\n    confidence: number;\n    /** Number of templates that voted for this item */\n    voteCount: number;\n    /** Total votes cast */\n    totalVotes: number;\n    /** Whether this result passes the threshold */\n    passesThreshold: boolean;\n    /** Voting breakdown by item */\n    votingBreakdown: Map<string, VoteAggregate>;\n    /** Confidence in the winning item (ratio of votes) */\n    consensus: number;\n}\n\n/**\n * Aggregate statistics for votes for a single item\n */\nexport interface VoteAggregate {\n    itemId: string;\n    voteCount: number;\n    totalWeight: number;\n    avgConfidence: number;\n    maxConfidence: number;\n    weightedConfidence: number;\n}\n\n/**\n * Voting configuration\n */\nexport interface VotingConfig {\n    /** Minimum votes required for a valid result */\n    minVotes: number;\n    /** Minimum consensus ratio (votes for winner / total votes) */\n    minConsensus: number;\n    /** Weight boost for templates with good historical performance */\n    usePerformanceWeighting: boolean;\n    /** Weight for template ranking (0 = ignore, 1 = full weight) */\n    performanceWeight: number;\n    /** Voting method */\n    method: 'weighted-average' | 'max' | 'median' | 'ranked-choice';\n    /** Penalty for templates with multiple item matches (confusion) */\n    confusionPenalty: number;\n}\n\n/**\n * Default voting configuration\n */\nexport const DEFAULT_VOTING_CONFIG: VotingConfig = {\n    minVotes: 1,\n    minConsensus: 0.5,\n    usePerformanceWeighting: true,\n    performanceWeight: 0.3,\n    method: 'weighted-average',\n    confusionPenalty: 0.1,\n};\n\n/**\n * Strict voting configuration - requires higher consensus\n */\nexport const STRICT_VOTING_CONFIG: VotingConfig = {\n    minVotes: 2,\n    minConsensus: 0.7,\n    usePerformanceWeighting: true,\n    performanceWeight: 0.4,\n    method: 'weighted-average',\n    confusionPenalty: 0.15,\n};\n\n/**\n * Lenient voting configuration - accepts more results\n */\nexport const LENIENT_VOTING_CONFIG: VotingConfig = {\n    minVotes: 1,\n    minConsensus: 0.3,\n    usePerformanceWeighting: true,\n    performanceWeight: 0.2,\n    method: 'max',\n    confusionPenalty: 0.05,\n};\n\n// Active configuration\nlet activeConfig = DEFAULT_VOTING_CONFIG;\n\n/**\n * Set voting configuration\n */\nexport function setVotingConfig(config: VotingConfig): void {\n    activeConfig = config;\n}\n\n/**\n * Get current voting configuration\n */\nexport function getVotingConfig(): VotingConfig {\n    return activeConfig;\n}\n\n/**\n * Calculate template weight based on historical performance\n */\nfunction getTemplateWeight(templateId: string, config: VotingConfig): number {\n    if (!config.usePerformanceWeighting) {\n        return 1.0;\n    }\n\n    const ranking = getTemplateRanking(templateId);\n    if (!ranking) {\n        return 1.0; // No history, use default weight\n    }\n\n    // Base weight from success rate\n    let weight = 0.5 + ranking.successRate * 0.5; // Range: 0.5 to 1.0\n\n    // Boost for templates with higher rank scores (more reliable)\n    const dataBonus = Math.min(ranking.rankScore / 100, 0.2); // Up to 0.2 bonus\n    weight += dataBonus;\n\n    // Penalty for templates that should be skipped\n    if (ranking.shouldSkip) {\n        weight *= 0.5; // Halve weight for skip-listed templates\n    }\n\n    return Math.max(0.1, Math.min(1.5, weight)); // Clamp to reasonable range\n}\n\n/**\n * Aggregate votes for each item\n */\nfunction aggregateVotes(votes: TemplateVote[], config: VotingConfig): Map<string, VoteAggregate> {\n    const aggregates = new Map<string, VoteAggregate>();\n\n    for (const vote of votes) {\n        const existing = aggregates.get(vote.itemId);\n        const templateWeight = getTemplateWeight(vote.templateId, config);\n        const weightedScore = vote.confidence * templateWeight;\n\n        if (existing) {\n            existing.voteCount++;\n            existing.totalWeight += templateWeight;\n            existing.avgConfidence =\n                (existing.avgConfidence * (existing.voteCount - 1) + vote.confidence) / existing.voteCount;\n            existing.maxConfidence = Math.max(existing.maxConfidence, vote.confidence);\n            existing.weightedConfidence += weightedScore;\n        } else {\n            aggregates.set(vote.itemId, {\n                itemId: vote.itemId,\n                voteCount: 1,\n                totalWeight: templateWeight,\n                avgConfidence: vote.confidence,\n                maxConfidence: vote.confidence,\n                weightedConfidence: weightedScore,\n            });\n        }\n    }\n\n    // Normalize weighted confidence by total weight\n    for (const agg of aggregates.values()) {\n        if (agg.totalWeight > 0) {\n            agg.weightedConfidence /= agg.totalWeight;\n        }\n    }\n\n    return aggregates;\n}\n\n/**\n * Calculate final confidence using the configured method\n */\nfunction calculateFinalConfidence(aggregate: VoteAggregate, votes: TemplateVote[], config: VotingConfig): number {\n    switch (config.method) {\n        case 'max':\n            return aggregate.maxConfidence;\n\n        case 'median': {\n            const itemVotes = votes\n                .filter(v => v.itemId === aggregate.itemId)\n                .map(v => v.confidence)\n                .sort((a, b) => a - b);\n            const mid = Math.floor(itemVotes.length / 2);\n            return itemVotes.length % 2 === 0\n                ? ((itemVotes[mid - 1] ?? 0) + (itemVotes[mid] ?? 0)) / 2\n                : (itemVotes[mid] ?? 0);\n        }\n\n        case 'ranked-choice': {\n            // Weight by vote rank (first choice counts more)\n            const itemVotes = votes\n                .filter(v => v.itemId === aggregate.itemId)\n                .map(v => v.confidence)\n                .sort((a, b) => b - a);\n            let total = 0;\n            let weightSum = 0;\n            for (let i = 0; i < itemVotes.length; i++) {\n                const rankWeight = 1 / (i + 1); // 1, 0.5, 0.33, ...\n                total += (itemVotes[i] ?? 0) * rankWeight;\n                weightSum += rankWeight;\n            }\n            return weightSum > 0 ? total / weightSum : 0;\n        }\n\n        case 'weighted-average':\n        default:\n            return aggregate.weightedConfidence;\n    }\n}\n\n/**\n * Combine votes from multiple template matches using weighted voting\n */\nexport function combineVotes(votes: TemplateVote[], config?: Partial<VotingConfig>): VotingResult | null {\n    const effectiveConfig = { ...activeConfig, ...config };\n\n    if (votes.length === 0) {\n        return null;\n    }\n\n    // Aggregate votes by item\n    const aggregates = aggregateVotes(votes, effectiveConfig);\n\n    if (aggregates.size === 0) {\n        return null;\n    }\n\n    // Find the winner\n    let winner: VoteAggregate | null = null;\n    let maxScore = -1;\n\n    for (const agg of aggregates.values()) {\n        const score = calculateFinalConfidence(agg, votes, effectiveConfig);\n        if (score > maxScore) {\n            maxScore = score;\n            winner = agg;\n        }\n    }\n\n    if (!winner) {\n        return null;\n    }\n\n    // Calculate consensus\n    const totalVotes = votes.length;\n    const consensus = winner.voteCount / totalVotes;\n\n    // Check minimum requirements\n    if (winner.voteCount < effectiveConfig.minVotes) {\n        return null;\n    }\n\n    if (consensus < effectiveConfig.minConsensus) {\n        // Low consensus - might be ambiguous\n        // Still return result but with lower confidence\n        maxScore *= consensus; // Penalize ambiguous results\n    }\n\n    // Get rarity from first vote for threshold check\n    const rarity = votes.find(v => v.itemId === winner!.itemId)?.rarity;\n\n    return {\n        itemId: winner.itemId,\n        confidence: Math.min(0.99, maxScore),\n        voteCount: winner.voteCount,\n        totalVotes,\n        passesThreshold: passesThreshold(maxScore, rarity),\n        votingBreakdown: aggregates,\n        consensus,\n    };\n}\n\n/**\n * Simple majority voting - returns item with most votes\n */\nexport function majorityVote(votes: TemplateVote[]): { itemId: string; voteCount: number; confidence: number } | null {\n    if (votes.length === 0) {\n        return null;\n    }\n\n    const counts = new Map<string, { count: number; maxConf: number }>();\n\n    for (const vote of votes) {\n        const existing = counts.get(vote.itemId);\n        if (existing) {\n            existing.count++;\n            existing.maxConf = Math.max(existing.maxConf, vote.confidence);\n        } else {\n            counts.set(vote.itemId, { count: 1, maxConf: vote.confidence });\n        }\n    }\n\n    let winner: string | null = null;\n    let maxCount = 0;\n    let winnerConf = 0;\n\n    for (const [itemId, data] of counts) {\n        if (data.count > maxCount) {\n            maxCount = data.count;\n            winner = itemId;\n            winnerConf = data.maxConf;\n        }\n    }\n\n    return winner ? { itemId: winner, voteCount: maxCount, confidence: winnerConf } : null;\n}\n\n/**\n * Weighted voting with confidence threshold filtering\n * Only considers votes that pass the threshold\n */\nexport function thresholdVote(votes: TemplateVote[], rarity?: string): VotingResult | null {\n    // Filter votes that pass threshold\n    const passingVotes = votes.filter(vote => passesThreshold(vote.confidence, vote.rarity ?? rarity));\n\n    if (passingVotes.length === 0) {\n        return null;\n    }\n\n    return combineVotes(passingVotes);\n}\n\n/**\n * Ensemble voting - combines results from multiple detection strategies\n */\nexport function ensembleVote(\n    strategyResults: Array<{ strategy: string; votes: TemplateVote[]; weight: number }>\n): VotingResult | null {\n    // Flatten all votes with strategy weights applied\n    const allVotes: TemplateVote[] = [];\n\n    for (const { votes, weight } of strategyResults) {\n        for (const vote of votes) {\n            allVotes.push({\n                ...vote,\n                confidence: vote.confidence * weight, // Apply strategy weight\n            });\n        }\n    }\n\n    return combineVotes(allVotes);\n}\n\n/**\n * Get voting statistics for debugging\n */\nexport function describeVotingResult(result: VotingResult): string {\n    const lines: string[] = [\n        `Winner: ${result.itemId} (${(result.confidence * 100).toFixed(1)}%)`,\n        `Votes: ${result.voteCount}/${result.totalVotes} (${(result.consensus * 100).toFixed(0)}% consensus)`,\n        `Passes threshold: ${result.passesThreshold ? 'Yes' : 'No'}`,\n        '',\n        'Breakdown:',\n    ];\n\n    for (const [itemId, agg] of result.votingBreakdown) {\n        lines.push(\n            `  ${itemId}: ${agg.voteCount} votes, avg=${(agg.avgConfidence * 100).toFixed(1)}%, max=${(agg.maxConfidence * 100).toFixed(1)}%`\n        );\n    }\n\n    return lines.join('\\n');\n}\n","// ========================================\n// Template Matching & Similarity\n// ========================================\n\nimport type { Item } from '../../types/index.ts';\nimport type { ROI, TemplateData } from './types.ts';\nimport {\n    getItemTemplates,\n    getResizedTemplate,\n    setResizedTemplate,\n    getMultiScaleTemplate,\n    hasMultiScaleTemplates,\n} from './state.ts';\nimport { calculateEnhancedSimilarity } from './similarity.ts';\nimport { getTrainingTemplatesForItem } from './training.ts';\nimport type { TrainingTemplate } from './training.ts';\nimport { combineVotes, type TemplateVote } from './voting.ts';\nimport { shouldSkipTemplate, getTemplateRanking } from './template-ranking.ts';\nimport {\n    resizeImageData,\n    extractIconRegion,\n    findClosestTemplateSize,\n} from './detection-utils.ts';\n\n// ========================================\n// Similarity Calculation\n// ========================================\n\n/**\n * Calculate similarity between two image regions using enhanced multi-method approach\n * Returns similarity score (0-1, higher is better)\n * Uses preprocessing (contrast + normalization) and multiple similarity metrics (NCC, SSIM, histogram, edges)\n * Scientific testing showed +41.8% F1 improvement with this approach\n */\nexport function calculateSimilarity(imageData1: ImageData, imageData2: ImageData): number {\n    return calculateEnhancedSimilarity(imageData1, imageData2);\n}\n\n// ========================================\n// Template Ranking Check\n// ========================================\n\n/**\n * Check if template should be used based on ranking\n */\nexport function shouldUseTemplate(templateId: string, _itemId: string): boolean {\n    // Check if template is in skip list\n    if (shouldSkipTemplate(templateId)) {\n        return false;\n    }\n\n    // Get ranking info\n    const ranking = getTemplateRanking(templateId);\n    if (ranking && ranking.successRate < 0.3 && !ranking.shouldSkip) {\n        // Skip templates with very low success rate (ranking system ensures enough data)\n        return false;\n    }\n\n    return true;\n}\n\n// ========================================\n// Template Matching\n// ========================================\n\n/**\n * Match a screenshot cell against an item template\n * Returns similarity score (0-1, higher is better)\n * Returns 0 if template resizing fails or template should be skipped\n * Uses pre-generated multi-scale templates when available, falls back to cache\n * Integrates template ranking to skip poor performers\n */\nexport function matchTemplate(\n    screenshotCtx: CanvasRenderingContext2D,\n    cell: ROI,\n    template: TemplateData,\n    itemId?: string,\n    skipRankingCheck: boolean = false\n): number {\n    // Check template ranking - skip if it's a known poor performer\n    const templateId = itemId ? `${itemId}_primary` : 'unknown';\n    if (!skipRankingCheck && itemId && !shouldUseTemplate(templateId, itemId)) {\n        return 0;\n    }\n\n    // Extract icon region from screenshot (exclude count area)\n    const iconRegion = extractIconRegion(screenshotCtx, cell);\n\n    // Try to use pre-generated multi-scale template first (much faster)\n    let resizedTemplate: ImageData | undefined;\n    if (itemId && hasMultiScaleTemplates(itemId)) {\n        // Find closest pre-generated size\n        const targetSize = Math.max(iconRegion.width, iconRegion.height);\n        const closestSize = findClosestTemplateSize(targetSize);\n        resizedTemplate = getMultiScaleTemplate(itemId, closestSize);\n\n        // If sizes don't match exactly, we need to resize\n        if (resizedTemplate && (closestSize !== iconRegion.width || closestSize !== iconRegion.height)) {\n            const resized = resizeImageData(resizedTemplate, iconRegion.width, iconRegion.height);\n            if (resized) {\n                resizedTemplate = resized;\n            }\n        }\n    }\n\n    // Fall back to cache-based approach\n    if (!resizedTemplate && itemId) {\n        resizedTemplate = getResizedTemplate(itemId, iconRegion.width, iconRegion.height);\n    }\n\n    // Resize from original template if not found\n    if (!resizedTemplate) {\n        const templateImageData = template.ctx.getImageData(0, 0, template.width, template.height);\n        // Convert null to undefined for type consistency\n        resizedTemplate = resizeImageData(templateImageData, iconRegion.width, iconRegion.height) ?? undefined;\n\n        // Handle resize failure gracefully\n        if (!resizedTemplate) {\n            return 0;\n        }\n\n        // Cache the resized template for reuse\n        if (itemId) {\n            setResizedTemplate(itemId, iconRegion.width, iconRegion.height, resizedTemplate);\n        }\n    }\n\n    // Calculate similarity\n    return calculateSimilarity(iconRegion, resizedTemplate);\n}\n\n/**\n * Match using multiple templates (primary + training data)\n * Uses voting.ts module for intelligent score aggregation\n */\nexport function matchTemplateMulti(\n    screenshotCtx: CanvasRenderingContext2D,\n    cell: ROI,\n    template: TemplateData,\n    itemId: string,\n    trainingTemplates: TrainingTemplate[]\n): number {\n    // Get primary template score\n    const primaryScore = matchTemplate(screenshotCtx, cell, template, itemId);\n\n    // If no training templates, return primary score\n    if (!trainingTemplates || trainingTemplates.length === 0) {\n        return primaryScore;\n    }\n\n    // Extract icon region for matching against training templates\n    const iconRegion = extractIconRegion(screenshotCtx, cell);\n\n    // Build votes array for voting module\n    const votes: TemplateVote[] = [\n        {\n            templateId: `primary_${itemId}`,\n            itemId,\n            confidence: primaryScore,\n        },\n    ];\n\n    // Match against training templates\n    for (let i = 0; i < trainingTemplates.length; i++) {\n        const trainingTpl = trainingTemplates[i];\n        if (!trainingTpl) continue; // TypeScript guard\n        // Resize training template to match icon region size\n        const resizedTraining = resizeImageData(trainingTpl.imageData, iconRegion.width, iconRegion.height);\n        if (!resizedTraining) continue;\n\n        const rawScore = calculateSimilarity(iconRegion, resizedTraining);\n        votes.push({\n            templateId: `training_${itemId}_${i}`,\n            itemId,\n            confidence: rawScore,\n        });\n    }\n\n    // Use voting module to combine scores\n    const votingResult = combineVotes(votes);\n    if (!votingResult) {\n        return primaryScore;\n    }\n\n    return votingResult.confidence;\n}\n\n/**\n * Match cell against all templates and return best match\n * Used by sliding window and grid detection\n */\nexport function findBestTemplateMatch(\n    screenshotCtx: CanvasRenderingContext2D,\n    cell: ROI,\n    items: Item[],\n    minConfidence: number,\n    useMultiTemplate: boolean = false\n): { item: Item; similarity: number } | null {\n    const itemTemplates = getItemTemplates();\n    let bestMatch: { item: Item; similarity: number } | null = null;\n\n    for (const item of items) {\n        const template = itemTemplates.get(item.id);\n        if (!template) continue;\n\n        // Get training templates if available\n        const trainingTemplates = useMultiTemplate ? getTrainingTemplatesForItem(item.id) : [];\n\n        // Match template\n        const similarity =\n            trainingTemplates.length > 0\n                ? matchTemplateMulti(screenshotCtx, cell, template, item.id, trainingTemplates)\n                : matchTemplate(screenshotCtx, cell, template, item.id);\n\n        // Absolute similarity floor - never accept matches below 0.35 regardless of config\n        const SIMILARITY_FLOOR = 0.35;\n        if (similarity >= SIMILARITY_FLOOR && similarity > minConfidence && (!bestMatch || similarity > bestMatch.similarity)) {\n            bestMatch = { item, similarity };\n        }\n    }\n\n    return bestMatch;\n}\n","// ========================================\n// Detection Result Processing, Caching, Validation\n// ========================================\n\nimport type { Item } from '../../types/index.ts';\nimport { logger } from '../logger.ts';\nimport type { CVDetectionResult } from './types.ts';\nimport {\n    getDetectionCache,\n    CACHE_TTL,\n    MAX_CACHE_SIZE,\n} from './state.ts';\nimport { detectBorderRarity } from './color.ts';\nimport { IMAGE_LOAD_TIMEOUT_MS } from './detection-config.ts';\n\n// ========================================\n// Image Loading\n// ========================================\n\n/**\n * Load image to canvas for processing\n * Includes timeout protection to prevent indefinite waiting\n */\nexport async function loadImageToCanvas(\n    imageDataUrl: string,\n    timeoutMs: number = IMAGE_LOAD_TIMEOUT_MS\n): Promise<{\n    canvas: HTMLCanvasElement;\n    ctx: CanvasRenderingContext2D;\n    width: number;\n    height: number;\n}> {\n    return new Promise((resolve, reject) => {\n        const img = new Image();\n        let timeoutId: ReturnType<typeof setTimeout> | null = null;\n        let resolved = false;\n\n        const cleanup = () => {\n            if (timeoutId) {\n                clearTimeout(timeoutId);\n                timeoutId = null;\n            }\n        };\n\n        // Set up timeout to prevent indefinite waiting\n        timeoutId = setTimeout(() => {\n            if (!resolved) {\n                resolved = true;\n                img.src = ''; // Cancel image loading\n                logger.warn({\n                    operation: 'cv.load_image_timeout',\n                    error: { name: 'TimeoutError', message: `Image loading timed out after ${timeoutMs}ms` },\n                });\n                reject(new Error(`Image loading timed out after ${timeoutMs}ms`));\n            }\n        }, timeoutMs);\n\n        img.onload = () => {\n            if (resolved) return;\n            resolved = true;\n            cleanup();\n\n            const canvas = document.createElement('canvas');\n            canvas.width = img.width;\n            canvas.height = img.height;\n            const ctx = canvas.getContext('2d', { willReadFrequently: true });\n\n            if (!ctx) {\n                reject(new Error('Failed to get canvas context'));\n                return;\n            }\n\n            ctx.drawImage(img, 0, 0);\n            resolve({ canvas, ctx, width: img.width, height: img.height });\n        };\n\n        img.onerror = event => {\n            if (resolved) return;\n            resolved = true;\n            cleanup();\n            const errorMessage = event instanceof ErrorEvent ? event.message : 'Failed to load image';\n            logger.warn({\n                operation: 'cv.load_image_error',\n                error: { name: 'ImageLoadError', message: errorMessage },\n            });\n            reject(new Error(errorMessage));\n        };\n\n        img.src = imageDataUrl;\n    });\n}\n\n// ========================================\n// Cache Functions\n// ========================================\n\n/**\n * Get cached detection results if available\n */\nexport function getCachedResults(imageHash: string): CVDetectionResult[] | null {\n    const detectionCache = getDetectionCache();\n    const cached = detectionCache.get(imageHash);\n\n    if (!cached) return null;\n\n    // Check if cache is expired\n    if (Date.now() - cached.timestamp > CACHE_TTL) {\n        detectionCache.delete(imageHash);\n        return null;\n    }\n\n    return cached.results;\n}\n\n/**\n * Cache detection results\n */\nexport function cacheResults(imageHash: string, results: CVDetectionResult[]): void {\n    const detectionCache = getDetectionCache();\n    detectionCache.set(imageHash, {\n        results,\n        timestamp: Date.now(),\n    });\n\n    // Cleanup old cache entries (keep last 50)\n    if (detectionCache.size > MAX_CACHE_SIZE) {\n        const entries = Array.from(detectionCache.entries());\n        entries.sort((a, b) => a[1].timestamp - b[1].timestamp);\n\n        // Remove oldest 10 entries\n        for (let i = 0; i < 10; i++) {\n            const entry = entries[i];\n            if (entry) {\n                detectionCache.delete(entry[0]);\n            }\n        }\n    }\n}\n\n// ========================================\n// Confidence Boosting and Validation\n// ========================================\n\n/**\n * Boost confidence based on game context (rarity, synergies)\n * Helps with ambiguous detections\n */\nexport function boostConfidenceWithContext(detections: CVDetectionResult[]): CVDetectionResult[] {\n    const boosted = detections.map(detection => {\n        let boost = 0;\n        const entity = detection.entity as Item;\n\n        // Boost common items (more likely to appear)\n        if (entity.rarity === 'common') {\n            boost += 0.03;\n        } else if (entity.rarity === 'uncommon') {\n            boost += 0.02;\n        } else if (entity.rarity === 'legendary') {\n            // Reduce legendary confidence slightly (less likely)\n            boost -= 0.02;\n        }\n\n        // Boost items that synergize with already detected items\n        const detectedItemNames = detections.map(d => d.entity.name.toLowerCase());\n\n        // Known synergies (simplified - could be expanded)\n        const synergies: Record<string, string[]> = {\n            wrench: ['scrap', 'metal', 'gear'],\n            battery: ['tesla', 'electric', 'shock'],\n            'gym sauce': ['protein', 'fitness', 'muscle'],\n            medkit: ['bandage', 'health', 'healing'],\n        };\n\n        const itemNameLower = entity.name.toLowerCase();\n        const itemSynergies = synergies[itemNameLower] || [];\n\n        for (const synergy of itemSynergies) {\n            if (detectedItemNames.some(name => name.includes(synergy))) {\n                boost += 0.03;\n                break; // Only boost once per item\n            }\n        }\n\n        // Clamp confidence to [0, 0.99]\n        const newConfidence = Math.min(0.99, Math.max(0, detection.confidence + boost));\n\n        return {\n            ...detection,\n            confidence: newConfidence,\n        };\n    });\n\n    return boosted;\n}\n\n/**\n * Validate detections using border rarity check\n * Stronger validation: reject clear mismatches, significantly boost matches\n */\nexport function validateWithBorderRarity(\n    detection: CVDetectionResult,\n    ctx: CanvasRenderingContext2D,\n    strictMode: boolean = false\n): CVDetectionResult | null {\n    if (!detection.position) return detection;\n\n    const entity = detection.entity as Item;\n    const pos = detection.position;\n\n    // Bounds check to prevent getImageData errors\n    const canvasWidth = ctx.canvas.width;\n    const canvasHeight = ctx.canvas.height;\n    if (pos.x < 0 || pos.y < 0 || pos.x + pos.width > canvasWidth || pos.y + pos.height > canvasHeight) {\n        return detection; // Can't validate, keep original\n    }\n\n    // Extract cell image data\n    const cellImageData = ctx.getImageData(pos.x, pos.y, pos.width, pos.height);\n\n    // Detect border rarity\n    const detectedRarity = detectBorderRarity(cellImageData);\n\n    if (!detectedRarity) {\n        // No clear border detected, slight penalty for uncertainty\n        return {\n            ...detection,\n            confidence: detection.confidence * 0.98,\n        };\n    }\n\n    // Check if detected rarity matches item rarity\n    if (detectedRarity === entity.rarity) {\n        // Match! Strong boost for matching rarity\n        return {\n            ...detection,\n            confidence: Math.min(0.99, detection.confidence * 1.08),\n        };\n    } else {\n        // Mismatch - apply penalty based on strictness\n        // In strict mode for non-common items, reject the detection entirely\n        if (strictMode && entity.rarity !== 'common' && detectedRarity !== 'common') {\n            // Clear mismatch between colored rarities - reject\n            logger.info({\n                operation: 'cv.rarity_validation.rejected',\n                data: {\n                    item: entity.name,\n                    expectedRarity: entity.rarity,\n                    detectedRarity,\n                },\n            });\n            return null;\n        }\n\n        // Soft mode: strong penalty for mismatch\n        return {\n            ...detection,\n            confidence: detection.confidence * 0.75, // Stronger penalty\n        };\n    }\n}\n\n/**\n * Filter detections below a confidence threshold\n */\nexport function filterByConfidence(\n    detections: CVDetectionResult[],\n    minConfidence: number\n): CVDetectionResult[] {\n    return detections.filter(d => d.confidence >= minConfidence);\n}\n\n/**\n * Aggregate multiple detection results (from different strategies/phases)\n * Handles deduplication and merging overlapping detections\n */\nexport function aggregateDetections(\n    ...detectionArrays: CVDetectionResult[][]\n): CVDetectionResult[] {\n    return detectionArrays.flat();\n}\n","// ========================================\n// CV Detection Metrics Collection\n// ========================================\n// Tracks performance and accuracy metrics for CV detection\n// Used for empirical validation and optimization\n\nimport { logger } from '../logger.ts';\n\n// ========================================\n// Types\n// ========================================\n\n/**\n * Metrics for a single detection run\n */\nexport interface CVDetectionMetrics {\n    // Timing metrics\n    totalTimeMs: number;\n    gridDetectionTimeMs: number;\n    templateMatchingTimeMs: number;\n    validationTimeMs: number;\n\n    // Two-phase detection metrics\n    twoPhaseAttempted: boolean;\n    twoPhaseSucceeded: boolean;\n    twoPhaseFailureReason: string | null;\n    gridConfidence: number;\n    gridCellsGenerated: number;\n\n    // Grid verification metrics\n    gridVerificationInput: number;\n    gridVerificationOutput: number;\n    gridVerificationRejected: number;\n\n    // Color pre-filtering metrics\n    colorFilterAttempts: number;\n    colorExactMatches: number;\n    colorMixedFallbacks: number;\n    avgCandidatesAfterColorFilter: number;\n\n    // Detection results\n    totalDetections: number;\n    highConfidenceDetections: number; // >0.8\n    mediumConfidenceDetections: number; // 0.65-0.8\n    lowConfidenceDetections: number; // <0.65\n\n    // Confidence distribution (buckets)\n    confidenceHistogram: {\n        '0.5-0.6': number;\n        '0.6-0.7': number;\n        '0.7-0.8': number;\n        '0.8-0.9': number;\n        '0.9-1.0': number;\n    };\n\n    // Rarity validation metrics\n    rarityValidationMatches: number;\n    rarityValidationMismatches: number;\n    rarityValidationRejections: number;\n\n    // Per-rarity detection counts\n    detectionsByRarity: Record<string, number>;\n\n    // Image info\n    imageWidth: number;\n    imageHeight: number;\n    resolution: string;\n}\n\n/**\n * Aggregated metrics across multiple runs\n */\nexport interface CVAggregatedMetrics {\n    runCount: number;\n\n    // Two-phase success rate\n    twoPhaseSuccessRate: number;\n    avgGridConfidence: number;\n\n    // Grid verification stats\n    avgGridRetentionRate: number;\n\n    // Color filtering stats\n    avgColorExactMatchRate: number;\n    avgColorMixedFallbackRate: number;\n    avgCandidatesAfterFilter: number;\n\n    // Detection stats\n    avgDetectionsPerRun: number;\n    avgHighConfidenceRate: number;\n\n    // Timing stats\n    avgTotalTimeMs: number;\n    avgGridDetectionTimeMs: number;\n    avgTemplateMatchingTimeMs: number;\n\n    // Per-difficulty stats\n    byDifficulty: Record<\n        string,\n        {\n            avgF1: number;\n            avgPrecision: number;\n            avgRecall: number;\n            avgDetections: number;\n        }\n    >;\n}\n\n// ========================================\n// Metrics Collector Class\n// ========================================\n\n/**\n * Singleton metrics collector for CV detection\n */\nclass CVMetricsCollector {\n    private static instance: CVMetricsCollector;\n    private enabled: boolean = false;\n    private runs: CVDetectionMetrics[] = [];\n    private currentRun: Partial<CVDetectionMetrics> | null = null;\n    private colorFilterStats = { attempts: 0, exactMatches: 0, mixedFallbacks: 0, candidateCounts: [] as number[] };\n\n    private constructor() {}\n\n    static getInstance(): CVMetricsCollector {\n        if (!CVMetricsCollector.instance) {\n            CVMetricsCollector.instance = new CVMetricsCollector();\n        }\n        return CVMetricsCollector.instance;\n    }\n\n    /**\n     * Enable or disable metrics collection\n     */\n    setEnabled(enabled: boolean): void {\n        this.enabled = enabled;\n        if (enabled) {\n            logger.info({ operation: 'cv.metrics.enabled' });\n        }\n    }\n\n    isEnabled(): boolean {\n        return this.enabled;\n    }\n\n    /**\n     * Start a new detection run\n     */\n    startRun(imageWidth: number, imageHeight: number, resolution: string): void {\n        if (!this.enabled) return;\n\n        this.currentRun = {\n            totalTimeMs: 0,\n            gridDetectionTimeMs: 0,\n            templateMatchingTimeMs: 0,\n            validationTimeMs: 0,\n            twoPhaseAttempted: false,\n            twoPhaseSucceeded: false,\n            twoPhaseFailureReason: null,\n            gridConfidence: 0,\n            gridCellsGenerated: 0,\n            gridVerificationInput: 0,\n            gridVerificationOutput: 0,\n            gridVerificationRejected: 0,\n            colorFilterAttempts: 0,\n            colorExactMatches: 0,\n            colorMixedFallbacks: 0,\n            avgCandidatesAfterColorFilter: 0,\n            totalDetections: 0,\n            highConfidenceDetections: 0,\n            mediumConfidenceDetections: 0,\n            lowConfidenceDetections: 0,\n            confidenceHistogram: {\n                '0.5-0.6': 0,\n                '0.6-0.7': 0,\n                '0.7-0.8': 0,\n                '0.8-0.9': 0,\n                '0.9-1.0': 0,\n            },\n            rarityValidationMatches: 0,\n            rarityValidationMismatches: 0,\n            rarityValidationRejections: 0,\n            detectionsByRarity: {},\n            imageWidth,\n            imageHeight,\n            resolution,\n        };\n\n        // Reset color filter stats for this run\n        this.colorFilterStats = { attempts: 0, exactMatches: 0, mixedFallbacks: 0, candidateCounts: [] };\n    }\n\n    /**\n     * Record two-phase detection attempt\n     */\n    recordTwoPhaseAttempt(\n        succeeded: boolean,\n        failureReason: string | null,\n        gridConfidence: number,\n        gridCells: number\n    ): void {\n        if (!this.enabled || !this.currentRun) return;\n\n        this.currentRun.twoPhaseAttempted = true;\n        this.currentRun.twoPhaseSucceeded = succeeded;\n        this.currentRun.twoPhaseFailureReason = failureReason;\n        this.currentRun.gridConfidence = gridConfidence;\n        this.currentRun.gridCellsGenerated = gridCells;\n    }\n\n    /**\n     * Record grid detection timing\n     */\n    recordGridDetectionTime(timeMs: number): void {\n        if (!this.enabled || !this.currentRun) return;\n        this.currentRun.gridDetectionTimeMs = timeMs;\n    }\n\n    /**\n     * Record template matching timing\n     */\n    recordTemplateMatchingTime(timeMs: number): void {\n        if (!this.enabled || !this.currentRun) return;\n        this.currentRun.templateMatchingTimeMs = timeMs;\n    }\n\n    /**\n     * Record validation timing\n     */\n    recordValidationTime(timeMs: number): void {\n        if (!this.enabled || !this.currentRun) return;\n        this.currentRun.validationTimeMs = timeMs;\n    }\n\n    /**\n     * Record grid verification results\n     */\n    recordGridVerification(inputCount: number, outputCount: number): void {\n        if (!this.enabled || !this.currentRun) return;\n\n        this.currentRun.gridVerificationInput = inputCount;\n        this.currentRun.gridVerificationOutput = outputCount;\n        this.currentRun.gridVerificationRejected = inputCount - outputCount;\n    }\n\n    /**\n     * Record color filter usage\n     */\n    recordColorFilter(usedExactMatch: boolean, usedMixed: boolean, candidateCount: number): void {\n        if (!this.enabled || !this.currentRun) return;\n\n        this.colorFilterStats.attempts++;\n        if (usedExactMatch) this.colorFilterStats.exactMatches++;\n        if (usedMixed) this.colorFilterStats.mixedFallbacks++;\n        this.colorFilterStats.candidateCounts.push(candidateCount);\n    }\n\n    /**\n     * Record a detection with its confidence\n     */\n    recordDetection(confidence: number, rarity: string): void {\n        if (!this.enabled || !this.currentRun) return;\n\n        this.currentRun.totalDetections = (this.currentRun.totalDetections || 0) + 1;\n\n        // Categorize by confidence\n        if (confidence >= 0.8) {\n            this.currentRun.highConfidenceDetections = (this.currentRun.highConfidenceDetections || 0) + 1;\n        } else if (confidence >= 0.65) {\n            this.currentRun.mediumConfidenceDetections = (this.currentRun.mediumConfidenceDetections || 0) + 1;\n        } else {\n            this.currentRun.lowConfidenceDetections = (this.currentRun.lowConfidenceDetections || 0) + 1;\n        }\n\n        // Update histogram\n        const histogram = this.currentRun.confidenceHistogram!;\n        if (confidence >= 0.9) histogram['0.9-1.0']++;\n        else if (confidence >= 0.8) histogram['0.8-0.9']++;\n        else if (confidence >= 0.7) histogram['0.7-0.8']++;\n        else if (confidence >= 0.6) histogram['0.6-0.7']++;\n        else histogram['0.5-0.6']++;\n\n        // Track by rarity\n        if (!this.currentRun.detectionsByRarity) {\n            this.currentRun.detectionsByRarity = {};\n        }\n        this.currentRun.detectionsByRarity[rarity] = (this.currentRun.detectionsByRarity[rarity] || 0) + 1;\n    }\n\n    /**\n     * Record rarity validation result\n     */\n    recordRarityValidation(matched: boolean, rejected: boolean): void {\n        if (!this.enabled || !this.currentRun) return;\n\n        if (rejected) {\n            this.currentRun.rarityValidationRejections = (this.currentRun.rarityValidationRejections || 0) + 1;\n        } else if (matched) {\n            this.currentRun.rarityValidationMatches = (this.currentRun.rarityValidationMatches || 0) + 1;\n        } else {\n            this.currentRun.rarityValidationMismatches = (this.currentRun.rarityValidationMismatches || 0) + 1;\n        }\n    }\n\n    /**\n     * End the current run and record total time\n     */\n    endRun(totalTimeMs: number): CVDetectionMetrics | null {\n        if (!this.enabled || !this.currentRun) return null;\n\n        // Finalize color filter stats\n        this.currentRun.colorFilterAttempts = this.colorFilterStats.attempts;\n        this.currentRun.colorExactMatches = this.colorFilterStats.exactMatches;\n        this.currentRun.colorMixedFallbacks = this.colorFilterStats.mixedFallbacks;\n        this.currentRun.avgCandidatesAfterColorFilter =\n            this.colorFilterStats.candidateCounts.length > 0\n                ? this.colorFilterStats.candidateCounts.reduce((a, b) => a + b, 0) /\n                  this.colorFilterStats.candidateCounts.length\n                : 0;\n\n        this.currentRun.totalTimeMs = totalTimeMs;\n\n        const metrics = this.currentRun as CVDetectionMetrics;\n        this.runs.push(metrics);\n        this.currentRun = null;\n\n        return metrics;\n    }\n\n    /**\n     * Get all recorded runs\n     */\n    getRuns(): CVDetectionMetrics[] {\n        return [...this.runs];\n    }\n\n    /**\n     * Get aggregated metrics\n     */\n    getAggregatedMetrics(): CVAggregatedMetrics | null {\n        if (this.runs.length === 0) return null;\n\n        const runs = this.runs;\n        const runCount = runs.length;\n\n        // Two-phase success rate\n        const twoPhaseAttempts = runs.filter(r => r.twoPhaseAttempted).length;\n        const twoPhaseSuccesses = runs.filter(r => r.twoPhaseSucceeded).length;\n        const twoPhaseSuccessRate = twoPhaseAttempts > 0 ? twoPhaseSuccesses / twoPhaseAttempts : 0;\n\n        // Grid confidence\n        const gridConfidences = runs.filter(r => r.twoPhaseAttempted).map(r => r.gridConfidence);\n        const avgGridConfidence =\n            gridConfidences.length > 0 ? gridConfidences.reduce((a, b) => a + b, 0) / gridConfidences.length : 0;\n\n        // Grid retention rate\n        const retentionRates = runs\n            .filter(r => r.gridVerificationInput > 0)\n            .map(r => r.gridVerificationOutput / r.gridVerificationInput);\n        const avgGridRetentionRate =\n            retentionRates.length > 0 ? retentionRates.reduce((a, b) => a + b, 0) / retentionRates.length : 1;\n\n        // Color filtering\n        const colorRuns = runs.filter(r => r.colorFilterAttempts > 0);\n        const avgColorExactMatchRate =\n            colorRuns.length > 0\n                ? colorRuns.reduce((sum, r) => sum + r.colorExactMatches / r.colorFilterAttempts, 0) / colorRuns.length\n                : 0;\n        const avgColorMixedFallbackRate =\n            colorRuns.length > 0\n                ? colorRuns.reduce((sum, r) => sum + r.colorMixedFallbacks / r.colorFilterAttempts, 0) /\n                  colorRuns.length\n                : 0;\n        const avgCandidatesAfterFilter =\n            colorRuns.length > 0\n                ? colorRuns.reduce((sum, r) => sum + r.avgCandidatesAfterColorFilter, 0) / colorRuns.length\n                : 0;\n\n        // Detection stats\n        const avgDetectionsPerRun = runs.reduce((sum, r) => sum + r.totalDetections, 0) / runCount;\n        const avgHighConfidenceRate =\n            runs.reduce(\n                (sum, r) => sum + (r.totalDetections > 0 ? r.highConfidenceDetections / r.totalDetections : 0),\n                0\n            ) / runCount;\n\n        // Timing\n        const avgTotalTimeMs = runs.reduce((sum, r) => sum + r.totalTimeMs, 0) / runCount;\n        const avgGridDetectionTimeMs = runs.reduce((sum, r) => sum + r.gridDetectionTimeMs, 0) / runCount;\n        const avgTemplateMatchingTimeMs = runs.reduce((sum, r) => sum + r.templateMatchingTimeMs, 0) / runCount;\n\n        return {\n            runCount,\n            twoPhaseSuccessRate,\n            avgGridConfidence,\n            avgGridRetentionRate,\n            avgColorExactMatchRate,\n            avgColorMixedFallbackRate,\n            avgCandidatesAfterFilter,\n            avgDetectionsPerRun,\n            avgHighConfidenceRate,\n            avgTotalTimeMs,\n            avgGridDetectionTimeMs,\n            avgTemplateMatchingTimeMs,\n            byDifficulty: {}, // Populated by test runner\n        };\n    }\n\n    /**\n     * Clear all recorded metrics\n     */\n    clear(): void {\n        this.runs = [];\n        this.currentRun = null;\n        this.colorFilterStats = { attempts: 0, exactMatches: 0, mixedFallbacks: 0, candidateCounts: [] };\n    }\n\n    /**\n     * Export metrics to JSON\n     */\n    exportJSON(): string {\n        return JSON.stringify(\n            {\n                runs: this.runs,\n                aggregated: this.getAggregatedMetrics(),\n                timestamp: new Date().toISOString(),\n            },\n            null,\n            2\n        );\n    }\n}\n\n// ========================================\n// Exported Functions\n// ========================================\n\n/**\n * Get the metrics collector instance\n */\nexport function getMetricsCollector(): CVMetricsCollector {\n    return CVMetricsCollector.getInstance();\n}\n\n/**\n * Enable metrics collection\n */\nexport function enableMetrics(): void {\n    getMetricsCollector().setEnabled(true);\n}\n\n/**\n * Disable metrics collection\n */\nexport function disableMetrics(): void {\n    getMetricsCollector().setEnabled(false);\n}\n\n/**\n * Check if metrics collection is enabled\n */\nexport function isMetricsEnabled(): boolean {\n    return getMetricsCollector().isEnabled();\n}\n","// ========================================\n// Detection Pipeline - Two-Phase Grid Detection\n// ========================================\n\nimport type { Item } from '../../../types/index.ts';\nimport { logger } from '../../logger.ts';\nimport type { CVDetectionResult } from '../types.ts';\nimport { getTemplatesByColor } from '../state.ts';\nimport {\n    getDominantColor,\n    getColorCandidates,\n    isEmptyCell,\n    calculateColorVariance,\n} from '../color.ts';\nimport { isTrainingDataLoaded } from '../training.ts';\nimport { getMetricsCollector } from '../metrics.ts';\nimport { getDynamicMinConfidence } from '../detection-config.ts';\nimport {\n    detectHotbarRegion,\n    detectIconEdges,\n    inferGridFromEdges,\n    generateGridROIs,\n} from '../detection-grid.ts';\nimport { findBestTemplateMatch } from '../detection-matching.ts';\nimport type { TwoPhaseOptions, TwoPhaseResult } from './types.ts';\n\n/**\n * Two-phase detection: first detect grid, then match only at grid positions\n * Much faster than sliding window (100-200x speedup)\n */\nexport async function detectIconsWithTwoPhase(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    items: Item[],\n    options: TwoPhaseOptions = {}\n): Promise<TwoPhaseResult> {\n    // Use dynamic threshold based on resolution (width/height available from ctx)\n    const { minConfidence = getDynamicMinConfidence(width, height), progressCallback } = options;\n    const metrics = getMetricsCollector();\n    const gridStartTime = performance.now();\n\n    // Phase 1: Detect grid structure\n    if (progressCallback) {\n        progressCallback(20, 'Phase 1: Detecting grid structure...');\n    }\n\n    const hotbarRegion = detectHotbarRegion(ctx, width, height);\n    const edges = detectIconEdges(ctx, width, hotbarRegion);\n    const grid = inferGridFromEdges(edges, hotbarRegion, width);\n\n    metrics.recordGridDetectionTime(performance.now() - gridStartTime);\n\n    logger.info({\n        operation: 'cv.two_phase.grid_detection',\n        data: {\n            hotbarConfidence: hotbarRegion.confidence,\n            edgesFound: edges.length,\n            gridDetected: !!grid,\n            gridConfidence: grid?.confidence || 0,\n        },\n    });\n\n    // If grid detection failed or low confidence, fall back to sliding window\n    if (!grid || grid.confidence < 0.4 || grid.columns < 3) {\n        const failureReason = !grid ? 'no_grid' : grid.confidence < 0.4 ? 'low_confidence' : 'too_few_columns';\n        logger.info({\n            operation: 'cv.two_phase.fallback_to_sliding_window',\n            data: { reason: failureReason },\n        });\n        metrics.recordTwoPhaseAttempt(false, failureReason, grid?.confidence || 0, 0);\n        return { detections: [], gridUsed: false, grid: null };\n    }\n\n    // Phase 2: Match templates only at grid positions\n    if (progressCallback) {\n        progressCallback(30, 'Phase 2: Matching templates at grid positions...');\n    }\n\n    const gridCells = generateGridROIs(grid);\n    const detections: CVDetectionResult[] = [];\n    const templatesByColor = getTemplatesByColor();\n    const useMultiTemplate = isTrainingDataLoaded();\n\n    logger.info({\n        operation: 'cv.two_phase.matching_start',\n        data: {\n            gridCells: gridCells.length,\n            columns: grid.columns,\n            rows: grid.rows,\n            cellSize: grid.cellWidth,\n        },\n    });\n\n    for (let i = 0; i < gridCells.length; i++) {\n        const cell = gridCells[i];\n        if (!cell) continue; // TypeScript guard\n\n        // Update progress\n        if (progressCallback && i % 5 === 0) {\n            const progress = 30 + Math.floor((i / gridCells.length) * 50);\n            progressCallback(progress, `Matching cell ${i + 1}/${gridCells.length}...`);\n        }\n\n        // Extract cell image data for pre-filtering\n        const cellData = ctx.getImageData(cell.x, cell.y, cell.width, cell.height);\n\n        // Skip empty cells\n        if (isEmptyCell(cellData)) {\n            continue;\n        }\n\n        // Check variance\n        const variance = calculateColorVariance(cellData);\n        if (variance < 800) {\n            continue;\n        }\n\n        // Color-based pre-filtering using adjacent colors\n        const cellColor = getDominantColor(cellData);\n        const colorsToCheck = getColorCandidates(cellColor);\n\n        // Gather candidates from exact match and adjacent colors\n        const candidateItems: Item[] = [];\n        const seenIds = new Set<string>();\n        let usedExactMatch = false;\n\n        for (const color of colorsToCheck) {\n            const colorItems = templatesByColor.get(color) || [];\n            if (color === cellColor && colorItems.length > 0) {\n                usedExactMatch = true;\n            }\n            for (const item of colorItems) {\n                if (!seenIds.has(item.id)) {\n                    seenIds.add(item.id);\n                    candidateItems.push(item);\n                }\n            }\n        }\n\n        const itemsToCheck = candidateItems.length > 0 ? candidateItems : items.slice(0, 30);\n        const usedAdjacent = !usedExactMatch && candidateItems.length > 0;\n\n        // Record color filter metrics\n        metrics.recordColorFilter(usedExactMatch, usedAdjacent, itemsToCheck.length);\n\n        // Match against candidate templates\n        const bestMatch = findBestTemplateMatch(ctx, cell, itemsToCheck, minConfidence, useMultiTemplate);\n\n        if (bestMatch) {\n            detections.push({\n                type: 'item',\n                entity: bestMatch.item,\n                confidence: bestMatch.similarity,\n                position: { x: cell.x, y: cell.y, width: cell.width, height: cell.height },\n                method: 'template_match',\n            });\n            // Record detection metrics\n            metrics.recordDetection(bestMatch.similarity, bestMatch.item.rarity);\n        }\n    }\n\n    const templateMatchingTime = performance.now() - gridStartTime - (metrics.isEnabled() ? 0 : 0);\n    metrics.recordTemplateMatchingTime(templateMatchingTime);\n\n    logger.info({\n        operation: 'cv.two_phase.complete',\n        data: {\n            detections: detections.length,\n            cellsScanned: gridCells.length,\n        },\n    });\n\n    // Record successful two-phase attempt\n    metrics.recordTwoPhaseAttempt(true, null, grid.confidence, gridCells.length);\n\n    return { detections, gridUsed: true, grid };\n}\n","// ========================================\n// Grid Structure Inference\n// ========================================\n\nimport type { ROI } from '../types.ts';\nimport type { GridParameters } from './grid-types.ts';\n\n/**\n * Infer grid structure from detected edges\n * Returns grid parameters if a consistent grid pattern is found\n */\nexport function inferGridFromEdges(\n    edges: number[],\n    hotbarRegion: { topY: number; bottomY: number },\n    _width: number\n): GridParameters | null {\n    if (edges.length < 2) {\n        return null;\n    }\n\n    // Calculate spacings between edges\n    const spacings: number[] = [];\n    for (let i = 1; i < edges.length; i++) {\n        const current = edges[i];\n        const previous = edges[i - 1];\n        if (current === undefined || previous === undefined) continue;\n\n        const spacing = current - previous;\n        if (spacing > 20 && spacing < 120) {\n            spacings.push(spacing);\n        }\n    }\n\n    if (spacings.length < 1) {\n        return null;\n    }\n\n    // Find the mode spacing (most common cell size)\n    const spacingCounts = new Map<number, number>();\n    const tolerance = 6; // 6px tolerance for grouping\n\n    for (const spacing of spacings) {\n        const bucket = Math.round(spacing / tolerance) * tolerance;\n        spacingCounts.set(bucket, (spacingCounts.get(bucket) || 0) + 1);\n    }\n\n    let modeSpacing = 0;\n    let modeCount = 0;\n    for (const [bucket, count] of spacingCounts) {\n        if (count > modeCount) {\n            modeCount = count;\n            modeSpacing = bucket;\n        }\n    }\n\n    // Need at least 2 consistent gaps\n    if (modeCount < 2 || modeSpacing < 25) {\n        return null;\n    }\n\n    // Find the first edge that starts a consistent sequence\n    let startX = edges[0] ?? 0;\n    for (let i = 0; i < edges.length - 1; i++) {\n        const current = edges[i];\n        const next = edges[i + 1];\n        if (current === undefined || next === undefined) continue;\n\n        const gap = next - current;\n        if (Math.abs(gap - modeSpacing) <= tolerance) {\n            startX = current;\n            break;\n        }\n    }\n\n    // Count consistent columns\n    let columns = 1;\n    let lastEdgeX = startX;\n    for (let i = 0; i < edges.length; i++) {\n        const edgeX = edges[i];\n        if (edgeX === undefined || edgeX <= lastEdgeX) continue;\n        const gap = edgeX - lastEdgeX;\n        if (Math.abs(gap - modeSpacing) <= tolerance) {\n            columns++;\n            lastEdgeX = edgeX;\n        }\n    }\n\n    // Calculate confidence based on consistency\n    const expectedEdges = columns;\n    const actualConsistentEdges = modeCount + 1;\n    const confidence = Math.min(1, actualConsistentEdges / Math.max(3, expectedEdges));\n\n    // Determine rows based on hotbar height\n    const bandHeight = hotbarRegion.bottomY - hotbarRegion.topY;\n    const rows = Math.max(1, Math.round(bandHeight / modeSpacing));\n\n    return {\n        startX,\n        startY: hotbarRegion.topY,\n        cellWidth: modeSpacing,\n        cellHeight: modeSpacing,\n        columns,\n        rows,\n        confidence,\n    };\n}\n\n/**\n * Generate grid cell ROIs from grid parameters\n */\nexport function generateGridROIs(grid: GridParameters, maxCells: number = 50): ROI[] {\n    const cells: ROI[] = [];\n\n    for (let row = 0; row < grid.rows && cells.length < maxCells; row++) {\n        for (let col = 0; col < grid.columns && cells.length < maxCells; col++) {\n            cells.push({\n                x: grid.startX + col * grid.cellWidth,\n                y: grid.startY + row * grid.cellHeight,\n                width: grid.cellWidth,\n                height: grid.cellHeight,\n                label: `grid_${row}_${col}`,\n            });\n        }\n    }\n\n    return cells;\n}\n","// ========================================\n// Detection Pipeline - Sliding Window Detection\n// ========================================\n\nimport type { Item } from '../../../types/index.ts';\nimport { logger } from '../../logger.ts';\nimport type { CVDetectionResult, ROI } from '../types.ts';\nimport { getItemTemplates, getTemplatesByColor } from '../state.ts';\nimport {\n    getDominantColor,\n    getColorCandidates,\n    isEmptyCell,\n    calculateColorVariance,\n} from '../color.ts';\nimport { getTrainingTemplatesForItem, isTrainingDataLoaded } from '../training.ts';\nimport { getDynamicMinConfidence } from '../detection-config.ts';\nimport { nonMaxSuppression } from '../detection-utils.ts';\nimport { getAdaptiveIconSizes } from '../detection-grid.ts';\nimport { matchTemplate, matchTemplateMulti } from '../detection-matching.ts';\nimport type { SlidingWindowOptions, ProgressCallback } from './types.ts';\n\n/**\n * Sliding window detection to find icons anywhere on screen\n * Returns detected icons with their positions\n * Supports multi-scale matching for better accuracy across resolutions\n */\nexport async function detectIconsWithSlidingWindow(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    items: Item[],\n    options: SlidingWindowOptions = {}\n): Promise<CVDetectionResult[]> {\n    // Use dynamic threshold based on resolution and scoring config\n    const dynamicThreshold = getDynamicMinConfidence(width, height);\n    const {\n        stepSize = 12,\n        minConfidence = dynamicThreshold,\n        regionOfInterest,\n        progressCallback,\n        multiScale = true,\n    } = options;\n\n    const detections: CVDetectionResult[] = [];\n    const iconSizes = getAdaptiveIconSizes(width, height);\n    // Use all scales if multiScale is enabled, otherwise just the primary\n    const sizesToUse = multiScale ? iconSizes : [iconSizes[1] || 48];\n    const primarySize = iconSizes[1] || 48; // Primary size for window extraction\n    const itemTemplates = getItemTemplates();\n    const templatesByColor = getTemplatesByColor();\n\n    // Define scan region (full image or ROI)\n    const scanX = regionOfInterest?.x ?? 0;\n    const scanY = regionOfInterest?.y ?? 0;\n    const scanWidth = regionOfInterest?.width ?? width;\n    const scanHeight = regionOfInterest?.height ?? height;\n\n    // Calculate total steps for progress tracking\n    const totalStepsX = Math.ceil((scanWidth - primarySize) / stepSize);\n    const totalStepsY = Math.ceil((scanHeight - primarySize) / stepSize);\n    const totalSteps = totalStepsX * totalStepsY;\n    let currentStep = 0;\n\n    // Check if training data is loaded for multi-template matching\n    const useMultiTemplate = isTrainingDataLoaded();\n\n    logger.info({\n        operation: 'cv.sliding_window_start',\n        data: {\n            scanRegion: { x: scanX, y: scanY, w: scanWidth, h: scanHeight },\n            iconSizes: sizesToUse,\n            multiScale,\n            stepSize,\n            totalSteps,\n            templatesLoaded: itemTemplates.size,\n            trainingDataLoaded: useMultiTemplate,\n        },\n    });\n\n    // Scan across the region\n    for (let y = scanY; y <= scanY + scanHeight - primarySize; y += stepSize) {\n        for (let x = scanX; x <= scanX + scanWidth - primarySize; x += stepSize) {\n            currentStep++;\n\n            // Update progress periodically\n            if (progressCallback && currentStep % 100 === 0) {\n                const progress = Math.floor((currentStep / totalSteps) * 60) + 20;\n                progressCallback(progress, `Scanning ${currentStep}/${totalSteps}...`);\n            }\n\n            // Extract window data for pre-filtering\n            const windowData = ctx.getImageData(x, y, primarySize, primarySize);\n\n            // Skip empty/uniform regions\n            if (isEmptyCell(windowData)) {\n                continue;\n            }\n\n            // Check variance - skip low-detail areas\n            const variance = calculateColorVariance(windowData);\n            if (variance < 800) {\n                continue;\n            }\n\n            // Color-based pre-filtering using adjacent colors\n            const windowColor = getDominantColor(windowData);\n            const colorsToCheck = getColorCandidates(windowColor);\n\n            // Gather candidates from exact match and adjacent colors\n            const candidateItems: Item[] = [];\n            const seenIds = new Set<string>();\n\n            for (const color of colorsToCheck) {\n                const colorItems = templatesByColor.get(color) || [];\n                for (const item of colorItems) {\n                    if (!seenIds.has(item.id)) {\n                        seenIds.add(item.id);\n                        candidateItems.push(item);\n                    }\n                }\n            }\n\n            const itemsToCheck = candidateItems.length > 0 ? candidateItems : items.slice(0, 30);\n\n            // Match against candidate templates at multiple scales\n            let bestMatch: { item: Item; similarity: number; scale: number } | null = null;\n\n            for (const item of itemsToCheck) {\n                const template = itemTemplates.get(item.id);\n                if (!template) continue;\n\n                // Get training templates for this item (if available)\n                const trainingTemplates = useMultiTemplate ? getTrainingTemplatesForItem(item.id) : [];\n\n                // Try each scale and find the best match\n                for (const scaleSize of sizesToUse) {\n                    // Create ROI at this scale\n                    const scaleROI: ROI = {\n                        x,\n                        y,\n                        width: scaleSize,\n                        height: scaleSize,\n                    };\n\n                    // Use multi-template matching if we have training data\n                    const similarity =\n                        trainingTemplates.length > 0\n                            ? matchTemplateMulti(ctx, scaleROI, template, item.id, trainingTemplates)\n                            : matchTemplate(ctx, scaleROI, template, item.id);\n\n                    // Apply scale-aware confidence adjustment\n                    // Smaller icons naturally have lower similarity due to pixelation\n                    const scaleAdjustment = scaleSize < 40 ? -0.02 : scaleSize > 60 ? 0.01 : 0;\n                    const adjustedThreshold = minConfidence + scaleAdjustment;\n\n                    if (similarity > adjustedThreshold && (!bestMatch || similarity > bestMatch.similarity)) {\n                        bestMatch = { item, similarity, scale: scaleSize };\n                    }\n                }\n            }\n\n            if (bestMatch) {\n                detections.push({\n                    type: 'item',\n                    entity: bestMatch.item,\n                    confidence: bestMatch.similarity,\n                    position: { x, y, width: bestMatch.scale, height: bestMatch.scale },\n                    method: 'template_match',\n                });\n            }\n        }\n    }\n\n    logger.info({\n        operation: 'cv.sliding_window_complete',\n        data: {\n            rawDetections: detections.length,\n            scannedPositions: currentStep,\n        },\n    });\n\n    // Apply Non-Maximum Suppression to remove overlapping detections\n    const nmsDetections = nonMaxSuppression(detections, 0.3);\n\n    logger.info({\n        operation: 'cv.nms_complete',\n        data: {\n            beforeNMS: detections.length,\n            afterNMS: nmsDetections.length,\n        },\n    });\n\n    return nmsDetections;\n}\n\n/**\n * Detect equipment (weapons/tomes) in top-left area of screen\n * These appear in a different location than inventory items\n */\nexport async function detectEquipmentRegion(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    items: Item[],\n    progressCallback?: ProgressCallback\n): Promise<CVDetectionResult[]> {\n    // Equipment is typically in top-left 25% of screen\n    const equipmentROI: ROI = {\n        x: 0,\n        y: 0,\n        width: Math.floor(width * 0.25),\n        height: Math.floor(height * 0.4),\n        label: 'equipment_region',\n    };\n\n    if (progressCallback) {\n        progressCallback(85, 'Scanning equipment region...');\n    }\n\n    logger.info({\n        operation: 'cv.equipment_region_scan',\n        data: {\n            region: equipmentROI,\n        },\n    });\n\n    // Use sliding window on equipment region with smaller step for precision\n    const equipmentDetections = await detectIconsWithSlidingWindow(ctx, width, height, items, {\n        stepSize: 8,\n        minConfidence: getDynamicMinConfidence(width, height), // Dynamic threshold\n        regionOfInterest: equipmentROI,\n    });\n\n    return equipmentDetections;\n}\n","// ========================================\n// Ensemble Detector Module\n// ========================================\n// Combines multiple detection strategies for improved accuracy\n// Uses voting and confidence aggregation\n\nimport { getProfileForResolution } from './resolution-profiles.ts';\nimport { passesThreshold } from './scoring-config.ts';\nimport { combineVotes, type TemplateVote } from './voting.ts';\n\n/**\n * Detection strategy identifier\n */\nexport type StrategyId = 'default' | 'high-precision' | 'high-recall' | 'edge-focused' | 'color-focused' | 'fast';\n\n/**\n * Strategy configuration\n */\nexport interface DetectionStrategy {\n    id: StrategyId;\n    name: string;\n    description: string;\n    /** Weight for this strategy in ensemble voting (0-1) */\n    weight: number;\n    /** Minimum confidence threshold override */\n    minConfidence?: number;\n    /** Preprocessing options */\n    preprocessing: {\n        contrastEnhance: boolean;\n        contrastFactor: number;\n        colorNormalize: boolean;\n        edgeEnhance: boolean;\n    };\n    /** Metric weights override */\n    metricWeights?: {\n        ncc: number;\n        ssim: number;\n        histogram: number;\n        edge: number;\n    };\n    /** Template selection options */\n    templates: {\n        useRanking: boolean;\n        skipPoorPerformers: boolean;\n        maxTemplatesPerItem: number;\n    };\n}\n\n/**\n * Single detection from a strategy\n */\nexport interface StrategyDetection {\n    /** Strategy that produced this detection */\n    strategyId: StrategyId;\n    /** Detected item ID */\n    itemId: string;\n    /** Confidence score */\n    confidence: number;\n    /** Cell position */\n    position: { x: number; y: number; width: number; height: number };\n    /** Template used */\n    templateId: string;\n    /** Individual metrics (if available) */\n    metrics?: {\n        ncc: number;\n        ssim: number;\n        histogram: number;\n        edge: number;\n    };\n}\n\n/**\n * Ensemble detection result\n */\nexport interface EnsembleResult {\n    /** Winning item ID */\n    itemId: string;\n    /** Combined confidence */\n    confidence: number;\n    /** Position */\n    position: { x: number; y: number; width: number; height: number };\n    /** Strategy that had the best match */\n    bestStrategy: StrategyId;\n    /** All strategy detections for this cell */\n    strategyResults: StrategyDetection[];\n    /** Agreement level (0-1) */\n    agreement: number;\n    /** Whether result passes threshold */\n    passesThreshold: boolean;\n    /** Item count (if detected) */\n    count?: number;\n}\n\n/**\n * Ensemble configuration\n */\nexport interface EnsembleConfig {\n    /** Strategies to use */\n    strategies: StrategyId[];\n    /** Minimum strategies that must agree */\n    minAgreement: number;\n    /** How to combine results */\n    combineMethod: 'voting' | 'max' | 'average' | 'weighted';\n    /** Early exit if first strategy is confident enough */\n    earlyExitThreshold: number;\n    /** Run strategies in parallel or sequential */\n    parallel: boolean;\n}\n\n// ========================================\n// Strategy Definitions\n// ========================================\n\n/**\n * Default balanced strategy\n */\nexport const DEFAULT_STRATEGY: DetectionStrategy = {\n    id: 'default',\n    name: 'Balanced',\n    description: 'Balanced precision/recall with standard preprocessing',\n    weight: 1.0,\n    preprocessing: {\n        contrastEnhance: true,\n        contrastFactor: 1.5,\n        colorNormalize: true,\n        edgeEnhance: false,\n    },\n    templates: {\n        useRanking: true,\n        skipPoorPerformers: true,\n        maxTemplatesPerItem: 5,\n    },\n};\n\n/**\n * High precision strategy - fewer false positives\n */\nexport const HIGH_PRECISION_STRATEGY: DetectionStrategy = {\n    id: 'high-precision',\n    name: 'High Precision',\n    description: 'Stricter matching to reduce false positives',\n    weight: 0.9,\n    minConfidence: 0.55,\n    preprocessing: {\n        contrastEnhance: true,\n        contrastFactor: 1.3,\n        colorNormalize: true,\n        edgeEnhance: false,\n    },\n    metricWeights: {\n        ssim: 0.45,\n        ncc: 0.2,\n        histogram: 0.2,\n        edge: 0.15,\n    },\n    templates: {\n        useRanking: true,\n        skipPoorPerformers: true,\n        maxTemplatesPerItem: 3,\n    },\n};\n\n/**\n * High recall strategy - fewer misses\n */\nexport const HIGH_RECALL_STRATEGY: DetectionStrategy = {\n    id: 'high-recall',\n    name: 'High Recall',\n    description: 'Lenient matching to catch more items',\n    weight: 0.8,\n    minConfidence: 0.35,\n    preprocessing: {\n        contrastEnhance: true,\n        contrastFactor: 1.8,\n        colorNormalize: true,\n        edgeEnhance: false,\n    },\n    metricWeights: {\n        ssim: 0.3,\n        ncc: 0.3,\n        histogram: 0.25,\n        edge: 0.15,\n    },\n    templates: {\n        useRanking: true,\n        skipPoorPerformers: false,\n        maxTemplatesPerItem: 8,\n    },\n};\n\n/**\n * Edge-focused strategy - good for blurry/compressed images\n */\nexport const EDGE_FOCUSED_STRATEGY: DetectionStrategy = {\n    id: 'edge-focused',\n    name: 'Edge Focused',\n    description: 'Emphasizes edge structure over color',\n    weight: 0.85,\n    preprocessing: {\n        contrastEnhance: true,\n        contrastFactor: 1.4,\n        colorNormalize: false,\n        edgeEnhance: true,\n    },\n    metricWeights: {\n        ssim: 0.25,\n        ncc: 0.15,\n        histogram: 0.15,\n        edge: 0.45,\n    },\n    templates: {\n        useRanking: true,\n        skipPoorPerformers: true,\n        maxTemplatesPerItem: 5,\n    },\n};\n\n/**\n * Color-focused strategy - good for distinguishing similar items\n */\nexport const COLOR_FOCUSED_STRATEGY: DetectionStrategy = {\n    id: 'color-focused',\n    name: 'Color Focused',\n    description: 'Emphasizes color matching for similar-shaped items',\n    weight: 0.85,\n    preprocessing: {\n        contrastEnhance: false,\n        contrastFactor: 1.0,\n        colorNormalize: false,\n        edgeEnhance: false,\n    },\n    metricWeights: {\n        ssim: 0.2,\n        ncc: 0.2,\n        histogram: 0.45,\n        edge: 0.15,\n    },\n    templates: {\n        useRanking: true,\n        skipPoorPerformers: true,\n        maxTemplatesPerItem: 5,\n    },\n};\n\n/**\n * Fast strategy - for quick scanning\n */\nexport const FAST_STRATEGY: DetectionStrategy = {\n    id: 'fast',\n    name: 'Fast',\n    description: 'Quick detection with minimal processing',\n    weight: 0.7,\n    minConfidence: 0.5,\n    preprocessing: {\n        contrastEnhance: false,\n        contrastFactor: 1.0,\n        colorNormalize: false,\n        edgeEnhance: false,\n    },\n    metricWeights: {\n        ssim: 0.5,\n        ncc: 0.5,\n        histogram: 0.0,\n        edge: 0.0,\n    },\n    templates: {\n        useRanking: true,\n        skipPoorPerformers: true,\n        maxTemplatesPerItem: 2,\n    },\n};\n\n/**\n * All strategies indexed by ID\n */\nexport const STRATEGIES: Record<StrategyId, DetectionStrategy> = {\n    default: DEFAULT_STRATEGY,\n    'high-precision': HIGH_PRECISION_STRATEGY,\n    'high-recall': HIGH_RECALL_STRATEGY,\n    'edge-focused': EDGE_FOCUSED_STRATEGY,\n    'color-focused': COLOR_FOCUSED_STRATEGY,\n    fast: FAST_STRATEGY,\n};\n\n/**\n * Default ensemble configuration\n */\nexport const DEFAULT_ENSEMBLE_CONFIG: EnsembleConfig = {\n    strategies: ['default', 'high-precision', 'edge-focused'],\n    minAgreement: 2,\n    combineMethod: 'voting',\n    earlyExitThreshold: 0.9,\n    parallel: true,\n};\n\n/**\n * Precision-focused ensemble\n */\nexport const PRECISION_ENSEMBLE_CONFIG: EnsembleConfig = {\n    strategies: ['high-precision', 'default', 'edge-focused'],\n    minAgreement: 2,\n    combineMethod: 'voting',\n    earlyExitThreshold: 0.95,\n    parallel: true,\n};\n\n/**\n * Recall-focused ensemble\n */\nexport const RECALL_ENSEMBLE_CONFIG: EnsembleConfig = {\n    strategies: ['high-recall', 'default', 'color-focused'],\n    minAgreement: 1,\n    combineMethod: 'max',\n    earlyExitThreshold: 0.85,\n    parallel: true,\n};\n\n/**\n * Fast ensemble for quick scanning\n */\nexport const FAST_ENSEMBLE_CONFIG: EnsembleConfig = {\n    strategies: ['fast'],\n    minAgreement: 1,\n    combineMethod: 'max',\n    earlyExitThreshold: 0.8,\n    parallel: false,\n};\n\n// Active configuration\nlet activeConfig = DEFAULT_ENSEMBLE_CONFIG;\n\n/**\n * Set ensemble configuration\n */\nexport function setEnsembleConfig(config: EnsembleConfig): void {\n    activeConfig = config;\n}\n\n/**\n * Get current ensemble configuration\n */\nexport function getEnsembleConfig(): EnsembleConfig {\n    return activeConfig;\n}\n\n/**\n * Get strategy by ID\n */\nexport function getStrategy(id: StrategyId): DetectionStrategy {\n    return STRATEGIES[id];\n}\n\n/**\n * Combine strategy detections into ensemble result\n */\nexport function combineStrategyDetections(\n    detections: StrategyDetection[],\n    position: { x: number; y: number; width: number; height: number },\n    config: EnsembleConfig = activeConfig\n): EnsembleResult | null {\n    if (detections.length === 0) {\n        return null;\n    }\n\n    // Group by item ID\n    const byItem = new Map<string, StrategyDetection[]>();\n    for (const det of detections) {\n        const existing = byItem.get(det.itemId) ?? [];\n        existing.push(det);\n        byItem.set(det.itemId, existing);\n    }\n\n    // Find winning item based on combine method\n    let winnerItemId: string | null = null;\n    let winnerConfidence = 0;\n    let winnerDetections: StrategyDetection[] = [];\n\n    switch (config.combineMethod) {\n        case 'voting': {\n            // Use voting module\n            const votes: TemplateVote[] = detections.map(d => ({\n                templateId: d.templateId,\n                itemId: d.itemId,\n                confidence: d.confidence * STRATEGIES[d.strategyId].weight,\n            }));\n            const result = combineVotes(votes);\n            if (result) {\n                winnerItemId = result.itemId;\n                winnerConfidence = result.confidence;\n                winnerDetections = byItem.get(result.itemId) ?? [];\n            }\n            break;\n        }\n\n        case 'max': {\n            // Pick item with highest single confidence\n            for (const [itemId, dets] of byItem) {\n                const maxConf = Math.max(...dets.map(d => d.confidence));\n                if (maxConf > winnerConfidence) {\n                    winnerConfidence = maxConf;\n                    winnerItemId = itemId;\n                    winnerDetections = dets;\n                }\n            }\n            break;\n        }\n\n        case 'average': {\n            // Pick item with highest average confidence\n            for (const [itemId, dets] of byItem) {\n                const avgConf = dets.reduce((sum, d) => sum + d.confidence, 0) / dets.length;\n                if (avgConf > winnerConfidence) {\n                    winnerConfidence = avgConf;\n                    winnerItemId = itemId;\n                    winnerDetections = dets;\n                }\n            }\n            break;\n        }\n\n        case 'weighted': {\n            // Weight by strategy weight\n            for (const [itemId, dets] of byItem) {\n                let totalWeight = 0;\n                let weightedSum = 0;\n                for (const d of dets) {\n                    const weight = STRATEGIES[d.strategyId].weight;\n                    weightedSum += d.confidence * weight;\n                    totalWeight += weight;\n                }\n                const weightedConf = weightedSum / totalWeight;\n                if (weightedConf > winnerConfidence) {\n                    winnerConfidence = weightedConf;\n                    winnerItemId = itemId;\n                    winnerDetections = dets;\n                }\n            }\n            break;\n        }\n    }\n\n    if (!winnerItemId) {\n        return null;\n    }\n\n    // Check minimum agreement\n    const agreement = winnerDetections.length / detections.length;\n    if (winnerDetections.length < config.minAgreement) {\n        // Not enough agreement, reduce confidence\n        winnerConfidence *= agreement;\n    }\n\n    // Find best strategy\n    const bestDet = winnerDetections.reduce((best, d) => (d.confidence > best.confidence ? d : best));\n\n    return {\n        itemId: winnerItemId,\n        confidence: Math.min(0.99, winnerConfidence),\n        position,\n        bestStrategy: bestDet.strategyId,\n        strategyResults: detections,\n        agreement,\n        passesThreshold: passesThreshold(winnerConfidence),\n    };\n}\n\n/**\n * Select optimal strategies for given image conditions\n */\nexport function selectStrategiesForImage(\n    width: number,\n    height: number,\n    sceneType?: 'bright' | 'dark' | 'normal' | 'noisy'\n): StrategyId[] {\n    const profile = getProfileForResolution(width, height);\n    const strategies: StrategyId[] = ['default'];\n\n    // Add precision for high-res images\n    if (profile.tier === 'high' || profile.tier === 'ultra') {\n        strategies.push('high-precision');\n    }\n\n    // Add recall for low-res images (harder to match)\n    if (profile.tier === 'low') {\n        strategies.push('high-recall');\n    }\n\n    // Scene-specific strategies\n    switch (sceneType) {\n        case 'dark':\n            strategies.push('edge-focused');\n            break;\n        case 'bright':\n            strategies.push('color-focused');\n            break;\n        case 'noisy':\n            strategies.push('edge-focused');\n            break;\n    }\n\n    // Limit to 3 strategies for performance\n    return strategies.slice(0, 3);\n}\n\n/**\n * Describe ensemble configuration for debugging\n */\nexport function describeEnsembleConfig(config: EnsembleConfig = activeConfig): string {\n    const lines: string[] = [\n        `Ensemble Configuration:`,\n        `  Strategies: ${config.strategies.join(', ')}`,\n        `  Min Agreement: ${config.minAgreement}`,\n        `  Combine Method: ${config.combineMethod}`,\n        `  Early Exit: ${(config.earlyExitThreshold * 100).toFixed(0)}%`,\n        `  Parallel: ${config.parallel}`,\n        '',\n        'Strategy Details:',\n    ];\n\n    for (const id of config.strategies) {\n        const s = STRATEGIES[id];\n        lines.push(`  ${s.name} (weight=${s.weight}): ${s.description}`);\n    }\n\n    return lines.join('\\n');\n}\n\n/**\n * Get recommended ensemble config based on use case\n */\nexport function getRecommendedConfig(useCase: 'scanning' | 'verification' | 'training' | 'fast'): EnsembleConfig {\n    switch (useCase) {\n        case 'scanning':\n            return DEFAULT_ENSEMBLE_CONFIG;\n        case 'verification':\n            return PRECISION_ENSEMBLE_CONFIG;\n        case 'training':\n            return RECALL_ENSEMBLE_CONFIG;\n        case 'fast':\n            return FAST_ENSEMBLE_CONFIG;\n    }\n}\n","// ========================================\n// CV Active Learning Prompts\n// ========================================\n// Prompts users to verify uncertain detections to improve accuracy\n\nimport type { Item, AllGameData } from '../../types/index.ts';\nimport { logger } from '../logger.ts';\nimport { addCorrection, startFeedbackSession, downloadFeedback, getCorrectionCount } from './training-feedback.ts';\nimport type { DetectionForFeedback } from './training-feedback.ts';\nimport { escapeHtml } from '../utils.ts';\n\n// ========================================\n// Types\n// ========================================\n\n/**\n * An uncertain detection needing verification\n */\nexport interface UncertainDetection {\n    detection: DetectionForFeedback;\n    alternatives: Item[];\n    cropDataUrl?: string;\n}\n\n/**\n * User's verification response\n */\nexport interface VerificationResponse {\n    detectionId: string;\n    isCorrect: boolean;\n    correctedItemId?: string;\n    correctedItemName?: string;\n}\n\n/**\n * Active learning session state\n */\nexport interface ActiveLearningSession {\n    uncertainDetections: UncertainDetection[];\n    currentIndex: number;\n    responses: VerificationResponse[];\n    startedAt: string;\n}\n\n// ========================================\n// Configuration\n// ========================================\n\nconst CONFIG = {\n    UNCERTAINTY_THRESHOLD: 0.6, // Detections below this are uncertain\n    MAX_ALTERNATIVES: 3,\n    MIN_UNCERTAIN_FOR_PROMPT: 2, // Need at least this many uncertain to prompt\n};\n\n// ========================================\n// State\n// ========================================\n\nlet currentSession: ActiveLearningSession | null = null;\nlet allData: AllGameData = {};\n\n// ========================================\n// Initialization\n// ========================================\n\n/**\n * Initialize active learning with game data\n */\nexport function initActiveLearning(gameData: AllGameData): void {\n    allData = gameData;\n}\n\n// ========================================\n// Detection Analysis\n// ========================================\n\n/**\n * Find uncertain detections from a list\n */\nexport function findUncertainDetections(\n    detections: DetectionForFeedback[],\n    threshold: number = CONFIG.UNCERTAINTY_THRESHOLD\n): UncertainDetection[] {\n    const uncertain: UncertainDetection[] = [];\n\n    for (const detection of detections) {\n        if (detection.confidence < threshold) {\n            // Find alternative items that might be correct\n            const alternatives = findAlternatives(detection, CONFIG.MAX_ALTERNATIVES);\n\n            uncertain.push({\n                detection,\n                alternatives,\n                cropDataUrl: detection.cropDataUrl,\n            });\n        }\n    }\n\n    // Sort by confidence (lowest first - most uncertain)\n    uncertain.sort((a, b) => a.detection.confidence - b.detection.confidence);\n\n    return uncertain;\n}\n\n/**\n * Find alternative items for a detection\n */\nfunction findAlternatives(detection: DetectionForFeedback, maxCount: number): Item[] {\n    const items = allData.items?.items || [];\n\n    // Filter out the detected item and score remaining\n    const scored = items\n        .filter(item => item.id !== detection.detectedItemId)\n        .map(item => ({\n            item,\n            score: calculateSimilarityScore(detection, item),\n        }))\n        .filter(({ score }) => score > 0.3) // Only reasonably similar items\n        .sort((a, b) => b.score - a.score);\n\n    return scored.slice(0, maxCount).map(({ item }) => item);\n}\n\n/**\n * Calculate similarity score between detection and potential item\n * Uses name similarity and rarity as heuristics\n */\nfunction calculateSimilarityScore(detection: DetectionForFeedback, item: Item): number {\n    let score = 0;\n\n    // Name similarity (simple substring/edit distance proxy)\n    const detectedName = detection.detectedItemName.toLowerCase();\n    const itemName = item.name.toLowerCase();\n\n    // Exact word match bonus\n    const detectedWords = detectedName.split(/\\s+/);\n    const itemWords = itemName.split(/\\s+/);\n    const commonWords = detectedWords.filter(w => itemWords.includes(w));\n    score += commonWords.length * 0.2;\n\n    // First letter match\n    if (detectedName[0] === itemName[0]) {\n        score += 0.1;\n    }\n\n    // Similar length\n    const lengthDiff = Math.abs(detectedName.length - itemName.length);\n    if (lengthDiff <= 3) {\n        score += 0.1;\n    }\n\n    // Same rarity bonus (items often confused within same rarity)\n    // Note: detection might not have rarity, so this is optional\n    // For now, just use the item's rarity as a small boost\n\n    return Math.min(1, score);\n}\n\n/**\n * Check if we should prompt for active learning\n */\nexport function shouldPromptForLearning(detections: DetectionForFeedback[]): boolean {\n    const uncertain = findUncertainDetections(detections);\n    return uncertain.length >= CONFIG.MIN_UNCERTAIN_FOR_PROMPT;\n}\n\n// ========================================\n// Session Management\n// ========================================\n\n/**\n * Start an active learning session\n */\nexport function startActiveLearningSession(\n    detections: DetectionForFeedback[],\n    imageDataUrl: string,\n    imageWidth: number,\n    imageHeight: number\n): ActiveLearningSession {\n    const uncertainDetections = findUncertainDetections(detections);\n\n    currentSession = {\n        uncertainDetections,\n        currentIndex: 0,\n        responses: [],\n        startedAt: new Date().toISOString(),\n    };\n\n    // Also start a feedback session for collecting corrections\n    startFeedbackSession(imageDataUrl, imageWidth, imageHeight);\n\n    logger.info({\n        operation: 'active_learning.session_started',\n        data: {\n            totalDetections: detections.length,\n            uncertainCount: uncertainDetections.length,\n        },\n    });\n\n    return currentSession;\n}\n\n/**\n * Get current active learning session\n */\nexport function getActiveLearningSession(): ActiveLearningSession | null {\n    return currentSession;\n}\n\n/**\n * Get current uncertain detection\n */\nexport function getCurrentUncertainDetection(): UncertainDetection | null {\n    if (!currentSession || currentSession.currentIndex >= currentSession.uncertainDetections.length) {\n        return null;\n    }\n    return currentSession.uncertainDetections[currentSession.currentIndex] ?? null;\n}\n\n/**\n * Submit verification response\n */\nexport async function submitVerification(response: VerificationResponse): Promise<boolean> {\n    if (!currentSession) return false;\n\n    const current = getCurrentUncertainDetection();\n    if (!current) return false;\n\n    currentSession.responses.push(response);\n\n    // If user corrected the detection, add to feedback\n    if (!response.isCorrect && response.correctedItemId) {\n        const correctItem = allData.items?.items.find(i => i.id === response.correctedItemId);\n        if (correctItem) {\n            await addCorrection(current.detection, correctItem);\n        }\n    }\n\n    // Move to next\n    currentSession.currentIndex++;\n\n    logger.info({\n        operation: 'active_learning.verification_submitted',\n        data: {\n            isCorrect: response.isCorrect,\n            correctedTo: response.correctedItemName || null,\n            remaining: currentSession.uncertainDetections.length - currentSession.currentIndex,\n        },\n    });\n\n    return true;\n}\n\n/**\n * Skip current detection\n */\nexport function skipCurrentDetection(): void {\n    if (!currentSession) return;\n    currentSession.currentIndex++;\n}\n\n/**\n * End active learning session\n */\nexport function endActiveLearningSession(): {\n    totalReviewed: number;\n    correctionsAdded: number;\n    skipped: number;\n} {\n    if (!currentSession) {\n        return { totalReviewed: 0, correctionsAdded: 0, skipped: 0 };\n    }\n\n    const totalReviewed = currentSession.responses.length;\n    const correctionsAdded = currentSession.responses.filter(r => !r.isCorrect && r.correctedItemId).length;\n    const skipped = currentSession.uncertainDetections.length - totalReviewed;\n\n    logger.info({\n        operation: 'active_learning.session_ended',\n        data: { totalReviewed, correctionsAdded, skipped },\n    });\n\n    currentSession = null;\n\n    return { totalReviewed, correctionsAdded, skipped };\n}\n\n// ========================================\n// UI Rendering\n// ========================================\n\n/**\n * Render active learning prompt modal content\n */\nexport function renderActiveLearningPrompt(uncertain: UncertainDetection): string {\n    const { detection, alternatives, cropDataUrl } = uncertain;\n\n    return `\n        <div class=\"active-learning-prompt\">\n            <div class=\"al-header\">\n                <h3>Help Improve Detection Accuracy</h3>\n                <p>We're not sure about this detection. Can you help verify it?</p>\n            </div>\n\n            <div class=\"al-detection\">\n                ${\n                    cropDataUrl\n                        ? `<div class=\"al-crop\"><img src=\"${cropDataUrl}\" alt=\"Detected region\" /></div>`\n                        : '<div class=\"al-crop-placeholder\">No crop available</div>'\n                }\n                <div class=\"al-detected-info\">\n                    <span class=\"al-label\">Detected as:</span>\n                    <span class=\"al-item-name\">${escapeHtml(detection.detectedItemName)}</span>\n                    <span class=\"al-confidence\">${Math.round(detection.confidence * 100)}% confidence</span>\n                </div>\n            </div>\n\n            <div class=\"al-question\">\n                <p>Is this detection correct?</p>\n            </div>\n\n            <div class=\"al-actions\">\n                <button class=\"al-btn al-btn-correct\" data-action=\"correct\">\n                     Yes, it's correct\n                </button>\n                <button class=\"al-btn al-btn-wrong\" data-action=\"wrong\">\n                     No, it's wrong\n                </button>\n                <button class=\"al-btn al-btn-skip\" data-action=\"skip\">\n                    Skip\n                </button>\n            </div>\n\n            ${\n                alternatives.length > 0\n                    ? `\n                <div class=\"al-alternatives\" style=\"display: none;\">\n                    <p>Select the correct item:</p>\n                    <div class=\"al-alternatives-list\">\n                        ${alternatives\n                            .map(\n                                item => `\n                            <button class=\"al-alternative\" data-item-id=\"${item.id}\" data-item-name=\"${escapeHtml(item.name)}\">\n                                ${escapeHtml(item.name)}\n                            </button>\n                        `\n                            )\n                            .join('')}\n                        <button class=\"al-alternative al-other\" data-action=\"other\">\n                            Other...\n                        </button>\n                    </div>\n                </div>\n            `\n                    : ''\n            }\n\n            <div class=\"al-progress\">\n                <span class=\"al-progress-text\"></span>\n            </div>\n        </div>\n    `;\n}\n\n/**\n * Render completion message\n */\nexport function renderCompletionMessage(stats: {\n    totalReviewed: number;\n    correctionsAdded: number;\n    skipped: number;\n}): string {\n    const hasCorrections = getCorrectionCount() > 0;\n\n    return `\n        <div class=\"al-completion\">\n            <div class=\"al-completion-icon\"></div>\n            <h3>Thank You!</h3>\n            <p>Your feedback helps improve detection accuracy for everyone.</p>\n\n            <div class=\"al-completion-stats\">\n                <div class=\"al-stat\">\n                    <span class=\"al-stat-value\">${stats.totalReviewed}</span>\n                    <span class=\"al-stat-label\">Reviewed</span>\n                </div>\n                <div class=\"al-stat\">\n                    <span class=\"al-stat-value\">${stats.correctionsAdded}</span>\n                    <span class=\"al-stat-label\">Corrections</span>\n                </div>\n            </div>\n\n            ${\n                hasCorrections\n                    ? `\n                <div class=\"al-export\">\n                    <p>Would you like to export your corrections to help train the system?</p>\n                    <button class=\"al-btn al-btn-export\" data-action=\"export\">\n                         Export Feedback\n                    </button>\n                </div>\n            `\n                    : ''\n            }\n\n            <button class=\"al-btn al-btn-done\" data-action=\"done\">\n                Done\n            </button>\n        </div>\n    `;\n}\n\n/**\n * Render prompt badge for uncertain detections\n */\nexport function renderUncertainBadge(count: number): string {\n    if (count === 0) return '';\n\n    return `\n        <div class=\"al-badge\" title=\"${count} uncertain detections need verification\">\n            <span class=\"al-badge-icon\">?</span>\n            <span class=\"al-badge-count\">${count}</span>\n        </div>\n    `;\n}\n\n// ========================================\n// Event Handling Helpers\n// ========================================\n\n/**\n * Handle verification action\n */\nexport async function handleVerificationAction(\n    action: string,\n    itemId?: string,\n    itemName?: string\n): Promise<'next' | 'done' | 'alternatives'> {\n    const current = getCurrentUncertainDetection();\n    if (!current) return 'done';\n\n    if (action === 'correct') {\n        await submitVerification({\n            detectionId: current.detection.detectedItemId,\n            isCorrect: true,\n        });\n        return getCurrentUncertainDetection() ? 'next' : 'done';\n    }\n\n    if (action === 'wrong') {\n        return 'alternatives';\n    }\n\n    if (action === 'skip') {\n        skipCurrentDetection();\n        return getCurrentUncertainDetection() ? 'next' : 'done';\n    }\n\n    if (action === 'alternative' && itemId) {\n        await submitVerification({\n            detectionId: current.detection.detectedItemId,\n            isCorrect: false,\n            correctedItemId: itemId,\n            correctedItemName: itemName,\n        });\n        return getCurrentUncertainDetection() ? 'next' : 'done';\n    }\n\n    if (action === 'export') {\n        downloadFeedback();\n        return 'done';\n    }\n\n    return 'done';\n}\n\n// ========================================\n// Reset for testing\n// ========================================\n\nexport function __resetForTesting(): void {\n    currentSession = null;\n    allData = {};\n}\n","// ========================================\n// Item Count Detection Module\n// ========================================\n// Detects stack counts (x2, x3, x5, etc.) on item icons\n// Uses digit recognition and pattern matching\n\nimport { getCountTextRegion } from './resolution-profiles.ts';\n\n/**\n * Simple image data interface\n */\ninterface SimpleImageData {\n    data: Uint8ClampedArray | number[];\n    width: number;\n    height: number;\n}\n\n/**\n * Count detection result\n */\nexport interface CountDetectionResult {\n    /** Detected count (1 = no count detected) */\n    count: number;\n    /** Confidence in the detection */\n    confidence: number;\n    /** Raw text detected (if any) */\n    rawText: string;\n    /** Region where count was found */\n    region: { x: number; y: number; width: number; height: number };\n    /** Method used for detection */\n    method: 'pattern' | 'ocr' | 'none';\n}\n\n/**\n * Digit pattern for recognition\n * Uses 5x7 bitmap representation\n */\ninterface DigitPattern {\n    digit: number;\n    pattern: number[][];\n}\n\n/**\n * Common digit patterns (5 wide x 7 tall)\n * 1 = filled, 0 = empty\n */\nconst DIGIT_PATTERNS: DigitPattern[] = [\n    {\n        digit: 1,\n        pattern: [\n            [0, 0, 1, 0, 0],\n            [0, 1, 1, 0, 0],\n            [0, 0, 1, 0, 0],\n            [0, 0, 1, 0, 0],\n            [0, 0, 1, 0, 0],\n            [0, 0, 1, 0, 0],\n            [0, 1, 1, 1, 0],\n        ],\n    },\n    {\n        digit: 2,\n        pattern: [\n            [0, 1, 1, 1, 0],\n            [1, 0, 0, 0, 1],\n            [0, 0, 0, 0, 1],\n            [0, 0, 1, 1, 0],\n            [0, 1, 0, 0, 0],\n            [1, 0, 0, 0, 0],\n            [1, 1, 1, 1, 1],\n        ],\n    },\n    {\n        digit: 3,\n        pattern: [\n            [0, 1, 1, 1, 0],\n            [1, 0, 0, 0, 1],\n            [0, 0, 0, 0, 1],\n            [0, 0, 1, 1, 0],\n            [0, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [0, 1, 1, 1, 0],\n        ],\n    },\n    {\n        digit: 4,\n        pattern: [\n            [0, 0, 0, 1, 0],\n            [0, 0, 1, 1, 0],\n            [0, 1, 0, 1, 0],\n            [1, 0, 0, 1, 0],\n            [1, 1, 1, 1, 1],\n            [0, 0, 0, 1, 0],\n            [0, 0, 0, 1, 0],\n        ],\n    },\n    {\n        digit: 5,\n        pattern: [\n            [1, 1, 1, 1, 1],\n            [1, 0, 0, 0, 0],\n            [1, 1, 1, 1, 0],\n            [0, 0, 0, 0, 1],\n            [0, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [0, 1, 1, 1, 0],\n        ],\n    },\n    {\n        digit: 6,\n        pattern: [\n            [0, 0, 1, 1, 0],\n            [0, 1, 0, 0, 0],\n            [1, 0, 0, 0, 0],\n            [1, 1, 1, 1, 0],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [0, 1, 1, 1, 0],\n        ],\n    },\n    {\n        digit: 7,\n        pattern: [\n            [1, 1, 1, 1, 1],\n            [0, 0, 0, 0, 1],\n            [0, 0, 0, 1, 0],\n            [0, 0, 1, 0, 0],\n            [0, 1, 0, 0, 0],\n            [0, 1, 0, 0, 0],\n            [0, 1, 0, 0, 0],\n        ],\n    },\n    {\n        digit: 8,\n        pattern: [\n            [0, 1, 1, 1, 0],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [0, 1, 1, 1, 0],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [0, 1, 1, 1, 0],\n        ],\n    },\n    {\n        digit: 9,\n        pattern: [\n            [0, 1, 1, 1, 0],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [0, 1, 1, 1, 1],\n            [0, 0, 0, 0, 1],\n            [0, 0, 0, 1, 0],\n            [0, 1, 1, 0, 0],\n        ],\n    },\n    {\n        digit: 0,\n        pattern: [\n            [0, 1, 1, 1, 0],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [1, 0, 0, 0, 1],\n            [0, 1, 1, 1, 0],\n        ],\n    },\n];\n\n/**\n * Extract a region from image data\n */\nfunction extractRegion(\n    imageData: SimpleImageData,\n    x: number,\n    y: number,\n    width: number,\n    height: number\n): SimpleImageData {\n    const data = new Uint8ClampedArray(width * height * 4);\n\n    for (let dy = 0; dy < height; dy++) {\n        for (let dx = 0; dx < width; dx++) {\n            const srcX = x + dx;\n            const srcY = y + dy;\n\n            if (srcX >= 0 && srcX < imageData.width && srcY >= 0 && srcY < imageData.height) {\n                const srcIdx = (srcY * imageData.width + srcX) * 4;\n                const dstIdx = (dy * width + dx) * 4;\n\n                data[dstIdx] = imageData.data[srcIdx] ?? 0;\n                data[dstIdx + 1] = imageData.data[srcIdx + 1] ?? 0;\n                data[dstIdx + 2] = imageData.data[srcIdx + 2] ?? 0;\n                data[dstIdx + 3] = imageData.data[srcIdx + 3] ?? 255;\n            }\n        }\n    }\n\n    return { data, width, height };\n}\n\n/**\n * Convert region to binary (black/white) image\n * Count text is typically light on dark or white on transparent\n * @internal Reserved for future digit recognition enhancements\n */\nexport function binarize(imageData: SimpleImageData, threshold: number = 128): boolean[][] {\n    const result: boolean[][] = [];\n\n    for (let y = 0; y < imageData.height; y++) {\n        const row: boolean[] = [];\n        for (let x = 0; x < imageData.width; x++) {\n            const idx = (y * imageData.width + x) * 4;\n            const r = imageData.data[idx] ?? 0;\n            const g = imageData.data[idx + 1] ?? 0;\n            const b = imageData.data[idx + 2] ?? 0;\n            const gray = (r + g + b) / 3;\n            row.push(gray > threshold);\n        }\n        result.push(row);\n    }\n\n    return result;\n}\n\n/**\n * Find bright (white/yellow) text pixels - typical for count overlays\n */\nfunction findBrightTextPixels(imageData: SimpleImageData): boolean[][] {\n    const result: boolean[][] = [];\n\n    for (let y = 0; y < imageData.height; y++) {\n        const row: boolean[] = [];\n        for (let x = 0; x < imageData.width; x++) {\n            const idx = (y * imageData.width + x) * 4;\n            const r = imageData.data[idx] ?? 0;\n            const g = imageData.data[idx + 1] ?? 0;\n            const b = imageData.data[idx + 2] ?? 0;\n\n            // Look for white, light gray, yellow, or light text\n            const isWhite = r > 200 && g > 200 && b > 200;\n            const isYellow = r > 200 && g > 180 && b < 100;\n            const isLight = (r + g + b) / 3 > 180;\n\n            row.push(isWhite || isYellow || isLight);\n        }\n        result.push(row);\n    }\n\n    return result;\n}\n\n/**\n * Resize binary image to target size using nearest neighbor\n */\nfunction resizeBinary(binary: boolean[][], targetWidth: number, targetHeight: number): boolean[][] {\n    const srcHeight = binary.length;\n    const srcWidth = binary[0]?.length ?? 0;\n\n    if (srcWidth === 0 || srcHeight === 0) {\n        return Array(targetHeight)\n            .fill(null)\n            .map(() => Array(targetWidth).fill(false));\n    }\n\n    const result: boolean[][] = [];\n\n    for (let y = 0; y < targetHeight; y++) {\n        const row: boolean[] = [];\n        const srcY = Math.floor((y * srcHeight) / targetHeight);\n\n        for (let x = 0; x < targetWidth; x++) {\n            const srcX = Math.floor((x * srcWidth) / targetWidth);\n            row.push(binary[srcY]?.[srcX] ?? false);\n        }\n        result.push(row);\n    }\n\n    return result;\n}\n\n/**\n * Calculate match score between binary image and digit pattern\n */\nfunction matchPattern(binary: boolean[][], pattern: number[][]): number {\n    const patternHeight = pattern.length;\n    const patternWidth = pattern[0]?.length ?? 0;\n\n    // Resize binary to pattern size\n    const resized = resizeBinary(binary, patternWidth, patternHeight);\n\n    let matches = 0;\n    let total = 0;\n\n    for (let y = 0; y < patternHeight; y++) {\n        for (let x = 0; x < patternWidth; x++) {\n            const expected = (pattern[y]?.[x] ?? 0) === 1;\n            const actual = resized[y]?.[x] ?? false;\n\n            if (expected === actual) {\n                matches++;\n            }\n            total++;\n        }\n    }\n\n    return matches / total;\n}\n\n/**\n * Find connected components in binary image (for digit segmentation)\n */\nfunction findComponents(binary: boolean[][]): { x: number; y: number; width: number; height: number }[] {\n    const height = binary.length;\n    const width = binary[0]?.length ?? 0;\n    const visited = Array(height)\n        .fill(null)\n        .map(() => Array(width).fill(false));\n    const components: { x: number; y: number; width: number; height: number }[] = [];\n\n    for (let startY = 0; startY < height; startY++) {\n        for (let startX = 0; startX < width; startX++) {\n            if (binary[startY]?.[startX] && !visited[startY]?.[startX]) {\n                // BFS to find component bounds\n                let minX = startX,\n                    maxX = startX;\n                let minY = startY,\n                    maxY = startY;\n                const queue: [number, number][] = [[startX, startY]];\n                const visitedRow = visited[startY];\n                if (visitedRow) visitedRow[startX] = true;\n\n                while (queue.length > 0) {\n                    const coord = queue.shift()!;\n                    const x = coord[0];\n                    const y = coord[1];\n\n                    minX = Math.min(minX, x);\n                    maxX = Math.max(maxX, x);\n                    minY = Math.min(minY, y);\n                    maxY = Math.max(maxY, y);\n\n                    // Check neighbors\n                    const neighbors = [\n                        [-1, 0],\n                        [1, 0],\n                        [0, -1],\n                        [0, 1],\n                    ] as const;\n                    for (const delta of neighbors) {\n                        const nx = x + delta[0];\n                        const ny = y + delta[1];\n\n                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {\n                            if (binary[ny]?.[nx] && !visited[ny]?.[nx]) {\n                                if (visited[ny]) visited[ny][nx] = true;\n                                queue.push([nx, ny]);\n                            }\n                        }\n                    }\n                }\n\n                const compWidth = maxX - minX + 1;\n                const compHeight = maxY - minY + 1;\n\n                // Filter out noise (too small or too large)\n                if (compWidth >= 3 && compHeight >= 5 && compWidth <= width / 2) {\n                    components.push({ x: minX, y: minY, width: compWidth, height: compHeight });\n                }\n            }\n        }\n    }\n\n    // Sort left to right\n    components.sort((a, b) => a.x - b.x);\n\n    return components;\n}\n\n/**\n * Extract sub-region from binary image\n */\nfunction extractBinaryRegion(binary: boolean[][], x: number, y: number, width: number, height: number): boolean[][] {\n    const result: boolean[][] = [];\n\n    for (let dy = 0; dy < height; dy++) {\n        const row: boolean[] = [];\n        for (let dx = 0; dx < width; dx++) {\n            row.push(binary[y + dy]?.[x + dx] ?? false);\n        }\n        result.push(row);\n    }\n\n    return result;\n}\n\n/**\n * Recognize a digit from binary image\n */\nfunction recognizeDigit(binary: boolean[][]): { digit: number; confidence: number } | null {\n    let bestMatch = -1;\n    let bestScore = 0;\n\n    for (const { digit, pattern } of DIGIT_PATTERNS) {\n        const score = matchPattern(binary, pattern);\n        if (score > bestScore) {\n            bestScore = score;\n            bestMatch = digit;\n        }\n    }\n\n    if (bestScore < 0.5) {\n        return null;\n    }\n\n    return { digit: bestMatch, confidence: bestScore };\n}\n\n/**\n * Check if region contains an \"x\" prefix (as in \"x3\")\n */\nfunction hasXPrefix(binary: boolean[][]): boolean {\n    const height = binary.length;\n    const width = binary[0]?.length ?? 0;\n\n    if (width < 5 || height < 5) return false;\n\n    // Look for diagonal patterns characteristic of \"x\"\n    let diagonalCount = 0;\n    const midY = Math.floor(height / 2);\n    const midX = Math.floor(width / 2);\n\n    // Check for \\ diagonal\n    for (let i = -2; i <= 2; i++) {\n        const y = midY + i;\n        const x = midX + i;\n        if (y >= 0 && y < height && x >= 0 && x < width) {\n            if (binary[y]?.[x]) diagonalCount++;\n        }\n    }\n\n    // Check for / diagonal\n    for (let i = -2; i <= 2; i++) {\n        const y = midY + i;\n        const x = midX - i;\n        if (y >= 0 && y < height && x >= 0 && x < width) {\n            if (binary[y]?.[x]) diagonalCount++;\n        }\n    }\n\n    return diagonalCount >= 6;\n}\n\n/**\n * Detect item count in a cell\n */\nexport function detectCount(\n    imageData: SimpleImageData,\n    cellX: number,\n    cellY: number,\n    cellWidth: number,\n    cellHeight: number,\n    screenHeight: number = 1080\n): CountDetectionResult {\n    // Get the count text region\n    const region = getCountTextRegion(cellX, cellY, cellWidth, cellHeight, screenHeight);\n\n    // Make sure region is within image bounds\n    const clampedRegion = {\n        x: Math.max(0, Math.min(region.x, imageData.width - 1)),\n        y: Math.max(0, Math.min(region.y, imageData.height - 1)),\n        width: Math.min(region.width, imageData.width - region.x),\n        height: Math.min(region.height, imageData.height - region.y),\n    };\n\n    if (clampedRegion.width < 3 || clampedRegion.height < 3) {\n        return {\n            count: 1,\n            confidence: 0,\n            rawText: '',\n            region: clampedRegion,\n            method: 'none',\n        };\n    }\n\n    // Extract the region\n    const regionData = extractRegion(\n        imageData,\n        clampedRegion.x,\n        clampedRegion.y,\n        clampedRegion.width,\n        clampedRegion.height\n    );\n\n    // Find bright text pixels\n    const binary = findBrightTextPixels(regionData);\n\n    // Find connected components (potential digits)\n    const components = findComponents(binary);\n\n    if (components.length === 0) {\n        return {\n            count: 1,\n            confidence: 0,\n            rawText: '',\n            region: clampedRegion,\n            method: 'none',\n        };\n    }\n\n    // Try to recognize digits\n    let digits: number[] = [];\n    let totalConfidence = 0;\n    let hasX = false;\n\n    for (const comp of components) {\n        const compBinary = extractBinaryRegion(binary, comp.x, comp.y, comp.width, comp.height);\n\n        // Check for \"x\" prefix\n        if (!hasX && hasXPrefix(compBinary)) {\n            hasX = true;\n            continue;\n        }\n\n        // Try to recognize as digit\n        const result = recognizeDigit(compBinary);\n        if (result) {\n            digits.push(result.digit);\n            totalConfidence += result.confidence;\n        }\n    }\n\n    if (digits.length === 0) {\n        return {\n            count: 1,\n            confidence: 0,\n            rawText: hasX ? 'x?' : '',\n            region: clampedRegion,\n            method: 'none',\n        };\n    }\n\n    // Combine digits into number\n    let count = 0;\n    for (const d of digits) {\n        count = count * 10 + d;\n    }\n\n    // Sanity check - counts are typically 1-99\n    if (count < 1 || count > 99) {\n        count = 1;\n        totalConfidence = 0;\n    }\n\n    const avgConfidence = totalConfidence / digits.length;\n\n    return {\n        count,\n        confidence: avgConfidence,\n        rawText: (hasX ? 'x' : '') + digits.join(''),\n        region: clampedRegion,\n        method: 'pattern',\n    };\n}\n\n/**\n * Quick check if a cell likely has a count overlay\n * Faster than full detection, useful for filtering\n */\nexport function hasCountOverlay(\n    imageData: SimpleImageData,\n    cellX: number,\n    cellY: number,\n    cellWidth: number,\n    cellHeight: number,\n    screenHeight: number = 1080\n): boolean {\n    const region = getCountTextRegion(cellX, cellY, cellWidth, cellHeight, screenHeight);\n\n    // Check for bright pixels in count region\n    let brightCount = 0;\n    const threshold = 0.1; // 10% bright pixels suggests text\n\n    for (let y = region.y; y < region.y + region.height && y < imageData.height; y++) {\n        for (let x = region.x; x < region.x + region.width && x < imageData.width; x++) {\n            const idx = (y * imageData.width + x) * 4;\n            const r = imageData.data[idx] ?? 0;\n            const g = imageData.data[idx + 1] ?? 0;\n            const b = imageData.data[idx + 2] ?? 0;\n\n            if (r > 200 && g > 200 && b > 200) {\n                brightCount++;\n            }\n        }\n    }\n\n    const regionSize = region.width * region.height;\n    return brightCount / regionSize > threshold;\n}\n\n/**\n * Batch detect counts for multiple cells\n */\nexport function detectCounts(\n    imageData: SimpleImageData,\n    cells: Array<{ x: number; y: number; width: number; height: number }>,\n    screenHeight: number = 1080\n): CountDetectionResult[] {\n    return cells.map(cell => detectCount(imageData, cell.x, cell.y, cell.width, cell.height, screenHeight));\n}\n\n/**\n * Common stack sizes in the game\n * Used to validate and correct detected counts\n */\nexport const COMMON_STACK_SIZES = [1, 2, 3, 4, 5, 10, 15, 20, 25, 50, 99];\n\n/**\n * Correct potentially misread count to nearest common stack size\n */\nexport function correctToCommonStack(count: number, confidence: number): number {\n    // High confidence - trust the detection\n    if (confidence > 0.8) return count;\n\n    // Low confidence - check if close to common value\n    for (const common of COMMON_STACK_SIZES) {\n        if (Math.abs(count - common) <= 1) {\n            return common;\n        }\n    }\n\n    return count;\n}\n","// ========================================\n// Detection Pipeline - Main Orchestration\n// ========================================\n\nimport type { CVDetectionResult, ROI } from '../types.ts';\nimport { logger } from '../../logger.ts';\nimport { detectResolution } from '../../test-utils.ts';\nimport { getAllData, getItemTemplates, isPriorityTemplatesLoaded } from '../state.ts';\nimport { loadItemTemplates } from '../templates.ts';\nimport { getMetricsCollector } from '../metrics.ts';\nimport { selectStrategiesForImage } from '../ensemble-detector.ts';\nimport { getResolutionTier } from '../resolution-profiles.ts';\nimport { findUncertainDetections, shouldPromptForLearning } from '../active-learning.ts';\nimport { detectCount, hasCountOverlay } from '../count-detection.ts';\nimport {\n    getDynamicMinConfidence,\n    isCVDetectionInProgress,\n    setCVDetectionInProgress,\n} from '../detection-config.ts';\nimport { hashImageDataUrl } from '../detection-utils.ts';\nimport {\n    detectHotbarRegion,\n    getAdaptiveIconSizes,\n    verifyGridPattern,\n    detectGridPositions,\n} from '../detection-grid.ts';\nimport {\n    loadImageToCanvas,\n    getCachedResults,\n    cacheResults,\n    boostConfidenceWithContext,\n    validateWithBorderRarity,\n} from '../detection-processing.ts';\n\n// Import from sibling modules\nimport { detectIconsWithTwoPhase } from './two-phase.ts';\nimport { detectIconsWithSlidingWindow, detectEquipmentRegion } from './sliding-window.ts';\nimport { detectItemsWithWorkers } from './worker-detection.ts';\nimport type { ProgressCallback } from './types.ts';\n\n/**\n * Detect items using template matching against stored item icons\n * Uses smart sliding window detection to find icons anywhere on screen\n */\nexport async function detectItemsWithCV(\n    imageDataUrl: string,\n    progressCallback?: ProgressCallback,\n    useWorkers: boolean = false\n): Promise<CVDetectionResult[]> {\n    // Race condition fix: Prevent concurrent CV detection runs\n    // Multiple simultaneous calls would corrupt metrics and cause confusing progress updates\n    if (isCVDetectionInProgress()) {\n        logger.warn({\n            operation: 'cv.detect_concurrent_rejected',\n            data: { message: 'CV detection already in progress' },\n        });\n        // Return empty results rather than corrupt state\n        return [];\n    }\n    setCVDetectionInProgress(true);\n\n    const metrics = getMetricsCollector();\n    const runStartTime = performance.now();\n\n    try {\n        // Check cache first\n        const imageHash = hashImageDataUrl(imageDataUrl);\n        const cachedResults = getCachedResults(imageHash);\n\n        if (cachedResults) {\n            logger.info({\n                operation: 'cv.cache_hit',\n                data: { imageHash, resultCount: cachedResults.length },\n            });\n\n            if (progressCallback) {\n                progressCallback(100, 'Loaded from cache (instant)');\n            }\n\n            return cachedResults;\n        }\n\n        if (progressCallback) {\n            progressCallback(0, 'Loading image...');\n        }\n\n        // Ensure templates are loaded (at least priority ones)\n        if (!isPriorityTemplatesLoaded()) {\n            if (progressCallback) {\n                progressCallback(5, 'Loading item templates...');\n            }\n            await loadItemTemplates();\n        }\n\n        const { ctx, width, height } = await loadImageToCanvas(imageDataUrl);\n\n        // Start metrics collection for this run\n        const resolution = detectResolution(width, height);\n        metrics.startRun(width, height, resolution.category);\n\n        // Select optimal detection strategies based on resolution\n        const selectedStrategies = selectStrategiesForImage(width, height);\n        const resolutionTier = getResolutionTier(width, height);\n        logger.info({\n            operation: 'cv.strategy_selection',\n            data: {\n                resolutionTier,\n                selectedStrategies,\n                dynamicThreshold: getDynamicMinConfidence(width, height),\n            },\n        });\n\n        if (progressCallback) {\n            progressCallback(15, 'Analyzing image structure...');\n        }\n\n        const items = getAllData().items?.items || [];\n        const itemTemplates = getItemTemplates();\n\n        // Log detection start with details\n        logger.info({\n            operation: 'cv.detect_start',\n            data: {\n                imageWidth: width,\n                imageHeight: height,\n                templatesLoaded: itemTemplates.size,\n                mode: 'sliding_window',\n            },\n        });\n\n        // Use workers for parallel processing if enabled (legacy path)\n        if (useWorkers) {\n            const gridPositions = detectGridPositions(width, height);\n            logger.info({\n                operation: 'cv.detect_items_workers',\n                data: { gridPositions: gridPositions.length, workers: 4 },\n            });\n\n            const workerResults = await detectItemsWithWorkers(ctx, gridPositions, items, progressCallback);\n\n            if (progressCallback) {\n                progressCallback(100, 'Worker processing complete');\n            }\n\n            logger.info({\n                operation: 'cv.detect_items_workers_complete',\n                data: {\n                    detectionsCount: workerResults.length,\n                    gridPositions: gridPositions.length,\n                },\n            });\n\n            // Cache worker results\n            cacheResults(imageHash, workerResults);\n\n            return workerResults;\n        }\n\n        // NEW: Two-phase detection strategy\n        // Phase 1: Try fast grid-based detection first\n        // Phase 2: Fall back to sliding window if grid detection fails\n        if (progressCallback) {\n            progressCallback(18, 'Attempting two-phase grid detection...');\n        }\n\n        const twoPhaseResult = await detectIconsWithTwoPhase(ctx, width, height, items, {\n            minConfidence: getDynamicMinConfidence(width, height),\n            progressCallback,\n        });\n\n        let hotbarDetections: CVDetectionResult[];\n\n        if (twoPhaseResult.gridUsed && twoPhaseResult.detections.length > 0) {\n            // Two-phase detection succeeded\n            hotbarDetections = twoPhaseResult.detections;\n            logger.info({\n                operation: 'cv.two_phase_success',\n                data: {\n                    detections: hotbarDetections.length,\n                    gridColumns: twoPhaseResult.grid?.columns || 0,\n                    gridRows: twoPhaseResult.grid?.rows || 0,\n                },\n            });\n        } else {\n            // Fall back to sliding window\n            logger.info({\n                operation: 'cv.two_phase_fallback',\n                data: {\n                    reason: !twoPhaseResult.gridUsed ? 'grid_detection_failed' : 'no_detections',\n                },\n            });\n\n            if (progressCallback) {\n                progressCallback(25, 'Falling back to sliding window...');\n            }\n\n            const detectedHotbar = detectHotbarRegion(ctx, width, height);\n\n            // Use detected hotbar region, with fallback\n            const hotbarROI: ROI = {\n                x: 0,\n                y: detectedHotbar.confidence > 0.3 ? detectedHotbar.topY : Math.floor(height * 0.8),\n                width: width,\n                height:\n                    detectedHotbar.confidence > 0.3\n                        ? detectedHotbar.bottomY - detectedHotbar.topY\n                        : Math.floor(height * 0.2),\n                label: 'hotbar_region',\n            };\n\n            logger.info({\n                operation: 'cv.hotbar_detection',\n                data: {\n                    detected: detectedHotbar,\n                    usingROI: hotbarROI,\n                },\n            });\n\n            hotbarDetections = await detectIconsWithSlidingWindow(ctx, width, height, items, {\n                stepSize: 10,\n                minConfidence: getDynamicMinConfidence(width, height),\n                regionOfInterest: hotbarROI,\n                progressCallback,\n            });\n        }\n\n        // Scan equipment region (top-left for weapons/tomes)\n        const equipmentDetections = await detectEquipmentRegion(ctx, width, height, items, progressCallback);\n\n        // Combine all detections\n        const allDetections = [...hotbarDetections, ...equipmentDetections];\n\n        if (progressCallback) {\n            progressCallback(88, 'Verifying grid pattern...');\n        }\n\n        // Apply geometric grid verification to filter outliers\n        const iconSizes = getAdaptiveIconSizes(width, height);\n        const expectedIconSize = iconSizes[1] || 48;\n        const gridVerification = verifyGridPattern(allDetections, expectedIconSize);\n        let verifiedDetections = gridVerification.isValid ? gridVerification.filteredDetections : allDetections;\n\n        // Record grid verification metrics\n        metrics.recordGridVerification(allDetections.length, verifiedDetections.length);\n\n        if (progressCallback) {\n            progressCallback(92, 'Applying context boosting...');\n        }\n\n        // Apply confidence boosting with game context\n        let boostedDetections = boostConfidenceWithContext(verifiedDetections);\n\n        if (progressCallback) {\n            progressCallback(96, 'Validating with border rarity...');\n        }\n\n        // Validate detections with border rarity check (stronger validation)\n        // Filter out null results (rejected by strict rarity validation)\n        const validationStartTime = performance.now();\n        boostedDetections = boostedDetections\n            .map(detection => {\n                const validated = validateWithBorderRarity(detection, ctx, false);\n                // Record validation result\n                if (validated === null) {\n                    metrics.recordRarityValidation(false, true);\n                } else if (validated.confidence > detection.confidence) {\n                    metrics.recordRarityValidation(true, false);\n                } else {\n                    metrics.recordRarityValidation(false, false);\n                }\n                return validated;\n            })\n            .filter((d): d is CVDetectionResult => d !== null);\n        metrics.recordValidationTime(performance.now() - validationStartTime);\n\n        // Detect item counts (stack sizes like x2, x3, x5)\n        if (progressCallback) {\n            progressCallback(98, 'Detecting item counts...');\n        }\n        const imageData = ctx.getImageData(0, 0, width, height);\n        for (const detection of boostedDetections) {\n            if (detection.position) {\n                const { x, y, width: cellW, height: cellH } = detection.position;\n                // Quick check if count overlay might exist\n                if (hasCountOverlay(imageData, x, y, cellW, cellH, height)) {\n                    const countResult = detectCount(imageData, x, y, cellW, cellH, height);\n                    if (countResult.count > 1 && countResult.confidence > 0.5) {\n                        // Add count to detection metadata\n                        (\n                            detection as CVDetectionResult & { stackCount?: number; countConfidence?: number }\n                        ).stackCount = countResult.count;\n                        (\n                            detection as CVDetectionResult & { stackCount?: number; countConfidence?: number }\n                        ).countConfidence = countResult.confidence;\n                    }\n                }\n            }\n        }\n\n        if (progressCallback) {\n            progressCallback(100, 'Smart detection complete');\n        }\n\n        // Log detailed results\n        const logData: Record<string, unknown> = {\n            detectionsCount: boostedDetections.length,\n            hotbarDetections: hotbarDetections.length,\n            equipmentDetections: equipmentDetections.length,\n            mode: twoPhaseResult.gridUsed ? 'two_phase_grid' : 'sliding_window',\n            gridUsed: twoPhaseResult.gridUsed,\n        };\n\n        // If nothing detected, add debug hints\n        if (boostedDetections.length === 0) {\n            logData.debugHint = 'No icons detected - ensure screenshot shows game UI with item icons';\n            logData.suggestion = 'Try taking screenshot during gameplay with hotbar visible';\n        } else {\n            logData.detectedItems = boostedDetections.slice(0, 5).map(d => d.entity.name);\n        }\n\n        logger.info({\n            operation: 'cv.detect_items_smart',\n            data: logData,\n        });\n\n        // Cache results for future use\n        cacheResults(imageHash, boostedDetections);\n\n        // Active learning: flag uncertain detections for potential user feedback\n        // Convert CVDetectionResult to DetectionForFeedback format\n        const feedbackDetections = boostedDetections\n            .filter(d => d.position) // Need position for feedback\n            .map(d => ({\n                detectedItemId: d.entity.id,\n                detectedItemName: d.entity.name,\n                confidence: d.confidence,\n                x: d.position!.x,\n                y: d.position!.y,\n                width: d.position!.width,\n                height: d.position!.height,\n            }));\n        const uncertainDetections = findUncertainDetections(feedbackDetections);\n        if (uncertainDetections.length > 0 && shouldPromptForLearning(feedbackDetections)) {\n            logger.info({\n                operation: 'cv.active_learning.uncertain_found',\n                data: {\n                    uncertainCount: uncertainDetections.length,\n                    totalDetections: boostedDetections.length,\n                    topUncertain: uncertainDetections.slice(0, 3).map(u => ({\n                        item: u.detection.detectedItemName,\n                        confidence: u.detection.confidence.toFixed(2),\n                        alternatives: u.alternatives.length,\n                    })),\n                },\n            });\n        }\n\n        // End metrics run\n        metrics.endRun(performance.now() - runStartTime);\n\n        return boostedDetections;\n    } catch (error) {\n        logger.error({\n            operation: 'cv.detect_items',\n            error: {\n                name: (error as Error).name,\n                message: (error as Error).message,\n            },\n        });\n        // End metrics run even on error\n        metrics.endRun(performance.now() - runStartTime);\n        throw error;\n    } finally {\n        // Race condition fix: Always release lock when done\n        setCVDetectionInProgress(false);\n    }\n}\n\n/**\n * Reset detection state for testing\n * @internal\n */\nexport function __resetDetectionStateForTesting(): void {\n    setCVDetectionInProgress(false);\n}\n","// ========================================\n// Detection Pipeline - Worker-based Detection\n// ========================================\n\nimport type { Item } from '../../../types/index.ts';\nimport type { CVDetectionResult, ROI } from '../types.ts';\nimport { getItemTemplates } from '../state.ts';\nimport { getWorkerPath } from '../detection-config.ts';\nimport { extractIconRegion } from '../detection-utils.ts';\nimport type { WorkerMatchResult, ProgressCallback } from './types.ts';\n\n/**\n * Detect items using Web Workers for parallel processing (optional)\n * Offloads template matching to workers to avoid blocking UI\n */\nexport async function detectItemsWithWorkers(\n    ctx: CanvasRenderingContext2D,\n    gridPositions: ROI[],\n    items: Item[],\n    progressCallback?: ProgressCallback\n): Promise<CVDetectionResult[]> {\n    const itemTemplates = getItemTemplates();\n    // Create worker pool (4 workers for parallel processing)\n    const workerCount = 4;\n    const workers: Worker[] = [];\n\n    try {\n        // Initialize workers\n        for (let i = 0; i < workerCount; i++) {\n            workers.push(new Worker(getWorkerPath('template-matcher-worker.js')));\n        }\n\n        // Prepare template data for workers (serialize ImageData)\n        const templateData = items\n            .map(item => {\n                const template = itemTemplates.get(item.id);\n                if (!template) return null;\n\n                const imageData = template.ctx.getImageData(0, 0, template.width, template.height);\n\n                return {\n                    itemId: item.id,\n                    itemName: item.name,\n                    imageData: {\n                        width: imageData.width,\n                        height: imageData.height,\n                        data: Array.from(imageData.data), // Convert Uint8ClampedArray to regular array\n                    },\n                };\n            })\n            .filter(t => t !== null);\n\n        // Split cells into batches for workers\n        const batchSize = Math.ceil(gridPositions.length / workerCount);\n        const batches: ROI[][] = [];\n\n        for (let i = 0; i < gridPositions.length; i += batchSize) {\n            batches.push(gridPositions.slice(i, i + batchSize));\n        }\n\n        // Send batches to workers and collect results\n        const batchPromises = batches.map((batch, batchIndex) => {\n            return new Promise<WorkerMatchResult[]>(resolve => {\n                const worker = workers[batchIndex % workerCount];\n\n                // Prepare cell data\n                const cells = batch.map((cell, index) => {\n                    const iconRegion = extractIconRegion(ctx, cell);\n\n                    return {\n                        index,\n                        position: cell,\n                        imageData: {\n                            width: iconRegion.width,\n                            height: iconRegion.height,\n                            data: Array.from(iconRegion.data),\n                        },\n                    };\n                });\n\n                // Listen for response\n                const handler = (e: MessageEvent) => {\n                    if (e.data.type === 'BATCH_COMPLETE' && e.data.data.batchId === batchIndex) {\n                        worker?.removeEventListener('message', handler);\n                        resolve(e.data.data.results);\n                    }\n                };\n\n                worker?.addEventListener('message', handler);\n\n                // Send batch to worker\n                worker?.postMessage({\n                    type: 'MATCH_BATCH',\n                    data: {\n                        batchId: batchIndex,\n                        cells,\n                        templates: templateData,\n                    },\n                });\n            });\n        });\n\n        // Wait for all batches to complete\n        if (progressCallback) {\n            progressCallback(60, 'Processing with workers...');\n        }\n\n        const allResults = await Promise.all(batchPromises);\n\n        // Flatten results\n        const flatResults = allResults.flat();\n\n        // Convert to CVDetectionResult format\n        const detections: CVDetectionResult[] = flatResults\n            .map(result => {\n                const item = items.find(i => i.id === result.itemId);\n                if (!item) return null;\n\n                return {\n                    type: 'item' as const,\n                    entity: item,\n                    confidence: result.similarity,\n                    position: result.position,\n                    method: 'template_match' as const,\n                };\n            })\n            .filter(d => d !== null) as CVDetectionResult[];\n\n        return detections;\n    } finally {\n        // Terminate all workers\n        workers.forEach(w => w.terminate());\n    }\n}\n","// ========================================\n// CV UI Region Detection\n// ========================================\n\nimport { logger } from '../logger.ts';\nimport { detectResolution, detectUILayout } from '../test-utils.ts';\nimport type { ROI } from './types.ts';\n\n// ========================================\n// Screen Type Detection\n// ========================================\n\n/**\n * Detect if screenshot shows pause menu or gameplay by analyzing bottom hotbar region\n * Gameplay has colorful icons at bottom, pause menu has empty/dark bottom\n */\nexport function detectScreenType(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    height: number\n): 'pause_menu' | 'gameplay' {\n    // Sample bottom 20% of screen (where hotbar is during gameplay)\n    const hotbarY = Math.floor(height * 0.8);\n    const hotbarHeight = height - hotbarY;\n    const imageData = ctx.getImageData(0, hotbarY, width, hotbarHeight);\n    const pixels = imageData.data;\n\n    // Calculate brightness and color variance\n    let totalBrightness = 0;\n    let totalVariance = 0;\n    let sampleCount = 0;\n\n    // Sample every 10th pixel for performance\n    for (let i = 0; i < pixels.length; i += 40) {\n        // 40 = 10 pixels * 4 channels (RGBA)\n        const r = pixels[i] ?? 0;\n        const g = pixels[i + 1] ?? 0;\n        const b = pixels[i + 2] ?? 0;\n        const a = pixels[i + 3] ?? 0;\n\n        // Skip transparent pixels\n        if (a < 128) continue;\n\n        // Brightness (0-255)\n        const brightness = (r + g + b) / 3;\n        totalBrightness += brightness;\n\n        // Color variance (how different are R, G, B from each other)\n        const mean = brightness;\n        const variance = Math.pow(r - mean, 2) + Math.pow(g - mean, 2) + Math.pow(b - mean, 2);\n        totalVariance += variance;\n\n        sampleCount++;\n    }\n\n    if (sampleCount === 0) {\n        // No pixels sampled, assume pause menu (fully transparent bottom)\n        return 'pause_menu';\n    }\n\n    const avgBrightness = totalBrightness / sampleCount;\n    const avgVariance = totalVariance / sampleCount;\n\n    // Thresholds:\n    // - Gameplay: Bright colorful icons (brightness > 80, variance > 1000)\n    // - Pause menu: Dark or uniform bottom (brightness < 60 or variance < 800)\n    const isGameplay = avgBrightness > 70 && avgVariance > 900;\n\n    logger.info({\n        operation: 'cv.detect_screen_type',\n        data: {\n            avgBrightness: Math.round(avgBrightness),\n            avgVariance: Math.round(avgVariance),\n            sampleCount,\n            screenType: isGameplay ? 'gameplay' : 'pause_menu',\n        },\n    });\n\n    return isGameplay ? 'gameplay' : 'pause_menu';\n}\n\n// ========================================\n// UI Region Detection\n// ========================================\n\n/**\n * Detect UI regions (for finding inventory, stats, etc.)\n * Adapts to different UI layouts (PC vs Steam Deck)\n *\n * @param ctxOrWidth - Canvas context for screen type detection, or width if called without context\n * @param widthOrHeight - Width if ctx provided, or height if called without context\n * @param height - Height (only used when ctx is provided)\n */\nexport function detectUIRegions(\n    ctxOrWidth: CanvasRenderingContext2D | number,\n    widthOrHeight: number,\n    height?: number\n): { inventory?: ROI; stats?: ROI; character?: ROI; pauseMenu?: ROI; gameplay?: ROI } {\n    // Handle both signatures: detectUIRegions(ctx, width, height) or detectUIRegions(width, height)\n    let ctx: CanvasRenderingContext2D | null = null;\n    let width: number;\n    let actualHeight: number;\n\n    if (typeof ctxOrWidth === 'number') {\n        // Called as detectUIRegions(width, height)\n        width = ctxOrWidth;\n        actualHeight = widthOrHeight;\n    } else {\n        // Called as detectUIRegions(ctx, width, height)\n        ctx = ctxOrWidth;\n        width = widthOrHeight;\n        actualHeight = height!;\n    }\n\n    const resolution = detectResolution(width, actualHeight);\n    const uiLayout = detectUILayout(width, actualHeight);\n\n    // Detect if this is pause menu or gameplay by analyzing bottom hotbar region\n    // If no context provided, default to pause_menu for backwards compatibility\n    const screenType = ctx ? detectScreenType(ctx, width, actualHeight) : 'pause_menu';\n\n    logger.info({\n        operation: 'cv.detect_ui_regions',\n        data: {\n            width,\n            height: actualHeight,\n            uiLayout,\n            resolution: resolution.category,\n            screenType,\n            hasContext: ctx !== null,\n        },\n    });\n\n    if (screenType === 'pause_menu') {\n        return detectPauseMenuRegions(width, actualHeight, uiLayout);\n    } else {\n        return detectGameplayRegions(width, actualHeight, uiLayout);\n    }\n}\n\n/**\n * Detect regions for pause menu layout\n */\nfunction detectPauseMenuRegions(\n    width: number,\n    height: number,\n    uiLayout: 'pc' | 'steam_deck' | 'unknown'\n): { inventory?: ROI; stats?: ROI; character?: ROI; pauseMenu?: ROI } {\n    if (uiLayout === 'steam_deck') {\n        // Steam Deck: More compact layout\n        return {\n            pauseMenu: {\n                x: Math.floor(width * 0.15),\n                y: Math.floor(height * 0.15),\n                width: Math.floor(width * 0.7),\n                height: Math.floor(height * 0.7),\n                label: 'pause_menu',\n            },\n            stats: {\n                x: Math.floor(width * 0.2),\n                y: Math.floor(height * 0.15),\n                width: Math.floor(width * 0.6),\n                height: Math.floor(height * 0.2),\n                label: 'stats',\n            },\n            inventory: {\n                x: Math.floor(width * 0.2),\n                y: Math.floor(height * 0.4),\n                width: Math.floor(width * 0.6),\n                height: Math.floor(height * 0.45),\n                label: 'inventory',\n            },\n        };\n    } else {\n        // PC: Standard layout\n        return {\n            pauseMenu: {\n                x: Math.floor(width * 0.15),\n                y: Math.floor(height * 0.1),\n                width: Math.floor(width * 0.7),\n                height: Math.floor(height * 0.8),\n                label: 'pause_menu',\n            },\n            stats: {\n                x: Math.floor(width * 0.25),\n                y: Math.floor(height * 0.15),\n                width: Math.floor(width * 0.5),\n                height: Math.floor(height * 0.2),\n                label: 'stats',\n            },\n            inventory: {\n                x: Math.floor(width * 0.25),\n                y: Math.floor(height * 0.4),\n                width: Math.floor(width * 0.5),\n                height: Math.floor(height * 0.5),\n                label: 'inventory',\n            },\n        };\n    }\n}\n\n/**\n * Detect regions for gameplay layout\n */\nfunction detectGameplayRegions(\n    width: number,\n    height: number,\n    _uiLayout: 'pc' | 'steam_deck' | 'unknown'\n): { stats?: ROI; character?: ROI; gameplay?: ROI } {\n    return {\n        gameplay: {\n            x: 0,\n            y: 0,\n            width,\n            height,\n            label: 'gameplay',\n        },\n        stats: {\n            x: Math.floor(width * 0.02),\n            y: Math.floor(height * 0.02),\n            width: Math.floor(width * 0.15),\n            height: Math.floor(height * 0.12),\n            label: 'stats',\n        },\n        character: {\n            x: Math.floor(width * 0.02),\n            y: Math.floor(height * 0.2),\n            width: Math.floor(width * 0.15),\n            height: Math.floor(height * 0.4),\n            label: 'character',\n        },\n    };\n}\n","// ========================================\n// MegaBonk Complete Guide - Main Script\n// ========================================\n// This file serves as the entry point and initializes all modules.\n// Uses ES6 modules for better code organization and tree-shaking.\n// ========================================\n\n// ========================================\n// ES Module Imports\n// ========================================\n\n// Core utilities\nimport { ToastManager } from './modules/toast.ts';\nimport { loadAllData } from './modules/data-service.ts';\nimport { loadFavorites } from './modules/favorites.ts';\nimport { setupEventListeners, setupEventDelegation } from './modules/events.ts';\nimport { domCache } from './modules/dom-cache.ts';\nimport { safeModuleInit, registerErrorBoundary } from './modules/error-boundary.ts';\nimport { setupKeyboardShortcuts } from './modules/keyboard-shortcuts.ts';\nimport { themeManager } from './modules/theme-manager.ts';\nimport { initWebVitals, createPerformanceBadge } from './modules/web-vitals.ts';\nimport { setupImageFallbackHandler, setupBlurUpHandler } from './modules/utils.ts';\nimport { logger } from './modules/logger.ts';\nimport { setupOfflineListeners } from './modules/offline-ui.ts';\nimport { scheduleModulePreload } from './modules/events.ts';\nimport { initMobileNav, injectMoreMenuStyles } from './modules/mobile-nav.ts';\nimport { initMobileFilters } from './modules/mobile-filters.ts';\nimport { initRecentlyViewed } from './modules/recently-viewed.ts';\nimport { initDebugPanel } from './modules/debug-ui.ts';\nimport { initPullRefresh } from './modules/pull-refresh.ts';\n// Note: Tab-specific modules (advisor, build-planner, calculator, changelog, about) are now lazy-loaded\n// via the tab-loader module when their tabs are first accessed\n// Core modules that may be needed across multiple contexts are still eagerly loaded:\nimport './modules/ocr/index.ts';\nimport './modules/computer-vision.ts';\nimport './modules/test-utils.ts';\n\n// Note: filteredData is now managed by the centralized store (store.ts)\n// Use getState('filteredData') and setState('filteredData', data) for access\n\n/**\n * Setup global error tracking\n */\nfunction setupErrorTracking(): void {\n    // Catch uncaught JavaScript errors\n    window.onerror = (message, source, lineno, colno, error) => {\n        const err = error as Error | undefined;\n        logger.error({\n            operation: 'error.unhandled',\n            error: {\n                name: err?.name || 'Error',\n                message: String(message),\n                stack: err?.stack,\n                module: 'global',\n            },\n            data: {\n                source,\n                line: lineno,\n                column: colno,\n            },\n        });\n\n        // Show user-friendly error message\n        try {\n            ToastManager.error('Something went wrong. The error has been logged.');\n        } catch {\n            // ToastManager not initialized yet, fail silently\n        }\n\n        // Return false to let browser handle error as well\n        return false;\n    };\n\n    // Catch unhandled promise rejections\n    window.addEventListener('unhandledrejection', (event: PromiseRejectionEvent) => {\n        const reason = event.reason;\n        logger.error({\n            operation: 'error.promise',\n            error: {\n                name: reason?.name || 'UnhandledRejection',\n                message: reason?.message || String(reason),\n                stack: reason?.stack,\n                module: 'global',\n            },\n        });\n\n        // Show user-friendly error message\n        try {\n            ToastManager.error('An error occurred. Please try again.');\n        } catch {\n            // ToastManager not initialized yet, fail silently\n        }\n\n        // Prevent default browser error handling\n        event.preventDefault();\n    });\n}\n\n// Track update interval ID for cleanup\nlet updateIntervalId: number | null = null;\n\n/**\n * Setup service worker update notification\n * Note: Service worker is registered by VitePWA plugin\n */\nfunction setupUpdateNotification(): void {\n    // Check if service worker is supported\n    if (!('serviceWorker' in navigator)) {\n        return;\n    }\n\n    // Wait for service worker to be ready (VitePWA handles registration)\n    navigator.serviceWorker.ready\n        .then((registration: ServiceWorkerRegistration) => {\n            // Check for updates periodically (every hour)\n            updateIntervalId = window.setInterval(\n                () => {\n                    registration.update();\n                },\n                60 * 60 * 1000\n            );\n\n            // Track if update notification has been shown to prevent duplicates\n            let updateNotificationShown = false;\n\n            // Listen for waiting service worker (new version available)\n            registration.addEventListener('updatefound', () => {\n                const newWorker = registration.installing;\n                if (!newWorker) return;\n\n                const handleStateChange = (): void => {\n                    // New service worker is waiting to activate\n                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n                        // Only show notification once per session\n                        if (!updateNotificationShown) {\n                            updateNotificationShown = true;\n                            showUpdateNotification(registration);\n                            // Clean up listener after notification shown\n                            newWorker.removeEventListener('statechange', handleStateChange);\n                        }\n                    }\n                };\n\n                newWorker.addEventListener('statechange', handleStateChange);\n            });\n        })\n        .catch((err: Error) => {\n            logger.warn({\n                operation: 'app.update',\n                error: {\n                    name: err.name,\n                    message: err.message,\n                    module: 'service-worker',\n                },\n                data: { reason: 'service_worker_not_available' },\n            });\n        });\n}\n\n/**\n * Cleanup service worker update checking\n * Exported for potential use in cleanup hooks or testing\n */\nexport function cleanupUpdateNotification(): void {\n    if (updateIntervalId !== null) {\n        clearInterval(updateIntervalId);\n        updateIntervalId = null;\n    }\n}\n\n/**\n * Show update notification to user\n * @param registration - Service worker registration\n */\nfunction showUpdateNotification(registration: ServiceWorkerRegistration): void {\n    const notification = document.createElement('div');\n    notification.className = 'update-notification';\n    notification.innerHTML = `\n        <div class=\"update-content\">\n            <span class=\"update-icon\"></span>\n            <div class=\"update-message\">\n                <strong>Update Available!</strong>\n                <p>A new version of MegaBonk Guide is ready.</p>\n            </div>\n            <button class=\"update-btn\" id=\"update-reload-btn\">\n                Reload Now\n            </button>\n            <button class=\"update-dismiss-btn\" id=\"update-dismiss-btn\">\n                Later\n            </button>\n        </div>\n    `;\n    document.body.appendChild(notification);\n\n    // Cleanup function to remove notification and event listeners\n    const cleanup = () => {\n        notification.remove();\n    };\n\n    // Handle reload button\n    const reloadBtn = document.getElementById('update-reload-btn');\n    if (reloadBtn) {\n        const handleReload = () => {\n            // Tell waiting service worker to skip waiting\n            if (registration.waiting) {\n                registration.waiting.postMessage({ type: 'SKIP_WAITING' });\n            }\n            // Reload page when new service worker takes control\n            const handleControllerChange = () => {\n                window.location.reload();\n            };\n            navigator.serviceWorker.addEventListener('controllerchange', handleControllerChange, { once: true });\n        };\n        reloadBtn.addEventListener('click', handleReload, { once: true });\n    }\n\n    // Handle dismiss button\n    const dismissBtn = document.getElementById('update-dismiss-btn');\n    if (dismissBtn) {\n        dismissBtn.addEventListener('click', cleanup, { once: true });\n    }\n}\n\n/**\n * Initialize the application\n */\nasync function init(): Promise<void> {\n    const initStartTime = performance.now();\n\n    // Log app initialization start\n    logger.info({\n        operation: 'app.init',\n        data: { phase: 'start' },\n    });\n\n    // Setup error tracking first (critical - no error boundary)\n    setupErrorTracking();\n\n    // Initialize theme manager early (before any UI rendering)\n    await safeModuleInit(\n        'theme-manager',\n        async () => {\n            themeManager.init();\n        },\n        { required: false }\n    );\n\n    // Register error boundaries for modules\n    registerErrorBoundary('dom-cache', () => {\n        logger.warn({\n            operation: 'module.degraded',\n            data: { moduleName: 'dom-cache', fallback: 'direct_dom_queries' },\n        });\n    });\n\n    registerErrorBoundary('data-service', () => {\n        logger.error({\n            operation: 'module.init.failed',\n            data: { moduleName: 'data-service', critical: true },\n        });\n        ToastManager.error('Failed to load game data. Please refresh the page.');\n    });\n\n    // Setup offline indicator (non-critical)\n    await safeModuleInit(\n        'offline-indicator',\n        async () => {\n            setupOfflineListeners();\n        },\n        { required: false }\n    );\n\n    // Setup update notification (non-critical)\n    await safeModuleInit(\n        'update-notification',\n        async () => {\n            setupUpdateNotification();\n        },\n        { required: false }\n    );\n\n    // Initialize DOM cache (important but can degrade)\n    await safeModuleInit(\n        'dom-cache',\n        async () => {\n            domCache.init();\n        },\n        { required: false, gracefulDegradation: true }\n    );\n\n    // Setup image fallback handler for CSP compliance (non-critical)\n    await safeModuleInit(\n        'image-fallback',\n        async () => {\n            setupImageFallbackHandler();\n        },\n        { required: false }\n    );\n\n    // Setup blur-up image loading handler for better perceived performance (non-critical)\n    await safeModuleInit(\n        'blur-up-images',\n        async () => {\n            setupBlurUpHandler();\n        },\n        { required: false }\n    );\n\n    // Initialize toast manager (important)\n    await safeModuleInit(\n        'toast-manager',\n        async () => {\n            ToastManager.init();\n        },\n        { required: true }\n    );\n\n    // Load favorites from localStorage (non-critical)\n    await safeModuleInit(\n        'favorites',\n        async () => {\n            loadFavorites();\n        },\n        { required: false }\n    );\n\n    // Setup event delegation and listeners (critical)\n    await safeModuleInit(\n        'event-system',\n        async () => {\n            setupEventDelegation();\n            setupEventListeners();\n        },\n        { required: true }\n    );\n\n    // Setup keyboard shortcuts (non-critical)\n    await safeModuleInit(\n        'keyboard-shortcuts',\n        async () => {\n            setupKeyboardShortcuts();\n        },\n        { required: false }\n    );\n\n    // Load all game data (critical)\n    await safeModuleInit(\n        'data-service',\n        async () => {\n            await loadAllData();\n        },\n        { required: true }\n    );\n\n    // Initialize Web Vitals monitoring (non-critical)\n    await safeModuleInit(\n        'web-vitals',\n        async () => {\n            initWebVitals();\n            createPerformanceBadge();\n        },\n        { required: false }\n    );\n\n    // Initialize mobile navigation (non-critical)\n    await safeModuleInit(\n        'mobile-nav',\n        async () => {\n            injectMoreMenuStyles();\n            initMobileNav();\n        },\n        { required: false }\n    );\n\n    // Initialize mobile filters bottom sheet (non-critical)\n    await safeModuleInit(\n        'mobile-filters',\n        async () => {\n            initMobileFilters();\n        },\n        { required: false }\n    );\n\n    // Initialize recently viewed tracking (non-critical)\n    await safeModuleInit(\n        'recently-viewed',\n        async () => {\n            initRecentlyViewed();\n        },\n        { required: false }\n    );\n\n    // Initialize debug panel UI (non-critical)\n    await safeModuleInit(\n        'debug-panel',\n        async () => {\n            initDebugPanel();\n        },\n        { required: false }\n    );\n\n    // Initialize pull-to-refresh for mobile (non-critical)\n    await safeModuleInit(\n        'pull-refresh',\n        async () => {\n            initPullRefresh();\n        },\n        { required: false }\n    );\n\n    // Schedule preloading of common modules after initial render\n    // This warms the module cache for frequently-used tabs\n    scheduleModulePreload();\n\n    // Log app initialization complete\n    const initDuration = Math.round(performance.now() - initStartTime);\n    logger.info({\n        operation: 'app.ready',\n        durationMs: initDuration,\n        data: {\n            phase: 'complete',\n            modulesLoaded: [\n                'theme-manager',\n                'offline-indicator',\n                'update-notification',\n                'dom-cache',\n                'image-fallback',\n                'blur-up-images',\n                'toast-manager',\n                'favorites',\n                'event-system',\n                'keyboard-shortcuts',\n                'data-service',\n                'web-vitals',\n                'mobile-nav',\n                'mobile-filters',\n                'recently-viewed',\n                'debug-panel',\n                'pull-refresh',\n            ],\n        },\n    });\n}\n\n// Initialize when DOM is ready\ndocument.addEventListener('DOMContentLoaded', init);\n","// ========================================\n// MegaBonk Computer Vision Module\n// ========================================\n// This file re-exports from the cv/ directory for backwards compatibility.\n// All CV functionality has been split into smaller, focused modules.\n// ========================================\n\n// Re-export everything from the cv module\nexport * from './cv/index.ts';\n\n// ========================================\n// Global Assignments (for browser compatibility)\n// ========================================\nimport {\n    initCV,\n    // Detection functions\n    detectItemsWithCV,\n    detectGridPositions,\n    detectItemCounts,\n    loadImageToCanvas,\n    calculateSimilarity,\n    calculateIoU,\n    nonMaxSuppression,\n    getAdaptiveIconSizes,\n    extractCountRegion,\n    detectHotbarRegion,\n    detectIconEdges,\n    detectIconScale,\n    resizeImageData,\n    fitsGrid,\n    verifyGridPattern,\n    runEnsembleDetection,\n    getCVMetrics,\n    getDetectionConfig,\n    // Color functions\n    extractDominantColors,\n    getDominantColor,\n    calculateColorVariance,\n    isEmptyCell,\n    detectBorderRarity,\n    // Region functions\n    detectUIRegions,\n    detectScreenType,\n    // Templates\n    clearDetectionCache,\n} from './cv/index.ts';\n\nif (typeof window !== 'undefined') {\n    // Core\n    window.initCV = initCV;\n    \n    // Detection - use type assertions for functions with concrete parameter types\n    // The Window interface uses `unknown` for flexibility, but actual functions use specific types\n    window.detectItemsWithCV = detectItemsWithCV;\n    window.detectGridPositions = detectGridPositions;\n    window.detectItemCounts = detectItemCounts as typeof window.detectItemCounts;\n    window.loadImageToCanvas = loadImageToCanvas;\n    window.calculateSimilarity = calculateSimilarity;\n    window.calculateIoU = calculateIoU as typeof window.calculateIoU;\n    window.nonMaxSuppression = nonMaxSuppression as typeof window.nonMaxSuppression;\n    window.getAdaptiveIconSizes = getAdaptiveIconSizes;\n    window.extractCountRegion = extractCountRegion as typeof window.extractCountRegion;\n    window.detectHotbarRegion = detectHotbarRegion;\n    window.detectIconEdges = detectIconEdges as typeof window.detectIconEdges;\n    window.detectIconScale = detectIconScale;\n    window.resizeImageData = resizeImageData;\n    window.fitsGrid = fitsGrid;\n    window.verifyGridPattern = verifyGridPattern as typeof window.verifyGridPattern;\n    window.runEnsembleDetection = runEnsembleDetection as typeof window.runEnsembleDetection;\n    window.getCVMetrics = getCVMetrics;\n    window.getDetectionConfig = getDetectionConfig;\n    \n    // Color - extractDominantColors returns objects, Window interface expects strings for simplicity\n    window.extractDominantColors = extractDominantColors as unknown as typeof window.extractDominantColors;\n    window.getDominantColor = getDominantColor;\n    window.calculateColorVariance = calculateColorVariance;\n    window.isEmptyCell = isEmptyCell;\n    window.detectBorderRarity = detectBorderRarity;\n    \n    // Regions\n    window.detectUIRegions = detectUIRegions;\n    window.detectScreenType = detectScreenType;\n    \n    // Templates\n    window.clearDetectionCache = clearDetectionCache;\n}\n","// ========================================\n// Detection Pipeline - OCR Count Detection\n// ========================================\n\nimport type { ROI } from '../types.ts';\nimport { logger } from '../../logger.ts';\nimport { extractCountRegion } from '../detection-utils.ts';\nimport { loadImageToCanvas } from '../detection-processing.ts';\n\n/**\n * Extract count numbers from item cells using OCR\n * Returns a map of cell labels to counts\n */\nexport async function detectItemCounts(imageDataUrl: string, cells: ROI[]): Promise<Map<string, number>> {\n    const Tesseract = await import('tesseract.js');\n    const counts = new Map<string, number>();\n\n    // Load screenshot\n    const { canvas: srcCanvas } = await loadImageToCanvas(imageDataUrl);\n\n    for (const cell of cells) {\n        try {\n            // Extract count region (bottom-right corner)\n            const countROI = extractCountRegion(cell);\n\n            // Create canvas for just the count region\n            const countCanvas = document.createElement('canvas');\n            countCanvas.width = countROI.width;\n            countCanvas.height = countROI.height;\n            const countCtx = countCanvas.getContext('2d', { willReadFrequently: true })!;\n\n            countCtx.drawImage(\n                srcCanvas,\n                countROI.x,\n                countROI.y,\n                countROI.width,\n                countROI.height,\n                0,\n                0,\n                countROI.width,\n                countROI.height\n            );\n\n            // OCR just this tiny region\n            // PSM 8 = SINGLE_WORD mode (optimized for single word recognition)\n            // Note: For simple Tesseract.recognize(), parameters like pageseg_mode\n            // need to be passed differently. Using default settings for simplicity.\n            // TODO: For better OCR accuracy, use createWorker with setParameters\n            const result = await Tesseract.recognize(countCanvas.toDataURL(), 'eng');\n\n            const text = result.data.text.trim();\n\n            // Parse count (look for patterns like \"x5\", \"5\", \"3\")\n            const countMatch = text.match(/[x]?(\\d+)/);\n            if (countMatch && countMatch[1]) {\n                const count = parseInt(countMatch[1], 10);\n                if (!isNaN(count) && count > 1 && count <= 20) {\n                    counts.set(cell.label || '', count);\n                }\n            }\n        } catch (error) {\n            // Silently fail for individual cells, default to 1\n            logger.error({\n                operation: 'cv.detect_count',\n                error: {\n                    name: (error as Error).name,\n                    message: (error as Error).message,\n                },\n            });\n        }\n    }\n\n    return counts;\n}\n","// ========================================\n// Detection Pipeline - Ensemble Detection\n// ========================================\n\nimport type { Item } from '../../../types/index.ts';\nimport type { ROI } from '../types.ts';\nimport { getItemTemplates } from '../state.ts';\nimport { getDynamicMinConfidence } from '../detection-config.ts';\nimport { matchTemplate } from '../detection-matching.ts';\nimport { shouldSkipTemplate } from '../template-ranking.ts';\nimport {\n    selectStrategiesForImage,\n    getStrategy,\n    combineStrategyDetections,\n    getEnsembleConfig,\n    type StrategyDetection,\n    type EnsembleResult,\n} from '../ensemble-detector.ts';\nimport type { ProgressCallback } from './types.ts';\n\n/**\n * Run ensemble detection with multiple strategies\n * Combines results from different strategies for better accuracy\n * @internal Reserved for future ensemble-based detection enhancements\n */\nexport async function runEnsembleDetection(\n    ctx: CanvasRenderingContext2D,\n    width: number,\n    height: number,\n    _items: Item[],\n    cell: ROI,\n    _progressCallback?: ProgressCallback\n): Promise<EnsembleResult | null> {\n    const strategies = selectStrategiesForImage(width, height);\n    const config = getEnsembleConfig();\n    const strategyDetections: StrategyDetection[] = [];\n\n    // Run each strategy\n    for (const strategyId of strategies) {\n        const strategy = getStrategy(strategyId);\n        const threshold = strategy.minConfidence ?? getDynamicMinConfidence(width, height);\n\n        // Match against templates\n        const itemTemplates = getItemTemplates();\n        let bestMatch: { itemId: string; confidence: number; templateId: string } | null = null;\n\n        for (const [itemId, template] of itemTemplates) {\n            // Check template ranking - skip poor performers if enabled\n            if (strategy.templates.skipPoorPerformers && shouldSkipTemplate(`${itemId}_primary`)) {\n                continue;\n            }\n\n            const similarity = matchTemplate(ctx, cell, template, itemId);\n\n            if (similarity > threshold && (!bestMatch || similarity > bestMatch.confidence)) {\n                bestMatch = {\n                    itemId,\n                    confidence: similarity,\n                    templateId: `${itemId}_primary`,\n                };\n            }\n        }\n\n        if (bestMatch) {\n            strategyDetections.push({\n                strategyId,\n                itemId: bestMatch.itemId,\n                confidence: bestMatch.confidence * strategy.weight,\n                position: { x: cell.x, y: cell.y, width: cell.width, height: cell.height },\n                templateId: bestMatch.templateId,\n            });\n\n            // Early exit if confidence is very high\n            if (bestMatch.confidence >= config.earlyExitThreshold) {\n                break;\n            }\n        }\n    }\n\n    if (strategyDetections.length === 0) {\n        return null;\n    }\n\n    // Combine strategy results\n    return combineStrategyDetections(\n        strategyDetections,\n        { x: cell.x, y: cell.y, width: cell.width, height: cell.height },\n        config\n    );\n}\n","// ========================================\n// Detection Pipeline - Metrics & Config Exports\n// ========================================\n\nimport type { CVDetectionResult } from '../types.ts';\nimport { getMetricsCollector } from '../metrics.ts';\nimport { getDynamicMinConfidence } from '../detection-config.ts';\nimport { getResolutionTier } from '../resolution-profiles.ts';\nimport { selectStrategiesForImage, type StrategyId } from '../ensemble-detector.ts';\nimport { findUncertainDetections } from '../active-learning.ts';\nimport { getScoringConfig } from '../scoring-config.ts';\n\n/**\n * Get CV detection metrics for UI display\n * Returns run history and aggregated stats\n */\nexport function getCVMetrics(): {\n    runs: ReturnType<typeof getMetricsCollector>['getRuns'] extends () => infer R ? R : never;\n    aggregated: ReturnType<typeof getMetricsCollector>['getAggregatedMetrics'] extends () => infer R ? R : never;\n    enabled: boolean;\n} {\n    const collector = getMetricsCollector();\n    return {\n        runs: collector.getRuns(),\n        aggregated: collector.getAggregatedMetrics(),\n        enabled: collector.isEnabled(),\n    };\n}\n\n/**\n * Get current detection configuration for debugging\n */\nexport function getDetectionConfig(\n    width?: number,\n    height?: number\n): {\n    dynamicThreshold: number;\n    resolutionTier: string;\n    selectedStrategies: StrategyId[];\n    scoringConfig: ReturnType<typeof getScoringConfig>;\n} {\n    const tier = width && height ? getResolutionTier(width, height) : 'medium';\n    const strategies = width && height ? selectStrategiesForImage(width, height) : ['default' as StrategyId];\n\n    return {\n        dynamicThreshold: getDynamicMinConfidence(width, height),\n        resolutionTier: tier,\n        selectedStrategies: strategies,\n        scoringConfig: getScoringConfig(),\n    };\n}\n\n/**\n * Get uncertain detections from last run for active learning UI\n */\nexport function getUncertainDetectionsFromResults(\n    detections: CVDetectionResult[]\n): ReturnType<typeof findUncertainDetections> {\n    // Convert CVDetectionResult to DetectionForFeedback format\n    const feedbackDetections = detections\n        .filter(d => d.position)\n        .map(d => ({\n            detectedItemId: d.entity.id,\n            detectedItemName: d.entity.name,\n            confidence: d.confidence,\n            x: d.position!.x,\n            y: d.position!.y,\n            width: d.position!.width,\n            height: d.position!.height,\n        }));\n    return findUncertainDetections(feedbackDetections);\n}\n"],"file":"main-BWYXOf-Y.js"}